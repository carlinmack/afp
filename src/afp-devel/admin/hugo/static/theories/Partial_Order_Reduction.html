<div id="List_Prefixes">
<div class="head">
<h1>Theory List_Prefixes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹List Prefixes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> List_Prefixes
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Prefix_Order.html">HOL-Library.Prefix_Order</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> prefixI strict_prefixI<span class="main">[</span><span class="operator">folded</span> less_eq_list_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> prefixE strict_prefixE<span class="main">[</span><span class="operator">folded</span> less_eq_list_def<span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">?</span></span><span class="main">]</span> <span class="main">=</span> take_is_prefix<span class="main">[</span><span class="operator">folded</span> less_eq_list_def<span class="main">]</span>

  <span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Sublist.prefix Sublist.suffix

  <span class="keyword1" id="List_Prefixes-prefix_finI_item"><span class="command">lemma</span></span> prefix_finI_item<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">#</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1" id="List_Prefixes-prefix_finE_item"><span class="command">lemma</span></span> prefix_finE_item<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">#</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1" id="List_Prefixes-prefix_fin_append"><span class="command">lemma</span></span> prefix_fin_append<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="List_Prefixes-pprefix_fin_length"><span class="command">lemma</span></span> pprefix_fin_length<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u</span> <span class="main">&lt;</span> length <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="List_Extensions">
<div class="head">
<h1>Theory List_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> List_Extensions
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">declare</span></span> remove1_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1" id="List_Extensions-nth_append_simps"><span class="command">lemma</span></span> nth_append_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">notation</span></span> zip <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">||</span>"</span> 51<span class="main">)</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">project</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">select</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> nths <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

  <span class="keyword1" id="List_Extensions-map_plus"><span class="command">lemma</span></span> map_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>plus <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>plus <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span>Suc <span class="main">∘</span> plus <span class="skolem">n</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>map Suc <span class="main">∘</span> map <span class="main">(</span>plus <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map Suc <span class="main">(</span>map <span class="main">(</span>plus <span class="skolem">n</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map Suc <span class="main">[</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span>Suc <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_Suc_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">n</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="List_Extensions-singleton_list_lengthE"><span class="command">lemma</span></span> singleton_list_lengthE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 Suc_length_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="List_Extensions-singleton_hd_last"><span class="command">lemma</span></span> singleton_hd_last<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> hd <span class="free">xs</span> <span class="main">=</span> last <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1" id="List_Extensions-set_subsetI"><span class="command">lemma</span></span> set_subsetI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="List_Extensions-hd_take"><span class="command">lemma</span></span> hd_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_conv_nth<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_take<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> hd <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hd_conv_nth<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="List_Extensions-hd_drop"><span class="command">lemma</span></span> hd_drop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hd_drop_conv_nth assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="List_Extensions-last_take"><span class="command">lemma</span></span> last_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq Suc_pred<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="List_Extensions-split_list_first_unique"><span class="command">lemma</span></span> split_list_first_unique<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∨</span>
      <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> append_eq_append_conv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> hd_append2 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Word_Prefixes">
<div class="head">
<h1>Theory Word_Prefixes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite Prefixes of Infinite Sequences›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Word_Prefixes
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="List_Prefixes.html">List_Prefixes</a>
  <span class="quoted">"<a href="List_Extensions.html">../Extensions/List_Extensions</a>"</span>
  <a href="../Transition_Systems_and_Automata/Sequence.html">Transition_Systems_and_Automata.Sequence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">prefix_fininf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span>"</span> 50<span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1"><span class="free">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">@-</span> <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

  <span class="keyword1" id="Word_Prefixes-prefix_fininfI"><span class="command">lemma</span></span> prefix_fininfI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prefix_fininf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininfE"><span class="command">lemma</span></span> prefix_fininfE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prefix_fininf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Word_Prefixes-prefix_fininfI_empty"><span class="command">lemma</span></span> prefix_fininfI_empty<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininfI_item"><span class="command">lemma</span></span> prefix_fininfI_item<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">b</span> <span class="main">##</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininfE_item"><span class="command">lemma</span></span> prefix_fininfE_item<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">b</span> <span class="main">##</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1" id="Word_Prefixes-prefix_fininf_item"><span class="command">lemma</span></span> prefix_fininf_item<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">#</span> <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininf_list"><span class="command">lemma</span></span> prefix_fininf_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininf_conc"><span class="command">lemma</span></span> prefix_fininf_conc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininf_prefix"><span class="command">lemma</span></span> prefix_fininf_prefix<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="free">k</span> <span class="free">w</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stake_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininf_set_range"><span class="command">lemma</span></span> prefix_fininf_set_range<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span> <span class="main">⟹</span> set <span class="free">u</span> <span class="main">⊆</span> sset <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Word_Prefixes-prefix_fininf_absorb"><span class="command">lemma</span></span> prefix_fininf_absorb<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u</span> <span class="main">≤</span> length <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">@</span> stake <span class="main">(</span>length <span class="free">v</span> <span class="main">-</span> length <span class="free">u</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininf_extend"><span class="command">lemma</span></span> prefix_fininf_extend<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">≤</span> length <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">@</span> stake <span class="main">(</span>length <span class="free">u</span> <span class="main">-</span> length <span class="free">v</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininf_length"><span class="command">lemma</span></span> prefix_fininf_length<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u</span> <span class="main">≤</span> length <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> shift_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">@-</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min.absorb2 stake_append<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Word_Prefixes-prefix_fininf_append"><span class="command">lemma</span></span> prefix_fininf_append<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>absorb<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="main">|</span> <span class="main">(</span>extend<span class="main">)</span> <span class="free">z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> le
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> absorb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">@</span> stake <span class="main">(</span>length <span class="free">v</span> <span class="main">-</span> length <span class="free">u</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ge
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> extend<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> shift_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@</span> stake <span class="main">(</span>length <span class="free">u</span> <span class="main">-</span> length <span class="free">v</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@</span> stake <span class="main">(</span>length <span class="free">u</span> <span class="main">-</span> length <span class="free">v</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="free">u</span> <span class="main">-</span> length <span class="free">v</span><span class="main">)</span> <span class="free">w</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Word_Prefixes-prefix_fin_prefix_fininf_trans"><span class="command">lemma</span></span> prefix_fin_prefix_fininf_trans<span class="main">[</span><span class="operator">trans</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Prefix_Order.prefixE prefix_fininf_def shift_append<span class="main">)</span>

  <span class="keyword1" id="Word_Prefixes-prefix_finE_nth"><span class="command">lemma</span></span> prefix_finE_nth<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Word_Prefixes-prefix_fininfI_nth"><span class="command">lemma</span></span> prefix_fininfI_nth<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prefix_fininfI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> sdrop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_eq_iff_nth_eq shift_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">chain</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> mono <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">limit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> stream"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">limit</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> smap <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> nats"</span></span>

  <span class="keyword1" id="Word_Prefixes-chainI"><span class="command">lemma</span></span> chainI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Word_Prefixes-chainD_mono"><span class="command">lemma</span></span> chainD_mono<span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Word_Prefixes-chainE_length"><span class="command">lemma</span></span> chainE_length<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Word_Prefixes-chain_prefix_limit"><span class="command">lemma</span></span> chain_prefix_limit<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">k</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prefix_fininfI_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chainD_mono chainE_length assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> someI_ex 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> limit <span class="free">w</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monoD 2<span class="main">(</span>1<span class="main">)</span> le <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> limit_def <span class="keyword1"><span class="command">using</span></span> prefix_finE_nth 4 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ge<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">w</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monoD 2<span class="main">(</span>1<span class="main">)</span> ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> limit_def <span class="keyword1"><span class="command">using</span></span> prefix_finE_nth 4 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Word_Prefixes-chain_construct_1"><span class="command">lemma</span></span> chain_construct_1<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Q</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x'</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≡</span> rec_nat <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="bound">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> that chainI monoI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> comp_apply<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">-</span> <span class="skolem">x</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Word_Prefixes-chain_construct_2"><span class="command">lemma</span></span> chain_construct_2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Q</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x'</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">x'</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≡</span> rec_nat <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">Q</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="bound">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> that chainI monoI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> comp_apply<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">-</span> <span class="skolem">x</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">-</span> <span class="skolem">x</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Word_Prefixes-chain_construct_2'"><span class="command">lemma</span></span> chain_construct_2'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="free">u<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u'</span> <span class="bound">v'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="bound">u'</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≤</span> <span class="bound">u'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≤</span> <span class="bound">v'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> length <span class="bound">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> length <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="main">(</span><span class="free">u</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="bound">k</span> <span class="main">(</span><span class="skolem">Q</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span>snd <span class="main">∘</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> chain_construct_2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="bound">x'</span> <span class="main">∧</span> fst <span class="skolem">x</span> <span class="main">≤</span> fst <span class="bound">x'</span> <span class="main">∧</span> snd <span class="skolem">x</span> <span class="main">≤</span> snd <span class="bound">x'</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">k</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>snd <span class="main">∘</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="main">(</span>snd <span class="main">∘</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Set_Extensions">
<div class="head">
<h1>Theory Set_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Set_Extensions
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">declare</span></span> finite_subset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

  <span class="keyword1" id="Set_Extensions-set_not_emptyI"><span class="command">lemma</span></span> set_not_emptyI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Set_Extensions-sets_empty_iffI"><span class="command">lemma</span></span> sets_empty_iffI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Set_Extensions-disjointI"><span class="command">lemma</span></span> disjointI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> False"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Set_Extensions-range_subsetI"><span class="command">lemma</span></span> range_subsetI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"range <span class="free">f</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="Set_Extensions-finite_imageI_range"><span class="command">lemma</span></span> finite_imageI_range<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset image_mono subset_UNIV assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Set_Extensions-inf_img_fin_domE'"><span class="command">lemma</span></span> inf_img_fin_domE'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">.</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_UN_I<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">.</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-vimage_singleton"><span class="command">lemma</span></span> vimage_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vimage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Set_Extensions-these_alt_def"><span class="command">lemma</span></span> these_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Option.these <span class="free">S</span> <span class="main">=</span> Some <span class="main">-`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Option.these_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1" id="Set_Extensions-the_vimage_subset"><span class="command">lemma</span></span> the_vimage_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">-`</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="free">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Set_Extensions-finite_induct_reverse"><span class="command">lemma</span></span> finite_induct_reverse<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> remove<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">S</span><span class="main">.</span> finite <span class="bound">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>psubset <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> psubset<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊂</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-zero_not_in_Suc_image"><span class="command">lemma</span></span> zero_not_in_Suc_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> Suc <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Set_Extensions-Collect_split_Suc"><span class="command">lemma</span></span> Collect_split_Suc<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> image_eqI mem_Collect_eq nat.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> imageI mem_Collect_eq not0_implies_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-Collect_subsume"><span class="command">lemma</span></span> Collect_subsume<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> simp_implies_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Set_Extensions-Max_ge'"><span class="command">lemma</span></span> Max_ge'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> Max <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Max_ge_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

  <span class="keyword1" id="Set_Extensions-least_contains"><span class="command">lemma</span></span> least_contains<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI<span class="main">)</span>
  <span class="keyword1" id="Set_Extensions-least_contains'"><span class="command">lemma</span></span> least_contains'<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI equals0I<span class="main">)</span>
  <span class="keyword1" id="Set_Extensions-least_least"><span class="command">lemma</span></span> least_least<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Least_le<span class="main">)</span>
  <span class="keyword1" id="Set_Extensions-least_unique"><span class="command">lemma</span></span> least_unique<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> least <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> least <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Least_le antisym<span class="main">)</span>
  <span class="keyword1" id="Set_Extensions-least_not_less"><span class="command">lemma</span></span> least_not_less<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> least <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_less_Least<span class="main">)</span>
  <span class="keyword1" id="Set_Extensions-leastI2_order"><span class="command">lemma</span></span> leastI2_order<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="bound">l</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>least <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI2_order<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">l</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-least_singleton"><span class="command">lemma</span></span> least_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_not_empty least_contains' singletonD<span class="main">)</span>

  <span class="keyword1" id="Set_Extensions-least_image"><span class="command">lemma</span></span> least_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> wellorder"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>least <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> leastI2_order<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> leastI2_order<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-least_le"><span class="command">lemma</span></span> least_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> least <span class="free">A</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> least <span class="free">B</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">≤</span> least <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> least <span class="free">A</span> <span class="main">≤</span> least <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="free">B</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">≤</span> least <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Set_Extensions-least_eq"><span class="command">lemma</span></span> least_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> least <span class="free">A</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> least <span class="free">B</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">=</span> least <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> antisym least_le<span class="main">)</span>

  <span class="keyword1" id="Set_Extensions-least_Suc"><span class="command">lemma</span></span> least_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>least <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">∈</span> Suc <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 LeastI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> Suc <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 LeastI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> least <span class="free">A</span> <span class="main">≤</span> <span class="bound">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 Least_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> Suc <span class="main">`</span> <span class="free">A</span> <span class="main">⟹</span> least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 Least_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>least <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 20 31 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>least <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 21 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-least_Suc_diff"><span class="command">lemma</span></span> least_Suc_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">`</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">`</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="main">(</span>least <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="free">A</span> <span class="main">-</span> Suc <span class="main">`</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-Max_diff_least"><span class="command">lemma</span></span> Max_diff_least<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Max <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="free">A</span> <span class="main">=</span> Max <span class="main">(</span>insert <span class="main">(</span>least <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert_absorb 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> max <span class="main">(</span>least <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Max <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max_insert<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> max_absorb2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Max_ge'<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-nat_set_card_equality_less"><span class="command">lemma</span></span> nat_set_card_equality_less<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset_card_mono 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> equal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> equal <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> greater
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> greater <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset_card_mono 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-nat_set_card_equality_le"><span class="command">lemma</span></span> nat_set_card_equality_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset_card_mono 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> equal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> equal <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> greater
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> greater <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset_card_mono 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-nat_set_card_mono"><span class="command">lemma</span></span> nat_set_card_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> psubset_card_mono psubsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Set_Extensions-card_one"><span class="command">lemma</span></span> card_one<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def card_Suc_eq<span class="main">)</span>

  <span class="keyword1" id="Set_Extensions-image_alt_def"><span class="command">lemma</span></span> image_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Set_Extensions-supset_mono_inductive"><span class="command">lemma</span></span> supset_mono_inductive<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟶</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Set_Extensions-Collect_mono_inductive"><span class="command">lemma</span></span> Collect_mono_inductive<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Set_Extensions-image_union_split"><span class="command">lemma</span></span> image_union_split<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">D</span> <span class="free">E</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">B</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> image_Un
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inf_sup_ord<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inf_sup_ord<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> subset_imageE<span class="main">)</span>
  <span class="keyword1" id="Set_Extensions-image_insert_split"><span class="command">lemma</span></span> image_insert_split<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> insert <span class="free">a</span> <span class="free">B</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">d</span> <span class="free">E</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="free">g</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">B</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">B</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="skolem">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> image_union_split 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> imageE
      image_empty image_insert inj_image_eq_iff singletonI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 2 <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Basic_Extensions">
<div class="head">
<h1>Theory Basic_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Basic_Extensions
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Types›</span></span>

    <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rules›</span></span>

    <span class="keyword1"><span class="command">declare</span></span> less_imp_le<span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>
  
    <span class="keyword1"><span class="command">declare</span></span> le_funI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> le_funE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> le_funD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span>
  
    <span class="keyword1" id="Basic_Extensions-IdI'"><span class="command">lemma</span></span> IdI'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> Id"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> order_le_cases<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>lt<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms le_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> linorder_cases'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>le<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gt<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
    <span class="keyword1" id="Basic_Extensions-monoI_comp"><span class="command">lemma</span></span> monoI_comp<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> monoI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> monoD<span class="main">)</span>
    <span class="keyword1" id="Basic_Extensions-strict_monoI_comp"><span class="command">lemma</span></span> strict_monoI_comp<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> strict_monoI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> strict_monoD<span class="main">)</span>

    <span class="keyword1" id="Basic_Extensions-eq_le_absorb"><span class="command">lemma</span></span> eq_le_absorb<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> order"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Basic_Extensions-INFM_Suc"><span class="command">lemma</span></span> INFM_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> INFM_nat <span class="keyword1"><span class="command">using</span></span> Suc_lessE less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1" id="Basic_Extensions-INFM_plus"><span class="command">lemma</span></span> INFM_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">n</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> INFM_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Basic_Extensions-INFM_minus"><span class="command">lemma</span></span> INFM_minus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="free">n</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">-</span> Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> INFM_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constants›</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">const</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">const</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">const2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">const2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">const3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">const3</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">const4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">const4</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">const5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">const5</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  
    <span class="keyword1" id="Basic_Extensions-const_apply"><span class="command">lemma</span></span> const_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> const_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1" id="Basic_Extensions-const2_apply"><span class="command">lemma</span></span> const2_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const2 <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> const2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1" id="Basic_Extensions-const3_apply"><span class="command">lemma</span></span> const3_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const3 <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="free">u</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> const3_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1" id="Basic_Extensions-const4_apply"><span class="command">lemma</span></span> const4_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const4 <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="free">u</span> <span class="free">v</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> const4_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1" id="Basic_Extensions-const5_apply"><span class="command">lemma</span></span> const5_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"const5 <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="free">u</span> <span class="free">v</span> <span class="free">w</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> const5_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">zip_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 51<span class="main">)</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">∥</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  
    <span class="keyword1" id="Basic_Extensions-zip_fun_simps"><span class="command">lemma</span></span> zip_fun_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∥</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">,</span> <span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> <span class="main">(</span><span class="free">f</span> <span class="main">∥</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
      <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> <span class="main">(</span><span class="free">f</span> <span class="main">∥</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
      <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> <span class="free">h</span> <span class="main">∥</span> snd <span class="main">∘</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
      <span class="quoted"><span class="quoted">"fst <span class="main">`</span> range <span class="main">(</span><span class="free">f</span> <span class="main">∥</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> range <span class="free">f</span>"</span></span>
      <span class="quoted"><span class="quoted">"snd <span class="main">`</span> range <span class="main">(</span><span class="free">f</span> <span class="main">∥</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> range <span class="free">g</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> zip_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  
    <span class="keyword1" id="Basic_Extensions-zip_fun_eq"><span class="command">lemma</span></span> zip_fun_eq<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∥</span> <span class="free">g</span> <span class="main">=</span> <span class="free">h</span> <span class="main">∥</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> zip_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_cong<span class="main">)</span>
  
    <span class="keyword1" id="Basic_Extensions-zip_fun_range_subset"><span class="command">lemma</span></span> zip_fun_range_subset<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="free">f</span> <span class="main">∥</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">f</span> <span class="main">×</span> range <span class="free">g</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> zip_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Basic_Extensions-zip_fun_range_finite"><span class="command">lemma</span></span> zip_fun_range_finite<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span><span class="free">f</span> <span class="main">∥</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_imageI <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">fst</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_imageI <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">snd</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
    <span class="keyword1" id="Basic_Extensions-zip_fun_split"><span class="command">lemma</span></span> zip_fun_split<span class="main">:</span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="free">g</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∥</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> fst <span class="main">∘</span> <span class="free">h</span> <span class="main">∥</span> snd <span class="main">∘</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">None_None</span> <span class="main">≡</span> <span class="main">(</span>None<span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">None_Some</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>None<span class="main">,</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Some_None</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Some_Some</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span>
  
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">None_None_None</span> <span class="main">≡</span> <span class="main">(</span>None<span class="main">,</span> None<span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">None_None_Some</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>None<span class="main">,</span> None<span class="main">,</span> Some <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">None_Some_None</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>None<span class="main">,</span> Some <span class="bound">y</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">None_Some_Some</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>None<span class="main">,</span> Some <span class="bound">y</span><span class="main">,</span> Some <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Some_None_None</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> None<span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Some_None_Some</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> None<span class="main">,</span> Some <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Some_Some_None</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> Some <span class="bound">y</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Some_Some_Some</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> Some <span class="bound">y</span><span class="main">,</span> Some <span class="bound">z</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Basic_Extensions-inj_Some2"><span class="command">lemma</span></span> inj_Some2<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"inj None_Some"</span></span>
      <span class="quoted"><span class="quoted">"inj Some_None"</span></span>
      <span class="quoted"><span class="quoted">"inj Some_Some"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
    <span class="keyword1" id="Basic_Extensions-inj_Some3"><span class="command">lemma</span></span> inj_Some3<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"inj None_None_Some"</span></span>
      <span class="quoted"><span class="quoted">"inj None_Some_None"</span></span>
      <span class="quoted"><span class="quoted">"inj None_Some_Some"</span></span>
      <span class="quoted"><span class="quoted">"inj Some_None_None"</span></span>
      <span class="quoted"><span class="quoted">"inj Some_None_Some"</span></span>
      <span class="quoted"><span class="quoted">"inj Some_Some_None"</span></span>
      <span class="quoted"><span class="quoted">"inj Some_Some_Some"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">swap</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  
    <span class="keyword1" id="Basic_Extensions-swap_simps"><span class="command">lemma</span></span> swap_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"swap <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> swap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="Basic_Extensions-swap_inj"><span class="command">lemma</span></span> swap_inj<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj swap"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Basic_Extensions-swap_surj"><span class="command">lemma</span></span> swap_surj<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"surj swap"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surjI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">swap</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Basic_Extensions-swap_bij"><span class="command">lemma</span></span> swap_bij<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bij swap"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bijI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">push</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">push</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">pull</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'c</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pull</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
    <span class="keyword1" id="Basic_Extensions-push_simps"><span class="command">lemma</span></span> push_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"push <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> push_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="Basic_Extensions-pull_simps"><span class="command">lemma</span></span> pull_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pull <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pull_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">label</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'label</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">label</span> <span class="main">≡</span> fst <span class="main">∘</span> snd"</span></span>
  
    <span class="keyword1" id="Basic_Extensions-label_select"><span class="command">lemma</span></span> label_select<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"label <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> label_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Theorems for @term{curry} and @term{split}›</span></span>

    <span class="keyword1" id="Basic_Extensions-curry_split"><span class="command">lemma</span></span> curry_split<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"curry <span class="main">∘</span> case_prod <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Basic_Extensions-split_curry"><span class="command">lemma</span></span> split_curry<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="main">∘</span> curry <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1" id="Basic_Extensions-curry_le"><span class="command">lemma</span></span> curry_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"curry <span class="free">f</span> <span class="main">≤</span> curry <span class="free">g</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> le_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="Basic_Extensions-split_le"><span class="command">lemma</span></span> split_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">≤</span> case_prod <span class="free">g</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> le_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
    <span class="keyword1" id="Basic_Extensions-mono_curry_left"><span class="command">lemma</span></span> mono_curry_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>curry <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟷</span> mono <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1" id="Basic_Extensions-mono_split_left"><span class="command">lemma</span></span> mono_split_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟷</span> mono <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1" id="Basic_Extensions-mono_curry_right"><span class="command">lemma</span></span> mono_curry_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> curry<span class="main">)</span> <span class="main">⟷</span> mono <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mono_def split_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">bestsimp</span>
    <span class="keyword1" id="Basic_Extensions-mono_split_right"><span class="command">lemma</span></span> mono_split_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> case_prod<span class="main">)</span> <span class="main">⟷</span> mono <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mono_def curry_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">bestsimp</span>
  
    <span class="keyword1" id="Basic_Extensions-Collect_curry"><span class="command">lemma</span></span> Collect_curry<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>curry <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> case_prod <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> image_Collect <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1" id="Basic_Extensions-Collect_split"><span class="command">lemma</span></span> Collect_split<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>case_prod <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> curry <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> image_Collect <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
    <span class="keyword1" id="Basic_Extensions-gfp_split_curry"><span class="command">lemma</span></span> gfp_split_curry<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gfp <span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> curry<span class="main">)</span> <span class="main">=</span> case_prod <span class="main">(</span>gfp <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gfp <span class="main">(</span>case_prod <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> curry<span class="main">)</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> case_prod <span class="main">(</span><span class="free">f</span> <span class="main">(</span>curry <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gfp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> curry <span class="bound">u</span> <span class="main">≤</span> curry <span class="main">(</span>case_prod <span class="main">(</span><span class="free">f</span> <span class="main">(</span>curry <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> curry_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> curry <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>curry <span class="bound">u</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Sup <span class="main">(</span>case_prod <span class="main">`</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Collect_curry<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">u</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> case_prod <span class="main">(</span>Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> case_prod <span class="main">(</span>gfp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gfp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Basic_Extensions-gfp_curry_split"><span class="command">lemma</span></span> gfp_curry_split<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gfp <span class="main">(</span>curry <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> case_prod<span class="main">)</span> <span class="main">=</span> curry <span class="main">(</span>gfp <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gfp <span class="main">(</span>curry <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> case_prod<span class="main">)</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> curry <span class="main">(</span><span class="free">f</span> <span class="main">(</span>case_prod <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gfp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> case_prod <span class="bound">u</span> <span class="main">≤</span> case_prod <span class="main">(</span>curry <span class="main">(</span><span class="free">f</span> <span class="main">(</span>case_prod <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> split_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> case_prod <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>case_prod <span class="bound">u</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Sup <span class="main">(</span>curry <span class="main">`</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Collect_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">u</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> curry <span class="main">(</span>Sup <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> curry <span class="main">(</span>gfp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gfp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Basic_Extensions-not_someI"><span class="command">lemma</span></span> not_someI<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Basic_Extensions-some_ccontr"><span class="command">lemma</span></span> some_ccontr<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms someI_ex ccontr <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Relation_Extensions">
<div class="head">
<h1>Theory Relation_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Relation_Extensions
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Basic_Extensions.html">Basic_Extensions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rev_lex_prod</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">&lt;*rlex*&gt;</span>"</span> 80<span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">&lt;*rlex*&gt;</span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> inv_image <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">&lt;*lex*&gt;</span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> swap"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> sym_rtranclp<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> sym_rtrancl<span class="main">[</span><span class="operator">to_pred</span><span class="main">]</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">liftablep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">liftablep</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Relation_Extensions-liftablepI"><span class="command">lemma</span></span> liftablepI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"liftablep <span class="free">r</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> liftablep_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Relation_Extensions-liftablepE"><span class="command">lemma</span></span> liftablepE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"liftablep <span class="free">r</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> liftablep_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Relation_Extensions-liftablep_rtranclp"><span class="command">lemma</span></span> liftablep_rtranclp<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"liftablep <span class="free">r</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"liftablep <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">confluentp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">confluentp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="bound">y1</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">y2</span> <span class="bound">z</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Relation_Extensions-confluentpI"><span class="command">lemma</span></span> confluentpI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="bound">y1</span> <span class="main">⟹</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="bound">y2</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">y2</span> <span class="bound">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"confluentp <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> confluentp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Relation_Extensions-confluentpE"><span class="command">lemma</span></span> confluentpE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"confluentp <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y2</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">z</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">y1</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">y2</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> confluentp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="Relation_Extensions-confluentpI'"><span class="command">lemma</span></span> confluentpI'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">x</span> <span class="bound">y1</span> <span class="main">⟹</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y2</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">y2</span> <span class="bound">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"confluentp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y1</span> <span class="skolem">y2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span> <span class="skolem">y1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span> <span class="skolem">y2</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y2</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Relation_Extensions-transclp_eq_implies_confluent_imp"><span class="command">lemma</span></span> transclp_eq_implies_confluent_imp<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="free">r2</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"confluentp <span class="free">r1</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"confluentp <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1" id="Relation_Extensions-transclp_eq_implies_confluent_eq"><span class="command">lemma</span></span> transclp_eq_implies_confluent_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="free">r2</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"confluentp <span class="free">r1</span> <span class="main">⟷</span> confluentp <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms transclp_eq_implies_confluent_imp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">diamondp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">diamondp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">x</span> <span class="bound">y1</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">x</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">y2</span> <span class="bound">z</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Relation_Extensions-diamondpI"><span class="command">lemma</span></span> diamondpI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y1</span> <span class="main">⟹</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y2</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span> <span class="bound">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free">r</span> <span class="bound">y2</span> <span class="bound">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diamondp <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> diamondp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Relation_Extensions-diamondpE"><span class="command">lemma</span></span> diamondpE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diamondp <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span> <span class="free">y1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span> <span class="free">y2</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">z</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">y1</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">y2</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> diamondp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="Relation_Extensions-diamondp_implies_confluentp"><span class="command">lemma</span></span> diamondp_implies_confluentp<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diamondp <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"confluentp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> confluentpI'<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y1</span> <span class="skolem">y2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">x</span> <span class="skolem">y1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">x</span> <span class="skolem">y2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span> <span class="skolem">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y2</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y1</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">y2</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">locale</span></span> wellfounded_relation <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> wellfounded<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="free">R</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Transition_System_Extensions">
<div class="head">
<h1>Theory Transition_System_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Transition Systems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_System_Extensions
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Word_Prefixes.html">Basics/Word_Prefixes</a>"</span>
  <span class="quoted">"<a href="Set_Extensions.html">Extensions/Set_Extensions</a>"</span>
  <span class="quoted">"<a href="Relation_Extensions.html">Extensions/Relation_Extensions</a>"</span>
  <a href="../Transition_Systems_and_Automata/Transition_System.html">Transition_Systems_and_Automata.Transition_System</a>
  <a href="../Transition_Systems_and_Automata/Transition_System_Extra.html">Transition_Systems_and_Automata.Transition_System_Extra</a>
  <a href="../Transition_Systems_and_Automata/Transition_System_Construction.html">Transition_Systems_and_Automata.Transition_System_Construction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">context</span></span> transition_system_initial
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cycles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'transition</span> list set"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cycles</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> path <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> target <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Transition_System_Extensions-cyclesI"><span class="command">lemma</span></span> cyclesI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"target <span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> cycles <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cycles_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Transition_System_Extensions-cyclesE"><span class="command">lemma</span></span> cyclesE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> cycles <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"target <span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cycles_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">executable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> set"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> executable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">enabled</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free">executable</span>"</span></span>

    <span class="keyword1" id="Transition_System_Extensions-executableI_step"><span class="command">lemma</span></span> executableI_step<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> executable"</span></span>
      <span class="keyword1"><span class="command">using</span></span> executable assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1" id="Transition_System_Extensions-executableI_words_fin"><span class="command">lemma</span></span> executableI_words_fin<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">w</span> <span class="main">⊆</span> executable"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
    <span class="keyword1" id="Transition_System_Extensions-executableE"><span class="command">lemma</span></span> executableE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> executable"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_interpreted <span class="main">=</span>
    transition_system <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">visible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> set"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">visible</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">int</span> <span class="bound">q</span> <span class="main">≠</span> <span class="free">int</span> <span class="main">(</span><span class="free">ex</span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Transition_System_Extensions-visibleI"><span class="command">lemma</span></span> visibleI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="free">q</span> <span class="main">≠</span> <span class="free">int</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> visible"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> visible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Transition_System_Extensions-visibleE"><span class="command">lemma</span></span> visibleE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> visible"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="free">q</span> <span class="main">≠</span> <span class="free">int</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> visible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">invisible</span> <span class="main">≡</span> <span class="main">-</span> visible"</span></span>

    <span class="keyword1" id="Transition_System_Extensions-execute_fin_word_invisible"><span class="command">lemma</span></span> execute_fin_word_invisible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">w</span> <span class="main">⊆</span> invisible"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="main">(</span>target <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">int</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Extensions-execute_inf_word_invisible"><span class="command">lemma</span></span> execute_inf_word_invisible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">∉</span> visible"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> <span class="free">l</span> <span class="main">=</span> target <span class="main">(</span>stake <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">l</span> <span class="free">w</span> <span class="main">=</span> stake <span class="free">k</span> <span class="free">w</span> <span class="main">@</span> stake <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"target <span class="main">…</span> <span class="free">p</span> <span class="main">=</span> target <span class="main">(</span>stake <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_append comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> execute_fin_word_invisible<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> stake <span class="free">l</span> <span class="free">w</span> <span class="main">@-</span> sdrop <span class="free">l</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">l</span> <span class="free">w</span> <span class="main">=</span> stake <span class="free">k</span> <span class="free">w</span> <span class="main">@</span> stake <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>stake <span class="free">k</span> <span class="free">w</span> <span class="main">@-</span> stake <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">@-</span> sdrop <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> shift_append <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>stake <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>stake <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_stake_snth<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_complete <span class="main">=</span>
    transition_system_initial <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span> <span class="main">+</span>
    transition_system_interpreted <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">int</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'interpretation</span> stream set"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">language</span> <span class="main">≡</span> <span class="main">{</span>smap <span class="free">int</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> trace <span class="bound">w</span> <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> <span class="free">init</span> <span class="bound">p</span> <span class="main">∧</span> run <span class="bound">w</span> <span class="bound">p</span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Transition_System_Extensions-languageI"><span class="command">lemma</span></span> languageI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> smap <span class="free">int</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">v</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Transition_System_Extensions-languageE"><span class="command">lemma</span></span> languageE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="free">v</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> smap <span class="free">int</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">v</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_finite_nodes <span class="main">=</span>
    transition_system_initial <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> reachable_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite nodes"</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_cut <span class="main">=</span>
    transition_system_finite_nodes <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cuts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> cycles_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> cycles <span class="free">p</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> set <span class="free">w</span> <span class="main">∩</span> <span class="free">cuts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">scut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> scut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">en</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free">cuts</span> <span class="main">⟹</span> <span class="free">scut</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free">ex</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">declare</span></span> scut.intros<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> scut.cases<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

    <span class="keyword1" id="Transition_System_Extensions-scut_reachable"><span class="command">lemma</span></span> scut_reachable<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"scut <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Transition_System_Extensions-scut_trancl"><span class="command">lemma</span></span> scut_trancl<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"scut<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"target <span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">w</span> <span class="main">∩</span> <span class="free">cuts</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"target <span class="skolem">w</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">∩</span> <span class="free">cuts</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="skolem">a</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="free">cuts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"target <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> <span class="free">cuts</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">sublocale</span></span> wellfounded_relation <span class="quoted"><span class="quoted">"scut<span class="main">¯¯</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> finite_acyclic_wf_converse<span class="main"><span class="main">[</span></span><span class="operator">to_pred</span><span class="main"><span class="main">]</span></span> acyclicI<span class="main"><span class="main">[</span></span><span class="operator">to_pred</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> scut <span class="bound">p</span> <span class="bound">q</span><span class="main">}</span> <span class="main">⊆</span> nodes <span class="main">×</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> scut_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="main">×</span> nodes<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_cartesian_product reachable_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> scut <span class="bound">p</span> <span class="bound">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"scut<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">p</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 tranclE<span class="main">[</span><span class="operator">to_pred</span><span class="main">]</span> scut_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">w</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"target <span class="skolem">w</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">∩</span> <span class="free">cuts</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> scut_trancl 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> cycles <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">∩</span> <span class="free">cuts</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cycles_cut 2 4 3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Transition_System_Extensions-no_cut_scut"><span class="command">lemma</span></span> no_cut_scut<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">cuts</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"scut<span class="main">¯¯</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_sticky <span class="main">=</span>
    transition_system_complete <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">int</span></span> <span class="main">+</span>
    transition_system_cut <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">sticky</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sticky</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> set"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> executable_visible_sticky<span class="main">:</span> <span class="quoted"><span class="quoted">"executable <span class="main">∩</span> visible <span class="main">⊆</span> <span class="free">sticky</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Traces">
<div class="head">
<h1>Theory Traces</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Trace Theory›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Traces
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Word_Prefixes.html">Basics/Word_Prefixes</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> traces <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> <span class="main">⇒</span> <span class="tfree">'item</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> independence_symmetric<span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">ind</span> <span class="free">b</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> set <span class="main">⇒</span> <span class="tfree">'item</span> set <span class="main">⇒</span> bool"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ind</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> <span class="free">ind</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>

    <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eq_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> list <span class="main">⇒</span> <span class="tfree">'item</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span>"</span> 50<span class="main">)</span>
      <span class="keyword2"><span class="keyword">where</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>S</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

    <span class="keyword1"><span class="command">declare</span></span> eq_swap.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> eq_swap.cases<span class="main">[</span><span class="operator">elim</span><span class="main">]</span>

    <span class="keyword1" id="Traces-eq_swap_sym"><span class="command">lemma</span></span> eq_swap_sym<span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> independence_symmetric <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-eq_swap_length"><span class="command">lemma</span></span> eq_swap_length<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> length <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="Traces-eq_swap_range"><span class="command">lemma</span></span> eq_swap_range<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> set <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> set <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1" id="Traces-eq_swap_extend"><span class="command">lemma</span></span> eq_swap_extend<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>swap <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">u'</span> <span class="skolem">v'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">u'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">v'</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">v'</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">u'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-eq_swap_remove1"><span class="command">lemma</span></span> eq_swap_remove1<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>equal<span class="main">)</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> remove1 <span class="free">c</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="main">|</span> <span class="main">(</span>swap<span class="main">)</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> remove1 <span class="free">c</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>swap <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> set <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∨</span>
        <span class="free">c</span> <span class="main">∈</span> set <span class="skolem">u</span> <span class="main">∨</span>
        <span class="free">c</span> <span class="main">∉</span> set <span class="skolem">u</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span>
        <span class="free">c</span> <span class="main">∉</span> set <span class="skolem">u</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∨</span>
        <span class="free">c</span> <span class="main">∉</span> set <span class="skolem">u</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> <span class="skolem">b</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">∈</span> set <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> set <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> set <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> remove1_idem 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> remove1_idem 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> eq_swap.intros swap<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> swap<span class="main">(</span>3<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> remove1 <span class="free">c</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> remove1 <span class="free">c</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> eq_swap.intros swap<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> swap<span class="main">(</span>3<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> set <span class="skolem">u</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> remove1_idem 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> remove1_idem 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> swap<span class="main">(</span>2<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> set <span class="skolem">u</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> remove1_idem 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> remove1_idem 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> swap<span class="main">(</span>2<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> set <span class="skolem">u</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> <span class="skolem">b</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">∈</span> set <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="free">c</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="free">c</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> remove1_append <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> remove1 <span class="free">c</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> eq_swap.intros swap<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> swap<span class="main">(</span>3<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-eq_swap_rev"><span class="command">lemma</span></span> eq_swap_rev<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> rev <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>swap <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="skolem">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> rev <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> rev <span class="skolem">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> rev <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="skolem">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> rev <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> rev <span class="skolem">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> rev <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 eq_swap_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eq_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> list <span class="main">⇒</span> <span class="tfree">'item</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span>"</span> 50<span class="main">)</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">eq_fin</span> <span class="main">≡</span> eq_swap<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

    <span class="keyword1" id="Traces-eq_fin_symp"><span class="command">lemma</span></span> eq_fin_symp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_swap_sym sym_rtrancl<span class="main">[</span><span class="operator">to_pred</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> symp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1" id="Traces-eq_fin_length"><span class="command">lemma</span></span> eq_fin_length<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> length <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Traces-eq_fin_range"><span class="command">lemma</span></span> eq_fin_range<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> set <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> set <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1" id="Traces-eq_fin_remove1"><span class="command">lemma</span></span> eq_fin_remove1<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"remove1 <span class="free">c</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> remove1 <span class="free">c</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq_swap_remove1<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?c</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> equal
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step equal <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> swap
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-eq_fin_rev"><span class="command">lemma</span></span> eq_fin_rev<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> rev <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_swap_rev<span class="main">)</span>

    <span class="keyword1" id="Traces-eq_fin_concat_eq_fin_start"><span class="command">lemma</span></span> eq_fin_concat_eq_fin_start<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_remove1<span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-eq_fin_concat"><span class="command">lemma</span></span> eq_fin_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_concat_eq_fin_start 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> rev <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_fin_rev<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">v</span> <span class="main">@</span> rev <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> rev <span class="free">v</span> <span class="main">@</span> rev <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> rev <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_concat_eq_fin_start 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>rev <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> rev <span class="main">(</span>rev <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_fin_rev<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_swap_extend<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-eq_fin_concat_start"><span class="command">lemma</span></span> eq_fin_concat_start<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_fin_concat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">w</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="Traces-eq_fin_concat_end"><span class="command">lemma</span></span> eq_fin_concat_end<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_fin_concat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">w</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1" id="Traces-ind_eq_fin'"><span class="command">lemma</span></span> ind_eq_fin'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_swap.intros<span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-ind_eq_fin"><span class="command">lemma</span></span> ind_eq_fin<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">u</span><span class="main">)</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">@</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ind_eq_fin' 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">le_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> list <span class="main">⇒</span> <span class="tfree">'item</span> list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span>"</span> 50<span class="main">)</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≼<span class="hidden">⇩</span><sub>F</sub></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">@</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

    <span class="keyword1" id="Traces-le_finI"><span class="command">lemma</span></span> le_finI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_fin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-le_finE"><span class="command">lemma</span></span> le_finE<span class="main">[</span><span class="operator">elim</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_fin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-le_fin_empty"><span class="command">lemma</span></span> le_fin_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="Traces-le_fin_trivial"><span class="command">lemma</span></span> le_fin_trivial<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[]</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_fin_length"><span class="command">lemma</span></span> le_fin_length<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> length <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> length <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="Traces-le_fin_range"><span class="command">lemma</span></span> le_fin_range<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> set <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> set <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1" id="Traces-eq_fin_alt_def"><span class="command">lemma</span></span> eq_fin_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> le_finE<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> length <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 6 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_fin_reflp"><span class="command">lemma</span></span> le_fin_reflp<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-le_fin_transp"><span class="command">lemma</span></span> le_fin_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-eq_fin_le_fin_transp"><span class="command">lemma</span></span> eq_fin_le_fin_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-le_fin_eq_fin_transp"><span class="command">lemma</span></span> le_fin_eq_fin_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-prefix_le_fin_transp"><span class="command">lemma</span></span> prefix_le_fin_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_fin_prefix_transp"><span class="command">lemma</span></span> le_fin_prefix_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-prefix_eq_fin_transp"><span class="command">lemma</span></span> prefix_eq_fin_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-le_fin_concat_start"><span class="command">lemma</span></span> le_fin_concat_start<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_fin_concat_end"><span class="command">lemma</span></span> le_fin_concat_end<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">le_fininf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> list <span class="main">⇒</span> <span class="tfree">'item</span> stream <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span>"</span> 50<span class="main">)</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

    <span class="keyword1" id="Traces-le_fininfI"><span class="command">lemma</span></span> le_fininfI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_fininf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-le_fininfE"><span class="command">lemma</span></span> le_fininfE<span class="main">[</span><span class="operator">elim</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_fininf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-le_fininf_empty"><span class="command">lemma</span></span> le_fininf_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1" id="Traces-le_fininf_range"><span class="command">lemma</span></span> le_fininf_range<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> set <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> sset <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1" id="Traces-eq_fin_le_fininf_transp"><span class="command">lemma</span></span> eq_fin_le_fininf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-le_fin_le_fininf_transp"><span class="command">lemma</span></span> le_fin_le_fininf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-prefix_le_fininf_transp"><span class="command">lemma</span></span> prefix_le_fininf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-le_fin_prefix_fininf_transp"><span class="command">lemma</span></span> le_fin_prefix_fininf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-eq_fin_prefix_fininf_transp"><span class="command">lemma</span></span> eq_fin_prefix_fininf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-le_fininf_concat_start"><span class="command">lemma</span></span> le_fininf_concat_start<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">≤</span> length <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≤</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefix_fininf_extend<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">w</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_fininf_singleton"><span class="command">lemma</span></span> le_fininf_singleton<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>shd <span class="free">v</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>shd <span class="free">v</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> shd <span class="free">v</span> <span class="main">##</span> sdrop <span class="main">1</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">le_inf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> stream <span class="main">⇒</span> <span class="tfree">'item</span> stream <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span>"</span> 50<span class="main">)</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≼<span class="hidden">⇩</span><sub>I</sub></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟶</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

    <span class="keyword1" id="Traces-le_infI"><span class="command">lemma</span></span> le_infI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_inf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-le_infE"><span class="command">lemma</span></span> le_infE<span class="main">[</span><span class="operator">elim</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> le_inf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-le_inf_range"><span class="command">lemma</span></span> le_inf_range<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sset <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> sset <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> sset <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE sset_range<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lessI set_stake_snth<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> sset <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">using</span></span> 5 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_inf_reflp"><span class="command">lemma</span></span> le_inf_reflp<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-prefix_fininf_le_inf_transp"><span class="command">lemma</span></span> prefix_fininf_le_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-le_fininf_le_inf_transp"><span class="command">lemma</span></span> le_fininf_le_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-le_inf_transp"><span class="command">lemma</span></span> le_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1" id="Traces-le_infI'"><span class="command">lemma</span></span> le_infI'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u</span> <span class="main">≤</span> length <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefix_fininf_length 1 2<span class="main">(</span>1<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_infI_chain_left"><span class="command">lemma</span></span> le_infI_chain_left<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">w</span> <span class="bound">k</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">w</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_infI'<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">va</span><span class="main">.</span> <span class="bound">va</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="bound">va</span> <span class="main">∧</span> <span class="bound">va</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">l</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_prefix_limit assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">l</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_infI_chain_right"><span class="command">lemma</span></span> le_infI_chain_right<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span> <span class="main">⟹</span> <span class="bound">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">(</span><span class="free">l</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">(</span><span class="free">l</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_prefix_limit assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">(</span><span class="free">l</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_infI_chain_right'"><span class="command">lemma</span></span> le_infI_chain_right'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> stake <span class="bound">k</span> <span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">(</span><span class="free">l</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_infI_chain_right<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_fininf_def shift_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">(</span><span class="free">l</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span> <span class="main">(</span><span class="free">l</span> <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_inf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> stream <span class="main">⇒</span> <span class="tfree">'item</span> stream <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span>"</span> 50<span class="main">)</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇩</span><sub>I</sub></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span>

    <span class="keyword1" id="Traces-eq_infI"><span class="command">lemma</span></span> eq_infI<span class="main">[</span><span class="operator">intro</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_inf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-eq_infE"><span class="command">lemma</span></span> eq_infE<span class="main">[</span><span class="operator">elim</span> 0<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eq_inf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-eq_inf_range"><span class="command">lemma</span></span> eq_inf_range<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> sset <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> sset <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1" id="Traces-eq_inf_reflp"><span class="command">lemma</span></span> eq_inf_reflp<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-eq_inf_symp"><span class="command">lemma</span></span> eq_inf_symp<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-eq_inf_transp"><span class="command">lemma</span></span> eq_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-le_fininf_eq_inf_transp"><span class="command">lemma</span></span> le_fininf_eq_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-le_inf_eq_inf_transp"><span class="command">lemma</span></span> le_inf_eq_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-eq_inf_le_inf_transp"><span class="command">lemma</span></span> eq_inf_le_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-prefix_fininf_eq_inf_transp"><span class="command">lemma</span></span> prefix_fininf_eq_inf_transp<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1" id="Traces-le_inf_concat_start"><span class="command">lemma</span></span> le_inf_concat_start<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>
        <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>
        <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prefix_fininf_append<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>absorb<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> absorb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">z</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 extend <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-eq_fin_le_inf_concat_end"><span class="command">lemma</span></span> eq_fin_le_inf_concat_end<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">w</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">w</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prefix_fininf_append<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>absorb<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> absorb 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">w'</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">w'</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> extend<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-eq_inf_concat_start"><span class="command">lemma</span></span> eq_inf_concat_start<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟷</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-eq_inf_concat_end"><span class="command">lemma</span></span> eq_inf_concat_end<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_fin_le_inf_concat_end<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> eq_fin_le_inf_concat_end<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_fininf_suffixI"><span class="command">lemma</span></span> le_fininf_suffixI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Traces-le_fininf_suffixE"><span class="command">lemma</span></span> le_fininf_suffixE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-subsume_fin"><span class="command">lemma</span></span> subsume_fin<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_cases<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> le
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> prefix_fininf_length<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> ge
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> prefix_fininf_length<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ge<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-eq_fin_end"><span class="command">lemma</span></span> eq_fin_end<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">indoc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item</span> <span class="main">⇒</span> <span class="tfree">'item</span> list <span class="main">⇒</span> bool"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">indoc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> set <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> Ind <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span> <span class="main">(</span>set <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Traces-indoc_set"><span class="command">lemma</span></span> indoc_set<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> indoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Traces-indoc_appendI1"><span class="command">lemma</span></span> indoc_appendI1<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> indoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="Traces-indoc_appendI2"><span class="command">lemma</span></span> indoc_appendI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> indoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> indoc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-indoc_appendE"><span class="command">lemma</span></span> indoc_appendE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>first<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">u</span>"</span></span> <span class="main">|</span> <span class="main">(</span>second<span class="main">)</span>  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> indoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> split_list_first_unique<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> first<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">u</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> indoc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> indoc_set assms False <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> split_list_first_unique<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> second<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">v</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> indoc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-indoc_single"><span class="command">lemma</span></span> indoc_single<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> indoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_Cons_conv append_is_Nil_conv list.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> indoc_def 1
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> set <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span>set <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-indoc_append"><span class="command">lemma</span></span> indoc_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span>
      indoc <span class="free">a</span> <span class="free">u</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">∉</span> set <span class="free">u</span> <span class="main">∧</span> Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">u</span><span class="main">)</span> <span class="main">∧</span> indoc <span class="free">a</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1" id="Traces-indoc_Nil"><span class="command">lemma</span></span> indoc_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">[]</span> <span class="main">⟷</span> False"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> indoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-indoc_Cons"><span class="command">lemma</span></span> indoc_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">ind</span> <span class="free">a</span> <span class="free">b</span> <span class="main">∧</span> indoc <span class="free">a</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> indoc <span class="free">a</span> <span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> indoc <span class="free">a</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">∉</span> set <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">∧</span> Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> indoc <span class="free">a</span> <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> indoc_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">ind</span> <span class="free">a</span> <span class="free">b</span> <span class="main">∧</span> indoc <span class="free">a</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> indoc_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-eq_swap_indoc"><span class="command">lemma</span></span> eq_swap_indoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">v</span> <span class="main">⟹</span> indoc <span class="free">c</span> <span class="free">u</span> <span class="main">⟹</span> indoc <span class="free">c</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Traces-eq_fin_indoc"><span class="command">lemma</span></span> eq_fin_indoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">⟹</span> indoc <span class="free">c</span> <span class="free">u</span> <span class="main">⟹</span> indoc <span class="free">c</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1" id="Traces-eq_fin_ind'"><span class="command">lemma</span></span> eq_fin_ind'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_indoc assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-eq_fin_ind"><span class="command">lemma</span></span> eq_fin_ind<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">u</span> <span class="main">∩</span> set <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">u</span><span class="main">)</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_fin_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">@</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="free">v</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">@</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">u</span> <span class="main">∩</span> set <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_fin_member'"><span class="command">lemma</span></span> le_fin_member'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_fin_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">≤</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_fin_not_member'"><span class="command">lemma</span></span> le_fin_not_member'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> 3<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_fin_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 4<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">≤</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_fininf_not_member'"><span class="command">lemma</span></span> le_fininf_not_member'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_fininfE assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prefix_fininf_append<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> absorb
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> absorb <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">z</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">u</span> <span class="main">@</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_fin_not_member' 2 assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-le_fin_ind''"><span class="command">lemma</span></span> le_fin_ind''<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 assms<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil eq_fin_range list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_ConsD<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> 4<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_fin_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 5<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 5<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_fin_ind'"><span class="command">lemma</span></span> le_fin_ind'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fin_ind''<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fin_not_member'<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">[</span><span class="skolem">b</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Traces-le_fininf_ind''"><span class="command">lemma</span></span> le_fininf_ind''<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subsume_fin le_fin_ind'' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1" id="Traces-le_fininf_ind'"><span class="command">lemma</span></span> le_fininf_ind'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subsume_fin le_fin_ind' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1" id="Traces-indoc_alt_def"><span class="command">lemma</span></span> indoc_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="free">a</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">v</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> indoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="free">a</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>1<span class="main">)</span> remove1_append <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="free">a</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="free">a</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="free">a</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"indoc <span class="free">a</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_indoc 0  1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Traces-levi_lemma"><span class="command">lemma</span></span> levi_lemma<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">@</span> <span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p</span> <span class="free">r</span> <span class="free">s</span> <span class="free">q</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">p</span> <span class="main">@</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">s</span> <span class="main">@</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">p</span> <span class="main">@</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">r</span> <span class="main">@</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">r</span><span class="main">)</span> <span class="main">(</span>set <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Nil<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[]</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[]</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_fin_not_member' 1 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_fin_ind'<span class="main">[</span><span class="operator">OF</span> 1 4<span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">t'</span> <span class="main">@</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">@</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">@</span> <span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">s</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span>
          <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">r'</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ 6<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">v</span> <span class="main">=</span> set <span class="skolem">p</span> <span class="main">∪</span> set <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_range 7<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">t'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">s</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">p</span> <span class="main">@</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>5<span class="main">)</span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_fin_member' 1 True <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">t'</span> <span class="main">@</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">@</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">@</span> <span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v'</span> <span class="main">@</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">p'</span> <span class="main">@</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">s</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">p'</span> <span class="main">@</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">r</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span>
          <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ 4<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p'</span> <span class="main">@</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">t'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">s</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p'</span> <span class="main">@</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">r</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Transition_System_Traces">
<div class="head">
<h1>Theory Transition_System_Traces</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Transition Systems and Trace Theory›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_System_Traces
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Transition_System_Extensions.html">Transition_System_Extensions</a>
  <a href="Traces.html">Traces</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> transition_system<span class="main">)</span> words_infI_construct<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">⟶</span> path <span class="bound">v</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduct</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> transition_system<span class="main">)</span> words_infI_construct'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="bound">v</span> <span class="main">∧</span> path <span class="bound">v</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">u</span> <span class="main">&lt;</span> length <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">u</span> <span class="main">≤</span> length <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefix_fininf_length 1 2<span class="main">(</span>1<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">u</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> transition_system<span class="main">)</span> words_infI_construct_chain<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> path <span class="main">(</span><span class="free">w</span> <span class="bound">k</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>limit <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> words_infI_construct'<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="bound">v</span> <span class="main">∧</span> path <span class="bound">v</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">l</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> limit <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_prefix_limit assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> transition_system<span class="main">)</span> words_fin_blocked<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> path <span class="bound">w</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∩</span> set <span class="bound">w</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="main">(</span>target <span class="bound">w</span> <span class="free">p</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="free">p</span><span class="main">}</span> <span class="main">∩</span> set <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_traces <span class="main">=</span>
    transition_system <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="main">+</span>
    traces <span class="quoted"><span class="free">ind</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'action</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> en<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">en</span> <span class="free">a</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">en</span> <span class="free">b</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">en</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">en</span> <span class="free">a</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">en</span> <span class="free">b</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">ex</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">ex</span> <span class="free">a</span> <span class="main">(</span><span class="free">ex</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Transition_System_Traces-diamond_bottom"><span class="command">lemma</span></span> diamond_bottom<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">b</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="main">(</span><span class="free">ex</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">ex</span> <span class="free">a</span> <span class="main">(</span><span class="free">ex</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms independence_symmetric en ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1" id="Transition_System_Traces-diamond_right"><span class="command">lemma</span></span> diamond_right<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="main">(</span><span class="free">ex</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">b</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">ex</span> <span class="free">a</span> <span class="main">(</span><span class="free">ex</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms independence_symmetric en ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1" id="Transition_System_Traces-diamond_left"><span class="command">lemma</span></span> diamond_left<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="main">(</span><span class="free">ex</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">b</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="free">b</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">ex</span> <span class="free">a</span> <span class="main">(</span><span class="free">ex</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms independence_symmetric en ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1" id="Transition_System_Traces-eq_swap_word"><span class="command">lemma</span></span> eq_swap_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms diamond_right <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Traces-eq_fin_word"><span class="command">lemma</span></span> eq_fin_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms eq_swap_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Traces-le_fin_word"><span class="command">lemma</span></span> le_fin_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms eq_fin_word <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Transition_System_Traces-le_fininf_word"><span class="command">lemma</span></span> le_fininf_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms le_fin_word <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Transition_System_Traces-le_inf_word"><span class="command">lemma</span></span> le_inf_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms le_fininf_word <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> words_infI_construct<span class="main">)</span>
    <span class="keyword1" id="Transition_System_Traces-eq_inf_word"><span class="command">lemma</span></span> eq_inf_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms le_inf_word <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Transition_System_Traces-eq_swap_execute"><span class="command">lemma</span></span> eq_swap_execute<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold <span class="free">ex</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span> <span class="main">=</span> fold <span class="free">ex</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">)</span> diamond_right <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Traces-eq_fin_execute"><span class="command">lemma</span></span> eq_fin_execute<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold <span class="free">ex</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span> <span class="main">=</span> fold <span class="free">ex</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">)</span> eq_fin_word eq_swap_execute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1" id="Transition_System_Traces-diamond_fin_word_step"><span class="command">lemma</span></span> diamond_fin_word_step<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diamond_bottom assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Traces-diamond_inf_word_step"><span class="command">lemma</span></span> diamond_inf_word_step<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diamond_fin_word_step assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> words_infI_construct<span class="main">)</span>
    <span class="keyword1" id="Transition_System_Traces-diamond_fin_word_inf_word"><span class="command">lemma</span></span> diamond_fin_word_inf_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="main">(</span>fold <span class="free">ex</span> <span class="free">v</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diamond_inf_word_step assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Traces-diamond_fin_word_inf_word'"><span class="command">lemma</span></span> diamond_fin_word_inf_word'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">@-</span> <span class="free">w</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms diamond_fin_word_inf_word <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Functions">
<div class="head">
<h1>Theory Functions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Functions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Functions
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Set_Extensions.html">../Extensions/Set_Extensions</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> bounded_function <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">?</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>

  <span class="keyword1"><span class="command">locale</span></span> bounded_function_pair <span class="main">=</span>
    f<span class="main">:</span> bounded_function <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">f</span></span> <span class="main">+</span>
    g<span class="main">:</span> bounded_function <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">g</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>

  <span class="keyword1"><span class="command">locale</span></span> injection <span class="main">=</span> bounded_function_pair <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> left_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Functions-inj_on"><span class="command">lemma</span></span> inj_on<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_onI left_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1" id="Functions-injective_on"><span class="command">lemma</span></span> injective_on<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms left_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> injective <span class="main">=</span> bounded_function <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> injection<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g</span><span class="main">.</span> injection <span class="free">A</span> <span class="free">B</span> <span class="free">f</span> <span class="bound">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">g</span><span class="main">.</span> injection <span class="free">A</span> <span class="free">B</span> <span class="free">f</span> <span class="bound">g</span>"</span></span>

    <span class="keyword1"><span class="command">sublocale</span></span> injection <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">g</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> injection<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> surjection <span class="main">=</span> bounded_function_pair <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> right_inverse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Functions-image_superset"><span class="command">lemma</span></span> image_superset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊇</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g.wellformed image_iff right_inverse subsetI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1" id="Functions-image_eq"><span class="command">lemma</span></span> image_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> image_superset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> surjective <span class="main">=</span> bounded_function <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> surjection<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g</span><span class="main">.</span> surjection <span class="free">A</span> <span class="free">B</span> <span class="free">f</span> <span class="bound">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">g</span><span class="main">.</span> surjection <span class="free">A</span> <span class="free">B</span> <span class="free">f</span> <span class="bound">g</span>"</span></span>

    <span class="keyword1"><span class="command">sublocale</span></span> surjection <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">g</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> surjection<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> bijection <span class="main">=</span> injection <span class="main">+</span> surjection

  <span class="keyword1" id="Functions-inj_on_bijection"><span class="command">lemma</span></span> inj_on_bijection<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bijection <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span>inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imageI <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟹</span> inv_into <span class="free">A</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv_into_into <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv_into_f_f assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>inv_into <span class="free">A</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_inv_into_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ENat_Extensions">
<div class="head">
<h1>Theory ENat_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extended Natural Numbers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ENat_Extensions
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Coinductive/Coinductive_Nat.html">Coinductive.Coinductive_Nat</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">declare</span></span> eSuc_enat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> iadd_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> iadd_Suc_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> enat_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> enat_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> one_eSuc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> enat_0_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> enat_1_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> Suc_ile_eq<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>

  <span class="keyword1" id="ENat_Extensions-enat_Suc0"><span class="command">lemma</span></span> enat_Suc0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def one_eSuc one_enat_def<span class="main">)</span>

  <span class="keyword1" id="ENat_Extensions-le_epred"><span class="command">lemma</span></span> le_epred<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> epred <span class="free">k</span> <span class="main">⟷</span> eSuc <span class="free">l</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eSuc_le_iff epred_eSuc epred_le_epredI less_le_not_le not_le<span class="main">)</span>

  <span class="keyword1" id="ENat_Extensions-eq_infI"><span class="command">lemma</span></span> eq_infI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> enat <span class="bound">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_less_imp_le enat_ord_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> less_le_not_le<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CCPO_Extensions">
<div class="head">
<h1>Theory CCPO_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Chain-Complete Partial Orders›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CCPO_Extensions
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Complete_Partial_Order2.html">HOL-Library.Complete_Partial_Order2</a>"</span>
  <a href="ENat_Extensions.html">ENat_Extensions</a>
  <a href="Set_Extensions.html">Set_Extensions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="CCPO_Extensions-chain_split"><span class="command">lemma</span></span> chain_split<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="free">ord</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="free">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="bound">y</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">ord</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="free">ord</span> <span class="bound">y</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chainD assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="CCPO_Extensions-infinite_chain_below"><span class="command">lemma</span></span> infinite_chain_below<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="free">ord</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="free">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="bound">y</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="free">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="bound">y</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_Un assms<span class="main">(</span>2<span class="main">,</span> 4<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="CCPO_Extensions-infinite_chain_above"><span class="command">lemma</span></span> infinite_chain_above<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain <span class="free">ord</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="bound">y</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="free">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="free">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="free">ord</span> <span class="bound">y</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_Un assms<span class="main">(</span>2<span class="main">,</span> 4<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ccpo<span class="main">)</span> ccpo_Sup_upper_inv<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">⨆</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ccpo_Sup_upper <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ccpo<span class="main">)</span> ccpo_Sup_least_inv<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span> <span class="free">C</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ccpo_Sup_least that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1" id="CCPO_Extensions-ccpo_Sup_least_inv'"><span class="command">lemma</span></span> ccpo_Sup_least_inv'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ccpo<span class="main">,</span> linorder<span class="main">}</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span> <span class="free">C</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ccpo_Sup_least_inv assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="CCPO_Extensions-mcont2mcont_lessThan"><span class="command">lemma</span></span> mcont2mcont_lessThan<span class="main">[</span><span class="operator">THEN</span> lfp.mcont2mcont<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont_intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> mcont_lessThan<span class="main">:</span> <span class="quoted"><span class="quoted">"mcont Sup less_eq Sup less_eq
      <span class="main">(</span>lessThan <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ccpo<span class="main">,</span> linorder<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"monotone less_eq less_eq <span class="main">(</span>lessThan <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cont Sup less_eq Sup less_eq <span class="main">(</span>lessThan <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="skolem">C</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="main">⨆</span> <span class="skolem">C</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>lessThan <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
        <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="main">⨆</span> <span class="skolem">C</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">&gt;</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ccpo_Sup_least_inv' 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>lessThan <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
        <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span>lessThan <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="main">⨆</span> <span class="skolem">C</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ccpo_Sup_upper 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">class</span></span> esize <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">esize</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> enat"</span></span>

  <span class="keyword1"><span class="command">class</span></span> esize_order <span class="main">=</span> esize <span class="main">+</span> order <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> esize_finite<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="free">x</span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> esize_mono<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> esize <span class="free">x</span> <span class="main">≤</span> esize <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> esize_strict_mono<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="free">x</span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟹</span> esize <span class="free">x</span> <span class="main">&lt;</span> esize <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="CCPO_Extensions-infinite_chain_eSuc_esize"><span class="command">lemma</span></span> infinite_chain_eSuc_esize<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="free">y</span> <span class="main">≥</span> eSuc <span class="main">(</span>esize <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"esize <span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>enat <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> esize_finite enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> <span class="free">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="skolem">y</span> <span class="main">&gt;</span> esize <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> esize_strict_mono enat 5<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 5<span class="main">(</span>1<span class="main">)</span> 6 ileI1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infinity<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that infinity assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="CCPO_Extensions-infinite_chain_arbitrary_esize"><span class="command">lemma</span></span> infinite_chain_arbitrary_esize<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="free">x</span> <span class="main">≥</span> enat <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">x</span> <span class="main">≥</span> enat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">y</span> <span class="main">≥</span> eSuc <span class="main">(</span>esize <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gfp.leq_trans Suc<span class="main">(</span>2<span class="main">)</span> 1<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">class</span></span> esize_ccpo <span class="main">=</span> esize_order <span class="main">+</span> ccpo
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="CCPO_Extensions-esize_cont"><span class="command">lemma</span></span> esize_cont<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"esize <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span> <span class="main">(</span>esize <span class="main">`</span> <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">A</span> <span class="main">≥</span> enat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≤</span> <span class="main">⨆</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ccpo_Sup_upper assms<span class="main">(</span>1<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">≤</span> esize <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> esize <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">≤</span> esize <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨆</span> <span class="bound">A</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> esize <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">A</span> <span class="main">≥</span> enat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">A</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> esize <span class="bound">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SUP_upper2 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> esize <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> order_class.antisym SUP_upper SUP_least esize_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_chain_finite assms<span class="main">(</span>1<span class="main">)</span> True assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⨆</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ccpo_Sup_upper assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="CCPO_Extensions-esize_mcont"><span class="command">lemma</span></span> esize_mcont<span class="main">:</span> <span class="quoted"><span class="quoted">"mcont Sup less_eq Sup less_eq esize"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mcontI monotoneI contI<span class="main">)</span>
  
    <span class="keyword1"><span class="command">lemmas</span></span> mcont2mcont_esize <span class="main">=</span> esize_mcont<span class="main">[</span><span class="operator">THEN</span> lfp.mcont2mcont<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont_intro</span><span class="main">]</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ESet_Extensions">
<div class="head">
<h1>Theory ESet_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sets and Extended Natural Numbers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ESet_Extensions
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Functions.html">../Basics/Functions</a>"</span>
  <a href="Basic_Extensions.html">Basic_Extensions</a>
  <a href="CCPO_Extensions.html">CCPO_Extensions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="ESet_Extensions-card_lessThan_enat"><span class="command">lemma</span></span> card_lessThan_enat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{..&lt;</span> enat <span class="free">k</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{..&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> enat <span class="free">k</span><span class="main">}</span> <span class="main">=</span> enat <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lessThan_def image_Collect <span class="keyword1"><span class="command">using</span></span> enat_iless <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{..&lt;</span> enat <span class="free">k</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span>enat <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{..&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_image inj_enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="ESet_Extensions-card_atMost_enat"><span class="command">lemma</span></span> card_atMost_enat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{..</span> enat <span class="free">k</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{..</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..</span> enat <span class="free">k</span><span class="main">}</span> <span class="main">=</span> enat <span class="main">`</span> <span class="main">{..</span> <span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> atMost_def image_Collect <span class="keyword1"><span class="command">using</span></span> enat_ile <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{..</span> enat <span class="free">k</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span>enat <span class="main">`</span> <span class="main">{..</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{..</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_image inj_enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-enat_Collect"><span class="command">lemma</span></span> enat_Collect<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∞</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> the_enat <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> enat_the_enat<span class="main">)</span>

  <span class="keyword1" id="ESet_Extensions-Collect_lessThan"><span class="command">lemma</span></span> Collect_lessThan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> the_enat <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∞</span> <span class="main">∉</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> the_enat <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enat_Collect 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">instantiation</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">esize_ccpo</span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">function</span></span> <span class="entity"><span class="class_parameter">esize_set</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> esize <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> enat <span class="main">(</span>card <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"infinite <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> esize <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

    <span class="keyword1" id="ESet_Extensions-esize_iff_empty"><span class="command">lemma</span></span> esize_iff_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="free">A</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="ESet_Extensions-esize_iff_infinite"><span class="command">lemma</span></span> esize_iff_infinite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="free">A</span> <span class="main">=</span> <span class="main">∞</span> <span class="main">⟷</span> infinite <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="ESet_Extensions-esize_singleton"><span class="command">lemma</span></span> esize_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">=</span> eSuc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="ESet_Extensions-esize_infinite_enat"><span class="command">lemma</span></span> esize_infinite_enat<span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span> <span class="main">⟹</span> enat <span class="free">k</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">instance</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="skolem">A</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">⊆</span> <span class="skolem">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">A</span> <span class="main">≤</span> esize <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_mono True 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="skolem">A</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊂</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">A</span> <span class="main">&lt;</span> esize <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset_card_mono 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1" id="ESet_Extensions-esize_image"><span class="command">lemma</span></span> esize_image<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"esize <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_image finite_imageD assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="ESet_Extensions-esize_insert1"><span class="command">lemma</span></span> esize_insert1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> esize <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span>esize <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="ESet_Extensions-esize_insert2"><span class="command">lemma</span></span> esize_insert2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> esize <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_absorb <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="ESet_Extensions-esize_remove1"><span class="command">lemma</span></span> esize_remove1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> esize <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="ESet_Extensions-esize_remove2"><span class="command">lemma</span></span> esize_remove2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> esize <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> epred <span class="main">(</span>esize <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="ESet_Extensions-esize_union_disjoint"><span class="command">lemma</span></span> esize_union_disjoint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"esize <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> esize <span class="free">A</span> <span class="main">+</span> esize <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_Un_disjoint assms True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="ESet_Extensions-esize_lessThan"><span class="command">lemma</span></span> esize_lessThan<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>enat <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> enat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_lessThan_enat_iff not_enat_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infinity<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> infinity <span class="keyword1"><span class="command">using</span></span> infinite_lessThan_infty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> infinity <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="ESet_Extensions-esize_atMost"><span class="command">lemma</span></span> esize_atMost<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">{..</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> eSuc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>enat <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{..</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> enat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atMost_iff finite_enat_bounded<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infinity<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{..</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> infinity
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atMost_iff enat_ord_code<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> infinite_lessThan_infty infinite_super subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> infinity <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-least_eSuc"><span class="command">lemma</span></span> least_eSuc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>eSuc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span>least <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"eSuc <span class="skolem">k</span> <span class="main">∈</span> eSuc <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 LeastI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>eSuc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> eSuc <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 LeastI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> least <span class="free">A</span> <span class="main">≤</span> <span class="bound">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 Least_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> eSuc <span class="main">`</span> <span class="free">A</span> <span class="main">⟹</span> least <span class="main">(</span>eSuc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 Least_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>eSuc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> eSuc <span class="main">(</span>least <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 20 31 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eSuc <span class="main">(</span>least <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> least <span class="main">(</span>eSuc <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 21 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-Inf_enat_eSuc"><span class="command">lemma</span></span> Inf_enat_eSuc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">(</span>eSuc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span><span class="main">⨅</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Inf_enat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="ESet_Extensions-liftI_0"><span class="command">lemma</span></span> liftI_0<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> lift <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="ESet_Extensions-liftI_Suc"><span class="command">lemma</span></span> liftI_Suc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> Suc <span class="free">a</span> <span class="main">∈</span> lift <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="ESet_Extensions-liftE"><span class="command">lemma</span></span> liftE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> lift <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>0<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>Suc<span class="main">)</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> Suc <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="ESet_Extensions-lift_esize"><span class="command">lemma</span></span> lift_esize<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">(</span>lift <span class="free">A</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span>esize <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1" id="ESet_Extensions-lift_least"><span class="command">lemma</span></span> lift_least<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>lift <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nth_least</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> wellorder"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nth_least</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">0</span> <span class="main">=</span> least <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nth_least</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nth_least</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">{</span>least <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_wellformed"><span class="command">lemma</span></span> nth_least_wellformed<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">&lt;</span> esize <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-card_wellformed"><span class="command">lemma</span></span> card_wellformed<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_strict_mono"><span class="command">lemma</span></span> nth_least_strict_mono<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">l</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Suc <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr0_conv_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">l'</span> <span class="main">&lt;</span> esize <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_neq_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Suc <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessE<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc 2 <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword1" id="ESet_Extensions-nth_least_mono"><span class="command">lemma</span></span> nth_least_mono<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">l</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">k</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nth_least_strict_mono le_less assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="ESet_Extensions-card_nth_least"><span class="command">lemma</span></span> card_nth_least<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> least <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> least_not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nth_least.simps<span class="main">(</span>1<span class="main">)</span> card.empty 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">&lt;</span> esize <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="skolem">A</span> <span class="main">0</span> <span class="main">&lt;</span> nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_strict_mono Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 5 Collect_empty_eq card.infinite infinite_imp_nonempty least_not_less nth_least.simps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
      card <span class="main">(</span><span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-card_nth_least_le"><span class="command">lemma</span></span> card_nth_least_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 Collect_empty_eq card.infinite infinite_imp_nonempty least_not_less nth_least.simps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span>nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span>nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_card"><span class="command">lemma</span></span> nth_least_card<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nat_set_card_equality_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">⊂</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset_card_mono True 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">z</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">interpretation</span></span> nth_least<span class="main">:</span>
    bounded_function_pair <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">A</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nth_least_wellformed card_wellformed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> nth_least<span class="main">:</span>
    injection <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">A</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_nth_least <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> nth_least<span class="main">:</span>
    surjection <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">A</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nth_least_card <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">interpretation</span></span> nth_least<span class="main">:</span>
    bijection <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">A</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword1" id="ESet_Extensions-nth_least_strict_mono_inverse"><span class="command">lemma</span></span> nth_least_strict_mono_inverse<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">l</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_less_iff_gr_or_eq nth_least_strict_mono<span class="main">)</span>

  <span class="keyword1" id="ESet_Extensions-nth_least_less_card_less"><span class="command">lemma</span></span> nth_least_less_card_less<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span> <span class="main">∧</span> nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> enat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="free">n</span><span class="main">}</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_less_esize_less"><span class="command">lemma</span></span> nth_least_less_esize_less<span class="main">:</span>
    <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span> <span class="main">∧</span> enat <span class="main">(</span>nth_least <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟷</span> enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nth_least_less_card_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

  <span class="keyword1" id="ESet_Extensions-nth_least_le"><span class="command">lemma</span></span> nth_least_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_ile_eq less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_strict_mono Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_eq"><span class="command">lemma</span></span> nth_least_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> nth_least <span class="free">B</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">=</span> nth_least <span class="free">B</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="skolem">A</span> <span class="main">=</span> least <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> least_eq<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> least <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> least <span class="skolem">B</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">unfolding</span></span> nth_least.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="skolem">A</span> <span class="main">=</span> least <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> least_eq<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> least <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> least <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="skolem">A</span> <span class="main">0</span> <span class="main">≤</span> nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="skolem">B</span> <span class="main">0</span> <span class="main">≤</span> nth_least <span class="skolem">B</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nth_least <span class="skolem">B</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> nth_least <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">B</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">&lt;</span> esize <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">&lt;</span> esize <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">B</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nth_least <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">B</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nth_least <span class="skolem">B</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_restrict"><span class="command">lemma</span></span> nth_least_restrict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="free">i</span> <span class="main">=</span> nth_least <span class="free">s</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_least_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_less_esize_less assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> nth_least <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">l</span> <span class="main">≤</span> enat <span class="main">(</span>nth_least <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">⟷</span> <span class="skolem">l</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-least_nth_least"><span class="command">lemma</span></span> least_nth_least<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> nth_least <span class="free">B</span> <span class="main">(</span>least <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="ESet_Extensions-nth_least_nth_least"><span class="command">lemma</span></span> nth_least_nth_least<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">B</span> <span class="main">(</span>nth_least <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> nth_least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="free">B</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> nth_least <span class="free">B</span> <span class="main">`</span> <span class="skolem">A</span> <span class="main">-</span> nth_least <span class="free">B</span> <span class="main">`</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_image_set_diff<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>nth_least <span class="free">B</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least.inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">B</span> <span class="main">(</span>nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nth_least <span class="free">B</span> <span class="main">(</span>nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="skolem">A</span> <span class="main">-</span> nth_least <span class="free">B</span> <span class="main">`</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>nth_least <span class="free">B</span> <span class="main">(</span>least <span class="skolem">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span>nth_least <span class="free">B</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_Max"><span class="command">lemma</span></span> nth_least_Max<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="main">(</span>card <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Max <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_diff_1 card_gt_0_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="skolem">A</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="skolem">A</span> <span class="main">(</span>card <span class="skolem">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>card <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Max <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_le_Max"><span class="command">lemma</span></span> nth_least_le_Max<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">≤</span> Max <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">≤</span> nth_least <span class="free">A</span> <span class="main">(</span>card <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_least_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="free">A</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_1 Suc_ile_eq assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        card_eq_0_iff esize_set.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_gr0 order_refl<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> card <span class="free">A</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_1 Suc_leI antisym_conv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        enat_ord_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> esize_set.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_less neq_iff not_gr0<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Max <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_Max assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_not_contains"><span class="command">lemma</span></span> nth_least_not_contains<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least.right_inverse 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_least_strict_mono_inverse<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least.g.wellformed 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="free">n</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_least_strict_mono_inverse<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least.g.wellformed 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">A</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> nth_least <span class="free">A</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_Suc"><span class="command">lemma</span></span> nth_least_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>Suc <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Suc <span class="main">(</span>nth_least <span class="free">A</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">&lt;</span> esize <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="skolem">A</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> insert <span class="main">(</span>least <span class="skolem">A</span><span class="main">)</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eSuc <span class="main">(</span>enat <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> enat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> esize <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">(</span>insert <span class="main">(</span>least <span class="skolem">A</span><span class="main">)</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eSuc <span class="main">(</span>esize <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Extended_Nat.eSuc_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>Suc <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> nth_least <span class="main">(</span>Suc <span class="main">`</span> <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="main">(</span>Suc <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="main">(</span>Suc <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">(</span>nth_least <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">(</span>nth_least <span class="skolem">A</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_lift"><span class="command">lemma</span></span> nth_least_lift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>lift <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">&lt;</span> esize <span class="free">A</span> <span class="main">⟹</span> nth_least <span class="main">(</span>lift <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>nth_least <span class="free">A</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="ESet_Extensions-nth_least_list_card"><span class="command">lemma</span></span> nth_least_list_card<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">n</span> <span class="main">≤</span> esize <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> nth_least <span class="main">(</span>lift <span class="free">A</span><span class="main">)</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_Suc_eq_le assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nth_least.simps<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Coinductive_List_Extensions">
<div class="head">
<h1>Theory Coinductive_List_Extensions</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Coinductive Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Coinductive_List_Extensions
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Coinductive/Coinductive_List.html">Coinductive.Coinductive_List</a>
  <a href="../Coinductive/Coinductive_List_Prefix.html">Coinductive.Coinductive_List_Prefix</a>
  <a href="../Coinductive/Coinductive_Stream.html">Coinductive.Coinductive_Stream</a>
  <span class="quoted">"<a href="List_Extensions.html">../Extensions/List_Extensions</a>"</span>
  <span class="quoted">"<a href="ESet_Extensions.html">../Extensions/ESet_Extensions</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Sublist.prefix
  <span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Sublist.suffix

  <span class="keyword1"><span class="command">declare</span></span> list_of_lappend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> lnth_lappend1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> lnth_lappend2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> lprefix_llength_le<span class="main">[</span><span class="operator">dest</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> Sup_llist_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> length_list_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> llast_linfinite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> lnth_ltake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> lappend_assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> lprefix_lappend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1" id="Coinductive_List_Extensions-lprefix_lSup_revert"><span class="command">lemma</span></span> lprefix_lSup_revert<span class="main">:</span> <span class="quoted"><span class="quoted">"lSup <span class="main">=</span> Sup"</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="main">=</span> less_eq"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Coinductive_List_Extensions-admissible_lprefixI"><span class="command">lemma</span></span> admissible_lprefixI<span class="main">[</span><span class="operator">cont_intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mcont <span class="free">lub</span> <span class="free">ord</span> lSup lprefix <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mcont <span class="free">lub</span> <span class="free">ord</span> lSup lprefix <span class="free">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ccpo.admissible <span class="free">lub</span> <span class="free">ord</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> lprefix <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ccpo_class.admissible_leI assms <span class="keyword1"><span class="command">unfolding</span></span> lprefix_lSup_revert <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Coinductive_List_Extensions-llist_lift_admissible"><span class="command">lemma</span></span> llist_lift_admissible<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ccpo.admissible lSup lprefix <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> lfinite <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LNil_lprefix le_llist_conv_lprefix lfinite.simps llist_gen_induct<span class="main">)</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">linfinite</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">¬</span> lfinite <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">notation</span></span> LNil <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;&gt;</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> LCons <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">%</span>"</span> 65<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> lzip <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">¦¦</span>"</span> 51<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> lappend <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 65<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> lnth <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">?!</span>"</span> 100<span class="main">)</span>

  <span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_llist"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> llist"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">translations</span></span>
    <span class="quoted">"<span class="main">&lt;</span><span class="free">a</span><span class="main">,</span> <span class="free">x</span><span class="main">&gt;</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="free">a</span> <span class="main">%</span> <span class="main">&lt;</span><span class="free">x</span><span class="main">&gt;</span>"</span>
    <span class="quoted">"<span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="free">a</span> <span class="main">%</span> <span class="main">&lt;&gt;</span>"</span>

  <span class="keyword1" id="Coinductive_List_Extensions-eq_LNil_conv_lnull"><span class="command">lemma</span></span> eq_LNil_conv_lnull<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">&lt;&gt;</span> <span class="main">⟷</span> lnull <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Coinductive_List_Extensions-Collect_lnull"><span class="command">lemma</span></span> Collect_lnull<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">w</span><span class="main">.</span> lnull <span class="bound">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">&lt;&gt;</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Coinductive_List_Extensions-inj_on_ltake"><span class="command">lemma</span></span> inj_on_ltake<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> ltake <span class="bound">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">{..</span> llength <span class="free">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> llength_ltake min_def<span class="main">)</span>

  <span class="keyword1" id="Coinductive_List_Extensions-lnth_inf_llist'"><span class="command">lemma</span></span> lnth_inf_llist'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lnth <span class="main">(</span>inf_llist <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Coinductive_List_Extensions-not_lnull_lappend_startE"><span class="command">lemma</span></span> not_lnull_lappend_startE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span> <span class="main">$</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_lnull_conv assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1" id="Coinductive_List_Extensions-not_lnull_lappend_endE"><span class="command">lemma</span></span> not_lnull_lappend_endE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">w</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">w</span> <span class="main">$</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lappend_inf False <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> True assms that
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lfinite_LNil<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lfinite_LNil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lfinite_LConsI <span class="skolem">w</span> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lnull <span class="skolem">w</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="skolem">b</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lfinite_LConsI<span class="main">(</span>2<span class="main">)</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lfinite_LConsI<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">%</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">%</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="main">&lt;</span><span class="skolem">b</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lfinite_LConsI<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">%</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">&lt;&gt;</span> <span class="main">$</span> <span class="main">&lt;</span><span class="skolem">a</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Coinductive_List_Extensions-llength_lappend_startE"><span class="command">lemma</span></span> llength_lappend_startE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">w</span> <span class="main">≥</span> eSuc <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span> <span class="main">$</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">v</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Coinductive_List_Extensions-llength_lappend_endE"><span class="command">lemma</span></span> llength_lappend_endE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">w</span> <span class="main">≥</span> eSuc <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span>"</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">v</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Coinductive_List_Extensions-llength_lappend_start'E"><span class="command">lemma</span></span> llength_lappend_start'E<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">w</span> <span class="main">=</span> enat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span> <span class="main">$</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">v</span> <span class="main">=</span> enat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">w</span> <span class="main">≥</span> eSuc <span class="main">(</span>enat <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">&lt;</span><span class="skolem">a</span><span class="main">&gt;</span> <span class="main">$</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">&lt;</span><span class="skolem">a</span><span class="main">&gt;</span> <span class="main">$</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llength <span class="skolem">v</span> <span class="main">=</span> enat <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> eSuc_enat eSuc_inject<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Coinductive_List_Extensions-llength_lappend_end'E"><span class="command">lemma</span></span> llength_lappend_end'E<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">w</span> <span class="main">=</span> enat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span>"</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">v</span> <span class="main">=</span> enat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">w</span> <span class="main">≥</span> eSuc <span class="main">(</span>enat <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="skolem">a</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="skolem">a</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llength <span class="skolem">v</span> <span class="main">=</span> enat <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> eSuc_enat eSuc_inject<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Coinductive_List_Extensions-ltake_llast"><span class="command">lemma</span></span> ltake_llast<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"llast <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">using</span></span> min.absorb_iff1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llast <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> ltake <span class="main">(</span>enat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> llast_conv_lnth 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lnth_ltake<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Coinductive_List_Extensions-linfinite_llength"><span class="command">lemma</span></span> linfinite_llength<span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linfinite <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms not_lfinite_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1" id="Coinductive_List_Extensions-llist_nth_eqI"><span class="command">lemma</span></span> llist_nth_eqI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"llength <span class="free">u</span> <span class="main">=</span> llength <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">u</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Eq_llist
    <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="skolem">u</span> <span class="main">=</span> llength <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Eq_llist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="skolem">u</span> <span class="main">⟹</span>  enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="skolem">v</span> <span class="main">⟹</span> <span class="skolem">u</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">?!</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Eq_llist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI exI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lnull <span class="skolem">u</span> <span class="main">⟷</span> lnull <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lhd <span class="skolem">u</span> <span class="main">=</span> lhd <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lhd_conv_lnth enat_0 11 20 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ltl <span class="skolem">u</span> <span class="main">=</span> ltl <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ltl <span class="skolem">v</span> <span class="main">=</span> ltl <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>ltl <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> llength <span class="main">(</span>ltl <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 40<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>ltl <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>ltl <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 41<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">?!</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">?!</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> 11<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc_ile_eq 40<span class="main">(</span>1<span class="main">)</span> 40<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc_ile_eq 40<span class="main">(</span>2<span class="main">)</span> 40<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ltl <span class="skolem">u</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> ltl <span class="skolem">v</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lnth_ltl 40<span class="main">(</span>1-2<span class="main">)</span> 41 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">lscan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> llist <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> llist"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lscan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">of</span> <span class="main">&lt;&gt;</span> <span class="main">⇒</span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">&gt;</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">%</span> <span class="bound">xs</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">%</span> <span class="free">lscan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Coinductive_List_Extensions-lscan_simps"><span class="command">lemma</span></span> lscan_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"lscan <span class="free">f</span> <span class="main">&lt;&gt;</span> <span class="free">a</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">a</span><span class="main">&gt;</span>"</span></span>
    <span class="quoted"><span class="quoted">"lscan <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">%</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span> <span class="main">%</span> lscan <span class="free">f</span> <span class="free">xs</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> llist.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> lscan.code<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> llist.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> lscan.code<span class="main">)</span>

  <span class="keyword1" id="Coinductive_List_Extensions-lscan_lfinite"><span class="command">lemma</span></span> lscan_lfinite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="main">(</span>lscan <span class="free">f</span> <span class="free">w</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> lfinite <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="main">(</span>lscan <span class="free">f</span> <span class="free">w</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"lscan <span class="free">f</span> <span class="free">w</span> <span class="free">a</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lfinite_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> LNil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> LNil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> LCons
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LCons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">w</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="main">(</span>lscan <span class="free">f</span> <span class="free">w</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Coinductive_List_Extensions-lscan_llength"><span class="command">lemma</span></span> lscan_llength<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lscan <span class="free">f</span> <span class="free">w</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span>llength <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">w</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lscan <span class="free">f</span> <span class="free">w</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_lfinite_llength False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">w</span> <span class="main">=</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_lfinite_llength False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">function</span></span> <span class="entity">lfold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> llist <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟹</span> <span class="free">lfold</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> fold <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>list_of <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"linfinite <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟹</span> <span class="free">lfold</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> id"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span> <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

  <span class="keyword1" id="Coinductive_List_Extensions-lfold_llist_of"><span class="command">lemma</span></span> lfold_llist_of<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lfold <span class="free">f</span> <span class="main">(</span>llist_of <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fold <span class="free">f</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Coinductive_List_Extensions-finite_UNIV_llength_eq"><span class="command">lemma</span></span> finite_UNIV_llength_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">w</span> <span class="main">::</span> <span class="tfree">'a</span> llist<span class="main">.</span> llength <span class="bound">w</span> <span class="main">=</span> enat <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> llength <span class="bound">v</span> <span class="main">=</span> enat <span class="skolem">n</span><span class="main">}</span> <span class="main">×</span> UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> llist <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="bound">a</span><span class="main">&gt;</span> <span class="main">::</span> <span class="tfree">'a</span> llist <span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> llength <span class="bound">v</span> <span class="main">=</span> enat <span class="skolem">n</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="bound">a</span><span class="main">&gt;</span> <span class="main">::</span> <span class="tfree">'a</span> llist <span class="main">|</span><span class="bound">v</span> <span class="bound">a</span><span class="main">.</span> llength <span class="bound">v</span> <span class="main">=</span> enat <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="bound">a</span><span class="main">&gt;</span> <span class="main">::</span> <span class="tfree">'a</span> llist  <span class="main">|</span><span class="bound">v</span> <span class="bound">a</span><span class="main">.</span> llength <span class="bound">v</span> <span class="main">=</span> enat <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="bound">a</span><span class="main">&gt;</span> <span class="main">::</span> <span class="tfree">'a</span> llist <span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> llength <span class="bound">v</span> <span class="main">=</span> enat <span class="skolem">n</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">w</span> <span class="main">::</span> <span class="tfree">'a</span> llist <span class="main">.</span> llength <span class="bound">w</span> <span class="main">=</span> enat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">w</span> <span class="main">::</span> <span class="tfree">'a</span> llist <span class="main">.</span> llength <span class="bound">w</span> <span class="main">=</span> enat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound">v</span> <span class="main">$</span> <span class="main">&lt;</span><span class="bound">a</span><span class="main">&gt;</span> <span class="main">::</span> <span class="tfree">'a</span> llist  <span class="main">|</span><span class="bound">v</span> <span class="bound">a</span><span class="main">.</span> llength <span class="bound">v</span> <span class="main">=</span> enat <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Coinductive_List_Extensions-finite_UNIV_llength_le"><span class="command">lemma</span></span> finite_UNIV_llength_le<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">w</span> <span class="main">::</span> <span class="tfree">'a</span> llist<span class="main">.</span> llength <span class="bound">w</span> <span class="main">≤</span> enat <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">w</span><span class="main">.</span> llength <span class="bound">w</span> <span class="main">≤</span> enat <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> llength <span class="bound">w</span> <span class="main">=</span> enat <span class="bound">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> atMost_iff enat_ile enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> finite_UNIV_llength_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Coinductive_List_Extensions-lprefix_ltake"><span class="command">lemma</span></span> lprefix_ltake<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> ltake <span class="main">(</span>llength <span class="free">u</span><span class="main">)</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_llist_conv_lprefix lprefix_conv_lappend ltake_all ltake_lappend1 order_refl<span class="main">)</span>
  <span class="keyword1" id="Coinductive_List_Extensions-prefixes_set"><span class="command">lemma</span></span> prefixes_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>ltake <span class="bound">k</span> <span class="free">w</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> llength <span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1" id="Coinductive_List_Extensions-esize_prefixes"><span class="command">lemma</span></span> esize_prefixes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">w</span><span class="main">}</span> <span class="main">=</span> eSuc <span class="main">(</span>llength <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"esize <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">w</span><span class="main">}</span> <span class="main">=</span> esize <span class="main">{</span>ltake <span class="bound">k</span> <span class="free">w</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> llength <span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prefixes_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> ltake <span class="bound">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..</span> llength <span class="free">w</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> atMost_def image_Collect <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">{..</span> llength <span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_on_ltake esize_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eSuc <span class="main">(</span>llength <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Coinductive_List_Extensions-prefix_subsume"><span class="command">lemma</span></span> prefix_subsume<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⟹</span> llength <span class="free">v</span> <span class="main">≤</span> llength <span class="free">u</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">≤</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_llist_conv_lprefix lprefix_conv_lappend
      lprefix_ltake ltake_is_lprefix ltake_lappend1<span class="main">)</span>

  <span class="keyword1" id="Coinductive_List_Extensions-ltake_infinite"><span class="command">lemma</span></span> ltake_infinite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ltake <span class="main">∞</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_ord_code<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ltake_all<span class="main">)</span>

  <span class="keyword1" id="Coinductive_List_Extensions-lprefix_infinite"><span class="command">lemma</span></span> lprefix_infinite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"linfinite <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">u</span> <span class="main">=</span> <span class="main">∞</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_lfinite_llength assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> ltake <span class="main">(</span>llength <span class="free">u</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lprefix_ltake assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">instantiation</span></span> llist <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">esize_order</span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="main">≡</span> llength"</span></span>

    <span class="keyword1"><span class="command">instance</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> llist"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="skolem">w</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≤</span> <span class="skolem">w</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> esize_prefixes 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eSuc_eq_infinity_iff esize_set.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> esize_llist_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> llist"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">u</span> <span class="main">≤</span> esize <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lprefix_llength_le 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> llist"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"esize <span class="skolem">u</span> <span class="main">&lt;</span> esize <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lstrict_prefix_llength_less 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Index Sets›</span></span>
  
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">liset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> llist <span class="main">⇒</span> nat set"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">liset</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lisetI"><span class="command">lemma</span></span> lisetI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> liset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Coinductive_List_Extensions-lisetD"><span class="command">lemma</span></span> lisetD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> liset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Coinductive_List_Extensions-liset_finite"><span class="command">lemma</span></span> liset_finite<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="free">w</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lfinite_finite_index assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-liset_nil"><span class="command">lemma</span></span> liset_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="main">&lt;&gt;</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Coinductive_List_Extensions-liset_cons_not_member"><span class="command">lemma</span></span> liset_cons_not_member<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">`</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Collect_split_Suc<span class="main">(</span>1<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc_ile_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">`</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-liset_cons_member"><span class="command">lemma</span></span> liset_cons_member<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> Suc <span class="main">`</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">a</span> <span class="main">%</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Collect_split_Suc<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> Suc <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc_ile_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> Suc <span class="main">`</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
    <span class="keyword1" id="Coinductive_List_Extensions-liset_prefix"><span class="command">lemma</span></span> liset_prefix<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> liset_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lprefix_lnthD assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-liset_suffix"><span class="command">lemma</span></span> liset_suffix<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> liset_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> CollectI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lprefix_llength_le 1<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lprefix_lnthD assms<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-liset_ltake"><span class="command">lemma</span></span> liset_ltake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> enat <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lnth_ltake 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> enat <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lnth_ltake 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-liset_mono"><span class="command">lemma</span></span> liset_mono<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> liset <span class="free">A</span> <span class="free">u</span> <span class="main">⊆</span> liset <span class="free">A</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> liset_def <span class="keyword1"><span class="command">using</span></span> lprefix_lnthD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1" id="Coinductive_List_Extensions-liset_cont"><span class="command">lemma</span></span> liset_cont<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Complete_Partial_Order.chain less_eq <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> liset <span class="free">A</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> liset <span class="free">A</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> esize_llist_def infinite_chain_arbitrary_esize assms<span class="main">(</span>1<span class="main">)</span> False Suc_ile_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≤</span> <span class="main">⨆</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_lprefix_lSup assms<span class="main">(</span>1<span class="main">)</span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> liset_prefix 1 3 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_chain_finite assms<span class="main">(</span>1<span class="main">)</span> True assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≤</span> <span class="main">⨆</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_lprefix_lSup assms<span class="main">(</span>1<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span><span class="main">⨆</span> <span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> liset_suffix 1<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-liset_mcont"><span class="command">lemma</span></span> liset_mcont<span class="main">:</span> <span class="quoted"><span class="quoted">"Complete_Partial_Order2.mcont lSup lprefix Sup less_eq <span class="main">(</span>liset <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lprefix_lSup_revert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mcontI monotoneI contI<span class="main">)</span>

    <span class="keyword1"><span class="command">lemmas</span></span> mcont2mcont_liset <span class="main">=</span> liset_mcont<span class="main">[</span><span class="operator">THEN</span> lfp.mcont2mcont<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont_intro</span><span class="main">]</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Selections›</span></span>

    <span class="comment1">(* TODO: thm lfitler_K_False *)</span>

    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lproject</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> lfilter <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lselect</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> lnths <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_to_lproject"><span class="command">lemma</span></span> lselect_to_lproject<span class="main">:</span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">w</span> <span class="main">=</span> lmap fst <span class="main">(</span>lproject <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">¦¦</span> iterates Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">=</span> UNIV <span class="main">×</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">w</span> <span class="main">=</span> lmap fst <span class="main">(</span>lproject <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">(</span><span class="free">w</span> <span class="main">¦¦</span> iterates Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lnths_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lmap fst <span class="main">(</span>lproject <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">¦¦</span> iterates Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-lproject_to_lselect"><span class="command">lemma</span></span> lproject_to_lselect<span class="main">:</span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="free">w</span> <span class="main">=</span> lselect <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lfilter_conv_lnths liset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

    <span class="keyword1" id="Coinductive_List_Extensions-lproject_llength"><span class="command">lemma</span></span> lproject_llength<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> esize <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> llist_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Coinductive_List_Extensions-lproject_lfinite"><span class="command">lemma</span></span> lproject_lfinite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> finite <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lproject_llength esize_iff_infinite llength_eq_infty_conv_lfinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_restrict_indices"><span class="command">lemma</span></span> lselect_restrict_indices<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lselect <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="free">w</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lnths_cong<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">n</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="main">⟷</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_llength"><span class="command">lemma</span></span> lselect_llength<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">w</span> <span class="main">¦¦</span> iterates Suc <span class="main">0</span><span class="main">)</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">?!</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_funpow enat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> enat_ord_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> llength_iterates lnth_iterates
          lnth_lzip monoid_add_class.add.right_neutral<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">∧</span> <span class="main">(</span><span class="free">w</span> <span class="main">¦¦</span> iterates Suc <span class="main">0</span><span class="main">)</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">∈</span> UNIV <span class="main">×</span> <span class="free">s</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> esize <span class="main">(</span>liset <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">¦¦</span> iterates Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lselect_to_lproject <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">∧</span> <span class="main">(</span><span class="free">w</span> <span class="main">¦¦</span> iterates Suc <span class="main">0</span><span class="main">)</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">∈</span> UNIV <span class="main">×</span> <span class="free">s</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> liset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-lselect_llength_le"><span class="command">lemma</span></span> lselect_llength_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">≤</span> esize <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Collect_conj_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-least_lselect_llength"><span class="command">lemma</span></span> least_lselect_llength<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> least <span class="free">s</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> enat <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-lselect_lnull"><span class="command">lemma</span></span> lselect_lnull<span class="main">:</span> <span class="quoted"><span class="quoted">"lnull <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">≥</span> llength <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> llength_eq_0<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_discard_start"><span class="command">lemma</span></span> lselect_discard_start<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lselect <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">k</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">&lt;&gt;</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lselect_lnull min_le_iff_disj<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="main">{</span><span class="bound">m</span><span class="main">.</span> <span class="free">k</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
        lselect <span class="free">s</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">$</span> lselect <span class="main">{</span><span class="bound">m</span><span class="main">.</span> <span class="free">k</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="free">k</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lnths_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-lselect_discard_end"><span class="command">lemma</span></span> lselect_discard_end<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"lselect <span class="main">{</span><span class="bound">m</span><span class="main">.</span> <span class="free">k</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="free">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">&lt;&gt;</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lselect_lnull min_le_iff_disj<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
        lselect <span class="free">s</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">$</span> lselect <span class="main">{</span><span class="bound">m</span><span class="main">.</span> <span class="free">k</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="free">k</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lnths_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_least"><span class="command">lemma</span></span> lselect_least<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> least <span class="free">s</span> <span class="main">%</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"least <span class="free">s</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LeastI 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> least <span class="free">s</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Least_le 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span> Suc <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> least_unique 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> least_lselect_llength assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"lselect <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>least <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">&lt;&gt;</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lselect_llength <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> least_not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"lselect <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="main">(</span>Suc <span class="main">(</span>least <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
        lselect <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lselect_discard_start 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">w</span> <span class="main">=</span> lselect <span class="main">(</span>insert <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>least <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">$</span> <span class="main">&lt;</span><span class="free">w</span> <span class="main">?!</span> least <span class="free">s</span><span class="main">&gt;</span> <span class="main">$</span>
        lselect <span class="main">{</span><span class="bound">m</span><span class="main">.</span> Suc <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="main">(</span>Suc <span class="main">(</span>least <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lnths_insert<span class="main">[</span><span class="operator">OF</span> 5<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">w</span> <span class="main">?!</span> least <span class="free">s</span><span class="main">&gt;</span> <span class="main">$</span>
        lselect <span class="main">{</span><span class="bound">m</span><span class="main">.</span> Suc <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">}</span> <span class="main">(</span>ldropn <span class="main">(</span>Suc <span class="main">(</span>least <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> <span class="main">(</span>least <span class="free">s</span><span class="main">)</span> <span class="main">%</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_lnth"><span class="command">lemma</span></span> lselect_lnth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">w</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="main">(</span>lselect <span class="skolem">s</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lselect_least 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lnull <span class="main">(</span>lselect <span class="skolem">s</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"lselect <span class="skolem">s</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> least <span class="skolem">s</span> <span class="main">%</span> lselect <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lselect_least 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="skolem">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span>llength <span class="main">(</span>lselect <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="skolem">s</span> <span class="free">w</span> <span class="main">?!</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">?!</span> least <span class="skolem">s</span> <span class="main">%</span> lselect <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span>least <span class="skolem">s</span><span class="main">}</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="skolem">s</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-lproject_lnth"><span class="command">lemma</span></span> lproject_lnth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="free">w</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lproject_to_lselect <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1" id="Coinductive_List_Extensions-lproject_ltake"><span class="command">lemma</span></span> lproject_ltake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">≤</span> llength <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
        ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lproject <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        enat <span class="main">(</span>card <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> enat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lessThan_def Collect_conj_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> enat <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> llength <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> min_absorb1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lproject <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        llength <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lproject <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 nat.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k'</span> <span class="main">&lt;</span> llength <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nth_least.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">≤</span> nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span>
        nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_least_eq<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> esize <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">≤</span> enat <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k'</span> <span class="main">&lt;</span> esize <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> esize <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">}</span> <span class="main">⟷</span> <span class="skolem">j</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span>
        ltake <span class="main">(</span>enat <span class="main">(</span>Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span>
        nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span> <span class="main">∩</span> <span class="main">{..&lt;</span> Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ltake <span class="main">(</span>enat <span class="main">(</span>Suc <span class="main">(</span>nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lproject <span class="free">A</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>ltake <span class="main">(</span>enat <span class="main">(</span>nth_least <span class="main">(</span>lift <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span>
        ltake <span class="main">(</span>enat <span class="free">k</span><span class="main">)</span> <span class="main">(</span>lproject <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-llength_less_llength_lselect_less"><span class="command">lemma</span></span> llength_less_llength_lselect_less<span class="main">:</span>
      <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> esize <span class="free">s</span> <span class="main">∧</span> enat <span class="main">(</span>nth_least <span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">⟷</span> enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nth_least_less_esize_less <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_lselect''"><span class="command">lemma</span></span> lselect_lselect''<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">t</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">note</span></span> lselect_llength<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> lselect_llength_le less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>nth_least <span class="free">s</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_inj_on nth_least.inj_on 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> esize <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> esize <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> llength <span class="main">(</span>lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> llength <span class="main">(</span>lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> esize <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less_le_trans 1 lselect_llength_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">t</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> lselect_llength_le less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="free">t</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="main">(</span>nth_least <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_lselect'"><span class="command">lemma</span></span> lselect_lselect'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">t</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Compr_image_eq
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_cong<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="main">(</span>nth_least <span class="free">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> llength_less_llength_lselect_less assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="main">(</span>nth_least <span class="free">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> esize <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nth_least_less_esize_less assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="skolem">i</span> <span class="main">=</span> nth_least <span class="free">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
        lselect <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>lselect <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="main">`</span>
        <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lselect_lselect''<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lselect_llength<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="free">t</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_lselect"><span class="command">lemma</span></span> lselect_lselect<span class="main">:</span>
      <span class="quoted"><span class="quoted">"lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">t</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lselect_llength_le less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lselect_lselect'<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">t</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> llength_less_llength_lselect_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lnths_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_lproject'"><span class="command">lemma</span></span> lselect_lproject'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟹</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span><span class="main">}</span> <span class="main">=</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="free">s</span> <span class="main">`</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">s</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">s</span> <span class="skolem">k</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> llength_less_llength_lselect_less 4 <span class="keyword1"><span class="command">unfolding</span></span> liset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="free">s</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_card 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">using</span></span> assms 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> nth_least <span class="free">s</span> <span class="main">`</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> nth_least <span class="free">s</span> <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">(</span>liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lproject_to_lselect <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> esize <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lselect_lselect <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>nth_least <span class="free">s</span> <span class="main">`</span> liset <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_lproject"><span class="command">lemma</span></span> lselect_lproject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lproject <span class="free">A</span> <span class="main">(</span>lselect <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span><span class="main">}</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lselect_lproject'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lproject_lselect_subset"><span class="command">lemma</span></span> lproject_lselect_subset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"liset <span class="free">A</span> <span class="free">w</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lproject <span class="free">A</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span> <span class="main">=</span> liset <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>lselect <span class="free">s</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> lselect <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>liset <span class="free">A</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lproject <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lproject_to_lselect <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Coinductive_List_Extensions-lselect_prefix"><span class="command">lemma</span></span> lselect_prefix<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">u</span> <span class="main">≤</span> lselect <span class="free">s</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">u</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lprefix_infinite assms False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="free">u</span> <span class="main">=</span> enat <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True length_list_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">u</span> <span class="main">$</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lprefix_conv_lappend assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">u</span> <span class="main">≤</span> lselect <span class="free">s</span> <span class="free">u</span> <span class="main">$</span> lselect <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="free">s</span><span class="main">}</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="main">(</span><span class="free">u</span> <span class="main">$</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lnths_lappend_lfinite<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-lproject_prefix"><span class="command">lemma</span></span> lproject_prefix<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="free">u</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lprefix_lfilterI assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Coinductive_List_Extensions-lproject_prefix_limit"><span class="command">lemma</span></span> lproject_prefix_limit<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⟹</span> lfinite <span class="bound">v</span> <span class="main">⟹</span> lproject <span class="free">A</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"ccpo.admissible lSup lprefix <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> lproject <span class="free">A</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> llist_lift_admissible 1 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Coinductive_List_Extensions-lproject_prefix_limit'"><span class="command">lemma</span></span> lproject_prefix_limit'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">∧</span> enat <span class="bound">k</span> <span class="main">&lt;</span> llength <span class="bound">v</span> <span class="main">∧</span> lproject <span class="free">A</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lproject_prefix_limit<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="skolem">u</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="skolem">u</span> <span class="main">=</span> enat <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_list_of<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"llength <span class="skolem">u</span> <span class="main">&lt;</span> llength <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="skolem">u</span> <span class="main">≤</span> llength <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefix_subsume 1<span class="main">(</span>1<span class="main">)</span> 3<span class="main">(</span>1<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="skolem">u</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LList_Prefixes">
<div class="head">
<h1>Theory LList_Prefixes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Prefixes on Coinductive Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LList_Prefixes
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Word_Prefixes.html">Word_Prefixes</a>
  <span class="quoted">"<a href="Coinductive_List_Extensions.html">../Extensions/Coinductive_List_Extensions</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="LList_Prefixes-unfold_stream_siterate_smap"><span class="command">lemma</span></span> unfold_stream_siterate_smap<span class="main">:</span> <span class="quoted"><span class="quoted">"unfold_stream <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> smap <span class="free">f</span> <span class="main">∘</span> siterate <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">coinduction</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> unfold_stream_eq_SCons<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="LList_Prefixes-lappend_stream_of_llist"><span class="command">lemma</span></span> lappend_stream_of_llist<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_of_llist <span class="main">(</span><span class="free">u</span> <span class="main">$</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> list_of <span class="free">u</span> <span class="main">@-</span> stream_of_llist <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stream_of_llist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

  <span class="keyword1" id="LList_Prefixes-llist_of_inf_llist_prefix"><span class="command">lemma</span></span> llist_of_inf_llist_prefix<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span> <span class="main">⟹</span> llist_of <span class="free">u</span> <span class="main">≤</span> llist_of_stream <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lappend_llist_of_stream_conv_shift le_llist_conv_lprefix lprefix_lappend prefix_fininfE<span class="main">)</span>
  <span class="keyword1" id="LList_Prefixes-prefix_llist_of_inf_llist"><span class="command">lemma</span></span> prefix_llist_of_inf_llist<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lfinite <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⟹</span> list_of <span class="free">u</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> stream_of_llist <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lappend_stream_of_llist le_llist_conv_lprefix lprefix_conv_lappend prefix_fininfI<span class="main">)</span>

  <span class="keyword1" id="LList_Prefixes-lproject_prefix_limit_chain"><span class="command">lemma</span></span> lproject_prefix_limit_chain<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">w</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lproject_prefix_limit'<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">v</span></span> <span class="main">≤</span> llist_of_stream <span class="main">(</span>limit <span class="free">w</span><span class="main">)</span><span class="main">.</span> enat <span class="skolem">k</span> <span class="main">&lt;</span> llength <span class="bound">v</span> <span class="main">∧</span> lproject <span class="free">A</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llist_of <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> llist_of_stream <span class="main">(</span>limit <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> llist_of_inf_llist_prefix chain_prefix_limit assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k</span> <span class="main">&lt;</span> llength <span class="main">(</span>llist_of <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">w</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="LList_Prefixes-lproject_eq_limit_chain"><span class="command">lemma</span></span> lproject_eq_limit_chain<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> project <span class="free">A</span> <span class="main">(</span><span class="free">u</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> project <span class="free">A</span> <span class="main">(</span><span class="free">v</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lproject_prefix_limit_chain<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">u</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">v</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_prefix_limit assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">u</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lproject_prefix_limit_chain<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">v</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">u</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_prefix_limit assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject <span class="free">A</span> <span class="main">(</span>llist_of <span class="main">(</span><span class="free">v</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> lproject <span class="free">A</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>limit <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Stuttering">
<div class="head">
<h1>Theory Stuttering</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stuttering›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stuttering
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Stuttering_Equivalence/StutterEquivalence.html">Stuttering_Equivalence.StutterEquivalence</a>
  <a href="LList_Prefixes.html">LList_Prefixes</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">function</span></span> <span class="entity">nth_least_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"enat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> esize <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> <span class="free">nth_least_ext</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> nth_least <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"enat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≥</span> esize <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> <span class="free">nth_least_ext</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> Suc <span class="main">(</span>Max <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> card <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

  <span class="keyword1" id="Stuttering-nth_least_ext_strict_mono"><span class="command">lemma</span></span> nth_least_ext_strict_mono<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth_least_ext <span class="free">s</span> <span class="free">k</span> <span class="main">&lt;</span> nth_least_ext <span class="free">s</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"enat <span class="free">l</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_ord_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_strict_mono assms True 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False esize_infinite_enat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">l</span> <span class="main">≥</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≥</span> card <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_least_ext <span class="free">s</span> <span class="free">k</span> <span class="main">=</span> nth_least <span class="free">s</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Max <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_le_Max 1 4 True <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Max <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Suc <span class="main">(</span>Max <span class="free">s</span> <span class="main">+</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> card <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Max <span class="free">s</span> <span class="main">+</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> card <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nth_least_ext <span class="free">s</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">k</span> <span class="main">≥</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> card <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nth_least_ext <span class="free">s</span> <span class="free">k</span> <span class="main">=</span> Suc <span class="main">(</span>Max <span class="free">s</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> card <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Max <span class="free">s</span> <span class="main">+</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> card <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least_ext <span class="free">s</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_selection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="tfree">'a</span> llist <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">stutter_selection</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">0</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span> <span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟶</span> enat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟶</span>
      nth_least <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">&lt;</span> nth_least <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">?!</span> nth_least <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">k</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟶</span> finite <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟶</span> Max <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">?!</span> Max <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Stuttering-stutter_selectionI"><span class="command">lemma</span></span> stutter_selectionI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">⟹</span> enat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">s</span> <span class="main">⟹</span>
      nth_least <span class="free">s</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> nth_least <span class="free">s</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="bound">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">&lt;</span> llength <span class="free">w</span> <span class="main">⟹</span> finite <span class="free">s</span> <span class="main">⟹</span> Max <span class="free">s</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_selection_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Stuttering-stutter_selectionD_0"><span class="command">lemma</span></span> stutter_selectionD_0<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_selection_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Stuttering-stutter_selectionD_inside"><span class="command">lemma</span></span> stutter_selectionD_inside<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">s</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> nth_least <span class="free">s</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_selection_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Stuttering-stutter_selectionD_infinite"><span class="command">lemma</span></span> stutter_selectionD_infinite<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"enat <span class="free">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"Max <span class="free">s</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_selection_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Stuttering-stutter_selection_stutter_sampler"><span class="command">lemma</span></span> stutter_selection_stutter_sampler<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linfinite <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">s</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span>nth_least_ext <span class="free">s</span><span class="main">)</span> <span class="main">(</span>lnth <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stutter_sampler_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least_ext <span class="free">s</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"enat <span class="main">0</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>nth_least_ext <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_monoI nth_least_ext_strict_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least_ext <span class="free">s</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> nth_least_ext <span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="free">s</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> less
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_selectionD_inside<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">s</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="free">s</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> nth_least <span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> equal
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> equal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat_ord_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lessI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> equal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> esize_infinite_enat less_irrefl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> Max <span class="free">s</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> card <span class="free">s</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> equal 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 enat.inject esize_set.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="free">s</span> <span class="main">=</span> nth_least <span class="free">s</span> <span class="main">(</span>card <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_Max 3 assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least <span class="free">s</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_least_ext <span class="free">s</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="free">s</span> <span class="main">=</span> nth_least_ext <span class="free">s</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> 4 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> greater
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">k</span> <span class="main">≥</span> esize <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> greater <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_ile_eq not_le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> greater <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> esize_infinite_enat less_asym<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> Max <span class="free">s</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> 2 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> Suc <span class="main">(</span>Max <span class="free">s</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> card <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Stuttering-stutter_equivI_selection"><span class="command">lemma</span></span> stutter_equivI_selection<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linfinite <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"linfinite <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">s</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="free">t</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lselect <span class="free">s</span> <span class="free">u</span> <span class="main">=</span> lselect <span class="free">t</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">u</span> <span class="main">≈</span> lnth <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equivI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> llength <span class="main">(</span>lselect <span class="free">t</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="free">s</span> <span class="main">=</span> esize <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span>nth_least_ext <span class="free">s</span><span class="main">)</span> <span class="main">(</span>lnth <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span>nth_least_ext <span class="free">t</span><span class="main">)</span> <span class="main">(</span>lnth <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lnth <span class="free">u</span> <span class="main">∘</span> nth_least_ext <span class="free">s</span> <span class="main">=</span> lnth <span class="free">v</span> <span class="main">∘</span> nth_least_ext <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> comp_apply<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> nth_least_ext <span class="free">t</span> <span class="skolem">i</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> esize <span class="free">s</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">t</span> <span class="free">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> 2 True <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">u</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">u</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">t</span> <span class="free">v</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> nth_least <span class="free">t</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> nth_least_ext <span class="free">t</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> nth_least_ext <span class="free">t</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> esize_infinite_enat 2 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> Max <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">u</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> Max <span class="free">t</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">?!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> Max <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 4<span class="main">)</span> 4<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"esize <span class="free">s</span> <span class="main">=</span> enat <span class="main">(</span>card <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"esize <span class="free">t</span> <span class="main">=</span> enat <span class="main">(</span>card <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">t</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">s</span> <span class="free">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 7<span class="main">(</span>1<span class="main">)</span> 8<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>card <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="free">t</span> <span class="free">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 7<span class="main">(</span>2<span class="main">)</span> 8<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> lselect_llength <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">?!</span> nth_least_ext <span class="free">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">u</span> <span class="main">?!</span> Suc <span class="main">(</span>Max <span class="free">s</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> card <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">?!</span> Max <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">u</span> <span class="main">?!</span> nth_least <span class="free">s</span> <span class="main">(</span>card <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_Max 4<span class="main">(</span>1<span class="main">)</span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">u</span> <span class="main">?!</span> <span class="main">(</span>card <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lselect_lnth 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">s</span> <span class="free">u</span> <span class="main">?!</span> <span class="main">(</span>card <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="free">t</span> <span class="free">v</span> <span class="main">?!</span> <span class="main">(</span>card <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> nth_least <span class="free">t</span> <span class="main">(</span>card <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lselect_lnth 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> Max <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_least_Max 4<span class="main">(</span>2<span class="main">)</span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> Suc <span class="main">(</span>Max <span class="free">t</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> card <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span> <span class="main">?!</span> nth_least_ext <span class="free">t</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">stuttering_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word set <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">stuttering_invariant</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≈</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

  <span class="keyword1" id="Stuttering-stuttering_invariant_complement"><span class="command">lemma</span></span> stuttering_invariant_complement<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stuttering_invariant <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stuttering_invariant <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stuttering_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Stuttering-stutter_equiv_forw_subst"><span class="command">lemma</span></span> stutter_equiv_forw_subst<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≈</span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⟹</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="free">w<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Stuttering-stutter_sampler_build"><span class="command">lemma</span></span> stutter_sampler_build<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stutter_sampler_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_sampler_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">unfolding</span></span> stutter_sampler_def strict_mono_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> 1 that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">w</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">unfolding</span></span> stutter_sampler_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> 0 3 that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Stuttering-stutter_extend_build"><span class="command">lemma</span></span> stutter_extend_build<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≈</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">u</span> <span class="main">≈</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="skolem">f</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="skolem">g</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∘</span> <span class="skolem">f</span> <span class="main">=</span> <span class="free">v</span> <span class="main">∘</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stutter_equivE assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> stutter_equivI ext<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stutter_sampler_build 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stutter_sampler_build 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">u</span> <span class="main">∘</span> <span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">∘</span> <span class="main">0</span> <span class="main">##</span> <span class="main">(</span>Suc <span class="main">∘</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">using</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Stuttering-stutter_extend_concat"><span class="command">lemma</span></span> stutter_extend_concat<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≈</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⌢</span> <span class="free">u</span> <span class="main">≈</span> <span class="free">w</span> <span class="main">⌢</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stutter_extend_build assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="Stuttering-build_stutter"><span class="command">lemma</span></span> build_stutter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">0</span> <span class="main">##</span> <span class="free">w</span> <span class="main">≈</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equivI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">0</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_sampler_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_monoI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span> <span class="main">0</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">0</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_sampler id <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">0</span> <span class="main">##</span> <span class="free">w</span> <span class="main">∘</span> <span class="main">(</span>Suc <span class="main">(</span><span class="main">0</span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">∘</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Stuttering-replicate_stutter"><span class="command">lemma</span></span> replicate_stutter<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌢</span> <span class="free">v</span> <span class="main">≈</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> stutter_equiv_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌢</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">0</span> <span class="main">##</span> replicate <span class="skolem">n</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌢</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="skolem">n</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌢</span> <span class="free">v</span><span class="main">)</span> <span class="main">0</span> <span class="main">##</span> replicate <span class="skolem">n</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌢</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≈</span> replicate <span class="skolem">n</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌢</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> build_stutter <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≈</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Stuttering-replicate_stutter'"><span class="command">lemma</span></span> replicate_stutter'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⌢</span> replicate <span class="free">n</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">⌢</span> <span class="free">v</span> <span class="main">≈</span> <span class="free">u</span> <span class="main">⌢</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stutter_extend_concat replicate_stutter <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Transition_System_Interpreted_Traces">
<div class="head">
<h1>Theory Transition_System_Interpreted_Traces</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Interpreted Transition Systems and Traces›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_System_Interpreted_Traces
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Transition_System_Traces.html">Transition_System_Traces</a>
  <span class="quoted">"<a href="Stuttering.html">Basics/Stuttering</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_interpreted_traces <span class="main">=</span>
    transition_system_interpreted <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">int</span></span> <span class="main">+</span>
    transition_system_traces <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">ind</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'action</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> independence_invisible<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> visible <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> visible <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ind</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Transition_System_Interpreted_Traces-eq_swap_lproject_visible"><span class="command">lemma</span></span> eq_swap_lproject_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of <span class="free">u</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms independence_invisible <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Interpreted_Traces-eq_fin_lproject_visible"><span class="command">lemma</span></span> eq_fin_lproject_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of <span class="free">u</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms eq_swap_lproject_visible <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Interpreted_Traces-le_fin_lproject_visible"><span class="command">lemma</span></span> le_fin_lproject_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of <span class="free">u</span><span class="main">)</span> <span class="main">≤</span> lproject visible <span class="main">(</span>llist_of <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="skolem">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of <span class="free">u</span><span class="main">)</span> <span class="main">≤</span>
        lproject visible <span class="main">(</span>llist_of <span class="free">u</span><span class="main">)</span> <span class="main">$</span> lproject visible <span class="main">(</span>llist_of <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of <span class="main">(</span><span class="free">u</span> <span class="main">@</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lappend_llist_of_llist_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_lproject_visible 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Transition_System_Interpreted_Traces-le_fininf_lproject_visible"><span class="command">lemma</span></span> le_fininf_lproject_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of <span class="free">u</span><span class="main">)</span> <span class="main">≤</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of <span class="free">u</span><span class="main">)</span> <span class="main">≤</span> lproject visible <span class="main">(</span>llist_of <span class="skolem">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> le_fin_lproject_visible 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Transition_System_Interpreted_Traces-le_inf_lproject_visible"><span class="command">lemma</span></span> le_inf_lproject_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span> <span class="main">≤</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> lproject_prefix_limit<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≤</span> llist_of_stream <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"lfinite <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_of <span class="skolem">w</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> stream_of_llist <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"list_of <span class="skolem">w</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="skolem">w</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of <span class="main">(</span>list_of <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_fininf_lproject_visible 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="skolem">w</span> <span class="main">≤</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Transition_System_Interpreted_Traces-eq_inf_lproject_visible"><span class="command">lemma</span></span> eq_inf_lproject_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_inf_lproject_visible assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym eq_infE<span class="main">)</span>

    <span class="keyword1" id="Transition_System_Interpreted_Traces-stutter_selection_lproject_visible"><span class="command">lemma</span></span> stutter_selection_lproject_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">u</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> execute_inf_word_invisible<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">u</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">∉</span> lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_least_not_contains<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> esize <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∉</span> liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">∉</span> visible"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span>
        nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lnth_list_of_stream snth_smap<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> Max <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> execute_inf_word_invisible<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">u</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">∉</span> lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Suc <span class="skolem">j</span> <span class="main">∉</span> lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">∈</span> lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> Max <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Max_ge 1 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∉</span> liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">∉</span> visible"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span>
        Max <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lnth_list_of_stream snth_smap<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Transition_System_Interpreted_Traces-execute_fin_visible"><span class="command">lemma</span></span> execute_fin_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">u</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"project visible <span class="free">u</span> <span class="main">=</span> project visible <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="main">(</span>target <span class="free">u</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span>target <span class="free">v</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subsume_fin assms<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="skolem">u'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">@</span> <span class="skolem">v'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="skolem">u'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@</span> <span class="skolem">u'</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">v</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> levi_lemma 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"project visible <span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> project visible <span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_fin_lproject_visible assms<span class="main">(</span>5<span class="main">)</span> 4<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"project visible <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> project visible <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>project visible <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>project visible <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> visible <span class="main">=</span> set <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∩</span> visible"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> invisible <span class="main">∨</span> set <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> independence_invisible 4<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> invisible"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>target <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_word 4<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>target <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_word 4<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span> <span class="main">(</span>fold <span class="free">ex</span> <span class="free">u</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span>fold <span class="free">ex</span> <span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_execute assms<span class="main">(</span>1<span class="main">)</span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span>fold <span class="free">ex</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute_fin_word_invisible 11 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span>fold <span class="free">ex</span> <span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute_fin_word_invisible 12 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span>fold <span class="free">ex</span> <span class="free">v</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_execute assms<span class="main">(</span>2<span class="main">)</span> 4<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Transition_System_Interpreted_Traces-execute_inf_visible"><span class="command">lemma</span></span> execute_inf_visible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">u</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">v</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≈</span> snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"lnth <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≈</span>
        lnth <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linfinite <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linfinite <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> stutter_selection_lproject_visible assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_selection <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> stutter_selection_lproject_visible assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eSuc <span class="main">(</span>llength <span class="main">(</span>lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lselect_llength<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eSuc <span class="main">(</span>llength <span class="main">(</span>lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> llength <span class="main">(</span>lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lselect_llength<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"llength <span class="main">(</span>lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> llength <span class="main">(</span>lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span>
            <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">&lt;</span> llength <span class="main">(</span>lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span>
            <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">≤</span> llength <span class="main">(</span>lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"enat <span class="skolem">i</span> <span class="main">≤</span> llength <span class="main">(</span>lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lselect_llength<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≡</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≡</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span>
            <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span> <span class="main">!!</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lnth_list_of_stream lselect_lnth snth_smap<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> sscan_scons_snth
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> execute_fin_visible<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">u</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> run_shift_elim stake_sdrop<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>stake <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> run_shift_elim stake_sdrop<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="skolem">k</span> <span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"stake <span class="skolem">l</span> <span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"project visible <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span>
              list_of <span class="main">(</span>lproject visible <span class="main">(</span>llist_of <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_of <span class="main">(</span>lproject visible <span class="main">(</span>ltake <span class="main">(</span>enat <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_stake llength_llist_of llist_of_inf_llist_prefix lprefix_ltake prefix_fininf_prefix<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_of <span class="main">(</span>ltake <span class="main">(</span>enat <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> k_def lproject_ltake<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_of <span class="main">(</span>ltake <span class="main">(</span>enat <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>lproject visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_of <span class="main">(</span>lproject visible <span class="main">(</span>ltake <span class="main">(</span>enat <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> l_def lproject_ltake<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> project visible <span class="main">(</span>stake <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_stake lfilter_llist_of list_of_llist_of llength_llist_of
                llist_of_inf_llist_prefix lprefix_ltake prefix_fininf_prefix<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"project visible <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> project visible <span class="main">(</span>stake <span class="skolem">l</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">int</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span> <span class="main">!!</span> nth_least <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> l_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lnth_list_of_stream lselect_lnth snth_smap<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span> <span class="main">=</span> lselect <span class="main">(</span>lift <span class="main">(</span>liset visible <span class="main">(</span>llist_of_stream <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>llist_of_stream <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">?!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ample_Abstract">
<div class="head">
<h1>Theory Ample_Abstract</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Theory of Ample Set Partial Order Reduction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ample_Abstract
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Transition_System_Interpreted_Traces.html">Transition_System_Interpreted_Traces</a>
  <span class="quoted">"<a href="Relation_Extensions.html">Extensions/Relation_Extensions</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="comment1">(*
    formalization of the abstract partial order reduction theory
    definitions and proofs adapted from
      [1] "Combining Partial Order Reductions with On-the-Fly Model-Checking"
        Doron Peled, FMSD, 1996
      [2] "Formal Verification of a Partial-Order Reduction Technique for Model Checking"
        Ching-Tsun Chou and Doron Peled, TACAS, 1996
  *)</span>

  <span class="keyword1"><span class="command">locale</span></span> ample_base <span class="main">=</span>
    transition_system_interpreted_traces <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">int</span></span> <span class="quoted"><span class="free">ind</span></span> <span class="main">+</span>
    wellfounded_relation <span class="quoted"><span class="free">src</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'action</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">src</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ample_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'action</span> set <span class="main">⇒</span> bool"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ample_set</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span>
        <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="main">∧</span>
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="main">⟶</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="free">src</span> <span class="main">(</span><span class="free">ex</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> invisible<span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span> <span class="bound">w</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="main">⟶</span> path <span class="bound">w</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> set <span class="bound">w</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> Ind <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>set <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="comment1">(* implicit in [1, 2] *)</span>
    <span class="keyword1" id="Ample_Abstract-ample_subset"><span class="command">lemma</span></span> ample_subset<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ample_set <span class="free">q</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ample_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* implicit in [1], condition C0 in [2] *)</span>
    <span class="keyword1" id="Ample_Abstract-ample_nonempty"><span class="command">lemma</span></span> ample_nonempty<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ample_set <span class="free">q</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ample_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* condition C2 in [1, 2] *)</span>
    <span class="keyword1" id="Ample_Abstract-ample_wellfounded"><span class="command">lemma</span></span> ample_wellfounded<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ample_set <span class="free">q</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">src</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ample_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* condition C3' in [1], not needed in [2] *)</span>
    <span class="keyword1" id="Ample_Abstract-ample_invisible"><span class="command">lemma</span></span> ample_invisible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ample_set <span class="free">q</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> invisible"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ample_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* condition C1 in [1, 2] *)</span>
    <span class="keyword1" id="Ample_Abstract-ample_independent"><span class="command">lemma</span></span> ample_independent<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ample_set <span class="free">q</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ind <span class="free">A</span> <span class="main">(</span>set <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ample_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Ample_Abstract-ample_en"><span class="command">lemma</span></span> ample_en<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ample_set <span class="free">q</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ample_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> ample_abstract <span class="main">=</span>
    S<span class="main">?</span><span class="main">:</span> transition_system_complete <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">int</span></span> <span class="main">+</span>
    R<span class="main">:</span> transition_system_complete <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">ren</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">int</span></span> <span class="main">+</span>
    ample_base <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">int</span></span> <span class="quoted"><span class="free">ind</span></span> <span class="quoted"><span class="free">src</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'action</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">src</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ren</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> reduction_ample<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes <span class="main">⟹</span> ample_set <span class="free">q</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Ample_Abstract-reduction_words_fin"><span class="command">lemma</span></span> reduction_words_fin<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"R.path <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S.path <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">)</span> ample_subset reduction_ample <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
    <span class="keyword1" id="Ample_Abstract-reduction_words_inf"><span class="command">lemma</span></span> reduction_words_inf<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"R.run <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S.run <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduction_words_fin assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> words_infI_construct<span class="main">)</span>

    <span class="comment1">(* lemma 3.7 in [1] *)</span>
    <span class="keyword1" id="Ample_Abstract-reduction_step"><span class="command">lemma</span></span> reduction_step<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span>
        <span class="main">(</span>deferred<span class="main">)</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="free">a</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="main">|</span>
        <span class="main">(</span>omitted<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">⊆</span> invisible"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>shd <span class="free">w</span> <span class="main">##</span> sdrop <span class="main">1</span> <span class="free">w</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> deferred<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>shd <span class="free">w</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ample_subset reduction_ample assms<span class="main">(</span>1<span class="main">)</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">∩</span> sset <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> omitted<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> ample_invisible reduction_ample assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
            <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> sset <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="skolem">a</span> <span class="free">q</span>"</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">b</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split_stream_first' 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ample_independent<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ample_set <span class="free">q</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction_ample assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">∩</span> set <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">∩</span> set <span class="skolem">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="skolem">a</span> <span class="free">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> split_stream_first<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">u</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="free">q</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">u</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ample_independent reduction_ample assms<span class="main">(</span>1<span class="main">)</span> 1 3 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> deferred<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="skolem">a</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">(* theorem 3.9 in [1] *)</span>
    <span class="keyword1" id="Ample_Abstract-reduction_chunk"><span class="command">lemma</span></span> reduction_chunk<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">b</span> <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>
      <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="free">b</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="free">q</span>"</span></span>
        <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">b</span> <span class="main">⊆</span> invisible"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellfounded assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wfP_induct_rule<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="free">a</span> <span class="skolem">q</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>True<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>False<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="skolem">q</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="skolem">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False less<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reduction_step<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>deferred <span class="skolem">c</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="skolem">c</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deferred<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fininf_ind''<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deferred<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fininf_not_member'<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deferred<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∉</span> set <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_inf_word 3 less<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">src</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ample_wellfounded ample_subset reduction_ample less<span class="main">(</span>3<span class="main">)</span> 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> 100<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="skolem">c</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>4<span class="main">)</span> deferred<span class="main">(</span>2<span class="main">)</span> le_fininf_word <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">)</span> 100 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span>
            <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="skolem">b</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">b</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">b</span> <span class="main">⊆</span> invisible"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v'</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thesis</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> invisible"</span></span>
                <span class="keyword1"><span class="command">using</span></span> ample_invisible ample_subset reduction_ample less<span class="main">(</span>3<span class="main">)</span> 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
                <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>omitted<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="skolem">q</span><span class="main">}</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> omitted<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">ren</span> <span class="bound">a</span> <span class="skolem">q</span><span class="main">}</span> <span class="main">(</span>sset <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> omitted<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ren</span> <span class="skolem">c</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">a</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduction_ample ample_nonempty less<span class="main">(</span>3<span class="main">)</span> 1 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>sset <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction_ample ample_subset less<span class="main">(</span>3<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>target <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diamond_fin_word_inf_word 4 6 less<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">src</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> reduction_ample ample_wellfounded ample_subset less<span class="main">(</span>3<span class="main">)</span> 0 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>3<span class="main">)</span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">s</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span>
            <span class="keyword3"><span class="command">assume</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="skolem">b</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">c</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">b</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">b</span> <span class="main">⊆</span> invisible"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">thesis</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="skolem">c</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ind</span> <span class="free">a</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> independence_symmetric 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> sset <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
              <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="skolem">u</span> <span class="main">⊆</span> sset <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">(</span><span class="main">[</span><span class="skolem">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">(*
      q: initial state
      v<span class="hidden">⇩</span><sub>1</sub>: operations of the original run processed so far
      v<span class="hidden">⇩</span><sub>2</sub>: operations of the original run remaining
      l: operations executed in the reduced run, but not yet in the original run
      w: reduced run processed so far
      w<span class="hidden">⇩</span><sub>1</sub>: selected reduced run processed so far
      w<span class="hidden">⇩</span><sub>2</sub>: unselected reduced run processed so far
      u: continuation of w
    *)</span>
    <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">reduced_run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'action</span> list <span class="main">⇒</span> <span class="tfree">'action</span> stream <span class="main">⇒</span> <span class="tfree">'action</span> list <span class="main">⇒</span>
      <span class="tfree">'action</span> list <span class="main">⇒</span> <span class="tfree">'action</span> list <span class="main">⇒</span> <span class="tfree">'action</span> list <span class="main">⇒</span> <span class="tfree">'action</span> stream <span class="main">⇒</span> bool"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span>
        init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">reduced_run</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
        absorb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">reduced_run</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@-</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟹</span>
          <span class="free">reduced_run</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span>remove1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
        extend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">reduced_run</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@-</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟹</span>
          R.path <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>target <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">⟹</span>
          Ind <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">⟹</span> set <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⊆</span> invisible <span class="main">⟹</span>
          <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">@-</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">@-</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> Ind <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>sset <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
          <span class="free">reduced_run</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_words_fin"><span class="command">lemma</span></span> reduced_run_words_fin<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"R.path <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_invar_2"><span class="command">lemma</span></span> reduced_run_invar_2<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">l</span> <span class="main">@-</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>init <span class="skolem">q</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>absorb <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> absorb<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fininf_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> absorb<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> remove1_append <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conc_conc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> absorb<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span> <span class="skolem">b</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fininf_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 131<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> set <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 132<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 131 132 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="main">(</span><span class="main">(</span><span class="skolem">l</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_inf <span class="main">…</span> <span class="main">(</span><span class="main">(</span><span class="skolem">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">@-</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_inf <span class="main">…</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_inf <span class="main">…</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_invar_1"><span class="command">lemma</span></span> reduced_run_invar_1<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>init <span class="skolem">q</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>absorb <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_2 absorb<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split_list_first<span class="main">[</span><span class="operator">OF</span> absorb<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fininf_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> remove1_append <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> absorb<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> remove1 <span class="skolem">a</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span> <span class="skolem">b</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_2 extend<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_fininf_ind'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">l</span> <span class="main">@-</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 131<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> set <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 132<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 13<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 131 132 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 14<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 13 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 14 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">…</span> <span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">…</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_fin <span class="main">…</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_invisible"><span class="command">lemma</span></span> reduced_run_invisible<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> invisible"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>init <span class="skolem">q</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>absorb <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> absorb<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span> <span class="skolem">b</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> set <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_append <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> extend<span class="main">(</span>6<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_ind"><span class="command">lemma</span></span> reduced_run_ind<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>init <span class="skolem">q</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>absorb <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> absorb<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span> <span class="skolem">b</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="skolem">u'</span> <span class="main">⊆</span> sset <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> extend<span class="main">(</span>9<span class="main">)</span> 1 <span class="keyword1"><span class="command">unfolding</span></span> set_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_decompose"><span class="command">lemma</span></span> reduced_run_decompose<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>init <span class="skolem">q</span> <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>absorb <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> absorb<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>extend <span class="skolem">q</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">a</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span> <span class="skolem">b</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>5<span class="main">)</span> extend<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_ind extend<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="skolem">u</span> <span class="main">=</span> sset <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_append <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> extend<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_project"><span class="command">lemma</span></span> reduced_run_project<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"project visible <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> project visible <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_decompose assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invisible assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"project visible <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> filter_empty_conv <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"project visible <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> project visible <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> project visible <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> project visible <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_of <span class="main">(</span>lproject visible <span class="main">(</span>llist_of <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_of <span class="main">(</span>lproject visible <span class="main">(</span>llist_of <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_fin_lproject_visible 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> project visible <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_length_1"><span class="command">lemma</span></span> reduced_run_length_1<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> length <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="Ample_Abstract-reduced_run_length"><span class="command">lemma</span></span> reduced_run_length<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> length <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> length <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_length_1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_decompose assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduced_run_step"><span class="command">lemma</span></span> reduced_run_step<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l'</span> <span class="free">w'</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">u'</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l'</span> <span class="main">(</span><span class="free">w</span> <span class="main">@</span> <span class="free">w'</span><span class="main">)</span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="free">u'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> absorb<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span><span class="free">w</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_1 assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">l</span> <span class="main">@-</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_2 assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_decompose assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span><span class="main">)</span> <span class="main">@-</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@-</span> <span class="free">u</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> diamond_fin_word_inf_word'<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_ind assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"R.path <span class="free">w</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_words_fin assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction_words_fin assms<span class="main">(</span>1<span class="main">)</span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_fin_word 4 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">l</span> <span class="main">@-</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">l</span><span class="main">)</span> <span class="main">@-</span> <span class="free">u</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_inf_word assms<span class="main">(</span>2<span class="main">)</span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">w</span> <span class="main">@-</span> <span class="free">u</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_inf_word 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_inf_concat_end shift_append<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">l</span> <span class="main">@-</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_fininf_not_member' 7 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 101<span class="main">:</span> <span class="quoted"><span class="quoted">"target <span class="free">w</span> <span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">(</span>target <span class="free">w</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_inf_word 9 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 11<span class="main">:</span>
        <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="skolem">b</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>target <span class="free">w</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">b</span> <span class="main">⊆</span> invisible"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u''</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reduction_chunk 101 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extend<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">w</span> <span class="free">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"R.path <span class="main">(</span><span class="skolem">b</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>target <span class="free">w</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span>set <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">b</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">@-</span> <span class="skolem">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="skolem">u''</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 9 11<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span>set <span class="skolem">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>sset <span class="skolem">u''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 11<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">(* theorem 3.11 in [1] *)</span>
    <span class="keyword1" id="Ample_Abstract-reduction_word"><span class="command">lemma</span></span> reduction_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">v</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">w</span>
      <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"R.run <span class="free">w</span> <span class="free">q</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">w</span>"</span></span>
        <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of_stream <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">k</span> <span class="bound">w</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">u</span><span class="main">.</span> reduced_run <span class="free">q</span> <span class="main">(</span>stake <span class="bound">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="bound">k</span> <span class="free">v</span><span class="main">)</span> <span class="bound">l</span> <span class="bound">w</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">u</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">k</span> <span class="main">(</span><span class="skolem">w</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> chain_construct_2'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">0</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">using</span></span> init <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">k</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="skolem"><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">w<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span>
          <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">v</span> <span class="main">@</span> <span class="main">[</span><span class="free">v</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reduced_run_step<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">v</span> <span class="main">@-</span> <span class="main">[</span><span class="free">v</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@-</span> sdrop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="free">q</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> shift_append stake_Suc stake_sdrop<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reduced_run <span class="free">q</span> <span class="main">(</span>stake <span class="skolem">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">v</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@-</span> sdrop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">w</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop_simps shift.simps stream.collapse<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w'</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="bound">w'</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">≤</span> <span class="bound">w'</span> <span class="main">∧</span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prefix_fin_append stake_Suc<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_length 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_length_1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> reduced_run <span class="free">q</span> <span class="main">(</span>stake <span class="bound">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="bound">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"R.run <span class="main">(</span>Word_Prefixes.limit <span class="skolem">w</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_words_fin 1<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> Word_Prefixes.limit <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> Word_Prefixes.limit <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_infI_chain_right'<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> stake <span class="bound">k</span> <span class="free">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_1<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Word_Prefixes.limit <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_infI_chain_left<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>F</sub></span> stake <span class="skolem">k</span> <span class="free">v</span> <span class="main">@</span> <span class="skolem">l</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> stake <span class="skolem">k</span> <span class="free">v</span> <span class="main">@-</span> <span class="skolem">l</span> <span class="skolem">k</span> <span class="main">@-</span> <span class="skolem">u</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> stake <span class="skolem">k</span> <span class="free">v</span> <span class="main">@-</span> sdrop <span class="skolem">k</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_invar_2<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Word_Prefixes.limit <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> Word_Prefixes.limit <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_infI_chain_left<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chain <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub></span> <span class="skolem">w</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_run_decompose<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">≤<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> Word_Prefixes.limit <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_prefix_limit 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>I</sub></span> Word_Prefixes.limit <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="main">(</span>Word_Prefixes.limit <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          lproject visible <span class="main">(</span>llist_of_stream <span class="main">(</span>Word_Prefixes.limit <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lproject_eq_limit_chain reduced_run_project 1 <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">(* theorem 3.12 in [1] *)</span>
    <span class="keyword1" id="Ample_Abstract-reduction_equivalent"><span class="command">lemma</span></span> reduction_equivalent<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">u</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"R.run <span class="free">v</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≈</span> snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">v</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"R.run <span class="skolem">w</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">w</span>"</span></span>
        <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of_stream <span class="skolem">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reduction_word assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"R.run <span class="skolem">w</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="free">u</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≈</span> snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="free">q</span> <span class="main">##</span> trace <span class="skolem">w</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> execute_inf_visible<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">u</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">w</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction_words_inf assms<span class="main">(</span>1<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">=<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>I</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of_stream <span class="skolem">v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> eq_inf_lproject_visible 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of_stream <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lproject visible <span class="main">(</span>llist_of_stream <span class="free">u</span><span class="main">)</span> <span class="main">=</span> lproject visible <span class="main">(</span>llist_of_stream <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Abstract-reduction_language_subset"><span class="command">lemma</span></span> reduction_language_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"R.language <span class="main">⊆</span> S.language"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S.language_def R.language_def <span class="keyword1"><span class="command">using</span></span> reduction_words_inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1" id="Ample_Abstract-reduction_language_stuttering"><span class="command">lemma</span></span> reduction_language_stuttering<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> S.language"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> R.language"</span></span> <span class="quoted"><span class="quoted">"snth <span class="free">u</span> <span class="main">≈</span> snth <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> smap <span class="free">int</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> trace <span class="skolem">v</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"S.run <span class="skolem">v</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"R.run <span class="skolem">v'</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> trace <span class="skolem">v</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≈</span> snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> trace <span class="skolem">v'</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reduction_equivalent 1<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> that R.languageI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="free">int</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> trace <span class="skolem">v'</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> smap <span class="free">int</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> trace <span class="skolem">v'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"R.run <span class="skolem">v'</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snth <span class="free">u</span> <span class="main">≈</span> snth <span class="main">(</span>smap <span class="free">int</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> trace <span class="skolem">v'</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Formula">
<div class="head">
<h1>Theory Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹LTL Formulae›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Stuttering.html">Basics/Stuttering</a>"</span>
  <a href="../Stuttering_Equivalence/PLTL.html">Stuttering_Equivalence.PLTL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> formula <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream set"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">language</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">}</span>"</span></span>
  
    <span class="keyword1" id="Formula-language_entails"><span class="command">lemma</span></span> language_entails<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="main">⟷</span> snth <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> formula_next_free <span class="main">=</span>
    formula <span class="quoted"><span class="free">φ</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> next_free<span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Formula-stutter_equivalent_entails"><span class="command">lemma</span></span> stutter_equivalent_entails<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≈</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> next_free_stutter_invariant next_free <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ample_Correctness">
<div class="head">
<h1>Theory Ample_Correctness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Correctness Theorem of Partial Order Reduction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ample_Correctness
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Ample_Abstract.html">Ample_Abstract</a>
  <a href="Formula.html">Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> ample_correctness <span class="main">=</span>
    S<span class="main">:</span> transition_system_complete <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">int</span></span> <span class="main">+</span>
    R<span class="main">:</span> transition_system_complete <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">ren</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">int</span></span> <span class="main">+</span>
    F<span class="main">:</span> formula_next_free <span class="quoted"><span class="free">φ</span></span> <span class="main">+</span>
    ample_abstract <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">int</span></span> <span class="quoted"><span class="free">ind</span></span> <span class="quoted"><span class="free">src</span></span> <span class="quoted"><span class="free">ren</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'action</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">src</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ren</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'interpretation</span> pltl"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Ample_Correctness-reduction_language_indistinguishable"><span class="command">lemma</span></span> reduction_language_indistinguishable<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"R.language <span class="main">⊆</span> F.language"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S.language <span class="main">⊆</span> F.language"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> S.language"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> R.language"</span></span> <span class="quoted"><span class="quoted">"snth <span class="skolem">u</span> <span class="main">≈</span> snth <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction_language_stuttering 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> F.language"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> F.language"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">theorem</span></span> reduction_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"S.language <span class="main">⊆</span> F.language <span class="main">⟷</span> R.language <span class="main">⊆</span> F.language"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduction_language_subset reduction_language_indistinguishable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Ample_Analysis">
<div class="head">
<h1>Theory Ample_Analysis</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Static Analysis for Partial Order Reduction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ample_Analysis
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Ample_Abstract.html">Ample_Abstract</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_ample <span class="main">=</span>
    transition_system_sticky <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">int</span></span> <span class="quoted"><span class="free">sticky</span></span> <span class="main">+</span>
    transition_system_interpreted_traces <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">int</span></span> <span class="quoted"><span class="free">ind</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'interpretation</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sticky</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'action</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">sublocale</span></span> ample_base <span class="quoted"><span class="quoted">"<span class="free">ex</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">int</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ind</span>"</span></span> <span class="quoted"><span class="quoted">"scut<span class="main">¯¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

    <span class="keyword1" id="Ample_Analysis-restrict_ample_set"><span class="command">lemma</span></span> restrict_ample_set<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">∩</span> <span class="free">sticky</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>executable <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> path <span class="bound">w</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">∩</span> set <span class="bound">w</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∩</span> set <span class="bound">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ample_set <span class="free">s</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ample_set_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"scut<span class="main">¯¯</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">a</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> no_cut_scut<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="skolem">a</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="free">sticky</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> executable"</span></span> <span class="keyword1"><span class="command">using</span></span> executable assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> invisible"</span></span> <span class="keyword1"><span class="command">using</span></span> executable_visible_sticky assms<span class="main">(</span>3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">w</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">∩</span> set <span class="skolem">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set <span class="skolem">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> executable"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ind <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_concurrent <span class="main">=</span>
    transition_system_initial <span class="quoted"><span class="free">ex</span></span> <span class="quoted"><span class="free">en</span></span> <span class="quoted"><span class="free">init</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'action</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">procs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'process</span> set"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pac</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'process</span> <span class="main">⇒</span> <span class="tfree">'action</span> set"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">psen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'process</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'action</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> procs_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes <span class="main">⟹</span> finite <span class="main">(</span><span class="free">procs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> psen_en<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> psen_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">-</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">psen</span> <span class="free">p</span> <span class="main">(</span><span class="free">ex</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Ample_Analysis-psen_fin_word"><span class="command">lemma</span></span> psen_fin_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> set <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">psen</span> <span class="free">p</span> <span class="main">(</span>target <span class="free">w</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">,</span> 3<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nil <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">a</span> <span class="skolem">s</span> <span class="skolem">w</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ex</span> <span class="skolem">a</span> <span class="skolem">s</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> cons<span class="main">(</span>4<span class="main">,</span> 1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">psen</span> <span class="free">p</span> <span class="main">(</span>target <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">psen</span> <span class="free">p</span> <span class="main">(</span>target <span class="skolem">w</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">psen</span> <span class="free">p</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">psen</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psen_ex cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Analysis-en_fin_word"><span class="command">lemma</span></span> en_fin_word<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span> <span class="main">-</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">⟹</span>
        <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span><span class="free">ex</span> <span class="bound">b</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> set <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span>target <span class="free">w</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">b</span> <span class="skolem">w</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
        <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">pac</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="skolem">a</span> <span class="main">(</span>target <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">en</span> <span class="skolem">a</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">psen</span> <span class="free">p</span> <span class="main">(</span>target <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psen_fin_word snoc<span class="main">(</span>3<span class="main">,</span> 4<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"target <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="free">s</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
          <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="main">(</span>target <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psen_en 4 2<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> 3 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="skolem">a</span> <span class="main">(</span>target <span class="skolem">w</span> <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> snoc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"target <span class="skolem">w</span> <span class="free">s</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span>target <span class="skolem">w</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="free">pac</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>4<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="skolem">a</span> <span class="main">(</span><span class="free">ex</span> <span class="skolem">b</span> <span class="main">(</span>target <span class="skolem">w</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span>target <span class="skolem">w</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> snoc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span> <span class="main">-</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">⟹</span>
            <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span><span class="free">ex</span> <span class="bound">b</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">w</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> set <span class="skolem">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="skolem">a</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Ample_Analysis-pac_en_blocked"><span class="command">lemma</span></span> pac_en_blocked<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span> <span class="main">-</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">⟹</span>
        <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span><span class="free">ex</span> <span class="bound">b</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">w</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">∩</span> set <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">pac</span> <span class="free">p</span> <span class="main">∩</span> set <span class="free">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> words_fin_blocked en_fin_word assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">proc</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free">pac</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Proc</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> proc <span class="bound">a</span>"</span></span>

    <span class="keyword1" id="Ample_Analysis-psen_simple"><span class="command">lemma</span></span> psen_simple<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Proc <span class="main">(</span><span class="free">psen</span> <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">en</span> <span class="bound">b</span> <span class="bound">r</span> <span class="main">⟹</span>
        proc <span class="bound">a</span> <span class="main">∩</span> proc <span class="bound">b</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span><span class="free">ex</span> <span class="bound">b</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">psen</span> <span class="free">p</span> <span class="free">s</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span> <span class="main">-</span> <span class="free">pac</span> <span class="free">p</span> <span class="main">⟹</span>
        <span class="free">en</span> <span class="bound">a</span> <span class="main">(</span><span class="free">ex</span> <span class="bound">b</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">en</span> <span class="bound">a</span> <span class="bound">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>