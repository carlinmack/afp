<div id="Notation">
<div class="head">
<h1>Theory Notation</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Notation for hotel key card system
    Author:     Tobias Nipkow, TU Muenchen
*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Notation
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/LaTeXsugar.html">HOL-Library.LaTeXsugar</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
 <span class="quoted">"<span class="entity">SomeFloor</span>"</span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">⌊</span>_<span class="keyword1">⌋</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌊</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">⌋</span></span> <span class="main">≡</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Notation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
HOL conforms largely to everyday mathematical notation.
This section introduces further non-standard notation and in particular
a few basic data types with their primitive operations.
\sloppy
\begin{description}

\item[Types] The type of truth values is called <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">bool</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  The
space of total functions is denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⇒›</span></span></span></span>. Type variables
start with a quote, as in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> etc. The notation
$t$~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>::›</span></span></span></span>~$\tau$ means that term $t$ has type $\tau$.

\item[Functions] can be updated at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> with new value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>,
written <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">:=</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  The range of a function is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"range <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"inj <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> is injective.

\item[Pairs] come with the two projection functions
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>fst :: 'a × 'b ⇒ 'a›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>snd :: 'a × 'b ⇒ 'b›</span></span></span></span>.

\item[Sets] have type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\item[Lists] (type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) come with the empty list
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the infix constructor <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⋅›</span></span></span></span>, the infix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>@›</span></span></span></span>
that appends two lists, and the conversion function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from
lists to sets.  Variable names ending in ``s'' usually stand for
lists.

\item[Records] are constructed like this <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⦇f<span class="hidden">⇩</span><sub>1</sub> = v<span class="hidden">⇩</span><sub>1</sub>, …⦈›</span></span></span></span>
and updated like this \mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r⦇f<span class="hidden">⇩</span><sub>i</sub> := v<span class="hidden">⇩</span><sub>i</sub>, …⦈›</span></span></span></span>},
where the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> are the field names,
the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span> the values and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> is a record.

\end{description}\fussy
Datatype <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>option›</span></span></span></span> is defined like this
\begin{center}
\isacommand{datatype} <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a option = None | Some 'a›</span></span></span></span>
\end{center}
and adjoins a new element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">None</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to a type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. For
succinctness we write <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> instead of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[source]<span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Note that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟦A<span class="hidden">⇩</span><sub>1</sub>; …; A<span class="hidden">⇩</span><sub>n</sub>⟧ ⟹ A›</span></span></span></span>
abbreviates <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A<span class="hidden">⇩</span><sub>1</sub> ⟹ … ⟹ A<span class="hidden">⇩</span><sub>n</sub> ⟹ A›</span></span></span></span>, which is the same as
``If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and \dots\ and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A<span class="hidden">⇩</span><sub>n</sub>›</span></span></span></span> then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>''.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Basis">
<div class="head">
<h1>Theory Basis</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Basis for hotel key card system

    Author:     Tobias Nipkow, TU Muenchen
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Basis
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Notation.html">Notation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> guest
<span class="keyword1"><span class="command">typedecl</span></span> key
<span class="keyword1"><span class="command">typedecl</span></span> room

<span class="keyword1"><span class="command">type_synonym</span></span> card <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">*</span> key"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="State">
<div class="head">
<h1>Theory State</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      A state based hotel key card system

    Author:     Tobias Nipkow, TU Muenchen
*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> State
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Basis.html">Basis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> if_split_asm<span class="main">[</span><span class="operator">split</span><span class="main">]</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹A state based model›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The model is based on three opaque types <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">guest</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">key</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">room</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">card</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is just an abbreviation
for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span><span class="quoted"><span class="quoted">"key <span class="main"><span class="main">×</span></span> key"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The state of the system is modelled as a record which combines the
information about the front desk, the rooms and the guests.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> state <span class="main">=</span>
 owns <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> guest option"</span></span>
 currk <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> key"</span></span>
 issued <span class="main">::</span> <span class="quoted"><span class="quoted">"key set"</span></span>
 cards <span class="main">::</span> <span class="quoted"><span class="quoted">"guest <span class="main">⇒</span> card set"</span></span>
 roomk <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> key"</span></span>
 isin <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> guest set"</span></span>
 safe <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\noindent Reception records who <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> owns<span class="antiquote"><span class="antiquote">}</span></span></span></span> a room (if anybody, hence
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span><span class="quoted"><span class="quoted">"guest option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), the current key <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> currk<span class="antiquote"><span class="antiquote">}</span></span></span></span> that has been
issued for a room, and which keys have been <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> issued<span class="antiquote"><span class="antiquote">}</span></span></span></span> so
far. Each guest has a set of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> cards<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Each room has a key
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> roomk<span class="antiquote"><span class="antiquote">}</span></span></span></span> recorded in the lock and a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> isin<span class="antiquote"><span class="antiquote">}</span></span></span></span> of
occupants. The auxiliary variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> is explained further
below; we ignore it for now.

In specification languages like Z, VDM and B we would now define a
number of operations on this state space. Since they are the only
permissible operations on the state, this defines a set of
\emph{reachable} states. In a purely logical environment like
Isabelle/HOL this set can be defined directly by an inductive
definition. Each clause of the definition corresponds to a
transition/operation/event. This is the standard approach to modelling
state machines in theorem provers.

The set of reachable states of the system (called <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>reach›</span></span></span></span>) is
defined by four transitions: initialization, checking in, entering a room,
and leaving a room:›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">(*&gt;*)</span>
init<span class="main">:</span>
<span class="quoted"><span class="quoted">"inj <span class="free"><span class="bound"><span class="entity">initk</span></span></span> <span class="main">⟹</span>
<span class="main">⦇</span> owns <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> None<span class="main">)</span><span class="main">,</span> currk <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">initk</span></span></span><span class="main">,</span> issued <span class="main">=</span> range <span class="free"><span class="bound"><span class="entity">initk</span></span></span><span class="main">,</span>
  cards <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> roomk <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">initk</span></span></span><span class="main">,</span> isin <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span>
  safe <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> True<span class="main">)</span> <span class="main">⦈</span> <span class="main">∈</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> check_in<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∉</span> issued <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span> currk <span class="main">:=</span> <span class="main">(</span>currk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">,</span> issued <span class="main">:=</span> issued <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span><span class="main">,</span>
   cards <span class="main">:=</span> <span class="main">(</span>cards <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">:=</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>currk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
   owns <span class="main">:=</span>  <span class="main">(</span>owns <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">,</span>
   safe <span class="main">:=</span> <span class="main">(</span>safe <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> False<span class="main">)</span> <span class="main">⦈</span> <span class="main">∈</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> enter_room<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span> <span class="main">∈</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> roomk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span>
<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span> isin <span class="main">:=</span> <span class="main">(</span>isin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
   roomk <span class="main">:=</span> <span class="main">(</span>roomk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">,</span>
   safe <span class="main">:=</span> <span class="main">(</span>safe <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> owns <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">⌋</span> <span class="main">∧</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">=</span> currk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                              <span class="main">∨</span> safe <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
  <span class="main">⦈</span> <span class="main">∈</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> exit_room<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span> isin <span class="main">:=</span> <span class="main">(</span>isin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">∈</span> <span class="free">reach</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\bigskip There is no check-out event because it is implicit in the next
check-in for that room: this covers the cases where a guest leaves without checking out (in which case the room should not be blocked forever) or where
the hotel decides to rent out a room prematurely, probably by accident.
Neither do guests have to return their cards at any point because they may
loose cards or may pretended to have lost them.
We will now explain the events.
\begin{description}
\item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span>]
Initialization requires that every room has a different key, i.e.\
that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> currk<span class="antiquote"><span class="antiquote">}</span></span></span></span> is injective. Nobody
owns a room, the keys of all rooms are recorded as issued, nobody has
a card, and all rooms are empty.
\item[<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] enter_room<span class="antiquote"><span class="antiquote">}</span></span></span></span>]
A guest may enter if either of the two keys on his card equal the room key.
Then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> is added to the occupants of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> and
the room key is set to the second key on the card.
Normally this has no effect because the second key is already the room key.
But when entering for the first time, the first key on the card equals
the room key and then the lock is actually recoded.
\item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>exit_room›</span></span></span></span>]
removes an occupant from the occupants of a room.
\item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_in›</span></span></span></span>] for room <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> and guest <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span>
issues the card <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>currk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">k</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> is new, makes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> the owner of the room,
and sets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"currk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the new key <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.
\end{description}

The reader can easily check that our specification allows the intended
distributed implementation: entering only reads and writes the key in
that lock, and check-in only reads and writes the information at
reception.

In contrast to Jackson we require that initially distinct rooms have
distinct keys. This protects the hotel from its guests: otherwise a
guest may be able to enter rooms he does not own, potentially stealing
objects from those rooms. Of course he can also steal objects from his
own room, but in that case it is easier to hold him responsible. In
general, the hotel may just want to minimize the opportunity for
theft.

The main difference to Jackson's model is that his can talk about
transitions between states rather than merely about reachable
states. This means that he can specify that unauthorized entry into a
room should not occur. Because our specification does not formalize
the transition relation itself, we need to include the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>isin›</span></span></span></span>
component in order to
express the same requirement. In the end, we would like to establish
that the system is \emph{safe}: only the owner of a room can be in a
room:
\begin{center}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">∈</span></span> reach <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">⟹</span></span> owns <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> Some <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{center}
Unfortunately, this is just not true. It does not take a PhD in
computer science to come up with the following scenario: because
guests can retain their cards, there is nothing to stop a guest from
reentering his old room after he has checked out (in our model: after
the next guest has checked in), but before the next guest has entered
his room. Hence the best we can do is to prove a conditional safety
property: under certain conditions, the above safety property
holds. The question is: which conditions? It is clear that the room
must be empty when its owner enters it, or all bets
are off. But is that sufficient? Unfortunately not. Jackson's Alloy tool
took 2 seconds~\cite[p.~303]{Jackson06}
to find the following ``guest-in-the-middle'' attack:

\begin{enumerate}

\item Guest 1 checks in and obtains a card $(k_1,k_2)$ for room 1 (whose key
in the lock is $k_1$). Guest 1 does not enter room 1.

\item Guest 2 checks in, obtains a card $(k_2,k_3)$ for room 1, but
does not enter room 1 either.

\item Guest 1 checks in again, obtains a card $(k_3,k_4)$, goes to
room 1, opens it with his old card $(k_1,k_2)$, finds the room empty,
and feels safe \ldots

\end{enumerate}
After Guest~1 has left his room, Guest~2 enters and makes off with the
luggage.

Jackson now assumes that guests return their cards upon
check-out, which can be modelled as follows: upon check-in, the new card
is not added to the guest's set of cards but it replaces his previous
set of cards, i.e.\ guests return old cards the next time they check
in.  Under this assumption, Alloy finds no more counterexamples to
safety --- at least not up to 6 cards and keys and 3 guests and
rooms. This is not a proof but a strong indication that the given
assumptions suffice for safety. We prove that this is indeed the case.

It should be noted that the system also suffers from a liveness
problem: if a guest never enters the room he checked in to, that room
is forever blocked. In practice this is dealt with by a master key. We
ignore liveness.

\subsection{Formalizing safety}
\label{sec:formalizing-safety}

It should be clear that one cannot force guests to always return their
cards (or, equivalently, never to use an old card). We can only prove that if
they do, their room is safe. However, we do not follow Jackson's
approach of globally assuming everybody returns their old cards upon
check-in. Instead we would like to take a local approach where it is up
to each guest whether he follows this safety policy. We allow
guests to keep their cards but make safety dependent on how they use
them.  This generality requires a finer grained model: we need to
record if a guest has entered his room in a safe manner,
i.e.\ if it was empty and if he used the latest key for the room, the
one stored at reception.
The auxiliary variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> records for each room if this
was the case at some point between his last check-in and now.
The main theorem will be that if a room is safe in this
manner, then only the owner can be in the room.
Now we explain how <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> is modified with each event:

\begin{description}
\item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>init›</span></span></span></span>] sets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> True<span class="antiquote"><span class="antiquote">}</span></span></span></span> for every room.
\item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_in›</span></span></span></span>] for room <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> resets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
because it is not safe for the new owner yet.
\item[<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] enter_room<span class="antiquote"><span class="antiquote">}</span></span></span></span>] for room <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> sets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if
the owner entered an empty room using the latest card issued for that room
by reception, or if the room was already safe.
\item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>exit_room›</span></span></span></span>] does not modify <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{description}

The reader should convince his or herself that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>
corresponds to the informal safety policy set out above.  Note that a
guest may find his room non-empty the first time he enters, and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> will not be set, but he may come back later, find the
room empty, and then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> will be set. Furthermore, it is
important that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] enter_room<span class="antiquote"><span class="antiquote">}</span></span></span></span> cannot reset <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>
due to the disjunct <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∨ safe s r›</span></span></span></span>.  Hence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_in›</span></span></span></span> is
the only event that can reset <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>.  That is, a room stays
safe until the next <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_in›</span></span></span></span>.  Additionally <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> is
initially <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> True<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is fine because initially injectivity
of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>initk›</span></span></span></span> prohibits illegal entries by non-owners.

Note that because none of the other state components depend on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span>
safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>, it is truly auxiliary: it can be deleted from the system and
the same set of reachable states is obtained, modulo the absence of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We have formalized a very general safety policy of always using the
latest card. A special case of this policy is the one called
\emph{NoIntervening} by Jackson~\cite[p.~200]{Jackson06}: every <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>check_in›</span></span></span></span> must immediately be followed by the corresponding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source]
enter_room<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">lemma</span></span> currk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> currk <span class="free">s</span> <span class="free">r</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> key1_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">:</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> key2_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">:</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> roomk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> roomk <span class="free">s</span> <span class="free">k</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> currk_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">∀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span>currk <span class="free">s</span> <span class="bound">r</span> <span class="main">=</span> currk <span class="free">s</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> key1_not_currk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">(</span>currk <span class="free">s</span> <span class="free">r</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">∉</span> cards <span class="free">s</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> guest_key2_disj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">:</span> reach<span class="main">;</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g<span class="hidden">⇩</span><sub>1</sub></span><span class="main">=</span><span class="free">g<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_roomk_currk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> safe <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> roomk <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> currk <span class="free">s</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> safe_only_owner_enter_normal_aux<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">:</span> reach<span class="main">;</span> safe <span class="free">s</span> <span class="free">r</span><span class="main">;</span> <span class="main">(</span><span class="free">k'</span><span class="main">,</span>roomk <span class="free">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_only_owner_enter_normal<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> safe <span class="free">s</span> <span class="free">r</span><span class="main">;</span> <span class="main">(</span><span class="free">k'</span><span class="main">,</span>roomk <span class="free">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>enter_room <span class="skolem">s</span> <span class="skolem">k</span> <span class="skolem">k1</span> <span class="skolem">g1</span> <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span>isin <span class="main">:=</span> <span class="main">(</span>isin <span class="skolem">s</span><span class="main">)</span><span class="main">(</span><span class="skolem">r1</span> <span class="main">:=</span> isin <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">g1</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
               roomk <span class="main">:=</span> <span class="main">(</span>roomk <span class="skolem">s</span><span class="main">)</span><span class="main">(</span><span class="skolem">r1</span> <span class="main">:=</span> <span class="skolem">k1</span><span class="main">)</span><span class="main">,</span>
               safe <span class="main">:=</span> <span class="main">(</span>safe <span class="skolem">s</span><span class="main">)</span>
                 <span class="main">(</span><span class="skolem">r1</span> <span class="main">:=</span>
                    owns <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> Some <span class="skolem">g1</span> <span class="main">∧</span> isin <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="skolem">k1</span> <span class="main">=</span> currk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">∨</span>
                    safe <span class="skolem">s</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> s <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> reach›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⟦</span> safe <span class="skolem">s</span> <span class="free">r</span><span class="main">;</span> <span class="main">(</span><span class="free">k'</span><span class="main">,</span> roomk <span class="skolem">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> cards <span class="skolem">s</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="skolem">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> card_g1 <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">k1</span><span class="main">)</span> <span class="main">∈</span> cards <span class="skolem">s</span> <span class="skolem">g1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> safe <span class="main">=</span> <span class="quoted"><span class="quoted">‹safe <span class="var">?s'</span> <span class="free">r</span>›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> card_g <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k'</span><span class="main">,</span>roomk <span class="var">?s'</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> cards <span class="var">?s'</span> <span class="free">g</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"roomk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∨</span> roomk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">k1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹roomk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">k1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"roomk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="free">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> IH safe card_g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> safe'<span class="main">:</span> <span class="quoted"><span class="quoted">"owns <span class="skolem">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="skolem">g1</span> <span class="main">∨</span> safe <span class="skolem">s</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"safe <span class="skolem">s</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> s card_g1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"owns <span class="skolem">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="skolem">g1</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"owns <span class="var">?s'</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> s card_g card_g1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"roomk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">k1</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> enter_room <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> safe <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">:</span> isin <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> safe<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">:</span> isin <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>enter_room <span class="skolem">s</span> <span class="skolem">k1</span> <span class="skolem">k2</span> <span class="skolem">g1</span> <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span>isin <span class="main">:=</span> <span class="main">(</span>isin <span class="skolem">s</span><span class="main">)</span><span class="main">(</span><span class="skolem">r1</span> <span class="main">:=</span> isin <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">g1</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
               roomk <span class="main">:=</span> <span class="main">(</span>roomk <span class="skolem">s</span><span class="main">)</span><span class="main">(</span><span class="skolem">r1</span> <span class="main">:=</span> <span class="skolem">k2</span><span class="main">)</span><span class="main">,</span>
               safe <span class="main">:=</span> <span class="main">(</span>safe <span class="skolem">s</span><span class="main">)</span>
                 <span class="main">(</span><span class="skolem">r1</span> <span class="main">:=</span>
                    owns <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> Some <span class="skolem">g1</span> <span class="main">∧</span> isin <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="skolem">k2</span> <span class="main">=</span> currk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">∨</span>
                    safe <span class="skolem">s</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> s <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> reach›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⟦</span> safe <span class="skolem">s</span> <span class="free">r</span><span class="main">;</span> <span class="free">g</span> <span class="main">∈</span> isin <span class="skolem">s</span> <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="skolem">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> card_g1 <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">k1</span><span class="main">,</span><span class="skolem">k2</span><span class="main">)</span> <span class="main">∈</span> cards <span class="skolem">s</span> <span class="skolem">g1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> safe <span class="main">=</span> <span class="quoted"><span class="quoted">‹safe <span class="var">?s'</span> <span class="free">r</span>›</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> isin <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="main">∈</span> isin <span class="var">?s'</span> <span class="free">r</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="free">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> IH isin safe <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> isin <span class="skolem">s</span> <span class="free">r</span> <span class="main">∨</span> <span class="free">g</span> <span class="main">=</span> <span class="skolem">g1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> isin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> isin <span class="skolem">s</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe <span class="skolem">s</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="skolem">g1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k2</span> <span class="main">=</span> roomk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">∨</span> <span class="skolem">k1</span> <span class="main">=</span> roomk <span class="skolem">s</span> <span class="skolem">r1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹roomk <span class="skolem">s</span> <span class="skolem">r1</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k1</span><span class="main">,</span><span class="skolem">k2</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k2</span> <span class="main">=</span> roomk <span class="skolem">s</span> <span class="skolem">r1</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> card_g1 s safe <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k1</span> <span class="main">=</span> roomk <span class="skolem">s</span> <span class="skolem">r1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"owns <span class="skolem">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="skolem">g1</span> <span class="main">∨</span> safe <span class="skolem">s</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"owns <span class="skolem">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="skolem">g1</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"safe <span class="skolem">s</span> <span class="free">r</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> s card_g1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

\subsection{Verifying safety}
\label{sec:verisafe}

All of our lemmas are invariants of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> reach<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The complete list, culminating in the main theorem, is this:
\begin{lemma}\label{state-lemmas}
\begin{enumerate}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> currk_issued<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> key1_issued<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> key2_issued<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> roomk_issued<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item \label{currk_inj} <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> currk_inj<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item \label{key1_not_currk} <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> key1_not_currk<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> guest_key2_disj<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item \label{safe_roomk_currk} <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display] safe_roomk_currk<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item \label{safe_only_owner_enter_normal} <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> safe_only_owner_enter_normal<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{enumerate}
\end{lemma}
\begin{theorem}\label{safe-state}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=IfThen] safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{theorem}
The lemmas and the theorem are proved in this order, each one is marked as a
simplification rule, and each proof is a one-liner: induction on
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">∈</span></span> reach"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> followed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>auto›</span></span></span></span>.

Although, or maybe even because these proofs work so smoothly one may
like to understand why. Hence we examine the proof of
Theorem~\ref{safe-state} in more detail. The only interesting case is
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] enter_room<span class="antiquote"><span class="antiquote">}</span></span></span></span>. We assume that guest <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> enters room
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> with card <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and call the new state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span>.
We assume <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and prove
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"owns <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌊</span></span><span class="free"><span class="free">g</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by case distinction.
If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the claim follows directly from the induction hypothesis
using \mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"owns <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> owns <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivalent with
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">∨</span></span> <span class="free"><span class="free">g</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">g<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then
\mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} follows from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by
definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source]enter_room<span class="antiquote"><span class="antiquote">}</span></span></span></span> because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
implies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"isin <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Hence the induction hypothesis implies the
claim.  If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">g<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we make another case distinction.
If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">=</span></span> roomk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the claim follows immediately from
Lemma~\ref{state-lemmas}.\ref{safe_only_owner_enter_normal} above:
only the owner of a room can possess a card where the second
key is the room key.
If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">=</span></span> roomk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then, by definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source]enter_room<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"owns <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌊</span></span><span class="free"><span class="free">g</span></span><span class="main"><span class="main">⌋</span></span> <span class="main"><span class="main">∨</span></span> safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
In the first case the claim is immediate. If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"roomk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> currk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
(by Lemma~\ref{state-lemmas}.\ref{safe_roomk_currk})
and thus <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>currk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> cards <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by assumption
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> cards <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">g<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, thus contradicting
Lemma~\ref{state-lemmas}.\ref{key1_not_currk}.

This detailed proof shows that a number of case distinctions are
required. Luckily, they all suggest themselves to Isabelle via the
definition of function update (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>:=›</span></span></span></span>) or via disjunctions that
arise automatically.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="NewCard">
<div class="head">
<h1>Theory NewCard</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      State based hotel key card system with "new card"

    Author:     Tobias Nipkow, TU Muenchen

Like State.thy but with additional features: cards can be lost and new
ones can be issued. Cannot build on State.thy because record state
needs to be extended with a new field. This would require explaining
Isabelle's record inheritance. An interesting project, but not now.
*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> NewCard
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
 <span class="quoted">"<span class="entity">SomeFloor</span>"</span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">⌊</span>_<span class="keyword1">⌋</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⌊</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">⌋</span></span> <span class="main">≡</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> if_split_asm<span class="main">[</span><span class="operator">split</span><span class="main">]</span>

<span class="keyword1"><span class="command">typedecl</span></span> guest
<span class="keyword1"><span class="command">typedecl</span></span> key
<span class="keyword1"><span class="command">type_synonym</span></span> card <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">*</span> key"</span></span>
<span class="keyword1"><span class="command">typedecl</span></span> room

<span class="keyword1"><span class="command">record</span></span> state <span class="main">=</span>
 <span class="comment1">(* reception: *)</span>
 owns <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> guest option"</span></span>
 prevk <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> key"</span></span>
 currk <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> key"</span></span>
 issued <span class="main">::</span> <span class="quoted"><span class="quoted">"key set"</span></span>
 <span class="comment1">(* guests: *)</span>
 cards <span class="main">::</span> <span class="quoted"><span class="quoted">"guest <span class="main">⇒</span> card set"</span></span>
 <span class="comment1">(* rooms: *)</span>
 roomk <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> key"</span></span>
 isin <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> guest set"</span></span>
 <span class="comment1">(* ghost variable: *)</span>
 safe <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
init<span class="main">:</span> <span class="comment1">(* prevk = arbitrary prevents the invariant prevk : issued *)</span>
<span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">initk</span></span></span> <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">initk</span></span></span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">⦇</span> owns <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> None<span class="main">)</span><span class="main">,</span> prevk <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">initk</span></span></span><span class="main">,</span> currk <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">initk</span></span></span><span class="main">,</span> issued <span class="main">=</span> range <span class="free"><span class="bound"><span class="entity">initk</span></span></span><span class="main">,</span>
  cards <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span> roomk <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">initk</span></span></span><span class="main">,</span> isin <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span>
  safe <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> True<span class="main">)</span> <span class="main">⦈</span> <span class="main">∈</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> enter_room<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span> <span class="main">∈</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> roomk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span>
<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span> isin <span class="main">:=</span> <span class="main">(</span>isin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
   roomk <span class="main">:=</span> <span class="main">(</span>roomk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span><span class="main">)</span><span class="main">,</span>
   safe <span class="main">:=</span> <span class="main">(</span>safe <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> owns <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">⌋</span> <span class="main">∧</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">=</span> currk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                              <span class="main">∨</span> safe <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
  <span class="main">⦈</span> <span class="main">∈</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> exit_room<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span> isin <span class="main">:=</span> <span class="main">(</span>isin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">∈</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> check_in<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">:</span> <span class="free">reach</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∉</span> issued <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span>currk <span class="main">:=</span> <span class="main">(</span>currk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">,</span> prevk <span class="main">:=</span> <span class="main">(</span>prevk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> currk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span>
   issued <span class="main">:=</span> issued <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span><span class="main">,</span>
   cards <span class="main">:=</span> <span class="main">(</span>cards <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">:=</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>currk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
   owns <span class="main">:=</span>  <span class="main">(</span>owns <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">,</span>
   safe <span class="main">:=</span> <span class="main">(</span>safe <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> False<span class="main">)</span> <span class="main">⦈</span> <span class="main">:</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> loose_card<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">:</span> <span class="free">reach</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">:</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span>
 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span>cards <span class="main">:=</span> <span class="main">(</span>cards <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">:=</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">⦈</span> <span class="main">:</span> <span class="free">reach</span>"</span></span>

<span class="main">|</span> new_card<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">:</span> <span class="free">reach</span> <span class="main">⟹</span> owns <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span>
 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦇</span>cards <span class="main">:=</span> <span class="main">(</span>cards <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">:=</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>prevk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> currk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">⦈</span> <span class="main">:</span> <span class="free">reach</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> currk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> currk <span class="free">s</span> <span class="free">r</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prevk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> prevk <span class="free">s</span> <span class="free">r</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> key2_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">:</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> key1_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">:</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> roomk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> roomk <span class="free">s</span> <span class="free">k</span> <span class="main">:</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> currk_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">∀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> <span class="main">(</span>currk <span class="free">s</span> <span class="bound">r</span> <span class="main">=</span> currk <span class="free">s</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> currk_not_prevk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r'</span> <span class="main">=</span> Some <span class="free">g</span> <span class="main">⟹</span> currk <span class="free">s</span> <span class="free">r</span> <span class="main">≠</span> prevk <span class="free">s</span> <span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> key1_not_currk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="main">(</span>currk <span class="free">s</span> <span class="free">r</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">∉</span> cards <span class="free">s</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> key2_not_currk<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">≠</span> <span class="free">g'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> currk <span class="free">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">∉</span> cards <span class="free">s</span> <span class="free">g'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> guest_key2_disj2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">:</span> reach<span class="main">;</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g<span class="hidden">⇩</span><sub>1</sub></span><span class="main">=</span><span class="free">g<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>key2_not_currk<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_roomk_currk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> safe <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> roomk <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> currk <span class="free">s</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> only_owner_enter_normal<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">:</span> reach<span class="main">;</span> safe <span class="free">s</span> <span class="free">r</span><span class="main">;</span> <span class="main">(</span><span class="free">k'</span><span class="main">,</span>roomk <span class="free">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span> safe <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">:</span> isin <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> reach<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> new_invs <span class="main">=</span> prevk_issued currk_not_prevk key2_not_currk
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹An extension›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
To test the flexibility of our model we extended it with the
possibility for obtaining a new card, e.g.\ when one has lost one's
card. Now reception needs to remember not just the current but also
the previous key for each room, i.e.\ a new field <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>prevk :: room
⇒ key›</span></span></span></span> is added to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">state</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It is initialized with the same value
as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> currk<span class="antiquote"><span class="antiquote">}</span></span></span></span>: though strictly speaking it could be arbitrary,
this permits the convenient invariant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"prevk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">∈</span></span> issued <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Upon check-in we set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>prevk›</span></span></span></span> to \mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>prevk <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">r</span></span> <span class="main"><span class="main">:=</span></span> currk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}.
Event <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>new_card›</span></span></span></span> is simple enough:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display] new_card<span class="antiquote"><span class="antiquote">}</span></span></span></span>

The verification is not seriously affected. Some additional
invariants are required
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display] new_invs<span class="antiquote"><span class="antiquote">}</span></span></span></span>
but the proofs are still of the same trivial induct-auto format.

Adding a further event for loosing a card has no impact at all on the proofs.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Trace">
<div class="head">
<h1>Theory Trace</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Trace
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Basis.html">Basis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> if_split_asm<span class="main">[</span><span class="operator">split</span><span class="main">]</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹A trace based model›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The only clumsy aspect of the state based model is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe›</span></span></span></span>: we use a state component to record if the sequence of events
that lead to a state satisfies some property. That is, we simulate a
condition on traces via the state. Unsurprisingly, it is not trivial
to convince oneself that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe›</span></span></span></span> really has the informal meaning
set out at the beginning of subsection~\ref{sec:formalizing-safety}.
Hence we now describe an alternative, purely trace based model,
similar to Paulson's inductive protocol model~\cite{Paulson-JCS98}.
The events are:
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> event <span class="main">=</span>
  Check_in <span class="quoted">guest</span> <span class="quoted">room</span> <span class="quoted">card</span> <span class="main">|</span> Enter <span class="quoted">guest</span> <span class="quoted">room</span> <span class="quoted">card</span> <span class="main">|</span> Exit <span class="quoted">guest</span> <span class="quoted">room</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Instead of a state, we have a trace, i.e.\ list of events, and
extract the state from the trace:›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  initk <span class="main">::</span> <span class="quoted"><span class="quoted">"room <span class="main">⇒</span> key"</span></span>
   
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">owns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> room <span class="main">⇒</span> guest option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">owns</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">owns</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
 Check_in <span class="bound">g</span> <span class="bound">r'</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Some <span class="bound">g</span> <span class="keyword1">else</span> <span class="free">owns</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
 Enter <span class="bound">g</span> <span class="bound">r'</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="free">owns</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
 Exit <span class="bound">g</span> <span class="bound">r'</span> <span class="main">⇒</span> <span class="free">owns</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">currk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> room <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">currk</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> initk <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">currk</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">currk</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> Check_in <span class="bound">g</span> <span class="bound">r'</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> snd <span class="bound">c</span> <span class="keyword1">else</span> <span class="bound">k</span>
            <span class="main">|</span> Enter <span class="bound">g</span> <span class="bound">r'</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="bound">k</span>
            <span class="main">|</span> Exit <span class="bound">g</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">issued</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> key set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">issued</span> <span class="main">[]</span> <span class="main">=</span> range initk"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">issued</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">issued</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> Check_in <span class="bound">g</span> <span class="bound">r</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="main">{</span>snd <span class="bound">c</span><span class="main">}</span> <span class="main">|</span> Enter <span class="bound">g</span> <span class="bound">r</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Exit <span class="bound">g</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cards</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> guest <span class="main">⇒</span> card set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cards</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cards</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">C</span> <span class="main">=</span> <span class="free">cards</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">in</span>
                    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> Check_in <span class="bound">g'</span> <span class="bound">r</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">g'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">then</span> insert <span class="bound">c</span> <span class="bound">C</span>
                                                <span class="keyword1">else</span> <span class="bound">C</span>
                            <span class="main">|</span> Enter <span class="bound">g</span> <span class="bound">r</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="bound">C</span>
                            <span class="main">|</span> Exit <span class="bound">g</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">roomk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> room <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">roomk</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> initk <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">roomk</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">roomk</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> Check_in <span class="bound">g</span> <span class="bound">r'</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="bound">k</span>
            <span class="main">|</span> Enter <span class="bound">g</span> <span class="bound">r'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="comment1">⌦‹∧ x = k›</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="bound">k</span>
            <span class="main">|</span> Exit <span class="bound">g</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">isin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> room <span class="main">⇒</span> guest set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">isin</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">isin</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">G</span> <span class="main">=</span> <span class="free">isin</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
                 <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> Check_in <span class="bound">g</span> <span class="bound">r</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="bound">G</span>
                 <span class="main">|</span> Enter <span class="bound">g</span> <span class="bound">r'</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">g</span><span class="main">}</span> <span class="main">∪</span> <span class="bound">G</span> <span class="keyword1">else</span> <span class="bound">G</span>
                 <span class="main">|</span> Exit <span class="bound">g</span> <span class="bound">r'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">r'</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> <span class="bound">G</span> <span class="main">-</span> <span class="main">{</span><span class="bound">g</span><span class="main">}</span> <span class="keyword1">else</span> <span class="bound">G</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">hotel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">hotel</span> <span class="main">[]</span>  <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">hotel</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">hotel</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
  Check_in <span class="bound">g</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">k</span> <span class="main">=</span> currk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">k'</span> <span class="main">∉</span> issued <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">|</span>
  Enter <span class="bound">g</span> <span class="bound">r</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">k'</span><span class="main">)</span> <span class="main">:</span> cards <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">g</span> <span class="main">&amp;</span> <span class="main">(</span>roomk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r</span> <span class="main">:</span> <span class="main">{</span><span class="bound">k</span><span class="main">,</span> <span class="bound">k'</span><span class="main">}</span><span class="main">)</span> <span class="main">|</span>
  Exit <span class="bound">g</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">g</span> <span class="main">:</span> isin <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Except for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> initk<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is completely unspecified,
all these functions are defined by primitive recursion over traces:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]owns.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]currk.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]issued.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]cards.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]roomk.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]isin.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>

However, not every trace is possible. Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> hotel<span class="antiquote"><span class="antiquote">}</span></span></span></span> tells us
which traces correspond to real hotels:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]hotel.simps<span class="antiquote"><span class="antiquote">}</span></span></span></span>
Alternatively we could have followed Paulson~\cite{Paulson-JCS98}
in defining <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> hotel<span class="antiquote"><span class="antiquote">}</span></span></span></span> as an inductive set of traces.
The difference is only slight.

\subsection{Formalizing safety}
\label{sec:FormalSafetyTrace}

The principal advantage of the trace model is the intuitive
specification of safety. Using the auxiliary predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>no_Check_in›</span></span></span></span>
›</span></span>

<span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">no_Check_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> room <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span><span class="comment1">(*&gt;*)</span>
<span class="quoted"><span class="quoted">"<span class="free">no_Check_in</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">g</span> <span class="bound">c</span><span class="main">.</span> Check_in <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\medskip\noindent we define a trace to be <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> for a
room if the card obtained at the last <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Check_in<span class="antiquote"><span class="antiquote">}</span></span></span></span> was later
actually used to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Enter<span class="antiquote"><span class="antiquote">}</span></span></span></span> the room:›</span></span>

<span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> room <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span><span class="comment1">(*&gt;*)</span>
<span class="quoted"><span class="quoted">"<span class="free">safe<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">g</span> <span class="bound">c</span><span class="main">.</span>
 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="main">[</span>Enter <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> no_Check_in <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\medskip\noindent A trace is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe›</span></span></span></span> if additionally the room was
empty when it was entered:›</span></span>

<span class="comment1">(*&lt;*)</span><span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event list <span class="main">⇒</span> room <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span><span class="comment1">(*&gt;*)</span>
<span class="quoted"><span class="quoted">"<span class="free">safe</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">g</span> <span class="bound">c</span><span class="main">.</span>
 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="main">[</span>Enter <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span>
 no_Check_in <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> isin <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\medskip\noindent The two notions of safety are distinguished because,
except for the main theorem, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="hidden">⇩</span><sub>0</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span> suffices.

The alert reader may already have wondered why, in contrast to the
state based model, we do not require <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> initk<span class="antiquote"><span class="antiquote">}</span></span></span></span> to be
injective. If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> initk<span class="antiquote"><span class="antiquote">}</span></span></span></span> is not injective, e.g.\ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"initk
<span class="free"><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">=</span></span> initk <span class="free"><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span>Enter <span class="free"><span class="free">g</span></span> <span class="free"><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">(</span></span>initk <span class="free"><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> Check_in <span class="free"><span class="free">g</span></span>
<span class="free"><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">(</span></span>initk <span class="free"><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a legal trace and guest <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> ends up in a room he is not the owner of.  However, this is not a
safe trace for room <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> according to our
definition. This reflects that hotel rooms are not safe until
the first time their owner has entered them. We no longer protect the
hotel from its guests.›</span></span>

<span class="comment1">(* state thm w/o "isin"
hotel s ==&gt; s = Enter g # s' ⟹ owns s' r = Some g ∨ s' = s1 @ Checkin g @ s2 ∧ 
no checkin, no enter in s1

*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">lemma</span></span> safe_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> safe<span class="hidden">⇩</span><sub>0</sub> <span class="free">s</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe<span class="hidden">⇩</span><sub>0</sub>_def safe_def<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> initk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hotel <span class="free">s</span> <span class="main">⟹</span> initk <span class="free">r</span> <span class="main">∈</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> currk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hotel <span class="free">s</span> <span class="main">⟹</span> currk <span class="free">s</span> <span class="free">r</span> <span class="main">∈</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> key1_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hotel <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">:</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">∈</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> key2_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hotel <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">:</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">∈</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> roomk_issued<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hotel <span class="free">s</span> <span class="main">⟹</span> roomk <span class="free">s</span> <span class="free">r</span> <span class="main">∈</span> issued <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> issued_app<span class="main">:</span> <span class="quoted"><span class="quoted">"issued <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> issued <span class="free">s</span> <span class="main">∪</span> issued <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> owns_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"no_Check_in <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span> <span class="main">⟹</span> owns <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> owns <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> currk_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"no_Check_in <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span> <span class="main">⟹</span> currk <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> currk <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> currk_Check_in<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> Check_in <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">k'</span><span class="main">)</span><span class="main">#</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">;</span>
    <span class="free">k'</span> <span class="main">=</span> currk <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> Check_in <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">k'</span><span class="main">)</span> <span class="main">#</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">r'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> issued_app <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_checkin_no_newkey<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel<span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">;</span> no_Check_in <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span> <span class="main">⟧</span>
 <span class="main">⟹</span> <span class="main">(</span><span class="free">k'</span><span class="main">,</span><span class="free">k''</span><span class="main">)</span> <span class="main">∉</span> cards <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> Check_in <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">#</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">g'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> currk_Check_in<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> guest_key2_disj2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g<span class="hidden">⇩</span><sub>1</sub></span><span class="main">=</span><span class="free">g<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_roomk_currk<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"hotel <span class="free">s</span> <span class="main">⟹</span> safe<span class="hidden">⇩</span><sub>0</sub> <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> roomk <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> currk <span class="free">s</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>safe<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">hypsubst_thin</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> guest ba<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">b</span><span class="main">,</span> <span class="improper">ba</span><span class="main">)</span>
        <span class="main">∉</span> cards <span class="main">(</span><span class="main">(</span><span class="improper">list</span> <span class="main">@</span> Enter <span class="improper">g</span> <span class="free">r</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span> <span class="main">#</span> <span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">@</span> Check_in <span class="improper">g</span> <span class="free">r</span> <span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span> <span class="main">#</span> <span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
           <span class="improper">guest</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> no_checkin_no_newkey<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> only_owner_enter_normal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel <span class="free">s</span><span class="main">;</span> safe<span class="hidden">⇩</span><sub>0</sub> <span class="free">s</span> <span class="free">r</span><span class="main">;</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span>roomk <span class="free">s</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>safe<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">hypsubst_thin</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>issued_app <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* A short proof *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel <span class="free">s</span><span class="main">;</span> safe <span class="free">s</span> <span class="free">r</span><span class="main">;</span> <span class="free">g</span> <span class="main">∈</span> isin <span class="free">s</span> <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safe_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">hypsubst_thin</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> g' k k'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span>
 <span class="quoted"><span class="quoted">"safe<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="improper">list</span> <span class="main">@</span> Enter <span class="improper">g'</span> <span class="free">r</span> <span class="main">(</span><span class="improper">k</span><span class="main">,</span><span class="improper">k'</span><span class="main">)</span> <span class="main">#</span> <span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> Check_in <span class="improper">g'</span> <span class="free">r</span> <span class="main">(</span><span class="improper">k</span><span class="main">,</span> <span class="improper">k'</span><span class="main">)</span> <span class="main">#</span> <span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safe<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cut_tac</span> s<span class="hidden">⇩</span><sub>2</sub> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">list</span> <span class="main">@</span> Enter <span class="improper">g'</span> <span class="free">r</span> <span class="main">(</span><span class="improper">k</span><span class="main">,</span> <span class="improper">k'</span><span class="main">)</span> <span class="main">#</span> <span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> no_checkin_no_newkey<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span>
 <span class="quoted"><span class="quoted">"safe<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="improper">list</span> <span class="main">@</span> Enter <span class="improper">g'</span> <span class="free">r</span> <span class="main">(</span><span class="improper">k</span><span class="main">,</span><span class="improper">k'</span><span class="main">)</span> <span class="main">#</span> <span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> Check_in <span class="improper">g'</span> <span class="free">r</span> <span class="main">(</span><span class="improper">k</span><span class="main">,</span> <span class="improper">k'</span><span class="main">)</span> <span class="main">#</span> <span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">r</span>"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> only_owner_enter_normal<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safe<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_conv_decomp_firstD<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">ys</span> <span class="bound">x</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ys</span> <span class="bound">x</span> <span class="bound">zs</span><span class="main">.</span> <span class="var">?P</span> <span class="free">xs</span> <span class="bound">ys</span> <span class="bound">x</span> <span class="bound">zs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="free">P</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">[]</span> <span class="skolem">a</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="free">P</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons_eq_appendI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ownsD<span class="main">:</span> <span class="quoted"><span class="quoted">"owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span> <span class="main">⟹</span>
 <span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">g</span> <span class="bound">c</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="bound">g</span> <span class="free">r</span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> no_Check_in <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_Check_in_owns<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"no_Check_in <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Enter_safe<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel<span class="main">(</span>Enter <span class="free">g</span> <span class="free">r</span> <span class="free">c</span> <span class="main">#</span> <span class="free">s</span><span class="main">)</span><span class="main">;</span> safe<span class="hidden">⇩</span><sub>0</sub> <span class="free">s</span> <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">g</span> <span class="bound">c</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="bound">g</span> <span class="free">r</span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> no_Check_in <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span>"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safe<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>no_checkin_no_newkey<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> only_owner_enter_normal<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_future<span class="main">:</span> <span class="quoted"><span class="quoted">"safe<span class="hidden">⇩</span><sub>0</sub> <span class="free">s</span> <span class="free">r</span> <span class="main">⟹</span> no_Check_in <span class="free">s'</span> <span class="free">r</span> <span class="main">⟹</span> safe<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">s'</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>safe<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> Enter_safe_future<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel<span class="main">(</span>Enter <span class="free">g</span> <span class="free">r</span> <span class="free">c</span> <span class="main">#</span> <span class="free">s'</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span><span class="main">;</span> safe<span class="hidden">⇩</span><sub>0</sub> <span class="free">s</span> <span class="free">r</span><span class="main">;</span> no_Check_in <span class="free">s'</span> <span class="free">r</span> <span class="main">⟧</span>
 <span class="main">⟹</span> owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> safe_future<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Enter_safe<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
  \begin{figure}
  \begin{center}\begin{minipage}{\textwidth}  
  \isastyle\isamarkuptrue
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> safe<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hotel <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> isin <span class="free">s</span> <span class="free">r</span>"</span></span>
                    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">g</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">g'</span> <span class="skolem">k</span> <span class="skolem">k'</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Enter <span class="skolem">g'</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="skolem">g'</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="var">?b</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"isin <span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="skolem">g'</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> hotel <span class="var">?s</span><span class="main">;</span> no_Check_in <span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">r</span><span class="main">;</span> <span class="free">g</span> <span class="main">∈</span> isin <span class="var">?s</span> <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">g'</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span> <span class="main">⋅</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">@</span> <span class="var">?b</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Enter <span class="skolem">g''</span> <span class="skolem">r'</span> <span class="skolem">c</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g''</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"hotel <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> cards <span class="var">?s</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hotel <span class="var">?t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="var">?s</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹no_Check_in <span class="main">(</span><span class="main">(</span><span class="skolem">e</span> <span class="main">⋅</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">r</span>›</span></span> 0
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>safe_def<span class="main">)</span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"roomk <span class="var">?s</span> <span class="free">r</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> safe_roomk_currk<span class="main">[</span><span class="operator">OF</span> 1 safe_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">]</span></span><span class="main">]</span>
                <span class="quoted"><span class="quoted">‹no_Check_in <span class="main">(</span><span class="main">(</span><span class="skolem">e</span> <span class="main">⋅</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> roomk <span class="var">?s</span> <span class="free">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> no_checkin_no_newkey<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="hidden">⇩</span><sub>2</sub> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">@</span> <span class="main">[</span>Enter <span class="skolem">g'</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main">]</span>
                1 2 <span class="quoted"><span class="quoted">‹no_Check_in <span class="main">(</span><span class="main">(</span><span class="skolem">e</span> <span class="main">⋅</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> roomk <span class="var">?s</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hotel <span class="var">?t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> only_owner_enter_normal<span class="main">[</span><span class="operator">OF</span> 1 safe_safe<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">]</span></span><span class="main">]</span> 2
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"owns <span class="var">?t</span> <span class="free">r</span> <span class="main">=</span>  <span class="main">⌊</span><span class="free">g</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"owns <span class="var">?t</span> <span class="free">r</span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">g'</span><span class="main">⌋</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hotel <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹no_Check_in <span class="main">(</span><span class="main">(</span><span class="skolem">e</span> <span class="main">⋅</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g''</span> <span class="main">≠</span> <span class="free">g</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≠</span> <span class="free">r</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">g</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>safe_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹
  \end{minipage}
  \end{center}
  \caption{Isar proof of Theorem~\ref{safe}}\label{fig:proof}
  \end{figure}
›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
\subsection{Verifying safety}

Lemma~\ref{state-lemmas} largely carries over after replacing
\mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">:</span></span> <span class="free"><span class="free">reach</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"hotel <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> by
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="hidden">⇩</span><sub>0</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Only properties \ref{currk_inj} and
\ref{key1_not_currk} no longer hold because we no longer assume that
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> roomk<span class="antiquote"><span class="antiquote">}</span></span></span></span> is initially injective.
They are replaced by two somewhat similar properties:
\begin{lemma}\label{trace-lemmas}\mbox{}
\begin{enumerate}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display,margin=80]currk_Check_in<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item \label{no_checkin_no_newkey}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display,margin=100] no_checkin_no_newkey<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{enumerate}
\end{lemma}
Both are proved by induction on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span>.
In addition we need some easy structural properties:
\begin{lemma}\label{app-lemmas}
\begin{enumerate}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> issued_app<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> owns_app<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item \label{currk_app} <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> currk_app<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{enumerate}
\end{lemma}

The main theorem again correspond closely to its state based
counterpart:
\begin{theorem}\label{safe}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=IfThen] safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{theorem}
Let us examine the proof of this theorem to show how it differs from
the state based version. For the core of the proof let
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span>Enter <span class="free"><span class="free">g'</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span>Check_in <span class="free"><span class="free">g'</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and assume
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"isin <span class="main"><span class="main">(</span></span><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span>Check_in <span class="free"><span class="free">g'</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (0). By induction on
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s<span class="hidden">⇩</span><sub>3</sub>›</span></span></span></span> we prove
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span>[display]<span class="quoted"><span class="quoted">"<span class="main"><span class="main">⟦</span></span>hotel <span class="free"><span class="free">s</span></span><span class="main"><span class="main">;</span></span> no_Check_in <span class="main"><span class="main">(</span></span><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">;</span></span> <span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">⟧</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">g'</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
The actual theorem follows by definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The base case of the induction follows from (0). For the induction step let
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">e</span></span><span class="main"><span class="main">#</span></span><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span>Enter <span class="free"><span class="free">g'</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span>Check_in <span class="free"><span class="free">g'</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
We assume <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"hotel <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"no_Check_in <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">e</span></span><span class="main"><span class="main">#</span></span><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span> <span class="main"><span class="main">∈</span></span> isin <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and show <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g'</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The proof is by case distinction on the event <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>e›</span></span></span></span>.
The cases <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Check_in<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Exit<span class="antiquote"><span class="antiquote">}</span></span></span></span> follow directly from the
induction hypothesis because the set of occupants of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>
can only decrease. Now we focus on the case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span> <span class="main"><span class="main">=</span></span> Enter <span class="free"><span class="free">g''</span></span> <span class="free"><span class="free">r'</span></span> <span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">r'</span></span> <span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the set of occupants of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> remains unchanged
and the claim follow directly from the induction hypothesis.
If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g''</span></span> <span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> must already have been in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>
before the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Enter›</span></span></span></span> event and the claim again follows directly
from the induction hypothesis. Now assume <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">r'</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g''</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
From <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"hotel <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we obtain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"hotel <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (1) and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span> <span class="main"><span class="main">∈</span></span> cards <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (2), and
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"no_Check_in <span class="main"><span class="main">(</span></span><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and (0)
we obtain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (3). Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
From Lemma~\ref{state-lemmas}.\ref{safe_roomk_currk} and
Lemma~\ref{app-lemmas}.\ref{currk_app} we obtain
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>roomk s r = currk s r = k'›</span></span></span></span>.
Hence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">≠</span></span> roomk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by
Lemma~\ref{trace-lemmas}.\ref{no_checkin_no_newkey}
using (1), (2) and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"no_Check_in <span class="main"><span class="main">(</span></span><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Hence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">=</span></span> roomk <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"hotel <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
With Lemma~\ref{state-lemmas}.\ref{safe_only_owner_enter_normal}
and (1--3) we obtain
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"owns <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span>  <span class="main"><span class="main">⌊</span></span><span class="free"><span class="free">g</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. At the same time we have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"owns <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌊</span></span><span class="free"><span class="free">g'</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"hotel <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"no_Check_in <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">e</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: nobody
has checked in to room <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> after <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g'›</span></span></span></span>. Thus the claim
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">g'</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> follows.

The details of this proof differ from those of Theorem~\ref{safe-state}
but the structure is very similar.

\subsection{Eliminating \isa{isin}}

In the state based approach we needed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> isin<span class="antiquote"><span class="antiquote">}</span></span></span></span> to express our
safety guarantees. In the presence of traces, we can do away with it
and talk about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Enter<span class="antiquote"><span class="antiquote">}</span></span></span></span> events instead. We show that if somebody
enters a safe room, he is the owner:
\begin{theorem}\label{Enter_safe}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=IfThen] Enter_safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{theorem}
From <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"safe<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> it follows that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> must be of the form
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span>Check_in <span class="free"><span class="free">g<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free"><span class="free">r</span></span> <span class="free"><span class="free">c'</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"no_Check_in <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">k</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">k'</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
By Lemma~\ref{state-lemmas}.\ref{safe_roomk_currk} we have
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>roomk s r = currk s r = k'›</span></span></span></span>.
From <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"hotel<span class="main"><span class="main">(</span></span>Enter <span class="free"><span class="free">g</span></span> <span class="free"><span class="free">r</span></span> <span class="free"><span class="free">c</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> it follows that
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> cards <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">k'</span></span> <span class="main"><span class="main">∈</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
By Lemma~\ref{trace-lemmas}.\ref{no_checkin_no_newkey}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">k'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> would contradict <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> cards <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Hence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">y</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">k'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
With Lemma~\ref{state-lemmas}.\ref{safe_only_owner_enter_normal}
we obtain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"owns <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌊</span></span><span class="free"><span class="free">g</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Having dispensed with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> isin<span class="antiquote"><span class="antiquote">}</span></span></span></span> we could also eliminate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span>
Exit<span class="antiquote"><span class="antiquote">}</span></span></span></span> to arrive at a model closer to the ones in~\cite{Jackson06}.

Finally one may quibble that all the safety theorems proved so far
assume safety of the room at that point in time when somebody enters
it.  That is, the owner of the room must be sure that once a room is
safe, it stays safe, in order to profit from those safety theorems.
Of course, this is the case as long as nobody else checks in to that room:
\begin{lemma}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=IfThen]safe_future<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{lemma}
It follows easily that Theorem~\ref{Enter_safe} also extends until check-in:
\begin{corollary}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=IfThen]Enter_safe_future<span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{corollary}

\subsection{Completeness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>}

Having proved correctness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e.\ that safe behaviour
protects against intruders, one may wonder if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> is
complete, i.e.\ if it covers all safe behaviour, or if it is too
restrictive. It turns out that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> is incomplete for two
different reasons.  The trivial one is that in case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> initk<span class="antiquote"><span class="antiquote">}</span></span></span></span> is
injective, every room is protected against intruders right from the
start. That is, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span>Check_in <span class="free"><span class="free">g</span></span> <span class="free"><span class="free">r</span></span> <span class="free"><span class="free">c</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will only allow <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to
enter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> until somebody else checks in to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>. The
second, more subtle incompleteness is that even if there are previous
owners of a room, it may be safe to enter a room with an old card
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>: one merely needs to make sure that no other guest checked
in after the check-in where one obtained <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>. However,
formalizing this is not only messy, it is also somewhat pointless:
this liberalization is not something a guest can take advantage of
because there is no (direct) way he can find out which of his cards
meets this criterion. But without this knowledge, the only safe thing
to do is to make sure he has used his latest card. This incompleteness
applies to the state based model as well.
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Equivalence">
<div class="head">
<h1>Theory Equivalence</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Equivalence
<span class="keyword2"><span class="keyword">imports</span></span> <a href="State.html">State</a> <a href="Trace.html">Trace</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">r</span><span class="main">.</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Trace.safe_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="main">(</span>Exit <span class="free">g</span> <span class="free">r</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">r'</span> <span class="main">=</span> safe <span class="free">t</span> <span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Trace.safe_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe <span class="main">(</span>Check_in <span class="free">g</span> <span class="free">r</span> <span class="free">c</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Trace.safe_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span> <span class="main">⟹</span> safe <span class="main">(</span>Check_in <span class="free">g</span> <span class="free">r'</span> <span class="free">c</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> safe <span class="free">t</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Trace.safe_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="free">r'</span> <span class="main">⟹</span> safe <span class="main">(</span>Enter <span class="free">g</span> <span class="free">r'</span> <span class="free">c</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> safe <span class="free">t</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Trace.safe_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">:</span> reach <span class="main">⟹</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r'</span> <span class="main">⟹</span> <span class="free">r'</span> <span class="main">:</span> reach"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cards_app<span class="main">:</span> <span class="quoted"><span class="quoted">"cards <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="free">s'</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> cards <span class="free">s</span> <span class="free">g</span> <span class="main">∪</span> cards <span class="free">s'</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.split<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> ownsD<span class="main">:</span> <span class="quoted"><span class="quoted">"owns <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> Some <span class="free">g</span> <span class="main">⟹</span>
 <span class="main">∃</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> <span class="main">[</span>Check_in <span class="free">g</span> <span class="free">r</span> <span class="bound">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> no_Check_in <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="free">t</span> <span class="free">r</span> <span class="main">⟹</span> safe <span class="main">(</span>Enter <span class="free">g</span> <span class="free">r</span> <span class="free">c</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Trace.safe_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_key2D<span class="main">:</span>
<span class="quoted"><span class="quoted">"hotel <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> Check_in <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">:</span> cards<span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">@</span> Check_in <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">g'</span> <span class="main">⟹</span> <span class="free">g</span><span class="main">=</span><span class="free">g'</span> <span class="main">∧</span> <span class="free">k<span class="hidden">⇩</span><sub>1</sub></span><span class="main">=</span><span class="free">k<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simp_depth_limit</span> <span class="main"><span class="main">=</span></span> 5<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>issued_app <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> safe_Enter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hotel <span class="main">(</span>Enter <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
 safe <span class="main">(</span>Enter <span class="free">g</span> <span class="free">r</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">k'</span><span class="main">)</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span>
 <span class="main">(</span>owns <span class="free">t</span> <span class="free">r</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">g</span><span class="main">⌋</span> <span class="main">∧</span> isin <span class="free">t</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">k'</span> <span class="main">=</span> currk <span class="free">t</span> <span class="free">r</span> <span class="main">∨</span> safe <span class="free">t</span> <span class="free">r</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule_tac</span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">g</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Trace.safe<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Trace.safe_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ownsD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Trace.safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> same_key2D<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">s<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> hotel_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"inj initk <span class="main">⟹</span> hotel <span class="free">t</span> <span class="main">⟹</span> <span class="main">⦇</span> state.owns <span class="main">=</span> owns <span class="free">t</span><span class="main">,</span>
 state.currk <span class="main">=</span> currk <span class="free">t</span><span class="main">,</span>
 state.issued <span class="main">=</span> issued <span class="free">t</span><span class="main">,</span>
 state.cards <span class="main">=</span> cards <span class="free">t</span><span class="main">,</span>
 state.roomk <span class="main">=</span> roomk <span class="free">t</span><span class="main">,</span>
 state.isin <span class="main">=</span> isin <span class="free">t</span><span class="main">,</span>
 state.safe <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">r</span><span class="main">.</span> safe <span class="free">t</span> <span class="bound">r</span> <span class="main">∨</span> owns <span class="free">t</span> <span class="bound">r</span> <span class="main">=</span>  None<span class="main">)</span><span class="main">⦈</span> <span class="main">:</span> reach"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">insert</span> State.init<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> initk<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">initk</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> reach_cong<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>event.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> exit_room<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> reach_cong<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> guest room key<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">guest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">room</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> check_in<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> reach_cong<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> guest room key1 key2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule_tac</span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">guest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">room</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> enter_room<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> reach_cong<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_hotel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> reach <span class="main">⟹</span>
 <span class="main">∃</span><span class="bound">t</span> <span class="bound">ik</span><span class="main">.</span> initk <span class="main">=</span> <span class="bound">ik</span> <span class="main">⟶</span> hotel <span class="bound">t</span> <span class="main">∧</span>
 state.cards <span class="free">s</span> <span class="main">=</span> cards <span class="bound">t</span> <span class="main">∧</span>
 state.isin <span class="free">s</span> <span class="main">=</span>  isin <span class="bound">t</span> <span class="main">∧</span>
 state.roomk <span class="free">s</span> <span class="main">=</span> roomk <span class="bound">t</span> <span class="main">∧</span> state.owns <span class="free">s</span> <span class="main">=</span> owns <span class="bound">t</span> <span class="main">∧</span>
 state.currk <span class="free">s</span> <span class="main">=</span> currk <span class="bound">t</span> <span class="main">∧</span>
 state.issued <span class="free">s</span> <span class="main">=</span> issued <span class="bound">t</span> <span class="main">∧</span>
 state.safe <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> safe <span class="bound">t</span> <span class="bound">r</span> <span class="main">∨</span> owns <span class="bound">t</span> <span class="bound">r</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> reach.induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Check_in <span class="improper">g</span> <span class="improper">r</span> <span class="main">(</span>currk <span class="improper">t</span> <span class="improper">r</span><span class="main">,</span><span class="improper">k</span><span class="main">)</span> <span class="main">#</span> <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">room</span><span class="main"><span class="main">]</span></span> fun_eq_iff <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">guest</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">room</span><span class="main"><span class="main">]</span></span> fun_eq_iff <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">guest</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>key <span class="main">×</span> key<span class="main">)</span> set"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Enter <span class="improper">g</span> <span class="improper">r</span> <span class="main">(</span>roomk <span class="improper">t</span> <span class="improper">r</span><span class="main">,</span><span class="improper">k'</span><span class="main">)</span> <span class="main">#</span> <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Enter <span class="improper">g</span> <span class="improper">r</span> <span class="main">(</span><span class="improper">k</span><span class="main">,</span> roomk <span class="improper">t</span> <span class="improper">r</span><span class="main">)</span> <span class="main">#</span> <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Exit <span class="improper">g</span> <span class="improper">r</span> <span class="main">#</span> <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">room</span><span class="main"><span class="main">]</span></span> fun_eq_iff <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">guest</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>key <span class="main">×</span> key<span class="main">)</span> set"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Although the state based and the trace based model look similar
enough, the
nagging feeling remains that they could be subtly different. Hence I
wanted to show the equivalence formally. This was very fortunate,
because it revealed some unintended discrepancies (no longer
present). Although I had proved both systems safe, it turned out that
the state based version of safety was more restrictive than the trace
based one. In the state based version of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe›</span></span></span></span> the room had to
be empty the first time the owner enters with the latest card, whereas
in the trace based version any time the owner enters with the latest
card can make a room safe.  Such errors in an automaton checking a
trace property are very common and show the superiority of the trace
based formalism.

When comparing the two models we have to take two slight differences
into account:
\begin{itemize}

\item The initial setting of the room keys <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Trace.initk<span class="antiquote"><span class="antiquote">}</span></span></span></span> in the
trace based model is an arbitrary but fixed value.  In the state based
model any injective initial value is fine.

\item As a consequence (see the end of
Section~\ref{sec:FormalSafetyTrace}) <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> state.safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> is initially
true whereas <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Trace.safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> is initially false.

\end{itemize}
Since many names occur in both models they are disambiguated by the
prefixes <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>state›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Trace›</span></span></span></span>.

In the one direction I have shown that any hotel trace starting
with an injective <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> initk<span class="antiquote"><span class="antiquote">}</span></span></span></span> gives rise to a reachable state
when the components of that state are computed by the trace functions:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]hotel_reach<span class="antiquote"><span class="antiquote">}</span></span></span></span>

Conversely, for any reachable state there is a hotel trace leading to it:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]reach_hotel<span class="antiquote"><span class="antiquote">}</span></span></span></span>
The precondition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"initk <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">ik</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> just says that we can find some
interpretation for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> initk<span class="antiquote"><span class="antiquote">}</span></span></span></span> that works, namely the one that was
chosen as the initial setting for the keys in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\sloppy
The proofs are almost automatic, except for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe›</span></span></span></span>
component. In essence, we have to show that the procedural <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span>
state.safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> implements the declarative <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Trace.safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>. The proof
was complicated by the fact that initially it was not true and I had
to debug <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Trace.safe<span class="antiquote"><span class="antiquote">}</span></span></span></span> by proof.
Unfortunately Isabelle's current counterexample
finders~\cite{BerghoferN-SEFM04,Weber05bounded}
did not seem to work here due to search space reasons.
Once the bugs were ironed out, the following key lemma,
together with some smaller lemmas,
automated the correspondence proof for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>safe›</span></span></span></span>:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display]safe_Enter<span class="antiquote"><span class="antiquote">}</span></span></span></span>
In addition we used many lemmas from the trace model, including
Theorem~\ref{safe}.
\fussy

›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>