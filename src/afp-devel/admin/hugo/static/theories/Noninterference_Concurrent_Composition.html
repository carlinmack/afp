<div id="ConcurrentComposition">
<div class="head">
<h1>Theory ConcurrentComposition</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conservation of CSP Noninterference Security under Concurrent Composition
    Author:      Pasquale Noce
                 Security Certification Specialist at Arjo Systems, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at arjosystems dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Concurrent composition and noninterference security"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ConcurrentComposition
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Noninterference_Sequential_Composition/Propaedeutics.html">Noninterference_Sequential_Composition.Propaedeutics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In his outstanding work on Communicating Sequential Processes \cite{R6}, Hoare has defined two
fundamental binary operations allowing to compose the input processes into another, typically more
complex, process: sequential composition and concurrent composition. Particularly, the output of the
latter operation is a process in which any event not shared by both operands can occur whenever the
operand that admits the event can engage in it, whereas any event shared by both operands can occur
just in case both can engage in it. In other words, shared events are those that synchronize the
concurrent processes, which on the contrary can engage asynchronously in the respective non-shared
events.

This paper formalizes Hoare's definition of concurrent composition and proves, in the general case
of a possibly intransitive policy, that CSP noninterference security \cite{R1} is conserved under
this operation, viz. the security of both of the input processes implies that of the output process.
This result, along with the analogous one concerning sequential composition attained in \cite{R5},
enables the construction of more and more complex processes enforcing noninterference security by
composing, sequentially or concurrently, simpler secure processes, whose security can in turn be
proven using either the definition of security formulated in \cite{R1}, or the unwinding theorems
demonstrated in \cite{R2}, \cite{R3}, and \cite{R4}.

Throughout this paper, the salient points of definitions and proofs are commented; for additional
information, cf. Isabelle documentation, particularly \cite{R7}, \cite{R8}, \cite{R9}, and
\cite{R10}.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Propaedeutic definitions and lemmas"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The starting point is comprised of some definitions and lemmas propaedeutic to the proof of the
target security conservation theorem.

Particularly, the definition of operator \emph{after} given in \cite{R6} is formalized, and it is
proven that for any secure process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and any trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> after
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is still a secure process. Then, this result is used to generalize the lemma stating the
closure of the failures of a secure process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under intransitive purge, proven in \cite{R5},
to the futures of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> associated to any one of its traces. This is a generalization of the
former result since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"futures <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">=</span></span> failures <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sinks_aux_elem <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">⟶</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_ref_aux_cons<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_1_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> traces_failures<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_3_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">Y'</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_3<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_4_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span> <span class="main">∨</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> insert <span class="free">x</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> append_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_4<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_5_general <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> append_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_5<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below is the definition of operator \emph{after}, for which a symbolic notation similar to the
one used in \cite{R6} is introduced. Then, it is proven that for any process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and any trace
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the failures set and the divergences set of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> after <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
indeed enjoy their respective characteristic properties as defined in \cite{R1}.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">future_divergences</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">future_divergences</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∈</span> divergences <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">after</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> process"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∖</span>"</span> 64<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">∖</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> Abs_process <span class="main">(</span>futures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> future_divergences <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_5_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> future_divergences <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> future_divergences <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> future_divergences_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> append_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> process_rule_5<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_6_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> future_divergences <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def future_divergences_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_6<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_rep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Rep_process <span class="main">(</span><span class="free">P</span> <span class="main">∖</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>futures <span class="free">P</span> <span class="free">xs</span><span class="main">,</span> future_divergences <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?X</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> after_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Abs_process_inverse<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_1 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_1_futures <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_2 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_2_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_futures<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_3 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_3_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3_futures<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_4 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_4_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_4_futures<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_5 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_5_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_5_futures<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_6 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_6_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6_futures<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> after_failures<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"failures <span class="main">(</span><span class="free">P</span> <span class="main">∖</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> futures <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def after_rep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> after_futures<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"futures <span class="main">(</span><span class="free">P</span> <span class="main">∖</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> futures <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def after_failures <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Finally, the closure of the futures of a secure process under intransitive purge is proven.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> after_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">⟹</span> secure <span class="main">(</span><span class="free">P</span> <span class="main">∖</span> <span class="free">xs</span><span class="main">)</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def after_futures <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_tr_ref_aux_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">;</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span><span class="main">,</span> ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> after_failures <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> ipurge_tr_ref_aux_failures<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> after_secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> failures_traces<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_tr_ref_aux_failures_general<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">;</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span><span class="main">,</span> ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> ipurge_tr_ref_aux_futures<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Concurrent composition"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In \cite{R6}, the concurrent composition of two processes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, expressed using
notation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P ∥ Q›</span></span></span></span>, is defined as a process whose alphabet is the union of the alphabets of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, so that the shared events requiring the synchronous participation of both
processes are those in the intersection of their alphabets.

In the formalization of Communicating Sequential Processes developed in \cite{R1}, the alphabets of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the data types <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> nested in their respective types
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> process"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'b</span></span> process"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Therefore, for any two maps <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">::</span></span> <span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">q</span></span> <span class="main"><span class="main">::</span></span> <span class="tfree"><span class="tfree">'b</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the concurrent composition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with respect to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, expressed using notation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P ∥ Q &lt;p, q&gt;›</span></span></span></span>, is defined in what follows
as a process of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'c</span></span> process"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where meaningful events are those in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and shared events are those in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∩</span></span> range <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The case where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span>range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> constitutes a generalization of the definition
given in \cite{R6}, and the events in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span>range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, not being mapped to any event
in the alphabets of the input processes, shall be understood as fake events lacking any meaning.
Consistently with this interpretation, such events are allowed to occur in divergent traces only --
necessarily, since divergences are capable by definition of giving rise to any sort of event. As a
result, while in \cite{R6} the refusals associated to non-divergent traces are the union of two
sets, a refusal of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a refusal of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, in the following definition they are the
union of three sets instead, where the third set is any subset of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span>range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Since the definition given in \cite{R6} preserves the identity of the events of the input processes,
a further generalization resulting from the following definition corresponds to the case where
either map <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not injective. However, as shown below, these generalizations
turn out to compromise neither the compliance of the output of concurrent composition with the
characteristic properties of processes as defined in \cite{R1}, nor even the validity of the target
security conservation theorem.

Since divergences can contain fake events, whereas non-divergent traces cannot, it is necessary to
add divergent failures to the failures set explicitly. The following definition of the divergences
set restricts the definition given in \cite{R6}, as it identifies a divergence with an arbitrary
extension of an event sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> being a divergence of both <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, rather
than a divergence of either process and a trace of the other one. This is a reasonable restriction,
in that it requires the concurrent composition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to admit a shared event
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a divergent trace just in case both <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> diverge and can then accept
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, analogously to what is required for a non-divergent trace. Anyway, the definitions match
if the input processes do not diverge, which is the case for any process of practical significance
(cf. \cite{R6}).

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">con_comp_divergences</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'b</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">con_comp_divergences</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">|</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span>
    set <span class="bound">xs</span> <span class="main">⊆</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span>
    map <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
    map <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">con_comp_failures</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'b</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> failure set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">con_comp_failures</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span> <span class="main">∪</span> <span class="bound">Y</span> <span class="main">∪</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="bound">Z</span><span class="main">.</span>
    set <span class="bound">xs</span> <span class="main">⊆</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span>
    <span class="bound">X</span> <span class="main">⊆</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">⊆</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> <span class="bound">Z</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">(</span>range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span><span class="main">,</span> inv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">]</span><span class="main">,</span> inv <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">`</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">}</span> <span class="main">∪</span>
  <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">con_comp</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'b</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> process"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">con_comp</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
  Abs_process <span class="main">(</span>con_comp_failures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> con_comp_divergences <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">con_comp_syntax</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'b</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> process"</span></span>
 <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">∥</span> _ <span class="keyword1">&lt;</span>_<span class="keyword1">,</span> _<span class="keyword1">&gt;</span><span class="keyword3">)</span>"</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">∥</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="main">≡</span> con_comp <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below is the proof that, for any two processes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and any two maps <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, sets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"con_comp_failures <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">Q</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"con_comp_divergences <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">Q</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> enjoy
the characteristic properties of the failures and the divergences sets of a process as defined in
\cite{R1}.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_prop_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_prop_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> range <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> range <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">∨</span>
    <span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_divergences_def<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ws</span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span>
      B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ws</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ws'</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">∧</span>
      set <span class="bound">ws'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">ws'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">ws'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ws'</span><span class="main">.</span> <span class="var">?B</span> <span class="bound">ws'</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> disjI2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> insert <span class="free">x</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_insertI<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Cons
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span><span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">@</span> butlast <span class="skolem">ys</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_append<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">@</span> <span class="bound">ys'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="skolem">ws</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws'</span><span class="main">.</span> <span class="var">?B</span> <span class="bound">ws'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_prop_3<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span><span class="main">;</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X'</span> <span class="skolem">Y'</span> <span class="skolem">Z'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="skolem">X'</span> <span class="main">∪</span> <span class="skolem">Y'</span> <span class="main">∪</span> <span class="skolem">Z'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z'</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z'</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X'</span> <span class="bound">Y'</span> <span class="bound">Z'</span><span class="main">.</span>
    <span class="free">X</span> <span class="main">=</span> <span class="bound">X'</span> <span class="main">∪</span> <span class="bound">Y'</span> <span class="main">∪</span> <span class="bound">Z'</span> <span class="main">∧</span>
    <span class="bound">X'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
    <span class="bound">Y'</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
    <span class="bound">Z'</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
    <span class="bound">Z'</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">X'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∩</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">∩</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z'</span> <span class="main">∩</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">X'</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">∪</span> <span class="skolem">Y'</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">∪</span> <span class="skolem">Z'</span> <span class="main">∩</span> <span class="free">X</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z'</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z'</span> <span class="main">∩</span> <span class="free">X</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">X'</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">X'</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">Y'</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> G <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">Y'</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_prop_4<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span>
    <span class="main">(</span><span class="free">xs</span><span class="main">,</span> insert <span class="free">x</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">∨</span>
    <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">X'</span> <span class="bound">Y'</span> <span class="bound">Z'</span><span class="main">.</span>
      insert <span class="free">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> <span class="bound">X'</span> <span class="main">∪</span> <span class="bound">Y'</span> <span class="main">∪</span> <span class="bound">Z'</span> <span class="main">∧</span>
      <span class="bound">X'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">Y'</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">Z'</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">Z'</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">X'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span><span class="main">)</span> <span class="main">∨</span>
    <span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∨</span> <span class="main">_</span> <span class="main">∨</span> <span class="var">?A</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">∈</span></span> range <span class="free"><span class="free">q</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">∨</span>
      <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span>
      <span class="var">?A</span> <span class="main">∨</span>
      <span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> disj_not1<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>
        I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> failures <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∨</span>
          <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> insert <span class="main">(</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_4<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> insert <span class="free">x</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span>
        I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> failures <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∪</span> insert <span class="free">x</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">Y</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">∨</span>
          <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> insert <span class="main">(</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_4<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> insert <span class="free">x</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">∨</span>
      <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span>
      <span class="var">?A</span> <span class="main">∨</span>
      <span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
     <span class="main">∈</span> failures <span class="free">P</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∨</span>
          <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> insert <span class="main">(</span>inv <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_4<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> insert <span class="free">x</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">∨</span>
      <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span>
      <span class="var">?A</span> <span class="main">∨</span>
      <span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
     <span class="main">∈</span> failures <span class="free">Q</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">with</span></span> E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∪</span> insert <span class="free">x</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">Y</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">∨</span>
          <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> insert <span class="main">(</span>inv <span class="free">q</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_4<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> insert <span class="free">x</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> range <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">Y</span> <span class="main">∪</span> insert <span class="free">x</span> <span class="skolem">Z</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span>
      <span class="var">?A</span> <span class="main">∨</span>
      <span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_prop_5<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span>
    <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_divergences_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">∧</span>
    set <span class="bound">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">∧</span>
    map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A B C<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_prop_6<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_rep<span class="main">:</span>
 <span class="quoted"><span class="quoted">"Rep_process <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span><span class="main">,</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?X</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> con_comp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Abs_process_inverse<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_1 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_prop_1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_2 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_2_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_prop_2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_3 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_3_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_prop_3<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_4 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_4_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_prop_4<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_5 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_5_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_prop_5<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_prop_6 <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_6_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_prop_6<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below, the previous result is applied to derive useful expressions for the outputs of the
functions returning the elements of a process, as defined in \cite{R1} and \cite{R2}, when acting on
the concurrent composition of a pair of processes.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_failures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"failures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def con_comp_rep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_divergences<span class="main">:</span>
 <span class="quoted"><span class="quoted">"divergences <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span> con_comp_divergences <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divergences_def con_comp_rep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
    <span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def con_comp_failures<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"traces <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">=</span> Domain <span class="main">(</span>con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def con_comp_failures<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_refusals<span class="main">:</span>
 <span class="quoted"><span class="quoted">"refusals <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">xs</span> <span class="main">≡</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">``</span> <span class="main">{</span><span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def con_comp_failures<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_next_events<span class="main">:</span>
 <span class="quoted"><span class="quoted">"next_events <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> Domain <span class="main">(</span>con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def con_comp_traces<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, three lemmas are proven. The first one, whose proof makes use of the axiom of
choice, establishes an additional property required for the above definition of concurrent
composition to be correct, namely that for any two processes whose refusals are closed under set
union, their concurrent composition still be such, which is what is expected for any process of
practical significance (cf. \cite{R2}). The other two lemmas are auxiliary properties of concurrent
composition used in the proof of the target security conservation theorem.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_ref_union_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ref_union_closed <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def con_comp_failures con_comp_failures_def
 con_comp_divergences_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_identity_eq <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">A</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span>
    <span class="bound">X</span> <span class="main">=</span> <span class="bound">R</span> <span class="main">∪</span> <span class="bound">S</span> <span class="main">∪</span> <span class="bound">T</span> <span class="main">∧</span>
    set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
    <span class="bound">R</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
    <span class="bound">S</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
    <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
    <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">X</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">X</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">S</span> <span class="bound">T</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bchoice<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">X</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">S</span> <span class="bound">T</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">X</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">s</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">T</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bchoice<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">X</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">T</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">X</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">t</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bchoice<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">X</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> disjE<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> bexE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="skolem">X</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="skolem">X</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="bound">X</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="bound">X</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="bound">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">r</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">s</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UN_E<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UN_E<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">X</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UN_E<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UN_E<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">X</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">t</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>inv <span class="free">p</span> <span class="main">`</span> <span class="bound">X</span> <span class="main">|</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">R'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">R</span> <span class="main">=</span> <span class="skolem">r</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">r</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">R'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">R</span> <span class="skolem">R'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">R</span> <span class="main">=</span> <span class="skolem">r</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="skolem">X</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="bound">x</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> UN_I<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="bound">x</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R'</span> <span class="main">=</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span> <span class="main">∧</span> <span class="bound">R</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="bound">R'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">r</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> image_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>inv <span class="free">q</span> <span class="main">`</span> <span class="bound">X</span> <span class="main">|</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">S'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">s</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">s</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A'</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">S</span> <span class="skolem">S'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">`</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">s</span> <span class="bound">X</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="skolem">X</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">=</span> inv <span class="free">q</span> <span class="bound">x</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> inv <span class="free">q</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> UN_I<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">=</span> inv <span class="free">q</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">=</span> inv <span class="free">q</span> <span class="bound">x</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> inv <span class="free">q</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S'</span> <span class="main">=</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">`</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="bound">S'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">s</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> image_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_failures_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span>
    map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def con_comp_divergences_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span> <span class="skolem">ws</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">ws</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span>
    <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_5_general<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span>
    <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_5_general<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_failures_divergences<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span>
  <span class="free">y</span> <span class="main">∉</span> range <span class="free">p</span> <span class="main">⟹</span>
  <span class="free">y</span> <span class="main">∉</span> range <span class="free">q</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">∧</span>
      set <span class="bound">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def con_comp_divergences_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs'</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="skolem">xs'</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> take <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> take_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">=</span>
    take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_take_drop_id<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> take_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> G<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C D E<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In order to prove that CSP noninterference security is conserved under concurrent composition, the
first issue to be solved is to identify the noninterference policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the event-domain
map <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with respect to which the output process is secure.

If the events of the input processes corresponding to those of the output process contained in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∩</span></span> range <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> were mapped by the respective event-domain maps <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
into distinct security domains, there would be no criterion for determining the domains of the
aforesaid events of the output process, due to the equivalence of the input processes ensuing from
the commutative property of concurrent composition. Therefore, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must map the
events of the input processes into security domains of the same type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'d</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and for each
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∩</span></span> range <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must map the events of the input
processes corresponding to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into the same domain. This requirement is formalized here below
by means of predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>consistent_maps›</span></span></span></span>.

Similarly, if distinct noninterference policies applied to the input processes, there would exist
some ordered pair of security domains included in one of the policies, but not in the other one.
Thus, again, there would be no criterion for determining the inclusion of such a pair of domains in
the policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> applying to the output process. As a result, the input processes are required
to enforce the same noninterference policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, so that for any two domains <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">d</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'d</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the ordered pair comprised of the corresponding security domains for
the output process will be included in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> just in case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">d</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

However, in case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span>range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the event-domain map <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the
output process must assign a security domain to the fake events in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span>range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
as well. Since such events lack any meaning, they may all be mapped to the same security domain,
distinct from the domains of the meaningful events in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. A simple way to
do this is to identify the type of the security domains for the output process with
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'d</span></span> option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then, for any meaningful event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will assign <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to
domain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">d</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the domain of the events of the input processes mapped
to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, whereas <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">D'</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">=</span></span> None"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for any fake event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Such an event-domain map,
denoted using notation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">con_comp_map</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is defined here below.

Therefore, for any two security domains <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the output process,
the above considerations about policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> entail that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>Some <span class="free"><span class="free">d</span></span><span class="main"><span class="main">,</span></span> Some <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">I'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> just in
case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">d</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">e</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Furthermore, since fake events may only occur in divergent traces, which
are extensions of divergences of the input processes comprised of meaningful events, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must
allow the security domain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">None</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of fake events to be affected by any meaningful domain
matching pattern <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Some _›</span></span></span></span>. Such a noninterference policy, denoted using notation
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">con_comp_pol</span></span> <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is defined here below. Observe that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">con_comp_pol</span></span> <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> keeps being
reflexive or transitive if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">con_comp_pol</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> option <span class="main">×</span> <span class="tfree">'d</span> option<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">con_comp_pol</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="main">(</span>Some <span class="bound">d</span><span class="main">,</span> Some <span class="bound">e</span><span class="main">)</span> <span class="main">|</span> <span class="bound">d</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> None<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">con_comp_map</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span>
  <span class="free">con_comp_map</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟹</span>
  <span class="free">con_comp_map</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟹</span>
  <span class="free">con_comp_map</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent_maps</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">consistent_maps</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∩</span> range <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">(</span>inv <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary intransitive purge functions"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a noninterference policy, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> an event-domain map, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a domain set,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> an event list. Suppose to take event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> just in case it satisfies
predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, to append <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the resulting list (matching either <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), and then to compute the intransitive purge of the resulting list with domain set
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If recursion with respect to the input list is added, replacing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the list
produced by the same algorithm using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as input list and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as
domain set, the final result matches that obtained by applying filter <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the intransitive
purge of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with domain set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In fact, in each recursive step, the processed item
of the input list is retained in the output list just in case it passes filter <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and may be
affected neither by the domains in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, nor by the domains of the previous items affected by
some domain in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Here below is the formal definition of such purge function, named <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr_aux_foldr›</span></span></span></span> as its
action resembles that of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ipurge_tr_aux_foldr</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_aux_foldr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr_aux_foldr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> ipurge_tr_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>
   <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
     <span class="free">ipurge_tr_aux_foldr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>sinks_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Likewise, given <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and an event set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
suppose to take <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> just in case it satisfies predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, to append
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux_foldr <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">(</span></span>sinks_aux <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">xs'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the resulting list (matching either
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), and then to compute the intransitive purge of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using the
resulting list as input list and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as domain set. If recursion with respect to the input
list is added, replacing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the set produced by the same algorithm using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as
input list, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as input set, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as domain set, the final
result matches the intransitive purge of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with input list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and domain set
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In fact, each recursive step is such as to remove from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> any event that may be
affected either by the domains in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or by the domains of the items of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> preceding
the processed one which are affected by some domain in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

From the above considerations on function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it follows that the presence
of list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux_foldr <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">(</span></span>sinks_aux <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">xs'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has no impact on the final
result, because none of its items may be affected by the domains in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Here below is the formal definition of such purge function, named <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_ref_aux_foldr›</span></span></span></span>,
which at first glance just seems a uselessly complicate and inefficient way to compute the
intransitive purge of an event set.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ipurge_ref_aux_foldr</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_ref_aux_foldr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> ipurge_ref_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_ref_aux_foldr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> ipurge_ref_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>
   <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
     ipurge_tr_aux_foldr <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>sinks_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
   <span class="main">(</span><span class="free">ipurge_ref_aux_foldr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>sinks_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The reason for the introduction of such intransitive purge functions is that the recursive equations
contained in their definitions, along with lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] ipurge_tr_ref_aux_failures_general<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
enable to prove by induction on list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ys</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, assuming that process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be secure in
addition to further, minor premises, the following implication:

\null

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>inv <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">←</span></span><span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">ys</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> range <span class="free"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> inv <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">`</span></span> <span class="free"><span class="free">Y</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> failures <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">⟶</span></span>
  <span class="main"><span class="main">(</span></span>map <span class="main"><span class="main">(</span></span>inv <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">←</span></span><span class="free"><span class="free">xs</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> range <span class="free"><span class="free">p</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">@</span></span>
   map <span class="main"><span class="main">(</span></span>inv <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ipurge_tr_aux_foldr <span class="main"><span class="main">(</span></span>con_comp_pol <span class="free"><span class="free">I</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>con_comp_map <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>
     <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> range <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">U</span></span> <span class="free"><span class="free">ys</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span>
   inv <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">`</span></span> ipurge_ref_aux_foldr <span class="main"><span class="main">(</span></span>con_comp_pol <span class="free"><span class="free">I</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>con_comp_map <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span>
     <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> range <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">U</span></span> <span class="free"><span class="free">ys</span></span> <span class="free"><span class="free">Y</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> failures <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

\null

In fact, for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ys</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">ys'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the induction hypothesis entails that the consequent holds if
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ys</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are replaced with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ys'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="main"><span class="main">(</span></span>con_comp_pol <span class="free"><span class="free">I</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>con_comp_map <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, respectively. The proof can then
be accomplished by applying lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] ipurge_tr_ref_aux_failures_general<span class="antiquote"><span class="antiquote">}</span></span></span></span> to the
resulting future of trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"map <span class="main"><span class="main">(</span></span>inv <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">←</span></span><span class="free"><span class="free">xs</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> range <span class="free"><span class="free">p</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, moving functions
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into the arguments of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"map <span class="main"><span class="main">(</span></span>inv <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(`)</span></span> <span class="main"><span class="main">(</span></span>inv <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and using the recursive equations contained in the definitions of functions
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_ref_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

This property, along with the match of the outputs of functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_ref_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the filtered intransitive purge of the input event list and the
intransitive purge of the input event set, respectively, permits to solve the main proof obligations
arising from the demonstration of the target security conservation theorem.

Here below is the proof of the equivalence between function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the
filtered intransitive purge of an event list.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_tr_aux_foldr_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟹</span>
  ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">V</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">V</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_union <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">drule</span> Un_absorb2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_tr_aux_foldr_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">U</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="bound">U</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span>
    ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_foldr.simps ipurge_tr_aux_cons
   sinks_aux_single_event if_True if_False<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span>
      ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span> ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_cons True
     <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> con_comp_map.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
          ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span>
        ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span>
          <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_insertI<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
          ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span>
        ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
          <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">x</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span> ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_cons False
     <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> con_comp_map.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span>
        ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span>
        ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below is the proof of the equivalence between function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_ref_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the
intransitive purge of an event set.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_tr_aux_foldr_sinks_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">V</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">V</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">V</span><span class="main">.</span> <span class="free">U</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="bound">V</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="skolem">V</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">v</span></span> <span class="main"><span class="main">∈</span></span> <span class="skolem"><span class="skolem">V</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">D</span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">I</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_cons ipurge_tr_aux_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span> <span class="main">⟶</span>
      sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_insertI2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span><span class="main">)</span>
      <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?ys</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?zs</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">V</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">with</span></span> E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">V</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span>
        <span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span>
        <span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?ys</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?zs</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span> <span class="main">⟶</span>
      sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_insertI2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_insertI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span>
      <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">V</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?ys</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?zs</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="var">?ys</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="var">?zs</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_tr_aux_foldr_ref_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">V</span> <span class="free">xs</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span>
    ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[]</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_def ipurge_tr_aux_foldr_sinks_aux <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_ref_aux_foldr_subset <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">⟶</span>
  ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span> <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">V</span> <span class="free">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
    ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">V</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">V</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">U</span> <span class="skolem">V</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span> <span class="bound">U</span> <span class="bound">V</span><span class="main">.</span>
      sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="bound">ys</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">⟶</span>
      ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="bound">ys</span> <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="bound">V</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
        ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="bound">V</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">⊆</span> <span class="skolem">V</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
    ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">(</span>ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_foldr_ref_aux <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⟶</span>
        ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span>
          <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
        ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟶</span> <span class="var">?us</span> <span class="main">=</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?us</span> <span class="main">=</span> <span class="var">?vs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="var">?us</span> <span class="main">=</span> <span class="var">?us</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⟶</span>
          ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span>
            <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
          ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="var">?T</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sinks_aux_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sinks_aux_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">(</span>ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_foldr_ref_aux <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[]</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⟶</span>
        ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[]</span>
          <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
        ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟶</span> <span class="var">?us</span> <span class="main">=</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?us</span> <span class="main">=</span> <span class="var">?vs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="var">?us</span> <span class="main">=</span> <span class="var">?us</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⟶</span>
          ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span>
            <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
          ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="var">?T</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">V</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_ref_aux_foldr_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="free">X</span> <span class="main">=</span> ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="free">U</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">U</span><span class="main">.</span> ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="skolem">xs</span> <span class="free">X</span> <span class="main">=</span> ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="bound">U</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span>
    ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
      ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?xs'</span> <span class="var">?X'</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_ref_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span> <span class="var">?X'</span> <span class="main">=</span> <span class="var">?X'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_foldr_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="var">?xs'</span> <span class="var">?X'</span> <span class="main">=</span> <span class="var">?X'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span> <span class="main">=</span>
      ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="var">?xs'</span> <span class="var">?X'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span> <span class="main">=</span>
        ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sinks_aux_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
      ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[]</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?xs'</span> <span class="var">?X'</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_ref_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[]</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sinks_aux_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[]</span> <span class="var">?X'</span> <span class="main">=</span> <span class="var">?X'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_foldr_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="var">?xs'</span> <span class="var">?X'</span> <span class="main">=</span> <span class="var">?X'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span> <span class="main">=</span>
      ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="var">?xs'</span> <span class="var">?X'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span> <span class="main">=</span>
        ipurge_ref_aux_foldr <span class="free">I</span> <span class="free">D</span> <span class="free">P</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">X</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Finally, here below is the proof of the implication involving functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_tr_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ipurge_ref_aux_foldr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> discussed above.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_sinks_aux_range<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> range Some"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">⊆</span> range Some"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="main">_</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> sinks_aux_elem<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> bexE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range Some"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> range Some"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="var">?D'</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range Some"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_sinks_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> range Some"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">⟶</span>
    sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    the <span class="main">`</span> sinks_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">_</span> <span class="main">=</span> the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">⟶</span>
    sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
    the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
    the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="skolem">u</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="skolem">u</span> <span class="main">∈</span> the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">=</span> the <span class="bound">u</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> the <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">⊆</span> range Some"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux_range<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range Some"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">d</span><span class="main">,</span> Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_ipurge_tr_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> range Some"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">⟶</span>
    ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">_</span> <span class="main">=</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">⟶</span>
    ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="skolem">u</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="skolem">u</span> <span class="main">∈</span> the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
      the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
        the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">=</span> the <span class="bound">u</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> the <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span> <span class="main">⊆</span> range Some"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux_range<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range Some"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">d</span><span class="main">,</span> Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_ipurge_ref_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> range Some"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span>
    inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">U</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_aux_def set_eq_iff image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D E<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
    <span class="keyword3"><span class="command">assume</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
      the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="skolem">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">⊆</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux_range<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="bound">d</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">=</span> inv <span class="free">p</span> <span class="bound">x</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
      the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> the <span class="main">`</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">=</span> the <span class="bound">u</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> the <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">⊆</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_aux_range<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_sinks_filter<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sinks <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span> <span class="main">=</span>
  sinks <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∩</span> range Some"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span> <span class="main">=</span>
    sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">∩</span> range Some"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sinks <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?xs'</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span> <span class="main">=</span>
    sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> range Some"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Un_iff sinks.simps<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span>
      B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">∩</span> range Some<span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>range Some<span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>range Some<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>range Some<span class="main">)</span> <span class="main">=</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> insert_absorb<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> C <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bex_simps<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="bound">d</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> Some <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range Some"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">∩</span> range Some"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> range Some <span class="main">=</span>
      sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> range Some <span class="main">=</span>
      sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span> <span class="main">=</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_ipurge_tr_filter<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span> <span class="main">=</span>
  ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span> <span class="main">=</span>
    ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?xs'</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span> <span class="main">=</span>
    ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Un_iff ipurge_tr.simps<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span>
      B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> con_comp_sinks_filter<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∉</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∉</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> con_comp_sinks_filter<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∉</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="var">?xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="var">?xs'</span> <span class="main">=</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_ipurge_ref_filter<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span> <span class="free">X</span> <span class="main">=</span>
  ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def con_comp_sinks_filter set_eq_iff <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Un_iff<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∩</span> range Some<span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>None<span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff con_comp_pol_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">∩</span> range Some"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">⟶</span> <span class="free">U</span> <span class="main">⊆</span> range Some <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="free">U</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="free">U</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">U</span> <span class="main">[]</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y'</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">p</span> <span class="main">`</span> <span class="var">?Y'</span> <span class="main">⊆</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">xs</span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">U</span><span class="main">.</span> set <span class="skolem">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">⟶</span> <span class="bound">U</span> <span class="main">⊆</span> range Some <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="bound">U</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="bound">U</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">⟶</span>
    sinks_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">⊆</span> range Some <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">(</span>sinks_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="skolem">U</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">(</span>sinks_aux <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="skolem">U</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">_</span> <span class="main">⟶</span> <span class="main">_</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">_</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U'</span> <span class="main">⊆</span> range Some <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> range Some"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U'</span> <span class="main">⊆</span> range Some"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_single_event<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">y</span> <span class="main">∈</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
       ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
       ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
       ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_ref_aux_failures_general<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
      ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
      ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_ipurge_tr_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
    D ipurge_tr_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
      ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span>
    inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span>
      ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span>
      <span class="main">(</span>ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_ipurge_ref_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
   D ipurge_tr_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ipurge_ref_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?U'</span> <span class="skolem">ys</span> <span class="free">Y</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
     map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Conservation of noninterference security under concurrent composition"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Everything is now ready for proving the target security conservation theorem. It states that for any
two processes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> being secure with respect to the noninterference policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and the event-domain maps <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, their concurrent composition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">∥</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">&lt;</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">&gt;</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is secure with respect to the noninterference policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"con_comp_pol <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the event-domain
map <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"con_comp_map <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, provided that condition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
satisfied.

The only assumption, in addition to the security of the input processes, is the consistency of the
respective event-domain maps. Particularly, this assumption permits to solve the proof obligations
concerning the latter input process by just swapping <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"con_comp_map <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and then applying the corresponding lemmas
proven for the former input process.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_del_aux_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 ipurge_tr_aux_single_dom <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ipurge_ref_aux_single_dom <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
 ipurge_tr_aux_foldr_eq ipurge_ref_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
    inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="main">_</span> <span class="main">_</span> <span class="var">?F</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_aux <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A D C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
    map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
    inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">#</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span> <span class="main">#</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
         <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
         <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_dom ipurge_ref_aux_single_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_ipurge_tr_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
      ipurge_tr_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
        <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_ipurge_ref_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     ipurge_tr_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ipurge_ref_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_subset<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
         <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
         <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span>
         <span class="main">(</span>ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
        <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span>
        <span class="main">(</span>ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span>
      ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_foldr_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ipurge_tr_aux_foldr_sinks_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
       inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_add_aux_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">zs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
       <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span>
     inv <span class="free">p</span> <span class="main">`</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
   ipurge_tr_aux_single_dom <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ipurge_ref_aux_single_dom <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
   ipurge_tr_aux_foldr_eq ipurge_ref_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">,</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>
        <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="main">_</span> <span class="main">_</span> <span class="var">?F</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_aux <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A D C<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> range Some"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">,</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span><span class="var">?D'</span> <span class="free">y</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>
        <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
        map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">,</span>
        inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>
        <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">,</span>
         inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
         ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
           <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
         ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
           <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_dom ipurge_ref_aux_single_dom<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
          <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
          <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_ipurge_tr_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        ipurge_tr_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>the <span class="main">`</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
          <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span>
        inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
          <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span>
          <span class="main">(</span>ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_ipurge_ref_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
       ipurge_tr_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ipurge_ref_aux_foldr_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_subset<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span> <span class="main">#</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
           <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
         inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
           <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span>
           <span class="main">(</span>ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
          <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_aux_foldr_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"ipurge_ref_aux <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
          <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span>
          <span class="main">(</span>ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span>
        ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_aux_foldr_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> ipurge_tr_aux_foldr_sinks_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span> <span class="main">#</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span>
           <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">,</span>
         inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span>
           <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="free">P</span> <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span> inv <span class="free">p</span> <span class="free">y</span> <span class="main">#</span>
        map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">(</span>ipurge_tr_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span><span class="main">)</span><span class="main">,</span>
        inv <span class="free">p</span> <span class="main">`</span> ipurge_ref_aux_foldr <span class="var">?I'</span> <span class="var">?D'</span> <span class="var">?F</span> <span class="main">{</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span>
        <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_consistent_maps<span class="main">:</span>
 <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> con_comp_map <span class="free">E</span> <span class="free">D</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consistent_maps_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∩</span> range <span class="free">q</span><span class="main">.</span> <span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">E</span> <span class="main">(</span>inv <span class="free">q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="skolem">x</span> <span class="main">=</span> con_comp_map <span class="free">E</span> <span class="free">D</span> <span class="free">q</span> <span class="free">p</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_map.cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">D</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">E</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">D'</span> <span class="skolem">E'</span> <span class="skolem">x'</span>
    <span class="keyword3"><span class="command">assume</span></span>
      B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="skolem">E'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> range <span class="skolem">p'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="skolem">D'</span> <span class="main">(</span>inv <span class="skolem">p'</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> con_comp_map <span class="skolem">E'</span> <span class="skolem">D'</span> <span class="skolem">q'</span> <span class="skolem">p'</span> <span class="skolem">x'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> range <span class="skolem">q'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> range <span class="skolem">p'</span> <span class="main">∩</span> range <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∩</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> <span class="free">E</span> <span class="main">(</span>inv <span class="free">q</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">(</span>inv <span class="skolem">p'</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">E'</span> <span class="main">(</span>inv <span class="skolem">q'</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_del_aux_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span> <span class="main">⟹</span>
    <span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span> <span class="main">⟹</span>
    set <span class="free">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">⟹</span>
    <span class="free">Y</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">⟹</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">⟹</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span>
       inv <span class="free">q</span> <span class="main">`</span> ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> con_comp_consistent_maps <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> con_comp_secure_del_aux_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_add_aux_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span> <span class="main">⟹</span>
    <span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span> <span class="main">⟹</span>
    set <span class="free">zs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">⟹</span>
    <span class="free">Z</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">⟹</span>
    <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">⟹</span>
    map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span> <span class="main">⟹</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span>
       inv <span class="free">q</span> <span class="main">`</span> ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> con_comp_consistent_maps <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> con_comp_secure_add_aux_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_del_case_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span>
      <span class="free">Y</span> <span class="main">=</span> <span class="bound">R</span> <span class="main">∪</span> <span class="bound">S</span> <span class="main">∪</span> <span class="bound">T</span> <span class="main">∧</span>
      <span class="main">(</span><span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">∧</span>
      set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      set <span class="free">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">R</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">S</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span>
      ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">R</span> <span class="main">∪</span> <span class="bound">S</span> <span class="main">∪</span> <span class="bound">T</span> <span class="main">∧</span>
      set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>                     
      set <span class="main">(</span>ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">R</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">S</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">∃</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">S</span> <span class="skolem">T</span>
  <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">∪</span> <span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span> <span class="main">=</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="main">(</span><span class="skolem">R</span> <span class="main">∪</span> <span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span> <span class="main">=</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">R</span> <span class="main">∪</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">S</span> <span class="main">∪</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">T</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_distrib_union<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_empty <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?D'</span></span> <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> E<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> K <span class="keyword2"><span class="keyword">and</span></span> N <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> K <span class="keyword2"><span class="keyword">and</span></span> N <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="free">E</span> <span class="main">(</span>inv <span class="free">q</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span> <span class="main">=</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">R</span> <span class="main">∪</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_set<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">R</span> <span class="main">⊆</span> <span class="skolem">R</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">R</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">S</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">S</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_del_aux_1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B E G H L<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span>
      inv <span class="free">q</span> <span class="main">`</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_del_aux_2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C E G I M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_del_case_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">∧</span>
      set <span class="bound">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span>
      ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span> <span class="main">=</span> <span class="bound">R</span> <span class="main">∪</span> <span class="bound">S</span> <span class="main">∪</span> <span class="bound">T</span> <span class="main">∧</span>
      set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      set <span class="main">(</span>ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">R</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">S</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">∧</span>
      set <span class="bound">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?G</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&lt;</span> length <span class="skolem">xs'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> disjI2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> take <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> take_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> take <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span> <span class="main">=</span> <span class="skolem">xs'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="skolem">xs'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> D <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="skolem">xs'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_del_case_1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"range <span class="free">p</span> <span class="main">∩</span> <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"range <span class="free">q</span> <span class="main">∩</span> <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> range <span class="free">p</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">∪</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Y</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">}</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
        map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>drop <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span>
        <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_5_general<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">)</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_filter<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span>range <span class="free">p</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span>
        map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>drop <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span>
        <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_5_general<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="var">?vs</span><span class="main">)</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_filter<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span>range <span class="free">q</span> <span class="main">∩</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">R</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> con_comp_ipurge_tr_filter con_comp_ipurge_ref_filter<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span>
      <span class="var"><span class="quoted"><span class="var">?I'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"con_comp_pol <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?D'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span>
      drop <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_take_drop_id<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D E F<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_add_case_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span>
      <span class="free">Z</span> <span class="main">=</span> <span class="bound">R</span> <span class="main">∪</span> <span class="bound">S</span> <span class="main">∪</span> <span class="bound">T</span> <span class="main">∧</span>
      set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      set <span class="free">zs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">R</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">S</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span>
      ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span> <span class="main">=</span> <span class="bound">R</span> <span class="main">∪</span> <span class="bound">S</span> <span class="main">∪</span> <span class="bound">T</span> <span class="main">∧</span>
      set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      set <span class="main">(</span>ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">R</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">S</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span>
       inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span>
       inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">∃</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">S</span> <span class="skolem">T</span>
  <span class="keyword3"><span class="command">assume</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">∪</span> <span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    H<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">zs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span> <span class="main">=</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">(</span><span class="skolem">R</span> <span class="main">∪</span> <span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span> <span class="main">=</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">R</span> <span class="main">∪</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">S</span> <span class="main">∪</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">T</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_distrib_union<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_empty <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?D'</span></span> <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> E<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> K <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> L <span class="keyword2"><span class="keyword">and</span></span> O <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="free">D</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> K <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> L <span class="keyword2"><span class="keyword">and</span></span> O <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="free">E</span> <span class="main">(</span>inv <span class="free">q</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span> <span class="main">=</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">R</span> <span class="main">∪</span>
      ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_tr_set<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">R</span> <span class="main">⊆</span> <span class="skolem">R</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">R</span> <span class="main">⊆</span> range <span class="free">p</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">S</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">S</span> <span class="main">⊆</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span>
      inv <span class="free">p</span> <span class="main">`</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_add_aux_1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B E H I M<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span>
      inv <span class="free">q</span> <span class="main">`</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_add_aux_2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C E H J N<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_secure_add_case_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">∧</span>
      set <span class="bound">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span>
      ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span> <span class="main">=</span> <span class="bound">R</span> <span class="main">∪</span> <span class="bound">S</span> <span class="main">∪</span> <span class="bound">T</span> <span class="main">∧</span>
      set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      set <span class="main">(</span>ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">R</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">S</span> <span class="main">⊆</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∧</span>
      <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span>
       inv <span class="free">p</span> <span class="main">`</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
      <span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span>
       inv <span class="free">q</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">∧</span>
      set <span class="bound">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span> <span class="main">∧</span>
      map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?G</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs'</span> <span class="skolem">ys'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs'</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    H<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&lt;</span> length <span class="skolem">xs'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> disjI2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> take <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">xs</span> <span class="main">@</span> take <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">ys'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span> <span class="main">=</span> <span class="skolem">xs'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="skolem">xs'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_secure_add_case_1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C D E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"range <span class="free">p</span> <span class="main">∩</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"range <span class="free">q</span> <span class="main">∩</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">subst</span> conj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">=</span> range <span class="free">p</span> <span class="main">∩</span> <span class="free">Z</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Z</span> <span class="main">∪</span> <span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Z</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">}</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">p</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> range <span class="free">p</span> <span class="main">∩</span> <span class="main">-</span> range <span class="free">q</span> <span class="main">∩</span> <span class="free">Z</span> <span class="main">⊆</span> <span class="main">-</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">@</span>
        map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>drop <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span>
        <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_5_general<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span><span class="main">)</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_filter<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span><span class="main">]</span><span class="main">,</span> inv <span class="free">p</span> <span class="main">`</span> <span class="main">(</span>range <span class="free">p</span> <span class="main">∩</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">@</span>
        map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>drop <span class="main">(</span>length <span class="skolem">xs'</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span>
        <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">@</span> map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_5_general<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="var">?vs</span><span class="main">)</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span> <span class="main">∈</span> divergences <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_filter<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>inv <span class="free">q</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">.</span>
        <span class="bound">x</span> <span class="main">∈</span> range <span class="free">q</span><span class="main">]</span><span class="main">,</span> inv <span class="free">q</span> <span class="main">`</span> <span class="main">(</span>range <span class="free">q</span> <span class="main">∩</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">Q</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_6<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">R</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">R</span> <span class="bound">S</span> <span class="bound">T</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> con_comp_ipurge_tr_filter con_comp_ipurge_ref_filter<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span>
      <span class="var"><span class="quoted"><span class="var">?I'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"con_comp_pol <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?D'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span> <span class="main">@</span>
      drop <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_take_drop_id<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="var">?vs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> J<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F G H<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> con_comp_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"secure <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def con_comp_futures<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> rev_mp<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">Y</span> <span class="skolem">zs</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span>
       ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="skolem">Y</span><span class="main">)</span>
      <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">_</span> <span class="main">@</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def con_comp_divergences_def
   <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> con_comp_secure_del_case_1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule</span> con_comp_secure_del_case_2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">Y</span> <span class="skolem">zs</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span>
       ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>
         <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">Z</span><span class="main">)</span>
      <span class="main">∈</span> con_comp_failures <span class="free">P</span> <span class="free">Q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">_</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_failures_def con_comp_divergences_def
   <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter_append<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> disjI2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> con_comp_secure_add_case_1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule</span> con_comp_secure_add_case_2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule</span> con_comp_failures_divergences <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Conservation of noninterference security in the absence of fake events"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In what follows, it is proven that in the absence of fake events, namely if
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span> <span class="main"><span class="main">=</span></span> UNIV"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the output of the concurrent composition of two secure processes
is secure with respect to the same noninterference policy enforced by the input processes, and to
the event-domain map that simply associates each event to the same security domain as the
corresponding events of the input processes.

More formally, for any two processes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> being secure with respect to the
noninterference policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the event-domain maps <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, their concurrent
composition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">∥</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">&lt;</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">q</span></span><span class="main"><span class="main">&gt;</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is secure with respect to the same noninterference policy
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the event-domain map <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"the <span class="main"><span class="main">∘</span></span> con_comp_map <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, provided that conditions
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"range <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∪</span></span> range <span class="free"><span class="free">q</span></span> <span class="main"><span class="main">=</span></span> UNIV"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">E</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are satisfied.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_sinks_range<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range Some <span class="main">⟹</span>
  set <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">⟹</span>
    sinks <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">⊆</span> range Some"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> con_comp_sinks_aux_range <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">u</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_single_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_sinks_no_fake<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range Some"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
    the <span class="main">`</span> sinks <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> the <span class="main">`</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> the <span class="main">`</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="free">u</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> the <span class="main">`</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="free">u</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">d</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE <span class="main"><span class="main">[</span></span><span class="operator">OF</span> True<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> disjI2<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span>the <span class="free">u</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="free">u</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">⊆</span> range Some"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A B<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range Some"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="skolem">v</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span>the <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="skolem">v</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span>
        <span class="main">(</span><span class="bound">d</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span>the <span class="free">u</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span>the <span class="free">u</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="free">u</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> the <span class="main">`</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">=</span> the <span class="bound">v</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> the <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">⊆</span> range Some"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A B<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range Some"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="skolem">d</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_ipurge_tr_no_fake<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range Some"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span>
    ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> the <span class="main">`</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> con_comp_sinks_no_fake <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> the <span class="main">`</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> the <span class="main">`</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> the <span class="bound">v</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> the <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="bound">d</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> range Some"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A B<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range Some"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d'</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="bound">d'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> con_comp_sinks_no_fake <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> con_comp_ipurge_ref_no_fake<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> range Some"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="main">(</span>con_comp_pol <span class="free">I</span><span class="main">)</span> <span class="main">(</span>con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="free">u</span> <span class="free">xs</span> <span class="free">X</span> <span class="main">=</span>
    ipurge_ref <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>the <span class="free">u</span><span class="main">)</span> <span class="free">xs</span> <span class="free">X</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_sinks_no_fake <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="free">u</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> con_comp_pol <span class="free">I</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> con_comp_pol <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span>the <span class="free">u</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span>the <span class="bound">v</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>4<span class="main"><span class="improper">]</span></span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span>the <span class="free">u</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="free">u</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">⊆</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A B<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="skolem">v</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span>the <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="skolem">v</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="free">u</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span>the <span class="free">u</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span>the <span class="bound">v</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="skolem">v</span><span class="main">,</span> the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span>the <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> Some <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_pol_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="var">?I'</span> <span class="var">?D'</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">⊆</span> range Some"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> con_comp_sinks_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A B<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range Some"</span></span>
     <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Some <span class="main">(</span>the <span class="skolem">v</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="var">?D'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?I'</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> con_comp_secure_no_fake<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent_maps <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">Q</span> <span class="free">I</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"secure <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> con_comp_secure <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B C D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">Y</span> <span class="skolem">zs</span> <span class="skolem">Z</span>
  <span class="keyword1"><span class="command">let</span></span>
    <span class="var"><span class="quoted"><span class="var">?I'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"con_comp_pol <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="var"><span class="quoted"><span class="var">?D'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"con_comp_map <span class="free">D</span> <span class="free">E</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span> <span class="main">∪</span> range <span class="free">q</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="skolem">y</span> <span class="main">∈</span> range Some"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span> <span class="bound">Y</span> <span class="bound">zs</span> <span class="bound">Z</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">⟶</span>
      <span class="main">(</span>ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">ys</span><span class="main">,</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">ys</span> <span class="bound">Y</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">∧</span>
      <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">zs</span><span class="main">,</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">zs</span> <span class="bound">Z</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="bound">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="skolem">Y</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> ipurge_tr <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="var">?I'</span> <span class="var">?D'</span> <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">Z</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span>
      ipurge_ref <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span>
      ipurge_ref <span class="free">I</span> <span class="main">(</span>the <span class="main">∘</span> <span class="var">?D'</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?D'</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span><span class="free">P</span> <span class="main">∥</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">&gt;</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> con_comp_ipurge_tr_no_fake <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A E<span class="main"><span class="main">]</span></span>
    con_comp_ipurge_ref_no_fake <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A E<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>