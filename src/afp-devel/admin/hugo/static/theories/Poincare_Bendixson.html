<div id="Analysis_Misc">
<div class="head">
<h1>Theory Analysis_Misc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additions to HOL-Analysis›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Analysis_Misc
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../Ordinary_Differential_Equations/ODE_Analysis.html">Ordinary_Differential_Equations.ODE_Analysis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unsorted Lemmas (TODO: sort!)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_uminus_image<span class="main">:</span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> uminus <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'r</span><span class="main">::</span>ab_group_add set"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_uminus_image_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> uminus <span class="main">`</span> <span class="free">S</span> <span class="main">⟷</span> <span class="main">-</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'r</span><span class="main">::</span>ab_group_add set"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_subsegmentI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">+</span> <span class="free">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">z</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    w_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span> <span class="main">+</span> <span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">+</span> <span class="free">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">z</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">-</span> <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">-</span> <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> w_def z_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_image_interval
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> t u v
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> diff_0_right diff_left_mono linear mult_left_le_one_le mult_nonneg_nonpos order.trans<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult_left_le_one_le mult_nonneg_nonneg vector_space_over_itself.scale_right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_minus_cancel_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="free">F</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">g</span> <span class="main">⤏</span> <span class="main">-</span><span class="free">l</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="comment1">― ‹cf <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> tendsto_minus_cancel_left<span class="antiquote">}</span></span>›</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>topological_group_add"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tendsto_minus_cancel_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_nhds_continuousI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>nhds <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="comment1">― ‹TODO: the assumption is continuity of f at x›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> topological_tendstoI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> topological_tendstoD<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> nhds <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_composeD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">t</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compact_sequentialE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="free">T</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>first_countable_topology set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Heine_Borel_imp_Bolzano_Weierstrass<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">islimpt</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⇢</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">unfolding</span></span> islimpt_sequential
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_countable_subsetE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"range <span class="free">g</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_countable_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> real_quad_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">an</span> <span class="main">*</span> <span class="free">bn</span><span class="main">)</span> <span class="main">≤</span> <span class="free">an</span> <span class="main">*</span> <span class="free">an</span> <span class="main">+</span> <span class="free">bn</span> <span class="main">*</span> <span class="free">bn</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">an</span> <span class="free">bn</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"(((A&lt;0 * R&lt;1) + (R&lt;1 * (R&lt;1 * [an + ~1*bn]^2))))"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_quad_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span><span class="comment1">― ‹generalize?›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> euclidean_inner<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_distrib_left <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono real_quad_ge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inner_quad_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span><span class="comment1">― ‹generalize?›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> Basis"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∙</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∙</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> euclidean_eq_iff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">∙</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∙</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∙</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">∙</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_sqs_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∙</span><span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∙</span><span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_neq_trans real_quad_ge<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> euclidean_inner<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> Basis›</span></span> sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_distrib_left
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_strict_mono_ex1 real_quad_ge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_segment_line_hyperplanes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="free">a</span> <span class="main">+</span> <span class="bound">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_segment <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="free">a</span> <span class="main">+</span> <span class="bound">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inner_quad_ge<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_le_0_iff u<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_eq <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square inner_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner_ge_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">]</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_le_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_segment_line_hyperplanes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="free">a</span> <span class="main">+</span> <span class="bound">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_segment <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="free">a</span> <span class="main">+</span> <span class="bound">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inner_quad_gt<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">∙</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_less_0_iff u<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_eq <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square inner_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">u</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner_ge_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span><span class="main">]</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment <span class="dynamic"><span class="dynamic">algebra_simps</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> at_within_interior<span class="main">:</span> <span class="quoted"><span class="quoted">"NO_MATCH UNIV <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> interior <span class="free">S</span> <span class="main">⟹</span> <span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">S</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> at_within_interior<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_at_topI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> at_top"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x0</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="bound">x0</span><span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="bound">e</span>"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder_topology <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> tendstoI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_top_linorder
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_at_topE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder_topology <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x0</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">x0</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> tendstoD<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top<span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_top_linorder
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> tendsto_at_top_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> at_top <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">e</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x0</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="bound">x0</span><span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder_topology <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_at_topI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_at_topE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_at_top_eq_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder_topology <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">x0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tendsto_at_top_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> linear order_trans tendsto_at_topE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lim_divide_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">e</span> <span class="main">/</span> real <span class="bound">x</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">e</span> <span class="main">*</span> inverse <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> lim_inverse_n<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_eq_divide<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">at_top_within</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> filter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">at_top_within</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> principal <span class="main">(</span><span class="main">{</span><span class="bound">k</span> <span class="main">..}</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> "</span></span>

<span class="keyword1"><span class="command">lemma</span></span> at_top_within_at_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"at_top_within UNIV <span class="main">=</span> at_top"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def at_top_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> at_top_within_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"at_top_within <span class="main">{}</span> <span class="main">=</span> top"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nhds_set</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">S</span><span class="main">∈</span><span class="main">{</span><span class="bound">S</span><span class="main">.</span> open <span class="bound">S</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⊆</span> <span class="bound">S</span><span class="main">}</span><span class="main">.</span> principal <span class="bound">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_nhds_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> nhds_set <span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> open <span class="bound">S</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">⊆</span> <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nhds_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eventually_INF_base<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_principal<span class="main">)</span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">f</span> <span class="main">(</span>nhds_set <span class="main">(</span>frontier <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">F</span>"</span></span> <span class="comment1">― ‹f tends to the boundary of X?›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹somewhat inspired by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> islimpt_range_imp_convergent_subsequence<span class="antiquote"><span class="antiquote">}</span></span></span></span> and its dependencies.
The class constraints seem somewhat arbitrary, perhaps this can be generalized in some way.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> limpt_closed_imp_exploding_subsequence<span class="main">:</span><span class="comment1">―‹TODO: improve name?!›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>heine_borel<span class="main">,</span>real_normed_vector<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>first_countable_topology<span class="main">,</span> t2_space<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">[</span><span class="operator">THEN</span> continuous_on_compose2<span class="main">,</span> <span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">T</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> limpt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="keyword1">islimpt</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">s</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> compact <span class="bound">C</span> <span class="main">⟹</span> <span class="bound">C</span> <span class="main">⊆</span> <span class="free">T</span> <span class="main">⟹</span> <span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">i</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="free">s</span> <span class="bound">i</span> <span class="main">∉</span> <span class="bound">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> countable_basis_at_decseq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> open <span class="main">(</span><span class="skolem">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">l</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> evA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> open <span class="bound">S</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">⟹</span> eventually <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="bound">S</span><span class="main">)</span> sequentially"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> closed_Union_compact_subsets<span class="main">[</span><span class="operator">OF</span> closed<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> compact <span class="main">(</span><span class="skolem">C</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">n</span> <span class="main">⊆</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">n</span> <span class="main">⊆</span> <span class="skolem">C</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>range <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> evC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> compact <span class="bound">K</span> <span class="main">⟹</span> <span class="bound">K</span> <span class="main">⊆</span> <span class="free">T</span> <span class="main">⟹</span> <span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">i</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="bound">K</span> <span class="main">⊆</span> <span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eventually_sequentially<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> AC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="main">(</span><span class="skolem">A</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> C bound
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_Diff A compact_imp_closed compact_continuous_image <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">from</span></span> islimptE<span class="main">[</span><span class="operator">OF</span> limpt AC<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> topological_tendstoI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evA <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">i</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="skolem">t</span> <span class="bound">i</span> <span class="main">∉</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"compact <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">K</span>
    <span class="keyword1"><span class="command">using</span></span> evC<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">use</span> t <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> Inf_islimpt<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_below <span class="free">S</span> <span class="main">⟹</span> Inf <span class="free">S</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> Inf <span class="free">S</span> <span class="keyword1">islimpt</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> islimpt_in_closure <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> closure_contains_Inf<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> linorder
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹HOL-analysis doesn't seem to have these, maybe they were never needed.
  Some variants are around <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> Int_atLeastAtMost<span class="antiquote"><span class="antiquote">}</span></span></span></span>, but with old-style naming conventions.
  Change to the "modern" I.. convention there?›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Int_Ico<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">b</span><span class="main">..}</span> <span class="main">=</span> <span class="main">{</span>max <span class="free">a</span> <span class="free">b</span> <span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Int_Ici_Ico<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">b</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>max <span class="free">a</span> <span class="free">b</span> <span class="main">..&lt;</span><span class="free">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Int_Ico_Ici<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">b</span><span class="main">..}</span> <span class="main">=</span> <span class="main">{</span>max <span class="free">a</span> <span class="free">b</span> <span class="main">..&lt;</span><span class="free">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_Ico_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">c</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atLeastLessThan_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Ico_subset_Ioo_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">c</span><span class="main">&lt;..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∨</span> <span class="free">c</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> greaterThanLessThan_def atLeastLessThan_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Icc_Un_Ici<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">..}</span> <span class="main">=</span> <span class="main">{</span>min <span class="free">a</span> <span class="free">b</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atLeastAtMost_def atLeast_def atMost_def min_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> at_top_within_at_top_unbounded_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"at_top_within <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">=</span> at_top"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def at_top_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linorder_class.linear linorder_class.max.cobounded1 linorder_class.max.idem ord_class.atLeast_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> at_top_within_at_top_unbounded_rightI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"at_top_within <span class="free">s</span> <span class="main">=</span> at_top"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def at_top_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> Ici_subset_Ioi_iff Ioi_le_Ico assms dual_order.refl dual_order.trans leI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms atLeast_iff atLeast_subset_iff inf.cobounded1 linear subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> at_top_within_at_top_bounded_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>dense_order<span class="main">,</span>linorder_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"at_top_within <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> at_left <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def at_left_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff greaterThanLessThan_iff le_less lessThan_iff max.absorb1 subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms atLeastLessThan_iff dense linear max.absorb1 not_less order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> at_top_within_at_top_bounded_right'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>dense_order<span class="main">,</span>linorder_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"at_top_within <span class="main">{..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> at_left <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def at_left_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> INF_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> atLeast_iff greaterThanLessThan_iff le_less lessThan_iff subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ico_subset_Ioo_iff atLeastLessThan_def dense lessThan_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_at_top_within_linorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sn<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eventually <span class="free">P</span> <span class="main">(</span>at_top_within <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder_topology<span class="main">}</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="bound">x0</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eventually_INF_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>eventually_principal sn<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast_subset_iff inf.coboundedI2 inf_commute linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_at_top_withinI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder_topology <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x0</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x0</span><span class="main">..}</span> <span class="main">∩</span> <span class="free">s</span><span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>at_top_within <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> tendstoI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> at_top_within_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eventually_INF_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>eventually_principal assms<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast_subset_iff inf.coboundedI2 inf_commute linear<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_at_top_withinE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder_topology <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>at_top_within <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x0</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x0</span><span class="main">..}</span> <span class="main">∩</span> <span class="free">s</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> tendstoD<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top_within <span class="free">s</span><span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_top_within_linorder<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_at_top_within_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder_topology <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>at_top_within <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">e</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x0</span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x0</span><span class="main">..}</span> <span class="main">∩</span> <span class="free">s</span><span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_at_top_withinI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_at_top_withinE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filterlim_at_top_at_top_within_bounded_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>dense_order<span class="main">,</span>linorder_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">f</span> at_top <span class="main">(</span>at_top_within <span class="main">{..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="main">∞</span><span class="main">)</span> <span class="main">(</span>at_left <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filterlim_at_top_dense
    at_top_within_at_top_bounded_right'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    eventually_at_left<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    tendsto_PInfty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extract a sequence (going to infinity) bounded away from l›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_tendsto_frequentlyE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">S</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tendsto_def not_eventually<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_tendsto_frequently_metricE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">F</span><span class="main">.</span> <span class="free">e</span> <span class="main">≤</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tendsto_iff not_eventually not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_frequently_conj<span class="main">:</span> <span class="quoted"><span class="quoted">"frequently <span class="free">P</span> <span class="free">F</span> <span class="main">⟹</span> eventually <span class="free">Q</span> <span class="free">F</span> <span class="main">⟹</span> frequently <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frequently_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> contrapos_nn<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> frequently_at_top<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t0</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="bound">t0</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">,</span>no_top<span class="main">}</span><span class="main">⇒</span>bool"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frequently_def eventually_at_top_dense<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> frequently_at_topE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">,</span>no_top<span class="main">}</span><span class="main">⇒</span><span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> freq<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">a</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dependent_nat_choice<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> frequently_ex<span class="main">[</span><span class="operator">OF</span> freq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">0</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">n</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> freq<span class="main">[</span><span class="operator">unfolded</span> frequently_at_top<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> strict_mono_Suc_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frequently_at_topE'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">,</span>no_top<span class="main">}</span><span class="main">⇒</span><span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> freq<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">a</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="free">g</span> at_top sequentially"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">s</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">a</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> freq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_frequently_conj<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> frequently_at_topE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frequently_at_top_at_topE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linorder<span class="main">,</span>no_top<span class="main">}</span><span class="main">⇒</span><span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">a</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">a</span>"</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">g</span> at_top sequentially"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top sequentially"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> frequently_at_topE'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> s_at_top<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_at_top_mono<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms s <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Extract a strict monotone and sequence converging to something other than l *)</span>
<span class="keyword1"><span class="command">lemma</span></span> not_tendsto_convergent_seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="main">(</span><span class="free">l</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> at_top<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="bound">n</span> <span class="main">≥</span> <span class="bound">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> not_tendsto_frequentlyE<span class="main">[</span><span class="operator">OF</span> nl<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">S</span> <span class="main">∧</span> real <span class="bound">n</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eventually_frequently_conj<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_ge_at_top<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> frequently_at_topE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> real <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> dual_order.trans of_nat_0_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> im <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> X<span class="main">[</span><span class="operator">unfolded</span> compact_def<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">THEN</span> mp<span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> kLim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">-</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_in_closed_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">X</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">S</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ kLim<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> im <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">_</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span>›</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">S</span>›</span></span> X <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> compact_imp_closed<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> k
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">-</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kLim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_o<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">n</span> <span class="main">≥</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s_ge r
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply dual_order.trans of_nat_le_iff seq_suble<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> harmonic_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> frac_less2 of_nat_0_less_iff of_nat_less_two_power zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> INF_bounded_imp_convergent_seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">INF</span> <span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">s</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span>"</span></span>
    <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top sequentially"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">≠</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="keyword1"><span class="command">using</span></span> bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> limpt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="keyword1">islimpt</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">)</span> <span class="keyword1">islimpt</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Inf_islimpt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bdd_belowI2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">l</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bound<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> limpt_closed_imp_exploding_subsequence<span class="main">[</span><span class="operator">OF</span> cont closed_atLeast bound' limpt<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span>"</span></span>
    <span class="quoted"><span class="quoted">"compact <span class="skolem">C</span> <span class="main">⟹</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">⟹</span> <span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">i</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="skolem">s</span> <span class="bound">i</span> <span class="main">∉</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">C</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">i</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="skolem">s</span> <span class="bound">i</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span><span class="main">]</span> s<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filterlim_at_top
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>2<span class="main">)</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Generalizes to other combinations of strict_mono and filterlim *)</span>
<span class="keyword1"><span class="command">lemma</span></span> filterlim_at_top_strict_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="free">s</span> <span class="main">∘</span> <span class="free">r</span><span class="main">)</span> at_top <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_at_top_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> seq_suble strict_mono_leD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LIMSEQ_lb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⇢</span> <span class="main">(</span><span class="free">l</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n0</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n0</span><span class="main">.</span> <span class="free">s</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fl <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">no</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">no</span><span class="main">.</span> dist <span class="main">(</span><span class="free">s</span> <span class="bound">n</span><span class="main">)</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">-</span><span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LIMSEQ_iff_nz <span class="keyword1"><span class="command">using</span></span> u
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Used to sharpen a tendsto with additional information*)</span>
<span class="keyword1"><span class="command">lemma</span></span> filterlim_at_top_choose_lower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top sequentially"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"filterlim <span class="free">t</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">t</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">≥</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">s</span> <span class="bound">n</span> <span class="main">≥</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> filterlim_at_top eventually_sequentially <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span> <span class="bound">n</span> <span class="main">≥</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">t</span> at_top sequentially"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> filterlim_at_top eventually_sequentially t_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.commute trans_le_add2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> LIMSEQ_ignore_initial_segment<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="bound">n</span>›</span></span> <span class="quoted"><span class="quoted">‹filterlim <span class="skolem">t</span> at_top sequentially›</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frequently_at_top_realE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_top<span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat<span class="main">⇒</span>real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top at_top"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms frequently_at_top_at_topE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ filterlim_real_sequentially<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> approachable_sequenceE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>metric_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">tt</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">tt</span><span class="main">)</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top sequentially"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">i</span> <span class="keyword1">in</span> at_top<span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">/</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> frequently_at_top
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n m
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"max <span class="main">0</span> <span class="main">(</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> frequently_at_top_realE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> dist <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">note</span></span> this<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tendstoI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">i</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="main"><span class="main">0</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="skolem"><span class="skolem">e</span></span>›</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> real_tendsto_divide_at_top<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> filterlim_real_sequentially filterlim_Suc<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> dist <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">use</span> dual_order.strict_trans s <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_inc_bdd_above_has_limit_at_topI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="bound">l</span><span class="main">)</span> at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_incseq_SUP<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> bdd_aboveI2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mono_def of_nat_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tendsto_at_topI_sequentially_real<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> t<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="skolem">l</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_mono_inc_bdd_above_has_limit_at_topI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="bound">l</span><span class="main">)</span> at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ff</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ff</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m1<span class="main">:</span><span class="quoted"><span class="quoted">"mono <span class="skolem">ff</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ff_def mono_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> m2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">ff</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ff_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> mono_inc_bdd_above_has_limit_at_topI<span class="main">[</span><span class="operator">OF</span> m1 m2<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ff</span> <span class="main">⤏</span> <span class="skolem">l</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ff</span> <span class="main">⤏</span> <span class="skolem">l</span><span class="main">)</span> at_top›</span></span> ff_def tendsto_at_top_eq_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_mono_dec_bdd_below_has_limit_at_topI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="bound">l</span><span class="main">)</span> at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ff</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ff</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m1<span class="main">:</span><span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">-</span><span class="skolem">ff</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ff_def mono_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> m2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="skolem">ff</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">-</span><span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ff_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> mono_inc_bdd_above_has_limit_at_topI<span class="main">[</span><span class="operator">OF</span> m1 m2<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">ff</span> <span class="main">⤏</span> <span class="skolem">l</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ff</span> <span class="main">⤏</span> <span class="main">-</span><span class="skolem">l</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tendsto_at_top_eq_left tendsto_minus_cancel_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">ff</span> <span class="main">⤏</span> <span class="main">-</span><span class="skolem">l</span><span class="main">)</span> at_top›</span></span> ff_def tendsto_at_top_eq_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infdist_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="main">{</span><span class="bound">z</span><span class="main">.</span> infdist <span class="bound">z</span> <span class="free">S</span> <span class="main">≥</span> <span class="free">e</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>closed_Collect_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>continuous_on_infdist<span class="main">)</span>

<span class="comment1">(* TODO: this is a copy of LIMSEQ_norm_0 where the sequence
  is bounded above in norm by a geometric series *)</span>
<span class="keyword1"><span class="command">lemma</span></span> LIMSEQ_norm_0_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> norm <span class="main">(</span><span class="free">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> metric_LIMSEQ_I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">/</span> <span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">^</span><span class="main">(</span><span class="skolem">N</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="main">/</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> real_arch_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">s</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="skolem">n</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> frac_le leD power_less_imp_less_exp that zero_less_power<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_trans mult.commute pos_divide_less_eq zero_less_one zero_less_power<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms less_eq_real_def not_le order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">no</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">no</span><span class="main">.</span> dist <span class="main">(</span><span class="free">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filterlim_apply_filtermap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="free">g</span> <span class="free">G</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">m</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filtermap <span class="free">m</span> <span class="free">G</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filterlim_def filterlim_filtermap filtermap_mono g<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_at_right_field_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eventually <span class="free">P</span> <span class="main">(</span>at_right <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">b</span></span><span class="main">&gt;</span><span class="free">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&gt;</span><span class="free">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>linordered_field<span class="main">,</span> linorder_topology<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dense eventually_at_right_field le_less_trans less_le_not_le order.strict_trans1<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹indexing euclidean space with natural numbers›</span></span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">nth_eucl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_eucl</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∙</span> <span class="main">(</span>Basis_list <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹TODO: why is that and some sort of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>lambda_eucl›</span></span> nowhere available?›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lambda_eucl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lambda_eucl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span>nat<span class="main">⇒</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> Basis_list <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eucl_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> nth_eucl <span class="free">x</span> <span class="bound">i</span> <span class="main">=</span> nth_eucl <span class="free">y</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def euclidean_eq_iff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eucl_of_list_list_of_eucl list_of_eucl_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">bundle</span></span> eucl_notation <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">notation</span></span> nth_eucl <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span>"</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">bundle</span></span> no_eucl_notation <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">no_notation</span></span> nth_eucl <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span>"</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> eucl_notation

<span class="keyword1"><span class="command">lemma</span></span> eucl_of_list_eucl_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>eucl_of_list <span class="free">xs</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_of_eucl_eucl_of_list list_of_eucl_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eucl_of_list_inner<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>eucl_of_list <span class="free">xs</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">∙</span> eucl_of_list <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">←</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def eucl_of_list_inner_eq inner_lv_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> self_eq_eucl_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> eucl_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eucl_eq_iff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main"><span class="main">]</span></span> eucl_of_list_eucl_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∙</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span> <span class="main">*</span> <span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> self_eq_eucl_of_list<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> self_eq_eucl_of_list<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eucl_of_list_inner<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map2_map_map atLeast_upt interv_sum_list_conv_sum_set_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="free">x</span> <span class="main">=</span> L2_set <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> norm_eq_sqrt_inner inner_nth_eucl L2_set_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> plus_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">+</span> <span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> minus_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">-</span> <span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> uminus_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="main">-</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> scaleR_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"inf <span class="free">x</span> <span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">=</span> min <span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> inner_Basis_inf_left that inf_min<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> sup_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"sup <span class="free">x</span> <span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span> <span class="main">=</span> max <span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> inner_Basis_sup_left that sup_max<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_iff_le_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> eucl_le<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> eucl_le eucl_le_Basis_list_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eucl_less_iff_less_nth_eucl<span class="main">:</span> <span class="quoted"><span class="quoted">"eucl_less <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> eucl_less_def<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Basis_zero eucl_eq_iff inner_not_same_Basis inner_zero_left length_Basis_list
      nth_Basis_list_in_Basis nth_eucl_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_nth_eucl<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">X</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_eucl_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> that<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹derivatives›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_at_ne<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x0</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">x0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_vector_derivative_withinD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x0</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x0</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> LIM_zero_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_norm_zero_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x0</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">.</span> norm <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span> <span class="main">-</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    norm <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="main">-</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="main">_</span><span class="main">.</span> <span class="var">?th</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_filter
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">x0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="main">-</span> <span class="free">f'</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span>sgn <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="main">-</span> <span class="free">f'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sgn <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="main">-</span> <span class="free">f'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sgn_div_norm <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> add.commute add_divide_distrib diff_add_cancel scaleR_add_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?th</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="free">x0</span> <span class="main">-</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f'</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x0</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_norm_zero<span class="main">)</span>
      <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> has_vector_derivative_def has_derivative_at_within›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>path_connected›</span></span></span></span> set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> entering both <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>-T›</span></span></span></span>
      must cross the frontier of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> path_connected_frontier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_normed_vector set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="main">-</span><span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> frontier <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sn</span></span> <span class="keyword2"><span class="keyword">where</span></span> sn<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">sn</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∩</span> <span class="main">-</span><span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">g</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"pathstart <span class="skolem">g</span> <span class="main">=</span> <span class="skolem">st</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">g</span> <span class="main">=</span> <span class="skolem">sn</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> st sn <span class="keyword1"><span class="command">unfolding</span></span> path_connected_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"pathstart <span class="skolem">g</span> <span class="main">∈</span> closure <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> st g<span class="main">(</span>3<span class="main">)</span> closure_Un_frontier <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"pathfinish <span class="skolem">g</span> <span class="main">∉</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sn g<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> exists_path_subpath_to_frontier<span class="main">[</span><span class="operator">OF</span> g<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a1 a2<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">h</span> <span class="main">⊆</span> path_image <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">h</span> <span class="main">∈</span> frontier <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> g<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_mono pathfinish_in_path_image that<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> path_connected_not_frontier_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_normed_vector set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> frontier <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> path_connected_frontier assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1"><span class="command">lemma</span></span> compact_attains_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>topological_space <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder_topology"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compact<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="free">u</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="free">l</span> <span class="main">..</span> <span class="free">f</span> <span class="free">u</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> compact_continuous_image<span class="main">[</span><span class="operator">OF</span> cont compact<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> compact_image<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> ne_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> compact_attains_inf<span class="main">[</span><span class="operator">OF</span> compact_image ne_image<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> compact_attains_sup<span class="main">[</span><span class="operator">OF</span> compact_image ne_image<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="skolem">l</span> <span class="main">..</span> <span class="free">f</span> <span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> uniform_limit_const<span class="main">[</span><span class="operator">uniform_limit_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"uniform_limit <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">l</span><span class="main">)</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">l</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> uniform_limit_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> e
    <span class="keyword1"><span class="command">using</span></span> tendstoD<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Segments›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>closed_segment›</span></span></span></span> throws away the order that our intuition keeps›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">line</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_vector <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">{</span>_ <span class="keyword1">--</span> _<span class="keyword1">}⇘</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">--</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>}<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">u</span></span></span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">line_image</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">≡</span><span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">--</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>}<span class="hidden">⇘</span><sub><span class="bound">u</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> line_image <span class="main">(</span><span class="quoted">"<span class="keyword1">{</span>_ <span class="keyword1">--</span> _<span class="keyword1">}⇘`</span>_<span class="keyword1">⇙</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_closed_segment_iff_line<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_open_segment_iff_line<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_convex_combination1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span> <span class="main">+</span> <span class="free">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">u</span> <span class="main">-</span> <span class="free">i</span> <span class="main">*</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_convex_combination2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">+</span> <span class="free">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">i</span><span class="main">*</span><span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_convex_combination12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span> <span class="main">+</span> <span class="free">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> line <span class="free">a</span> <span class="free">b</span> <span class="free">j</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_less_one_less_self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">*</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">x</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_times_le_one_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">u</span> <span class="main">-</span> <span class="free">i</span> <span class="main">*</span> <span class="free">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">u</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_le_eq sum_le_prod1 that<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_times_less_one_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">u</span> <span class="main">-</span> <span class="free">i</span> <span class="main">*</span> <span class="free">u</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">u</span><span class="main">::</span><span class="quoted">real</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">-</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> line_eq_endpoint_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"line <span class="free">a</span> <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_open_segment_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">`</span> <span class="main">{</span><span class="free">i</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment line_convex_combination1 plus_times_less_one_lemma<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> j
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">j</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">/</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel less_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> mult_2_right plus_times_less_one_lemma that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_segment_line_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span><span class="main">}</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment line_convex_combination2 plus_times_less_one_lemma<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> j
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">j</span></span><span class="main"><span class="main">/</span></span><span class="free"><span class="free">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> line_closed_segment_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">`</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment line_convex_combination1 mult_le_cancel_right2 plus_times_le_one_lemma<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> j
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">j</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">/</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel less_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> mult_2_right plus_times_less_one_lemma that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_segment_line_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span><span class="main">}</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment line_convex_combination2 plus_times_less_one_lemma<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> j
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">j</span></span><span class="main"><span class="main">/</span></span><span class="free"><span class="free">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_segment_line_line_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i1</span><span class="main">--</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i2</span><span class="main">}</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">`</span> <span class="main">{</span><span class="free">i1</span><span class="main">..</span><span class="free">i2</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≤</span> <span class="free">i2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment line_convex_combination12 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> mult_left_le_one_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">u</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="free"><span class="free"><span class="free">i1</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">/</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">i2</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="free"><span class="free"><span class="free">i1</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> line_line1<span class="main">:</span> <span class="quoted"><span class="quoted">"line <span class="main">(</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">x</span> <span class="main">-</span> <span class="free">c</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_line2<span class="main">:</span> <span class="quoted"><span class="quoted">"line <span class="free">a</span> <span class="main">(</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> line_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_in_subsegment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">i2</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟹</span> line <span class="free">a</span> <span class="free">b</span> <span class="free">i1</span> <span class="main">∈</span> <span class="main">{</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i2</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">i2</span> <span class="main">&lt;</span> <span class="free">i1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_open_segment_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_in_subsegment2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i2</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">i1</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟹</span> line <span class="free">a</span> <span class="free">b</span> <span class="free">i1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>line <span class="free">a</span> <span class="free">b</span> <span class="free">i2</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">i1</span> <span class="main">&lt;</span> <span class="free">i2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_segment_line_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> line_in_open_segment_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"line <span class="free">a</span> <span class="free">b</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_open_segment_iff_line<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Open Segments›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_segment_subsegment<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x0</span><span class="main">&lt;--&lt;</span><span class="free">x3</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x1</span><span class="main">&lt;--&lt;</span><span class="free">x3</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x0</span><span class="main">&lt;--&lt;</span><span class="free">x2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span><span class="comment1">― ‹TODO: use <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>line›</span></span>›</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span>
    ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">≠</span> <span class="free">x3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x0</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x3</span> <span class="main">≠</span> <span class="free">x3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x0</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x0</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x3</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x3</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> <span class="skolem">v</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_nonneg_pos pos_add_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x0</span> <span class="main">≠</span> <span class="free">x3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="var">?d</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x3</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ua</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">/</span> <span class="var">?d</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">*</span> <span class="skolem">v</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">-</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ua_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> uv add_less_same_cancel1 add_strict_mono mult.right_neutral
        mult_less_cancel_left_pos not_real_square_gt_zero vector_space_over_itself.scale_zero_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ua</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">*</span> <span class="skolem">v</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">-</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x3</span> <span class="main">-</span> <span class="free">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ua</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ua_def pos_add_strict <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> divide_pos_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x1_def x2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">ua</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> in_segment<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sequentially_at_top</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">⇒</span>real<span class="main">)</span><span class="main">⇒</span>bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span></span> <span class="keyword1">∞</span>"</span><span class="main">)</span> <span class="comment1">― ‹the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span><span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span>›</span></span> is to disambiguate syntax...›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main"><span class="free">∞</span></span>  <span class="main">≡</span> filterlim <span class="free"><span class="bound"><span class="entity">s</span></span></span> at_top sequentially"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sequentially_at_bot</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">⇒</span>real<span class="main">)</span><span class="main">⇒</span>bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span></span> <span class="keyword1">-∞</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main"><span class="free">-∞</span></span>  <span class="main">≡</span> filterlim <span class="free"><span class="bound"><span class="entity">s</span></span></span> at_bot sequentially"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Paths›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subpath0_linepath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">0</span> <span class="free">u</span> <span class="main">(</span>linepath <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> linepath <span class="free">t</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> <span class="main">(</span><span class="free">t'</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subpath_def linepath_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span> <span class="bound">rc</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="bound">ra</span> <span class="main">*</span> <span class="bound">rb</span> <span class="main">-</span> <span class="bound">ra</span> <span class="main">*</span> <span class="bound">rc</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">-</span> <span class="bound">ra</span> <span class="main">*</span> <span class="main">(</span><span class="bound">rc</span> <span class="main">-</span> <span class="bound">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">-</span> <span class="bound">r</span> <span class="main">*</span> <span class="bound">ra</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">ra</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span> <span class="bound">rb</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">-</span> <span class="bound">ra</span> <span class="main">+</span> <span class="bound">rb</span> <span class="main">+</span> <span class="bound">ra</span> <span class="main">-</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">rb</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="bound">ra</span> <span class="main">=</span> <span class="bound">ra</span> <span class="main">+</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="bound">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="bound">ra</span><span class="main">)</span> <span class="main">=</span> <span class="bound">ra</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> <span class="main">(</span><span class="free">t'</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">t</span> <span class="main">-</span> <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">u</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">t'</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">u</span> <span class="main">*</span> <span class="main">(</span><span class="free">t'</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f6 f5 f4 f3 f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> mult.commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linepath_image0_right_open_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">t'</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linepath <span class="free">t</span> <span class="free">t'</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">t</span><span class="main">..&lt;</span><span class="free">t'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> linepath_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_left' assms diff_diff_eq2 diff_le_eq less_eq_real_def mult.commute mult.right_neutral mult_right_mono right_diff_distrib'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> assms comm_semiring_class.distrib mult_diff_mult semiring_normalization_rules<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_le_mult_iff<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="free">t</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">t'</span><span class="main">-</span><span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≤</span> <span class="skolem">x</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">t'</span>›</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="var">?u</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="var">?u</span><span class="main">*</span><span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">(</span><span class="bound">ra</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="main">-</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">-</span> <span class="bound">ra</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">+</span> <span class="main">(</span><span class="free">t'</span> <span class="main">+</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">t'</span> <span class="main">+</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">t'</span> <span class="main">+</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">t'</span> <span class="main">+</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.left_commute distrib_left mult.commute mult.right_neutral<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">t'</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> atLeastLessThan_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> oriented_subsegment_scale<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">-</span><span class="free">a</span> <span class="main">=</span> <span class="free">e</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x2</span><span class="main">-</span><span class="free">x1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_segment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x1</span> <span class="main">+</span> <span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_segment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x2</span><span class="main">-</span><span class="free">x1</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x1</span> <span class="main">+</span> <span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_right diff_minus_eq_add scaleR_collapse scaleR_left.minus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="skolem">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span><span class="main">)</span>  <span class="main">+</span> <span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">u</span><span class="main">)</span><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">u</span><span class="main">)</span><span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_diff_cancel diff_diff_add diff_minus_eq_add minus_diff_eq scaleR_collapse scale_minus_left scale_right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> x2x1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x2</span><span class="main">-</span><span class="free">x1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">*</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> scaleR_scaleR scale_right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> u<span class="main">(</span>2<span class="main">)</span> v<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x2</span><span class="main">-</span><span class="free">x1</span><span class="main">)</span><span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">v</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">-</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x2x1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> field_class.field_inverse scaleR_one scaleR_scaleR<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">v</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> positive_imp_inverse_positive that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ODE_Misc">
<div class="head">
<h1>Theory ODE_Misc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additions to the ODE Library›</span></span>
<span class="keyword1"><span class="command">theory</span></span> ODE_Misc
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Ordinary_Differential_Equations/ODE_Analysis.html">Ordinary_Differential_Equations.ODE_Analysis</a>
    <a href="Analysis_Misc.html">Analysis_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_compact_bicomposeE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="free">T</span> <span class="free">X</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> continuous_on <span class="free">I</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cI<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cv<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">I</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cw<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">I</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">`</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">`</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">L</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">w</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">L</span> <span class="main">*</span> dist <span class="main">(</span><span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> v w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">`</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">w</span> <span class="main">`</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ll <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">⊆</span> <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> llI<span class="main">:</span><span class="quoted"><span class="quoted">"local_lipschitz <span class="free">I</span> <span class="main">(</span><span class="free">v</span> <span class="main">`</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">w</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_lipschitz_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cvwI<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span><span class="free">v</span> <span class="main">`</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">w</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compact_continuous_image cv cw cI<span class="main">)</span>    

  <span class="keyword1"><span class="command">from</span></span> local_lipschitz_compact_implies_lipschitz<span class="main">[</span><span class="operator">OF</span> llI cvwI <span class="quoted"><span class="quoted">‹compact <span class="free">I</span>›</span></span> cf<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="skolem">L</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span><span class="free">v</span> <span class="main">`</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">w</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> v w
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> max <span class="skolem">L</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">w</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">L'</span> <span class="main">*</span> dist <span class="main">(</span><span class="free">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lipschitz_on_def L'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Un_iff image_eqI mult_right_mono zero_le_dist<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Comparison Principle›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comparison_principle_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> abX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> φ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">has_real_derivative</span> <span class="free">φ'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ψ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ψ</span> <span class="keyword1">has_real_derivative</span> <span class="free">ψ'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> φ_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ψ_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">ψ</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> defect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">φ'</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ψ'</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">ψ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">ψ</span> <span class="bound">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?th1</span>"</span></span><span class="main">)</span>
    <span class="comment1">(*
    "(∀x ∈ {a .. b}. φ x &lt; ψ x) ∨ (∃c∈{a..b}. (∀x∈{a..c}. φ x ≤ ψ x) ∧ (∀x∈{c&lt;..b}. φ x &lt; ψ x))"
    (is "?th2")
*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> atomize_conj
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> φ_cont <span class="main">=</span> has_real_derivative_imp_continuous_on<span class="main">[</span><span class="operator">OF</span> φ'<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ψ_cont <span class="main">=</span> has_real_derivative_imp_continuous_on<span class="main">[</span><span class="operator">OF</span> ψ'<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> local_lipschitz_compact_bicomposeE<span class="main">[</span><span class="operator">OF</span> ll cf compact_Icc abX φ_cont ψ_cont φ_in ψ_in<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">ψ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">L</span> <span class="main">*</span> dist <span class="main">(</span><span class="free">φ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">ψ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">ψ</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">φ</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>

  <span class="keyword1"><span class="command">have</span></span> w'<span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">w</span> <span class="keyword1">has_real_derivative</span> <span class="free">ψ'</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">φ'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> φ' ψ'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_vderiv_on_def w_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> w_cont<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span> has_real_derivative_imp_continuous_on<span class="main">[</span><span class="operator">OF</span> w'<span class="main">,</span> <span class="operator">THEN</span> continuous_on_compose2<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">d</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span> <span class="main">-`</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="skolem">d</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?N</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> compact_eq_bounded_closed
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI closed_vimage_Int<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a0</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="skolem">d</span><span class="main">}</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">`</span> <span class="main">{</span><span class="bound">a0</span> <span class="main">..</span> <span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="var">?N'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="var">?N'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> compact_eq_bounded_closed
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N'</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded <span class="var">?N'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bounded_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">u</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">x</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?N'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⇢</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">l</span> <span class="skolem">u</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">x</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> closed_sequentially<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹closed <span class="var">?N</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">⇢</span> <span class="skolem">l</span>›</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> order_tendstoD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">⇢</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">u</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eventually_happens<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">u</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_subset_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?N'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed_sequential_limits
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Lim_bounded Lim_bounded2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> compact_attains_inf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹compact <span class="var">?N'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?N'</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a0</span></span> <span class="keyword2"><span class="keyword">where</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">a0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">a0</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> a0_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="skolem">w</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">a0</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> a0d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a0</span> <span class="main">..</span> <span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that a0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> L_w_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">*</span> <span class="skolem">w</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">ψ'</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">φ'</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a0</span> <span class="main">..</span> <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> set_mp<span class="main">[</span><span class="operator">OF</span> a0d that<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> defect<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ'</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">ψ'</span> <span class="skolem">x</span> <span class="main">≤</span> dist <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">ψ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_real_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">L</span> <span class="main">*</span> dist <span class="main">(</span><span class="free">φ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">ψ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> L<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">-</span><span class="skolem">L</span> <span class="main">*</span> <span class="skolem">w</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">L</span>›</span></span> a0 that
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_real_def abs_real_def w_def <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">w</span> <span class="bound">x</span> <span class="main">*</span> exp<span class="main">(</span><span class="main">-</span><span class="skolem">L</span><span class="main">*</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">a0</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mono_onI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_nonneg_imp_nondecreasing<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> a0d
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ψ'</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">φ'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="skolem">L</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="skolem">L</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">L</span> <span class="main">*</span> <span class="skolem">w</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span>
          <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> L_w_bound <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">a0</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span><span class="skolem">L</span> <span class="main">*</span> <span class="skolem">a0</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="skolem">d</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span><span class="skolem">L</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mono_onD<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> that a0 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">a0</span> <span class="main">*</span> exp <span class="main">(</span><span class="main">-</span> <span class="skolem">L</span> <span class="main">*</span> <span class="skolem">a0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">a0</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> not_le<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="skolem">a0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span> <span class="skolem">a0</span><span class="main">}</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> a0 a0d <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> continuous_on_Icc_at_leftD<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="skolem">a0</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span> <span class="main">⤏</span> <span class="skolem">w</span> <span class="skolem">a0</span><span class="main">)</span> <span class="main">(</span>at_left <span class="skolem">a0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> order_tendstoD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="skolem">a0</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_left <span class="skolem">a0</span><span class="main">.</span> <span class="skolem">w</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_left <span class="skolem">a0</span><span class="main">.</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="skolem">a0</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_left <span class="skolem">a0</span><span class="main">.</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1'</span><span class="main">&lt;</span><span class="skolem">a0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">a1'</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">a0</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_left_field <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a1'</span> <span class="main">+</span> <span class="skolem">a0</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">&lt;</span> <span class="skolem">a0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a1'</span> <span class="main">&lt;</span> <span class="skolem">a0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">a1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="skolem">a0</span>›</span></span> a1_neg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a1'</span> <span class="main">&lt;</span> <span class="skolem">a0</span>›</span></span> a0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">a1</span><span class="main">..</span><span class="skolem">a0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="skolem">a0</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> a1_neg a0<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a1_def<span class="main">)</span> <span class="operator">smt</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">a0</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">≤</span> <span class="skolem">a1</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> a0_least<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff image_subset_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a1</span><span class="main">&lt;</span><span class="skolem">a0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a0</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≤</span> <span class="skolem">a0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="skolem">a0</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> w_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> w_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_lipschitz_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_lipschitz  <span class="main">(</span>UNIV<span class="main">::</span>real set<span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span>real set<span class="main">)</span> <span class="main">(*)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> c1_implies_local_lipschitz<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> blinfun_mult_left <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_derivative_mult_right mult_commute_abs<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comparison_principle_le_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">has_real_derivative</span> <span class="free">φ'</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">φ'</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">φ</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="free">φ</span> <span class="bound">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">g</span> <span class="bound">t</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> continuous_on_mult_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="main">(</span><span class="free">g</span><span class="main">`</span><span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span> UNIV <span class="main">(*)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local_lipschitz_subset<span class="main">[</span><span class="operator">OF</span> local_lipschitz_mult<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> local_lipschitz_compose1<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_lipschitz <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(*)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> comparison_principle_le<span class="main">[</span><span class="operator">OF</span> this _ _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ _ _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span><span class="main">0</span>"</span></span><span class="main">]</span> * assms<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locally Lipschitz ODEs›</span></span>

<span class="keyword1"><span class="command">context</span></span> ll_on_open_it <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_lipschitzE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl <span class="free">t0</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">L</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span><span class="keyword1">-lipschitz_on</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">(</span>flow <span class="free">t0</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow <span class="free">t0</span> <span class="free">x</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>flow <span class="free">t0</span> <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> flow_has_derivative<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_derivative_at_withinI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span>flow <span class="free">t0</span> <span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compact_continuous_image <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> local.existence_ivl_empty2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> atLeastAtMost_iff general.existence_ivl_subset in_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> general.flow_in_domain subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>flow <span class="free">t0</span> <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compact_imp_bounded <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> onorm <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>flow <span class="free">t0</span> <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">0</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> onorm_scaleR_left<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> onorm_id max_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_0_right diff_mono diff_self norm_ge_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bounded_derivative_imp_lipschitz<span class="main">[</span><span class="operator">OF</span> f' _ this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>max <span class="main">0</span> <span class="skolem">C</span><span class="main">)</span><span class="keyword1">-lipschitz_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span>flow <span class="free">t0</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_undefined0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∉</span> existence_ivl <span class="free">t0</span> <span class="free">x</span> <span class="main">⟹</span> flow <span class="free">t0</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flow_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> csols_undefined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">⟹</span> csols <span class="free">t0</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> csols_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> general.existence_ivl_empty2 general.existence_ivl_maximal_segment
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> existence_ivl_undefined <span class="main">=</span> existence_ivl_empty2

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse flow as Sublocale›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> range_preflect_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>preflect <span class="main">0</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> preflect_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> range_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"range uminus <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>ab_group_add set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rev<span class="main">:</span> auto_ll_on_open <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">using</span></span> auto_local_lipschitz auto_open_domain
  <span class="keyword1"><span class="command">unfolding</span></span> fun_Compl_def local_lipschitz_minus
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> existence_ivl_eq_rev0<span class="main">:</span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">y</span> <span class="main">=</span> uminus <span class="main">`</span> rev.existence_ivl0 <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">y</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> existence_ivl_eq_rev rev.existence_ivl0_def preflect_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_existence_ivl_eq0<span class="main">:</span> <span class="quoted"><span class="quoted">"rev.existence_ivl0 <span class="free">y</span> <span class="main">=</span> uminus <span class="main">`</span> existence_ivl0 <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">y</span>
  <span class="keyword1"><span class="command">using</span></span> uminus_uminus_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev.existence_ivl0 <span class="free">y</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> existence_ivl_eq_rev0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flow_eq_rev0<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> rev.flow0 <span class="free">y</span> <span class="main">(</span><span class="main">-</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">y</span> <span class="free">t</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_eq_rev<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> rev.flow0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preflect_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> flow_undefined0<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> existence_ivl_eq_rev0 rev.flow_undefined0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_eq_flow<span class="main">:</span> <span class="quoted"><span class="quoted">"rev.flow0 <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="main">(</span><span class="main">-</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">y</span> <span class="free">t</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_eq_rev0<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> uminus_uminus_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev.existence_ivl0 <span class="free">y</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> existence_ivl_eq_rev0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_flow_image_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"rev.flow0 <span class="free">x</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span>uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_eq_flow<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> flow_image_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> rev.flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span>uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_eq_flow<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> c1_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rev<span class="main">:</span> c1_on_open <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">f'</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c1_on_open_rev<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> c1_on_open_euclidean <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rev<span class="main">:</span> c1_on_open_euclidean <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">f'</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Autonomous LL ODE : Existence Interval and trapping on the interval›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_above_is_intervalI<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_above <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"is_interval <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">I</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bdd_above_def is_interval_1 le_cases that<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> bdd_below_is_intervalI<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_below <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"is_interval <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">I</span><span class="main">::</span><span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bdd_below_def is_interval_1 le_cases that<span class="main">)</span> 

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_existence_ivl0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">b</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">a</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="main">(</span>existence_ivl0 <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a1 a2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="main">0</span> <span class="skolem">d</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> openE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> ball <span class="main">0</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> dist_norm mem_ball <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹ball <span class="main">0</span> <span class="skolem">d</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span> divide_minus_left half_gt_zero order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_existence_ivl'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="free">a</span><span class="main">..</span><span class="free">a</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> open_existence_ivl0<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span>min <span class="main">(</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">..</span> min<span class="main">(</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ab<span class="main">(</span>3<span class="main">)</span> that<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹min <span class="main">(</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_existence_ivl_on_compact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">-</span><span class="free">a</span><span class="main">..</span><span class="free">a</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> existence_ivl_cballs
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">e</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>cball <span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> cball <span class="main">0</span> <span class="bound">t</span><span class="main">⊆</span>existence_ivl0 <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> C Int_absorb1 Int_iff UNIV_I<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d'</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>cball <span class="bound">x</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> cball <span class="main">0</span> <span class="main">(</span><span class="skolem">t'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> existence_ivl0 <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> compactE_image<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹compact <span class="free">C</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ball <span class="bound">x</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span><span class="skolem">C'</span><span class="main">.</span> ball <span class="bound">c</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> C_subset <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Min <span class="main">(</span><span class="skolem">d'</span> <span class="main">`</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Min <span class="main">(</span><span class="skolem">t'</span> <span class="main">`</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">C'</span> <span class="main">⊆</span> <span class="free">C</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">t</span> <span class="main">..</span> <span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> C_subset that <span class="quoted"><span class="quoted">‹<span class="skolem">C'</span> <span class="main">⊆</span> <span class="free">C</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ball <span class="skolem">c</span> <span class="main">(</span><span class="skolem">d'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">t</span> <span class="main">..</span> <span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> cball <span class="main">0</span> <span class="main">(</span><span class="skolem">t'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_real_def t_def minus_le_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cball <span class="main">0</span> <span class="main">(</span><span class="skolem">t'</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="free">C</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trapped_forward</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⟷</span> <span class="main">(</span>flow0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹TODO: use this for backwards trapped, invariant, and all assumptions›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trapped_backward</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⟷</span> <span class="main">(</span>flow0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∩</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trapped</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⟷</span> trapped_forward <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span> trapped_backward <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trapped_iff_on_existence_ivl0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trapped <span class="free">x</span> <span class="free">K</span> <span class="main">⟷</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapped_def trapped_forward_def trapped_backward_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI atLeast_iff atMost_iff image_subset_iff less_eq_real_def linorder_not_less<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_rev_existence_ivl0_rewrites<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> rev.existence_ivl0 <span class="free">x</span> <span class="main">⟷</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> rev.existence_ivl0 <span class="free">x</span> <span class="main">⟷</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev.rev_existence_ivl_eq0 subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> neg_le_0_iff_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> neg_0_le_iff_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> trapped_backward_iff_rev_trapped_forward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trapped_backward <span class="free">x</span> <span class="free">K</span>  <span class="main">⟷</span> rev.trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapped_backward_def rev.trapped_forward_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_flow_image_eq existence_ivl_eq_rev0 image_subset_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If solution is trapped in a compact set at some time
  on its existence interval then it is trapped forever›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trapped_sol_right<span class="main">:</span>
  <span class="comment1">― ‹TODO: when building on afp-devel (??? outdated):
    <span class="antiquoted"><span class="operator">🌐</span>‹https://bitbucket.org/isa-afp/afp-devel/commits/0c3edf9248d5389197f248c723b625c419e4d3eb›</span>›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∉</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bdd<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_above <span class="main">(</span>existence_ivl0 <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bdd_above_is_intervalI <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> flow_leaves_compact_ivl_right <span class="main">[</span><span class="operator">OF</span> UNIV_I <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> bdd UNIV_I assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> trapped_forward_def IntI atLeast_iff image_subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trapped_sol_right_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> local.existence_ivl_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> xtk<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.flow_in_domain<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trapped_sol_right<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> xtk assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> existence_ivl_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute atLeast_iff diff_add_cancel le_add_same_cancel1 subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trapped_sol_left<span class="main">:</span>
  <span class="comment1">― ‹TODO: when building on afp-devel:
    <span class="antiquoted"><span class="operator">🌐</span>‹https://bitbucket.org/isa-afp/afp-devel/commits/0c3edf9248d5389197f248c723b625c419e4d3eb›</span>›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_backward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∉</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bdd<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_below <span class="main">(</span>existence_ivl0 <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bdd_below_is_intervalI <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> flow_leaves_compact_ivl_left <span class="main">[</span><span class="operator">OF</span> UNIV_I <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> bdd UNIV_I assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> atMost_iff auto_ll_on_open.trapped_backward_def auto_ll_on_open_axioms image_subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trapped_sol_left_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_backward <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> local.existence_ivl_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> xtk<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.flow_in_domain<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trapped_sol_left<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> xtk assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> existence_ivl_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_le_same_cancel1 atMost_iff diff_add_cancel subset_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trapped_sol<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms existence_ivl_zero image_subset_iff interval local.existence_ivl_initial_time_iff local.existence_ivl_subset local.subset_mem_compact_implies_subset_existence_interval order_refl subset_antisym trapped_iff_on_existence_ivl0<span class="main">)</span>

<span class="comment1">(* Follows from rectification *)</span>
<span class="keyword1"><span class="command">lemma</span></span> regular_locally_noteq<span class="main">:</span><span class="comment1">― ‹TODO: should be true in <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>ll_on_open_it›</span></span>›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nf<span class="main">:</span><span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
      <span class="comment1">(* By continuity of solutions and f probably *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⟹</span> norm<span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> open_existence_ivl'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="keyword2"><span class="keyword">where</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">a1</span><span class="main">..</span><span class="skolem">a1</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> norm<span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.f_flow_continuous<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> norm <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">a2</span> <span class="main">⟶</span>
             norm <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> continuous_at_real_range
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> abs_norm_cancel cancel_comm_monoid_add_class.diff_cancel diff_zero half_gt_zero nf norm_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
      t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a2</span><span class="main">&lt;--&lt;</span><span class="skolem">a2</span><span class="main">}</span> <span class="main">⟹</span> norm<span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> open_segment_bound<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> open_segment_bound1 real_norm_def<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> min <span class="skolem">a1</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a1</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span><span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a1</span><span class="main">..</span><span class="skolem">a1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a1</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ODE_Auxiliarities.closed_segment_eq_real_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a2</span><span class="main">&lt;--&lt;</span><span class="skolem">a2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a1</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Diff_iff closed_segment_eq_real_ivl atLeastAtMost_iff empty_iff half_gt_zero insert_iff pos_half_less segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⟹</span> norm<span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t1 t2 t3 t4 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">has_vector_derivative</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">t</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_vector_derivative_at_within<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>flow_has_vector_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> vector_differentiable_bound_linearization<span class="main">[</span><span class="operator">OF</span> this _ a<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> nb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="main">{</span><span class="bound">c</span><span class="main">--</span><span class="bound">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⟹</span>
   norm <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">d</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="bound">c</span> <span class="main">-</span> <span class="main">(</span><span class="bound">d</span> <span class="main">-</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>  <span class="main">≤</span> norm <span class="main">(</span><span class="bound">d</span> <span class="main">-</span> <span class="bound">c</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> dist <span class="bound">t</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">t</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tx<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closed_segment_eq_real_ivl <span class="quoted"><span class="quoted">‹dist <span class="skolem">t</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">--</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span>›</span></span> a<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_closed_segment<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> nb<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"norm <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">-</span> <span class="free">x</span> <span class="main">-</span> <span class="skolem">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> nf
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">t</span><span class="main">--</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">a</span><span class="main">--</span><span class="skolem">a</span><span class="main">}</span>›</span></span> a<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_closed_segment<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> nb<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">x</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">+</span> <span class="skolem">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> nf
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eventually_at
    <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compact_max_time_flow_in_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"compact <span class="var">?C</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> compact_eq_bounded_closed
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bounded_subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> topological_space_class.openI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="comment1">― ‹TODO: there must be a more abstract argument for this, e.g., with
      <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> continuous_on_closed_vimageI<span class="antiquote">}</span></span> and then reasoning about the connected component around 0?›</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> notM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">¬</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">∉</span> <span class="free">M</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&gt;</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> open <span class="bound">T</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">∧</span> <span class="bound">T</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isCont <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> s ivl_subset_existence_ivl<span class="main">[</span><span class="operator">OF</span> t_ex<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flow_continuous<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> continuous_at_open<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">M</span>"</span></span><span class="main">]</span> sM <span class="quoted"><span class="quoted">‹closed <span class="free">M</span>›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this notM <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s0</span></span> <span class="keyword2"><span class="keyword">where</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s0</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s0</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> order_tendstoD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> tendsto_ident_at <span class="quoted"><span class="quoted">‹<span class="skolem">s0</span> <span class="main">&lt;</span> <span class="skolem">s</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">unfolded</span> eventually_at_topological<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="skolem">s0</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s0
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff image_subset_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">&lt;..}</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="main">0</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_in_closed_max_timeE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">T</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">s'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> local.mem_existence_ivl_iv_defined
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> compact_max_time_flow_in_closed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> compact_attains_sup<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="var">?C</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">s'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_leaves_closed_at_frontierE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">s</span> <span class="main">∈</span> frontier <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="free">s</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s'</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> flow_in_closed_max_timeE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">s'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">s'</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff image_subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> s
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">∉</span> interior <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> interior<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">∈</span> interior <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ivl_subset_existence_ivl<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main">]</span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> flow_continuous<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">THEN</span> isContD<span class="main">,</span> <span class="operator">THEN</span> topological_tendstoD<span class="main">,</span> <span class="operator">OF</span> open_interior interior<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="skolem">s</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s'</span> <span class="main">∈</span> interior <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="skolem">s</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s'</span> <span class="main">∈</span> interior <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="skolem">s</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tendsto_ident_at <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">&lt;</span> <span class="free">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="skolem">s</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">use</span> interior_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">s'</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_right_field_le<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> s'_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">s'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s''</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="skolem">s'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s''</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> s interior_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> s'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> s_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s'</span> <span class="main">&lt;</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">s'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">∈</span> frontier <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s closure_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frontier_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">-`</span> <span class="free">M</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">s</span><span class="main">..</span><span class="free">t</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"compact <span class="var">?C</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> compact_eq_bounded_closed
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">{</span><span class="skolem">s</span> <span class="main">..</span> <span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded <span class="var">?C</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bounded_subset<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="free">M</span>›</span></span> assms mem_existence_ivl_iv_defined<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t_ex<span class="main">]</span> ivl_subset_existence_ivl<span class="main">[</span><span class="operator">OF</span> t_ex<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> closed_vimage_Int<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="skolem">s</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s'</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> not_frequently
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="skolem">s</span><span class="main">.</span> <span class="main">¬</span> flow0 <span class="free">x</span> <span class="bound">s'</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="skolem">s</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tendsto_ident_at <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">&lt;</span> <span class="free">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s'</span> <span class="keyword1">in</span> at_right <span class="skolem">s</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">s'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">s'</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">s'</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_right_field<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">+</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">&lt;</span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s s'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> divide_le_eq_numeral1 le_divide_eq_numeral1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s''_def<span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">s''</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> u
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">≤</span><span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> s_max<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s''</span><span class="main">≤</span> <span class="free">t</span>›</span></span> this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s''</span> <span class="main">&gt;</span> <span class="skolem">s</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Connectedness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fcontX<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">X</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> auto_local_lipschitz local_lipschitz_continuous_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fcontx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> continuous_on_eq_continuous_at<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fcontX assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_at_imp_cball<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="free">r</span><span class="main">.</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">`</span> <span class="main">(</span>ball <span class="free">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⊆</span> ball <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> continuous_at_ball half_gt_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="main">(</span><span class="skolem">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dist_norm image_subset_iff mem_ball mem_cball pos_half_less real_norm_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> that half_gt_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>flow0›</span></span></span></span> is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>path_connected›</span></span></span></span> ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> flow0_path_connected_time<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">ts</span> <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms continuous_on_sequentially flow_continuous_on subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> path_connected_continuous_image<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow0_path_connected<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"path_connected <span class="free">ts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">ts</span> <span class="main">⊆</span> existence_ivl0 <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="main">(</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">D</span> <span class="main">×</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">×</span> <span class="free">ts</span> <span class="main">⊆</span> Sigma <span class="free">X</span> existence_ivl0"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> subset_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="free">D</span> <span class="main">×</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flow_continuous_on_state_space continuous_on_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> a2 <span class="main">:</span> <span class="quoted"><span class="quoted">"path_connected <span class="main">(</span><span class="free">D</span> <span class="main">×</span> <span class="free">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> path_connected_Times assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> path_connected_continuous_image<span class="main">[</span><span class="operator">OF</span> a1 a2<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Return Time and Implicit Function Theorem›</span></span>

<span class="keyword1"><span class="command">context</span></span> c1_on_open_euclidean <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_implicit_function<span class="main">:</span>
  <span class="comment1">― ‹TODO: generalization of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> returns_to_implicit_function<span class="antiquote">}</span></span>!›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> DsC<span class="main">:</span> <span class="quoted"><span class="quoted">"isCont <span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">e</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">u</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">(</span>flow0 <span class="bound">y</span> <span class="main">(</span><span class="free">u</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cball <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">u</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> cball <span class="free">x</span> <span class="free">e</span> <span class="main">⊆</span> Sigma <span class="free">X</span> existence_ivl0"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">-</span> blinfun_scaleR_left
                   <span class="main">(</span>inverse <span class="main">(</span>blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span>
                      <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> flowderiv <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> embed1_blinfun<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span> has_derivative_compose<span class="main">[</span><span class="operator">OF</span> _ Ds<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> cont_s<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_continuous_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Ds<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> cls<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> closed_levelset<span class="main">[</span><span class="operator">OF</span> cont_s<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> Sigma <span class="free">X</span> existence_ivl0"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t x<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Sigma <span class="free">X</span> existence_ivl0 <span class="main">⟹</span>
      <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span>
       blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span>flowderiv <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"isCont <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Ds</span> <span class="main">(</span>flow0 <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> flowderiv <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flowderiv_continuous_on<span class="main">[</span><span class="operator">unfolded</span> continuous_on_eq_continuous_within<span class="main">,</span>
        <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> xt1<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> at_within_open<span class="main">[</span><span class="operator">OF</span> xt1 open_state_space<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> x t
        isCont_tendsto_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> DsC<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> poincare_map_def<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta' isCont_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">s</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> st<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"blinfun_scaleR_left <span class="main">(</span>inverse <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> 
    <span class="main">(</span><span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="main">(</span>fst <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>snd <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span>
       flowderiv <span class="main">(</span>fst <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>snd <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span>
      embed2_blinfun<span class="main">)</span>
     <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nz
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinfun_eqI
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flowderiv_def <span class="dynamic"><span class="dynamic">blinfun.bilinear_simps</span></span> inverse_eq_divide poincare_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="main">(</span>fst <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>snd <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span>
       flowderiv <span class="main">(</span>fst <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>snd <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span>
      embed2_blinfun<span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> blinfun_scaleR_left <span class="main">(</span>inverse <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nz
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> blinfun_eqI
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flowderiv_def <span class="dynamic"><span class="dynamic">blinfun.bilinear_simps</span></span> inverse_eq_divide poincare_map_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> implicit_function_theorem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">(</span></span>flow0 <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
          <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Sigma <span class="free"><span class="free">X</span></span> existence_ivl0"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> D xt1 open_state_space order_refl C Z I1 I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">unfolding</span></span> split_beta' fst_conv snd_conv poincare_map_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_implicit_function_at<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> DsC<span class="main">:</span> <span class="quoted"><span class="quoted">"isCont <span class="free">Ds</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">d</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">(</span>flow0 <span class="bound">y</span> <span class="main">(</span><span class="free">u</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="free">d</span> <span class="main">⟹</span> <span class="main">¦</span><span class="free">u</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">u</span> <span class="bound">y</span> <span class="main">∈</span> existence_ivl0 <span class="bound">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cball <span class="free">x</span> <span class="free">d</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="keyword1">has_derivative</span> <span class="main">-</span><span class="free">Ds</span> <span class="free">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">Ds</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> flow_implicit_function<span class="main">[</span><span class="operator">OF</span> existence_ivl_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span> x<span class="main">,</span> <span class="operator">unfolded</span> x0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">,</span> <span class="operator">OF</span> st Ds DsC nz<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">d0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">u</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> u0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="skolem">d0</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">(</span>flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">u</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> uc<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cball <span class="free">x</span> <span class="skolem">d0</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> uex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="skolem">u</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> cball <span class="free">x</span> <span class="skolem">d0</span> <span class="main">⊆</span> Sigma <span class="free">X</span> existence_ivl0"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="keyword1">has_derivative</span>
     blinfun_apply
      <span class="main">(</span><span class="main">-</span> blinfun_scaleR_left <span class="main">(</span>inverse <span class="main">(</span>blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span><span class="free">Ds</span> <span class="free">x</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> flowderiv <span class="free">x</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> embed1_blinfun<span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> cball <span class="free">x</span> <span class="skolem">d0</span> <span class="main">=</span> <span class="keyword1">at</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> at_within_interior<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d0</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uc d0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def u0 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tendstoD<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span>›</span></span><span class="main">]</span> pos u0
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="keyword2"><span class="keyword">where</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> dist <span class="bound">xa</span> <span class="free">x</span> <span class="main">≤</span> <span class="skolem">d1</span> <span class="main">⟹</span> <span class="main">¦</span><span class="skolem">u</span> <span class="bound">xa</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_le
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> min <span class="skolem">d0</span> <span class="skolem">d1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def d0 d1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> u0
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">(</span>flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">u</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> u <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="main">¦</span><span class="skolem">u</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def dist_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="skolem">u</span> <span class="bound">y</span> <span class="main">∈</span> existence_ivl0 <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cball <span class="free">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span> <span class="keyword1">has_derivative</span> <span class="main">-</span><span class="free">Ds</span> <span class="free">x</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">Ds</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_subst<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x x0 flowderiv_def <span class="dynamic"><span class="dynamic">blinfun.bilinear_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> returns_to_implicit_function_gen<span class="main">:</span>
  <span class="comment1">― ‹TODO: generalizes proof of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> returns_to_implicit_function<span class="antiquote">}</span></span>!›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"returns_to <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="free">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"returns_to <span class="var">?P</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cS<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"isCont <span class="free">Ds</span> <span class="main">(</span>poincare_map <span class="var">?P</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">(</span>poincare_map <span class="var">?P</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>poincare_map <span class="var">?P</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">e</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">u</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="free">x</span> <span class="main">=</span> return_time <span class="var">?P</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">(</span>flow0 <span class="bound">y</span> <span class="main">(</span><span class="free">u</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cball <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">u</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> cball <span class="free">x</span> <span class="free">e</span> <span class="main">⊆</span> Sigma <span class="free">X</span> existence_ivl0"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">-</span> blinfun_scaleR_left
                   <span class="main">(</span>inverse <span class="main">(</span>blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>poincare_map <span class="var">?P</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>poincare_map <span class="var">?P</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span>
                      <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>poincare_map <span class="var">?P</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> flowderiv <span class="free">x</span> <span class="main">(</span>return_time <span class="var">?P</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o<span class="hidden">⇩</span><sub>L</sub></span> embed1_blinfun<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span> <span class="main">=</span> has_derivative_compose<span class="main">[</span><span class="operator">OF</span> _ Ds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> cont_s<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_derivative_continuous_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Ds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> cls<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> closed_levelset<span class="main">[</span><span class="operator">OF</span> cont_s<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"return_time <span class="var">?P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cls<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closed_levelset_within<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cS continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cont_s<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"poincare_map <span class="var">?P</span> <span class="free">x</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">(</span>return_time <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poincare_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"return_time <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="free">x</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>poincare_map <span class="var">?P</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poincare_map_returns rt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> return_time_exivl rt<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> E <span class="main">=</span> flow_implicit_function<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"return_time <span class="var">?P</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">Ds</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> *<span class="main"><span class="main">]</span></span> Ds<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> *<span class="main"><span class="main">]</span></span><span class="main">,</span>
      <span class="operator">folded</span> *<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> E<span class="main">)</span> <span class="operator">rule</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹c.f. Perko Section 3.7 Lemma 2 part 1.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_transversal_surface_finite_intersections<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>real_normed_vector"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Ds</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>L</sub></span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="free">Ds</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">Ds</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">t</span></span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="comment1">― ‹TODO: define notion of (compact/closed)-(continuous/differentiable/C1)-surface?›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">note</span></span> Ds <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">s</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="free">Ds</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> transversal <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">Ds</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">t</span></span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> flow0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">THEN</span> continuous_on_compose2<span class="main">,</span> <span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_derivative_continuous_on Ds <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> has_derivative_at_withinI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?T</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> compact_sequentialE<span class="main">[</span><span class="operator">OF</span> compact_Icc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">tl</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="var">?T</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="skolem">tl</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⇢</span> <span class="skolem">tl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tl</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> tl_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tl</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tl</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> closed_levelset_within <span class="quoted"><span class="quoted">‹closed <span class="free">S</span>›</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> flow_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="free">x</span> <span class="skolem">tl</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> tl_ex tl<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">tl</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closed_sequentially<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?qt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="bound">t</span> <span class="main">-</span> <span class="skolem">tl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> flow_has_vector_derivative<span class="main">[</span><span class="operator">OF</span> tl_ex<span class="main">,</span> <span class="operator">THEN</span> has_vector_derivative_withinD<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> qt_tendsto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?qt</span> <span class="main">─</span><span class="skolem">tl</span><span class="main">→</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?qt</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">t</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">tl</span><span class="main">)</span> sequentially"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tl<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_atI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> qt_tendsto <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">⇢</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> flow_lipschitzE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span><span class="keyword1">-lipschitz_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> lipschitz_on_le<span class="main">[</span><span class="operator">OF</span> L'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">L</span></span><span class="main">]</span> lipschitz_on_nonneg<span class="main">[</span><span class="operator">OF</span> L'<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span><span class="keyword1">-lipschitz_on</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> flow_lipschitzE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span><span class="keyword1">-lipschitz_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span> <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="comment1">― ‹TODO: is this reasoning (below) with this Lipschitz constant really necessary?›</span>
    <span class="keyword1"><span class="command">have</span></span> s<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="skolem">tl</span> <span class="main">∈</span> <span class="var">?S</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> Ds<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">tl</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> has_derivative_within<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">s</span> <span class="bound">y</span> <span class="main">-</span> <span class="main">(</span><span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">+</span> blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">─</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">→</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">s</span> <span class="bound">y</span> <span class="main">-</span> <span class="main">(</span><span class="free">s</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">+</span> blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span>nhds <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_nhds_continuousI<span class="main">)</span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> filterlim_compose<span class="main">[</span><span class="operator">OF</span> this flow_t<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span>blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> norm <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⇢</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inverse_eq_divide tendsto_minus_cancel_right<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tendsto_mult<span class="main">[</span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span>"</span></span><span class="main"><span class="main">]</span></span> tendsto_norm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> divide_inverse_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="comment1">― ‹TODO: uuugly›</span>
    <span class="keyword1"><span class="command">have</span></span> Ds0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> norm <span class="main">(</span>blinfun_apply <span class="main">(</span><span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>norm <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="skolem">L</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> _ Ds0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Lim_null_comparison<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eventuallyI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_scaleR blinfun.scaleR_right abs_inverse divide_inverse_commute<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> n
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">tl</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">blinfun.bilinear_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> divide_left_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> lipschitz_onD<span class="main">[</span><span class="operator">OF</span> L<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">tl</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">L</span>›</span></span> t<span class="main">(</span>3<span class="main">)</span> tl<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span> zero_less_divide_iff dist_norm pos_divide_le_eq
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_unique<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">tl</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transversal<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="skolem">tl</span> <span class="main">∈</span> <span class="var">?S</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> uniform_limit_flow0_state<span class="main">:</span><span class="comment1">― ‹TODO: is that something more general?›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"uniform_limit <span class="free">C</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> uniform_limitI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> existence_ivl_cballs<span class="main">[</span><span class="operator">OF</span> UNIV_I <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="skolem">x</span> <span class="skolem">u</span> <span class="main">⟹</span> cball <span class="main">0</span> <span class="skolem">t</span> <span class="main">⊆</span> existence_ivl0 <span class="bound">y</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="skolem">x</span> <span class="skolem">u</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> cball <span class="main">0</span> <span class="skolem">t</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="bound">s</span> <span class="main">∈</span> cball <span class="bound">y</span> <span class="skolem">u</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">L</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="main">0</span> <span class="skolem">t</span><span class="main">×</span>cball <span class="skolem">x</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="skolem">x</span> <span class="skolem">u</span> <span class="main">⟹</span> cball <span class="bound">y</span> <span class="skolem">u</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">u</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="bound">L</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="main">0</span> <span class="bound">t</span><span class="main">×</span>cball <span class="skolem">x</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound">L</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">u</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="bound">L</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="main">0</span> <span class="bound">t</span><span class="main">×</span>cball <span class="bound">x</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">L</span> <span class="bound">x</span><span class="main">)</span><span class="keyword1">-lipschitz_on</span> <span class="main">(</span>cball <span class="main">0</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">x</span><span class="main">)</span><span class="main">×</span>cball <span class="bound">x</span> <span class="main">(</span><span class="skolem">u'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> d'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="skolem">d'</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="skolem">u'</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> ball <span class="bound">c</span> <span class="main">(</span><span class="skolem">u'</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> compactE_image<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹compact <span class="free">C</span>›</span></span> _ this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C'_cover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span><span class="skolem">C'</span><span class="main">.</span> ball <span class="bound">c</span> <span class="main">(</span><span class="skolem">u'</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> C'_cover <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> ball <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u'</span> <span class="main">(</span><span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">⟹</span> <span class="skolem">c'</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>ball <span class="skolem">c</span> <span class="main">(</span><span class="skolem">u'</span> <span class="skolem">c</span><span class="main">)</span><span class="main">.</span> dist <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> cC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c' <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">C'</span>›</span></span> d' <span class="quoted"><span class="quoted">‹<span class="skolem">C'</span> <span class="main">⊆</span> <span class="free">C</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">L</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">¦</span><span class="skolem">s</span><span class="main">¦</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>ball <span class="skolem">c</span> <span class="main">(</span><span class="skolem">u'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> cball <span class="main">0</span> <span class="main">(</span><span class="skolem">d'</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> L<span class="main">[</span><span class="operator">OF</span> cC<span class="main">,</span> <span class="operator">THEN</span> lipschitz_onD<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span> d'<span class="main">[</span><span class="operator">OF</span> cC<span class="main">]</span> that
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_prod_def dist_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> abs <span class="bound">s</span> <span class="main">&lt;</span> <span class="skolem">d'</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">use</span> d' cC <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> <span class="skolem">L</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">¦</span><span class="bound">s</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">eventually_elim</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">use</span> * <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound">c</span><span class="main">∈</span><span class="skolem">C'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>ball <span class="bound">c</span> <span class="main">(</span><span class="skolem">u'</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> dist <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_ball_finite_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> dist <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">eventually_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">using</span></span> c'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fixpoints›</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixpoint_sol<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">solves_ode</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> UNIV <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> solves_odeI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> maximal_existence_flow<span class="main">[</span><span class="operator">OF</span> sol<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Invariance">
<div class="head">
<h1>Theory Invariance</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Invariance›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Invariance
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="ODE_Misc.html">ODE_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> trapped <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">positively_invariant</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> trapped_forward <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">negatively_invariant</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> trapped_backward <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"positively_invariant <span class="free">M</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="bound">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positively_invariant_def trapped_forward_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> negatively_invariant_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"negatively_invariant <span class="free">M</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="bound">x</span> <span class="main">∩</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> negatively_invariant_def trapped_backward_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> invariant_iff_pos_and_neg_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant <span class="free">M</span> <span class="main">⟷</span> positively_invariant <span class="free">M</span> <span class="main">∧</span> negatively_invariant <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invariant_def trapped_def positively_invariant_def negatively_invariant_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> invariant_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant <span class="free">M</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">M</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>  <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invariant_iff_pos_and_neg_invariant positively_invariant_iff negatively_invariant_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> SUP_le_iff invariant_def invariant_iff_pos_and_neg_invariant negatively_invariant_iff positively_invariant_iff trapped_iff_on_existence_ivl0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_restrict_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">M</span> <span class="main">=</span> positively_invariant <span class="main">(</span><span class="free">M</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positively_invariant_def trapped_forward_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flow_in_domain <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mem_existence_ivl_iv_defined<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> negatively_invariant_restrict_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"negatively_invariant <span class="free">M</span> <span class="main">=</span> negatively_invariant <span class="main">(</span><span class="free">M</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> negatively_invariant_def trapped_backward_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flow_in_domain <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mem_existence_ivl_iv_defined<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invariant_restrict_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="free">M</span> <span class="main">=</span> invariant <span class="main">(</span><span class="free">M</span> <span class="main">∩</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> invariant_iff_pos_and_neg_invariant
    negatively_invariant_restrict_dom
    positively_invariant_restrict_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(*
lemma positively_invariant_imp_subset:
  "M ⊆ X" if "positively_invariant M"
  using positively_invariant_iff that by blast

lemma negatively_invariant_imp_subset:
  "M ⊆ X" if "negatively_invariant M"
  using negatively_invariant_iff that by blast

lemma invariant_imp_subset:
  "M ⊆ X" if "invariant M"
  using invariant_iff that by blast
*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">M</span> <span class="main">=</span> rev.negatively_invariant <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positively_invariant_def rev.negatively_invariant_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev.trapped_backward_iff_rev_trapped_forward<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> negatively_invariant_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"negatively_invariant <span class="free">M</span> <span class="main">=</span> rev.positively_invariant <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> negatively_invariant_def rev.positively_invariant_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trapped_backward_iff_rev_trapped_forward<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invariant_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="free">M</span> <span class="main">=</span> rev.invariant <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invariant_iff_pos_and_neg_invariant rev.invariant_iff_pos_and_neg_invariant
    positively_invariant_eq_rev negatively_invariant_eq_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> negatively_invariant_complI<span class="main">:</span> <span class="quoted"><span class="quoted">"negatively_invariant <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> negatively_invariant_def trapped_backward_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">using</span></span> flow_in_domain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> flow0 <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> positively_invariant_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">x</span>›</span></span> flows_reverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> existence_ivl_reverse x<span class="main">(</span>3<span class="main">)</span> x<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trapped_forward_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_subset_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> flow0 <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">∉</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1 a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> negatively_invariant_complD<span class="main">:</span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"negatively_invariant <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev.positively_invariant <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negatively_invariant_eq_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev.negatively_invariant <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev.negatively_invariant_complI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev.negatively_invariant_eq_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Diff_Diff_Int
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_commute positively_invariant_restrict_dom<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_invariant_iff_compl_neg_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">M</span> <span class="main">⟷</span> negatively_invariant <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> negatively_invariant_complI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> negatively_invariant_complD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neg_invariant_iff_compl_pos_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"negatively_invariant <span class="free">M</span> <span class="main">⟷</span> positively_invariant <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auto_ll_on_open.pos_invariant_iff_compl_neg_invariant negatively_invariant_eq_rev positively_invariant_eq_rev rev.auto_ll_on_open_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invariant_iff_compl_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="free">M</span> <span class="main">⟷</span> invariant <span class="main">(</span><span class="free">X</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> invariant_iff_pos_and_neg_invariant neg_invariant_iff_compl_pos_invariant pos_invariant_iff_compl_neg_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> invariant_iff_pos_invariant_and_compl_pos_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="free">M</span> <span class="main">⟷</span> positively_invariant <span class="free">M</span> <span class="main">∧</span> positively_invariant <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_iff_pos_and_neg_invariant neg_invariant_iff_compl_pos_invariant<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tools for proving invariance›</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_left_inter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">C</span> <span class="main">∩</span> <span class="free">D</span><span class="main">.</span> trapped_forward <span class="bound">x</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span><span class="free">C</span> <span class="main">∩</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms positively_invariant_def trapped_forward_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trapped_forward_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> contg<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">V</span> <span class="keyword1">has_derivative</span> <span class="free">V'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⟹</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">V</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapped_forward_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.ivl_subset_existence_ivl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> contV<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> has_derivative_continuous_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">t</span><span class="main">}</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> flow0 <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_compose<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> continuous_on_subset ex local.flow_continuous_on <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Int_subset_iff atLeastAtMost_iff atLeast_iff contg continuous_on_subset ex image_mono subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⟹</span>
         <span class="main">(</span><span class="free">V</span> <span class="main">∘</span> flow0 <span class="free">x</span> <span class="keyword1">has_real_derivative</span> <span class="main">(</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> flow0 <span class="free">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def has_field_derivative_def<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>                              
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> flow_has_derivative<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> has_derivative_compose<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">V</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span>  <span class="main">(</span><span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="main">(</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> has_derivative_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">V</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> linear_cmul<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹linear <span class="main">(</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">V</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> <span class="main">(*)</span> <span class="main">(</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_commute_abs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⟹</span>
         <span class="main">(</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">s</span><span class="main">)</span>  <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> flow0 <span class="free">x</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> flow0 <span class="free">x</span><span class="main">)</span> <span class="bound">s</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">∘</span> flow0 <span class="free">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> comparison_principle_le_linear<span class="main">[</span><span class="operator">OF</span> 1 2 _ 3<span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">V</span> <span class="main">∘</span> flow0 <span class="free">x</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.mem_existence_ivl_iv_defined<span class="main">(</span>2<span class="main">)</span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="free">V</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_le_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> contg<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">D</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">V</span> <span class="keyword1">has_derivative</span> <span class="free">V'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="comment1">(* TODO: domain can be added here too ? *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">V'</span> <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">V</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span><span class="free">D</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>positively_invariant_left_inter<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="skolem">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">D</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> contg continuous_on_subset positively_invariant_def trapped_forward_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trapped_forward_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">V</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">0</span>›</span></span> this assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="skolem">x</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">D</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> positively_invariant_def trapped_forward_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_barrier_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">V</span> <span class="keyword1">has_derivative</span> <span class="free">V'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">D</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">V'</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">V</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">V'</span> <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span><span class="free">D</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>positively_invariant_left_inter<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> contV<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> has_derivative_continuous_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="skolem">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> continuous_on_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="skolem">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">D</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> positively_invariant_def trapped_forward_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> contV'<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="skolem">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">V'</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> continuous_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">x</span> <span class="main">⟹</span>
       <span class="main">0</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span>  max <span class="main">(</span><span class="main">-</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">D</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> positively_invariant_def trapped_forward_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">-</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">-</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="main">-</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_max_iff_disj
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="skolem">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">V'</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">/</span> max <span class="main">(</span><span class="main">-</span> <span class="free">V'</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">continuous_intros</span></span> continuous_on_max <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * contV'<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⟹</span>
        <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
        <span class="main">(</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span>
        <span class="main">/</span> max <span class="main">(</span><span class="main">-</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="main">-</span><span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> max <span class="main">(</span><span class="main">-</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>
      <span class="main">≤</span>  <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult_minus_left mult_minus_right power2_eq_square mult_le_cancel_iff2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
      <span class="main">≤</span>  <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>
      <span class="main">/</span> max <span class="main">(</span><span class="main">-</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p pos_le_divide_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
         <span class="main">≤</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">/</span>
           max <span class="main">(</span><span class="main">-</span> <span class="free">V'</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> trapped_forward_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">V</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">0</span>›</span></span> * assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="skolem">x</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_UNIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> positively_invariant_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_conj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span><span class="free">C</span> <span class="main">∩</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms positively_invariant_def
  <span class="keyword1"><span class="command">using</span></span> positively_invariant_left_inter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> contg<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">V</span> <span class="keyword1">has_derivative</span> <span class="free">V'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">V'</span> <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">V</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> positively_invariant_le_domain<span class="main">[</span><span class="operator">OF</span> positively_invariant_UNIV assms<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span>UNIV <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_barrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">V</span> <span class="keyword1">has_derivative</span> <span class="free">V'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">V'</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">V</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">V'</span> <span class="bound">s</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> positively_invariant_barrier_domain<span class="main">[</span><span class="operator">OF</span> positively_invariant_UNIV assms<span class="main">]</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span>UNIV <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">V</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Limit_Set">
<div class="head">
<h1>Theory Limit_Set</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Limit Sets›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Limit_Set
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Invariance.html">Invariance</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Positive limit point, assuming <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{0..} ⊆ existence_ivl0 x›</span></span></span></span>›</span></span>

<span class="comment1">(* TODO: Perhaps a more intrinsic definition would be better here *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ω_limit_point</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span>
  <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main">∞</span> <span class="main">∧</span> <span class="main">(</span>flow0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∘</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Also called the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ω›</span></span></span></span>-limit set of x ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ω_limit_set</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> ω_limit_point <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">p</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">α_limit_point</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span>
  <span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main">-∞</span> <span class="main">∧</span> <span class="main">(</span>flow0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∘</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Also called the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span>-limit set of x ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">α_limit_set</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
  <span class="main">{</span><span class="bound">p</span><span class="main">.</span> α_limit_point <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">p</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_point_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"α_limit_point <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> rev.ω_limit_point <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> α_limit_point_def rev.ω_limit_point_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_eq_flow<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> o_def filterlim_uminus_at_bot rev_existence_ivl_eq0 subset_iff
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"uminus <span class="keyword1">o</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">s</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> neg_0_le_iff_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_set_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">x</span> <span class="main">=</span> rev.ω_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> α_limit_set_def rev.ω_limit_set_def α_limit_point_eq_rev <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_pointE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">s</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms filterlim_at_top_choose_lower ω_limit_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">.</span> closure <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="bound">τ</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> pt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">t</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_pointE<span class="main">[</span><span class="operator">OF</span> pt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> closure <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">t</span><span class="main">..}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> closure_sequential
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast_iff comp_apply imageI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">τ</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">.</span> closure <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="bound">τ</span><span class="main">..}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span><span class="main">0</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="main">∈</span> closure <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="bound">t</span><span class="main">..}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≥</span><span class="main">0</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">tt</span></span> <span class="main">≥</span> <span class="bound">t</span><span class="main">.</span> dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">tt</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">&lt;</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closure_approachable
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> approachable_sequenceE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_point_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def ω_limit_point_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ω_limit_set_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ω_limit_set_empty closed_INT closed_closure closed_empty<span class="main">)</span>

<span class="comment1">(* TODO: Walter gives a more direct proof *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_positively_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> positively_invariant_def trapped_forward_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dummy</span> <span class="skolem">p</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem_existence_ivl_iv_defined<span class="main">(</span>2<span class="main">)</span> xa<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> exist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xa<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def ω_limit_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> xa<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span>
    <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>ω_limit_pointE<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">+</span> <span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rlim<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">r</span> at_top sequentially"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> filterlim_tendsto_add_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ s<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dom</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dom</span> <span class="main">=</span> image <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> domin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">dom</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">dom</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def o_def
    <span class="keyword1"><span class="command">using</span></span> exist <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">using</span></span> xa<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_trans'<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> exist xa<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> exist  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="skolem">dom</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flow_continuous_on_compose<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>  exist local.dom_def local.flow_in_domain <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> xt <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="skolem">p</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> domin s<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_sequentially
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ff<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def r_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> domin<span class="main">(</span>1<span class="main">)</span> xt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> flow_trans<span class="main">[</span><span class="operator">OF</span> s t<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">+</span> <span class="skolem">s</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="skolem">p</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">unfolding</span></span> ff <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">p</span> <span class="skolem">t</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exist f2 rlim
    <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def ω_limit_point_def
    <span class="keyword1"><span class="command">using</span></span> flow_in_domain r_def s<span class="main">(</span>3<span class="main">)</span> xa<span class="main">(</span>2<span class="main">)</span> xa<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invariant_iff_pos_invariant_and_compl_pos_invariant
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ω_limit_set_positively_invariant <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="main">(</span><span class="free">X</span> <span class="main">-</span> ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> positively_invariant_def trapped_forward_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">using</span></span> local.flow_in_domain <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dummy</span> <span class="skolem">p</span> <span class="skolem">t</span> 
    <span class="keyword3"><span class="command">assume</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> ω_limit_set <span class="free">x</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">p</span> <span class="skolem">t</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> exist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f
      <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def ω_limit_point_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> f
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span>
      <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="skolem">p</span> <span class="skolem">t</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>ω_limit_pointE<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="skolem">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">-</span><span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> filterlim_tendsto_add_at_top<span class="main">[</span><span class="operator">OF</span> this s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> rlim<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">r</span> at_top sequentially"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dom</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dom</span> <span class="main">=</span> image <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="skolem">t</span><span class="main">..}</span> <span class="main">∪</span> <span class="main">{</span>flow0 <span class="skolem">p</span> <span class="skolem">t</span><span class="main">}</span> "</span></span>
    <span class="keyword1"><span class="command">have</span></span> domin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">dom</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">p</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">dom</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def o_def
      <span class="keyword1"><span class="command">using</span></span> exist <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> xt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom</span> <span class="main">⟹</span> <span class="main">-</span><span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">using</span></span> xa<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> local.existence_ivl_reverse xa<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exist atLeast_iff diff_conv_add_uminus diff_ge_0_iff_ge linordered_ab_group_add_class.zero_le_double_add_iff_zero_le_single_add local.existence_ivl_trans' order_trans subset_iff xa<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="skolem">dom</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flow_continuous_on_compose<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> local.mem_existence_ivl_iv_defined<span class="main">(</span>2<span class="main">)</span> xt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xt<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="main">(</span>flow0 <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> domin s<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_sequentially
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> ff<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> o_def r_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> exist <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeast_iff order_trans subset_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> domin<span class="main">(</span>1<span class="main">)</span> xt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> flow_trans<span class="main">[</span><span class="operator">OF</span> s t<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span> <span class="main">+</span> <span class="skolem">s</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="main">(</span>flow0 <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">unfolding</span></span> ff <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flows_reverse xa<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def ω_limit_point_def
      <span class="keyword1"><span class="command">using</span></span> rlim exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> xa<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_set_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">τ</span> <span class="main">∈</span> <span class="main">{..</span><span class="main">0</span><span class="main">}</span><span class="main">.</span> closure <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{..</span><span class="bound">τ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">folded</span> infinite_rev_existence_ivl0_rewrites<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> α_limit_set_eq_rev rev_flow_image_eq image_uminus_atLeast 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> INT_extend_simps<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> Sup.SUP_cong image_uminus_atMost<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_set_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>α_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> α_limit_set_eq_rev <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev.ω_limit_set_closed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_set_positively_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"negatively_invariant <span class="main">(</span>α_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> negatively_invariant_eq_rev α_limit_set_eq_rev
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev.ω_limit_set_positively_invariant<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_set_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>α_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> invariant_eq_rev α_limit_set_eq_rev
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev.ω_limit_set_invariant<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Fundamental properties of the positive limit set ›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">K</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Bunch of facts for what's to come›</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> props<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"seq_compact <span class="free">K</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trapped_sol_right<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> x K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compact_imp_seq_compact<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> flowimg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span>existence_ivl0 <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> props<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_pointE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span>
    <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> x K props<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> trapped_forward_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> seq_compactE<span class="main">[</span><span class="operator">OF</span> props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fin<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LIMSEQ_subseq_LIMSEQ LIMSEQ_unique<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_compact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_subset 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bounded_subset compact_imp_bounded
    <span class="keyword1"><span class="command">using</span></span> K<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ω_limit_set_closed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compact_eq_bounded_closed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> real<span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x K props<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flowimg image_subset_iff trapped_forward_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> seq_compactE<span class="main">[</span><span class="operator">OF</span> props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> real <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_point_def <span class="keyword1"><span class="command">using</span></span> props<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> comp_def filterlim_sequentially_iff_filterlim_real filterlim_subseq tendsto_at_top_eq_left<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_existence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">⟹</span> existence_ivl0 <span class="bound">y</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ω_limit_set_in_compact_subset K <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">y</span> <span class="main">⟹</span> flow0 <span class="skolem">y</span> <span class="bound">t</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> invariant_def trapped_iff_on_existence_ivl0 <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">y</span> <span class="main">⟹</span> flow0 <span class="skolem">y</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">K</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ω_limit_set_in_compact_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="skolem">y</span> <span class="main">=</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> existence_ivl_zero existence_ivl_initial_time_iff existence_ivl_subset mem_compact_implies_subset_existence_interval subset_antisym K<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_tendsto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword1"><span class="command">from</span></span> not_tendsto_frequentlyE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_top<span class="main">.</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="main">0</span> <span class="skolem">e</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> openE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span><span class="main">0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span> <span class="main">⟶</span>
        infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infdist_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">from</span></span> frequently_mono<span class="main">[</span><span class="operator">OF</span> this S<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_top<span class="main">.</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_top<span class="main">.</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">e</span> <span class="main">∧</span> real <span class="bound">n</span> <span class="main">≤</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventually_frequently_conj<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> frequently_at_topE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">≤</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> real <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filterlim_at_top_mono filterlim_real_sequentially not_eventuallyD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">K</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> x K props<span class="main">(</span>1<span class="main">)</span> s <span class="keyword1"><span class="command">unfolding</span></span> flowimg trapped_forward_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast_iff comp_apply image_subset_iff of_nat_0_le_iff order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> seq_compactE<span class="main">[</span><span class="operator">OF</span> props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"strict_mono <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> filterlim_at_top_strict_mono<span class="main">[</span><span class="operator">OF</span> s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> r<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sf<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> at_top sequentially"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_point_def <span class="keyword1"><span class="command">using</span></span> props<span class="main">(</span>1<span class="main">)</span> calculation
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infdist <span class="skolem">l</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ω_limit_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> infdist <span class="bound">y</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_compose_at<span class="main"><span class="main">[</span></span><span class="operator">OF</span> l<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">≤</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> c1 c2 <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def
    <span class="keyword1"><span class="command">using</span></span> Lim_bounded2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ball_eq_empty centre_in_ball empty_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_connected<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"connected <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> connected_closed_set<span class="main">[</span><span class="operator">OF</span> ω_limit_set_closed<span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Apre</span> <span class="skolem">Bpre</span>
  <span class="keyword3"><span class="command">assume</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="skolem">Apre</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Apre</span> <span class="main">∪</span> <span class="skolem">Bpre</span> <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">Bpre</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Apre</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bpre</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Apre</span> <span class="main">∩</span> <span class="skolem">Bpre</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="comment1">(* TODO: this move is very strange *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Apre</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bpre</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> disj<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> t4_space<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    p<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ω_limit_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_pointE<span class="main">[</span><span class="operator">OF</span> p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">ps</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">ps</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_pointE<span class="main">[</span><span class="operator">OF</span> q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">qs</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">qs</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_top<span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> frequently_at_top
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dummy</span> <span class="skolem">mpre</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="skolem">mpre</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> approximation_preproc_push_neg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gt_ex le_cases order_trans<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> ps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">A</span>›</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> tendsto_def filterlim_at_top eventually_sequentially
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> approximation_preproc_push_neg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> comp_apply gt_ex le_cases order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> qs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">B</span>›</span></span> q <span class="keyword1"><span class="command">unfolding</span></span> tendsto_def filterlim_at_top eventually_sequentially
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> approximation_preproc_push_neg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> comp_apply gt_ex le_cases order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Icc_subset_Ici_iff <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">a</span>›</span></span> approximation_preproc_push_neg<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> atMost_iff atMost_subset_iff continuous_on_subset le_cases local.flow_continuous_on props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> connected_continuous_image<span class="main">[</span><span class="operator">OF</span> this connected_Icc<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"connected <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> topological_space_class.connectedD<span class="main">[</span><span class="operator">OF</span> c <span class="quoted"><span class="quoted">‹open <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">B</span>›</span></span> _ this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a b disj <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="skolem">mpre</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">n</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">n</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mpre</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> a<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> atLeastAtMost_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> frequently_at_topE'<span class="main">[</span><span class="operator">OF</span> this filterlim_real_sequentially<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">K</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeast_iff comp_apply flowimg image_subset_iff of_nat_0_le_iff trapped_forward_def x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> seq_compactE<span class="main">[</span><span class="operator">OF</span> props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s filterlim_at_top_mono filterlim_real_sequentially not_eventuallyD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> filterlim_at_top_strict_mono<span class="main">[</span><span class="operator">OF</span> s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> r<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> at_top sequentially"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_point_def <span class="keyword1"><span class="command">using</span></span> props<span class="main">(</span>1<span class="main">)</span> r
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> r<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹open <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tendsto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> r<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹open <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tendsto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_ω_limit_set_contained<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span><span class="main">.</span> ω_limit_set <span class="bound">y</span> <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ω_limit_set <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_pointE<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">y</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="skolem">y</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>›</span></span> invariant_def
      ω_limit_set_in_compact_existence ω_limit_set_invariant trapped_iff_on_existence_ivl0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> closed_sequential_limits s ω_limit_set_closed
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_set_in_compact_α_limit_set_contained<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> zpx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">z</span> <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> α_limit_set <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">z</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> α_limit_set_def α_limit_point_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="free">z</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ω_limit_set_in_compact_existence<span class="main">[</span><span class="operator">OF</span> zpx<span class="main">]</span> zpx
    <span class="keyword1"><span class="command">using</span></span> invariant_def trapped_iff_on_existence_ivl0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> closed_sequentially<span class="main">[</span><span class="operator">OF</span> ω_limit_set_closed this s<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Fundamental properties of the negative limit set ›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">K</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_backward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> xrev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"rev.trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trapped_backward_iff_rev_trapped_forward x<span class="main">(</span>2<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_existence_ivl_eq0 rev_eq_flow x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_set_in_compact_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> α_limit_set_in_compact_compact<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>α_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> α_limit_set_in_compact_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> α_limit_set_in_compact_connected<span class="main">:</span> <span class="quoted"><span class="quoted">"connected <span class="main">(</span>α_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> α_limit_set_in_compact_α_limit_set_contained<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> α_limit_set <span class="free">x</span><span class="main">.</span> α_limit_set <span class="bound">y</span> <span class="main">⊆</span> α_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> α_limit_set_in_compact_tendsto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> infdist <span class="main">(</span>flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>α_limit_set <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_bot"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_in_compact_subset<span class="main">[</span><span class="operator">OF</span> K xrev<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_in_compact_compact<span class="main">[</span><span class="operator">OF</span> K xrev<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_in_compact_nonempty<span class="main">[</span><span class="operator">OF</span> K xrev<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_in_compact_connected<span class="main">[</span><span class="operator">OF</span> K xrev<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_in_compact_ω_limit_set_contained<span class="main">[</span><span class="operator">OF</span> K xrev<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_in_compact_tendsto<span class="main">[</span><span class="operator">OF</span> K xrev<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> invariant_eq_rev α_limit_set_eq_rev existence_ivl_eq_rev flow_eq_rev0 filterlim_at_bot_mirror
    minus_minus
  <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_set_in_compact_existence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> α_limit_set <span class="free">x</span> <span class="main">⟹</span> existence_ivl0 <span class="bound">y</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev.ω_limit_set_in_compact_existence<span class="main">[</span><span class="operator">OF</span> K xrev<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> α_limit_set_eq_rev existence_ivl_eq_rev0
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Periodic_Orbit">
<div class="head">
<h1>Theory Periodic_Orbit</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Periodic Orbits›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Periodic_Orbit
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../Ordinary_Differential_Equations/ODE_Analysis.html">Ordinary_Differential_Equations.ODE_Analysis</a>
    <a href="Analysis_Misc.html">Analysis_Misc</a>
    <a href="ODE_Misc.html">ODE_Misc</a>
    <a href="Limit_Set.html">Limit_Set</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Definition of closed and periodic orbits and their associated properties ›</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
   TODO: not sure if the "closed orbit" terminology is standard
   Closed orbits have some non-zero recurrence time T where the flow returns to the initial state
   The period of a closed orbit is the infimum of all positive recurrence times
   Periodic orbits are the subset of closed orbits where the period is non-zero
  ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed_orbit</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">T</span> <span class="main">∈</span> existence_ivl0 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="bound">T</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">T</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">period</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
  Inf <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> existence_ivl0 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="bound">T</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">T</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">periodic_orbit</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span>
  closed_orbit <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> period <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recurrence_time_flip_sign<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">T</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="main">-</span><span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms existence_ivl_reverse <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> assms flows_reverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_recurrence_times_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span><span class="main">.</span> <span class="bound">T</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> recurrence_time_flip_sign<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_recurrence_times_bdd_below<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_below <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span><span class="main">.</span> <span class="bound">T</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bdd_below_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> le_cases not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_period_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> period_def
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> recurrence_time_flip_sign<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_in_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def
  <span class="keyword1"><span class="command">using</span></span> local.mem_existence_ivl_iv_defined<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_global_existence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Tp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tp</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tp</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">Tp</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> recurrence_time_flip_sign<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> apos<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> closed_orbit_in_domain assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span><span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">+</span> <span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih
      <span class="keyword1"><span class="command">using</span></span> existence_ivl_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih T <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">+</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ih local.flow_trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l r
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute distrib_left mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> aneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span>real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="main">-</span>real <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> recurrence_time_flip_sign<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">&gt;</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>1<span class="main">)</span> ex_less_of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> apos
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>›</span></span> atLeastAtMost_iff less_eq_real_def local.ivl_subset_existence_ivl subset_eq<span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> real <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">T</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> T<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add.inverse_inverse ex_less_of_nat_mult mult.commute mult_minus_right neg_less_iff_less<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aneg
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> apos atLeastAtMost_iff calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.existence_ivl_trans' local.ivl_subset_existence_ivl mult_minus_left subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recurrence_time_multiples<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">T</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="bound">t</span><span class="main">+</span><span class="free">T</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> ih <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="bound">t</span> <span class="main">+</span> <span class="free">T</span> <span class="main">*</span> real <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_global_existence<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span><span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">+</span> <span class="free">T</span> <span class="main">*</span> real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span><span class="main">+</span><span class="free">T</span><span class="main">*</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add.commute distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span><span class="main">+</span> <span class="free">T</span><span class="main">*</span>real <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.existence_ivl_trans' local.flow_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">T</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I add.commute local.existence_ivl_trans' local.flow_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">+</span> <span class="free">T</span> <span class="main">*</span> real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nasty_arithmetic1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">T</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> floor <span class="main">(</span><span class="free">t</span> <span class="main">/</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> floor_divide_lower<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ql<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="free">T</span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> floor_divide_upper<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> qu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">t</span> <span class="main">-</span> <span class="skolem">q</span> <span class="main">*</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rl<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ql <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ru<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qu <span class="keyword1"><span class="command">unfolding</span></span> r_def  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> q r_def rl ru
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse of_int_of_nat_eq plus_int_code<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ql that zle_iff_zadd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nasty_arithmetic2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">T</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q</span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="free">T</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> nasty_arithmetic1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> qr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="free">T</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">+</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="free">T</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">T</span><span class="main">-</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> qr<span class="main">(</span>2-3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> real <span class="skolem">q</span> <span class="main">*</span> <span class="main">-</span> <span class="free">T</span> <span class="main">-</span> <span class="skolem">r</span>›</span></span> that<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recurrence_time_restricts_compact_flow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">T</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">T</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> nasty_arithmetic1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> qr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="free">T</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> recurrence_time_multiples<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add.commute mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">T</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> nasty_arithmetic2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> qr<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="free">T</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">T</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="main">-</span><span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> recurrence_time_flip_sign assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> recurrence_time_multiples<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute qr<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">T</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">T</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbitI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms local.existence_ivl_reverse local.existence_ivl_trans local.flow_trans local.flows_reverse<span class="main">)</span>

<span class="comment1">(* TODO: can be considerably generalized *)</span>
<span class="keyword1"><span class="command">lemma</span></span> flow0_image_UNIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">t</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I add.commute assms image_eqI local.existence_ivl_trans' local.flow_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I add.commute assms imageI local.existence_ivl_trans' local.flow_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> recurrence_time_restricts_compact_flow'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">=</span> flow0 <span class="free">y</span> <span class="main">`</span> <span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> closed_orbitI inf.strict_order_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_global_existence<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> yex<span class="main">:</span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">y</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">t'</span><span class="main">-</span> <span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">y</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2-3<span class="main"><span class="main">)</span></span> local.existence_ivl_trans'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">-</span><span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">t'</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> local.flow_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">from</span></span> recurrence_time_restricts_compact_flow<span class="main">[</span><span class="operator">OF</span> a1 a2 a3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">`</span> UNIV <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span> <span class="free">t'</span><span class="main">-</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> flow0_image_UNIV<span class="main">[</span><span class="operator">OF</span> yex<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"UNIV"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eql<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">`</span> UNIV <span class="main">=</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute surj_def surj_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> flow0_image_UNIV<span class="main">[</span><span class="operator">OF</span> yex<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t'</span><span class="main">-</span><span class="free">t</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eqr<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span> <span class="free">t'</span><span class="main">-</span><span class="free">t</span><span class="main">}</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="main">`</span> <span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq eql eqr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbitE'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="bound">t</span><span class="main">+</span><span class="free">T</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Tp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tp</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tp</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">Tp</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> recurrence_time_flip_sign<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>  recurrence_time_multiples T that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="bound">t</span><span class="main">+</span><span class="free">T</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closed_orbitE'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms mult.commute reals_Archimedean3<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_flow_compact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compact<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Tp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tp</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tp</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">Tp</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">T</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> recurrence_time_flip_sign<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> recurrence_time_restricts_compact_flow<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> feq<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">T</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">T</span><span class="main">}</span> <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> T<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> continuous_on_sequentially in_mono local.flow_continuous_on local.ivl_subset_existence_ivl<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> compact_continuous_image<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">T</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> feq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixed_point_imp_closed_orbit_period_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fixpoint_sol<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fp<span class="main">:</span><span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> co<span class="main">:</span><span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">T</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> fp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dense<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> cInf_le_iff<span class="main">[</span><span class="operator">OF</span> closed_orbit_recurrence_times_nonempty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> co<span class="main"><span class="main">]</span></span>
      closed_orbit_recurrence_times_bdd_below <span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> period_def <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_period_nonneg<span class="main">[</span><span class="operator">OF</span> co<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹period <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> co <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_period_zero_fixed_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> regular_locally_noteq<span class="main">[</span><span class="operator">OF</span> closed_orbit_in_domain<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">x</span> "</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> dist <span class="bound">t</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="main">⟶</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eventually_at
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">≥</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> period_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> closed_orbit_def linorder_neqE_linordered_idom neg_0_less_iff_less recurrence_time_flip_sign<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_subset_ω_limit_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def ω_limit_point_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbitE'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="bound">t</span> <span class="main">+</span> <span class="skolem">T</span><span class="main">*</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="bound">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">t</span> <span class="main">+</span> <span class="skolem">T</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> exist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms closed_orbit_global_existence<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span><span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s_def
    <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>filterlim_tendsto_add_at_top filterlim_tendsto_pos_mult_at_top
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filterlim_real_sequentially<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def s_def <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="free">x</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main">∞</span> <span class="main">∧</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="free">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exist l r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_ω_limit_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> flow0 <span class="free">x</span> <span class="main">`</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_orbit_global_existence<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ω_limit_set_in_compact_subset<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flow_in_domain
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms closed_orbit_in_domain image_subset_iff trapped_forward_def
        closed_orbit_flow_compact<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> closed_orbit_subset_ω_limit_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow0_inj_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">&lt;</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t'</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">s</span> <span class="main">≠</span> flow0 <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">u</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uv<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> recurrence_time_restricts_compact_flow'<span class="main">[</span><span class="operator">OF</span> this _ _ uv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">u</span><span class="main">..</span><span class="skolem">v</span><span class="main">}</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> uv<span class="main">(</span>1-2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">u</span><span class="main">..</span><span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∨</span> flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">u</span><span class="main">..</span><span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff image_iff uv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> uv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> uv assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> recurrence_time_restricts_compact_flow'<span class="main">[</span><span class="operator">OF</span> this _ _ <span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">v</span><span class="main">..</span><span class="skolem">u</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subset_iff uv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> uv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> uv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">v</span><span class="main">..</span><span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∨</span> flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">v</span><span class="main">..</span><span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff image_iff uv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> uv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> uv assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Probably has a simpler proof *)</span>
<span class="keyword1"><span class="command">lemma</span></span> finite_ω_limit_set_in_compact_imp_unique_fixed_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> connected_finite_iff_sing<span class="main">[</span><span class="operator">OF</span> ω_limit_set_in_compact_connected<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ω_limit_set_in_compact_nonempty assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> fy<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_existence<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> yex<span class="main">:</span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="skolem">y</span> <span class="main">=</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.mem_existence_ivl_iv_defined<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> regular_locally_noteq<span class="main">[</span><span class="operator">OF</span> this fy<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> flow0 <span class="skolem">y</span> <span class="bound">t</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> dist <span class="bound">t</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="main">⟶</span> flow0 <span class="skolem">y</span> <span class="bound">t</span> <span class="main">≠</span> flow0 <span class="skolem">y</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eventually_at <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span> <span class="main">⟹</span> flow0 <span class="skolem">y</span> <span class="bound">s</span> <span class="main">≠</span> flow0 <span class="skolem">y</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> flow0_inj_on<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"inj_on<span class="main">(</span>flow0 <span class="skolem">y</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r yex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>flow0 <span class="skolem">y</span><span class="main">`</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_image_iff r<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">`</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">r</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y yex
      <span class="keyword1"><span class="command">unfolding</span></span> invariant_def trapped_iff_on_existence_ivl0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> y
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> finite.emptyI subset_singleton_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_periodic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_orbit_def
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_period_nonneg<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nneg<span class="main">:</span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> period <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_period_zero_fixed_point<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> periodic_orbitI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> local.mem_existence_ivl_iv_defined<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbitI<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_periodic<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> periodic_orbit_recurrence_times_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span><span class="main">.</span> <span class="bound">T</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms closed_orbit_in_domain periodic_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms closed_orbit_in_domain fixed_point_imp_closed_orbit_period_zero<span class="main">(</span>2<span class="main">)</span> periodic_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> regular_locally_noteq<span class="main">[</span><span class="operator">OF</span> a1 a2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> dist <span class="bound">t</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="main">⟶</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eventually_at
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>discrete_imp_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="skolem">t2</span>
    <span class="keyword3"><span class="command">assume</span></span> t12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t1</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">t2</span> <span class="skolem">t1</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fx<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">-</span><span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> a1 assms closed_orbit_global_existence existence_ivl_zero general.existence_ivl_initial_time_iff local.flow_trans periodic_orbit_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">t1</span><span class="main">-</span><span class="skolem">t2</span><span class="main">)</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t12<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r fx
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> periodic_orbit_period<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span>period <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> periodic_orbit_recurrence_times_closed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span><span class="main">.</span> <span class="bound">T</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> periodic_orbit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> closed_contains_Inf<span class="main">[</span><span class="operator">OF</span> closed_orbit_recurrence_times_nonempty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span>
      closed_orbit_recurrence_times_bdd_below cl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">∈</span>  <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span><span class="main">.</span> <span class="bound">T</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="bound">T</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> period_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"period <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span>period <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_flow0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_global_existence<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbitE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">+</span><span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I <span class="quoted"><span class="quoted">‹existence_ivl0 <span class="free">x</span> <span class="main">=</span> UNIV›</span></span> less_irrefl local.existence_ivl_trans' local.flow_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> periodic_orbit_imp_flow0_regular<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I assms closed_orbit_flow0 closed_orbit_global_existence closed_orbit_in_domain fixed_point_imp_closed_orbit_period_zero<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fixpoint_sol<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_irrefl local.flows_reverse periodic_orbit_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fixed_point_imp_ω_limit_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms fixed_point_imp_closed_orbit_period_zero<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> closed_orbit_ω_limit_set<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fixpoint_sol<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_empty image_insert image_subset_iff insertI1 rangeI subset_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_eq_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span> <span class="main">=</span> rev.closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_def rev.closed_orbit_def rev_eq_flow rev_existence_ivl_eq0
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_orbit_α_limit_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_orbit <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">`</span> UNIV <span class="main">=</span> α_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev.closed_orbit_ω_limit_set assms
  <span class="keyword1"><span class="command">unfolding</span></span> closed_orbit_eq_rev α_limit_set_eq_rev flow_image_eq_rev range_uminus <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixed_point_imp_α_limit_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rev.fixed_point_imp_ω_limit_set assms
  <span class="keyword1"><span class="command">unfolding</span></span> α_limit_set_eq_rev
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_α_limit_set_in_compact_imp_unique_fixed_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>  <span class="quoted"><span class="quoted">"trapped_backward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>α_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rev.finite_ω_limit_set_in_compact_imp_unique_fixed_point<span class="main">[</span><span class="operator">OF</span>
      assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> trapped_backward_iff_rev_trapped_forward α_limit_set_eq_rev<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> α_limit_set_eq_rev
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Poincare_Bendixson">
<div class="head">
<h1>Theory Poincare_Bendixson</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Poincare Bendixson Theory›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Poincare_Bendixson
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../Ordinary_Differential_Equations/ODE_Analysis.html">Ordinary_Differential_Equations.ODE_Analysis</a>
    <a href="Analysis_Misc.html">Analysis_Misc</a> <a href="ODE_Misc.html">ODE_Misc</a> <a href="Periodic_Orbit.html">Periodic_Orbit</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Flow to Path›</span></span>

<span class="keyword1"><span class="command">context</span></span> auto_ll_on_open <span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* The path along the flow starting at time t to time t' *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">flow_to_path</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> flow0 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∘</span> linepath <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pathstart_flow_to_path<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pathstart <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flow_to_path_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathstart_compose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pathfinish_flow_to_path<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flow_to_path_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathfinish_compose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flow_to_path_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span> <span class="free">s</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flow_to_path_def o_def linepath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subpath0_flow_to_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subpath <span class="main">0</span> <span class="free">u</span> <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">u</span><span class="main">*</span><span class="main">(</span><span class="free">t'</span><span class="main">-</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flow_to_path_def subpath_image subpath0_linepath
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> path_image_flow_to_path<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flow_to_path_def path_image_compose path_image_linepath
  <span class="keyword1"><span class="command">using</span></span> assms real_Icc_closed_segment <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flow_to_path_image0_right_open<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span><span class="main">{</span><span class="free">t</span><span class="main">..&lt;</span><span class="free">t'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flow_to_path_def image_comp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> linepath_image0_right_open_real<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flow_to_path_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> subset_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">xa</span> <span class="main">⟹</span> <span class="bound">xa</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span>  <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="bound">xa</span> <span class="main">*</span> <span class="free">t'</span> <span class="main">≤</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> convex_bound_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">xa</span> <span class="main">⟹</span> <span class="bound">xa</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="bound">xa</span> <span class="main">*</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_left' diff_diff_eq2 diff_le_eq mult.commute mult.right_neutral mult_right_mono right_diff_distrib'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">xa</span> <span class="main">⟹</span> <span class="bound">xa</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="main">+</span> <span class="bound">xa</span> <span class="main">*</span> <span class="free">t'</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_def flow_to_path_def linepath_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span><span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow_to_path_arc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t</span><span class="main">&lt;..&lt;</span><span class="free">t'</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s</span> <span class="main">≠</span> flow0 <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">≠</span> flow0 <span class="free">x</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arc <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> arc_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">from</span></span> flow_to_path_path<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>flow_to_path <span class="free">x</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flow_to_path_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comp_inj_on<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> inj_on_linepath<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms path_image_linepath<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>flow0_inj_on<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> flow0_inj_on greaterThanLessThan_iff linepath_image_01 real_Icc_closed_segment <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> c1_on_open_R2 <span class="main">=</span> c1_on_open_euclidean <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="free">X</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>executable_euclidean_space <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dim2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹2D Line segments›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Line segments are specified by two endpoints
      The closed line segment from x to y is given by the set {x--y}
      and {x&lt;--&lt;y} for the open segment›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Rotates a vector clockwise 90 degrees ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rot</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eucl_of_list <span class="main">[</span>nth_eucl <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">1</span><span class="main">,</span> <span class="main">-</span>nth_eucl <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">0</span><span class="main">]</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exhaust2_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_2_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> sum2_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="main">0</span> <span class="main">+</span> <span class="free">P</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> vec_simps <span class="main">=</span>
  eucl_eq_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span> dim2 eucl_of_list_eucl_nth exhaust2_nat
  plus_nth_eucl
  minus_nth_eucl
  uminus_nth_eucl
  scaleR_nth_eucl
  inner_nth_eucl
  sum2_nat
  <span class="dynamic"><span class="dynamic">algebra_simps</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_expand<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">-</span><span class="free">y</span> <span class="main">=</span> <span class="main">(</span>eucl_of_list <span class="main">[</span><span class="free">x</span><span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span><span class="main">0</span> <span class="main">-</span> <span class="free">y</span><span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span><span class="main">0</span><span class="main">,</span> <span class="free">x</span><span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span><span class="main">1</span> <span class="main">-</span> <span class="free">y</span><span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dot_ortho<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∙</span> rot <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rot_def minus_expand
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nrm_dot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rot_def minus_expand
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nrm_reverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">a</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">y</span><span class="main">-</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rot_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_rot<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>rot <span class="free">v</span><span class="main">)</span> <span class="main">=</span> norm <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">v</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rot_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec_simps norm_nth_eucl L2_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rot_rot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rot <span class="main">(</span>rot <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rot_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rot_scaleR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rot <span class="main">(</span> <span class="free">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span>  <span class="free">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>rot <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rot_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rot_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rot <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rot_scaleR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rot_eq_0_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rot <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rot_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def norm_eq_zero norm_rot norm_zero rot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> rot_0 rot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_segment_inner_rot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_add_left nrm_dot<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inner_rot_in_segment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="free">a</span> <span class="main">+</span> <span class="bound">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span>
    x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">=</span>
      <span class="main">(</span><span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">/</span>
      <span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">≠</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span> <span class="main">+</span> <span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rot_def vec_simps <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span>  <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">-</span>  <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    "</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">-</span>  <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_simps x0 <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ab_semigroup_mult_class.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult.commute sum_sqs_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute mult.left_commute sum_sqs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="main">-</span>  <span class="free">a</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_simps x1 <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ab_semigroup_mult_class.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult.commute sum_sqs_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute mult.left_commute sum_sqs_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_open_segment_iff_rot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">∙</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;..&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> open_segment_line_hyperplanes<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nrm_dot <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inner_rot_in_segment<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_open_segment_rotD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">∙</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;..&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> in_open_segment_iff_rot<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_closed_segment_iff_rot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">∙</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">..</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_line_hyperplanes<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nrm_dot <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inner_rot_in_segment<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_segment_inner_rot2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_add_left <span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_diff_cancel_left' in_segment_inner_rot inner_diff_left minus_diff_eq nrm_reverse that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> y<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_segment_surface<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">∙</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">..</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_closed_segment_iff_rot<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rot_diff_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span>rot<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rot_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def minus_diff_eq rot_def rot_rot<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bijection Real-Complex for Jordan Curve Theorem›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">complex_of</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span><span class="main">0</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="keyword1">$<span class="hidden">⇩</span><sub>e</sub></span><span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">real_of</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>complex<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eucl_of_list <span class="main">[</span>Re <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Im <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> complex_of_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linear complex_of"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complex_of_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>linearI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left plus_nth_eucl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_real_def scaleR_add_right scaleR_nth_eucl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> complex_of_bounded_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_linear complex_of"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complex_of_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>bounded_linearI' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left plus_nth_eucl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_real_def scaleR_add_right scaleR_nth_eucl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> real_of_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linear real_of"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_of_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>linearI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> real_of_bounded_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_linear real_of"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_of_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>bounded_linearI' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> complex_of_real_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>complex_of <span class="main">∘</span> real_of<span class="main">)</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complex_of_def real_of_def
  <span class="keyword1"><span class="command">using</span></span> complex_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> real_of_complex_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>real_of <span class="main">∘</span> complex_of<span class="main">)</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> complex_of_def real_of_def
  <span class="keyword1"><span class="command">using</span></span> complex_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> complex_of_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>complex_of<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> o_bij<span class="main">[</span><span class="operator">OF</span> real_of_complex_of complex_of_real_of<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> real_of_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>real_of<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> o_bij<span class="main">[</span><span class="operator">OF</span> complex_of_real_of real_of_complex_of<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> real_of_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>real_of<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> real_of_bij
  <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Jordan_curve_R2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"simple_path <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="free">c</span> <span class="main">=</span> pathstart <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">inside</span> <span class="free">outside</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">inside</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">inside</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="free">inside</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">outside</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="free">outside</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="free">outside</span>"</span></span>
    <span class="quoted"><span class="quoted">"bounded <span class="free">inside</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="free">outside</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">inside</span> <span class="main">∩</span> <span class="free">outside</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">inside</span> <span class="main">∪</span> <span class="free">outside</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="free">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="free">inside</span> <span class="main">=</span> path_image <span class="free">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="free">outside</span> <span class="main">=</span> path_image <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> simple_path_linear_image_eq<span class="main">[</span><span class="operator">OF</span> complex_of_linear<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"simple_path <span class="main">(</span>complex_of <span class="main">∘</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> complex_of_bij
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"pathfinish <span class="main">(</span>complex_of <span class="main">∘</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> pathstart <span class="main">(</span>complex_of <span class="main">∘</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pathstart_compose pathfinish_compose<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Jordan_curve<span class="main">[</span><span class="operator">OF</span> a1 a2<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">inside</span></span> <span class="skolem"><span class="skolem">outside</span></span> <span class="keyword2"><span class="keyword">where</span></span> io<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">inside</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">inside</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="skolem">inside</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">outside</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">outside</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="skolem">outside</span>"</span></span>
    <span class="quoted"><span class="quoted">"bounded <span class="skolem">inside</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="skolem">outside</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inside</span> <span class="main">∩</span> <span class="skolem">outside</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">inside</span> <span class="main">∪</span> <span class="skolem">outside</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="main">(</span>complex_of <span class="main">∘</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="skolem">inside</span> <span class="main">=</span> path_image <span class="main">(</span>complex_of <span class="main">∘</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="skolem">outside</span> <span class="main">=</span> path_image <span class="main">(</span>complex_of <span class="main">∘</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rin</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of <span class="main">`</span> <span class="skolem">inside</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rout</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of <span class="main">`</span> <span class="skolem">outside</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inside</span> <span class="main">=</span> complex_of <span class="main">`</span> <span class="var">?rin</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complex_of_real_of <span class="keyword1"><span class="command">unfolding</span></span> image_comp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">outside</span> <span class="main">=</span> complex_of <span class="main">`</span> <span class="var">?rout</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complex_of_real_of <span class="keyword1"><span class="command">unfolding</span></span> image_comp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image<span class="main">(</span>complex_of <span class="main">∘</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> complex_of <span class="main">`</span> <span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_image_compose<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rin</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> open_bijective_linear_image_eq<span class="main">[</span><span class="operator">OF</span> real_of_linear real_of_bij<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="var">?rin</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> connected_linear_image<span class="main">[</span><span class="operator">OF</span> real_of_linear<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connected <span class="var">?rin</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rout</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> open_bijective_linear_image_eq<span class="main">[</span><span class="operator">OF</span> real_of_linear real_of_bij<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="var">?rout</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> connected_linear_image<span class="main">[</span><span class="operator">OF</span> real_of_linear<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connected <span class="var">?rout</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bounded_linear_image<span class="main">[</span><span class="operator">OF</span> io<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> real_of_bounded_linear<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded <span class="var">?rin</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bounded_linear_image<span class="main">[</span><span class="operator">OF</span> _ complex_of_bounded_linear<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="var">?rout</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io<span class="main">(</span>8<span class="main">)</span> o
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> image_Int<span class="main">[</span><span class="operator">OF</span> real_of_inj<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rin</span> <span class="main">∩</span> <span class="var">?rout</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bij_image_Compl_eq<span class="main">[</span><span class="operator">OF</span> complex_of_bij<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rin</span> <span class="main">∪</span> <span class="var">?rout</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io<span class="main">(</span>10<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> c
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> id_apply image_Un image_comp image_cong image_ident real_of_complex_of<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> closure_injective_linear_image<span class="main">[</span><span class="operator">OF</span> real_of_linear real_of_inj<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frontier <span class="var">?rin</span> <span class="main">=</span> path_image <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io<span class="main">(</span>11<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> frontier_closures c
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">B</span> <span class="bound">A</span><span class="main">.</span> real_of <span class="main">`</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> real_of <span class="main">`</span> <span class="bound">A</span> <span class="main">∩</span> real_of <span class="main">`</span> <span class="bound">B</span>›</span></span> bij_image_Compl_eq c calculation<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> compl_sup double_compl io<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> real_of_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> closure_injective_linear_image<span class="main">[</span><span class="operator">OF</span> real_of_linear real_of_inj<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frontier <span class="var">?rout</span> <span class="main">=</span> path_image <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> io<span class="main">(</span>12<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> frontier_closures c
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">B</span> <span class="bound">A</span><span class="main">.</span> real_of <span class="main">`</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> real_of <span class="main">`</span> <span class="bound">A</span> <span class="main">∩</span> real_of <span class="main">`</span> <span class="bound">B</span>›</span></span> bij_image_Compl_eq c calculation<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> frontier_closures io<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> real_of_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> bounded <span class="main">(</span>real_of <span class="main">`</span> <span class="skolem">outside</span><span class="main">)</span>›</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* copied *)</span>
<span class="keyword1"><span class="command">corollary</span></span> Jordan_inside_outside_R2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"simple_path <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="free">c</span> <span class="main">=</span> pathstart <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
          open<span class="main">(</span>inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          connected<span class="main">(</span>inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
          open<span class="main">(</span>outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          connected<span class="main">(</span>outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          bounded<span class="main">(</span>inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">¬</span> bounded<span class="main">(</span>outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">∩</span> outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
          inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">∪</span> outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">-</span> path_image <span class="free">c</span> <span class="main">∧</span>
          frontier<span class="main">(</span>inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> path_image <span class="free">c</span> <span class="main">∧</span>
          frontier<span class="main">(</span>outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> path_image <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">inner</span></span> <span class="skolem"><span class="skolem">outer</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inner</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">inner</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="skolem">inner</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">outer</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">outer</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="skolem">outer</span>"</span></span>
      <span class="quoted"><span class="quoted">"bounded <span class="skolem">inner</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="skolem">outer</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inner</span> <span class="main">∩</span> <span class="skolem">outer</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">inner</span> <span class="main">∪</span> <span class="skolem">outer</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="free">c</span>"</span></span>
      <span class="quoted"><span class="quoted">"frontier <span class="skolem">inner</span> <span class="main">=</span> path_image <span class="free">c</span>"</span></span>
      <span class="quoted"><span class="quoted">"frontier <span class="skolem">outer</span> <span class="main">=</span> path_image <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Jordan_curve_R2 <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> inner<span class="main">:</span> <span class="quoted"><span class="quoted">"inside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">inner</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.antisym inside_subset interior_eq interior_inside_frontier<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> outer<span class="main">:</span> <span class="quoted"><span class="quoted">"outside<span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">outer</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">inner</span> <span class="main">∪</span> <span class="skolem">outer</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="free">c</span>›</span></span> <span class="quoted"><span class="quoted">‹inside <span class="main">(</span>path_image <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">inner</span>›</span></span>
      outside_inside <span class="quoted"><span class="quoted">‹<span class="skolem">inner</span> <span class="main">∩</span> <span class="skolem">outer</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner outer<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jordan_points_inside_outside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> jordan<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_path <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="free">p</span> <span class="main">=</span> pathstart <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> path_image <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> inside <span class="main">(</span>path_image <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="free">e</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> outside <span class="main">(</span>path_image <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Jordan_inside_outside_R2<span class="main">[</span><span class="operator">OF</span> jordan<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> frontier<span class="main">(</span>inside <span class="main">(</span>path_image <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    xo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> frontier<span class="main">(</span>outside <span class="main">(</span>path_image <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> inside <span class="main">(</span>path_image <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span>›</span></span> xi
    <span class="keyword1"><span class="command">unfolding</span></span> frontier_straddle
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> outside <span class="main">(</span>path_image <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span>›</span></span> xo
    <span class="keyword1"><span class="command">unfolding</span></span> frontier_straddle
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> y z that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> eventually_at_open_segment<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot<span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">&lt;..&lt;</span><span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_open_segment_iff_rot<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">&lt;..&lt;</span><span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> topological_tendstoD<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_open_segment_iff_rot<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main"><span class="main">]</span></span> nrm_reverse<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> dist_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linepath_ball<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="free">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot<span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> eventually_at_open_segment<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at in_open_segment_iff_rot dist_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linepath_ball_inside_outside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> jordan<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_path <span class="main">(</span><span class="free">p</span> <span class="main">+++</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="free">p</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"pathstart <span class="free">p</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="free">e</span> <span class="main">∩</span> path_image <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="free">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> inside <span class="main">(</span>path_image <span class="main">(</span><span class="free">p</span> <span class="main">+++</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     ball <span class="free">x</span> <span class="free">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> outside <span class="main">(</span>path_image <span class="main">(</span><span class="free">p</span> <span class="main">+++</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∨</span> 
     ball <span class="free">x</span> <span class="free">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> inside <span class="main">(</span>path_image <span class="main">(</span><span class="free">p</span> <span class="main">+++</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     ball <span class="free">x</span> <span class="free">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> outside <span class="main">(</span>path_image <span class="main">(</span><span class="free">p</span> <span class="main">+++</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+++</span> linepath <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pp<span class="main">:</span><span class="quoted"><span class="quoted">"path <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jordan path_join pathfinish_linepath simple_path_imp_path
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="free">p</span> <span class="main">∩</span> path_image <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> jordan simple_path_join_loop_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_commute path_join_path_ends path_linepath simple_path_imp_path simple_path_joinE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> path_image <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> path_image_linepath
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffE Int_iff le_iff_inf open_segment_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> path_image <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_not_in_closed<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_path_image <span class="quoted"><span class="quoted">‹path <span class="free">p</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_at_open_segment<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> path_image <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="skolem">e</span> <span class="main">∩</span> path_image <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> path_image <span class="free">p</span>›</span></span> x in_open_segment_rotD<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at subset_iff dist_commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff all_not_in_conv dist_commute mem_ball<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"pathfinish <span class="var">?lp</span> <span class="main">=</span> pathstart <span class="var">?lp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jordan<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> path_image <span class="var">?lp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> jordan<span class="main">(</span>1<span class="main">)</span> open_closed_segment path_image_join path_join_path_ends simple_path_imp_path x <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> jordan_points_inside_outside<span class="main">[</span><span class="operator">OF</span> e<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> jordan<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a1 this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> inside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">e</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> outside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> jordancurve<span class="main">:</span>
    <span class="quoted"><span class="quoted">"inside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span> <span class="main">∩</span> outside<span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="main">(</span>inside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> path_image <span class="var">?lp</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="main">(</span>outside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> path_image <span class="var">?lp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Jordan_inside_outside_R2<span class="main">[</span><span class="operator">OF</span> jordan<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> ball <span class="free">x</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">=</span> ball <span class="free">x</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b3</span> <span class="main">=</span> ball <span class="free">x</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> convex_imp_path_connected convex_Int <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inner_diff_left<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> convex_halfspace_gt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"rot<span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span>"</span></span><span class="main">]</span> inner_commute
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_connected <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b2_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> convex_imp_path_connected convex_Int <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inner_diff_left<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> convex_halfspace_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rot<span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span><span class="main">]</span> inner_commute
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∩</span> path_image<span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_image_linepath b1_def
    <span class="keyword1"><span class="command">using</span></span> closed_segment_surface<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main">]</span> in_segment_inner_rot2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b1i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∩</span> path_image <span class="var">?lp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD2 b1_def disjoint_iff_not_equal e<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_in_path_image_join<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∩</span> path_image<span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_image_linepath b2_def
    <span class="keyword1"><span class="command">using</span></span> closed_segment_surface<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main">]</span> in_segment_inner_rot2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b2i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∩</span> path_image <span class="var">?lp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD2 b2_def disjoint_iff_not_equal e<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_in_path_image_join<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bsplit<span class="main">:</span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="skolem">e</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="main">∪</span> <span class="skolem">b2</span> <span class="main">∪</span> <span class="skolem">b3</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> b1_def b2_def b3_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∉</span> <span class="skolem">b3</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">b3</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b3_def <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> path_image<span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_segment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> path_image <span class="var">?lp</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jordan<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_image_join<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> z
      <span class="keyword1"><span class="command">using</span></span> inside_Un_outside <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">b1</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z bsplit <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="skolem">b3</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">b3</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b3_def <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> path_image<span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_segment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> path_image <span class="var">?lp</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jordan<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> path_image_join<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> y
      <span class="keyword1"><span class="command">using</span></span> inside_Un_outside <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">b1</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y bsplit <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">b1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∩</span> inside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹path_connected <span class="skolem">b1</span>›</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">⊆</span> inside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> jordancurve <span class="keyword1"><span class="command">using</span></span> b1i
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">b2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jordancurve<span class="main">(</span>1<span class="main">)</span> z<span class="main">(</span>1<span class="main">)</span> z12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∩</span> outside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹path_connected <span class="skolem">b2</span>›</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">⊆</span> outside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> jordancurve <span class="keyword1"><span class="command">using</span></span> b2i
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> conjI<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">b2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">∩</span> inside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹path_connected <span class="skolem">b2</span>›</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">⊆</span> inside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> jordancurve <span class="keyword1"><span class="command">using</span></span> b2i
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jordancurve<span class="main">(</span>1<span class="main">)</span> z<span class="main">(</span>1<span class="main">)</span> z12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">∩</span> outside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹path_connected <span class="skolem">b1</span>›</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">⊆</span> outside <span class="main">(</span>path_image <span class="var">?lp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> jordancurve <span class="keyword1"><span class="command">using</span></span> b1i
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> conjI<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> b1_def b2_def <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">OF</span> e<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transversal Segments›</span></span><span class="comment1">― ‹TODO: Transversal surface in Euclidean space?!›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">transversal_segment</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span>
  <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">--</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">--</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_segment_reverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> transversal_segment_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.left_neutral add_uminus_conv_diff assms closed_segment_commute inner_diff_left inner_zero_left nrm_reverse transversal_segment_def<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> transversal_segment_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> transversal_segment <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> transversal_segment_reverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_segment_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">w</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">z</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ff</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ff</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">s</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ff</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ff_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> fu<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ff</span> <span class="main">1</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ff_def z<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_segment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> transversal_segment_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="skolem">ff</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ff_def 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">continuous_intros</span></span> closed_subsegmentI z <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IVT'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ff</span></span><span class="main">,</span> <span class="operator">OF</span> f0 fu zero_le_one this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ff</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">+</span> <span class="skolem">s</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> closed_subsegmentI z s w<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ff</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> s assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> transversal_segment_def ff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> transversal_segment_sign_less <span class="main">=</span> transversal_segment_neg<span class="main">[</span><span class="operator">OF</span> _ ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_segment_pos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">w</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">z</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> transversal_segment_neg<span class="main">[</span><span class="operator">OF</span> transversal_segment_reverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> w
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rot_diff_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="main">]</span></span> closed_segment_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_segment_posD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> transversal_segment_pos<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_segment_negD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> transversal_segment_neg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_segmentE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> transversal_segment_negD<span class="main">[</span><span class="operator">OF</span> assms ends_in_segment<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> True<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span> <span class="main">--</span> <span class="free">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">--</span><span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rot_diff_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span> not_less order.order_iff_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> transversal_segment_posD<span class="main">[</span><span class="operator">OF</span> assms ends_in_segment<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dist_add_vec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">s</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">v</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> abs <span class="free">s</span> <span class="main">*</span> norm <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_cancel_add1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_segment_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(* Line through x perpendicular to f x *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">::</span>real<span class="main">.</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="bound">s</span><span class="main">/</span>norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> rot <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> zero_less_norm_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> dist <span class="main">(</span><span class="skolem">l</span> <span class="bound">s</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> abs <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def dist_add_vec
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_rot<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"cball <span class="free">x</span> <span class="skolem">d</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> UNIV_I assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.local_unique_solution<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">`</span><span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> cball <span class="free">x</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_le_iff dist_commute image_subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fcontx<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> l_def o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> continuous_at_imp_cball<span class="main">[</span><span class="operator">OF</span> c this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>cball <span class="main">0</span> <span class="skolem">r</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">l</span><span class="main">)</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rc<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="skolem">l</span><span class="main">`</span><span class="main">{</span><span class="main">-</span><span class="skolem">r</span><span class="main">..</span><span class="skolem">r</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> real_norm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dr</span> <span class="main">=</span> min <span class="skolem">r</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">(</span><span class="main">-</span><span class="skolem">dr</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">l</span> <span class="skolem">dr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def dr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span>›</span></span> add_left_imp_eq divide_cancel_right norm_rot norm_zero scale_cancel_right<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> midpoint <span class="main">(</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span><span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> midpoint_def l_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xin<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span><span class="skolem">dr</span><span class="main">)</span><span class="main">&lt;--&lt;</span><span class="main">(</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="comment1">(* TODO: actually this should be equality, but l is affine ...
     also the existing stuff about -- is a little too specific *)</span>
  <span class="keyword1"><span class="command">have</span></span> lsub<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span><span class="skolem">dr</span><span class="main">)</span><span class="main">--</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">l</span><span class="main">`</span><span class="main">{</span><span class="main">-</span><span class="skolem">dr</span><span class="main">..</span><span class="skolem">dr</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">--</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span><span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> in_segment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">dr</span><span class="main">/</span>norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> rot <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span>  <span class="main">(</span><span class="skolem">dr</span><span class="main">/</span>norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> rot <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> l_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_def scaleR_add_right scale_right_diff_distrib u<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">dr</span><span class="main">/</span>norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> rot <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> scaleR_add_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">/</span>norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> rot <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_uminus_conv_diff scaleR_scaleR scale_minus_left times_divide_eq_right<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> zeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">u</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="skolem">dr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> ub<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="numeral">2</span><span class="main">*</span> <span class="skolem">u</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">-</span><span class="main">1</span> <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span> <span class="skolem">u</span> <span class="main">-</span> <span class="main">1</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">l</span> <span class="main">`</span> <span class="main">{</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">..</span><span class="skolem">dr</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zeq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff d<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dr_def image_eqI mult.commute mult_left_le mult_minus_left r<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">--</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lsub
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff d<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dist_commute distl dr_def image_subset_iff mem_cball order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">l</span> <span class="skolem">dr</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="skolem">dr</span><span class="main">/</span>norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> rot <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> scaleR_add_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> req<span class="main">:</span> <span class="quoted"><span class="quoted">"rot <span class="main">(</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">l</span> <span class="skolem">dr</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">dr</span><span class="main">/</span>norm<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> add.inverse_inverse rot_rot rot_scaleR<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">`</span><span class="main">{</span><span class="main">-</span><span class="skolem">dr</span><span class="main">..</span><span class="skolem">dr</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">l</span> <span class="main">`</span> <span class="main">{</span><span class="main">-</span><span class="skolem">r</span> <span class="main">..</span><span class="skolem">r</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dr_def image_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">--</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">l</span> <span class="main">`</span> <span class="main">{</span><span class="main">-</span><span class="skolem">r</span> <span class="main">..</span> <span class="skolem">r</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lsub <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">--</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">dr</span> <span class="main">/</span> norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>›</span></span> d<span class="main">(</span>1<span class="main">)</span> dr_def r<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> t3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">--</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">-</span> <span class="skolem">l</span> <span class="skolem">dr</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> req
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> divide_divide_eq_right inner_scaleR_right mult_2 norm_not_less_zero scaleR_2 times_divide_eq_left times_divide_eq_right zero_less_divide_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="main">(</span><span class="skolem">l</span> <span class="main">(</span><span class="main">-</span><span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="skolem">dr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t1 t2 t3 <span class="keyword1"><span class="command">unfolding</span></span> transversal_segment_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> xin
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Perko Section 3.7 Lemma 2 part 1.›</span></span> 
<span class="keyword1"><span class="command">lemma</span></span> flow_transversal_segment_finite_intersections<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span> <span class="main">..</span> <span class="free">t'</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">s</span></span><span class="main">∈</span><span class="main">{</span><span class="free">t</span><span class="main">..</span><span class="free">t'</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_segment_surface<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> flow_transversal_surface_finite_intersections<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ds<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> blinfun_inner_left <span class="main"><span class="main">(</span></span>rot <span class="main"><span class="main">(</span></span><span class="free"><span class="free">b</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">a</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>
      <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> closed_Collect_conj closed_halfspace_component_ge closed_halfspace_component_le
        <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span>
        <span class="quasi_keyword">simp</span><span class="main">:</span> transversal_segment_def nrm_reverse<span class="main">[</span><span class="operator">where</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">a</span></span><span class="main">]</span> in_closed_segment_iff_rot›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_bound_posE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transversal<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> direction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">d</span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> dist <span class="bound">x</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> transversal_segment_posD<span class="main">[</span><span class="operator">OF</span> transversal direction<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> seg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">z</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> transversal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">─</span><span class="skolem">x</span><span class="main">→</span> <span class="var">?a</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seg <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_const_simps</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> divide_pos_pos mult_pos_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="skolem">x</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_tendstoD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="skolem">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> topological_tendstoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_ident_at open_dom <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_imp_eventually_ne <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="skolem">x</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">x</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="skolem">x</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="var">?a</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?a</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_le dist_commute<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cball <span class="skolem">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="var">?a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> compact_continuous_image<span class="main">[</span><span class="operator">OF</span> this compact_cball<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span><span class="var">?a</span> <span class="main">`</span> cball <span class="skolem">x</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> compact_attains_inf<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> cball <span class="skolem">x</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>cball <span class="skolem">x</span> <span class="skolem">d</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">x</span> <span class="main">≥</span> <span class="var">?a</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">b</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> cball <span class="skolem">x</span> <span class="bound">d</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">x</span> <span class="main">≥</span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dx</span></span> <span class="skolem"><span class="skolem">Bx</span></span> <span class="keyword2"><span class="keyword">where</span></span> dB<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">y</span><span class="main">∈</span>cball <span class="bound">x</span> <span class="main">(</span><span class="skolem">dx</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?a</span> <span class="bound">y</span> <span class="main">≥</span> <span class="skolem">Bx</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">Bx</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">dx</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">dx</span> <span class="bound">x</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> d'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>cball <span class="bound">x</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">y</span> <span class="main">≥</span> <span class="skolem">Bx</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">d'</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dB<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> d'B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>cball <span class="bound">x</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="var">?a</span> <span class="bound">y</span> <span class="main">≥</span> <span class="skolem">Bx</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ball <span class="bound">x</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> compactE_image<span class="main">[</span><span class="operator">OF</span> compact_segment _ this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> ball <span class="bound">x</span> <span class="main">(</span><span class="skolem">d'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X cover <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Min <span class="main">(</span><span class="skolem">d'</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Min <span class="main">(</span><span class="skolem">Bx</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X d'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def d'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X dB
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_const_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≤</span> <span class="var">?a</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xc</span></span> <span class="keyword2"><span class="keyword">where</span></span> xc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xc</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ball <span class="skolem">xc</span> <span class="main">(</span><span class="skolem">d'</span> <span class="skolem">xc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cover <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="skolem">y</span> <span class="main">≥</span> <span class="skolem">Bx</span> <span class="skolem">xc</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dB<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xc</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xc <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">xc</span> <span class="skolem">y</span> <span class="main">≤</span> dist <span class="skolem">xc</span> <span class="skolem">x</span> <span class="main">+</span> dist <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">norm</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">xc</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">d'</span> <span class="skolem">xc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹dist <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">d</span>›</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≤</span> <span class="skolem">d'</span> <span class="skolem">xc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> xc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="skolem">xc</span> <span class="main">+</span> <span class="skolem">d'</span> <span class="skolem">xc</span> <span class="main">=</span> <span class="skolem">dx</span> <span class="skolem">xc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> cball <span class="skolem">xc</span> <span class="main">(</span><span class="skolem">dx</span> <span class="skolem">xc</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≤</span> <span class="skolem">Bx</span> <span class="skolem">xc</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xc
      <span class="keyword1"><span class="command">unfolding</span></span> B_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transversal_bound_negE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transversal<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> direction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">d</span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> dist <span class="bound">x</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> direction <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">b</span> <span class="main">--</span> <span class="free">a</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_commute rot_diff_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> transversal_bound_posE<span class="main">[</span><span class="operator">OF</span> transversal_segment_reverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> transversal<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> dist <span class="bound">x</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∙</span> <span class="main">(</span>rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> leaves_transversal_segmentE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transversal<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">T</span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">-</span><span class="free">T</span><span class="main">..</span><span class="free">T</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">T</span> <span class="main">⟹</span>
    <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">s</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">-</span><span class="free">T</span> <span class="main">≤</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span>
    <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">s</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> transversal_segmentE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> seg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> open_existence_ivl_on_compact<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">-</span> <span class="skolem">t</span><span class="main">..</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> dist <span class="bound">x</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="skolem">B</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">∙</span> rot <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> seg <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">a</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> transversal_bound_posE<span class="main">[</span><span class="operator">OF</span> transversal ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pos<span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> seg <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="free">a</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rot_diff_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> transversal_bound_negE<span class="main">[</span><span class="operator">OF</span> transversal ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ball <span class="bound">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="skolem">B</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">∙</span> rot <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> B<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> split_beta'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> topological_tendstoD <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_mp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> that<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> that <span class="quoted"><span class="quoted">‹open <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> d'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">d'</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> dist <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">d'</span> <span class="bound">x</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at<span class="main">)</span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d2</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">d'</span> <span class="skolem">x</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">d2</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ball <span class="bound">x</span> <span class="main">(</span><span class="skolem">d2</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> compactE_image<span class="main">[</span><span class="operator">OF</span> compact_segment _ C<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C'_cover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span><span class="skolem">C'</span><span class="main">.</span> ball <span class="bound">c</span> <span class="main">(</span><span class="skolem">d2</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> Min <span class="main">(</span>insert <span class="skolem">t</span> <span class="main">(</span><span class="skolem">d2</span> <span class="main">`</span> <span class="skolem">C'</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">t</span>›</span></span> d2 <span class="quoted"><span class="quoted">‹<span class="skolem">C'</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> n
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> T_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">-</span><span class="skolem">T</span><span class="main">..</span><span class="skolem">T</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ t<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> B_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ball <span class="skolem">c'</span> <span class="main">(</span><span class="skolem">d2</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ξ_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">ξ</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">c'</span> <span class="skolem">ξ</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c' <span class="quoted"><span class="quoted">‹<span class="skolem">C'</span> <span class="main">⊆</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ξ</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">d'</span> <span class="skolem">c'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">≤</span> dist <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">+</span> dist <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">norm</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_prod_def dist_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="skolem">ξ</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ξ_le
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d2</span> <span class="skolem">c'</span> <span class="main">+</span> <span class="skolem">d2</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">d'</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">x</span> <span class="skolem">ξ</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> d'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">t</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">-</span><span class="skolem">T</span> <span class="main">..</span> <span class="skolem">T</span><span class="main">}</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> T_ex that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">s'</span> <span class="main">⟹</span> <span class="skolem">s'</span> <span class="main">≤</span> <span class="skolem">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="var">?g</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">has_derivative</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">using</span></span> T_ex that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flowderiv_def <span class="dynamic"><span class="dynamic">blinfun.bilinear_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="skolem">s</span><span class="main">}</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cont <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> mvt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">s</span>›</span></span> cont deriv<span class="main">]</span> that
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ξ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ξ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> continuous_on_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">B</span>›</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> C'_cover that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ball <span class="skolem">c'</span> <span class="main">(</span><span class="skolem">d2</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> B_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> c'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">ξ</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ξ</span> <span class="main">&lt;</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">T</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_prod_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ξ H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span> not_less <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="skolem">s</span> <span class="main">..</span> <span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cont <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> mvt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> cont deriv<span class="main">]</span> that
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ξ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ξ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">ξ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">B</span>›</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">from</span></span> C'_cover that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ball <span class="skolem">c'</span> <span class="main">(</span><span class="skolem">d2</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>flow0 <span class="skolem">x</span> <span class="skolem">ξ</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> B_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> c'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ξ</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">ξ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">ξ</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">d2</span> <span class="skolem">c'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">ξ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ξ</span> <span class="main">&gt;</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">≥</span> <span class="main">-</span> <span class="skolem">T</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_prod_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ξ H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> inner_rot_pos_move_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> in_segment_inner_rot inner_diff_left inner_minus_right minus_diff_eq rot_rot that<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_rot_neg_move_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> in_segment_inner_rot inner_diff_left inner_minus_right minus_diff_eq rot_rot that<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_pos_move_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> y_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inner_neg_move_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">u</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> y_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">…</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rot_same_dir<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">∙</span> rot<span class="main">(</span><span class="free">x1</span><span class="main">-</span><span class="free">x2</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">∙</span> rot<span class="main">(</span><span class="free">x1</span><span class="main">-</span><span class="free">x2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> oriented_subsegment_scale<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> inner_scaleR_right nrm_reverse rot_scaleR zero_less_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> <span class="bound">e</span><span class="main">;</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span> <span class="main">=</span> <span class="bound">e</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x2</span> <span class="main">-</span> <span class="free">x1</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span> inner_minus_right inner_scaleR_right rot_diff_commute rot_scaleR zero_less_mult_iff<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monotone Step Lemma›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow0_transversal_segment_monotone_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&gt;</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> exist <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> t1t2 <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>›</span></span>
    <span class="comment1">(* Basic properties of the segment *)</span>
  <span class="keyword1"><span class="command">have</span></span> x1neqx2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">≠</span> flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_segment_def x2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t1neqt2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≠</span> <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_open_segment_iff_line<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="skolem">i2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> i1 line_open_segment_iff<span class="main">)</span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_closed_segment subset_open_segment x1<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> t12sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ends_in_segment<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> open_closed_segment subset_co_segment subset_eq subset_open_segment x1 x2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> subr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_closed_segment subset_open_segment x2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x1 x2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> open_segment_subsegment<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x1 x2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_closed_segment subset_open_segment x2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subl2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x1 x2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffE DiffI <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>›</span></span> half_open_segment_def insert_iff open_segment_def subset_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sub1b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_closed_segment subset_closed_segment x1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> suba2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_closed_segment subset_closed_segment t12sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suba2o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_closed_segment subset_closed_segment t12sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> x2_notmem<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i1 i2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_line_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> suba12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">--</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>›</span></span> open_closed_segment subset_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suba12_open<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x2_notmem
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_segment_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> suba2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> intereq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">t1</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t2</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span>  <span class="bound">t</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">∨</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">t</span><span class="main">=</span> <span class="free">t1</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t1t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> intereqt12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">t1</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t2</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span>  <span class="bound">t</span> <span class="main">=</span> <span class="free">t1</span> <span class="main">∨</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t12sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* The Jordan curve *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J1</span> <span class="main">=</span> flow_to_path <span class="free">x</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J2</span> <span class="main">=</span> linepath <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="skolem">J1</span> <span class="main">+++</span> <span class="skolem">J2</span>"</span></span>
    <span class="comment1">(* Proof that J is a Jordan curve *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">J</span> <span class="main">=</span> pathstart <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J_def J1_def J2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathstart_compose pathfinish_compose<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> piJ<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">J</span> <span class="main">=</span> path_image <span class="skolem">J1</span> <span class="main">∪</span> path_image <span class="skolem">J2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> J_def J1_def J2_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path_image_join<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">∧</span> flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> atLeastAtMost_iff <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> piD<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">J</span> <span class="main">=</span> path_image <span class="skolem">J1</span> <span class="main">∪</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> piJ J1_def J2_def path_image_flow_to_path<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">]</span>
      path_image_linepath open_segment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Diff_idemp Diff_insert2 Un_Diff_cancel closed_segment_commute mk_disjoint_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s</span> <span class="main">≠</span> flow0 <span class="free">x</span> <span class="free">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x1 t1t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> flow_to_path_arc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist this x1neqx2<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arc <span class="skolem">J1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> J1_def assms flow_to_path_arc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"simple_path <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arc <span class="skolem">J1</span>›</span></span> J1_def J2_def assms x1neqx2 t1neqt2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>simple_path_join_loop<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> intereqt12 closed_segment_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> Jordan_inside_outside_R2<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹pathfinish <span class="skolem">J</span> <span class="main">=</span> pathstart <span class="skolem">J</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">inner</span></span> <span class="skolem"><span class="skolem">outer</span></span> <span class="keyword2"><span class="keyword">where</span></span> inner_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inner</span> <span class="main">=</span> inside <span class="main">(</span>path_image <span class="skolem">J</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> outer_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">outer</span> <span class="main">=</span> outside <span class="main">(</span>path_image <span class="skolem">J</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> io<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">inner</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">inner</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="skolem">inner</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">outer</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">outer</span>"</span></span> <span class="quoted"><span class="quoted">"connected <span class="skolem">outer</span>"</span></span>
    <span class="quoted"><span class="quoted">"bounded <span class="skolem">inner</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="skolem">outer</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inner</span> <span class="main">∩</span> <span class="skolem">outer</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">inner</span> <span class="main">∪</span> <span class="skolem">outer</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="skolem">J</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="skolem">inner</span> <span class="main">=</span> path_image <span class="skolem">J</span>"</span></span>
    <span class="quoted"><span class="quoted">"frontier <span class="skolem">outer</span> <span class="main">=</span> path_image <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> io <span class="keyword1"><span class="command">have</span></span> io2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">outer</span> <span class="main">∩</span> <span class="skolem">inner</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">outer</span> <span class="main">∪</span> <span class="skolem">inner</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> swap_side<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">side2</span> <span class="main">⟹</span>
    <span class="main">0</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="bound">y</span> <span class="main">⟹</span>
    flow0 <span class="bound">y</span> <span class="bound">t</span> <span class="main">∈</span> closure <span class="skolem">side1</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">T</span> <span class="main">∧</span> <span class="bound">T</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">T</span><span class="main">}</span><span class="main">.</span> flow0 <span class="bound">y</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">side2</span><span class="main">)</span> <span class="main">∧</span>
        flow0 <span class="bound">y</span> <span class="bound">T</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">side1</span> <span class="main">∩</span> <span class="skolem">side2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"open <span class="skolem">side2</span>"</span></span>
      <span class="quoted"><span class="quoted">"frontier <span class="skolem">side1</span> <span class="main">=</span> path_image <span class="skolem">J</span>"</span></span>
      <span class="quoted"><span class="quoted">"frontier <span class="skolem">side2</span> <span class="main">=</span> path_image <span class="skolem">J</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">side1</span> <span class="main">∪</span> <span class="skolem">side2</span> <span class="main">=</span> <span class="main">-</span> path_image <span class="skolem">J</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">side1</span> <span class="skolem">side2</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> yt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">side2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="skolem">t</span> <span class="main">∈</span> closure <span class="skolem">side1</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fp</span> <span class="main">=</span> flow_to_path <span class="skolem">y</span> <span class="main">0</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">t</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ivl_subset_existence_ivl yt<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y0<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mem_existence_ivl_iv_defined<span class="main">(</span>2<span class="main">)</span> yt<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tpos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yt<span class="main">(</span>2<span class="main">)</span>  <span class="quoted"><span class="quoted">‹<span class="skolem">side1</span> <span class="main">∩</span> <span class="skolem">side2</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> yt<span class="main">(</span>1<span class="main">)</span> yt<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> closure_iff_nhds_not_empty less_eq_real_def order_refl that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> flow_to_path_path<span class="main">[</span><span class="operator">OF</span> yt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ex<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">fp</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fp_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> closure <span class="skolem">side2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yt<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms closure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"pathstart <span class="skolem">fp</span> <span class="main">∈</span> closure <span class="skolem">side2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fp_def <span class="keyword1"><span class="command">using</span></span> y0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span><span class="quoted"><span class="quoted">"pathfinish <span class="skolem">fp</span> <span class="main">∉</span> <span class="skolem">side2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yt<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">side1</span> <span class="main">∩</span> <span class="skolem">side2</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fp_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> closure_iff_nhds_not_empty that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> subpath_to_frontier_strong<span class="main">[</span><span class="operator">OF</span> a1 a3<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">fp</span> <span class="skolem">u</span> <span class="main">∉</span> interior <span class="skolem">side2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟶</span>
        subpath <span class="main">0</span> <span class="skolem">u</span> <span class="skolem">fp</span> <span class="bound">x</span> <span class="main">∈</span> interior <span class="skolem">side2</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">fp</span> <span class="skolem">u</span> <span class="main">∈</span> closure <span class="skolem">side2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span><span class="quoted"><span class="quoted">"path_image <span class="main">(</span>subpath <span class="main">0</span> <span class="skolem">u</span> <span class="skolem">fp</span><span class="main">)</span> <span class="main">=</span>  flow0 <span class="skolem">y</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span>  <span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fp_def subpath0_flow_to_path <span class="keyword1"><span class="command">using</span></span> path_image_flow_to_path
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> yt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">fp</span> <span class="skolem">u</span> <span class="main">=</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fp_def flow_to_path_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> inout<span class="main">:</span><span class="quoted"><span class="quoted">"interior <span class="skolem">side2</span> <span class="main">=</span> <span class="skolem">side2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹open <span class="skolem">side2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interior_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> iemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">side2</span> <span class="main">∩</span> path_image <span class="skolem">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹frontier <span class="skolem">side2</span> <span class="main">=</span> path_image <span class="skolem">J</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> frontier_disjoint_eq inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> interior_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inout u<span class="main">(</span>3<span class="main">)</span> y0 p2 yt<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tpos u y0  <span class="quoted"><span class="quoted">‹<span class="skolem">side1</span> <span class="main">∩</span> <span class="skolem">side2</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> frontier_disjoint_eq io<span class="main">(</span>5<span class="main">)</span> yt<span class="main">(</span>1<span class="main">)</span> zero_less_mult_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> uim<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">fp</span> <span class="skolem">u</span> <span class="main">∈</span> path_image <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹frontier <span class="skolem">side2</span> <span class="main">=</span> path_image <span class="skolem">J</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ComplI IntI closure_subset frontier_closures inout subsetD<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> u<span class="main">(</span>1-2<span class="main">)</span> tpos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>flow_to_path <span class="skolem">y</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">*</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">side2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> u inout <span class="keyword1"><span class="command">unfolding</span></span> fp_def subpath0_flow_to_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">}</span><span class="main">.</span> flow0 <span class="skolem">y</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">side2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c4<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> path_image <span class="skolem">J</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> uim path_image_join_subset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∉</span> path_image <span class="skolem">J1</span> <span class="main">∨</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> path_image <span class="skolem">J1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">s</span> <span class="main">=</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J1_def <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">t1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="free">t1</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> st1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&gt;</span> <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sc</span> <span class="main">=</span> min <span class="main">(</span><span class="skolem">s</span><span class="main">-</span><span class="free">t1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> scd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">-</span><span class="skolem">sc</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sc_def
          <span class="keyword1"><span class="command">using</span></span> c1 s<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span><span class="main">-</span><span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> path_image <span class="skolem">J1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J1_def path_image_flow_to_path<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span><span class="main">-</span><span class="skolem">sc</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">sc</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> exist atLeastAtMost_iff existence_ivl_trans' flow_trans s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> scd subsetD<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">sc</span><span class="main">)</span>  <span class="main">∈</span> path_image <span class="skolem">J1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>3<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">sc</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sc_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> st1 c1 s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">sc</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> c2 ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span><span class="main">*</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> path_image <span class="skolem">J1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> **
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff diff_existence_ivl_trans ex flow_trans mult_left_le_one_le mult_nonneg_nonneg subset_eq u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> u<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> yt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> b c3 iemp piJ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">*</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">T</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="bound">T</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">T</span><span class="main">}</span><span class="main">.</span> flow0 <span class="skolem">y</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">side2</span><span class="main">)</span> <span class="main">∧</span>
          flow0 <span class="skolem">y</span> <span class="bound">T</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1 c2 c3 c4 <span class="keyword1"><span class="command">unfolding</span></span> piD
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffE UnE ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> half_open_segment_closed_segmentI insertCI open_segment_def x1neqx2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> outside_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">outer</span> <span class="main">⟹</span>
    <span class="main">0</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="bound">y</span> <span class="main">⟹</span>
    flow0 <span class="bound">y</span> <span class="bound">t</span> <span class="main">∈</span> closure <span class="skolem">inner</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">T</span> <span class="main">∧</span> <span class="bound">T</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">T</span><span class="main">}</span><span class="main">.</span> flow0 <span class="bound">y</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">outer</span><span class="main">)</span> <span class="main">∧</span>
          flow0 <span class="bound">y</span> <span class="bound">T</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> swap_side<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> io <span class="main"><span class="keyword3">|</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inside_out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">inner</span> <span class="main">⟹</span>
    <span class="main">0</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="bound">y</span> <span class="main">⟹</span>
    flow0 <span class="bound">y</span> <span class="bound">t</span> <span class="main">∈</span> closure <span class="skolem">outer</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">T</span> <span class="main">∧</span> <span class="bound">T</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">T</span><span class="main">}</span><span class="main">.</span> flow0 <span class="bound">y</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">inner</span><span class="main">)</span> <span class="main">∧</span>
          flow0 <span class="bound">y</span> <span class="bound">T</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> swap_side<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> io2 io <span class="main"><span class="keyword3">|</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> leaves_transversal_segmentE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d_above<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">s</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d_below<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">-</span><span class="skolem">d</span> <span class="main">≤</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span>flow0 <span class="bound">x</span> <span class="bound">s</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> ortho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="comment1">(* These "rectangles" are either fully inside or fully outside
           |-----------------------|
           |           r1          | (flow d)
    a --- (t1) --- rp --- (t2) --- b
    |          r2           | (flow -d)
    |-----------------------|
   *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">have</span></span> r1a1<span class="main">:</span> <span class="quoted"><span class="quoted">"path_connected <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> r1a2<span class="main">:</span> <span class="quoted"><span class="quoted">"path_connected <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_closed_segment subset_oc_segment x1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r1a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> d_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> flow0_path_connected<span class="main">[</span><span class="operator">OF</span> r1a1 r1a2 r1a3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> pcr1<span class="main">:</span><span class="quoted"><span class="quoted">"path_connected <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pir1J1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∩</span> path_image <span class="skolem">J1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> J1_def path_image_flow_to_path<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∩</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xx</span></span> <span class="skolem"><span class="skolem">tt</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      eq<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">xx</span> <span class="skolem">tt</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">tt</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r1_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sub1b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_mp<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> xx <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_closed_segment<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ss <span class="keyword1"><span class="command">have</span></span> ss_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exist
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> d_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span><span class="main">]</span> tt
    <span class="keyword1"><span class="command">have</span></span> tt_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">xx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg_tt_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">tt</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="skolem">xx</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_reverse<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="skolem">xx</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">ss</span> <span class="main">-</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tt_ex<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> neg_tt_ex<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ss_ex<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> neg_tt_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="skolem">ss</span> <span class="main">-</span> <span class="free">t1</span>"</span></span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="skolem">tt</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≤</span> <span class="skolem">tt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> neg_tt_ex eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> t1t2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 1 ss tt
        <span class="keyword1"><span class="command">unfolding</span></span> e_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> tt_ex xx
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neg_tt_ex<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sub1b subset_eq subset_open_segment<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> les<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">tt</span> <span class="main">-</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span> <span class="main">-</span> <span class="skolem">e</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tt ss 2 e_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> xxtte<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">xx</span> <span class="main">(</span><span class="skolem">tt</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t1</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">tt</span> <span class="main">-</span> <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">-</span> <span class="skolem">d</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">xx</span>›</span></span> atLeastAtMost_iff e_def eq
            local.existence_ivl_reverse local.existence_ivl_trans local.flow_trans ss<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ss_ex subset_iff tt<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span> <span class="main">=</span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> xxtte <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> xx <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_segment_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> les <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">tt</span> <span class="main">-</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> d_above<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">tt</span> <span class="main">-</span> <span class="skolem">e</span> <span class="main">≤</span> <span class="skolem">d</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">xx</span> <span class="main">(</span><span class="skolem">tt</span> <span class="main">-</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_closed_segment_iff_rot<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main"><span class="main">]</span></span>
              not_le <span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>›</span></span> inner_minus_right inner_rot_neg_move_base inner_rot_pos_move_base n rot_diff_commute<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> xxtte <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>›</span></span> suba2o <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">(* for sufficiently small d, the flow does not return to the line *)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> pir1J2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∩</span> path_image <span class="skolem">J2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r1_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aa</span> <span class="skolem">ba</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ba</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> sub1b <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span>flow0 <span class="skolem">aa</span> <span class="skolem">ba</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> segment_open_subset_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inner_pos_move_base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ortho d_above<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_segment_inner_rot in_segment_inner_rot2 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> J2_def path_image_linepath
      <span class="keyword1"><span class="command">using</span></span> t12sub open_closed_segment
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pir1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∩</span> <span class="main">(</span>path_image <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> J_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal not_in_path_image_join<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">&lt;..&lt;</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> r2a1<span class="main">:</span><span class="quoted"><span class="quoted">"path_connected <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> r2a2<span class="main">:</span><span class="quoted"><span class="quoted">"path_connected <span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">&lt;..&lt;</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> open_closed_segment subset_co_segment subset_oc_segment t12sub<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r2a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">&lt;..&lt;</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> d_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> flow0_path_connected<span class="main">[</span><span class="operator">OF</span> r2a1 r2a2 r2a3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> pcr2<span class="main">:</span><span class="quoted"><span class="quoted">"path_connected <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pir2J2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">∩</span> path_image <span class="skolem">J1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> J1_def path_image_flow_to_path<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">∩</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xx</span></span> <span class="skolem"><span class="skolem">tt</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      eq<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">xx</span> <span class="skolem">tt</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">ss</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">tt</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> suba2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_mp<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> xx <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_closed_segment<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ss <span class="keyword1"><span class="command">have</span></span> ss_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exist
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> d_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span><span class="main">]</span> tt
    <span class="keyword1"><span class="command">have</span></span> tt_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span> <span class="main">∈</span> existence_ivl0 <span class="skolem">xx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg_tt_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">tt</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="skolem">xx</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_reverse<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="skolem">xx</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">ss</span> <span class="main">-</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tt_ex<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> neg_tt_ex<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ss_ex<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> neg_tt_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="free">t2</span> <span class="main">-</span> <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">-</span> <span class="skolem">tt</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≤</span> <span class="main">-</span><span class="skolem">tt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> neg_tt_ex eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> t1t2<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 1 ss tt
        <span class="keyword1"><span class="command">unfolding</span></span> e_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">tt</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> tt_ex xx
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neg_tt_ex<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> suba2 subset_eq subset_open_segment<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">have</span></span> les<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span> <span class="main">+</span> <span class="skolem">e</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">d</span> <span class="main">≤</span> <span class="skolem">tt</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tt ss 2 e_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> xxtte<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">xx</span> <span class="main">(</span><span class="skolem">tt</span> <span class="main">+</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff calculation eq exist local.existence_ivl_trans' local.flow_trans neg_tt_ex ss_ex subset_iff <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span><span class="main">=</span><span class="main">-</span><span class="skolem">e</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> xxtte <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> xx <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_segment_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> les <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span><span class="main">+</span><span class="skolem">e</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> d_below<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">-</span><span class="skolem">d</span> <span class="main">≤</span> <span class="skolem">tt</span> <span class="main">+</span> <span class="skolem">e</span>›</span></span> this<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">xx</span> <span class="main">(</span><span class="skolem">tt</span> <span class="main">+</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_closed_segment_iff_rot<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main"><span class="main">]</span></span>
              not_le <span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="skolem">xx</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>›</span></span> inner_minus_right inner_rot_neg_move_base inner_rot_pos_move_base n rot_diff_commute<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> xxtte <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> pir2J2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">∩</span> path_image <span class="skolem">J2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r2_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aa</span> <span class="skolem">ba</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ba</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">&lt;..&lt;</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> suba2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span>flow0 <span class="skolem">aa</span> <span class="skolem">ba</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> segment_open_subset_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inner_neg_move_base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ortho d_below<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_segment_inner_rot in_segment_inner_rot2 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> J2_def path_image_linepath
      <span class="keyword1"><span class="command">using</span></span> t12sub open_closed_segment
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pir2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">∩</span> <span class="main">(</span>path_image <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> J_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal not_in_path_image_join<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">=</span> midpoint <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rpi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x1neqx2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rpi suba2o subl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* The fundamental case distinction *)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">J1</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span>
    <span class="quoted"><span class="quoted">"pathstart <span class="skolem">J1</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rpi
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_segment_commute J1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong in_open_segment_rotD inner_diff_left nrm_dot rpi<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong inner_minus_left nrm_reverse<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rot_same_dir<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> x1 x2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> side1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?lower1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong in_open_segment_rotD inner_diff_left nrm_dot rpi<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong inner_minus_left nrm_reverse<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rot_same_dir<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> x1 x2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> side2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">-</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?upper1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> linepath_ball_inside_outside<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹simple_path <span class="skolem">J</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> J_def J2_def<span class="main"><span class="main">]</span></span> *<span class="main">,</span>
      <span class="operator">folded</span> J2_def J_def<span class="main">,</span> <span class="operator">unfolded</span> side1 side2<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="quoted"><span class="quoted">"ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> path_image <span class="skolem">J1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?lower1</span> <span class="main">⊆</span> <span class="skolem">inner</span> <span class="main">∧</span>
        ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?upper1</span> <span class="main">⊆</span> <span class="skolem">outer</span> <span class="main">∨</span>
        ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?upper1</span> <span class="main">⊆</span> <span class="skolem">inner</span> <span class="main">∧</span>
        ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?lower1</span> <span class="main">⊆</span> <span class="skolem">outer</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_def outer_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lower</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?upper</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lower1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">}</span> <span class="main">∧</span> <span class="var">?upper1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">}</span> <span class="main">∨</span>
      <span class="var">?lower1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">}</span> <span class="main">∧</span> <span class="var">?upper1</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="bound">y</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n rot_diff_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this e0 <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="quoted"><span class="quoted">"ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> path_image <span class="skolem">J1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?lower</span> <span class="main">⊆</span> <span class="skolem">inner</span> <span class="main">∧</span>
        ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?upper</span> <span class="main">⊆</span> <span class="skolem">outer</span> <span class="main">∨</span>
        ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?upper</span> <span class="main">⊆</span> <span class="skolem">inner</span> <span class="main">∧</span>
        ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="var">?lower</span> <span class="main">⊆</span> <span class="skolem">outer</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_tendstoD <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> evr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span>flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rp</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>›</span></span> d_above<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_tendstoD <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> evl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">(</span>flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rp</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>›</span></span> d_below<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="main">0</span><span class="main">.</span> flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">∈</span> ball <span class="skolem">rp</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mem_ball
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dist_commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tendstoD<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> evl2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">∈</span> ball <span class="skolem">rp</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> evr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">∈</span> ball <span class="skolem">rp</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> evl3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> evr3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_tendstoD <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> evl4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> evr4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_filter<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> evl evl2 evl3 evl4
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_left <span class="main">0</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">∈</span> ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eventually_happens<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dl</span></span> <span class="keyword2"><span class="keyword">where</span></span> dl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">rp</span> <span class="skolem">dl</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="skolem">dl</span> <span class="main">∈</span> ball <span class="skolem">rp</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">dl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dl</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> evr evr2 evr3 evr4
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">t</span> <span class="keyword1">in</span> at_right <span class="main">0</span><span class="main">.</span> <span class="main">(</span>flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> flow0 <span class="skolem">rp</span> <span class="bound">t</span> <span class="main">∈</span> ball <span class="skolem">rp</span> <span class="skolem">e</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eventually_happens<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dr</span></span> <span class="keyword2"><span class="keyword">where</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="skolem">rp</span> <span class="skolem">dr</span> <span class="main">-</span> <span class="skolem">rp</span><span class="main">)</span> <span class="main">∙</span> rot <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="skolem">dr</span> <span class="main">∈</span> ball <span class="skolem">rp</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="skolem">dr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dr</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rpi subr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rpr1<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="main">(</span><span class="skolem">dr</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r1_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rp</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rpi subl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rpr2<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="main">(</span><span class="skolem">dl</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r2_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">-</span><span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">dl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dl</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> e<span class="main">(</span>3<span class="main">)</span> dr dl
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="main">(</span><span class="skolem">dr</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">outer</span> <span class="main">∧</span> flow0 <span class="skolem">rp</span> <span class="main">(</span><span class="skolem">dl</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">inner</span> <span class="main">∨</span> flow0 <span class="skolem">rp</span> <span class="main">(</span><span class="skolem">dr</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">inner</span> <span class="main">∧</span> flow0 <span class="skolem">rp</span> <span class="main">(</span><span class="skolem">dl</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="skolem">dr</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="skolem">dl</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      r1o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∩</span> <span class="skolem">outer</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      r2i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">∩</span> <span class="skolem">inner</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rpr1 rpr2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> pcr1 r1o<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">⊆</span> <span class="skolem">outer</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pir1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> io<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> pcr2 r2i<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">⊆</span> <span class="skolem">inner</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pir2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> io<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r1_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>image_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">⟹</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r1</span> <span class="main">⊆</span> <span class="skolem">outer</span>›</span></span> greaterThanLessThan_iff mem_Sigma_iff pair_imageI r1_def subset_eq x2<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t2o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r1a3<span class="main">[</span><span class="operator">OF</span> x2<span class="main">]</span> exist flow_trans
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> closed_segment_commute ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.existence_ivl_trans' local.flow_undefined0 real_Icc_closed_segment subset_eq <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">)</span>

<span class="comment1">(* Construct a sequence of times converging to these points in r2 ⊆ inner *)</span>
    <span class="keyword1"><span class="command">have</span></span> inner<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> closure <span class="skolem">inner</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y suba12_open suba2o <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">d</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">inner</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y
        <span class="keyword1"><span class="command">using</span></span> suba12_open <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> suba2o <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">⊆</span> <span class="skolem">inner</span>›</span></span><span class="main"><span class="main">]</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="main">-</span><span class="skolem">d</span><span class="main">/</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">n</span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r2_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> d_over_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="skolem">d</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_tendsto_divide_at_top<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filterlim_tendsto_add_at_top filterlim_real_sequentially<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">d</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> d_over_0<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> closure <span class="skolem">inner</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closure_sequential
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> flow0 <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">d</span></span></span><span class="main"><span class="main"><span class="main">/</span></span></span>Suc <span class="main"><span class="main"><span class="main">(</span></span></span>Suc <span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span> <span class="main">⊆</span> closure <span class="skolem">inner</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> suba12_open <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">--</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> closure <span class="skolem">inner</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> closure_closure closure_mono closure_open_segment dual_order.trans inner subl x1neqx2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> outer<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∉</span> <span class="skolem">outer</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span><span class="main">-</span> <span class="main">(</span><span class="free">t2</span><span class="main">+</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t2o t  <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span><span class="main">+</span><span class="skolem">dr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">have</span></span> t2d2_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist d_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> existence_ivl_trans<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_existence_ivl_trans<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t2d2_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∈</span> closure <span class="skolem">inner</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t<span class="main">(</span>3<span class="main">)</span> io
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ComplI Un_iff closure_Un_frontier<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> closure <span class="skolem">inner</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span><span class="main">+</span><span class="skolem">dr</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d t2o <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> outside_in<span class="main">[</span><span class="operator">OF</span> a1 a2 a3 a4<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">T</span><span class="main">}</span><span class="main">.</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">outer</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> subl2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">&lt;..&lt;</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r2_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>image_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span><span class="skolem">d</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> flow0 <span class="skolem">y</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_imageI subsetD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d T <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">dl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dl</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">d</span> <span class="main">&lt;</span> max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d T <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">dl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dl</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> inner<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">⊆</span> <span class="skolem">inner</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="main">(</span><span class="skolem">T</span><span class="main">+</span><span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">+</span><span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>1<span class="main">)</span> d <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">dl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dl</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> outer<span class="main">:</span> <span class="quoted"><span class="quoted">" flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">T</span><span class="main">+</span><span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> T_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> exist <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> d_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> T <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_rev_mp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">..</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">t2</span></span> <span class="main"><span class="main">+</span></span> <span class="skolem"><span class="skolem">dr</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ivl_subset_existence_ivl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_trans'<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_trans'<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> T_ex2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dr</span> <span class="main">+</span> <span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> T_ex ends_in_segment<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> exist local.existence_ivl_trans local.existence_ivl_trans' real_Icc_closed_segment subset_eq t2d2_ex <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> T <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> T_ex diff_existence_ivl_trans disjoint_iff_not_equal inner io<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> local.flow_trans local.flow_undefined0 outer y_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">inner</span> <span class="main">∩</span> <span class="skolem">outer</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> io<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> io<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> open_Int_closure_eq_empty<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&gt;</span> <span class="free">t2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>›</span></span> inner outer <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="skolem">dr</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">rp</span> <span class="skolem">dl</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      r1i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∩</span> <span class="skolem">inner</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      r2o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">∩</span> <span class="skolem">outer</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rpr1 rpr2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> pcr1 r1i<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">⊆</span> <span class="skolem">inner</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pir1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> io<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> path_connected_not_frontier_subset<span class="main">[</span><span class="operator">OF</span> pcr2 r2o<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">⊆</span> <span class="skolem">outer</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pir2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> io<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r1_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>image_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">⟹</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r1</span> <span class="main">⊆</span> <span class="skolem">inner</span>›</span></span> greaterThanLessThan_iff mem_Sigma_iff pair_imageI r1_def subset_eq x2<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t2o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r1a3<span class="main">[</span><span class="operator">OF</span> x2<span class="main">]</span> exist flow_trans
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> closed_segment_commute ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.existence_ivl_trans' local.flow_undefined0 real_Icc_closed_segment subset_eq <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">)</span>

<span class="comment1">(* Construct a sequence of times converging to these points in r2 ⊆ outer *)</span>
    <span class="keyword1"><span class="command">have</span></span> outer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> closure <span class="skolem">outer</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y suba12_open suba2o <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">d</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">outer</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y
        <span class="keyword1"><span class="command">using</span></span> suba12_open <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> suba2o <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">⊆</span> <span class="skolem">outer</span>›</span></span><span class="main"><span class="main">]</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="main">-</span><span class="skolem">d</span><span class="main">/</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">n</span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r2_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> d_over_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">-</span> <span class="skolem">d</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_tendsto_divide_at_top<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filterlim_tendsto_add_at_top filterlim_real_sequentially<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">d</span> <span class="main">/</span> real <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> d_over_0<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> closure <span class="skolem">outer</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closure_sequential
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> flow0 <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">d</span></span></span><span class="main"><span class="main"><span class="main">/</span></span></span>Suc <span class="main"><span class="main"><span class="main">(</span></span></span>Suc <span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span> <span class="main">⊆</span> closure <span class="skolem">outer</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> suba12_open <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">--</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> closure <span class="skolem">outer</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> closure_closure closure_mono closure_open_segment dual_order.trans outer subl x1neqx2<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> inner<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∉</span> <span class="skolem">inner</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span><span class="main">-</span> <span class="main">(</span><span class="free">t2</span><span class="main">+</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t2o t <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span><span class="main">+</span><span class="skolem">dr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">have</span></span> t2d2_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist d_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> existence_ivl_trans<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_existence_ivl_trans<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t2d2_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∈</span> closure <span class="skolem">outer</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t<span class="main">(</span>3<span class="main">)</span> io
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ComplI Un_iff closure_Un_frontier<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> closure <span class="skolem">outer</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span><span class="main">+</span><span class="skolem">dr</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d t2o <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> inside_out<span class="main">[</span><span class="operator">OF</span> a1 a2 a3 a4<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">T</span><span class="main">}</span><span class="main">.</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∈</span> <span class="skolem">inner</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> subl2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> flow0 <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span><span class="skolem">d</span><span class="main">&lt;..&lt;</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r2_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>image_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span><span class="skolem">d</span> <span class="main">&lt;</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟹</span> flow0 <span class="skolem">y</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_imageI subsetD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d T <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">dl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dl</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">d</span> <span class="main">&lt;</span> max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d T <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">dl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dl</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> outer<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">outer</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">⊆</span> <span class="skolem">outer</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="main">(</span><span class="skolem">T</span><span class="main">+</span><span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">+</span><span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>1<span class="main">)</span> d <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&gt;</span> <span class="skolem">dl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dl</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> inner<span class="main">:</span> <span class="quoted"><span class="quoted">" flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">T</span><span class="main">+</span><span class="main">(</span>max <span class="main">(</span><span class="main">-</span><span class="skolem">T</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="skolem">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">inner</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> T_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="free">t2</span> <span class="main">+</span> <span class="skolem">dr</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> exist <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> d_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">--</span> <span class="free">b</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> T <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">dr</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dr</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_rev_mp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">..</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">t2</span></span> <span class="main"><span class="main">+</span></span> <span class="skolem"><span class="skolem">dr</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ivl_subset_existence_ivl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_trans'<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_trans'<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> T_ex2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dr</span> <span class="main">+</span> <span class="skolem">T</span> <span class="main">∈</span> existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> T_ex ends_in_segment<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> exist local.existence_ivl_trans local.existence_ivl_trans' real_Icc_closed_segment subset_eq t2d2_ex <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> T <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> T_ex diff_existence_ivl_trans disjoint_iff_not_equal inner io<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> local.flow_trans local.flow_undefined0 outer y_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closure <span class="skolem">outer</span> <span class="main">∩</span> <span class="skolem">inner</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> io<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> io2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> open_Int_closure_eq_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&gt;</span> <span class="free">t2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>›</span></span> inner outer <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_segment_trichotomy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Un_open_segment<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">y</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">y</span><span class="main">}</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">y</span> <span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> open_segment_subsegment
      <span class="keyword1"><span class="command">using</span></span> open_segment_commute y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">y</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> open_segment_subsegment<span class="main">[</span><span class="operator">OF</span> y this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rev<span class="main">:</span> c1_on_open_R2 <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">f'</span><span class="main">)</span> <span class="main">=</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dim2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_transversal_segment<span class="main">:</span> <span class="quoted"><span class="quoted">"rev.transversal_segment <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def rev.transversal_segment_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flow0_transversal_segment_monotone_step_reverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> exist <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> t1t2 <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>›</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_open_segment_iff_line<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="skolem">i2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> i1 open_segment_line_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t2_exist<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> t2_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x1_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i1 i2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_in_subsegment line_line1<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> transversal'<span class="main">:</span> <span class="quoted"><span class="quoted">"rev.transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rev_transversal_segment <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> time'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t2</span> <span class="main">-</span> <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exist <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> exivl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">t2</span> <span class="main">-</span> <span class="free">t1</span><span class="main">}</span> <span class="main">⊆</span> rev.existence_ivl0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exist <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_existence_ivl_eq0 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> existence_ivl_trans'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step'<span class="main">:</span> <span class="quoted"><span class="quoted">"rev.flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">(</span><span class="free">t2</span><span class="main">-</span><span class="free">t</span><span class="main">)</span> <span class="main">∉</span>  <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>rev.flow0 <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">(</span><span class="free">t2</span> <span class="main">-</span> <span class="free">t1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev.flow0_transversal_segment_monotone_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> transversal' time' exivl'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> exist <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> x1 x2 t2_mem x1_mem t1t2 <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&lt;</span> <span class="free">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_existence_ivl_eq0 rev_eq_flow existence_ivl_trans' flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> existence_ivl_trans'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rev_eq_flow
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&lt;</span> <span class="free">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> existence_ivl_trans'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flow0_transversal_segment_monotone_step_reverse2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transversal<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> exist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t1t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flow0_transversal_segment_monotone_step_reverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">,</span> <span class="operator">OF</span> _ time exist<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
    assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_segment_commute transversal_segment_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flow0_transversal_segment_monotone_step2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transversal<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> exist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t1t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&gt;</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span> <span class="main">⟹</span> flow0 <span class="free">x</span> <span class="bound">t</span> <span class="main">∉</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flow0_transversal_segment_monotone_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">,</span> <span class="operator">OF</span> _ time exist<span class="main">]</span>
    assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_commute open_segment_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flow0_transversal_segment_monotone<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="free">t1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&gt;</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> exist <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&gt;</span> <span class="free">t2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> x1neqx2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">≠</span> flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> open_segment_def x2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t1neqt2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≠</span> <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">&lt;</span> <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_open_segment_iff_line<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x2 i1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">=</span> line <span class="free">a</span> <span class="free">b</span> <span class="skolem">i2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">i2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_open_segment_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t2_in<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i1 i2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">--</span><span class="free">b</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">s</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">t1</span><span class="main">..&lt;</span><span class="free">t2</span><span class="main">}</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> flow_transversal_segment_finite_intersections<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> exist<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?T'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">t1</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">&lt;</span> <span class="free">t2</span>›</span></span> x1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> tm_defined <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?T'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?T'</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tm</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tm</span> <span class="main">=</span> Max <span class="var">?T'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tm</span> <span class="main">∈</span> <span class="var">?T'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tm_def
    <span class="keyword1"><span class="command">using</span></span> tm_defined <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tm_in<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">tm</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">∈</span> <span class="var">?T'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≤</span> <span class="skolem">tm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tm</span> <span class="main">&lt;</span> <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tm</span> <span class="main">≤</span> <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">∈</span> <span class="var">?T'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tm_Max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">tm</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="var">?T'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tm_def
    <span class="keyword1"><span class="command">using</span></span> tm_defined<span class="main">(</span>1<span class="main">)</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> tm_exclude<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tm</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">∈</span> <span class="var">?T'</span>›</span></span> tm_Max that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">meson</span> approximation_preproc_push_neg<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dual_order.strict_trans2 le_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">tm</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exist tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> open_segment_trichotomy<span class="main">[</span><span class="operator">OF</span> tm_in t2_in<span class="main">]</span>
  <span class="keyword1"><span class="command">consider</span></span>
    <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="skolem">tm</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="skolem">tm</span><span class="main">}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">tm</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="free">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">from</span></span> flow0_transversal_segment_monotone_step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">tm</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span> tm_in 1 tm_exclude t<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≠</span> <span class="skolem">tm</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 x2 i1 i2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_in_subsegment line_in_subsegment2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">&lt;</span> <span class="skolem">tm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="skolem">tm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> flow0_transversal_segment_monotone_step_reverse<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">tm</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>›</span></span> tm_in 2 tm_exclude <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">&lt;</span> <span class="skolem">tm</span>›</span></span><span class="main">]</span> exist <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="skolem">tm</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> x1 x2 2 i1 i2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> line_in_subsegment line_in_subsegment2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> greaterThanLessThan_iff in_open_segment_iff_line line_in_subsegment2 tm_in<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≠</span> <span class="skolem">tm</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 x2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_segment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">&lt;</span> <span class="skolem">tm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="skolem">tm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>flow0 <span class="free">x</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">tm</span><span class="main">..</span><span class="free">t2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> recurrence_time_restricts_compact_flow'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">&lt;</span> <span class="free">t2</span>›</span></span> _ _ 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> exist <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t1</span> <span class="main">&lt;</span> <span class="skolem">tm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">&lt;</span> <span class="free">t2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span>insert <span class="free">t2</span> <span class="main">{</span><span class="skolem">tm</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tm</span> <span class="main">≤</span> <span class="free">t2</span>›</span></span> 3
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> greaterThanLessThan_iff image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">(</span>insert <span class="free">t2</span> <span class="main">{</span><span class="skolem">tm</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="free">t1</span> <span class="main">∈</span> flow0 <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">tm</span><span class="main">&lt;..&lt;</span><span class="free">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x1neqx2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tm_exclude
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> x1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Straightening›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ This lemma uses the implicit function theorem ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> cross_time_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">d</span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>ball <span class="free">x</span> <span class="free">d</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="free">d</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="free">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="free">d</span> <span class="main">⟹</span> <span class="main">¦</span><span class="free">t</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
    <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>ball <span class="free">x</span> <span class="free">d</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms segment_open_subset_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∙</span> rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> in_segment_inner_rot<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms open_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="keyword1">has_derivative</span> blinfun_inner_left <span class="main">(</span>rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="keyword1">has_derivative</span> blinfun_apply <span class="main">(</span><span class="var">?Ds</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> s_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Dsc<span class="main">:</span> <span class="quoted"><span class="quoted">"isCont <span class="var">?Ds</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Ds</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">unfolding</span></span> transversal_segment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> inner_minus_left nrm_reverse open_closed_segment<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> flow_implicit_function_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>›</span></span> Ds Dsc nz <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="skolem">d1</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="main">(</span>flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="skolem">d1</span> <span class="main">⟹</span> <span class="main">¦</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> cball <span class="free">x</span> <span class="skolem">d1</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="bound">y</span> <span class="main">∈</span> existence_ivl0 <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tc<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>cball <span class="free">x</span> <span class="skolem">d1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="keyword1">has_derivative</span>
        <span class="main">(</span><span class="main">-</span> blinfun_inner_left <span class="main">(</span>rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>blinfun_inner_left <span class="main">(</span>rot <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> tc
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">─</span><span class="free">x</span><span class="main">→</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def at_within_interior t0 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ftc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span><span class="main">)</span>



  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">=</span> min <span class="main">(</span>dist <span class="free">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>dist <span class="free">b</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> e2_def open_segment_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> tendstoD<span class="main">[</span><span class="operator">OF</span> ftc this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> dist <span class="main">(</span>flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"open <span class="var">?S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> open_segment_line_hyperplanes <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> open_Collect_conj open_halfspace_component_gt open_halfspace_component_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> topological_tendstoD<span class="main">[</span><span class="operator">OF</span> ftc this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">y</span> <span class="keyword1">in</span> <span class="keyword1">at</span> <span class="free">x</span><span class="main">.</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">e2</span> <span class="main">∩</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> dist <span class="bound">y</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">d2</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">e2</span> <span class="main">∩</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">y</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">d2</span> <span class="main">⟹</span> flow0 <span class="skolem">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">e2</span> <span class="main">∩</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> t0 <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="var">?S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> min <span class="skolem">d1</span> <span class="skolem">d2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>ball <span class="free">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>continuous_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tc<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="skolem">e2</span> <span class="main">∩</span> <span class="var">?S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_open_segment_iff_rot <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_def e2_def in_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">d</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> set_mp<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> d1 d2 <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def e2_def dist_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="main">¦</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>ball <span class="free">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t0<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ω_limit_crossings<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">s</span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main">∞</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="free">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∧</span> <span class="free">s</span> <span class="bound">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transversal_segment_def open_closed_segment<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main">∞</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ω_limit_point_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> t <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main">∞</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span> <span class="main">=</span> t<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cross_time_continuous<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> zero_less_one<span class="comment1">― ‹TODO ??›</span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="skolem"><span class="skolem">δ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">δ</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>ball <span class="free">p</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">p</span> <span class="skolem">δ</span> <span class="main">⟹</span> <span class="main">¦</span><span class="skolem">τ</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">p</span> <span class="skolem">δ</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">τ</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">note</span></span> τ <span class="main">=</span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">p</span> <span class="skolem">δ</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">τ</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="free">p</span> <span class="skolem">δ</span> <span class="main">⟹</span> <span class="main">¦</span><span class="skolem">τ</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹continuous_on <span class="main">(</span>ball <span class="free">p</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">τ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">τ</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">have</span></span> ev_in_ball<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> at_top<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> ball <span class="free">p</span> <span class="skolem">δ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> dist_commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tendstoD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> t<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">δ</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_at_top_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">t</span> <span class="bound">n</span><span class="main">)</span> at_top sequentially"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_tendsto_add_at_top<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filterlim_tendsto_add_at_top t<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ev_in_ball <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">t</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">eventually_elim</span>
      <span class="keyword1"><span class="command">using</span></span> τ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="main"><span class="main">:</span></span> s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> τ_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">─</span><span class="free">p</span><span class="main">→</span> <span class="skolem">τ</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">δ</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def at_within_ball <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span> <span class="main">=</span> tendsto_compose_at<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ev1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="skolem">t</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filterlim_at_top_dense t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ev_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="main">(</span><span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">o</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ev_in_ball
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> τ<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> flow_trans<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> pos_ex
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> existence_ivl_trans'<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span>
  <span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> flow0 <span class="main">(</span><span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">o</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="main">─</span><span class="free">p</span><span class="main">→</span> <span class="skolem">τ</span> <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> flow0 <span class="main">(</span><span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">τ</span> <span class="main">∘</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⇢</span>
  flow0 <span class="free">p</span> <span class="main">(</span><span class="skolem">τ</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>›</span></span> τ_cont <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> <span class="free">X</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> flow0 <span class="free">p</span> <span class="main">(</span><span class="skolem">τ</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ev_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="keyword1">o</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">τ</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ev_eq ev_in_ball
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">eventually_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> τ<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ev_in_ball ev1
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> τ<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> pos_ex
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Obvious but frequently used step *)</span>
<span class="keyword1"><span class="command">lemma</span></span> filterlim_at_top_tendstoE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">s</span> at_top sequentially"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">s</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="free">m</span><span class="main">)</span> <span class="free">u</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filterlim_at_top_dense<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> norm <span class="main">(</span><span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">-</span> <span class="free">u</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> tendstoD<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="bound">n</span> <span class="main">∧</span> norm <span class="main">(</span><span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">-</span> <span class="free">u</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">s</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">u</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_sequentially dist_norm<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_segment_separate_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="free">v</span> <span class="free">x</span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">u</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="free">x</span> <span class="free">u</span> <span class="main">&lt;</span> dist <span class="free">u</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">v</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">v</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute dist_in_open_segment open_segment_subsegment v x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> segment_open_subset_closed subset_eq subset_segment<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> u<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> open_segment_trichotomy<span class="main">[</span><span class="operator">OF</span> _ x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_segment_separate_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="free">v</span> <span class="free">x</span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="free">x</span> <span class="free">u</span> <span class="main">&lt;</span> dist <span class="free">u</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">v</span> <span class="main">&lt;--&lt;</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute dist_in_open_segment open_segment_commute open_segment_subsegment v x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ends_in_segment<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> segment_open_subset_closed subset_eq subset_segment<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> u<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> open_segment_trichotomy<span class="main">[</span><span class="operator">OF</span> _ x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_two_ω_limit_points<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> transversal<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ex_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">u</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> unotv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uv
    <span class="keyword1"><span class="command">using</span></span> dist_in_open_segment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">duv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">duv</span> <span class="main">=</span> dist <span class="free">u</span> <span class="free">v</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> duv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">duv</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> duv_def <span class="keyword1"><span class="command">using</span></span> unotv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_crossings<span class="main">[</span><span class="operator">OF</span> transversal ex_pos u<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">su</span></span> <span class="keyword2"><span class="keyword">where</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">su</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">su</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">su</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">su</span> <span class="bound">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_crossings<span class="main">[</span><span class="operator">OF</span> transversal ex_pos v<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sv</span></span> <span class="keyword2"><span class="keyword">where</span></span> sv<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">sv</span> at_top sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="skolem">sv</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="skolem">sv</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">sv</span> <span class="bound">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> filterlim_at_top_tendstoE<span class="main">[</span><span class="operator">OF</span> duv su<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">su1</span></span> <span class="keyword2"><span class="keyword">where</span></span> su1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">su1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">su1</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su1</span><span class="main">)</span> <span class="free">u</span> <span class="main">&lt;</span> <span class="skolem">duv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> filterlim_at_top_tendstoE<span class="main">[</span><span class="operator">OF</span> duv sv<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">su1</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">su2</span></span> <span class="keyword2"><span class="keyword">where</span></span> su2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">su2</span> <span class="main">&gt;</span> <span class="skolem">su1</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">su2</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su2</span><span class="main">)</span> <span class="free">v</span> <span class="main">&lt;</span> <span class="skolem">duv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> filterlim_at_top_tendstoE<span class="main">[</span><span class="operator">OF</span> duv su<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">su2</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">su3</span></span> <span class="keyword2"><span class="keyword">where</span></span> su3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">su3</span> <span class="main">&gt;</span> <span class="skolem">su2</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su3</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">su3</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su3</span><span class="main">)</span> <span class="free">u</span> <span class="main">&lt;</span> <span class="skolem">duv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">su1</span> <span class="main">≤</span> <span class="skolem">su2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">su1</span><span class="main">..</span><span class="skolem">su2</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> su1 su2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastatMost_empty_iff empty_iff mvar.closed_segment_subset_domain real_Icc_closed_segment su1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> su2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> subset_eq<span class="main">)</span>

<span class="comment1">(* by construction *)</span>
  <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su1</span><span class="main">)</span> <span class="free">v</span> <span class="main">≥</span> <span class="main">(</span>dist <span class="free">u</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> su1<span class="main">(</span>4<span class="main">)</span> duv <span class="keyword1"><span class="command">unfolding</span></span> duv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_triangle_half_r<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su1</span><span class="main">)</span> <span class="free">u</span> <span class="main">&lt;</span> dist <span class="free">u</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> su1<span class="main">(</span>4<span class="main">)</span> duv <span class="keyword1"><span class="command">unfolding</span></span> duv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> open_segment_separate_left<span class="main">[</span><span class="operator">OF</span> u<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> uv this su1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> su1l<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su1</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su2</span><span class="main">)</span> <span class="free">v</span> <span class="main">&lt;</span> dist <span class="free">v</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute duv_def su2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> open_segment_separate_right<span class="main">[</span><span class="operator">OF</span> v<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> su1l this su2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> su2l<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su2</span> <span class="main">∈</span> <span class="main">{</span>flow0 <span class="free">x</span> <span class="skolem">su1</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> su2ll<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su2</span> <span class="main">∈</span> <span class="main">{</span><span class="free">u</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute dist_pos_lt duv_def open_segment_subsegment pos_half_less open_segment_separate_right su2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> su2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> u<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> uv v<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> unotv<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su2</span><span class="main">)</span> <span class="free">u</span> <span class="main">≥</span> <span class="main">(</span>dist <span class="free">u</span> <span class="free">v</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> su2<span class="main">(</span>4<span class="main">)</span> duv <span class="keyword1"><span class="command">unfolding</span></span> duv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_triangle_half_r<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su3</span><span class="main">)</span> <span class="free">u</span> <span class="main">&lt;</span> dist <span class="free">u</span> <span class="main">(</span>flow0 <span class="free">x</span> <span class="skolem">su2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute duv_def su3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> open_segment_separate_left<span class="main">[</span><span class="operator">OF</span> u<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> su2ll this su3<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> su3l<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su3</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="skolem">su2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> flow0_transversal_segment_monotone<span class="main">[</span><span class="operator">OF</span> transversal * su1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> su2l su3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> su3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">x</span> <span class="skolem">su3</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span> <span class="main">&lt;--&lt;</span>flow0 <span class="free">x</span> <span class="skolem">su2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> su3l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unique Intersection›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Perko Section 3.7 Remark 2›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> unique_transversal_segment_intersection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> uv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span><span class="quoted"><span class="quoted">"ω_limit_point <span class="free">x</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> no_two_ω_limit_points<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="free">a</span> <span class="free">b</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dist_commute dist_in_open_segment open_segment_trichotomy u uv v assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Adapted from Perko Section 3.7 Lemma 4 (+ Chicone )›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> periodic_imp_ω_limit_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span>UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> y <span class="main">=</span> <span class="quoted"><span class="quoted">‹periodic_orbit <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> ω_limit_set <span class="free">x</span>›</span></span>
  <span class="keyword1"><span class="command">from</span></span> trapped_sol_right<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> ex_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span>UNIV <span class="main">≠</span> ω_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span> <span class="main">≠</span> ω_limit_set <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_connected<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    wcon<span class="main">:</span> <span class="quoted"><span class="quoted">"connected <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_compact<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"compact <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sc<span class="main">:</span> <span class="quoted"><span class="quoted">"seq_compact <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> compact_imp_seq_compact <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> y1<span class="main">:</span><span class="quoted"><span class="quoted">"closed <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_orbit_ω_limit_set periodic_orbit_def ω_limit_set_closed y<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> y2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?py</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"infdist <span class="skolem">p</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?py</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y1 y2 p<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infdist_pos_not_in_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">-</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">∧</span>
    infdist <span class="bound">z</span> <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span> UNIV<span class="main">)</span> <span class="main">&lt;</span> <span class="var">?py</span><span class="main">/</span><span class="numeral">2</span><span class="main">^</span><span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">-</span> range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span> <span class="main">∧</span>
                infdist <span class="bound">z</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span>
                <span class="main">&lt;</span> infdist <span class="skolem">p</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">-</span> range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">.</span>
      infdist <span class="bound">z</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="var">?py</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> infdist <span class="bound">z</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="var">?py</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> Ac<span class="main">:</span><span class="quoted"><span class="quoted">"closed <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">using</span></span> y1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> Bc<span class="main">:</span><span class="quoted"><span class="quoted">"closed <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> infdist_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> qz<span class="main">:</span><span class="quoted"><span class="quoted">"infdist <span class="skolem">q</span> <span class="main">(</span>range<span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?py</span>›</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infdist <span class="skolem">p</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qnz<span class="main">:</span> <span class="quoted"><span class="quoted">"infdist <span class="skolem">q</span><span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> qz qnz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">∩</span> ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">-</span> range<span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span><span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> connected_closedD<span class="main">[</span><span class="operator">OF</span> wcon a1 a2 Ac Bc<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="skolem">B</span> <span class="main">∩</span> ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">using</span></span> y<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∩</span> ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> p
        <span class="keyword1"><span class="command">using</span></span> A_def B_def a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">(</span><span class="skolem">s</span><span class="main">::</span>nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">-</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">∧</span>
                      infdist <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span> UNIV<span class="main">)</span> <span class="main">&lt;</span> <span class="var">?py</span><span class="main">/</span><span class="numeral">2</span><span class="main">^</span><span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> seq_compactE<span class="main">[</span><span class="operator">OF</span> sc this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> infdist <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?py</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s
    <span class="keyword1"><span class="command">using</span></span> less_eq_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm<span class="main">(</span>infdist <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?py</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infdist_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> LIMSEQ_norm_0_pow<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?py</span>›</span></span> _ this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> infdist <span class="bound">z</span> <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> LIMSEQ_subseq_LIMSEQ<span class="main">[</span><span class="operator">OF</span> this lr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> infdist <span class="bound">z</span> <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> infdist <span class="bound">z</span> <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> infdist <span class="skolem">l</span> <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> tendsto_compose_at<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lr<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infdist <span class="skolem">l</span> <span class="main">(</span>flow0 <span class="free">y</span> <span class="main">`</span>UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LIMSEQ_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> in_closed_iff_infdist_zero<span class="main">[</span><span class="operator">OF</span> y1 y2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_orbit_global_existence periodic_orbit_def y<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="comment1">(* TODO: factor out as periodic_orbitE *)</span>
  <span class="keyword1"><span class="command">have</span></span> l2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">∈</span> range <span class="main">(</span>flow0 <span class="free">y</span><span class="main">)</span>›</span></span> closed_orbit_global_existence fixed_point_imp_closed_orbit_period_zero<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fixpoint_sol<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_iff local.flows_reverse periodic_orbit_def y<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> transversal_segment_exists<span class="main">[</span><span class="operator">OF</span> l1 l2<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> unique_transversal_segment_intersection<span class="main">[</span><span class="operator">OF</span> ab<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ex_pos this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> luniq<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">l</span><span class="main">}</span> "</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> cross_time_continuous<span class="main">[</span><span class="operator">OF</span> ab<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> dt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="skolem">l</span> <span class="skolem">d</span> <span class="main">⟹</span> flow0 <span class="bound">y</span> <span class="main">(</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> ball <span class="skolem">l</span> <span class="skolem">d</span> <span class="main">⟹</span> <span class="main">¦</span><span class="skolem">t</span> <span class="bound">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span>ball <span class="skolem">l</span> <span class="skolem">d</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">∈</span> ball <span class="skolem">l</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lr<span class="main">(</span>3<span class="main">)</span> dt<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LIMSEQ_iff_nz
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dist_commute mem_ball order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">∉</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>›</span></span> calculation <span class="keyword1"><span class="command">unfolding</span></span> invariant_def trapped_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> ω_limit_set_in_compact_subset <span class="quoted"><span class="quoted">‹invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> invariant_def order_trans range_eqI subsetD trapped_iff_on_existence_ivl0 trapped_sol<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> unique_transversal_segment_intersection<span class="main">[</span><span class="operator">OF</span> ab<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ex_pos this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> luniq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> flow0 <span class="skolem">l</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> UNIV_I <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>›</span></span> flows_reverse ω_limit_set_in_compact_existence assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> sr<span class="main">(</span>2<span class="main">)</span> lu
      <span class="quoted"><span class="quoted">‹flow0 <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹flow0 <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">∘</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>›</span></span>
      closed_orbit_global_existence image_iff local.flow_trans periodic_orbit_def ω_limit_set_in_compact_existence range_eqI assms y<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword1"><span class="command">context</span></span> c1_on_open_R2 <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> α_limit_crossings<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transversal_segment <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"α_limit_point <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> ⇢<span class="hidden">⇘</span><sub></sub><span class="hidden">⇙</span> <span class="main">-∞</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span>
    flow0 <span class="free">x</span> <span class="main">(</span><span class="free">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∧</span>
    <span class="free">s</span> <span class="bound">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos_ex <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> uminus <span class="main">`</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> rev.ω_limit_crossings<span class="main">[</span><span class="operator">unfolded</span> rev_transversal_segment rev_existence_ivl_eq0 rev_eq_flow
      α_limit_point_eq_rev<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">∈</span> uminus <span class="main">`</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">-</span><span class="skolem">s</span><span class="main">)</span> at_bot sequentially"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">x</span> <span class="main">∘</span> <span class="main">(</span><span class="main">-</span><span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">x</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;--&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">-</span><span class="skolem">s</span><span class="main">)</span> <span class="bound">n</span> <span class="main">∈</span> existence_ivl0 <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_Compl_def o_def filterlim_uminus_at_top<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a positive limit point has a regular point in its positive limit set then it is periodic›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ω_limit_point_ω_limit_set_regular_imp_periodic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> ω_limit_set <span class="free">y</span> <span class="main">∪</span> α_limit_set <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">y</span> <span class="main">∧</span> flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> trapped_sol_right<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ex_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_existence<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> y<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> yex<span class="main">:</span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">y</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> yinv<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yex <span class="keyword1"><span class="command">unfolding</span></span> invariant_def
    <span class="keyword1"><span class="command">using</span></span> trapped_iff_on_existence_ivl0 y<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

  <span class="keyword1"><span class="command">have</span></span> zy<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">y</span> <span class="free">z</span> <span class="main">∨</span> α_limit_point <span class="free">y</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">unfolding</span></span> ω_limit_set_def α_limit_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_ω_limit_set_contained<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    ω_limit_set_in_compact_α_limit_set_contained<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> zx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zy y
    <span class="keyword1"><span class="command">using</span></span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I local.existence_ivl_initial_time_iff ω_limit_set_in_compact_existence assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> transversal_segment_exists<span class="main">[</span><span class="operator">OF</span> this z<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"transversal_segment <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> zy
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≠</span> <span class="skolem">t2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> zy<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_point <span class="free">y</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ω_limit_crossings<span class="main">[</span><span class="operator">OF</span> ab<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ zy ab<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> yex<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_top sequentially"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">y</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">z</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">y</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> eventually_happens<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> filterlim_at_top_dense s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">y</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> eventually_happens<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≠</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> t1 this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> zy<span class="main">:</span> <span class="quoted"><span class="quoted">"α_limit_point <span class="free">y</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> α_limit_crossings<span class="main">[</span><span class="operator">OF</span> ab<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ zy ab<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> yex<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="skolem">s</span> at_bot sequentially"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>flow0 <span class="free">y</span> <span class="main">∘</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">z</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">y</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> eventually_happens<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t1</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> filterlim_at_bot_dense s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">n</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> flow0 <span class="free">y</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> eventually_happens<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t2</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≠</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> t1 this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t1</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t1 UNIV_I yinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t2</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">a</span><span class="main">&lt;--&lt;</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t2 UNIV_I yinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> feq<span class="main">:</span><span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="skolem">t1</span> <span class="main">=</span> flow0 <span class="free">y</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unique_transversal_segment_intersection<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹transversal_segment <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> ex_pos<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≠</span> <span class="skolem">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">∈</span> existence_ivl0 <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t1</span> <span class="main">≠</span>  <span class="skolem">t2</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> yex<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> yex<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> periodic_orbitI<span class="main">[</span><span class="operator">OF</span> this feq y<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> periodic_imp_ω_limit_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> this yinv<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span><span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Poincare Bendixson Theorems›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Perko Section 3.7 Theorem 1›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> poincare_bendixson<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> f <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_nonempty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_existence<span class="main">[</span><span class="operator">OF</span>  assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> y<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> yex<span class="main">:</span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="skolem">y</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> yinv<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yex <span class="keyword1"><span class="command">unfolding</span></span> invariant_def
    <span class="keyword1"><span class="command">using</span></span> trapped_iff_on_existence_ivl0 y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yinv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> yk<span class="main">:</span><span class="quoted"><span class="quoted">"trapped_forward <span class="skolem">y</span> <span class="free">K</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_subsetI range_subsetD trapped_forward_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.mem_existence_ivl_iv_defined<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> yex<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_nonempty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> this _<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ω_limit_set <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yk <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_ω_limit_set_contained<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> zx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> ω_limit_set <span class="skolem">y</span>›</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> yreg <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f y
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> zreg <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f zx
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_image_eqI<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> ω_limit_point_ω_limit_set_regular_imp_periodic<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> y yreg _ zreg<span class="main">]</span> z
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixed_point_in_ω_limit_set_imp_ω_limit_set_singleton_fixed_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">yfp</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">yfp</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> zpx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_fp<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">K</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p1</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> ω_limit_set <span class="free">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p1</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">p2</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> α_limit_set <span class="free">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p2</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?weq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> wxK<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_ω_limit_set_contained<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> zx<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">z</span> <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zpx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> zX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_trans<span class="main">[</span><span class="operator">OF</span> wxK assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_iff zpx<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?weq</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_mono_iff Int_iff inf.absorb_iff1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?weq</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_finite_subset<span class="main">)</span> 

  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> fixed_point_imp_ω_limit_set<span class="main">[</span><span class="operator">OF</span> zX this<span class="main">]</span>
      fixed_point_imp_α_limit_set<span class="main">[</span><span class="operator">OF</span> zX this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">z</span> <span class="main">=</span> <span class="main">0</span>›</span></span> zpx<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> zweq<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">z</span> <span class="main">⊆</span> <span class="var">?weq</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> ω_limit_set <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">∧</span> <span class="free">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zx k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> ω_limit_point_ω_limit_set_regular_imp_periodic<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> zpx <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> _ this<span class="main">]</span> k<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"range<span class="main">(</span>flow0 <span class="free">z</span><span class="main">)</span> <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_iff periodic_orbit_imp_flow0_regular<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> fp
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> empty_Collect_eq image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> zweq0<span class="main">:</span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">z</span> <span class="main">⊆</span> <span class="var">?weq</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> α_limit_set <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span> <span class="main">∧</span> <span class="free">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zx k
          ω_limit_set_in_compact_α_limit_set_contained<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> zpx
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> ω_limit_point_ω_limit_set_regular_imp_periodic<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> zpx <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> _ this<span class="main">]</span> k<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"range<span class="main">(</span>flow0 <span class="free">z</span><span class="main">)</span> <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_iff periodic_orbit_imp_flow0_regular<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> fp
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> empty_Collect_eq image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_existence<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> zpx<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> zex<span class="main">:</span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="free">z</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> zinv<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="free">z</span> <span class="main">`</span> UNIV <span class="main">⊆</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zex <span class="keyword1"><span class="command">unfolding</span></span> invariant_def
      <span class="keyword1"><span class="command">using</span></span> trapped_iff_on_existence_ivl0 zpx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">z</span> <span class="main">`</span> UNIV <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wxK <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">z</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_backward <span class="free">z</span> <span class="free">K</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trapped_def trapped_iff_on_existence_ivl0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹range <span class="main">(</span>flow0 <span class="free">z</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">K</span>›</span></span> trapped_def trapped_iff_on_existence_ivl0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ω_limit_set <span class="free">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?weq</span>›</span></span> finite_subset zweq<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> finite_ω_limit_set_in_compact_imp_unique_fixed_point<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> zX a2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a3<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="keyword2"><span class="keyword">where</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">z</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">p1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">p1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">∈</span> <span class="var">?weq</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zweq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>α_limit_set <span class="free">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?weq</span>›</span></span> finite_subset zweq0<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> finite_α_limit_set_in_compact_imp_unique_fixed_point<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> zX a2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"α_limit_set <span class="free">z</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">p2</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">p2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span> <span class="main">∈</span> <span class="var">?weq</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zweq0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p1 p2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword1"><span class="command">context</span></span> c1_on_open_R2 <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Perko Section 3.7 Theorem 2›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> poincare_bendixson_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">K</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> periodic_orbit <span class="bound">y</span> <span class="main">∧</span>
    flow0 <span class="bound">y</span> <span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">P</span> <span class="bound">R</span><span class="main">.</span> ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="bound">P</span> <span class="main">∪</span> <span class="bound">R</span> <span class="main">∧</span>
    <span class="bound">P</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">R</span> <span class="main">∧</span> <span class="bound">R</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">p1</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">.</span> ω_limit_set <span class="bound">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p1</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">p2</span> <span class="main">∈</span> <span class="bound">P</span><span class="main">.</span> α_limit_set <span class="bound">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p2</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> S <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">K</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wreg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?weq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> wreqweq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wreg</span> <span class="main">∪</span> <span class="var">?weq</span> <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong Collect_disj_eq mem_Collect_eq ω_limit_set_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> trapped_sol_right<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ex_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="main">⊆</span> existence_ivl0 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> wxK<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?weq</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_mono_iff Int_iff inf.absorb_iff1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?weq</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_finite_subset<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_invariant
  <span class="keyword1"><span class="command">have</span></span> xinv<span class="main">:</span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> ω_limit_set_in_compact_nonempty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">]</span> wreqweq
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wreg</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="var">?weq</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="var">?weq</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wreg</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="comment1">(* If w has no regular points then it is equal to a single unique fixed point *)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wreg</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span> rev_finite_subset sup_bot.left_neutral wreqweq<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> finite_ω_limit_set_in_compact_imp_unique_fixed_point<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_empty_left <span class="quoted"><span class="quoted">‹<span class="var">?weq</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?wreg</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> insert_subset wreqweq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">(* If w has no fixed points, then the Poincare Bendixson theorem applies *)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?weq</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> ω_limit_set <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> empty_Collect_eq imageE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> poincare_bendixson<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> periodic_orbit <span class="bound">y</span> <span class="main">∧</span> flow0 <span class="bound">y</span> <span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">(* Otherwise, all points in the limit set converge to a finite subset of the fixed points *)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?weq</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wreg</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yfp</span></span> <span class="keyword2"><span class="keyword">where</span></span> yfp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yfp</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">yfp</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="var">?wreg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p1</span><span class="main">∈</span>ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> ω_limit_set <span class="skolem">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p1</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">p2</span><span class="main">∈</span>ω_limit_set <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> α_limit_set <span class="skolem">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p2</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> zpx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">using</span></span> fixed_point_in_ω_limit_set_imp_ω_limit_set_singleton_fixed_point<span class="main">[</span>
          <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span> yfp zpx <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> S<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">=</span> <span class="var">?weq</span> <span class="main">∪</span> <span class="var">?wreg</span> <span class="main">∧</span>
        <span class="var">?weq</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="var">?wreg</span> <span class="main">∧</span> <span class="var">?wreg</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="var">?wreg</span><span class="main">.</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound">p1</span> <span class="main">∈</span> <span class="var">?weq</span><span class="main">.</span> ω_limit_set <span class="bound">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p1</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound">p2</span> <span class="main">∈</span> <span class="var">?weq</span><span class="main">.</span> α_limit_set <span class="bound">z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p2</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wreqweq <span class="quoted"><span class="quoted">‹<span class="var">?weq</span> <span class="main">⊆</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?wreg</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="var">?wreg</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> poincare_bendixson_applied<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"trapped_forward <span class="skolem">x</span> <span class="free">K</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">K</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> positively_invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="skolem">x</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ω_limit_set_in_compact_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> ω_limit_set <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> poincare_bendixson<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> * this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>flow0 <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> ω_limit_set <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
  Limit cycles are periodic orbits that is the ω (or α)-limit set of some point not in the cycle.
  As with periodic_orbit, limit_cycles are defined for a representative point y
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">limit_cycle</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span>
  periodic_orbit <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> flow0 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">`</span> UNIV <span class="main">∧</span>
  <span class="main">(</span>flow0 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">`</span> UNIV <span class="main">=</span> ω_limit_set <span class="bound">x</span> <span class="main">∨</span> flow0 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">`</span> UNIV <span class="main">=</span> α_limit_set <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">corollary</span></span> poincare_bendixson_limit_cycle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"positively_invariant <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rev.flow0 <span class="free">x</span> <span class="free">t</span> <span class="main">∉</span> <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"limit_cycle <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"trapped_forward <span class="free">x</span> <span class="free">K</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> positively_invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"ω_limit_set <span class="free">x</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ω_limit_set_in_compact_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> ω_limit_set <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> poincare_bendixson<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> * this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_orbit <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>flow0 <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> ω_limit_set <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> exy<span class="main">:</span> <span class="quoted"><span class="quoted">"existence_ivl0 <span class="skolem">y</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_orbit_global_existence periodic_orbit_def y<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> flow0 <span class="skolem">y</span> <span class="main">`</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tt</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> flow0 <span class="skolem">y</span> <span class="skolem">tt</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev.flow0 <span class="main">(</span>flow0 <span class="skolem">y</span> <span class="skolem">tt</span><span class="main">)</span> <span class="free">t</span> <span class="main">∉</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev.flow0 <span class="main">(</span>flow0 <span class="skolem">y</span> <span class="skolem">tt</span><span class="main">)</span> <span class="free">t</span> <span class="main">∈</span> flow0 <span class="skolem">y</span> <span class="main">`</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> exy <span class="keyword1"><span class="command">unfolding</span></span> rev_eq_flow
      <span class="keyword1"><span class="command">using</span></span> UNIV_I <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> flow0 <span class="skolem">y</span> <span class="skolem">tt</span>›</span></span> closed_orbit_ω_limit_set closed_orbit_flow0 periodic_orbit_def y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit_cycle <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"flow0 <span class="skolem">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y c2 <span class="keyword1"><span class="command">unfolding</span></span> limit_cycle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Affine_Arithmetic_Misc">
<div class="head">
<h1>Theory Affine_Arithmetic_Misc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Affine_Arithmetic_Misc
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../HOL-ODE-Numerics/ODE_Numerics.html">HOL-ODE-Numerics.ODE_Numerics</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Branch-And-Bound Arithmetic›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">prove_nonneg</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">*</span> nat <span class="main">*</span> string<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> slp <span class="main">⇒</span> real aform list list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prove_nonneg</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">slp</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main"><span class="bound">_</span></span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> print <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''# depth limit exceeded⏎''</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">()</span> <span class="keyword1">in</span> False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prove_nonneg</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">slp</span></span></span> <span class="free"><span class="bound"><span class="entity">XXS</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">XXS</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">X</span><span class="main">#</span><span class="bound">XS</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">RS</span> <span class="main">=</span> approx_slp_outer <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">slp</span></span></span> <span class="bound">X</span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">RS</span><span class="main">≠</span>None <span class="main">∧</span> Inf_aform' <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>hd <span class="main">(</span>the <span class="bound">RS</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>
        <span class="keyword1">then</span>
          <span class="keyword1">let</span> <span class="main"><span class="bound">_</span></span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> print <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''# Success⏎''</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">()</span><span class="main">;</span>
             <span class="main"><span class="bound">_</span></span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> print <span class="main">(</span>String.implode <span class="main">(</span><span class="main">(</span>shows <span class="inner_quoted">''# ''</span> <span class="keyword1">o</span> shows_box_of_aforms_hr <span class="bound">X</span><span class="main">)</span> <span class="inner_quoted">''⏎''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">()</span><span class="main">;</span>
             <span class="main"><span class="bound">_</span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> print <span class="main">(</span>String.implode <span class="main">(</span>shows_segments_of_aform <span class="bound">a</span> <span class="bound">b</span> <span class="bound">X</span> <span class="bound">c</span> <span class="inner_quoted">''⏎''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="main">()</span>
          <span class="keyword1">in</span> <span class="free">prove_nonneg</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">slp</span></span></span> <span class="bound">XS</span>
        <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main"><span class="bound">_</span></span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> print <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''# Split⏎''</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">()</span> <span class="keyword1">in</span> <span class="keyword1">case</span> split_aforms_largest_uncond <span class="bound">X</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span>
          <span class="free">prove_nonneg</span> <span class="free"><span class="bound"><span class="entity">prnt</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">slp</span></span></span> <span class="main">(</span><span class="bound">a</span><span class="main">#</span><span class="bound">b</span><span class="main">#</span><span class="bound">XS</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prove_nonneg_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="main">0</span> <span class="free">p</span> <span class="free">slp</span> <span class="free">X</span> <span class="main">=</span> False"</span></span>
  <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="free">slp</span> <span class="free">XXS</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">XXS</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">X</span><span class="main">#</span><span class="bound">XS</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">RS</span> <span class="main">=</span> approx_slp_outer <span class="free">p</span> <span class="main">1</span> <span class="free">slp</span> <span class="bound">X</span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">RS</span><span class="main">≠</span>None <span class="main">∧</span> Inf_aform' <span class="free">p</span> <span class="main">(</span>hd <span class="main">(</span>the <span class="bound">RS</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>
        <span class="keyword1">then</span> prove_nonneg <span class="free">prnt</span> <span class="free">i</span> <span class="free">p</span> <span class="free">slp</span> <span class="bound">XS</span>
        <span class="keyword1">else</span> <span class="keyword1">case</span> split_aforms_largest_uncond <span class="bound">X</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> prove_nonneg <span class="free">prnt</span> <span class="free">i</span> <span class="free">p</span> <span class="free">slp</span> <span class="main">(</span><span class="bound">a</span><span class="main">#</span><span class="bound">b</span><span class="main">#</span><span class="bound">XS</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> <span class="main">=</span> prove_nonneg.simps

<span class="keyword1"><span class="command">lemma</span></span> split_aforms_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"real list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"split_aforms <span class="free">XS</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">YS</span><span class="main">,</span> <span class="free">ZS</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> Joints <span class="free">XS</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> Joints <span class="free">YS</span> <span class="main">∪</span> Joints <span class="free">ZS</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_rev_mp<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Joints_map_split_aform<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">XS</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_aforms_def o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prove_nonneg_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="free">slp</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prove_nonneg_fuel_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span>slp_of_fas <span class="main">[</span><span class="free">fa</span><span class="main">]</span><span class="main">)</span> <span class="free">YSS</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="free">i</span> <span class="free">p</span> <span class="main">(</span>slp_of_fas <span class="main">[</span><span class="free">fa</span><span class="main">]</span><span class="main">)</span> <span class="free">YSS</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">YSS</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> <span class="main">=</span> prove_nonneg_simps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prove_nonneg_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prove_nonneg_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prove_nonneg.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prove_nonneg.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prove_nonneg_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="free">i</span> <span class="free">p</span> <span class="main">(</span>slp_of_fas <span class="main">[</span><span class="free">fa</span><span class="main">]</span><span class="main">)</span> <span class="free">YSS</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="free">i</span> <span class="free">p</span> <span class="main">(</span>slp_of_fas <span class="main">[</span><span class="free">fa</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">YS</span> <span class="main">#</span> <span class="free">YSS</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">YS</span></span> <span class="quoted"><span class="free">YSS</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span> <span class="main">=</span> prove_nonneg_simps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prove_nonneg_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prove_nonneg_fuel_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prove_nonneg_fuel_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prove_nonneg_fuel_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prove_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prove_nonneg <span class="free">prnt</span> <span class="free">i</span> <span class="free">p</span> <span class="main">(</span>slp_of_fas <span class="main">[</span><span class="free">fa</span><span class="main">]</span><span class="main">)</span> <span class="free">XSS</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">XS</span> <span class="main">∈</span> set <span class="free">XSS</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Joints <span class="bound">XS</span><span class="main">.</span> interpret_floatarith <span class="free">fa</span> <span class="bound">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">XSS</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">XSS</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">YS</span> <span class="skolem">YSS</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Cons
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> xs <span class="keyword1"><span class="command">using</span></span> Suc.prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> approx_slp_outer_plain<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> Joints_imp_length_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> XS<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_length_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Inf_aform'_Affine_le<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_aforms_largest_uncond_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Suc.IH<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> split_aforms_lemma<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_aforms_largest_uncond_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Suc.IH<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> split_aforms_lemma<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> XS xs <span class="keyword1"><span class="command">using</span></span> Suc.prems
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> prove_nonneg_mono<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> prove_nonneg_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> ys
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> prove_nonneg_mono<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> prove_nonneg_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Examples
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Poincare_Bendixson.html">Poincare_Bendixson</a>
    <span class="quoted">"<a href="../HOL-ODE-Numerics/ODE_Numerics.html">HOL-ODE-Numerics.ODE_Numerics</a>"</span>
    <a href="Affine_Arithmetic_Misc.html">Affine_Arithmetic_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simple›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹coordinate functions›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cx</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cy</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> c_defs <span class="main">=</span> cx_def cy_def

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹partial derivatives›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C11</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C11</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C12</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C12</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C21</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C21</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C22</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C22</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> C_partials <span class="main">=</span> C11_def C12_def C21_def C22_def

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Jacobian as linear map›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> blinfun_of_matrix
    <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">:=</span>C11 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">:=</span>C12 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span>
       <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">:=</span>C21 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">:=</span>C22 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"blinfun_apply <span class="main">(</span>C <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">dx</span><span class="main">,</span> <span class="free">dy</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free">dx</span> <span class="main">*</span> C11 <span class="free">x</span> <span class="free">y</span> <span class="main">+</span> <span class="free">dy</span> <span class="main">*</span> C12 <span class="free">x</span> <span class="free">y</span><span class="main">,</span>
   <span class="free">dx</span> <span class="main">*</span> C21 <span class="free">x</span> <span class="free">y</span> <span class="main">+</span> <span class="free">dy</span> <span class="main">*</span> C22 <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def blinfun_of_matrix_apply Basis_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_continuous<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> local.C <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> C_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> continuous_on_blinfun_of_matrix <span class="dynamic"><span class="dynamic">continuous_intros</span></span> that
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_prod_def C_partials<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> c<span class="main">:</span> c1_on_open_R2 <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">,</span> <span class="bound">y</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>cx <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> cy <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">::</span>real<span class="main">*</span>real"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> C <span class="bound">x</span> <span class="bound">y</span>"</span></span> <span class="quoted">UNIV</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> ext <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="dynamic"><span class="dynamic">algebra_simps</span></span>
      c_defs C_partials power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trapC</span> <span class="main">=</span> cball <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">,</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="numeral">2</span> <span class="main">-</span> ball <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">,</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trapC_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trapC <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">4</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_Pair_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> real_sqrt_le_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> four_x_squared one_le_power real_sqrt_ge_0_iff real_sqrt_pow2<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> real_sqrt_le_mono <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span><span class="skolem">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="skolem">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">+</span> <span class="skolem">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> sqrt <span class="bound">r</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Groups.mult_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> distrib_left linorder_not_le real_sqrt_four real_sqrt_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> x_in_trapC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> trapC"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapC_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_Pair_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compact_trapC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compact trapC"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapC_def
  <span class="keyword1"><span class="command">using</span></span> compact_cball compact_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_trapC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trapC <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> x_in_trapC <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> origin_fixpoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>cx <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> cy <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cx_def cy_def zero_prod_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"((((A&lt;0 * R&lt;1) + (([28859/65536*a + 5089/8192*b + ~1/2] * A=0) + (([~5089/8192*a + 17219/65536*b + ~1/2] * A=1) + (R&lt;1 * ((R&lt;11853/65536 * [~16384/11853*a^2 + ~11585/11853*b^2 + 302/1317*a*b + a + 1940/3951*b]^2) + ((R&lt;73630271/776798208 * [a^2 + 64177444/73630271*b^2 + 44531712/73630271*a*b + ~131061126/73630271*b]^2) + ((R&lt;70211653911/4825433440256 * [~77895776116/70211653911*b^2 + 5825642465/10030236273*a*b + b]^2) + ((R&lt;48375415273/657341564387328 * [~36776393918/48375415273*b^2 + a*b]^2) + (R&lt;18852430195/11096159253659648 * [b^2]^2)))))))))) &amp; (((A&lt;0 * (A&lt;0 * R&lt;1)) + (([b] * A=0) + (([~1*a] * A=1) + (R&lt;1 * (R&lt;1 * [b]^2)))))))"</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="bound">ra</span><span class="main">::</span>real<span class="main">)</span> <span class="main">*</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">ra</span> <span class="main">*</span> <span class="main">-</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">b</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">ra</span><span class="main">.</span> <span class="free">b</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="bound">ra</span> <span class="main">*</span> <span class="main">(</span><span class="bound">r</span> <span class="main">*</span> <span class="main">(</span><span class="bound">ra</span> <span class="main">*</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f3 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> c.vec_simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> right_minus_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">b</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="bound">r</span> <span class="main">*</span> <span class="main">-</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> c.vec_simps<span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> origin_not_trapC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> trapC"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapC_def zero_prod_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_trapC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>cx <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> cy <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> trapC"</span></span>
  <span class="keyword1"><span class="command">using</span></span> origin_fixpoint origin_not_trapC
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> UNIV_I UNIV_I UNIV_def case_prodE2 imageE c.flow_initial_time_if
      c.rev.flow_initial_time_if mem_Collect_eq zero_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_outer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.positively_invariant  <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">4</span><span class="main">)</span> <span class="bound">p</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> c.positively_invariant_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span><span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">_</span></span>  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">p</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> fst <span class="bound">x</span> <span class="main">*</span> fst <span class="bound">p</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> snd <span class="bound">x</span> <span class="main">*</span> snd <span class="bound">p</span>"</span></span> <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cx_def cy_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"(((A&lt;0 * R&lt;1) + (R&lt;1 * ((R&lt;6 * [a]^2) + (R&lt;6 * [b]^2)))))"</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_inner<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.positively_invariant  <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">4</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> c.positively_invariant_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span><span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">p</span><span class="main">.</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> fst <span class="bound">x</span> <span class="main">*</span> fst <span class="bound">p</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> snd <span class="bound">x</span> <span class="main">*</span> snd <span class="bound">p</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cx_def cy_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"(((A&lt;0 * R&lt;1) + (R&lt;1 * ((R&lt;3/2 * [a]^2) + (R&lt;3/2 * [b]^2)))))"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_trapC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.positively_invariant trapC"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapC_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> c.positively_invariant_conj<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> positively_invariant_outer
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong case_prodE case_prodI2 case_prod_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> positively_invariant_inner
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong case_prodE case_prodI2 case_prod_conv<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> c_has_periodic_orbit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"c.periodic_orbit <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"c.flow0 <span class="free">y</span> <span class="main">`</span> UNIV <span class="main">⊆</span> trapC"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> c.poincare_bendixson_applied<span class="main">[</span><span class="operator">OF</span> compact_trapC _ nonempty_trapC positively_invariant_trapC regular_trapC<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Real-Arithmetic›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> c_fas<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">-</span><span class="main">(</span><span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> interpret_floatariths <span class="var">?fas</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">reify_floatariths</span><span class="main">)</span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">c_fas</span> <span class="keyword2"><span class="keyword">uses</span></span> c_fas

<span class="keyword1"><span class="command">interpretation</span></span> crev<span class="main">:</span> ode_interpretation <span class="quoted">true_form</span> <span class="quoted">UNIV</span> <span class="quoted">c_fas</span>
  <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>cx <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> cy <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">::</span>real<span class="main">*</span>real<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">::</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">d</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_fas_def less_Suc_eq_0_disj nth_Basis_list_prod Basis_list_real_def
      cx_def cy_def eval_nat_numeral
      mk_ode_ops_def eucl_of_list_prod power2_eq_square <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> isFDERIV_I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">/</span><span class="numeral">8</span> <span class="main">..</span> <span class="main">1</span><span class="main">/</span><span class="numeral">8</span><span class="main">}</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">..</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span>
   <span class="free">t</span> <span class="main">∈</span> c.rev.existence_ivl0 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∧</span> c.rev.flow0 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="numeral">5.15</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.651</span><span class="main">)</span><span class="main">..</span><span class="main">(</span><span class="numeral">5.18</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.647</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹<span class="entity">ode_bnds_tac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> c_fas_def<span class="antiquote">}</span></span></span> <span class="inner_numeral">30</span> <span class="inner_numeral">20</span> <span class="inner_numeral">7</span> <span class="inner_numeral">12</span> <span class="main">[</span><span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">,</span> <span class="inner_quoted">"0x000000"</span><span class="main">)</span><span class="main">]</span> <span class="comment1">(* "crev.out" *)</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span>›</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> c_has_limit_cycle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"c.limit_cycle <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>c.flow0 <span class="free">y</span><span class="main">)</span> <span class="main">⊆</span> trapC"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="numeral">5.15</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.651</span><span class="main">)</span><span class="main">..</span><span class="main">(</span><span class="numeral">5.18</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.647</span><span class="main">)</span><span class="main">::</span>real<span class="main">*</span>real<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> crev <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c.rev.flow0 <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">8</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∩</span> trapC <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_prod_def less_eq_prod_def E_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> power2_less_eq_zero_iff real_less_rsqrt zero_compare_simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">x</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> trapC"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trapC_def dist_prod_def norm_prod_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c.rev.flow0 <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">∉</span> trapC"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> c.poincare_bendixson_limit_cycle<span class="main">[</span><span class="operator">OF</span> compact_trapC subset_UNIV x_in_trapC positively_invariant_trapC regular_trapC this<span class="main">]</span> that
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Glycolysis›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Strogatz, Example 7.3.2›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹coordinate functions›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gx</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="numeral">0.08</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gy</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="numeral">0.6</span> <span class="main">-</span> <span class="numeral">0.08</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> g_defs <span class="main">=</span> gx_def gy_def

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹partial derivatives›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A11</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A11</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A12</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A12</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="numeral">0.08</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A21</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A21</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A22</span><span class="main">::</span><span class="quoted"><span class="quoted">"real<span class="main">⇒</span>real<span class="main">⇒</span>real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A22</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="numeral">0.08</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> A_partials <span class="main">=</span> A11_def A12_def A21_def A22_def

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Jacobian as linear map›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> <span class="keyword1">⇒<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> blinfun_of_matrix
    <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">:=</span>A11 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">:=</span>A12 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span>
       <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">:=</span>A21 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">:=</span>A22 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> A_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"blinfun_apply <span class="main">(</span>A <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">dx</span><span class="main">,</span> <span class="free">dy</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free">dx</span> <span class="main">*</span> A11 <span class="free">x</span> <span class="free">y</span> <span class="main">+</span> <span class="free">dy</span> <span class="main">*</span> A12 <span class="free">x</span> <span class="free">y</span><span class="main">,</span>
   <span class="free">dx</span> <span class="main">*</span> A21 <span class="free">x</span> <span class="free">y</span> <span class="main">+</span> <span class="free">dy</span> <span class="main">*</span> A22 <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def blinfun_of_matrix_apply Basis_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> A_continuous<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> local.A <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> continuous_on_blinfun_of_matrix <span class="dynamic"><span class="dynamic">continuous_intros</span></span> that
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_prod_def A_partials<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> g<span class="main">:</span> c1_on_open_R2 <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>real<span class="main">,</span> <span class="bound">y</span><span class="main">::</span>real<span class="main">)</span><span class="main">.</span> <span class="main">(</span>gx <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> gy <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">::</span>real<span class="main">*</span>real"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> A <span class="bound">x</span> <span class="bound">y</span>"</span></span> <span class="quoted">UNIV</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> ext <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="dynamic"><span class="dynamic">algebra_simps</span></span>
      g_defs A_partials<span class="main">)</span>

<span class="comment1">(*
  The outer invariant is the convex set formed by the axes, y ≤ 7.51, and x+y≤8.12
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pos_quad</span><span class="main">::</span><span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> set<span class="main">)</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">p</span> <span class="main">.</span> <span class="main">-</span> snd <span class="bound">p</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">p</span> <span class="main">.</span> <span class="main">-</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">trapG1</span><span class="main">::</span><span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> set<span class="main">)</span> <span class="main">=</span> pos_quad <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">751</span><span class="main">/</span><span class="numeral">100</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">812</span><span class="main">/</span><span class="numeral">100</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_y<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g.positively_invariant <span class="main">{</span><span class="bound">p</span> <span class="main">.</span> <span class="main">-</span> snd <span class="bound">p</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> g.positively_invariant_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span><span class="numeral">0.08</span> <span class="main">+</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">p</span><span class="main">.</span> <span class="main">-</span> snd <span class="bound">p</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> gy_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"()"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_pos_quad<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g.positively_invariant pos_quad"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pos_quad_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> g.positively_invariant_le_domain<span class="main"><span class="main">[</span></span><span class="operator">OF</span> positively_invariant_y<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">*</span> snd <span class="bound">p</span> <span class="main">-</span><span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> gx_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"(((A&lt;0 * R&lt;1) + (((A&lt;0 * R&lt;1) * (R&lt;11/14 * [1]^2)) + ((A&lt;=0 * R&lt;1) * (R&lt;1/7 * [1]^2)))))"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_y_upper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g.positively_invariant <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">751</span><span class="main">/</span><span class="numeral">100</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> g.positively_invariant_barrier<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> gy_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"((R&lt;1 + ((R&lt;1 * (R&lt;18775/2 * [a]^2)) + ((A&lt;=0 * R&lt;1) * (R&lt;1250 * [1]^2)))))"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arith2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="numeral">751</span><span class="main">/</span><span class="numeral">100</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="numeral">812</span><span class="main">/</span><span class="numeral">100</span> <span class="main">⟹</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">5</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_trapG1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g.positively_invariant trapG1"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapG1_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> g.positively_invariant_conj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> positively_invariant_pos_quad<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> g.positively_invariant_barrier_domain<span class="main"><span class="main">[</span></span><span class="operator">OF</span> positively_invariant_y_upper<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> gx_def gy_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Polynomial in invariant *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>real<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="numeral">21</span><span class="main">/</span><span class="numeral">34</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">69</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">/</span><span class="numeral">38</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">19</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">/</span><span class="numeral">15</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">9</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="numeral">28</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">4</span><span class="main">)</span><span class="main">/</span><span class="numeral">43</span> <span class="main">+</span> <span class="main">(</span> <span class="numeral">14</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">/</span><span class="numeral">29</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">31</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">/</span><span class="numeral">21</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">182</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">/</span><span class="numeral">47</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">35</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">3</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">/</span><span class="numeral">16</span> <span class="main">-</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">/</span><span class="numeral">17</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">/</span><span class="numeral">9</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">31</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">/</span><span class="numeral">20</span> <span class="main">+</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">102</span> <span class="main">+</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">^</span><span class="numeral">3</span><span class="main">)</span><span class="main">/</span><span class="numeral">59</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1d</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">=</span> <span class="numeral">38</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">15</span> <span class="main">-</span> <span class="numeral">69</span> <span class="main">*</span> fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">/</span> <span class="numeral">38</span> <span class="main">-</span>
          <span class="numeral">27</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">28</span> <span class="main">-</span>
          <span class="numeral">24</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">43</span> <span class="main">+</span>
          <span class="numeral">14</span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">/</span> <span class="numeral">29</span> <span class="main">+</span>
          <span class="main">(</span><span class="numeral">651</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span><span class="main">)</span> <span class="main">+</span>
           <span class="numeral">651</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
          <span class="numeral">441</span> <span class="main">+</span>
          <span class="main">(</span><span class="numeral">8554</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span><span class="main">)</span> <span class="main">+</span>
           <span class="numeral">17108</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
          <span class="numeral">2209</span> <span class="main">-</span>
          <span class="main">(</span><span class="numeral">560</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span><span class="main">)</span> <span class="main">+</span>
           <span class="numeral">1680</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
          <span class="numeral">256</span> <span class="main">-</span>
          <span class="numeral">6</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">17</span> <span class="main">-</span>
          <span class="main">(</span><span class="numeral">36</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
           <span class="numeral">18</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
          <span class="numeral">81</span> <span class="main">-</span>
          <span class="main">(</span><span class="numeral">1240</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
           <span class="numeral">1240</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
          <span class="numeral">400</span> <span class="main">+</span>
          snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">34</span> <span class="main">+</span>
          <span class="main">(</span><span class="numeral">177</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
           fst <span class="free"><span class="bound"><span class="entity">xa</span></span></span> <span class="main">*</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="numeral">59</span><span class="main">)</span> <span class="main">/</span>
          <span class="numeral">3481</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p1_has_derivative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> p1 <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_derivative</span> p1d <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> p1_def p1d_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>

<span class="comment1">(* p1 excludes equilibria for free *)</span>
<span class="keyword1"><span class="command">lemma</span></span> p1_not_equil<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" p1 <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> gx <span class="free">x</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> gy <span class="free">x</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gx_def gy_def p1_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"()"</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trapG</span> <span class="main">=</span> trapG1 <span class="main">∩</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> p1 <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Real-Arithmetic›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">g_arith</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="numeral">27</span> <span class="main">/</span> <span class="numeral">25</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">*</span> p1 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">-</span> p1d <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>gx <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> gy <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> g_arith_fas<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>g_arith <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> interpret_floatariths <span class="var">?fas</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_arith_def p1_def p1d_def gx_def gy_def fst_conv snd_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">reify_floatariths</span><span class="main">)</span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">g_arith_fas</span> <span class="keyword2"><span class="keyword">uses</span></span> g_arith_fas

<span class="keyword1"><span class="command">lemma</span></span> list_interval2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_interval <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">[</span><span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">..</span> <span class="free">c</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">b</span> <span class="main">..</span> <span class="free">d</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_interval_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y zs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_arith_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"g_arith <span class="free">a</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="numeral">8.24</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="numeral">7.51</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prove_nonneg <span class="main">[</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="inner_quoted">''0x000000''</span><span class="main">)</span><span class="main">]</span> <span class="numeral">1000000</span> <span class="numeral">30</span> <span class="main">(</span>slp_of_fas <span class="main">[</span>hd g_arith_fas<span class="main">]</span><span class="main">)</span> <span class="main">[</span>aforms_of_ivls <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>
    <span class="main">[</span>float_divr <span class="numeral">30</span> <span class="numeral">824</span> <span class="numeral">100</span><span class="main">,</span> float_divr <span class="numeral">30</span> <span class="numeral">751</span> <span class="numeral">100</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span><span class="comment1">― ‹slow: 60s›</span>
  <span class="keyword1"><span class="command">from</span></span> prove_nonneg<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> interpret_floatarith <span class="main">(</span>hd g_arith_fas<span class="main">)</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_arith_fas<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> Joints_aforms_of_ivls<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> divide_nonneg_nonneg float_divr float_numeral rel_simps<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> divide_nonneg_nonneg float_divr float_numeral rel_simps<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list_interval2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> a b
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ float_divr<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ float_divr<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> g_arith <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_arith_fas_def g_arith_def p1_def p1d_def gx_def gy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trap_arithmetic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"p1d <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>gx <span class="free">a</span> <span class="free">b</span><span class="main">,</span> gy <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="numeral">27</span> <span class="main">/</span> <span class="numeral">25</span><span class="main">)</span> <span class="main">-</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> p1 <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> trapG1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="numeral">7.51</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="numeral">8.24</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trapG1_def pos_quad_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> g_arith_nonneg<span class="main">[</span><span class="operator">OF</span> a b<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_arith_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> positively_invariant_trapG<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g.positively_invariant trapG"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapG_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> g.positively_invariant_le_domain<span class="main"><span class="main">[</span></span><span class="operator">OF</span> positively_invariant_trapG1 _ p1_has_derivative<span class="main"><span class="main">,</span></span>
        <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">-</span><span class="numeral">1.08</span> <span class="main">-</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> fst <span class="bound">p</span> <span class="main">*</span> snd <span class="bound">p</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_quad_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trap_arithmetic<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_trapG<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>gx <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> gy <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> trapG"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapG_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> p1_not_equil
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> arith<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">::</span>real<span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">⟹</span>
           <span class="main">0</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">⟹</span>
           <span class="bound">b</span> <span class="main">*</span> <span class="numeral">100</span> <span class="main">≤</span> <span class="numeral">751</span> <span class="main">⟹</span>
           <span class="bound">a</span> <span class="main">*</span> <span class="numeral">25</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="numeral">25</span> <span class="main">≤</span> <span class="numeral">203</span> <span class="main">⟹</span> norm <span class="bound">a</span> <span class="main">+</span> norm <span class="bound">b</span> <span class="main">≤</span> <span class="numeral">20</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trapG1_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trapG1 <span class="main">⊆</span> cball <span class="main">(</span><span class="main">0</span><span class="main">::</span>real <span class="main">×</span> real<span class="main">)</span> <span class="numeral">20</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapG1_def pos_quad_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> arith norm_Pair_le
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>

<span class="keyword1"><span class="command">lemma</span></span> compact_subset_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> compact_Int_closed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compact_trapG1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compact trapG1"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compact_subset_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ trapG1_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapG1_def pos_quad_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> closed_Collect_le <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compact_trapG<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compact trapG"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapG_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compact_Int_closed compact_trapG1 closed_Collect_le <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> x_in_trapG<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> trapG"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trapG_def trapG1_def pos_quad_def p1_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_Pair_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> g_fas<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">/</span> <span class="numeral">100</span> <span class="main">*</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="main">-</span><span class="main">(</span> <span class="numeral">6</span> <span class="main">/</span> <span class="numeral">10</span> <span class="main">-</span> <span class="numeral">8</span> <span class="main">/</span> <span class="numeral">100</span> <span class="main">*</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">X</span><span class="main">!</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> interpret_floatariths <span class="var">?fas</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">reify_floatariths</span><span class="main">)</span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">g_fas</span> <span class="keyword2"><span class="keyword">uses</span></span> g_fas

<span class="keyword1"><span class="command">interpretation</span></span> grev<span class="main">:</span> ode_interpretation <span class="quoted">true_form</span> <span class="quoted">UNIV</span> <span class="quoted">g_fas</span>
  <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>gx <span class="bound">x</span> <span class="bound">y</span><span class="main">,</span> gy <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">::</span>real<span class="main">*</span>real<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">::</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">d</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_fas_def less_Suc_eq_0_disj nth_Basis_list_prod Basis_list_real_def
      gx_def gy_def eval_nat_numeral
      mk_ode_ops_def eucl_of_list_prod power2_eq_square <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> isFDERIV_I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> grev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">/</span><span class="numeral">8</span> <span class="main">..</span> <span class="main">1</span><span class="main">/</span><span class="numeral">8</span><span class="main">}</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">..</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span>
   <span class="free">t</span> <span class="main">∈</span> g.rev.existence_ivl0 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∧</span> g.rev.flow0 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">∈</span>
    <span class="main">{</span><span class="main">(</span><span class="numeral">1.1</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.09</span><span class="main">)</span> <span class="main">..</span> <span class="main">(</span><span class="numeral">1.2</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.08</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹<span class="entity">ode_bnds_tac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> g_fas_def<span class="antiquote">}</span></span></span> <span class="inner_numeral">30</span> <span class="inner_numeral">20</span> <span class="inner_numeral">7</span> <span class="inner_numeral">12</span> <span class="main">[</span><span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">,</span> <span class="inner_quoted">"0x000000"</span><span class="main">)</span><span class="main">]</span> <span class="comment1">(* "grev.out" *)</span> <span class="inner_quoted">""</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">1</span>›</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> g_has_limit_cycle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"g.limit_cycle <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>g.flow0 <span class="free">y</span><span class="main">)</span> <span class="main">⊆</span> trapG"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>real<span class="main">*</span>real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="numeral">1.1</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.09</span><span class="main">)</span> <span class="main">..</span> <span class="main">(</span><span class="numeral">1.2</span><span class="main">,</span> <span class="main">-</span><span class="numeral">0.08</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> grev <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"g.rev.flow0 <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">8</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">∩</span> trapG <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trapG_def E_def trapG1_def pos_quad_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"g.rev.flow0 <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">∉</span> trapG"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> g.poincare_bendixson_limit_cycle<span class="main">[</span><span class="operator">OF</span> compact_trapG subset_UNIV x_in_trapG positively_invariant_trapG regular_trapG this<span class="main">]</span> that
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>