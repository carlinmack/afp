<div id="KMP">
<div class="head">
<h1>Theory KMP</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> KMP
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Refine_Imperative_HOL/IICF.html">Refine_Imperative_HOL.IICF</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> len_greater_imp_nonempty<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> min_absorb2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">no_notation</span></span> Ref.update <span class="main">(</span><span class="quoted">"_ <span class="keyword1">:=</span> _"</span> 62<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Specification›</span></span><span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\label{sec:spec}›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Sublist-predicate with a position check›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹One could define›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sublist_at'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>  

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹However, this doesn't handle out-of-bound indexes uniformly:›</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"sublist_at' <span class="main">[]</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="numeral">5</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"sublist_at' <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="numeral">5</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>nbe<span class="main">]</span> <span class="quoted"><span class="quoted">"sublist_at' <span class="main">[]</span> <span class="main">[]</span> <span class="numeral">5</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Instead, we use a recursive definition:›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sublist_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sublist_at</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">sublist_at</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sublist_at</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">sublist_at</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sublist_at</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">0</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sublist_at</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the relevant cases, both definitions agree:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">ys</span> <span class="main">⟹</span> sublist_at <span class="free">xs</span> <span class="free">ys</span> <span class="free">i</span> <span class="main">⟷</span> sublist_at' <span class="free">xs</span> <span class="free">ys</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sublist_at'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sublist_at.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹However, the new definition has some reasonable properties:›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Properties›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sublist_lengths<span class="main">:</span> <span class="quoted"><span class="quoted">"sublist_at <span class="free">xs</span> <span class="free">ys</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">+</span> length <span class="free">xs</span> <span class="main">≤</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sublist_at.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Nil_is_sublist<span class="main">:</span> <span class="quoted"><span class="quoted">"sublist_at <span class="main">(</span><span class="main">[]</span> <span class="main">::</span> <span class="tfree">'x</span> list<span class="main">)</span> <span class="free">ys</span> <span class="free">i</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">::</span> <span class="tfree">'x</span> list"</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sublist_at.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Furthermore, we need:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sublist_step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">+</span> length <span class="free">xs</span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">;</span> sublist_at <span class="free">xs</span> <span class="free">ys</span> <span class="free">i</span><span class="main">;</span> <span class="free">ys</span><span class="main">!</span><span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> sublist_at <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">ys</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sublist_at.induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> sublist_at.elims<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> all_positions_sublist<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">+</span> length <span class="free">xs</span> <span class="main">≤</span> length <span class="free">ys</span><span class="main">;</span> <span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">ys</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">jj</span><span class="main">⟧</span> <span class="main">⟹</span> sublist_at <span class="free">xs</span> <span class="free">ys</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil_is_sublist<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">ys</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> length <span class="skolem">xs</span> <span class="main">≤</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="free">ys</span><span class="main">!</span><span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">!</span><span class="bound">jj</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sublist_at <span class="skolem">xs</span> <span class="free">ys</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sublist_all_positions<span class="main">:</span> <span class="quoted"><span class="quoted">"sublist_at <span class="free">xs</span> <span class="free">ys</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">ys</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">jj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sublist_at.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It also connects well to theory <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> "<a href="../../HOL/HOL-Library/Sublist.html"></a><a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"<span class="antiquote"><span class="antiquote">}</span></span></span></span> (compare <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sublist_def<span class="antiquote"><span class="antiquote">}</span></span></span></span>):›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sublist_at_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sublist_at <span class="free">xs</span> <span class="free">ys</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ps</span> <span class="bound">ss</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">ps</span><span class="main">@</span><span class="free">xs</span><span class="main">@</span><span class="bound">ss</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> length <span class="bound">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sublist_at.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ss</span> <span class="skolem">t</span> <span class="skolem">ts</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sublist_at <span class="skolem">ss</span> <span class="main">(</span><span class="skolem">t</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">t</span><span class="main">#</span><span class="skolem">ts</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">@</span><span class="skolem">ss</span><span class="main">@</span><span class="bound">ys</span> <span class="main">∧</span> Suc <span class="skolem">i</span> <span class="main">=</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sublist_at <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.IH"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="skolem">ss</span><span class="main">@</span><span class="bound">ys</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">t</span><span class="main">#</span><span class="skolem">ts</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">@</span><span class="skolem">ss</span><span class="main">@</span><span class="bound">ys</span> <span class="main">∧</span> Suc <span class="skolem">i</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">t</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">t</span><span class="main">#</span><span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="skolem">ss</span><span class="main">@</span><span class="bound">ys</span> <span class="main">∧</span> length <span class="skolem">xs</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="main">(</span>tl <span class="skolem">xs</span><span class="main">)</span><span class="main">@</span><span class="skolem">ss</span><span class="main">@</span><span class="bound">ys</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> length <span class="main">(</span>tl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Suc_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">@</span><span class="skolem">ss</span><span class="main">@</span><span class="bound">ys</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> length <span class="bound">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.IH"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> sublist_iff_sublist_at<span class="main">:</span> <span class="quoted"><span class="quoted">"Sublist.sublist <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> sublist_at <span class="free">xs</span> <span class="free">ys</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sublist_at_altdef Sublist.sublist_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Sublist-check algorithms›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  We use the Isabelle Refinement Framework (Theory <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../Refine_Monadic/Refine_Monadic.html"></a><a href="../Refine_Monadic/Refine_Monadic.html">Refine_Monadic.Refine_Monadic</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>) to
  phrase the specification and the algorithm. 
›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for "searchword" / "searchlist", <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for "text"›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kmp_SPEC</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> SPEC <span class="main">(</span><span class="main">λ</span>
  None <span class="main">⇒</span> <span class="main">∄</span><span class="bound">i</span><span class="main">.</span> sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span> <span class="main">|</span>
  Some <span class="bound">i</span> <span class="main">⇒</span> sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">ii</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_arg_min_id<span class="main">:</span> <span class="quoted"><span class="quoted">"is_arg_min id <span class="free">P</span> <span class="free">i</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">ii</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_arg_min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> kmp_result<span class="main">:</span> <span class="quoted"><span class="quoted">"kmp_SPEC <span class="free">s</span> <span class="free">t</span> <span class="main">=</span>
  RETURN <span class="main">(</span><span class="keyword1">if</span> sublist <span class="free">s</span> <span class="free">t</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> sublist_at <span class="free">s</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kmp_SPEC_def sublist_iff_sublist_at
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_less_Least <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> LeastI nat_neq_iff not_less_Least<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> weak_kmp_SPEC<span class="main">:</span> <span class="quoted"><span class="quoted">"kmp_SPEC <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">pos</span><span class="main">.</span> <span class="bound">pos</span><span class="main">≠</span>None <span class="main">⟷</span> Sublist.sublist <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kmp_result<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> kmp_SPEC_altdefs <span class="main">=</span>
  kmp_SPEC_def<span class="main">[</span><span class="operator">folded</span> is_arg_min_id<span class="main">]</span>
  kmp_SPEC_def<span class="main">[</span><span class="operator">folded</span> sublist_iff_sublist_at<span class="main">]</span>
  kmp_result

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Naive algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Since KMP is a direct advancement of the naive "test-all-starting-positions" approach, we provide it here for comparison:›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_out_na</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">ii</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">pos</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span>
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">=</span><span class="bound">i</span> <span class="main">∧</span> sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_in_na</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span>
  <span class="keyword1">case</span> <span class="bound">pos</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">jj</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Algorithm›</span></span>

<span class="comment1">(*Algorithm is common knowledge ⟶ remove citation here, move explanations to KMP below?*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following definition is taken from Helmut Seidl's lecture on algorithms and data structures<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> GAD<span class="antiquote"><span class="antiquote">}</span></span></span></span> except that we
<span class="antiquoted"><span class="antiquoted">▪</span></span> output the identified position <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">pos</span></span> <span class="main"><span class="main">::</span></span> nat option›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> instead of just <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> True<span class="antiquote"><span class="antiquote">}</span></span></span></span>
<span class="antiquoted"><span class="antiquoted">▪</span></span> use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">pos</span></span> <span class="main"><span class="main">::</span></span> nat option›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as break-flag to support the abort within the loops
<span class="antiquoted"><span class="antiquoted">▪</span></span> rewrite <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">i</span></span> <span class="main"><span class="main">≤</span></span> length <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">-</span></span> length <span class="free"><span class="free">s</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the first while-condition to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">i</span></span> <span class="main"><span class="main">+</span></span> length <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">≤</span></span> length <span class="free"><span class="free">t</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to avoid having to use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">int</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for list indexes (or the additional precondition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹length <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">≤</span></span> length <span class="free"><span class="free">t</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">naive_algorithm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">;</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_out_na <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_in_na <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="bound">j</span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">j</span><span class="main">=</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">pos</span><span class="main">=</span>None <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>

  RETURN <span class="bound">pos</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The basic lemmas on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sublist_at<span class="antiquote"><span class="antiquote">}</span></span></span></span> from the previous chapter together with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../Refine_Monadic/Refine_Monadic.html"></a><a href="../Refine_Monadic/Refine_Monadic.html">Refine_Monadic.Refine_Monadic</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s verification condition generator / solver suffice:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> naive_algorithm <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> kmp_SPEC <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> naive_algorithm_def kmp_SPEC_def I_out_na_def I_in_na_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span>
    WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> length <span class="free">t</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">pos</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>nat option<span class="main">)</span><span class="main">.</span> length <span class="free">s</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vc_solve</span> <span class="quasi_keyword">solve</span><span class="main"><span class="main">:</span></span> asm_rl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right all_positions_sublist less_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_SucE sublist_all_positions<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> sublist_lengths add_less_cancel_right leI le_less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Note that the precondition cannot be removed without an extra branch: If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the inner while-condition accesses out-of-bound memory. This will apply to KMP, too.›</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Knuth--Morris--Pratt algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Just like our templates<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> KMP77<span class="antiquote"><span class="antiquote">}</span></span></span></span><span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> GAD<span class="antiquote"><span class="antiquote">}</span></span></span></span>, we first verify the main routine and discuss the computation of the auxiliary values <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">𝔣</span></span> <span class="free"><span class="free">s</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> only in a later section.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Preliminaries: Borders of lists›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">border</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> prefix <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∧</span> suffix <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">strict_border</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> border <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">intrinsic_border</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">≡</span> <span class="keyword1">ARG_MAX</span> length <span class="bound">b</span><span class="main">.</span> strict_border <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> border_order<span class="main">:</span> order <span class="quoted">border</span> <span class="quoted">strict_border</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> border_def suffix_def strict_border_def<span class="main">)</span>
<span class="keyword1"><span class="command">interpretation</span></span> border_bot<span class="main">:</span> order_bot <span class="quoted">Nil</span> <span class="quoted">border</span> <span class="quoted">strict_border</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> border_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> borderE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"border <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"suffix <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_borderE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"border <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> strict_border_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_border_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_border <span class="free">xs</span> <span class="main">[]</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"strict_border <span class="main">[]</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_border_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_border_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> strict_prefix <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> strict_border_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> strict_suffix <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> strict_border_imp_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> strict_border_prefix_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> strict_prefix <span class="free">xs</span> <span class="free">ys</span> <span class="main">∧</span> strict_suffix <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> border_order.order.strict_iff_order border_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> border_length_le<span class="main">:</span> <span class="quoted"><span class="quoted">"border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">≤</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_length_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> border_length_r_less <span class="comment1">(*rm*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> strict_border <span class="bound">xs</span> <span class="free">ys</span> <span class="main">⟶</span> length <span class="bound">xs</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_borderE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> border_positions<span class="main">:</span> <span class="quoted"><span class="quoted">"border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">ys</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">ys</span><span class="main">!</span><span class="main">(</span>length <span class="free">ys</span> <span class="main">-</span> length <span class="free">xs</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> border_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_add_inverse diff_add_inverse2 length_append not_add_less1 nth_append prefixE suffixE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> all_positions_drop_length_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> length <span class="free">w</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">x</span><span class="main">;</span>
  <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">w</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">w</span> <span class="main">+</span> <span class="bound">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> drop <span class="main">(</span>length <span class="free">w</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> length <span class="free">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> all_positions_suffix_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">≤</span> length <span class="free">w</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">x</span><span class="main">;</span>
  <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">w</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">w</span> <span class="main">+</span> <span class="bound">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> suffix <span class="main">(</span>take <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_positions_drop_length_take suffix_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> suffix_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"suffix <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> suffix <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 butlast.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> butlast_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> positions_border<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="free">w</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="main">(</span>length <span class="free">w</span> <span class="main">-</span> <span class="free">l</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> border <span class="main">(</span>take <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> border_def all_positions_suffix_take take_is_prefix<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> positions_strict_border<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">l</span><span class="main">.</span> <span class="free">w</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">w</span><span class="main">!</span><span class="main">(</span>length <span class="free">w</span> <span class="main">-</span> <span class="free">l</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> strict_border <span class="main">(</span>take <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> positions_border strict_border_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> intrinsic_borderI <span class="main">=</span> arg_max_natI<span class="main">[</span><span class="operator">OF</span> _ border_length_r_less<span class="main">,</span> <span class="operator">folded</span> intrinsic_border_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> intrinsic_borderI' <span class="main">=</span> border_bot.bot.not_eq_extremum<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">THEN</span> intrinsic_borderI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> intrinsic_border_max <span class="main">=</span> arg_max_nat_le<span class="main">[</span><span class="operator">OF</span> _ border_length_r_less<span class="main">,</span> <span class="operator">folded</span> intrinsic_border_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_is_arg_max_ib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> is_arg_max length <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> strict_border <span class="bound">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>intrinsic_border <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intrinsic_borderI' intrinsic_border_max is_arg_max_linorder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intrinsic_border_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> length <span class="main">(</span>intrinsic_border <span class="free">w</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> intrinsic_borderI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> border_length_r_less intrinsic_borderI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> intrinsic_border_take_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> length <span class="main">(</span>intrinsic_border <span class="main">(</span>take <span class="free">j</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intrinsic_border_less length_take less_not_refl2 min_less_iff_conj take_eq_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> border_example<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> border <span class="bound">b</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="inner_quoted">''''</span><span class="main">,</span> <span class="inner_quoted">''a''</span><span class="main">,</span> <span class="inner_quoted">''aa''</span><span class="main">,</span> <span class="inner_quoted">''aabaa''</span><span class="main">,</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> border <span class="bound">b</span> <span class="var">?l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="var">?take0</span><span class="main">,</span> <span class="var">?take1</span><span class="main">,</span> <span class="var">?take2</span><span class="main">,</span> <span class="var">?take5</span><span class="main">,</span> <span class="var">?l</span><span class="main">}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?take0</span><span class="main">,</span> <span class="var">?take1</span><span class="main">,</span> <span class="var">?take2</span><span class="main">,</span> <span class="var">?take5</span><span class="main">,</span> <span class="var">?l</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> border <span class="bound">b</span> <span class="var">?l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">eval</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>border <span class="inner_quoted">''aab''</span> <span class="var">?l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>border <span class="inner_quoted">''aaba''</span> <span class="var">?l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>border <span class="inner_quoted">''aabaab''</span> <span class="var">?l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>border <span class="inner_quoted">''aabaaba''</span> <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> border <span class="bound">b</span> <span class="var">?l</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">(</span>prefixes <span class="var">?l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> border_def in_set_prefixes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> border <span class="bound">b</span> <span class="var">?l</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="var">?take0</span><span class="main">,</span> <span class="var">?take1</span><span class="main">,</span> <span class="var">?take2</span><span class="main">,</span> <span class="var">?take5</span><span class="main">,</span> <span class="var">?l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> strict_border_example<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">b</span><span class="main">.</span> strict_border <span class="bound">b</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="inner_quoted">''''</span><span class="main">,</span> <span class="inner_quoted">''a''</span><span class="main">,</span> <span class="inner_quoted">''aa''</span><span class="main">,</span> <span class="inner_quoted">''aabaa''</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> border <span class="bound">b</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="inner_quoted">''''</span><span class="main">,</span> <span class="inner_quoted">''a''</span><span class="main">,</span> <span class="inner_quoted">''aa''</span><span class="main">,</span> <span class="inner_quoted">''aabaa''</span><span class="main">,</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> border_example<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">⊆</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="quoted"><span class="quoted">"intrinsic_border <span class="inner_quoted">''aabaabaa''</span> <span class="main">=</span> <span class="inner_quoted">''aabaa''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">― ‹We later obtain a fast algorithm for that.›</span>
  <span class="keyword1"><span class="command">have</span></span> exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_border <span class="skolem">b</span> <span class="inner_quoted">''aabaabaa''</span> <span class="main">⟷</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="inner_quoted">''''</span><span class="main">,</span> <span class="inner_quoted">''a''</span><span class="main">,</span> <span class="inner_quoted">''aa''</span><span class="main">,</span> <span class="inner_quoted">''aabaa''</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> strict_border_example <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_arg_max length <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> strict_border <span class="bound">b</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">)</span> <span class="inner_quoted">''''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_arg_max length <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> strict_border <span class="bound">b</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">)</span> <span class="inner_quoted">''a''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_arg_max length <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> strict_border <span class="bound">b</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">)</span> <span class="inner_quoted">''aa''</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_arg_max length <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> strict_border <span class="bound">b</span> <span class="inner_quoted">''aabaabaa''</span><span class="main">)</span> <span class="inner_quoted">''aabaa''</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_arg_max_linorder <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>intrinsic_border <span class="inner_quoted">''aabaabaa''</span><span class="main">)</span> <span class="inner_quoted">''aabaabaa''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intrinsic_borderI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">unfolded</span> exhaust<span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> list.discI nonempty_is_arg_max_ib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Main routine›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following is Seidl's "border"-table<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> GAD<span class="antiquote"><span class="antiquote">}</span></span></span></span> (values shifted by 1 so we don't need <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">int</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>),
or equivalently, "f" from Knuth's, Morris' and Pratt's paper<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> KMP77<span class="antiquote"><span class="antiquote">}</span></span></span></span> (with indexes starting at 0).›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝔣</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔣</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="comment1">― ‹This increments the compare position while <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">‹<span class="free">j</span><span class="main">=</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>›</span><span class="antiquote">}</span></span>›</span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔣</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> length <span class="main">(</span>intrinsic_border <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Note that we use their "next" only implicitly.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_outer</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">ii</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="bound">pos</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">jj</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">=</span><span class="bound">i</span> <span class="main">∧</span> sublist_at <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For the inner loop, we can reuse <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> I_in_na<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Algorithm›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First, we use the non-evaluable function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> 𝔣<span class="antiquote"><span class="antiquote">}</span></span></span></span> directly:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kmp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">;</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_outer <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_in_na <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="bound">j</span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">j</span><span class="main">=</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">pos</span><span class="main">=</span>None <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="bound">j</span> <span class="main">-</span> 𝔣 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> max <span class="main">0</span> <span class="main">(</span>𝔣 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>max›</span></span> not necessary›</span>
      RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>

  RETURN <span class="bound">pos</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Correctness›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> 𝔣_eq_0_iff_j_eq_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> j_le_𝔣_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span> <span class="main">⟹</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI intrinsic_border_less length_take list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> min.absorb2 nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> j_le_𝔣_le'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span> <span class="main">⟹</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_less j_le_𝔣_le le_eq_less_or_eq less_imp_diff_less less_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔣_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intrinsic_border_take_less<span class="main">)</span>

<span class="comment1">(*
  Only needed for run-time analysis
lemma "p576 et seq":
  assumes
    "j ≤ length s" and
    assignments:
    "i' = i + (j + 1 - 𝔣 s j)"
    "j' = max 0 (𝔣 s j - 1)"
  shows
    sum_no_decrease: "i' + j' ≥ i + j" and
    i_increase: "i' &gt; i"
  using assignments by (simp_all add: j_le_𝔣_le[OF assms(1), THEN le_imp_less_Suc])
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> reuse_matches<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> j_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> old_matches<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">jj</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span>𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">jj</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="var">?j'</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="var">?i'</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">jj</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&gt;</span><span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 𝔣_le<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j_le j_le_𝔣_le<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> old_matches <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="var">?j'</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="var">?i'</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ab_semigroup_add_class.add.commute add.assoc diff_diff_cancel less_diff_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>intrinsic_border <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?j'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j_le<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> diff_add_inverse2 𝔣.elims nat_neq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="var">?j'</span><span class="main">.</span> take <span class="free">j</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">jj</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span>𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intrinsic_borderI' <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> border_positions length_greater_0_conv strict_border_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="var">?j'</span><span class="main">.</span> take <span class="free">j</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">jj</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝔣_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="var">?j'</span><span class="main">.</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">jj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝔣_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> shift_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span>sublist_at <span class="free">s</span> <span class="free">t</span> <span class="bound">ii</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span><span class="main">!</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    matches<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> <span class="free">t</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="bound">jj</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>
    assignment<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≡</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="free">i'</span><span class="main">.</span> <span class="main">¬</span>sublist_at <span class="free">s</span> <span class="free">t</span> <span class="bound">ii</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ii</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="comment1">― ‹The position falls into one of three categories:›</span>
    <span class="main">(</span>old<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>current<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>skipped<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sublist_at <span class="free">s</span> <span class="free">t</span> <span class="skolem">ii</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> old <span class="comment1">― ‹Old position, use invariant.›</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span>sublist_at <span class="free">s</span> <span class="free">t</span> <span class="bound">ii</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> current <span class="comment1">― ‹The mismatch occurred while testing this alignment.›</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span><span class="main">!</span><span class="free">j</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> sublist_all_positions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> skipped <span class="comment1">― ‹The skipped positions.›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span> assignment <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> less_j<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">ii</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> skipped <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">note</span></span> 𝔣_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> j_le_𝔣_le<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> 𝔣 <span class="free">s</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> 𝔣_eq_0_iff_j_eq_0 neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">ii</span> <span class="main">&gt;</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i'</span>›</span></span> assignment 𝔣_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> contradiction_goal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">ii</span> <span class="main">&gt;</span> length <span class="main">(</span>intrinsic_border <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝔣.elims <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> add_diff_cancel_right' not_gr_zero<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sublist_at <span class="free">s</span> <span class="free">t</span> <span class="skolem">ii</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> sublist_all_positions<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">with</span></span> le_s <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="free">i</span><span class="main">-</span><span class="skolem">ii</span><span class="main">.</span> <span class="free">t</span><span class="main">!</span><span class="main">(</span><span class="skolem">ii</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="bound">jj</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> ff1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ii</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_less_iff_gr_or_eq skipped<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ii</span> <span class="main">-</span> <span class="free">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ii</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">jj</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc add_diff_inverse_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">ii</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ii</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ii</span> <span class="main">-</span> <span class="free">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">-</span> <span class="free">i</span> <span class="main">+</span> <span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">jj</span>
        <span class="keyword1"><span class="command">using</span></span> that ff1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matches<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">jj</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">ii</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ii</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ii</span> <span class="main">-</span> <span class="free">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">jj</span>
        <span class="keyword1"><span class="command">using</span></span> ff1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> matches <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="free">i</span><span class="main">-</span><span class="skolem">ii</span><span class="main">.</span> <span class="free">t</span><span class="main">!</span><span class="main">(</span><span class="skolem">ii</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="skolem">ii</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="free">i</span><span class="main">-</span><span class="skolem">ii</span><span class="main">.</span> <span class="free">s</span><span class="main">!</span><span class="bound">jj</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="skolem">ii</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">jj</span></span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="free">i</span><span class="main">-</span><span class="skolem">ii</span><span class="main">.</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span><span class="main">!</span><span class="bound">jj</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">ii</span><span class="main">-</span><span class="free">i</span><span class="main">+</span><span class="bound">jj</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="skolem">ii</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> positions_strict_border<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">+</span><span class="free">i</span><span class="main">-</span><span class="skolem">ii</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">j</span> <span class="free">s</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="free">i</span><span class="main">-</span><span class="skolem">ii</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">note</span></span> intrinsic_border_max<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> contradiction_goal
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">+</span><span class="free">i</span><span class="main">-</span><span class="skolem">ii</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> le_s<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kmp_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>
  <span class="main">⟹</span> kmp <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> kmp_SPEC <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kmp_def kmp_SPEC_def I_outer_def I_in_na_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span>
    WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> length <span class="free">t</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">pos</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>nat option<span class="main">)</span><span class="main">.</span> length <span class="free">s</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vc_solve</span> <span class="quasi_keyword">solve</span><span class="main"><span class="main">:</span></span> asm_rl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right all_positions_sublist less_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> less_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i jout j <span class="keyword1"><span class="command">using</span></span> shift_safe<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i jout j <span class="keyword1"><span class="command">using</span></span> reuse_matches<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> 𝔣_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> sublist_lengths add_less_cancel_right leI le_less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Storing the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> 𝔣<span class="antiquote"><span class="antiquote">}</span></span></span></span>-values›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We refine the algorithm to compute the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> 𝔣<span class="antiquote"><span class="antiquote">}</span></span></span></span>-values only once at the start:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compute_𝔣s_SPEC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat list nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compute_𝔣s_SPEC</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">𝔣s</span><span class="main">.</span> length <span class="bound">𝔣s</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="bound">𝔣s</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> 𝔣 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kmp1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">;</span>
  <span class="bound">𝔣s</span> <span class="main">←</span> compute_𝔣s_SPEC <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹At the last char, we abort instead.›</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_outer <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_in_na <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="bound">j</span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">j</span><span class="main">=</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">pos</span><span class="main">=</span>None <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="bound">j</span> <span class="main">-</span> <span class="bound">𝔣s</span><span class="main">!</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> max <span class="main">0</span> <span class="main">(</span><span class="bound">𝔣s</span><span class="main">!</span><span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>max›</span></span> not necessary›</span>
      RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>

  RETURN <span class="bound">pos</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔣_butlast<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">⟹</span> 𝔣 <span class="main">(</span>butlast <span class="free">s</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> 𝔣 <span class="free">s</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_butlast<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> kmp1_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"kmp1 <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> kmp <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refine_IdD<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> kmp1_def kmp_def Let_def compute_𝔣s_SPEC_def nres_monad_laws
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ASSERT_refine_right ASSERT_refine_left<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Refine_Basic.intro_spec_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_dref_type</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vc_solve</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Next, an algorithm that satisfies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> compute_𝔣s_SPEC<span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Computing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> 𝔣<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_out_cb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span>
  length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="bound">𝔣s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">jj</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="bound">𝔣s</span><span class="main">!</span><span class="bound">jj</span> <span class="main">=</span> 𝔣 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">jj</span><span class="main">)</span> <span class="main">∧</span>
  <span class="bound">𝔣s</span><span class="main">!</span><span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∧</span>
  <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">I_in_cb</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="comment1">― ‹first iteration›</span>
  <span class="keyword1">else</span>
    strict_border <span class="main">(</span>take <span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span>
    𝔣 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Again, we follow Seidl<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> GAD<span class="antiquote"><span class="antiquote">}</span></span></span></span>, p.582. Apart from the +1-shift, we make another modification:
Instead of directly setting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">𝔣s</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">1</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we let the first loop-iteration (if there is one) do that for us.
This allows us to remove the precondition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">[]</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, as the index bounds are respected even in that corner case.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compute_𝔣s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat list nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compute_𝔣s</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">𝔣s</span><span class="main">=</span>replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">;</span> <span class="comment1">― ‹only the first 0 is needed›</span>
  <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="main">1</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_out_cb <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">i</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_in_cb <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="bound">𝔣s</span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="bound">i</span>
    <span class="main">}</span><span class="main">)</span> <span class="bound">i</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
    ASSERT <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">𝔣s</span><span class="main">=</span><span class="bound">𝔣s</span><span class="main">[</span><span class="bound">j</span><span class="main">:=</span><span class="bound">i</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">;</span>
  
  RETURN <span class="bound">𝔣s</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Correctness›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> take_length_ib<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>intrinsic_border <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> intrinsic_border <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span>intrinsic_border <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intrinsic_borderI' border_def list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> neq0_conv not_less strict_border_def take_eq_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span>›</span></span> take_is_prefix<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj prefixE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ib_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"intrinsic_border <span class="main">[</span><span class="free">z</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intrinsic_border_less length_Cons length_greater_0_conv less_Suc0 list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> border_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> border <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> border_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> butlast_append prefixE prefix_order.eq_refl prefix_prefix prefixeq_butlast<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sublist.suffix_def append.right_neutral butlast.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> butlast_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> strict_border_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> strict_border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> strict_border <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strict_border_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> border_butlast less_diff_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> border_take_lengths<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">s</span> <span class="main">⟹</span> border <span class="main">(</span>take <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> border_length_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> border_step<span class="main">:</span> <span class="quoted"><span class="quoted">"border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> border <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">ys</span><span class="main">!</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">ys</span><span class="main">!</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> border_def suffix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> append_one_prefix prefixE <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> append_prefixD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> strict_border_step<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_border <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> strict_border <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">ys</span><span class="main">!</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">ys</span><span class="main">!</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strict_border_def <span class="keyword1"><span class="command">using</span></span> border_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ib_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> length <span class="main">(</span>intrinsic_border <span class="free">w</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>intrinsic_border <span class="main">(</span>butlast <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>intrinsic_border <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> intrinsic_borderI'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> length <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>butlast <span class="main">(</span>intrinsic_border <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def border_bot.bot.not_eq_extremum butlast.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> len_greater_imp_nonempty length_butlast lessI less_le_trans numerals<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> strict_border_butlast zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>butlast <span class="main">(</span>intrinsic_border <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>intrinsic_border <span class="main">(</span>butlast <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intrinsic_border_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> 𝔣_Suc<span class="comment1">(*rm*)</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≤</span> length <span class="free">w</span> <span class="main">⟹</span> 𝔣 <span class="free">w</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> 𝔣 <span class="free">w</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc0<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 Suc_to_right butlast_take diff_is_0_eq ib_butlast length_take min.absorb2 nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_eq_eq numerals<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔣_step_bound<span class="comment1">(*rm*)</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">w</span> <span class="free">j</span> <span class="main">≤</span> 𝔣 <span class="free">w</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> j_le_𝔣_le<span class="main">]</span> 𝔣_Suc assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred le_SucI not_gr_zero trans_le_add2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> border_take_𝔣<span class="main">:</span> <span class="quoted"><span class="quoted">"border <span class="main">(</span>take <span class="main">(</span>𝔣 <span class="free">s</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intrinsic_borderI' border_order.eq_iff border_order.less_imp_le border_positions nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_le_linear positions_border take_all take_eq_Nil take_length_ib zero_less_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> 𝔣_strict_borderI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> 𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> strict_border <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> strict_border <span class="main">(</span>take <span class="main">(</span><span class="free">y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> border_order.less_le_not_le border_order.order.trans border_take_𝔣 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> strict_border_take_𝔣<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">s</span> <span class="main">⟹</span> strict_border <span class="main">(</span>take <span class="main">(</span>𝔣 <span class="free">s</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> border_order.less_le_not_le border_take_𝔣 border_take_lengths j_le_𝔣_le' leD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔣_is_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span> <span class="main">⟹</span> strict_border <span class="free">b</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> 𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≥</span> length <span class="free">b</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 𝔣.elims add_le_cancel_right add_less_same_cancel2 border_length_r_less intrinsic_border_max length_take min_absorb2 not_add_less2<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> skipping_ok<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j_bounds<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mismatch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> greater_checked<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> 𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> 𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> greater_checked assms<span class="main">(</span>5<span class="main">)</span> take_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_less_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> border_length_r_less nz_le_conv_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> 𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>›</span></span> greater_checked <span class="keyword1"><span class="command">consider</span></span>
    <span class="main">(</span>tested<span class="main">)</span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="comment1">― ‹This contradicts <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> mismatch<span class="antiquote">}</span></span>›</span> <span class="main">|</span>
    <span class="main">(</span>skipped<span class="main">)</span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> 𝔣 <span class="free">s</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
      <span class="comment1">― ‹This contradicts <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> 𝔣_is_max<span class="main">[</span><span class="operator">of</span> <span class="quoted">"<span class="free">i</span><span class="main">-</span><span class="main">1</span>"</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> tested
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> border_positions<span class="main">[</span><span class="operator">OF</span> border_take_𝔣<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">j</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_bounds i_less_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_diff_less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mismatch <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> skipped
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?border</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="comment1">― ‹This border of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">‹take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span>›</span><span class="antiquote">}</span></span> could not be extended to a border of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">‹take <span class="free">j</span> <span class="free">s</span>›</span><span class="antiquote">}</span></span> due to the mismatch.›</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?impossible</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="comment1">― ‹A strict border longer than <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">‹intrinsic_border <span class="var">?border</span>›</span><span class="antiquote">}</span></span>, a contradiction.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> skipped <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> less_s<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> j_bounds<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> strict<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?impossible</span> <span class="main">&lt;</span> length <span class="var">?border</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="var">?impossible</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prefix_length_prefix take_is_prefix
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>›</span></span> j_bounds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_le_self j_le_𝔣_le length_take less_s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> min_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="var">?border</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>›</span></span> diff_le_self i_less_j le_trans length_take less_or_eq_imp_le less_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prefix_length_prefix take_is_prefix<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="var">?impossible</span> <span class="var">?border</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> strict less_imp_le_nat prefix_length_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="main">(</span>take <span class="main">(</span>𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> border_take_𝔣
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> border_def<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> suffix_butlast<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="var">?impossible</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def j_bounds<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_take diff_diff_left 𝔣_le len_greater_imp_nonempty less_or_eq_imp_le less_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> one_add_one<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="var">?impossible</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"suffix <span class="var">?border</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> suffix_length_suffix<span class="main">[</span><span class="operator">OF</span> this strict<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="var">?impossible</span> <span class="var">?border</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="var">?impossible</span> <span class="var">?border</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> strict_border_def<span class="main">[</span><span class="operator">unfolded</span> border_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> 𝔣_is_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">,</span> <span class="operator">OF</span> _ this<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="main">(</span>𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> 𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_le_nat less_s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> 𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> 𝔣 <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_diff_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> skipped<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extend_border<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> pos_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="free">s</span> "</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> border_length_r_less min_less_iff_conj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> strict_border_step<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> border_length_r_less length_take min_less_iff_conj nth_take<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> pos_in_range <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>take <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_pred add.left_neutral border_bot.bot.not_eq_extremum border_order.less_asym neq0_conv take_0 take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>take <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span><span class="main">!</span><span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_border <span class="main">(</span>take <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> diff_le_self less_le_trans neq0_conv nz_le_conv_less strict_border_imp_nonempty take_Suc_conv_app_nth take_eq_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 𝔣_is_max<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹𝔣 <span class="free">s</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> le_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compute_𝔣s_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"compute_𝔣s <span class="free">s</span> <span class="main">≤</span> compute_𝔣s_SPEC <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compute_𝔣s_SPEC_def compute_𝔣s_def I_out_cb_def I_in_cb_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_vcg</span>
    WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> length <span class="free">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
    WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure id"</span></span><span class="main"><span class="main">]</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">‹<span class="free">i</span><span class="main">::</span>nat›</span><span class="antiquote">}</span></span> decreases with every iteration.›</span>
    <span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vc_solve</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> One_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> b j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_border_take_𝔣<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 𝔣_step_bound less_Suc_eq_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_lessD Suc_pred border_length_r_less 𝔣_strict_borderI length_take less_Suc_eq less_Suc_eq_le min.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> b j i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_diff_1 Suc_eq_plus1 Suc_leI border_take_lengths less_Suc_eq_le less_antisym skipping_ok strict_border_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_1 border_take_lengths j_le_𝔣_le less_Suc_eq_le strict_border_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> b j i jj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_eq_plus1_left add.right_neutral extend_border 𝔣_eq_0_iff_j_eq_0 j_le_𝔣_le le_zero_eq less_Suc_eq less_Suc_eq_le nth_list_update_eq nth_list_update_neq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Index shift›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹To avoid inefficiencies, we refine <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> compute_𝔣s<span class="antiquote"><span class="antiquote">}</span></span></span></span> to take <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
instead of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹butlast <span class="free"><span class="free">s</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (it still only uses <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹butlast <span class="free"><span class="free">s</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compute_butlast_𝔣s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat list nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compute_butlast_𝔣s</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">𝔣s</span><span class="main">=</span>replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="main">1</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_out_cb <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">i</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_in_cb <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="bound">𝔣s</span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="bound">i</span>
    <span class="main">}</span><span class="main">)</span> <span class="bound">i</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
    ASSERT <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">𝔣s</span><span class="main">=</span><span class="bound">𝔣s</span><span class="main">[</span><span class="bound">j</span><span class="main">:=</span><span class="bound">i</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝔣s</span><span class="main">,</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">;</span>
  
  RETURN <span class="bound">𝔣s</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compute_𝔣s_inner_bounds<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"I_out_cb <span class="free">s</span> <span class="main">(</span><span class="free">𝔣s</span><span class="main">,</span><span class="free">ix</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">𝔣s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"I_in_cb <span class="free">s</span> <span class="free">j</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I_out_cb_def I_in_cb_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compute_butlast_𝔣s_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> br butlast <span class="main">(</span><span class="main">(≠)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compute_butlast_𝔣s <span class="free">s</span> <span class="main">≤</span> <span class="main">⇓</span> Id <span class="main">(</span>compute_𝔣s_SPEC <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compute_butlast_𝔣s <span class="free">s</span> <span class="main">≤</span> <span class="main">⇓</span> Id <span class="main">(</span>compute_𝔣s <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compute_butlast_𝔣s_def compute_𝔣s_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_dref_type</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vc_solve</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_pred length_greater_0_conv replicate_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def compute_𝔣s_inner_bounds nth_butlast<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> compute_𝔣s_correct
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Conflation›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We replace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> compute_𝔣s_SPEC<span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> compute_butlast_𝔣s<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kmp2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="main">0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">;</span>
  <span class="bound">𝔣s</span> <span class="main">←</span> compute_butlast_𝔣s <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_outer <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span> <span class="main">←</span> WHILEIT <span class="main">(</span>I_in_na <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">!</span><span class="bound">j</span> <span class="main">∧</span> <span class="bound">pos</span><span class="main">=</span>None<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">j</span><span class="main">=</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">j</span><span class="main">=</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">if</span> <span class="bound">pos</span><span class="main">=</span>None <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">j</span> <span class="main">&lt;</span> length <span class="bound">𝔣s</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="bound">j</span> <span class="main">-</span> <span class="bound">𝔣s</span><span class="main">!</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> max <span class="main">0</span> <span class="main">(</span><span class="bound">𝔣s</span><span class="main">!</span><span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>max›</span></span> not necessary›</span>
      RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>None<span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span>Some <span class="bound">i</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">,</span><span class="bound">pos</span><span class="main">)</span><span class="main">;</span>

  RETURN <span class="bound">pos</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] compute_butlast_𝔣s_refine<span class="antiquote"><span class="antiquote">}</span></span></span></span> (it has attribute <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">attribute</span></span> refine<span class="antiquote"><span class="antiquote">}</span></span></span></span>), the proof is trivial:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> kmp2_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"kmp2 <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> kmp1 <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refine_IdD<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> kmp2_def kmp1_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_dref_type</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vc_solve</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> kmp2_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>
  <span class="main">⟹</span> kmp2 <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> kmp_SPEC <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kmp2 <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> kmp1 <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> kmp2_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> kmp <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> kmp1_refine<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> kmp_SPEC <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> kmp_correct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For convenience, we also remove the precondition:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kmp3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span><span class="main">[]</span> <span class="keyword1">then</span> RETURN <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> kmp2 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kmp3_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"kmp3 <span class="free">s</span> <span class="free">t</span> <span class="main">≤</span> kmp_SPEC <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kmp3_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kmp2_correct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kmp_SPEC_def<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement to Imperative/HOL›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_id_param<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> Id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> in_bounds_aux <span class="main">=</span> compute_𝔣s_inner_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"butlast <span class="free"><span class="free">s</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="free"><span class="free">s</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">compute_butlast_𝔣s_impl</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">compute_butlast_𝔣s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>arl_assn id_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> array_assn nat_assn"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compute_butlast_𝔣s_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> in_bounds_aux<span class="main">[</span><span class="operator">dest</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> eq_id_param<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">,</span> <span class="operator">sepref_import_param</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> array_fold_custom_replicate<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  
<span class="keyword1"><span class="command">declare</span></span> compute_butlast_𝔣s_impl.refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span>

<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">compute_𝔣s</span>

<span class="keyword1"><span class="command">lemma</span></span> kmp_inner_in_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> length <span class="free">s</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"I_in_na <span class="free">s</span> <span class="free">t</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span>None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I_in_na_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">kmp_impl</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry kmp3"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>arl_assn id_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>arl_assn id_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> option_assn nat_assn"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kmp3_def kmp2_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> max_0L<span class="main">)</span> <span class="comment1">― ‹Avoid the unneeded <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> max<span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"WHILEIT <span class="main"><span class="main">(</span></span>I_in_na <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> conj_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"WHILEIT <span class="main"><span class="main">(</span></span>I_in_na <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> short_circuit_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> kmp_inner_in_bound<span class="main">[</span><span class="operator">dest</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> option.splits<span class="main">[</span><span class="operator">split</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> eq_id_param<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">,</span> <span class="operator">sepref_import_param</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">kmp_impl</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML_imp <span class="keyword2"><span class="keyword">module_name</span></span> KMP

<span class="keyword1"><span class="command">lemma</span></span> kmp3_correct'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry kmp3<span class="main">,</span> uncurry kmp_SPEC<span class="main">)</span> <span class="main">∈</span> Id <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> Id <span class="keyword1">→<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟨</span>Id<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> frefI nres_relI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> kmp3_correct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> kmp_impl_correct' <span class="main">=</span> kmp_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> kmp3_correct'<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Overall Correctness Theorem›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorem relates the final Imperative HOL algorithm to its specification,
  using, beyond basic HOL concepts
    <span class="antiquoted"><span class="antiquoted">▪</span></span> Hoare triples for Imperative/HOL, provided by the Separation Logic Framework for Imperative/HOL (Theory <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../Separation_Logic_Imperative_HOL/Sep_Main.html"></a><a href="../Separation_Logic_Imperative_HOL/Sep_Main.html">Separation_Logic_Imperative_HOL.Sep_Main</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>);
    <span class="antiquoted"><span class="antiquoted">▪</span></span> The assertion <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> arl_assn<span class="antiquote"><span class="antiquote">}</span></span></span></span> to specify array-lists, which we use to represent the input strings of the algorithm;
    <span class="antiquoted"><span class="antiquoted">▪</span></span> The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sublist_at<span class="antiquote"><span class="antiquote">}</span></span></span></span> function that we defined in section \ref{sec:spec}.
  ›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> kmp_impl_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> arl_assn id_assn <span class="free">s</span> <span class="free">si</span> <span class="main">*</span> arl_assn id_assn <span class="free">t</span> <span class="free">ti</span> <span class="main">&gt;</span> 
       kmp_impl <span class="free">si</span> <span class="free">ti</span> 
   <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> arl_assn id_assn <span class="free">s</span> <span class="free">si</span> <span class="main">*</span> arl_assn id_assn <span class="free">t</span> <span class="free">ti</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>
      <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span>  <span class="main">∄</span><span class="bound">i</span><span class="main">.</span> sublist_at <span class="free">s</span> <span class="free">t</span> <span class="bound">i</span>
              <span class="main">|</span> Some <span class="bound">i</span> <span class="main">⇒</span> sublist_at <span class="free">s</span> <span class="free">t</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">ii</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> sublist_at <span class="free">s</span> <span class="free">t</span> <span class="bound">ii</span><span class="main">)</span>
    <span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def kmp_SPEC_def
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split
    <span class="quasi_keyword">heap</span><span class="main"><span class="main">:</span></span>  kmp_impl_correct'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> hfrefD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> hn_refineD<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">si</span><span class="main">,</span><span class="free">ti</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">kmp_string_impl</span> <span class="main">≡</span> kmp_impl <span class="main">::</span> <span class="main">(</span>char array <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">_</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tests of Generated ML-Code›</span></span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">str2arl</span> <span class="entity">s</span> <span class="main">=</span> <span class="main">(</span>Array.fromList <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">String.explode</span><span class="antiquote">}</span></span></span> <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">nat_of_integer</span><span class="antiquote">}</span></span></span> <span class="main">(</span>String.size <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">kmp</span> <span class="entity">s</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">map_option</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">integer_of_nat</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">kmp_string_impl</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="entity">str2arl</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="entity">str2arl</span> <span class="entity">t</span><span class="main">)</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
  
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test1</span> <span class="main">=</span> <span class="entity">kmp</span> <span class="inner_quoted">"anas"</span> <span class="inner_quoted">"bananas"</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test2</span> <span class="main">=</span> <span class="entity">kmp</span> <span class="inner_quoted">""</span> <span class="inner_quoted">"bananas"</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test3</span> <span class="main">=</span> <span class="entity">kmp</span> <span class="inner_quoted">"hide_fact"</span> <span class="main">(</span>File.read <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">file</span> ‹~~/src/HOL/Main.thy›<span class="antiquote">}</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">test4</span> <span class="main">=</span> <span class="entity">kmp</span> <span class="inner_quoted">"sorry"</span> <span class="main">(</span>File.read <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">file</span> ‹~~/src/HOL/HOL.thy›<span class="antiquote">}</span></span></span><span class="main">)</span>  
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>