<div id="DFS">
<div class="head">
<h1>Theory DFS</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Presburger-Automata/DFS.thy
    Author:     Toshiaki Nishihara and Yasuhiko Minamide
    Author:     Stefan Berghofer and Alex Krauss, TU Muenchen, 2008-2009
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Depth First Search›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DFS
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">succsr</span> <span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">gen_dfs</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_dfs</span> <span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">wl</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">wl</span></span></span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> <span class="free">gen_dfs</span> <span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">xs</span>
        <span class="keyword1">else</span> <span class="free">gen_dfs</span> <span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">memb</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">succs</span></span></span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="free">S</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="free">S</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">memb</span> <span class="free">x</span> <span class="free">S</span> <span class="keyword1">then</span> gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="free">S</span> <span class="free">xs</span>
     <span class="keyword1">else</span> gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span> <span class="main">(</span><span class="free">ins</span> <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">succs</span> <span class="free">x</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_dfs.simps<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> DFS <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">succs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">empt</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ins_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">S</span><span class="main">.</span> <span class="free">is_node</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">is_node</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">y</span> <span class="bound">S</span> <span class="main">⟹</span>
      <span class="free">memb</span> <span class="bound">x</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">y</span> <span class="bound">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">is_node</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="free">empt</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> succs_is_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">is_node</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="free">is_node</span> <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empt_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">empt</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ins_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">S</span><span class="main">.</span> <span class="free">is_node</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">invariant</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> graph_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">is_node</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> inv_image finite_psubset <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="free">is_node</span> <span class="bound">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dfs</span> <span class="main">≡</span> gen_dfs <span class="free">succs</span> <span class="free">ins</span> <span class="free">memb</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_induct <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_node</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">S</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">is_node</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="free">is_node</span> <span class="bound">xs</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">S</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">S</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 I2 S xs
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction_schema</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ins_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succs_is_node<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"rel <span class="keyword1">&lt;*lex*&gt;</span> measure length"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_lex_prod rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def finite_psubset_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_eq graph_finite <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">succss</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_of</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">is_node</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">memb</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> visit_subset_dfs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span> <span class="main">⟹</span> list_all <span class="free">is_node</span> <span class="free">xs</span> <span class="main">⟹</span>
    <span class="free">is_node</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">memb</span> <span class="free">y</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">memb</span> <span class="free">y</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_subset_dfs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span> <span class="main">⟹</span> list_all <span class="free">is_node</span> <span class="free">xs</span> <span class="main">⟹</span>
    <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">memb</span> <span class="free">x</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> visit_subset_dfs ins_eq ins_invariant succs_is_node<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> succss_closed_dfs'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">ys</span> <span class="main">⟹</span> list_all <span class="free">is_node</span> <span class="free">xs</span> <span class="main">⟹</span>
    succss <span class="main">(</span>set_of <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∪</span> set_of <span class="free">ys</span> <span class="main">⟹</span>
    succss <span class="main">(</span>set_of <span class="main">(</span>dfs <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set_of <span class="main">(</span>dfs <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_eq succss_def set_of_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> succss_closed_dfs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_node</span> <span class="free">xs</span> <span class="main">⟹</span>
    succss <span class="main">(</span>set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succss_closed_dfs'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> empt_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succss_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> UN_E<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_def empt <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Image_closed_trancl<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">``</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms y
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_closed_dfs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_node</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">(</span>set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> reachable_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Image_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_def next_subset_dfs empt_invariant list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> succss_closed_dfs assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_of <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> reachable_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Image_closed_trancl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succss_def set_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_succs<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_subset_reachable_visit_nodes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">ys</span> <span class="main">⟹</span> list_all <span class="free">is_node</span> <span class="free">xs</span> <span class="main">⟹</span>
     set_of <span class="main">(</span>dfs <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set_of <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="skolem">x</span> <span class="skolem">S</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reachable_succs<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span>set <span class="main">(</span><span class="free">succs</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="main">(</span>set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def ins_eq set_of_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> dfs_eq_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_node</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_node</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free">y</span> <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">∈</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free">y</span> <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> dfs_subset_reachable_visit_nodes <span class="main">[</span><span class="operator">OF</span> empt_invariant xs<span class="main">]</span> y
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empt set_of_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> reachable <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> reachable_closed_dfs <span class="main">[</span><span class="operator">OF</span> xs<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free">y</span> <span class="main">(</span>dfs <span class="free">empt</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> dfs_eq_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_node</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_node</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free">y</span> <span class="main">(</span>dfs <span class="free">empt</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="free">succs</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_node</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dfs_eq_reachable <span class="main"><span class="main">[</span></span><span class="operator">OF</span> y x'<span class="main"><span class="main">]</span></span> reachable_def succsr_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> dfs_invariant <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_node</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">memb</span> <span class="bound">x</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">is_node</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">invariant</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="free">ins</span> <span class="bound">x</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> S xs H
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">invariant</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="skolem">x</span> <span class="skolem">S</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> dfs_invariant'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free">S</span> <span class="main">⟹</span> list_all <span class="free">is_node</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">invariant</span> <span class="main">(</span>dfs <span class="free">S</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> succsr_is_node<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="free">succs</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_node</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">is_node</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_node</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_node</span> <span class="main">(</span><span class="free">succs</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succs_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> gen_dfs_simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Presburger_Automata">
<div class="head">
<h1>Theory Presburger_Automata</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Presburger-Automata/Presburger_Automata.thy
    Author:     Markus Reiter and Stefan Berghofer, TU Muenchen, 2008-2009
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Presburger_Automata
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DFS.html">DFS</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Nat_Bijection.html">HOL-Library.Nat_Bijection</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹General automata›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reach</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> foldl <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">tr</span> <span class="free">p</span> <span class="main">[]</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">tr</span> <span class="free">p</span> <span class="free">bs</span> <span class="free">q</span> <span class="main">⟹</span> reach <span class="free">tr</span> <span class="free">p</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">tr</span> <span class="free">q</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_nil_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">tr</span> <span class="free">p</span> <span class="main">[]</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_snoc_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">tr</span> <span class="free">p</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> reach <span class="free">tr</span> <span class="free">p</span> <span class="free">bs</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> <span class="free">tr</span> <span class="bound">q</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil snoc<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> reach<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">tr</span> <span class="free">p</span> <span class="free">w</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span>reach <span class="free">tr</span> <span class="free">p</span> <span class="bound">x</span> <span class="bound">k</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">tr</span> <span class="bound">k</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>reach <span class="free">tr</span> <span class="free">p</span> <span class="free">a</span> <span class="free">r</span><span class="main">;</span> reach <span class="free">tr</span> <span class="free">r</span> <span class="free">b</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> reach <span class="free">tr</span> <span class="free">p</span> <span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="free">b</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>reach <span class="free">tr</span> <span class="free">p</span> <span class="free">a</span> <span class="free">q</span><span class="main">;</span> reach <span class="free">tr</span> <span class="free">p</span> <span class="free">a</span> <span class="free">q'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accepts</span> <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>foldl <span class="free"><span class="bound"><span class="entity">tr</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Automaton <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">is_alpha</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans_is_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span><span class="free">is_node</span> <span class="bound">q</span><span class="main">;</span> <span class="free">is_alpha</span> <span class="bound">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">is_node</span> <span class="main">(</span><span class="free">trans</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> steps_is_node<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_node</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_alpha</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_node</span> <span class="main">(</span>foldl <span class="free">trans</span> <span class="free">q</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trans_is_node<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_is_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>reach <span class="free">trans</span> <span class="free">p</span> <span class="free">w</span> <span class="free">q</span><span class="main">;</span> <span class="free">is_node</span> <span class="free">p</span><span class="main">;</span> list_all <span class="free">is_alpha</span> <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">is_node</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> steps_is_node reach_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹BDDs›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_alph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_alph</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> bdd <span class="main">=</span> Leaf <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Branch <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> bdd"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> bdd"</span></span> <span class="keyword2"><span class="keyword">for</span></span> map<span class="main">:</span> bdd_map

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">bddh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> bdd <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bddh</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bddh</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> False <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="free">bddh</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">bddh</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="free">bdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">m</span> <span class="free">bdd</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Branch <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Branch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="skolem">m</span> <span class="main">=</span> Suc <span class="bound">w</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Suc <span class="skolem">w</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">with</span></span> Branch V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="main">∧</span> bddh <span class="skolem">v</span> <span class="skolem">l</span> <span class="main">∧</span> bddh <span class="skolem">v</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Branch <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">w</span> <span class="skolem">l</span> <span class="main">∧</span> bddh <span class="skolem">w</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> W <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bdd_all</span> <span class="main">≡</span> pred_bdd"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bdd_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> bdd <span class="main">⇒</span> bool list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bdd_lookup</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bdd_lookup</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bdd_lookup</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_all_bdd_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bddh <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="free">bdd</span><span class="main">;</span> bdd_all <span class="free">P</span> <span class="free">bdd</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="free">bdd</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdd</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bdd_lookup.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_all_bdd_lookup_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="free">bdd</span> <span class="main">⟹</span> bdd_all <span class="free">P</span> <span class="free">bdd</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ws</span><span class="main">.</span> length <span class="bound">ws</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="free">bdd</span> <span class="bound">ws</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> mp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="skolem">n</span> False"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> Branch <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span><span class="main">.</span> length <span class="bound">ws</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span><span class="main">.</span> length <span class="bound">ws</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="bound">ws</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="bound">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ws</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>False<span class="main">#</span><span class="skolem">ws</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>False<span class="main">#</span><span class="skolem">ws</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> H k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>True<span class="main">#</span><span class="skolem">ws</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>True<span class="main">#</span><span class="skolem">ws</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="skolem">ws</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Branch k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_all_bdd_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="free">P</span> <span class="free">bdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="free">Q</span> <span class="main">(</span>bdd_map <span class="free">f</span> <span class="free">bdd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdd</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_bdd_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>bdd_map <span class="free">f</span> <span class="free">bdd</span><span class="main">)</span> <span class="main">=</span> bddh <span class="free">n</span> <span class="free">bdd</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>bdd_map <span class="free">f</span> <span class="free">bdd</span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="free">bdd</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> Branch <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="free">bdd</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>bdd_map <span class="free">f</span> <span class="free">bdd</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> Branch <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_map_bdd_lookup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="free">bdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>bdd_map <span class="free">f</span> <span class="free">bdd</span><span class="main">)</span> <span class="free">ws</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>bdd_lookup <span class="free">bdd</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdd</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bdd_lookup.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_bdd_map<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bdd_binop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> bdd <span class="main">⇒</span> <span class="tfree">'b</span> bdd <span class="main">⇒</span> <span class="tfree">'c</span> bdd"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Leaf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Branch <span class="main">(</span><span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Branch <span class="main">(</span><span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Branch <span class="main">(</span><span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">l<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">bdd_binop</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_binop<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>bdd_binop <span class="free">f</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bddh <span class="free">n</span> <span class="free">l</span> <span class="main">∧</span> bddh <span class="free">n</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bdd_binop.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_lookup_binop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bddh <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="free">l</span><span class="main">;</span> bddh <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span>
  bdd_lookup <span class="main">(</span>bdd_binop <span class="free">f</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>bdd_lookup <span class="free">l</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="free">r</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bdd_binop.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_all_bdd_binop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="free">P</span> <span class="free">bdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="free">Q</span> <span class="free">bdd'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">a</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="free">R</span> <span class="main">(</span>bdd_binop <span class="free">f</span> <span class="free">bdd</span> <span class="free">bdd'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">bdd</span></span> <span class="quoted"><span class="free">bdd'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bdd_binop.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_list_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"List.insert <span class="free">x</span> <span class="main">(</span>List.insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> List.insert <span class="free">x</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">add_leaves</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> bdd <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_leaves</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> List.insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_leaves</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free">add_leaves</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free">add_leaves</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_leaves_bdd_lookup<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>add_leaves <span class="free">b</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> bdd_lookup <span class="free">b</span> <span class="bound">bs</span> <span class="main">∧</span> is_alph <span class="free">n</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="improper">n</span> <span class="free">arbitrary</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"True <span class="main">#</span> <span class="improper">bs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"False <span class="main">#</span> <span class="improper">bs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">list</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">list</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_leaves_bdd_all_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="main">(</span>add_leaves <span class="free">tr</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> bdd_all <span class="free">P</span> <span class="free">tr</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">tr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> add_leaves_bdd_all_eq' <span class="main">=</span>
  add_leaves_bdd_all_eq <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> add_leaves_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ys</span> <span class="main">⟹</span> set <span class="main">(</span>add_leaves <span class="free">tr</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>add_leaves <span class="free">tr</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">tr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_leaves_binop_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_leaves <span class="main">(</span>bdd_binop <span class="free">f</span> <span class="free">b</span> <span class="free">b'</span><span class="main">)</span> <span class="main">[</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> x <span class="main">←</span> <span class="free">xs</span><span class="main">,</span> y <span class="main">←</span> <span class="free">ys</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span>
   <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>add_leaves <span class="free">b</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">y</span><span class="main">∈</span>set <span class="main">(</span>add_leaves <span class="free">b'</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>add_leaves <span class="free">b</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">`</span> set <span class="main">(</span>add_leaves <span class="free">b'</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">b'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bdd_binop.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> ys1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> x <span class="main">←</span> add_leaves <span class="skolem">l</span> <span class="skolem">xs</span><span class="main">,</span> y <span class="main">←</span> List.insert <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
      rev_subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ add_leaves_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> ys1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> x <span class="main">←</span> List.insert <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">,</span> y <span class="main">←</span> add_leaves <span class="skolem">l</span> <span class="skolem">ys</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
      rev_subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ add_leaves_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> ys1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> x <span class="main">←</span> add_leaves <span class="skolem">l<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">xs</span><span class="main">,</span> y <span class="main">←</span> add_leaves <span class="skolem">l<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ys</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
      rev_subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ add_leaves_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> meta_spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>add_leaves <span class="free">b</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">`</span> set <span class="main">(</span>add_leaves <span class="free">b'</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹DFAs›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> bddtable <span class="main">=</span> <span class="quoted"><span class="quoted">"nat bdd list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> astate <span class="main">=</span> <span class="quoted"><span class="quoted">"bool list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> dfa <span class="main">=</span> <span class="quoted"><span class="quoted">"bddtable <span class="main">×</span> astate"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dfa_is_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dfa_is_node</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wf_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_dfa</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">(</span>list_all <span class="main">(</span>bddh <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
     list_all <span class="main">(</span>bdd_all <span class="main">(</span>dfa_is_node <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
     length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
     length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dfa_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nat <span class="main">⇒</span> bool list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dfa_trans</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> bdd_lookup <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dfa_accepting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dfa_accepting</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> aut_dfa <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_formed<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> aut_dfa <span class="main">&lt;</span> Automaton <span class="quoted"><span class="quoted">"dfa_trans <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"is_alph <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"is_alph <span class="free">n</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> QL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> well_formed A <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def list_all_iff is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> QL well_formed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="skolem">q</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_trans_def bdd_all_bdd_lookup<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> aut_dfa <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> trans_is_node <span class="main">=</span> trans_is_node
<span class="keyword1"><span class="command">lemmas</span></span> steps_is_node <span class="main">=</span> steps_is_node
<span class="keyword1"><span class="command">lemmas</span></span> reach_is_node <span class="main">=</span> reach_is_node
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> dfa_trans_is_node <span class="main">=</span> aut_dfa.trans_is_node <span class="main">[</span><span class="operator">OF</span> aut_dfa.intro<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> dfa_steps_is_node <span class="main">=</span> aut_dfa.steps_is_node <span class="main">[</span><span class="operator">OF</span> aut_dfa.intro<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> dfa_reach_is_node <span class="main">=</span> aut_dfa.reach_is_node <span class="main">[</span><span class="operator">OF</span> aut_dfa.intro<span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dfa_steps</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> foldl <span class="main">(</span>dfa_trans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dfa_accepts</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> accepts <span class="main">(</span>dfa_trans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>dfa_accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dfa_reach</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> reach <span class="main">(</span>dfa_trans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfa_startnode_is_node<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span> <span class="main">⟹</span> dfa_is_node <span class="free">A</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def wf_dfa_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Minimization›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">make_tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_tr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">make_tr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free">make_tr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fold_map_idx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fold_map_idx</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fold_map_idx</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">y'</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">y''</span><span class="main">,</span> <span class="bound">xs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">fold_map_idx</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="bound">y'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">y''</span><span class="main">,</span> <span class="bound">x'</span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> bool list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_tr</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bd</span><span class="main">,</span><span class="bound">as</span><span class="main">)</span><span class="main">.</span> make_tr <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> make_tr <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">as</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="bound">bd</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tr_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tr_lookup</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">T</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">T</span> <span class="main">!</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="keyword1">else</span> <span class="bound">T</span> <span class="main">!</span> <span class="main">(</span><span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">check_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat bdd <span class="main">⇒</span> nat bdd <span class="main">⇒</span> bool list list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_eq</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">check_eq</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">check_eq</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free">check_eq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">check_eq</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">check_eq</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free">check_eq</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">check_eq</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">check_eq</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∧</span> <span class="free">check_eq</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> bool list list <span class="main">⇒</span> bool <span class="main">×</span> bool list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iter</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bd</span><span class="main">,</span><span class="bound">as</span><span class="main">)</span> <span class="bound">T</span><span class="main">.</span> fold_map_idx <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fold_map_idx <span class="main">(</span><span class="main">λ</span><span class="bound">j</span> <span class="bound">c</span> <span class="bound">b</span><span class="main">.</span>
     <span class="keyword1">let</span> <span class="bound">b'</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">∨</span> <span class="main">¬</span> check_eq <span class="main">(</span><span class="bound">bd</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">bd</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">T</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="bound">c</span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">≠</span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">1</span> False <span class="bound">T</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">count_tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_tr</span> <span class="main">=</span> foldl <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> Suc <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_map_idx_fst_snd_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">c</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">≠</span> snd <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">c</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span> <span class="main">∨</span> <span class="free">xs</span> <span class="main">≠</span> snd <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">c</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta f<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">y'</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">y'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">y'</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">y'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">f</span> <span class="free">y</span> <span class="free">xs</span> <span class="main">&lt;</span> foldl <span class="free">f</span> <span class="free">y'</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">y'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_map_idx_count<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">c</span> <span class="main">∨</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">y'</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">y'</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">g</span> <span class="bound">y'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">c</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">c</span> <span class="main">∨</span> foldl <span class="free">g</span> <span class="free">y</span> <span class="main">(</span>snd <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">c</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> foldl <span class="free">g</span> <span class="free">y</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">g</span> <span class="free">y</span> <span class="main">(</span>snd <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">c</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> foldl <span class="free">g</span> <span class="free">y</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> f' <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">simplified</span> le_eq_less_or_eq<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">y</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="skolem">c</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> f <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_le_trans foldl_mono g Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> f' <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">simplified</span> le_eq_less_or_eq<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans less_imp_le
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> foldl_mono g Cons<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> iter_count<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">T'</span><span class="main">)</span> <span class="main">=</span> iter <span class="main">(</span><span class="free">bd</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count_tr <span class="free">T'</span> <span class="main">&lt;</span> count_tr <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fold_map_idx <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fold_map_idx <span class="main">(</span><span class="main">λ</span><span class="bound">j</span> <span class="bound">c</span> <span class="bound">b</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="bound">b'</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">∨</span> <span class="main">¬</span> check_eq <span class="main">(</span><span class="free">bd</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bd</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="free">T</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">c</span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">≠</span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> False <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> eq <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?f</span> <span class="main">=</span> <span class="main">(</span>False <span class="main">∨</span> count_tr <span class="main">(</span>snd <span class="var">?f</span><span class="main">)</span> <span class="main">&lt;</span> count_tr <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> count_tr_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fold_map_idx_count foldl_mono <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> arg_cong<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted">snd</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> iter_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">fixpt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> bool list list <span class="main">⇒</span> bool list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fixpt</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">T2</span><span class="main">)</span> <span class="main">=</span> iter <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">fixpt</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">T2</span> <span class="keyword1">else</span> <span class="bound">T2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> count_tr <span class="bound">T</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iter_count<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fixpt_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iter <span class="free">M</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> fixpt <span class="free">M</span> <span class="free">T</span> <span class="main">=</span> fixpt <span class="free">M</span> <span class="main">(</span>snd <span class="main">(</span>iter <span class="free">M</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fixpt_False<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>fst <span class="main">(</span>iter <span class="free">M</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> fixpt <span class="free">M</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta iter_def fold_map_idx_fst_snd_eq<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> fixpt.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> fixpt_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">T</span><span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span>iter <span class="bound">M</span> <span class="bound">T</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">M</span> <span class="main">(</span>snd <span class="main">(</span>iter <span class="bound">M</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">M</span> <span class="bound">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">M</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fixpt.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">M</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> H<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> 1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl prod.collapse<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dist_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_nodes</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">M</span> <span class="bound">n</span> <span class="bound">m</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="bound">m</span><span class="main">)</span> <span class="bound">w</span> <span class="main">∧</span>
     dfa_accepting <span class="bound">M</span> <span class="main">(</span>dfa_steps <span class="bound">M</span> <span class="bound">p</span> <span class="bound">w</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="bound">M</span> <span class="main">(</span>dfa_steps <span class="bound">M</span> <span class="bound">q</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> bool list list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_tr</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">M</span> <span class="bound">T</span><span class="main">.</span> length <span class="bound">T</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="bound">M</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">T</span><span class="main">.</span> length <span class="main">(</span><span class="bound">T</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> make_tr_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>make_tr <span class="free">f</span> <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> make_tr_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> make_tr <span class="free">f</span> <span class="free">n</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_tr_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_tr_def wf_tr_def split_beta make_tr_len make_tr_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_map_idx_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">y</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_map_idx_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
  snd <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">y</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>fold_map_idx <span class="free">f</span> <span class="free">i</span> <span class="free">y</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta nth_Cons' take_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_tr_dist_nodes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> dist_nodes <span class="free">M</span> <span class="main">0</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="main">0</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span>snd <span class="free">M</span> <span class="main">!</span> <span class="free">p</span> <span class="main">≠</span> snd <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_nodes_def dfa_accepting_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>snd <span class="free">M</span> <span class="main">!</span> <span class="free">p</span> <span class="main">≠</span> snd <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def init_tr_def tr_lookup_def make_tr_nth split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dist_nodes_suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> is_alph <span class="free">v</span> <span class="bound">bs</span> <span class="main">∧</span> dist_nodes <span class="free">M</span> <span class="free">n</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">p</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">q</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dist_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">with</span></span> W B L <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> is_alph <span class="free">v</span> <span class="bound">bs</span> <span class="main">∧</span> dist_nodes <span class="free">M</span> <span class="free">n</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="bound">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_nodes_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> is_alph <span class="free">v</span> <span class="bound">bs</span> <span class="main">∧</span> dist_nodes <span class="free">M</span> <span class="free">n</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="bound">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"is_alph <span class="free">v</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> V'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> dist_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">p</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">q</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> W <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> V V' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dist_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_lookup_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="free">B</span> <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> bdd_lookup <span class="free">B</span> <span class="free">bs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bdd_lookup.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">b</span> <span class="skolem">bs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> bddh <span class="bound">n</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">n</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">m</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> bddh_ge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">n</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> bddh_ge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">n</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>Suc <span class="main">(</span>max <span class="skolem">n</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> check_eq_dist_nodes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="free">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="free">T</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="free">M</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="free">M</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="free">l</span> <span class="free">r</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="free">l</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="free">l</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="free">r</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> check_eq.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> 1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_nodes_def tr_lookup_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IV1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="skolem">l</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> IV2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="skolem">r</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> check_eq <span class="skolem">l</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">∨</span> <span class="main">¬</span> check_eq <span class="skolem">r</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span> <span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span><span class="main">)</span> <span class="main">=</span> <span class="var">?E</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> IV1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> bddh_exists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_append<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> IV2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> bddh_exists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_append<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">br</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">br</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> O IV1 IV2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IV1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> IV2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> check_eq <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">l</span> <span class="skolem">T</span> <span class="main">∨</span> <span class="main">¬</span> check_eq <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span> <span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span><span class="main">)</span> <span class="main">=</span> <span class="var">?E</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> IV1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> bddh_exists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_append<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> IV2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> bddh_exists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="skolem">k</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_append<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Leaf <span class="skolem">i</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">br</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">br</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> O IV1 IV2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">l2</span> <span class="skolem">r2</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IV1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">l1</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">l2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">l1</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">l2</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> IV2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">r1</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="skolem">r2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">r1</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">r2</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="main">(</span>Branch <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> check_eq <span class="skolem">l1</span> <span class="skolem">l2</span> <span class="skolem">T</span> <span class="main">∨</span> <span class="main">¬</span> check_eq <span class="skolem">r1</span> <span class="skolem">r2</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> <span class="var">?E</span> <span class="bound">bs</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> <span class="var">?E</span> <span class="bound">bs</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">l1</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">l2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">l1</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">l2</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> IV1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> bddh_exists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span> K1<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k1</span> <span class="skolem">r1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> K2<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k2</span> <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">l1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">l2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">r1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k1</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k2</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span>False <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_append<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">r1</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">r2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="skolem">r1</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">r2</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> IV2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> bddh_exists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span> K1<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k1</span> <span class="skolem">l1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> K2<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">k2</span> <span class="skolem">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">l1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">l2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">r1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k1</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_ge<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">k2</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">+</span> max <span class="skolem">k1</span> <span class="skolem">k2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Branch <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="main">(</span>max <span class="skolem">k1</span> <span class="skolem">k2</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_append<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> <span class="var">?E</span> <span class="bound">bs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">br</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">br</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> O IV1 IV2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="free">T</span> <span class="main">⟹</span> wf_tr <span class="free">M</span> <span class="main">(</span>snd <span class="main">(</span>iter <span class="free">M</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tr_def iter_def fold_map_idx_len fold_map_idx_nth split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fixpt_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="free">T</span> <span class="main">⟹</span> wf_tr <span class="free">M</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fixpt_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">M</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iter <span class="skolem">M</span> <span class="skolem">T</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">bs</span><span class="main">.</span> <span class="free">bss</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">∧</span> length <span class="bound">b</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">bs</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">∧</span> length <span class="bound">b</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">∧</span> length <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Suc Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">∧</span> length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> iter_dist_nodes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="free">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="free">T</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>snd <span class="main">(</span>iter <span class="free">M</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Suc <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> check_eq <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> check_eq <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_eq_dist_nodes wf_dfa_def list_all_iff dfa_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">bss</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span>
      length <span class="skolem">bss</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="skolem">bss</span> <span class="main">∧</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="skolem">bss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dist_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> list_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">@</span> replicate <span class="free">v</span> False"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b'</span> <span class="bound">bs'</span><span class="main">.</span> <span class="skolem">bs</span> <span class="main">@</span> replicate <span class="free">v</span> False <span class="main">=</span> <span class="bound">b'</span> <span class="main">@</span> <span class="bound">bs'</span> <span class="main">∧</span> length <span class="bound">b'</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">@</span> replicate <span class="free">v</span> False <span class="main">=</span> <span class="skolem">b'</span> <span class="main">@</span> <span class="skolem">bs'</span> <span class="main">∧</span> length <span class="skolem">b'</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> X bdd_lookup_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">v</span> False"</span></span><span class="main">]</span> bdd_lookup_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">v</span> False"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> replicate <span class="free">v</span> False<span class="main">)</span><span class="main">)</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs</span> <span class="main">@</span> replicate <span class="free">v</span> False<span class="main">)</span><span class="main">)</span> <span class="skolem">bss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">v</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="free">v</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 1 V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="skolem">b'</span><span class="main">)</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="skolem">b'</span><span class="main">)</span> <span class="skolem">bss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_append dfa_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> X V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_alph <span class="free">v</span> <span class="skolem">b'</span> <span class="main">∧</span> dist_nodes <span class="free">M</span> <span class="skolem">n</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="skolem">b'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_nodes_def is_alph_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_nodes_suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> X <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> is_alph <span class="free">v</span> <span class="bound">bs</span> <span class="main">∧</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="bound">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_nodes_suc<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> is_alph <span class="free">v</span> <span class="skolem">bs</span> <span class="main">∧</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> BS<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dfa_trans_def dist_nodes_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> bdd_all <span class="main">(</span>dfa_is_node <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> check_eq <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eq_dist_nodes<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>snd <span class="main">(</span>iter <span class="free">M</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> tr_lookup <span class="free">T</span> <span class="free">q</span> <span class="free">p</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="main">¬</span> check_eq <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_def wf_tr_def split_beta fold_map_idx_nth tr_lookup_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>tr_lookup <span class="free">T</span> <span class="free">q</span> <span class="free">p</span> <span class="main">∨</span> <span class="main">¬</span> check_eq <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="skolem">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> Suc <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> Suc <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="skolem">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this D M' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∨</span> dist_nodes <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixpt_dist_nodes'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="free">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="free">T</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="free">T</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fixpt_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">M</span> <span class="skolem">T</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>iter <span class="skolem">M</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iter <span class="skolem">M</span> <span class="skolem">T</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="skolem">M</span> <span class="skolem">q'</span> <span class="main">∧</span> <span class="skolem">p'</span> <span class="main">&lt;</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="var">?T</span> <span class="skolem">q'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="skolem">m</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> iter_dist_nodes<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="skolem">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="var">?T</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="skolem">m</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tr <span class="skolem">M</span> <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_wf<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> 1<span class="main">(</span>3<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span>"</span></span><span class="main">]</span> True
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>fixpt <span class="skolem">M</span> <span class="var">?T</span><span class="main">)</span> <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>iter <span class="skolem">M</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_def fold_map_idx_fst_snd_eq split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="skolem">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="skolem">T</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="bound">m'</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m'</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="skolem">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="skolem">T</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="skolem">m'</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">m'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="skolem">M</span> <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">&lt;</span> <span class="skolem">q'</span>"</span></span>
          <span class="keyword1"><span class="command">note</span></span> 1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> Suc
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Suc 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m'</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> H H2
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>snd <span class="main">(</span>iter <span class="skolem">M</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="skolem">m'</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iter_dist_nodes<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="skolem">T</span> <span class="skolem">q'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> Suc <span class="skolem">m'</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="skolem">M</span> <span class="skolem">q'</span> <span class="main">∧</span> <span class="skolem">p'</span> <span class="main">&lt;</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="skolem">T</span> <span class="skolem">q'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="skolem">T</span> <span class="skolem">q'</span> <span class="skolem">p'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> H C<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dist_nodes <span class="skolem">M</span> <span class="skolem">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n'</span></span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n'</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> H C<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="skolem">T</span> <span class="skolem">q'</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="skolem">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="skolem">T</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="skolem">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="quoted"><span class="quoted">‹dfa_is_node <span class="skolem">M</span> <span class="free">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&lt;</span> <span class="free">q</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixpt_dist_nodes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> init_tr_wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">&lt;</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span> <span class="skolem">q'</span> <span class="skolem">p'</span> <span class="main">=</span> dist_nodes <span class="free">M</span> <span class="main">0</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> init_tr_dist_nodes<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span> <span class="skolem">q'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="main">1</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> dfa_is_node <span class="free">M</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="bound">q</span> <span class="main">⟶</span> tr_lookup <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="main">1</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> H1 H2
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fixpt_dist_nodes'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def dist_nodes_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mk_eqcl'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool list list <span class="main">⇒</span> nat option list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_eqcl'</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mk_eqcl'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> tr_lookup <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> None <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">mk_eqcl'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl'_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>mk_eqcl' <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span> <span class="free">l</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">mk_eqcl</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat <span class="main">⇒</span> bool list list <span class="main">⇒</span> nat list <span class="main">×</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_eqcl</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_eqcl</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span><span class="bound">zs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">mk_eqcl</span> <span class="main">(</span>mk_eqcl' <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">,</span> <span class="bound">zs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_eqcl</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span><span class="bound">zs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">mk_eqcl</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">,</span> <span class="bound">zs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">lexicographic_order</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl'_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>mk_eqcl' <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span> <span class="free">l</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">l</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">l</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tr_lookup <span class="free">T</span> <span class="skolem">j</span> <span class="free">i</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≠</span> None"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl'_nth'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="free">xs</span> <span class="free">i</span> <span class="free">j</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="free">j'</span> <span class="main">=</span> Some <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="free">j'</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> I1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">j'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j''</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> Suc <span class="skolem">j''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="skolem">j''</span></span><span class="main">]</span> I1 Cons<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> J <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="skolem">j</span> <span class="free">i</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Cons H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl'_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span> <span class="bound">j'</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="bound">j'</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j'</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> <span class="free">jj</span><span class="main">)</span> <span class="main">(</span><span class="bound">j'</span> <span class="main">+</span> <span class="free">jj</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">a</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="bound">b</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="bound">c</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> <span class="free">jj</span> <span class="main">=</span> length <span class="free">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> <span class="free">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> <span class="free">jj</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mk_eqcl' <span class="free">xs</span> <span class="free">ii</span> <span class="free">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="free">xs</span> <span class="free">ii</span> <span class="free">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">jj</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">jj</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">jj</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">from</span></span> Nil<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">jj</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">=</span><span class="main">0</span>›</span></span> Cons<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 0 Cons<span class="main">(</span>5<span class="main">,</span>9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Some <span class="free">m</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">=</span> None <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="skolem">jj</span> <span class="free">ii</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tr_lookup <span class="free">T</span> <span class="skolem">jj</span> <span class="free">ii</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Some <span class="free">m</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="free">ii</span> <span class="main">(</span>Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">jj</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span> 
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span> <span class="skolem">jj</span> <span class="skolem">j'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> Cons<span class="main">(</span>8<span class="main">,</span>10<span class="main">)</span> Suc 0 H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> None <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="skolem">jj</span> <span class="free">ii</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="free">ii</span> <span class="main">(</span>Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl'_nth'<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> Suc <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>10<span class="main">)</span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Suc H 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span> 
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="free">ii</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> H' Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> H' Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="free">ii</span></span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 0 H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl'_bound<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span><span class="main">)</span><span class="main">.</span> mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">m</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">∨</span> <span class="free">m</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main"><span class="main">(</span></span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">jj</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">jj</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tr_lookup <span class="free">T</span> <span class="skolem">jj</span> <span class="free">ii</span> <span class="main">∨</span> <span class="skolem">a</span> <span class="main">≠</span> None"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> 0 H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tr_lookup <span class="free">T</span> <span class="skolem">jj</span> <span class="free">ii</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≠</span> None"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>8<span class="main">,</span>10<span class="main">)</span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl'_nth'<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> H Cons<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">with</span></span> 0 H Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="free">ii</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> H' Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> H' Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="free">ii</span></span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">ii</span> <span class="skolem">jj</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="free">ii</span> <span class="main">(</span>Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span> <span class="bound">j'</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="bound">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j'</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="bound">j'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">a</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="bound">b</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="bound">c</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">+</span> Suc <span class="skolem">jj</span> <span class="main">=</span> length <span class="free">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">ii</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ii</span> <span class="main">&lt;</span> Suc <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>8<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">=</span>Suc <span class="skolem">i'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>9<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">=</span>Suc <span class="skolem">i'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mk_eqcl' <span class="skolem">xs</span> <span class="free">ii</span> <span class="main">(</span>Suc <span class="skolem">jj</span><span class="main">)</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>10<span class="main">)</span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Suc <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">=</span>Suc <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">jj</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl'_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mk_eqcl' <span class="free">xs</span> <span class="free">ii</span> <span class="free">j</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">j</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl'_Some2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="free">xs</span> <span class="free">ii</span> <span class="free">j</span> <span class="free">l</span> <span class="free">T</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">j</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fst_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta mk_eqcl'_len mk_eqcl'_Some2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l</span> <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_len_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">zs</span> <span class="main">≤</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_len_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta mk_eqcl'_len<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_set_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">j</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_snd_mon<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j1</span> <span class="bound">j2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">j1</span> <span class="main">&lt;</span> <span class="bound">j2</span><span class="main">;</span> <span class="bound">j2</span> <span class="main">&lt;</span> length <span class="free">zs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">zs</span> <span class="main">!</span> <span class="bound">j1</span> <span class="main">&lt;</span> <span class="free">zs</span> <span class="main">!</span> <span class="bound">j2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j1</span> <span class="main">&lt;</span> <span class="free">j2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j2</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">j1</span> <span class="main">&lt;</span> snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">j2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j1</span> <span class="bound">j2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">j1</span> <span class="main">&lt;</span> <span class="bound">j2</span><span class="main">;</span> <span class="bound">j2</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j2</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j1</span> <span class="skolem">j2</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">&lt;</span> <span class="skolem">j2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> length <span class="skolem">zs</span> <span class="main">∨</span> <span class="skolem">j2</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this H 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">zs</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> 2<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j2</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">j1</span> <span class="main">&lt;</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l</span> <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">zs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> 3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j2</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">j1</span> <span class="main">&lt;</span> snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_snd_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">j</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">zs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta nth_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> length <span class="skolem">zs</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_snd<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">k'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> Some <span class="skolem">k'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">from</span></span> this H' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl'_bound<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> H 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l</span> <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_snd<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fst_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">zs</span> <span class="main">⟹</span> <span class="free">zs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">(</span><span class="free">zs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">ii</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">zs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">ii</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j1</span> <span class="bound">j2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">j1</span> <span class="main">&lt;</span> <span class="bound">j2</span><span class="main">;</span> <span class="bound">j2</span> <span class="main">&lt;</span> length <span class="free">zs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">zs</span> <span class="main">!</span> <span class="bound">j1</span> <span class="main">&lt;</span> <span class="free">zs</span> <span class="main">!</span> <span class="bound">j2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">ii</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> <span class="free">ii</span> <span class="main">≤</span> length <span class="free">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">ii</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≥</span> <span class="free">ii</span> <span class="main">⟶</span>  fst <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="free">ii</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> 1<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">∧</span>
    <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">⟶</span> mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">i'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">zs</span> <span class="main">∨</span> <span class="skolem">i'</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">⟶</span> mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">i'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">⟶</span> <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">hence</span></span> K'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> K H' H I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> K I H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl'_Some nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> K' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> G1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j1</span> <span class="bound">j2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">j1</span> <span class="main">&lt;</span> <span class="bound">j2</span><span class="main">;</span> <span class="bound">j2</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j2</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j1</span> <span class="skolem">j2</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">&lt;</span> <span class="skolem">j2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> length <span class="skolem">zs</span> <span class="main">∨</span> <span class="skolem">j2</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this H 2<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j1</span></span> <span class="quoted"><span class="skolem">j2</span></span><span class="main">]</span> 2<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j1</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="skolem">zs</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">≤</span> length <span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">∧</span>
   <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">≤</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">⟶</span>
    fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∨</span> Suc <span class="skolem">i</span> <span class="main">≤</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_snd_nth split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> k_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_snd<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> K'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> H' this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl_snd_mon<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> H' 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">&lt;</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl_snd_mon<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">with</span></span> H k_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> K'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> H IV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> K' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> G1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l</span> <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta mk_eqcl_len_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">zs</span> <span class="main">⟹</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">+</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> H2 G2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> K <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> G1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> 3<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="skolem">zs</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>5<span class="main">)</span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">≤</span> length <span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">i</span> <span class="main">∧</span>
    <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">≤</span> snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">⟶</span> fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta mk_eqcl_len_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">&lt;</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 3 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> T1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> set <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> set <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_set_snd<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> T1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> H <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> K'<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 1 H IV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> K K' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> G1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fst_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">ii</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="free">ii</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">a</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="bound">b</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="bound">c</span> <span class="main">≤</span> length <span class="free">T</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> <span class="free">ii</span> <span class="main">=</span> length <span class="free">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="free">xs</span> <span class="free">zs</span> <span class="free">ii</span> <span class="free">T</span><span class="main">)</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="free">T</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">ii</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">ii</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">ii</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_eqcl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> length <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> H J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fst_Some mk_eqcl'_len<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">≠</span> None"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> H J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> Suc <span class="skolem">ii</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl'_nth'<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> J 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">;</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">;</span> mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span>
         <span class="main">⟹</span> <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="skolem">j'</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">+</span> Suc <span class="skolem">ii</span> <span class="main">=</span> length <span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">ii</span>"</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">≠</span> None"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">with</span></span> H' 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&lt;</span> Suc <span class="skolem">ii</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> H<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl'_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">from</span></span> this H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl'_bound<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">ii</span> <span class="main">=</span> length <span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> H Suc J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl'_len<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="skolem">xs</span> <span class="skolem">ii</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ii</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Suc J <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> L <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>6<span class="main">)</span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 2<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> L<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l</span> <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> H J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fst_Some<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> H 0 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">;</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> 3<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>5<span class="main">)</span> H Suc J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">+</span> Suc <span class="skolem">ii</span> <span class="main">=</span> length <span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="skolem">xs</span> <span class="skolem">zs</span> <span class="main">(</span>Suc <span class="skolem">ii</span><span class="main">)</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> Suc <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> J Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> L <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>6<span class="main">)</span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>Some <span class="skolem">l</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">ii</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="skolem">T</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">ii</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 3<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> L<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tr_lookup_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_dfa</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bd</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">os</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span> <span class="main">=</span> mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="bound">bd</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="main">(</span><span class="bound">bd</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="main">(</span>init_tr <span class="main">(</span><span class="bound">bd</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="bound">os</span> <span class="main">!</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="bound">bd</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">ns</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">as</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_nodes</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">M</span> <span class="bound">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="bound">M</span> <span class="bound">n</span> <span class="bound">v</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fixpt_fst_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="var">?M</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>None<span class="main">::</span>nat option<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="var">?M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def mk_eqcl_len_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl_bound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fixpt_fst_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span>
          <span class="main">=</span> eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fixpt_wf init_tr_wf<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">a</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="bound">b</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="bound">c</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">;</span> <span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">⟧</span>
      <span class="main">⟹</span> <span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">b</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> H''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def<span class="main">)</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">hence</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> H'' WF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tr_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">with</span></span> H' <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dfa_is_node_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H'<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixpt_dist_nodes<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dist_nodes <span class="free">M</span> <span class="bound">n</span> <span class="free">v</span> <span class="skolem">a</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_nodes_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H' assms D <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixpt_dist_nodes<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span><span class="main">;</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>None<span class="main">::</span>nat option<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> WF assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tr_def wf_dfa_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> length <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&lt;</span> length <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> tr_lookup <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span><span class="main">+</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl_fst_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fixpt_dist_nodes eq_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fixpt_fst_snd_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"snd <span class="var">?M</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="var">?M</span><span class="main">)</span> <span class="main">∧</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>snd <span class="var">?M</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">[]</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">≤</span> <span class="main">[]</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟶</span> replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None <span class="main">!</span> <span class="main">(</span><span class="main">[]</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j1</span> <span class="bound">j2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">j1</span> <span class="main">&lt;</span> <span class="bound">j2</span><span class="main">;</span> <span class="bound">j2</span> <span class="main">&lt;</span> length <span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">!</span> <span class="bound">j1</span> <span class="main">&lt;</span> <span class="main">[]</span> <span class="main">!</span> <span class="bound">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="main">[]</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">≤</span> length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tr <span class="free">M</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> init_tr_wf fixpt_wf<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> WF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> M <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="var">?M</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="var">?M</span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">≤</span> snd <span class="var">?M</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⟶</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>snd <span class="var">?M</span> <span class="main">!</span> <span class="free">i</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mk_eqcl_fst_snd<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_nodes_dfa_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_alph <span class="free">v</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">q</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq_nodes_def dist_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">bs</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">p</span> <span class="main">(</span><span class="free">bs</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">q</span> <span class="main">(</span><span class="free">bs</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq_nodes_def dist_nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fixpt_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_alph <span class="free">v</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_trans <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> 
    fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"dfa_trans <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="free">bs</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="var">?M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">!</span> <span class="var">?q</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_fst_bound mk_eqcl_fixpt_fst_snd_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="var">?q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_fst wf_dfa_def list_all_iff is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> I1 <span class="keyword1"><span class="command">have</span></span> I3<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_fst dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms I1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="free">p</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_fst_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="var">?q</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_nodes_dfa_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms I3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="free">p</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>dfa_trans <span class="free">M</span> <span class="var">?q</span> <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_trans_is_node mk_eqcl_fixpt_fst_nth<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> assms I2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_trans_def min_dfa_def split_beta mk_eqcl_fixpt_fst_bound bdd_map_bdd_lookup<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fixpt_steps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_steps <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span>
    fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">p</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"dfa_steps <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="free">p</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="free">p</span> <span class="free">w</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_trans dfa_trans_is_node<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_eqcl_fixpt_startnode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> 
    fst <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> snd <span class="main">(</span>mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="var">?M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> snd <span class="var">?M</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> K <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="var">?M</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="main">(</span>mk_eqcl <span class="main">(</span>mk_eqcl' <span class="main">(</span>replicate <span class="skolem">k</span> None<span class="main">)</span> <span class="main">0</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> length <span class="main">[</span><span class="main">0</span><span class="main">::</span>nat<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_snd<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="var">?M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta mk_eqcl_snd_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_dfa_wf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span> <span class="main">⟹</span> wf_dfa <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bd</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"min_dfa <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bd</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"min_dfa <span class="free">M</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bd</span> <span class="main">=</span> fst <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> snd <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">bd</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">bd</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">bd</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> M H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="var">?M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_dfa_def split_beta mk_eqcl_fixpt_fst_snd_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="main">(</span>snd <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_fst dfa_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> BH<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">v</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="main">(</span>snd <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def list_all_iff dfa_is_node_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> I M <span class="keyword1"><span class="command">have</span></span> BI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bd</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="main">(</span>snd <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta min_dfa_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> BH <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">v</span> <span class="main">(</span><span class="skolem">bd</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_bdd_map<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> H N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="main">(</span>snd <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def list_all_iff dfa_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">!</span> <span class="skolem">q</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="var">?M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_fst_bound<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def min_dfa_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">M</span> <span class="main">!</span> <span class="main">(</span>snd <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_map<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> G1 BI I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">v</span> <span class="skolem">x</span> <span class="main">∧</span> bdd_all <span class="main">(</span>dfa_is_node <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bddh <span class="free">v</span><span class="main">)</span> <span class="skolem">bd</span> <span class="main">∧</span> list_all <span class="main">(</span>bdd_all <span class="main">(</span>dfa_is_node <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="var">?M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_startnode<span class="main">)</span>
  
  <span class="keyword1"><span class="command">with</span></span> G M <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def min_dfa_def split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">lemma</span></span> min_dfa_accept<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> dfa_accepts <span class="free">M</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mk_eqcl <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>fixpt <span class="free">M</span> <span class="main">(</span>init_tr <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> SN<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="var">?M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> fst <span class="var">?M</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> snd <span class="var">?M</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_startnode<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_steps <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">0</span> <span class="free">w</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_steps <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">0</span> <span class="free">w</span> <span class="main">=</span> dfa_steps <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_steps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_dfa_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_startnode_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> WF assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>dfa_steps <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_steps_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> D <span class="keyword1"><span class="command">have</span></span> DN<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="var">?M</span> <span class="main">!</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_steps_is_node dfa_startnode_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="var">?M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">!</span> <span class="var">?q</span> <span class="main">=</span> fst <span class="var">?M</span> <span class="main">!</span> dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_fst_bound mk_eqcl_fixpt_fst_snd_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_len_fst dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms N I <span class="keyword1"><span class="command">have</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_nodes <span class="free">M</span> <span class="free">v</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_eqcl_fixpt_fst_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> dfa_accepting <span class="free">M</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="free">M</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span> <span class="main">≠</span> dfa_accepting <span class="free">M</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist_nodes <span class="free">M</span> <span class="main">0</span> <span class="free">v</span> <span class="main">(</span>dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_nodes_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> EQ <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_nodes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> snd <span class="main">(</span>min_dfa <span class="free">M</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> dfa_steps <span class="free">M</span> <span class="main">0</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def dfa_accepting_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> WF DN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dfa_accepting <span class="free">M</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def wf_dfa_def min_dfa_def split_beta dfa_accepting_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dfa_accepts <span class="free">M</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def<span class="main">)</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹NFAs›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> nbddtable <span class="main">=</span> <span class="quoted"><span class="quoted">"bool list bdd list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> nfa <span class="main">=</span> <span class="quoted"><span class="quoted">"nbddtable <span class="main">×</span> astate"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nfa_is_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfa_is_node</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qs</span><span class="main">.</span> length <span class="bound">qs</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wf_nfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_nfa</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">(</span>list_all <span class="main">(</span>bddh <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
     list_all <span class="main">(</span>bdd_all <span class="main">(</span>nfa_is_node <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
     length <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
     length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">set_of_bv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_of_bv</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">bv_or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bv_or</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bv_or</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">bv_or</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bv_or_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bv_or <span class="free">l</span> <span class="free">r</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bv_or.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xx</span> <span class="skolem">xss</span> <span class="skolem">yy</span> <span class="skolem">yss</span> <span class="skolem">ii</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">ii</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ii</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bv_or_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> length <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>bv_or <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> length <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bv_or.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bv_or_set_of_bv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>bv_or <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> set_of_bv <span class="free">p</span> <span class="main">∪</span> set_of_bv <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfa_is_node_def set_of_bv_def bv_or_length bv_or_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bv_or_is_node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>nfa_is_node <span class="free">A</span> <span class="free">p</span><span class="main">;</span> nfa_is_node <span class="free">A</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> nfa_is_node <span class="free">A</span> <span class="main">(</span>bv_or <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bv_or_length nfa_is_node_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subsetbdd</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsetbdd</span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subsetbdd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bdd'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bdds</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free">subsetbdd</span> <span class="free"><span class="bound"><span class="entity">bdds</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>bdd_binop bv_or <span class="free"><span class="bound"><span class="entity">bdd</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd'</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">subsetbdd</span> <span class="free"><span class="bound"><span class="entity">bdds</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">bdd</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nfa_emptybdd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool list bdd"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfa_emptybdd</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Leaf <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_all_is_node_subsetbdd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bdds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list bdd list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">bd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list bdd"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bdds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">bd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bdds</span> <span class="main">=</span> length <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="skolem">bdds</span> <span class="skolem">q</span> <span class="skolem">bd</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">bdds</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">bd</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subsetbdd.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_binop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span><span class="skolem">n</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span> bv_or_length<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def nfa_emptybdd_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_subsetbdd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bddh <span class="free">l</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">l</span> <span class="free">bdd'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">l</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="free">q</span> <span class="free">bdd'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nfa_is_node_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main"><span class="main">(</span></span><span class="quoted"><span class="quoted">"fst <span class="free">A</span>"</span></span><span class="main"><span class="main">)</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">bdd'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subsetbdd.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_binop<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_lookup_subsetbdd'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">bdds</span> <span class="main">=</span> length <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">bdds</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="free">obdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bs</span> <span class="bound">w</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">bs</span> <span class="main">∈</span> set <span class="free">bdds</span><span class="main">;</span> length <span class="bound">w</span> <span class="main">=</span> length <span class="free">ws</span><span class="main">⟧</span> <span class="main">⟹</span> length <span class="main">(</span>bdd_lookup <span class="bound">bs</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">=</span> length <span class="free">ws</span> <span class="main">⟹</span> length <span class="main">(</span>bdd_lookup <span class="free">obdd</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="free">bdds</span> <span class="free">q</span> <span class="free">obdd</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">q</span><span class="main">.</span> <span class="free">q</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="free">bdds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="free">obdd</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bdds</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">obdd</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subsetbdd.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">bdd'</span> <span class="skolem">bdds</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">bdd</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="skolem">bdds</span> <span class="skolem">xs</span> <span class="main">(</span>bdd_binop bv_or <span class="skolem">bdd</span> <span class="skolem">bdd'</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="skolem">bdds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="main">(</span>bdd_binop bv_or <span class="skolem">bdd</span> <span class="skolem">bdd'</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_binop bdd_lookup_binop bv_or_length<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="skolem">bdds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="main">(</span>bdd_binop bv_or <span class="skolem">bdd</span> <span class="skolem">bdd'</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="skolem">bdds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>bdd_lookup <span class="skolem">bdd'</span> <span class="free">ws</span><span class="main">)</span> <span class="main">!</span> <span class="free">a</span> <span class="main">∨</span> <span class="main">(</span>bdd_lookup <span class="skolem">bdd</span> <span class="free">ws</span><span class="main">)</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_binop bv_or_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="main">(</span><span class="skolem">bdd'</span> <span class="main">#</span> <span class="skolem">bdds</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="skolem">bdd</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?Q</span> <span class="main">∨</span> <span class="var">?R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?Q</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?Q</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="var">?Q</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="skolem">bdds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="main">(</span>bdd_binop bv_or <span class="skolem">bdd</span> <span class="skolem">bdd'</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>True <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="main">(</span><span class="skolem">bdd'</span> <span class="main">#</span> <span class="skolem">bdds</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="skolem">bdd</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="skolem">bdds</span> <span class="skolem">xs</span> <span class="skolem">bdd</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="skolem">bdds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="skolem">bdd</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="skolem">bdds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="skolem">bdd</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>False <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span><span class="main">(</span><span class="skolem">bdd'</span> <span class="main">#</span> <span class="skolem">bdds</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="skolem">bdd</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> False H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> bdd_lookup_subsetbdd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">N</span> <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span> length <span class="free">q</span><span class="main">.</span> <span class="free">q</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">=</span> length <span class="free">ws</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bd</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span><span class="main">.</span> bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span> <span class="bound">bd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def list_all_iff<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bd</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="bound">bd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def list_all_iff<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> H
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bd</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span><span class="main">.</span> nfa_is_node <span class="free">N</span> <span class="main">(</span>bdd_lookup <span class="bound">bd</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">q</span><span class="main">.</span> <span class="free">q</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span> <span class="main">∨</span> bdd_lookup <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_lookup_subsetbdd' nfa_is_node_def wf_nfa_def list_all_iff nfa_emptybdd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfa_emptybdd_def nfa_is_node_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nfa_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfa_trans</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nfa_accepting'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfa_accepting'</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nfa_accepting'</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nfa_accepting'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∨</span> <span class="free">nfa_accepting'</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nfa_accepting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfa_accepting</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> nfa_accepting' <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_accepting'_set_of_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_accepting' <span class="free">l</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>set_of_bv <span class="free">l</span> <span class="main">∩</span> set_of_bv <span class="free">r</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nfa_accepting_help<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">q</span><span class="main">.</span> nfa_accepting' <span class="bound">as</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">as</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">q</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span> <span class="skolem">q</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nfa_accepting' <span class="skolem">as</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">as</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">q</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nfa_accepting'.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">q</span> <span class="skolem">qs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∧</span><span class="skolem">q</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_accepting' <span class="skolem">as</span> <span class="skolem">qs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">as</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">qs</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">qs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="skolem">as</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">qs</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">q</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">q</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">q</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">with</span></span> J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">∧</span><span class="skolem">q</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="skolem">a</span><span class="main">∧</span><span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="skolem">a</span><span class="main">∧</span><span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nfa_accepting' <span class="free">l</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">r</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">l</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_bv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>set_of_bv <span class="free">l</span> <span class="main">∩</span> set_of_bv <span class="free">r</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_accepting_set_of_bv<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_accepting <span class="free">A</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span>set_of_bv <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">∩</span> set_of_bv <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_accepting'_set_of_bv nfa_accepting_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nfa_startnode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> bool list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfa_startnode</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="main">0</span><span class="main">:=</span>True<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> aut_nfa <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_formed<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">A</span> <span class="free">n</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> aut_nfa <span class="main">&lt;</span> Automaton <span class="quoted"><span class="quoted">"nfa_trans <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"is_alph <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"is_alph <span class="free">n</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> well_formed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def bdd_all_is_node_subsetbdd<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> well_formed Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def nfa_emptybdd_def bddh_subsetbdd<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span>nfa_trans <span class="free">A</span> <span class="skolem">q</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> aut_nfa <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> trans_is_node <span class="main">=</span> trans_is_node
<span class="keyword1"><span class="command">lemmas</span></span> steps_is_node <span class="main">=</span> steps_is_node
<span class="keyword1"><span class="command">lemmas</span></span> reach_is_node <span class="main">=</span> reach_is_node
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nfa_trans_is_node <span class="main">=</span> aut_nfa.trans_is_node <span class="main">[</span><span class="operator">OF</span> aut_nfa.intro<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> nfa_steps_is_node <span class="main">=</span> aut_nfa.steps_is_node <span class="main">[</span><span class="operator">OF</span> aut_nfa.intro<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> nfa_reach_is_node <span class="main">=</span> aut_nfa.reach_is_node <span class="main">[</span><span class="operator">OF</span> aut_nfa.intro<span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nfa_steps</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> foldl <span class="main">(</span>nfa_trans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nfa_accepts</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> accepts <span class="main">(</span>nfa_trans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>nfa_accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nfa_reach</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> reach <span class="main">(</span>nfa_trans <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_startnode_is_node<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">A</span> <span class="free">n</span> <span class="main">⟹</span> nfa_is_node <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def wf_nfa_def nfa_startnode_def<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Automata Constructions›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Negation›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">negate_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">negate_dfa</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> map Not <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> negate_wf_dfa<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>negate_dfa <span class="free">A</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> wf_dfa <span class="free">A</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negate_dfa_def wf_dfa_def dfa_is_node_def split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> negate_negate_dfa<span class="main">:</span> <span class="quoted"><span class="quoted">"negate_dfa <span class="main">(</span>negate_dfa <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">t</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negate_dfa_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfa_accepts_negate<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>negate_dfa <span class="free">A</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> dfa_accepts <span class="free">A</span> <span class="free">bss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_steps <span class="main">(</span>negate_dfa <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="free">bss</span> <span class="main">=</span> dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negate_dfa_def dfa_trans_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_steps_is_node dfa_startnode_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def dfa_accepting_def wf_dfa_def dfa_is_node_def negate_dfa_def split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product Automaton›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">prod_succs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_succs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> add_leaves <span class="main">(</span>bdd_binop Pair <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_is_node</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> dfa_is_node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">i</span> <span class="main">∧</span> dfa_is_node <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">prod_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> nat option list list <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_invariant</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">tab</span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span><span class="main">.</span>
     length <span class="bound">tab</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tab'</span><span class="main">∈</span>set <span class="bound">tab</span><span class="main">.</span> length <span class="bound">tab'</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_ins</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">tab</span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="bound">tab</span><span class="main">[</span><span class="bound">i</span> <span class="main">:=</span> <span class="main">(</span><span class="bound">tab</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">[</span><span class="bound">j</span> <span class="main">:=</span> Some <span class="main">(</span>length <span class="bound">ps</span><span class="main">)</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
      <span class="bound">ps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">prod_memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">⇒</span> nat option list list <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_memb</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">tab</span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span><span class="main">.</span> <span class="bound">tab</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">prod_empt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> nat option list list <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_empt</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> None<span class="main">)</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">prod_dfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> nat option list list <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_dfs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> gen_dfs <span class="main">(</span>prod_succs <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> prod_ins prod_memb <span class="main">(</span>prod_empt <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">binop_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">binop_dfa</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">tab</span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">=</span> prod_dfs <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">in</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> bdd_binop <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> the <span class="main">(</span><span class="bound">tab</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">!</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">ps</span><span class="main">,</span>
        map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> prod_DFS <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_formed1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> well_formed2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">B</span> <span class="free">n</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> prod_DFS <span class="main">&lt;</span> DFS <span class="quoted"><span class="quoted">"prod_succs <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"prod_is_node <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"prod_invariant <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="quoted">prod_ins</span> <span class="quoted">prod_memb</span> <span class="quoted"><span class="quoted">"prod_empt <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_memb_def prod_ins_def prod_invariant_def
    prod_is_node_def split_paired_all dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">a</span> <span class="main">=</span> <span class="improper">aa</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">b</span> <span class="main">=</span> <span class="improper">ba</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_memb_def prod_empt_def prod_is_node_def split_paired_all dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> well_formed1 well_formed2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def prod_succs_def split_paired_all dfa_is_node_def wf_dfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> conjunct1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_leaves_binop_subset <span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> ys<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="free">A</span> <span class="main">!</span> <span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"fst <span class="free">B</span> <span class="main">!</span> <span class="improper">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_leaves_bdd_all_eq' list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_invariant_def prod_empt_def set_replicate_conv_if<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def prod_invariant_def
    prod_memb_def prod_ins_def split_paired_all dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> set_update_subset_insert<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> prod_DFS
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_dfs_eq_rtrancl<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_is_node <span class="free">A</span> <span class="free">B</span> <span class="free">x</span> <span class="main">⟹</span> prod_is_node <span class="free">A</span> <span class="free">B</span> <span class="free">y</span> <span class="main">⟹</span>
  prod_memb <span class="free">y</span> <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>prod_succs <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> prod_dfs_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> dfs_eq_rtrancl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_dfs_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_is_node <span class="free">A</span> <span class="free">B</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">k</span> <span class="main">∧</span> dfa_is_node <span class="free">A</span> <span class="free">i</span> <span class="main">∧</span> dfa_is_node <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>prod_is_node <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> empt_invariant
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>dfs <span class="main">(</span>prod_empt <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">k</span> <span class="main">∧</span> dfa_is_node <span class="free">A</span> <span class="free">i</span> <span class="main">∧</span> dfa_is_node <span class="free">B</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dfs <span class="main">(</span>prod_empt <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>dfs <span class="main">(</span>prod_empt <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_invariant<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_empt_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y1</span><span class="main">,</span> <span class="skolem">y2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y1</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y2</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> step y <span class="quoted"><span class="quoted">‹<span class="skolem">y1</span> <span class="main">=</span> <span class="free">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_ins_def prod_memb_def split_beta nth_append
            prod_invariant_def prod_is_node_def dfa_is_node_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> step y <span class="quoted"><span class="quoted">‹<span class="skolem">y1</span> <span class="main">=</span> <span class="free">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_ins_def prod_memb_def split_beta nth_append
            prod_invariant_def prod_is_node_def dfa_is_node_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> step y <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_ins_def prod_memb_def split_beta nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_dfs_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_invariant <span class="free">A</span> <span class="free">B</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>prod_is_node <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>gen_dfs <span class="main">(</span>prod_succs <span class="free">A</span> <span class="free">B</span><span class="main">)</span> prod_ins prod_memb <span class="free">z</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> z xs
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dfs_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_ins_def prod_memb_def split_paired_all prod_is_node_def prod_invariant_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">aa</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ba</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> prod_dfs_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>dfa_is_node <span class="free">A</span> <span class="free">i</span><span class="main">;</span> dfa_is_node <span class="free">B</span> <span class="free">j</span><span class="main">⟧</span> <span class="main">⟹</span> fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_def empt prod_is_node_def gen_dfs_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ins_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> empt_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> empt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succs_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_ins_def prod_empt_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_dfs_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_is_node <span class="free">A</span> <span class="free">B</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">i1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="free">i2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> j1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">j1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="free">j2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">!</span> <span class="free">i1</span> <span class="main">!</span> <span class="free">i2</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">!</span> <span class="free">j1</span> <span class="main">!</span> <span class="free">j2</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">i2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">j1</span><span class="main">,</span> <span class="free">j2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x i1 i2 i
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">i1</span><span class="main">,</span> <span class="free">i2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x j1 j2 j
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">j1</span><span class="main">,</span> <span class="free">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_dfs_statetrans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span>
    dfa_trans <span class="free">A</span> <span class="free">i</span> <span class="free">bs</span> <span class="main">!</span> dfa_trans <span class="free">B</span> <span class="free">j</span> <span class="free">bs</span> <span class="main">=</span> Some <span class="free">k'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="free">i</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">(</span>dfa_trans <span class="free">B</span> <span class="free">j</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> i well_formed1 bs <span class="keyword1"><span class="command">have</span></span> h_tr1<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j well_formed2 bs <span class="keyword1"><span class="command">have</span></span> h_tr2<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> i j k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_memb <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_memb_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>prod_succs <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i j s1 s2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_eq_rtrancl prod_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> h_tr1 h_tr2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">bs</span><span class="main">,</span> bdd_lookup <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span>
    bdd_lookup <span class="main">(</span>bdd_binop Pair <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_lookup_binop<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> i j h_tr1 h_tr2
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">bs</span><span class="main">,</span> bdd_lookup <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
    succsr <span class="main">(</span>prod_succs <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def prod_succs_def
      add_leaves_bdd_lookup <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span>"</span></span><span class="main"><span class="main">]</span></span> bddh_binop is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">bs</span><span class="main">,</span> bdd_lookup <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
    <span class="main">(</span>succsr <span class="main">(</span>prod_succs <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> well_formed1 well_formed2 bs i j
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_is_node <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">bs</span><span class="main">,</span> bdd_lookup <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_is_node_def bdd_all_bdd_lookup is_alph_def dfa_trans_is_node dfa_trans_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i well_formed1 bs
  <span class="keyword1"><span class="command">have</span></span> s_tr1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="free">i</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def dfa_trans_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> j well_formed2 bs
  <span class="keyword1"><span class="command">have</span></span> s_tr2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">(</span>dfa_trans <span class="free">B</span> <span class="free">j</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def dfa_trans_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k'</span><span class="main">.</span> fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> 
    dfa_trans <span class="free">A</span> <span class="free">i</span> <span class="free">bs</span> <span class="main">!</span> dfa_trans <span class="free">B</span> <span class="free">j</span> <span class="free">bs</span> <span class="main">=</span> Some <span class="bound">k'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s1 s2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_eq_rtrancl <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prod_memb_def split_beta prod_is_node_def dfa_trans_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> 
    dfa_trans <span class="free">A</span> <span class="free">i</span> <span class="free">bs</span> <span class="main">!</span> dfa_trans <span class="free">B</span> <span class="free">j</span> <span class="free">bs</span> <span class="main">=</span> Some <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> k' s_tr1 s_tr2 s1 s2
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="free">i</span> <span class="free">bs</span><span class="main">,</span> dfa_trans <span class="free">B</span> <span class="free">j</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prod_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> k' s_tr1 s_tr2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> binop_wf_dfa<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dfa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> well_formed1 well_formed2 <span class="keyword1"><span class="command">have</span></span> is_node_s1_s2<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_is_node <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def wf_dfa_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> bdd_binop <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> the <span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">!</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> conjI <span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> ij_k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_node_s1_s2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> well_formed1 i <span class="keyword1"><span class="command">have</span></span> bddh_tr1<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> less_tr1<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def list_all_iff dfa_is_node_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_formed2 j <span class="keyword1"><span class="command">have</span></span> bddh_tr2<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> less_tr2<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>dfa_is_node <span class="free">B</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def list_all_iff dfa_is_node_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> bddh_tr1 bddh_tr2 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>bdd_binop <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> the <span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">!</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_binop<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> the <span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> dfa_trans <span class="free">A</span> <span class="skolem">i</span> <span class="bound">bs</span> <span class="main">!</span> dfa_trans <span class="free">B</span> <span class="skolem">j</span> <span class="bound">bs</span><span class="main">)</span>
      <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bs</span>
      <span class="keyword3"><span class="command">assume</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">bs</span><span class="main">::</span>bool list<span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> i j
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> well_formed1 well_formed2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def wf_dfa_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> ij_k
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> dfa_trans <span class="free">A</span> <span class="skolem">i</span> <span class="skolem">bs</span> <span class="main">!</span> dfa_trans <span class="free">B</span> <span class="skolem">j</span> <span class="skolem">bs</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_statetrans<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> dfa_trans <span class="free">A</span> <span class="skolem">i</span> <span class="skolem">bs</span> <span class="main">!</span> dfa_trans <span class="free">B</span> <span class="skolem">j</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> bddh_tr1 bddh_tr2 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_binop <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> the <span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">!</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_binop bdd_lookup_binop bdd_all_bdd_lookup_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> dfa_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> this 1
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bddh <span class="free">n</span><span class="main">)</span> <span class="var">?tr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">&lt;</span> length <span class="var">?tr</span><span class="main">)</span><span class="main">)</span> <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_paired_all list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> well_formed1 well_formed2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def prod_dfs_start<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> is_node_s1_s2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> Some <span class="main">0</span> <span class="main">∧</span> dfa_is_node <span class="free">A</span> <span class="main">0</span> <span class="main">∧</span> dfa_is_node <span class="free">B</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 well_formed1 well_formed2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_def wf_dfa_def split_beta dfa_is_node_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> binop_dfa_reachable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bss<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_reach <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">0</span> <span class="free">bss</span> <span class="bound">m</span> <span class="main">∧</span>
    fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">∧</span>
    dfa_is_node <span class="free">A</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dfa_is_node <span class="free">B</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span>
    bdd_binop <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> the <span class="main">(</span>fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">!</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?tr</span> <span class="main">=</span> fst <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> well_formed1 well_formed2 <span class="keyword1"><span class="command">have</span></span> is_node_s1_s2<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_is_node <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_is_node_def wf_dfa_def dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> well_formed1 well_formed2 <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def wf_dfa_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> s1 s2 <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_start<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_reach <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">0</span> <span class="free">bss</span> <span class="bound">m</span> <span class="main">∧</span>
     fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">∧</span>
     dfa_is_node <span class="free">A</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dfa_is_node <span class="free">B</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="var">?lhs1</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?lhs2</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?lhs3</span> <span class="main">∧</span> <span class="var">?lhs4</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
     <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="var">?lhs1</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?lhs2</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?lhs3</span> <span class="main">∧</span> <span class="var">?lhs4</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs1</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs2</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lhs bss <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">from</span></span> is_node_s1_s2
        s1 s2 <span class="quoted"><span class="quoted">‹dfa_is_node <span class="free">A</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹dfa_is_node <span class="free">B</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> start <span class="quoted"><span class="quoted">‹fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_inj<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="main">[]</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_nil<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="main">[]</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_nil<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">j</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> binop_wf_dfa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def wf_dfa_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> snoc binop_wf_dfa <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_reach_is_node<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_def dfa_is_node_def split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> prod_dfs_bij <span class="main">[</span><span class="operator">OF</span> is_node_s1_s2<span class="main">,</span>
        <span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> j_tr1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> j_tr2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> Some_j<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">!</span> snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> j_tr1 j_tr2 s1 s2 Some_j
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> 
          dfa_trans <span class="free">A</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">!</span>
          dfa_trans <span class="free">B</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s_tr1'<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s_tr2'<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">(</span>dfa_trans <span class="free">B</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_statetrans<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> well_formed1 well_formed2 j_tr1 j_tr2 snoc
      <span class="keyword1"><span class="command">have</span></span> lh<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> rh<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def list_all_iff is_alph_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> dfa_trans_def binop_dfa_def Let_def split_beta fst_conv nth_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> j<span class="main"><span class="main">]</span></span> bdd_lookup_binop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lh<span class="main"><span class="main">,</span></span><span class="operator">OF</span> rh<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> dfa_trans_def<span class="main">]</span> k
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> is_node_s1_s2 <span class="quoted"><span class="quoted">‹dfa_is_node <span class="free">A</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹dfa_is_node <span class="free">B</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> s_tr1' s_tr2'
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">,</span> dfa_trans <span class="free">B</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> k
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_inj<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> snoc Some_j j_tr1 j_tr2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="skolem">bss</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_snoc<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> snoc Some_j j_tr1 j_tr2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="skolem">bss</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>dfa_trans <span class="free">B</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_snoc<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> bss
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> start s1 s2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_nil <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reach_nil_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">j</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> reach_s2'<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="skolem">bss</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> dfa_trans <span class="free">B</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">bs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reach_snoc_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> reach_s2'<span class="main">]</span> snoc<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> reach_m<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">bss</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">!</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s2''<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> binop_wf_dfa reach_m dfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> binop_wf_dfa<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> m_less<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dfa_reach_is_node<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> is_node_s1_s2 m j s2''
      <span class="keyword1"><span class="command">have</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> j s2'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> well_formed1 well_formed2 snoc
      <span class="keyword1"><span class="command">have</span></span> bddh<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">A</span> <span class="main">!</span> fst <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">B</span> <span class="main">!</span> snd <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def is_alph_def dfa_is_node_def list_all_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span>
          dfa_trans <span class="free">A</span> <span class="skolem">j</span> <span class="skolem">bs</span> <span class="main">!</span> dfa_trans <span class="free">B</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">bs</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s_tr1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>dfa_trans <span class="free">A</span> <span class="skolem">j</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s_tr2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="main">(</span>dfa_trans <span class="free">B</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j s2'' s1 s2 m
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_dfs_statetrans<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s2'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reach_snoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reach_m<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> m_less<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_trans_def binop_dfa_def split_beta dfa_is_node_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh bdd_lookup_binop split_beta<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_trans_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> m' k<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_tr1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_tr2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> binop_dfa_steps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">!</span> dfa_steps <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">0</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>snd <span class="free">A</span> <span class="main">!</span> dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">B</span> <span class="main">!</span> dfa_steps <span class="free">B</span> <span class="main">0</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?as3</span> <span class="main">!</span> dfa_steps <span class="var">?A</span> <span class="main">0</span> <span class="free">bs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> dfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> well_formed1<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> 5 <span class="main">=</span> dfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> well_formed2<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> B <span class="main">=</span> dfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> binop_wf_dfa<span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tab</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tab</span> <span class="main">=</span> fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">=</span> snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> tab_def ps_def <span class="keyword1"><span class="command">have</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tab</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="free">bs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> dfa_steps <span class="free">B</span> <span class="main">0</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> s1_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="free">bs</span> <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">B</span> <span class="main">0</span> <span class="free">bs</span> <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_reach <span class="var">?A</span> <span class="main">0</span> <span class="free">bs</span> <span class="bound">m</span> <span class="main">∧</span> fst <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">s1</span> <span class="main">!</span> <span class="skolem">s2</span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">∧</span> dfa_is_node <span class="free">A</span> <span class="skolem">s1</span> <span class="main">∧</span> dfa_is_node <span class="free">B</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_reachable<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> tab_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_reach <span class="var">?A</span> <span class="main">0</span> <span class="free">bs</span> <span class="bound">m</span> <span class="main">∧</span> <span class="skolem">tab</span> <span class="main">!</span> <span class="skolem">s1</span> <span class="main">!</span> <span class="skolem">s2</span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">∧</span> dfa_is_node <span class="free">A</span> <span class="skolem">s1</span> <span class="main">∧</span> dfa_is_node <span class="free">B</span> <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="var">?A</span> <span class="main">0</span> <span class="free">bs</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tab</span> <span class="main">!</span> <span class="skolem">s1</span> <span class="main">!</span> <span class="skolem">s2</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">B</span> <span class="skolem">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> dfa_steps <span class="var">?A</span> <span class="main">0</span> <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> B X R binop_wf_dfa <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> mL<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="var">?A</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_reach_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2 5 M s1 s2 <span class="keyword1"><span class="command">have</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>prod_dfs <span class="free">A</span> <span class="free">B</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tab_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_dfs_bij<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prod_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>snd <span class="free">A</span> <span class="main">!</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">B</span> <span class="main">!</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_def split_beta dfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> M' s1_def s2_def 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="var">?A</span> <span class="main">!</span> dfa_steps <span class="var">?A</span> <span class="main">0</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>snd <span class="free">A</span> <span class="main">!</span> dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">B</span> <span class="main">!</span> dfa_steps <span class="free">B</span> <span class="main">0</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> binop_wf_dfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">B</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A B
  <span class="keyword1"><span class="command">interpret</span></span> prod_DFS <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> binop_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> binop_dfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">B</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>binop_dfa <span class="free">f</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>dfa_accepts <span class="free">A</span> <span class="free">bss</span><span class="main">)</span> <span class="main">(</span>dfa_accepts <span class="free">B</span> <span class="free">bss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A B
  <span class="keyword1"><span class="command">interpret</span></span> prod_DFS <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">from</span></span> X <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def dfa_accepting_def binop_dfa_steps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">and_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">and_dfa</span> <span class="main">=</span> binop_dfa <span class="main">(∧)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> and_wf_dfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">N</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>and_dfa <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_dfa_def binop_wf_dfa<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> and_dfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">N</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>and_dfa <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span>dfa_accepts <span class="free">M</span> <span class="free">bs</span> <span class="main">∧</span> dfa_accepts <span class="free">N</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_accepts and_dfa_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">or_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">or_dfa</span> <span class="main">=</span> binop_dfa <span class="main">(∨)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> or_wf_dfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">N</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>or_dfa <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> or_dfa_def binop_wf_dfa<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> or_dfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">N</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>or_dfa <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span>dfa_accepts <span class="free">M</span> <span class="free">bs</span> <span class="main">∨</span> dfa_accepts <span class="free">N</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_accepts or_dfa_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">imp_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> dfa <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">imp_dfa</span> <span class="main">=</span> binop_dfa <span class="main">(⟶)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> imp_wf_dfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">N</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>imp_dfa <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_wf_dfa imp_dfa_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> imp_dfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">N</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>imp_dfa <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span>dfa_accepts <span class="free">M</span> <span class="free">bs</span> <span class="main">⟶</span> dfa_accepts <span class="free">N</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binop_dfa_accepts imp_dfa_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transforming DFAs to NFAs›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nfa_of_dfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfa_of_dfa</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bdd</span><span class="main">,</span><span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="bound">bdd</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="bound">q</span><span class="main">:=</span>True<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">bdd</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfa2wf_nfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> dfa_is_node <span class="free">M</span> <span class="bound">a</span> <span class="main">⟹</span> nfa_is_node <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="bound">a</span><span class="main">:=</span>True<span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def nfa_is_node_def nfa_of_dfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bdd</span><span class="main">.</span> bdd_all <span class="main">(</span>dfa_is_node <span class="free">M</span><span class="main">)</span> <span class="bound">bdd</span> <span class="main">⟹</span> bdd_all <span class="main">(</span>nfa_is_node <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="bound">q</span><span class="main">:=</span>True<span class="main">]</span><span class="main">)</span> <span class="bound">bdd</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_map<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span>nfa_is_node <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff split_beta nfa_of_dfa_def wf_dfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def wf_dfa_def nfa_of_dfa_def split_beta list_all_iff bddh_bdd_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> replicate_upd_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">q</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> <span class="main">(</span>replicate <span class="free">n</span> False<span class="main">)</span><span class="main">[</span><span class="free">q</span><span class="main">:=</span>True<span class="main">]</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="free">n</span> False<span class="main">)</span><span class="main">[</span><span class="free">p</span><span class="main">:=</span>True<span class="main">]</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">q</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">_</span> <span class="main">;</span><span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span><span class="main">⟧</span> <span class="main">⟹</span>  <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">!</span> <span class="free">q</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>›</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">!</span> <span class="free">q</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≠</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> r <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_of_dfa_reach'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">l</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="free">q</span><span class="main">:=</span>True<span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n1</span> <span class="free">bss</span> <span class="free">n2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">n2</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="bound">p</span><span class="main">:=</span>True<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> R V X N Q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="main">[]</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">j</span> <span class="skolem">bss</span> <span class="skolem">bs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def nfa_of_dfa_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> V2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa2wf_nfa<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="skolem">bss</span> <span class="bound">p</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="bound">p</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="skolem">bss</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">p</span><span class="main">:=</span>True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> JL<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def nfa_of_dfa_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> snoc PR <span class="keyword1"><span class="command">have</span></span> PL<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_reach_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc JL <span class="keyword1"><span class="command">have</span></span> PL'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def dfa_is_node_def nfa_of_dfa_def split_beta<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> dfa_trans <span class="free">M</span> <span class="skolem">p</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> snoc PR <span class="keyword1"><span class="command">have</span></span> MR<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> mL<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_reach_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> V2 JL snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>nfa_trans <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>nfa_trans <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def nfa_of_dfa_def split_beta<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_trans <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">bs</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">m</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq L<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> strip<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nfa_trans <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">m</span> <span class="main">:=</span> True<span class="main">]</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> V2 snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">note</span></span> JL <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> IL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_def split_beta<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span> 
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span> <span class="main">&lt;</span> length <span class="skolem">j</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">∧</span> bdd_lookup <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_lookup_subsetbdd<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> snoc J PL' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">with</span></span> xs PL snoc<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> m_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">m</span> <span class="main">:=</span> True<span class="main">]</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_def split_beta dfa_trans_def dfa_is_node_def wf_dfa_def is_alph_def bdd_map_bdd_lookup list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> H mL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> PL snoc<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> m_def <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_def split_beta dfa_is_node_def wf_dfa_def is_alph_def list_all_iff bdd_map_bdd_lookup dfa_trans_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> PL' J <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">p</span></span> <span class="main">&lt;</span> length <span class="skolem">j</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">!</span> <span class="bound">p</span> <span class="main">∧</span> bdd_lookup<span class="main">(</span> fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">!</span> <span class="bound">p</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>4<span class="main">)</span> V2 <span class="keyword1"><span class="command">have</span></span> V'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_def split_beta<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> H' V' E JL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_lookup_subsetbdd<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> MR <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> nfa_of_dfa_reach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">l</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="free">q</span><span class="main">:=</span>True<span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> N2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="free">p</span><span class="main">:=</span>True<span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n1</span> <span class="free">bss</span> <span class="free">n2</span> <span class="main">=</span> dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n1</span> <span class="free">bss</span> <span class="free">n2</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">n2</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="bound">p</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_reach'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">p'</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> V R Q X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">M</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_reach_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> N2 N2' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def replicate_upd_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> R <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2'</span> <span class="main">=</span> nfa_steps <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n1</span> <span class="free">bss</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n1</span> <span class="free">bss</span> <span class="skolem">n2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="bound">p</span> <span class="main">∧</span> <span class="skolem">n2'</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="bound">p</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_reach'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">q</span> <span class="free">bss</span> <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2'</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">M</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">p'</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> N2' N2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n2</span> <span class="main">=</span> <span class="skolem">n2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> R' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="main">(</span>nfa_of_dfa <span class="free">M</span><span class="main">)</span> <span class="free">n1</span> <span class="free">bss</span> <span class="free">n2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_accepting_replicate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="free">N</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfa_accepting <span class="free">N</span> <span class="main">(</span><span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="free">q</span><span class="main">:=</span>True<span class="main">]</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">N</span> <span class="main">!</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span><span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="free">q</span><span class="main">:=</span>True<span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_bv_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="free">q</span> <span class="main">:=</span> True<span class="main">]</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">q</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nfa_accepting <span class="free">N</span> <span class="main">(</span><span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="free">q</span><span class="main">:=</span>True<span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_of_bv <span class="main">(</span>snd <span class="free">N</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{</span><span class="free">q</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_accepting_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="main">∈</span> set_of_bv <span class="main">(</span>snd <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="free">N</span> <span class="main">!</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_bv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_of_dfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfa_accepts <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> dfa_accepts <span class="free">A</span> <span class="free">bss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> V <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_startnode_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_startnode <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="main">0</span><span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_startnode_def nfa_of_dfa_def split_beta<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">p</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p_def <span class="keyword1"><span class="command">have</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> p_def n2_def Q S X V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span> <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_reach<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> N2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> nfa_steps <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> PR Q X V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_reach_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def nfa_of_dfa_def split_beta<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> dfa2wf_nfa<span class="main">[</span><span class="operator">OF</span> V<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> n2_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span><span class="main">[</span><span class="skolem">p</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_of_dfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_accepting <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span> <span class="skolem">n2</span> <span class="main">=</span> snd <span class="main">(</span>nfa_of_dfa <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_accepting_replicate<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> N2 p_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def accepts_def dfa_accepting_def nfa_of_dfa_def split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transforming NFAs to DFAs›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">bddinsert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> bdd <span class="main">⇒</span> bool list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> bdd"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bddinsert</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bddinsert</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">then</span> Branch <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">bddinsert</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Branch <span class="main">(</span><span class="free">bddinsert</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bddinsert</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">then</span> Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free">bddinsert</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Branch <span class="main">(</span><span class="free">bddinsert</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_bddinsert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">x</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">≥</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="main">(</span>bddinsert <span class="free">b</span> <span class="free">w</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bddinsert.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">aa</span> <span class="skolem">ww</span> <span class="skolem">wss</span> <span class="skolem">yy</span> <span class="skolem">xaa</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">0</span> <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> length <span class="skolem">wss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>1<span class="main">)</span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">wss</span><span class="main">)</span> <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">wss</span> <span class="skolem">yy</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ww</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ll</span> <span class="skolem">rr</span> <span class="skolem">ww</span> <span class="skolem">wss</span> <span class="skolem">yy</span> <span class="skolem">xx</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">xx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xx</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">y</span> <span class="skolem">rr</span> <span class="main">∧</span> bddh <span class="skolem">y</span> <span class="skolem">ll</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">≤</span> length <span class="skolem">wss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ww</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 1 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">wss</span><span class="main">)</span> <span class="main">(</span>bddinsert <span class="skolem">rr</span> <span class="skolem">wss</span> <span class="skolem">yy</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Y 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> length <span class="skolem">wss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">y</span> <span class="skolem">ll</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">wss</span><span class="main">)</span> <span class="skolem">ll</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bddh_ge<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IV True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 1 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">wss</span><span class="main">)</span> <span class="main">(</span>bddinsert <span class="skolem">ll</span> <span class="skolem">wss</span> <span class="skolem">yy</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Y 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> length <span class="skolem">wss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="skolem">y</span> <span class="skolem">rr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">wss</span><span class="main">)</span> <span class="skolem">rr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bddh_ge<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IV False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_lookup_bddinsert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="free">w</span><span class="main">)</span> <span class="free">bd</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">=</span> length <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>bddinsert <span class="free">bd</span> <span class="free">w</span> <span class="free">y</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">y</span> <span class="keyword1">else</span> bdd_lookup <span class="free">bd</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bd</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bddinsert.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">aa</span> <span class="skolem">ww</span> <span class="skolem">wss</span> <span class="skolem">xx</span> <span class="skolem">vv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="bound">vs</span><span class="main">.</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">#</span> <span class="bound">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">vv</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">wss</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">wss</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="keyword1">then</span> <span class="skolem">xx</span> <span class="keyword1">else</span> bdd_lookup <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ww</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ww</span> <span class="main">#</span> <span class="skolem">wss</span><span class="main">)</span> <span class="skolem">xx</span><span class="main">)</span> <span class="skolem">vv</span> <span class="main">=</span> bdd_lookup <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">ww</span> <span class="keyword1">then</span> <span class="main">(</span>Branch <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Branch <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">ww</span> <span class="keyword1">then</span> bdd_lookup <span class="main">(</span>Branch <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vv</span> <span class="keyword1">else</span> bdd_lookup <span class="main">(</span>Branch <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span> <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> V IV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">ww</span> <span class="main">#</span> <span class="skolem">wss</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span> <span class="keyword1">then</span> bdd_lookup <span class="main">(</span>bddinsert <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span> <span class="skolem">vs</span> <span class="keyword1">else</span> bdd_lookup <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ww</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> V IV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">ww</span> <span class="main">#</span> <span class="skolem">wss</span> <span class="main">=</span> <span class="skolem">vv</span> <span class="keyword1">then</span> <span class="skolem">xx</span> <span class="keyword1">else</span> bdd_lookup <span class="main">(</span>Leaf <span class="skolem">aa</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ll</span> <span class="skolem">rr</span> <span class="skolem">ww</span> <span class="skolem">wss</span> <span class="skolem">xx</span> <span class="skolem">vv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="bound">vs</span><span class="main">.</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">#</span> <span class="bound">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">vv</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ww</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 3 V <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>bddinsert <span class="skolem">rr</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">wss</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="keyword1">then</span> <span class="skolem">xx</span> <span class="keyword1">else</span> bdd_lookup <span class="skolem">rr</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True 3 V <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 3 V <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>bddinsert <span class="skolem">ll</span> <span class="skolem">wss</span> <span class="skolem">xx</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">wss</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="keyword1">then</span> <span class="skolem">xx</span> <span class="keyword1">else</span> bdd_lookup <span class="skolem">ll</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> False 3 V <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subset_succs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subset_succs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> add_leaves <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subset_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> nat option bdd <span class="main">×</span> bool list list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subset_invariant</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bdd</span><span class="main">,</span> <span class="bound">qss</span><span class="main">)</span><span class="main">.</span> bddh <span class="main">(</span>length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">bdd</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subset_ins</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bdd</span><span class="main">,</span> <span class="bound">qss</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>bddinsert <span class="bound">bdd</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">(</span>Some <span class="main">(</span>length <span class="bound">qss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">qss</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subset_memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> nat option bdd <span class="main">×</span> bool list list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subset_memb</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bdd</span><span class="main">,</span> <span class="bound">qss</span><span class="main">)</span><span class="main">.</span> bdd_lookup <span class="bound">bdd</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subset_empt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option bdd <span class="main">×</span> bool list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subset_empt</span> <span class="main">=</span> <span class="main">(</span>Leaf None<span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subset_dfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> bool list <span class="main">⇒</span> nat option bdd <span class="main">×</span> bool list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subset_dfs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> gen_dfs <span class="main">(</span>subset_succs <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> subset_ins subset_memb subset_empt <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">det_nfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nfa <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">det_nfa</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">bdd</span><span class="main">,</span> <span class="bound">qss</span><span class="main">)</span> <span class="main">=</span> subset_dfs <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>nfa_startnode <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
             <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">qs</span><span class="main">.</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">qs</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="bound">bdd</span> <span class="bound">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">qs</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">qs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">qss</span><span class="main">,</span>
              map <span class="main">(</span><span class="main">λ</span><span class="bound">qs</span><span class="main">.</span> nfa_accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">qs</span><span class="main">)</span> <span class="bound">qss</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> subset_DFS <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_formed<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">A</span> <span class="free">n</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_list<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> list<span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> list<span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> Suc <span class="improper">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> Cons <span class="bound">x</span> <span class="main">`</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="improper">k</span><span class="main">}</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">sublocale</span></span> subset_DFS <span class="main">&lt;</span> DFS <span class="quoted"><span class="quoted">"subset_succs <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"subset_invariant <span class="free">A</span>"</span></span> <span class="quoted">subset_ins</span> <span class="quoted">subset_memb</span> <span class="quoted">subset_empt</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def subset_invariant_def subset_memb_def subset_ins_def bdd_lookup_bddinsert split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def subset_memb_def subset_empt_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> well_formed<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_succs_def add_leaves_bdd_all_eq bdd_all_is_node_subsetbdd wf_nfa_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_invariant_def subset_empt_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def subset_invariant_def subset_memb_def subset_ins_def split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="main">=</span> length <span class="improper">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bddh_bddinsert<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> subset_DFS
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> dfs_eq_rtrancl<span class="main">[</span><span class="operator">folded</span> subset_dfs_def<span class="main">]</span> <span class="main">=</span> dfs_eq_rtrancl

<span class="keyword1"><span class="command">lemma</span></span>  subset_dfs_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">v</span> <span class="main">=</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="free">q0</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> empt_invariant <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H1 <span class="keyword1"><span class="command">unfolding</span></span> subset_dfs_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_invariant<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span> <span class="skolem">vv</span> <span class="skolem">qq</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bd1</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bd1</span><span class="main">,</span> <span class="skolem">l1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">l1</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_ex <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">l1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">l1</span><span class="main">.</span> <span class="skolem">l1</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_ex_length<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">l1</span> <span class="main">∧</span> <span class="skolem">l1</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> step S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="skolem">bd1</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> step S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_memb_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">l1</span><span class="main">.</span> <span class="skolem">l1</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bd2</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">where</span></span> S2<span class="main">:</span> <span class="quoted"><span class="quoted">"subset_ins <span class="skolem">x</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bd2</span><span class="main">,</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"subset_ins <span class="skolem">x</span> <span class="skolem">S</span>"</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> S <span class="keyword1"><span class="command">have</span></span> SS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bd2</span> <span class="main">=</span> bddinsert <span class="skolem">bd1</span> <span class="skolem">x</span> <span class="main">(</span>Some <span class="main">(</span>length <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">l1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_ins_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> step S H1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>bddinsert <span class="skolem">bd1</span> <span class="skolem">x</span> <span class="main">(</span>Some <span class="main">(</span>length <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qq</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span> <span class="keyword1">then</span> Some <span class="main">(</span>length <span class="skolem">l1</span><span class="main">)</span> <span class="keyword1">else</span> bdd_lookup <span class="skolem">bd1</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_lookup_bddinsert subset_invariant_def nfa_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> SS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bdd_lookup <span class="skolem">bd2</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">vv</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span> <span class="keyword1">then</span> length <span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">vv</span> <span class="keyword1">else</span> bdd_lookup <span class="skolem">bd1</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">vv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span> <span class="main">∧</span> length <span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">vv</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">qq</span> <span class="main">∧</span> bdd_lookup <span class="skolem">bd1</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">vv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">vv</span> <span class="main">&lt;</span> length <span class="skolem">l2</span> <span class="main">∧</span> <span class="skolem">l2</span> <span class="main">!</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span> <span class="main">∧</span> length <span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">vv</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">qq</span> <span class="main">∧</span> bdd_lookup <span class="skolem">bd1</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">vv</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span> <span class="main">∧</span> length <span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">vv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">vv</span> <span class="main">&lt;</span> length <span class="skolem">l2</span> <span class="main">∧</span> <span class="skolem">l2</span> <span class="main">!</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">&lt;</span> length <span class="skolem">l2</span> <span class="main">∧</span> <span class="skolem">l2</span> <span class="main">!</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">qq</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span> <span class="main">∧</span> length <span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">vv</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">=</span> length <span class="skolem">l1</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> H SS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">&lt;</span> length <span class="skolem">l1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> SS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">!</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">l1</span> <span class="main">!</span> <span class="skolem">vv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> False H SS <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">&lt;</span> length <span class="skolem">l1</span> <span class="main">∧</span> <span class="skolem">l1</span> <span class="main">!</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> X <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SS<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">qq</span> <span class="main">∧</span> length <span class="skolem">l1</span> <span class="main">=</span> <span class="skolem">vv</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">qq</span> <span class="main">∧</span> bdd_lookup <span class="skolem">bd1</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">vv</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">qq</span> <span class="main">∧</span> bdd_lookup <span class="skolem">bd1</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">vv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> S <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">≠</span><span class="skolem">qq</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">vv</span> <span class="main">&lt;</span> length <span class="skolem">l1</span> <span class="main">∧</span> <span class="skolem">l1</span> <span class="main">!</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> SS <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">≠</span><span class="skolem">qq</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">vv</span> <span class="main">&lt;</span> length <span class="skolem">l2</span> <span class="main">∧</span> <span class="skolem">l2</span> <span class="main">!</span> <span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_empt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_dfs_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span><span class="main">)</span> <span class="free">q0</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bd</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"subset_ins <span class="free">q0</span> subset_empt <span class="main">=</span> <span class="main">(</span><span class="skolem">bd</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"subset_ins <span class="free">q0</span> subset_empt"</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> subset_memb <span class="free">q0</span> subset_empt"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empt<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H empt_invariant <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"subset_invariant <span class="free">A</span> <span class="main">(</span>subset_ins <span class="free">q0</span> subset_empt<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>subset_succs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succs_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>gen_dfs <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span> subset_ins subset_memb <span class="main">(</span>subset_ins <span class="free">q0</span> subset_empt<span class="main">)</span> <span class="main">(</span>subset_succs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">q0</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_invariant<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> subset_ins_def subset_empt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">q0</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"subset_memb <span class="free">q0</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_memb_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q0</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_invariant_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> H step <span class="quoted"><span class="quoted">‹<span class="free">q0</span><span class="main">≠</span><span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> bdd_lookup <span class="main">(</span>bddinsert <span class="main">(</span>fst <span class="skolem">S</span><span class="main">)</span> <span class="skolem">x</span> <span class="bound">v</span><span class="main">)</span> <span class="free">q0</span> <span class="main">=</span> bdd_lookup <span class="main">(</span>fst <span class="skolem">S</span><span class="main">)</span> <span class="free">q0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_lookup_bddinsert nfa_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>subset_ins <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="free">q0</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_ins_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> subset_dfs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfa_is_node_def gen_dfs_simps subset_memb_def subset_empt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_dfs_is_node<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="free">q0</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> empt_invariant <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> subset_dfs_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfs_invariant<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_empt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_ins_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_wf_nfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bt</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> BT<span class="main">:</span> <span class="quoted"><span class="quoted">"subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bt</span><span class="main">,</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> Q <span class="main">=</span> nfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> well_formed<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Q <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span><span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> BT <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"det_nfa <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="skolem">bt</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">,</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> nfa_accepting <span class="free">A</span> <span class="bound">q</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="var">?bdt</span><span class="main">,</span> <span class="var">?atbl</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> det_nfa_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BT<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> well_formed L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> bddh <span class="free">n</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ls</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_subsetbdd wf_nfa_def nfa_emptybdd_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> bddh <span class="free">n</span> <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="skolem">bt</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_bdd_map<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bddh <span class="free">n</span><span class="main">)</span> <span class="var">?bdt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ls</span><span class="main">.</span> <span class="skolem">ls</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> len_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">ls</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> len_i i L <span class="keyword1"><span class="command">have</span></span> Q'<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Q
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_dfs_bij<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> BT len_i i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="skolem">bt</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> BT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subset_memb <span class="skolem">q</span> <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_memb_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Q' Q <span class="keyword1"><span class="command">have</span></span> TR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_eq_rtrancl<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="main">(</span>subset_succs <span class="free">A</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> TR <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>subset_succs <span class="free">A</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> succs_is_node<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> P <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Q 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subset_memb <span class="skolem">p</span> <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_eq_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> BT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="skolem">bt</span> <span class="skolem">p</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_memb_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> BT <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="skolem">bt</span> <span class="skolem">p</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> 4 Q j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> j BT 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> bdd_lookup <span class="skolem">bt</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>subset_succs <span class="free">A</span> <span class="skolem">q</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> bdd_lookup <span class="skolem">bt</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> bdd_lookup <span class="skolem">bt</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">ls</span><span class="main">)</span> <span class="main">(</span>add_leaves <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff subset_succs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> bdd_lookup <span class="skolem">bt</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">ls</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_leaves_bdd_all_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> length <span class="skolem">ls</span><span class="main">)</span> <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="skolem">bt</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main"><span class="main">(</span></span><span class="quoted"><span class="quoted">"subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">ls</span><span class="main">.</span> bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> length <span class="skolem">ls</span><span class="main">)</span> <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="skolem">bt</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> length <span class="skolem">ls</span><span class="main">)</span> <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="skolem">bt</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> length <span class="skolem">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="skolem">bt</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> well_formed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_start nfa_startnode_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> well_formed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij nfa_startnode_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A B D BT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def det_nfa_def dfa_is_node_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_reach_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">bss</span><span class="main">.</span> nfa_reach <span class="free">A</span> <span class="free">i</span> <span class="bound">bss</span> <span class="free">j</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="bound">bss</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bss</span><span class="main">.</span> nfa_reach <span class="free">A</span> <span class="free">i</span> <span class="bound">bss</span> <span class="free">j</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="bound">bss</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bss</span></span> <span class="keyword2"><span class="keyword">where</span></span> BS<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">i</span> <span class="skolem">bss</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> BS <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">j</span> <span class="skolem">bss</span> <span class="skolem">bs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms well_formed <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_is_node<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> snoc well_formed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def bddh_subsetbdd nfa_emptybdd_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> snoc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">∈</span> set <span class="main">(</span>add_leaves <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_leaves_bdd_lookup<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">,</span> bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  succsr_def subset_succs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ij <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bss</span><span class="main">.</span> nfa_reach <span class="free">A</span> <span class="free">i</span> <span class="bound">bss</span> <span class="free">j</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="bound">bss</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">from</span></span> reach_nil<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nfa_trans <span class="free">A</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bss</span></span> <span class="keyword2"><span class="keyword">where</span></span> BS<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">i</span> <span class="skolem">bss</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assms well_formed BS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed BS <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def bddh_subsetbdd nfa_emptybdd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="main">(</span>add_leaves <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def subset_succs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> <span class="skolem">z</span> <span class="main">=</span> bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">bs</span> <span class="main">∧</span> is_alph <span class="free">n</span> <span class="bound">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_leaves_bdd_lookup<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"is_alph <span class="free">n</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> BS<span class="main">(</span>1<span class="main">)</span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>nfa_trans <span class="free">A</span> <span class="skolem">y</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> BS L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> BS<span class="main">(</span>2<span class="main">)</span> L
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_reach_subset_memb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">q0</span> <span class="free">bss</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Q0<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subset_memb <span class="free">q</span> <span class="main">(</span>subset_dfs <span class="free">A</span> <span class="free">q0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms well_formed <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> R X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> nfa_reach <span class="free">A</span> <span class="free">q0</span> <span class="bound">bs</span> <span class="free">q</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="bound">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Q0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q0</span><span class="main">,</span><span class="free">q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Q0 Q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_eq_rtrancl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_nfa_reach'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option bdd"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">bd</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subset_dfs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="bound">bs</span> <span class="free">q1</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="bound">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">=</span> <span class="free">ls</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q2</span> <span class="main">=</span> <span class="free">ls</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">q1</span> <span class="free">bss</span> <span class="free">q2</span> <span class="main">=</span> <span class="main">(</span>dfa_reach <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="free">i</span> <span class="free">bss</span> <span class="free">j</span> <span class="main">∧</span> nfa_is_node <span class="free">A</span> <span class="free">q2</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span>dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="free">bss</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">q1</span> <span class="free">bss</span> <span class="free">q2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="free">bss</span> <span class="free">j</span> <span class="main">∧</span> nfa_is_node <span class="free">A</span> <span class="free">q2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed <span class="keyword1"><span class="command">have</span></span> Q0<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_startnode_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Nil <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="skolem">bs</span> <span class="free">q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed Q0 Nil <span class="keyword1"><span class="command">have</span></span> Q1<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Q0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="main">(</span><span class="var">?subset_dfs</span><span class="main">)</span><span class="main">)</span> <span class="free">q1</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span><span class="var">?subset_dfs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span><span class="var">?subset_dfs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">q1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Nil<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="free">q1</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span> <span class="main">&lt;</span> length <span class="free">ls</span> <span class="main">∧</span> <span class="free">ls</span> <span class="main">!</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">q1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Nil 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="free">bd</span> <span class="free">q1</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Nil 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="free">bd</span> <span class="free">q1</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="main">[]</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">=</span><span class="skolem">j</span>›</span></span> Q1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">p</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> S_len <span class="main">=</span> nfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> well_formed<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> BSS'<span class="main">:</span><span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="skolem">bss'</span> <span class="free">q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BSS'L<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bss'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed S_len <span class="keyword1"><span class="command">have</span></span> Q_len<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed snoc <span class="keyword1"><span class="command">have</span></span> P_len<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> BSS' snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bss'</span> <span class="main">@</span> <span class="skolem">bss</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_trans<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> S_len <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> snoc BSS'L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bss'</span> <span class="main">@</span> <span class="skolem">bss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subset_memb <span class="skolem">p</span> <span class="var">?subset_dfs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nfa_reach_subset_memb<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?subset_dfs</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_memb_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?subset_dfs</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?subset_dfs</span><span class="main">)</span> <span class="skolem">p</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> P_len S_len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span><span class="var">?subset_dfs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> snd <span class="var">?subset_dfs</span> <span class="main">!</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="free">ls</span> <span class="main">∧</span> <span class="free">ls</span> <span class="main">!</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> snoc P_len <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="skolem">bss</span> <span class="skolem">v</span> <span class="main">∧</span> nfa_is_node <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> BS<span class="main">:</span> <span class="quoted"><span class="quoted">"is_alph <span class="free">n</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed P_len <span class="keyword1"><span class="command">have</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span>nfa_trans <span class="free">A</span> <span class="skolem">p</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_is_node<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="var">?subset_dfs</span><span class="main">)</span> <span class="main">∧</span> snd <span class="var">?subset_dfs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> N S_len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?subset_dfs</span><span class="main">)</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="free">bd</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> BD<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ls</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_nfa_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> V <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?M</span> <span class="main">!</span> <span class="skolem">v</span> <span class="main">=</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed BS P_len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_map_bdd_lookup bddh_subsetbdd wf_nfa_def is_alph_def nfa_emptybdd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> snoc J <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> JJ<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">from</span></span> R BS JJ <span class="keyword1"><span class="command">have</span></span> RR<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_snoc dfa_trans_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Z <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="free">bss</span> <span class="free">j</span> <span class="main">∧</span> nfa_is_node <span class="free">A</span> <span class="free">q2</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="free">bss</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">q1</span> <span class="free">bss</span> <span class="free">q2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">j</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">q2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> bdd_lookup <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qq</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">=</span> nfa_trans <span class="free">A</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_formed <span class="keyword1"><span class="command">have</span></span> Q0<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_startnode_is_node<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="var">?M</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_nfa_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="var">?M</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹dfa_reach <span class="var">?M</span> <span class="free">i</span> <span class="skolem">bss</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="var">?M</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_wf_nfa<span class="main">)</span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="var">?M</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_reach_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> L <span class="keyword1"><span class="command">have</span></span> J_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Q0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>snd <span class="var">?subset_dfs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_dfs_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc J_len <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> snoc<span class="main">(</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span><span class="main">!</span><span class="skolem">j</span>"</span></span><span class="main">]</span> snoc<span class="main">(</span>8<span class="main">)</span> J_len
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">q1</span> <span class="skolem">bss</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> snoc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="skolem">bs'</span> <span class="free">q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BS'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="skolem">bs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword1"><span class="command">have</span></span> lsj<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">bs'</span> <span class="main">@</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="skolem">qq</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qq_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> well_formed snoc<span class="main">(</span>10<span class="main">)</span> Q0 BS' <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"subset_memb <span class="skolem">qq</span> <span class="var">?subset_dfs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> QQ_len<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">qq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_subset_memb nfa_reach_is_node<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> snoc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> QQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="free">bd</span> <span class="skolem">qq</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_memb_def<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> well_formed snoc J <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bddh_subsetbdd wf_nfa_def nfa_emptybdd_def is_alph_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> v_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> bdd_lookup <span class="main">(</span>fst <span class="var">?M</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> bdd_lookup <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="bound">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_nfa_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> J_len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> bdd_lookup <span class="main">(</span>bdd_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="main">(</span><span class="free">ls</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_map_bdd_lookup<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> qq_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> the <span class="main">(</span>bdd_lookup <span class="free">bd</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> QQ <span class="keyword1"><span class="command">have</span></span> QQ'<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="free">bd</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="free">bd</span> <span class="skolem">qq</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    
    <span class="keyword1"><span class="command">with</span></span> snoc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?subset_dfs</span><span class="main">)</span> <span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> QQ_len Q0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="var">?subset_dfs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="var">?subset_dfs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">qq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc v_def <span class="keyword1"><span class="command">have</span></span> Q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">=</span> <span class="skolem">q2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_trans_def<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> R qq_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="free">q1</span> <span class="main">(</span><span class="skolem">bss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="skolem">q2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_nil<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_nfa_reach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option bdd"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ls</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">bd</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subset_dfs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> Q1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">=</span> <span class="free">ls</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="free">bss</span> <span class="free">q1</span> <span class="main">=</span> dfa_reach <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> SL <span class="main">=</span> nfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> well_formed<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="bound">b</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> SL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="var">?subset_dfs</span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_start<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> SL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="var">?subset_dfs</span><span class="main">)</span> <span class="main">∧</span> snd <span class="var">?subset_dfs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> nfa_startnode <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> S <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ls</span> <span class="main">∧</span> <span class="free">ls</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> nfa_startnode <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> S 1 Q1 J 2 X <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="free">bss</span> <span class="free">q1</span> <span class="main">=</span> <span class="main">(</span>dfa_reach <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="free">bss</span> <span class="free">j</span> <span class="main">∧</span> nfa_is_node <span class="free">A</span> <span class="free">q1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> det_nfa_reach'<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> SL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>nfa_is_node <span class="free">A</span><span class="main">)</span> <span class="main">(</span>snd <span class="var">?subset_dfs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Q1 J S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="free">q1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> T <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_nfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> nfa_accepts <span class="free">A</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> SL <span class="main">=</span> nfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> well_formed<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nfa_startnode <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subset_dfs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subset_dfs <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bd</span> <span class="main">=</span> fst <span class="var">?subset_dfs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> snd <span class="var">?subset_dfs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> bd_def <span class="keyword1"><span class="command">have</span></span> BD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?subset_dfs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bd</span><span class="main">,</span><span class="skolem">ls</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> nfa_steps <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> well_formed X SL <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_steps_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> p_def <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_reach <span class="free">A</span> <span class="var">?q</span> <span class="free">w</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> nfa_reach <span class="free">A</span> <span class="var">?q</span> <span class="bound">bs</span> <span class="skolem">p</span> <span class="main">∧</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="bound">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> SL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>subset_succs <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_reach_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> SL P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subset_memb <span class="skolem">p</span> <span class="var">?subset_dfs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_eq_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> BD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="skolem">bd</span> <span class="skolem">p</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_memb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="skolem">bd</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="skolem">bd</span> <span class="skolem">p</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> SL P <span class="keyword1"><span class="command">have</span></span> K_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">ls</span> <span class="main">∧</span> <span class="skolem">ls</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bd_def ls_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_dfs_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> BD X R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> det_nfa_reach<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> dfa_steps <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> snd <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def dfa_accepting_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ls_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>nfa_accepting <span class="free">A</span><span class="main">)</span> <span class="skolem">ls</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_nfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> K_len p_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nfa_accepts <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> nfa_accepts <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_wf_nfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A
  <span class="keyword1"><span class="command">interpret</span></span> subset_DFS <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_wf_nfa<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_nfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>det_nfa <span class="free">A</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> nfa_accepts <span class="free">A</span> <span class="free">bss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A
  <span class="keyword1"><span class="command">interpret</span></span> subset_DFS <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">from</span></span> w <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_nfa_accepts<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quantifiers›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">quantify_bdd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool list bdd <span class="main">⇒</span> bool list bdd"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quantify_bdd</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> Leaf <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">quantify_bdd</span> <span class="main">0</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bdd_binop bv_or <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">quantify_bdd</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Branch <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Branch <span class="main">(</span><span class="free">quantify_bdd</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">quantify_bdd</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_quantify_bdd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">bdd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="free">bdd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">bdd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quantify_bdd.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bddh_binop <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> quantify_bdd_is_node<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span> <span class="free">bdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span> <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="free">bdd</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">bdd</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quantify_bdd.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_binop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span>"</span></span> <span class="quoted">bv_or</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ bv_or_is_node<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">quantify_nfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nfa <span class="main">⇒</span> nfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quantify_nfa</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bdds</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>quantify_bdd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="bound">bdds</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> quantify_nfa_well_formed_aut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">N</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bddh <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 assms <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bddh <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quantify_nfa_def bddh_quantify_bdd list_all_iff split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quantify_bdd_is_node list_all_iff split_beta quantify_nfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>bdd_all <span class="main">(</span>nfa_is_node <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quantify_nfa_def split_beta nfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def quantify_nfa_def split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insertl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insertl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insertl</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insertl</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">insertl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insertl_len<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>insertl <span class="free">n</span> <span class="free">x</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">vs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insertl.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insertl_0_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"insertl <span class="main">0</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_lookup_quantify_bdd_set_of_bv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">bdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span> <span class="free">bdd</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="free">bdd</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="free">bdd</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">bdd</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> quantify_bdd.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_all_bdd_lookup<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>quantify_bdd <span class="main">0</span> <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>bdd_binop bv_or <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_of_bv <span class="main">(</span>bv_or <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdd_lookup_binop<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="skolem">l</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∪</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="skolem">r</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bv_or_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>insertl <span class="main">0</span> False <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>insertl <span class="main">0</span> True <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>insertl <span class="main">0</span> <span class="bound">b</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>Branch <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>insertl <span class="main">0</span> <span class="bound">b</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">k</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 3 J <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subsetbdd_set_of_bv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">N</span> <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="var">?q</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span> <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def bdd_all_is_node_subsetbdd<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def bdd_all_bdd_lookup bddh_subsetbdd nfa_emptybdd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?q</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def list_all_iff bdd_all_bdd_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">q</span> <span class="main">⟹</span> nfa_is_node <span class="free">N</span> <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> L assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_of_bv <span class="var">?q</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span><span class="main">.</span> bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_bv_def bdd_lookup_subsetbdd<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfa_is_node_def set_of_bv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_of_bv <span class="var">?q</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_trans_quantify_nfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">N</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_alph <span class="free">n</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>nfa_trans <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_trans <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> V1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quantify_nfa_well_formed_aut<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> V2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>length <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quantify_nfa_def wf_nfa_def split_beta nfa_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def set_of_bv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bddh <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def list_all_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span> <span class="main">⟹</span> length <span class="free">w</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> bddh <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> bdd_all <span class="main">(</span>nfa_is_node <span class="free">N</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> V3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> wf_nfa <span class="free">N</span> <span class="main">(</span>length <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nfa_def is_alph_def insertl_len<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> N V2  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetbdd_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span>  set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> quantify_nfa_def split_beta nfa_is_node_def set_of_bv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bdd_lookup_quantify_bdd_set_of_bv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">N</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>quantify_bdd <span class="free">v</span> <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> set_of_bv <span class="free">q</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="free">q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> V3 assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetbdd_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insertll</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insertll</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insertll</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bss</span></span></span><span class="main">)</span> <span class="main">=</span> insertl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">#</span> <span class="free">insertll</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bss</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insertll_len2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertll <span class="free">k</span> <span class="free">x</span> <span class="free">vs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insertll.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insertl_len is_alph_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insertll_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insertll <span class="free">k</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insertll <span class="free">k</span> <span class="free">xs</span> <span class="free">vs</span> <span class="main">@</span> <span class="main">[</span>insertl <span class="free">k</span> <span class="free">x</span> <span class="free">v</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insertll.induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> UN_UN_lenset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">M</span> <span class="bound">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">M</span> <span class="main">(</span>last <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="bound">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">xa</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="skolem">b</span> <span class="skolem">xa</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">xa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xa</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>last <span class="main">(</span><span class="skolem">xa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span><span class="skolem">xa</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xa</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>last <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="bound">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">bs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>last <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>butlast <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>last <span class="skolem">bs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">xa</span><span class="main">.</span> length <span class="bound">xa</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="bound">b</span> <span class="bound">xa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_steps_quantify_nfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">N</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> length <span class="free">w</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">xs</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quantify_nfa_well_formed_aut<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def quantify_nfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> snoc
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_steps_is_node<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="var">?q</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_is_node_def quantify_nfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> length <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertl_len is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> wf_nfa <span class="free">N</span> <span class="main">(</span>length <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> length <span class="skolem">xs</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="skolem">bs</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insertll_len2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">N</span> <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="skolem">bs</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_steps_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> N2 <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_of_bv <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="var">?q</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_of_bv <span class="main">(</span>nfa_trans <span class="main">(</span>quantify_nfa <span class="free">v</span> <span class="free">N</span><span class="main">)</span> <span class="var">?q</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> snoc N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_trans <span class="free">N</span> <span class="var">?q</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_quantify_nfa<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>subsetbdd <span class="main">(</span>fst <span class="free">N</span><span class="main">)</span> <span class="var">?q</span> <span class="main">(</span>nfa_emptybdd <span class="main">(</span>length <span class="var">?q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_trans_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> N B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="var">?q</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetbdd_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IV <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> length <span class="skolem">xs</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">x</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> length <span class="skolem">xs</span><span class="main">}</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">y</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span>set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="main">(</span>butlast <span class="bound">bs</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> set_of_bv <span class="main">(</span>bdd_lookup <span class="main">(</span>fst <span class="free">N</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="main">(</span>last <span class="bound">bs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UN_UN_lenset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> N2 B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_trans <span class="free">N</span> <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="main">(</span>butlast <span class="bound">bs</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">v</span> <span class="main">(</span>last <span class="bound">bs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetbdd_set_of_bv<span class="main"><span class="main">[</span></span><span class="operator">folded</span> nfa_trans_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="main">(</span>butlast <span class="bound">bs</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>insertl <span class="free">v</span> <span class="main">(</span>last <span class="bound">bs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="main">(</span>butlast <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span>last <span class="bound">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insertll_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">bs</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xa</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="main">(</span>butlast <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span>last <span class="bound">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">bs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">xa</span> <span class="main">∈</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="main">(</span>butlast <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span>last <span class="bound">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">bs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">xa</span> <span class="main">∈</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">bs</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xa</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">bs</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xa</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="main">(</span>butlast <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span>last <span class="bound">bs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="skolem">xa</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">N</span> <span class="free">q</span> <span class="main">(</span>insertll <span class="free">v</span> <span class="bound">bs</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_accepts_quantify_nfa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_nfa <span class="free">A</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfa_accepts <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> nfa_accepts <span class="free">A</span> <span class="main">(</span>insertll <span class="free">i</span> <span class="bound">bs</span> <span class="free">bss</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="free">bss</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> Q0 <span class="main">=</span> nfa_startnode_is_node<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nfa_is_node <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_startnode_def quantify_nfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"set_of_bv <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="free">bss</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertll <span class="free">i</span> <span class="bound">bs</span> <span class="free">bss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_steps_quantify_nfa<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_accepts <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> nfa_accepting <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>set_of_bv <span class="main">(</span>snd <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set_of_bv <span class="main">(</span>nfa_steps <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_accepting_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>set_of_bv <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="free">bss</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertll <span class="free">i</span> <span class="bound">bs</span> <span class="free">bss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quantify_nfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">bs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="free">bss</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">∩</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="main">(</span>quantify_nfa <span class="free">i</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insertll <span class="free">i</span> <span class="bound">bs</span> <span class="free">bss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">bs</span><span class="main">.</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="free">bss</span><span class="main">}</span><span class="main">.</span> set_of_bv <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">∩</span> set_of_bv <span class="main">(</span>nfa_steps <span class="free">A</span> <span class="main">(</span>nfa_startnode <span class="free">A</span><span class="main">)</span> <span class="main">(</span>insertll <span class="free">i</span> <span class="bound">bs</span> <span class="free">bss</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfa_startnode_def quantify_nfa_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> nfa_accepts <span class="free">A</span> <span class="main">(</span>insertll <span class="free">i</span> <span class="bound">bs</span> <span class="free">bss</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="free">bss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> accepts_def nfa_accepting_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Right Quotient›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rquot_succs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat bdd list <span class="main">×</span> bool list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquot_succs</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[</span>bdd_lookup <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>replicate <span class="bound">n</span> False<span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rquot_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat bdd list <span class="main">×</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquot_invariant</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquot_ins</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">[</span><span class="bound">x</span><span class="main">:=</span>True<span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rquot_memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquot_memb</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rquot_empt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat bdd list <span class="main">×</span> bool list <span class="main">⇒</span> bool list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquot_empt</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rquot_dfs</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> gen_dfs <span class="main">(</span>rquot_succs <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> rquot_ins rquot_memb <span class="main">(</span>rquot_empt <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">zeros</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zeros</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> replicate <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zeros_is_alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">v</span><span class="main">)</span> <span class="main">(</span>zeros <span class="free">n</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros_def is_alph_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zeros_rone<span class="main">:</span> <span class="quoted"><span class="quoted">"zeros <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> zeros <span class="free">n</span> <span class="free">v</span> <span class="main">@</span> zeros <span class="main">1</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros_def replicate_append_same<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zeros_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>zeros <span class="free">n</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zeros_rtrancl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="bound">n</span> <span class="free">v</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>rquot_succs <span class="free">M</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="bound">n</span> <span class="free">v</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="skolem">n</span> <span class="free">v</span><span class="main">)</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> zeros <span class="skolem">n</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">=</span> zeros <span class="bound">n</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> w_def N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="skolem">w</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this W <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>rquot_succs <span class="free">M</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">k</span> <span class="skolem">ws</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> N'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> zeros <span class="skolem">n'</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">ws</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> N' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros_len<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> NL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zeros <span class="skolem">n'</span> <span class="free">v</span> <span class="main">=</span> zeros <span class="skolem">n</span> <span class="free">v</span> <span class="main">@</span> zeros <span class="main">1</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zeros_rone<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> zeros <span class="skolem">n</span> <span class="free">v</span> <span class="main">@</span> <span class="main">[</span>replicate <span class="free">v</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"zeros <span class="skolem">n'</span> <span class="free">v</span> <span class="main">=</span> zeros <span class="skolem">n</span> <span class="free">v</span> <span class="main">@</span> <span class="main">[</span>replicate <span class="free">v</span> False<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> N' <span class="keyword1"><span class="command">have</span></span> WS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> zeros <span class="skolem">n</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> replicate <span class="free">v</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">ws</span> <span class="main">=</span> zeros <span class="bound">n</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> IV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>rquot_succs <span class="free">M</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> WS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_trans <span class="free">M</span> <span class="skolem">k</span> <span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>rquot_succs <span class="free">M</span> <span class="free">v</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_succs_def dfa_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> dfa_trans <span class="free">M</span> <span class="skolem">k</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>rquot_succs <span class="free">M</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> succsr_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IV <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>rquot_succs <span class="free">M</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="bound">n</span> <span class="free">v</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="main">0</span> <span class="free">v</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_nil zeros_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="bound">n</span> <span class="free">v</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="skolem">n</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> dfa_trans <span class="free">M</span> <span class="skolem">y</span> <span class="main">(</span>replicate <span class="free">v</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def rquot_succs_def dfa_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> N Z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="skolem">n</span> <span class="free">v</span> <span class="main">@</span> zeros <span class="main">1</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_snoc zeros_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_reach <span class="free">M</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zeros_rone<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">map_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_index</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_index</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free">map_index</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_index_len<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>map_index <span class="free">f</span> <span class="free">ls</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ls</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_index_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_index <span class="free">f</span> <span class="free">l</span> <span class="free">n</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rquot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dfa <span class="main">⇒</span> nat <span class="main">⇒</span> dfa"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rquot</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">bd</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">bd</span><span class="main">,</span> map_index <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> nfa_accepting' <span class="bound">as</span> <span class="main">(</span>rquot_dfs <span class="main">(</span><span class="bound">bd</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="bound">v</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">as</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rquot_well_formed_aut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">M</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>rquot <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_def split_beta wf_dfa_def map_index_len dfa_is_node_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rquot_node<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>rquot <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> dfa_is_node <span class="free">M</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_def dfa_is_node_def split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rquot_steps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dfa_steps <span class="main">(</span>rquot <span class="free">M</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="free">w</span> <span class="main">=</span> dfa_steps <span class="free">M</span> <span class="free">x</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_def dfa_trans_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> rquot_DFS <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted">dfa</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_formed<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rquot_DFS <span class="main">&lt;</span> DFS <span class="quoted"><span class="quoted">"rquot_succs <span class="free">A</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span>"</span></span>
  <span class="quoted"><span class="quoted">"rquot_invariant <span class="free">A</span>"</span></span> <span class="quoted">rquot_ins</span> <span class="quoted">rquot_memb</span> <span class="quoted"><span class="quoted">"rquot_empt <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> well_formed<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rquot_invariant <span class="free">A</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rquot_memb <span class="skolem">y</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rquot_memb <span class="skolem">x</span> <span class="main">(</span>rquot_ins <span class="skolem">y</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> rquot_memb <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def rquot_invariant_def rquot_memb_def rquot_ins_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_is_node_def rquot_memb_def rquot_empt_def
     rquot_succs_def rquot_invariant_def rquot_ins_def
     bounded_nat_set_is_finite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
     dfa_trans_is_node<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> dfa_trans_def dfa_is_node_def is_alph_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">context</span></span> rquot_DFS
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rquot_dfs_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rquot_invariant <span class="free">A</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms well_formed <span class="keyword1"><span class="command">unfolding</span></span> rquot_dfs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dfs_invariant' empt_invariant<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dfa_reach_rquot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rquot_memb <span class="free">y</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_reach <span class="free">A</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rquot_memb <span class="free">y</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>rquot_succs <span class="free">A</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_eq_rtrancl rquot_dfs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_reach <span class="free">A</span> <span class="free">x</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rquot_accepting<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepting <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_accepting <span class="free">A</span> <span class="main">(</span>dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rquot_invariant <span class="free">A</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_dfs_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_invariant_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_accepting' <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set_of_bv <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">∩</span> set_of_bv <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfa_accepting'_set_of_bv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> snd <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_bv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> well_formed L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> dfa_is_node <span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> snd <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> rquot_memb <span class="bound">i</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_dfa_def dfa_is_node_def rquot_memb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> dfa_is_node <span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> snd <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> rquot_memb <span class="bound">i</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> dfa_is_node <span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> snd <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_reach <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dfa_reach_rquot<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_is_node <span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> snd <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">m</span><span class="main">.</span> dfa_is_node <span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> snd <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> snd <span class="free">A</span> <span class="main">!</span> dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> snd <span class="free">A</span> <span class="main">!</span> dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="free">A</span> <span class="main">!</span> dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="skolem">m</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_formed Q zeros_is_alpha<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="free">A</span> <span class="main">(</span>dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="skolem">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_steps_is_node<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> N <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">m</span><span class="main">.</span> dfa_is_node <span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> snd <span class="free">A</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfa_accepting' <span class="main">(</span>snd <span class="free">A</span><span class="main">)</span> <span class="main">(</span>rquot_dfs <span class="free">A</span> <span class="free">n</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> snd <span class="free">A</span> <span class="main">!</span> dfa_steps <span class="free">A</span> <span class="free">q</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> well_formed assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_accepting_def rquot_def split_beta dfa_is_node_def map_index_nth wf_dfa_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rquot_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="free">A</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_accepts <span class="free">A</span> <span class="main">(</span><span class="free">bss</span> <span class="main">@</span> zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A
  <span class="keyword1"><span class="command">interpret</span></span> rquot_DFS <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_well_formed_aut<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_startnode_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms V <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"dfa_is_node <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>dfa_steps <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="main">0</span> <span class="free">bss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_steps_is_node<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> dfa_accepting <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>dfa_steps <span class="main">(</span>rquot <span class="free">A</span> <span class="free">n</span><span class="main">)</span> <span class="main">0</span> <span class="free">bss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_accepting <span class="free">A</span> <span class="main">(</span>dfa_steps <span class="free">A</span> <span class="main">(</span>dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="free">bss</span><span class="main">)</span> <span class="main">(</span>zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_accepting rquot_steps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_accepting <span class="free">A</span> <span class="main">(</span>dfa_steps <span class="free">A</span> <span class="main">0</span> <span class="main">(</span><span class="free">bss</span> <span class="main">@</span> zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> dfa_accepts <span class="free">A</span> <span class="main">(</span><span class="free">bss</span> <span class="main">@</span> zeros <span class="bound">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diophantine Equations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_dioph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list <span class="main">⇒</span> nat list <span class="main">⇒</span> int"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_dioph</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> int <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free">eval_dioph</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_dioph</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_dioph_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="main">*</span> int <span class="free">n</span> <span class="main">=</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_dioph.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_dioph_add_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
   eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">::</span>nat list<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_dioph.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> eval_dioph <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="free">g</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> distrib_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_dioph_div_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> int <span class="free">n</span> <span class="main">+</span>
   eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval_dioph <span class="free">ks</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_dioph_mult o_def eval_dioph_add_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_dioph_mod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="keyword1">mod</span> int <span class="free">n</span> <span class="main">=</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_dioph.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> int <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span> <span class="main">+</span> eval_dioph <span class="skolem">ks</span> <span class="skolem">xs</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_add_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span>int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span> <span class="main">+</span>
    eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 mod_mult_right_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmod_int mod_add_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_dioph_div_mod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">∧</span>
    eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> eval_dioph_mod <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> eval_dioph_div_mult <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> eq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_diff_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> eq' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r1</span> <span class="main">∧</span> <span class="var">?r2</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> eq1<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?r1</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> eq1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">l</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">l</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mod_diff_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_diff_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eq2 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span>
     <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span>
     <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span>
     <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span>
     <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span>
     <span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> eq1' eval_dioph_div_mult <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_diff_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_dioph_ineq_div_mod<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="main">≤</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span>
      <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword1"><span class="command">with</span></span> eval_dioph_div_mult <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_diff_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≤</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zdiv_mono1<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="main">≤</span> eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="main">+</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">≤</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_diff_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span>
    eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> eval_dioph_div_mult <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="free">xs</span> <span class="main">+</span>
    <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_abs_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> sum_list <span class="main">(</span>map abs <span class="free">ks</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> zmult_div_aux1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="keyword1">div</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> minus_mod_eq_mult_div <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zmult_div_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> b minus_mod_eq_mult_div <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> div_abs_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="keyword1">mod</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="free">a</span><span class="main">¦</span> <span class="keyword1">div</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> pos_imp_zdiv_nonneg_iff <span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span><span class="main">¦</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_neg_pos_less0 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> b<span class="main"><span class="main">]</span></span> zabs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> abs_of_neg <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span><span class="main">]</span> zdiv_zminus1_eq_if <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> mod
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_div_trivial<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">::</span>int<span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_add1_eq div_pos_pos_trivial<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_rhs_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">≤</span> max <span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">=</span>
    <span class="main">¦</span><span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span>
     <span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">¦</span><span class="main">(</span><span class="main">_</span> <span class="main">-</span> <span class="var">?r</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmult_div_aux1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">¦</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="var">?r</span><span class="main">¦</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmult_div_aux2 div_abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="var">?r</span><span class="main">¦</span> <span class="main">≤</span>
    <span class="main">¦</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="var">?r</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_triangle_ineq4<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span>
    <span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_triangle_ineq4<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_dioph.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span>
      <span class="main">¦</span><span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span>eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_triangle_ineq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="skolem">k</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span>int <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>int <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">k</span> <span class="main">*</span> int <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span>
      <span class="main">¦</span><span class="skolem">k</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span>eval_dioph <span class="skolem">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_list_abs_ge_0<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="free">l</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">≤</span>
    <span class="main">(</span><span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> <span class="main">¦</span><span class="var">?r</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdiv_mono1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">l</span><span class="main">¦</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">note</span></span> ineq
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> <span class="main">¦</span><span class="var">?r</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">¦</span><span class="var">?r</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdiv_mono1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">¦</span><span class="free">l</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_div_trivial<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> ineq
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> <span class="main">¦</span><span class="var">?r</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">¦</span><span class="var">?r</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdiv_mono1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_div_trivial<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_rhs_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">m</span><span class="main">¦</span> <span class="main">≤</span> max <span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="free">m</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">≤</span> max <span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">l</span><span class="main">¦</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="free">m</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">≤</span> max <span class="main">¦</span><span class="free">m</span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dioph_rhs_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">m</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">l</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="free">m</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">≤</span> max <span class="main">¦</span><span class="free">m</span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dioph_rhs_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">m</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_int_set_is_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">::</span>int<span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">¦</span><span class="bound">i</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>int <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nat_seg_image_imp_finite <span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span> int <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nat_seg_image_imp_finite <span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>int <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span> int <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_UnI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> int <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span> int <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> int <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span> int <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> int <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">-</span> int <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">-</span> int <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> nat <span class="free">j</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mk_nat_vecs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_nat_vecs</span> <span class="main">0</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mk_nat_vecs</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">yss</span> <span class="main">=</span> <span class="free">mk_nat_vecs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
      <span class="keyword1">in</span> map <span class="main">(</span>Cons <span class="main">0</span><span class="main">)</span> <span class="bound">yss</span> <span class="main">@</span> map <span class="main">(</span>Cons <span class="main">1</span><span class="main">)</span> <span class="bound">yss</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_nat_vecs_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_nat_vecs_mod_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> mk_nat_vecs_bound<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_succs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span>
     <span class="keyword1">if</span> eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">xs</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">mod</span> <span class="numeral">2</span>
     <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">-</span> eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">(</span>mk_nat_vecs <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dioph_is_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_is_node</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¦</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">¦</span> <span class="main">≤</span> max <span class="main">¦</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dioph_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list <span class="main">⇒</span> int <span class="main">⇒</span> nat option list <span class="main">×</span> int list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_invariant</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">is</span><span class="main">,</span> <span class="bound">js</span><span class="main">)</span><span class="main">.</span> length <span class="bound">is</span> <span class="main">=</span> nat <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> max <span class="main">¦</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_ins</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">is</span><span class="main">,</span> <span class="bound">js</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">is</span><span class="main">[</span>int_encode <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">:=</span> Some <span class="main">(</span>length <span class="bound">js</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">js</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dioph_memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat option list <span class="main">×</span> int list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_memb</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">is</span><span class="main">,</span> <span class="bound">js</span><span class="main">)</span><span class="main">.</span> <span class="bound">is</span> <span class="main">!</span> int_encode <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dioph_empt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list <span class="main">⇒</span> int <span class="main">⇒</span> nat option list <span class="main">×</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_empt</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>nat <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> max <span class="main">¦</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> None<span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> int_encode_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">m</span> <span class="main">⟹</span>
  int_encode <span class="free">m</span> <span class="main">&lt;</span> nat <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> max <span class="main">¦</span><span class="free">l</span><span class="main">¦</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">¦</span><span class="bound">k</span><span class="main">¦</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def int_encode_def sum_encode_def<span class="main">)</span> <span class="operator">arith</span>

<span class="keyword1"><span class="command">interpretation</span></span> dioph_dfs<span class="main">:</span> DFS <span class="quoted"><span class="quoted">"dioph_succs <span class="free">n</span> <span class="free">ks</span>"</span></span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span>"</span></span>
  <span class="quoted"><span class="quoted">"dioph_invariant <span class="free">ks</span> <span class="free">l</span>"</span></span> <span class="quoted">dioph_ins</span> <span class="quoted">dioph_memb</span> <span class="quoted"><span class="quoted">"dioph_empt <span class="free">ks</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def dioph_ins_def split_beta dioph_invariant_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_encode_bound<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_int_encode<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def dioph_empt_def int_encode_bound<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_succs_def map_filter_def list_all_iff dioph_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subst <span class="main"><span class="main">[</span></span><span class="operator">OF</span> mk_nat_vecs_mod_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> dioph_rhs_invariant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_invariant_def dioph_empt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_invariant_def dioph_ins_def split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bounded_int_set_is_finite <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"max <span class="main"><span class="main">¦</span></span><span class="free"><span class="free">l</span></span><span class="main"><span class="main">¦</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∑</span></span><span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">←</span></span><span class="free"><span class="free">ks</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">¦</span></span><span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">¦</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_dfs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> gen_dfs <span class="main">(</span>dioph_succs <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> dioph_ins dioph_memb <span class="main">(</span>dioph_empt <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">make_bdd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> bdd"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">make_bdd</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> Leaf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">make_bdd</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> Branch <span class="main">(</span><span class="free">make_bdd</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">make_bdd</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_dfa</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">is</span><span class="main">,</span> <span class="bound">js</span><span class="main">)</span> <span class="main">=</span> dioph_dfs <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
     <span class="keyword1">in</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> make_bdd <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span>
          <span class="keyword1">if</span> eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">xs</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">mod</span> <span class="numeral">2</span>
          <span class="keyword1">then</span> the <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="bound">j</span> <span class="main">-</span> eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span> length <span class="bound">js</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="bound">js</span> <span class="main">@</span> <span class="main">[</span>Leaf <span class="main">(</span>length <span class="bound">js</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
        map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="bound">js</span> <span class="main">@</span> <span class="main">[</span>False<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">nat_of_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nat_of_bool</span> <span class="main">≡</span> of_bool"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nat_of_bool_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"nat_of_bool <span class="free">b</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_of_bool_mk_nat_vecs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> map nat_of_bool <span class="free">bs</span> <span class="main">∈</span> set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_lookup_make_bdd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> bdd_lookup <span class="main">(</span>make_bdd <span class="free">f</span> <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> map nat_of_bool <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">bs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nat_of_bools</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nat_of_bools</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nat_of_bools</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> nat_of_bool <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">nat_of_bools</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nats_of_boolss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool list list <span class="main">⇒</span> nat list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nats_of_boolss</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span>"</span></span>
<span class="main">|</span> Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nats_of_boolss</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bss</span></span></span><span class="main">)</span> <span class="main">=</span>
     map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> nat_of_bool <span class="bound">b</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span><span class="free">nats_of_boolss</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">bss</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nats_of_boolss_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">⟹</span> length <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_alph_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nats_of_boolss_mod2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bss<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">#</span> <span class="free">bss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map nat_of_bool <span class="free">bs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bs bss
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map nat_of_bool <span class="main">(</span>map fst <span class="main">(</span>zip <span class="free">bs</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map nat_of_bool <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nats_of_boolss_length<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def o_def nat_of_bool_bound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nats_of_boolss_div2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bss<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="main">(</span><span class="free">bs</span> <span class="main">#</span> <span class="free">bss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nats_of_boolss <span class="free">n</span> <span class="free">bss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bs bss
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def o_def nat_of_bool_bound nats_of_boolss_length<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_insertl<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span>
  zip <span class="main">(</span>insertl <span class="free">n</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>insertl <span class="free">n</span> <span class="free">y</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> insertl <span class="free">n</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insertl.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_length_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_insertl<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>insertl <span class="free">i</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insertl <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insertl.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> insertl_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span>
  insertl <span class="free">m</span> <span class="free">x</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> replicate <span class="free">n</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">m</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nats_of_boolss_insertll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">⟹</span> length <span class="free">bs</span> <span class="main">=</span> length <span class="free">bss</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span>
   nats_of_boolss <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>insertll <span class="free">i</span> <span class="free">bs</span> <span class="free">bss</span><span class="main">)</span> <span class="main">=</span> insertl <span class="free">i</span> <span class="main">(</span>nat_of_bools <span class="free">bs</span><span class="main">)</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">bss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insertll.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_insertl nats_of_boolss_length insertll_len2 is_alph_def
     map_insertl insertl_replicate <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_replicate_map<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> zip <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span>Pair <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> zip_replicate_mapr<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> zip <span class="free">xs</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">xs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> zip_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="main">(</span>zip <span class="free">ys</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ys</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">zs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nats_of_boolss_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">⟹</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss'</span> <span class="main">⟹</span>
     nats_of_boolss <span class="free">n</span> <span class="main">(</span><span class="free">bss</span> <span class="main">@</span> <span class="free">bss'</span><span class="main">)</span> <span class="main">=</span>
     map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> length <span class="free">bss</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bss</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nats_of_boolss_length zip_replicate_map o_def
     map_zip_map map_zip_map2 zip_assoc is_alph_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nats_of_boolss_zeros<span class="main">:</span> <span class="quoted"><span class="quoted">"nats_of_boolss <span class="free">n</span> <span class="main">(</span>zeros <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> nats_of_boolss.Cons <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bools_of_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bools_of_nat</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> False <span class="main">#</span> <span class="free">bools_of_nat</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> <span class="free">bools_of_nat</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bools_of_nat_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="main">(</span>bools_of_nat <span class="free">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bools_of_nat.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bools_of_nat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bools_of_nat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nat_of_bool_mod_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"nat_of_bool <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bools_of_nat_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"nat_of_bools <span class="main">(</span>bools_of_nat <span class="free">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bools_of_nat.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> bools_of_nat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_of_bool_mod_eq <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bools_of_nat.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> bools_of_nat.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_dioph_replicate_0<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ks</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_dfs_bij<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span> <span class="main">∧</span> dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dfs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gen_dfs <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span> dioph_ins dioph_memb <span class="main">(</span>dioph_empt <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>dioph_is_node <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dioph_dfs.empt_invariant <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?dfs</span> <span class="main">!</span> int_encode <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span> <span class="main">∧</span> dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="var">?dfs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="var">?dfs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dioph_dfs.dfs_invariant<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_empt_def dioph_is_node_def int_encode_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ins_def dioph_memb_def dioph_is_node_def split_beta dioph_invariant_def
          int_encode_bound nth_append inj_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_int_encode<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_dfs_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_invariant <span class="free">ks</span> <span class="free">l</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>dioph_is_node <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>gen_dfs <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span> dioph_ins dioph_memb <span class="free">z</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> z xs H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_dfs.dfs_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ins_def dioph_memb_def split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> int_encode <span class="improper">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_dfs_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="free">l</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs_def gen_dfs_simps dioph_dfs.empt dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_dfs_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_dfs.ins_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_dfs.empt_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs.empt dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs.succs_is_node dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ins_def dioph_empt_def int_encode_bound dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_dfa_error<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> dfa_accepting <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>dfa_steps <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bss</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_dfa_def split_beta dfa_accepting_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_dfa_def split_beta nth_append dfa_trans_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_dfa_accepting<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">⟹</span>
  dfa_accepting <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>dfa_steps <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dioph_dfs.succsr_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> l Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="skolem">m</span> <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs.dfs_eq_rtrancl dioph_dfs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_dioph_replicate_0 dfa_accepting_def eq_dfa_def split_beta nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">bs</span> <span class="skolem">bss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dioph_dfs.succsr_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> l Cons
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="skolem">m</span> <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs.dfs_eq_rtrancl dioph_dfs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> m <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="main">(</span>map nat_of_bool <span class="skolem">bs</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">m</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> k' Cons
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span>
      the <span class="main">(</span>fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map nat_of_bool <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_dfa_def split_beta nth_append bdd_lookup_make_bdd is_alph_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map nat_of_bool <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_succs_def succsr_def map_filter_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"map nat_of_bool <span class="skolem"><span class="skolem">bs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Cons
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True nat_of_bool_mk_nat_vecs is_alph_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True k k' Cons
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_dioph_div_mod<span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nats_of_boolss_div2 nats_of_boolss_mod2 is_alph_def dfa_trans_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> k' Cons
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_dfa_def split_beta nth_append bdd_lookup_make_bdd is_alph_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False k k' Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_dioph_div_mod<span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nats_of_boolss_div2 nats_of_boolss_mod2 is_alph_def
         dfa_trans_def eq_dfa_error<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_dfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bss<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> <span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">rule</span> eq_dfa_accepting <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ks</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ bss<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> dioph_dfs_start<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bddh_make_bdd<span class="main">:</span> <span class="quoted"><span class="quoted">"bddh <span class="free">n</span> <span class="main">(</span>make_bdd <span class="free">f</span> <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bdd_all_make_bdd<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_all <span class="free">P</span> <span class="main">(</span>make_bdd <span class="free">f</span> <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ys</span><span class="main">∈</span>set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_wf_dfa<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>eq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ys</span><span class="main">∈</span>set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span><span class="main">.</span>
    eval_dioph <span class="free">ks</span> <span class="bound">ys</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">⟶</span>
      the <span class="main">(</span>fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="bound">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span>
        Suc <span class="main">(</span>length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys'<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_dioph <span class="free">ks</span> <span class="skolem">ys</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth dioph_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="skolem">x</span> <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs.dfs_eq_rtrancl dioph_dfs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def dioph_succs_def map_filter_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ys ys'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> dioph_dfs.succs_is_node <span class="main">[</span><span class="operator">OF</span> k'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> ys ys'
    <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_succs_def map_filter_def list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs.dfs_eq_rtrancl dioph_dfs_def ll<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span>
      int_encode <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> x' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> k'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fst <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span>
      Suc <span class="main">(</span>length <span class="main">(</span>snd <span class="main">(</span>dioph_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_dfa_def split_beta wf_dfa_def dfa_is_node_def list_all_iff
      bddh_make_bdd bdd_all_make_bdd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diophantine Inequations›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_ineq_succs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">-</span> eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>mk_nat_vecs <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> dioph_ineq_dfs<span class="main">:</span> DFS <span class="quoted"><span class="quoted">"dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span>"</span></span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span>"</span></span>
  <span class="quoted"><span class="quoted">"dioph_invariant <span class="free">ks</span> <span class="free">l</span>"</span></span> <span class="quoted">dioph_ins</span> <span class="quoted">dioph_memb</span> <span class="quoted"><span class="quoted">"dioph_empt <span class="free">ks</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def dioph_ins_def split_beta dioph_invariant_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_encode_bound<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_int_encode<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def dioph_empt_def int_encode_bound<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_succs_def map_filter_def list_all_iff dioph_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subst <span class="main"><span class="main">[</span></span><span class="operator">OF</span> mk_nat_vecs_mod_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> dioph_rhs_invariant<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_invariant_def dioph_empt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_invariant_def dioph_ins_def split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bounded_int_set_is_finite <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"max <span class="main"><span class="main">¦</span></span><span class="free"><span class="free">l</span></span><span class="main"><span class="main">¦</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∑</span></span><span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">←</span></span><span class="free"><span class="free">ks</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">¦</span></span><span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">¦</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dioph_ineq_dfs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> gen_dfs <span class="main">(</span>dioph_ineq_succs <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> dioph_ins dioph_memb <span class="main">(</span>dioph_empt <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ineq_dfa</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">is</span><span class="main">,</span> <span class="bound">js</span><span class="main">)</span> <span class="main">=</span> dioph_ineq_dfs <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
     <span class="keyword1">in</span>
       <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> make_bdd <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span>
          the <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="bound">j</span> <span class="main">-</span> eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">xs</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="bound">js</span><span class="main">,</span>
        map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">js</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_ineq_dfs_bij<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span> <span class="main">∧</span> dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dfs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gen_dfs <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span> dioph_ins dioph_memb <span class="main">(</span>dioph_empt <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>dioph_is_node <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dioph_dfs.empt_invariant <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?dfs</span> <span class="main">!</span> int_encode <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span> <span class="main">∧</span> dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="var">?dfs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="var">?dfs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs.dfs_invariant<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_empt_def dioph_is_node_def int_encode_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">S</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ins_def dioph_memb_def dioph_is_node_def split_beta dioph_invariant_def
          int_encode_bound nth_append inj_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_int_encode<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_ineq_dfs_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_invariant <span class="free">ks</span> <span class="free">l</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>dioph_is_node <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>gen_dfs <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span> dioph_ins dioph_memb <span class="free">z</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> z xs H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_ineq_dfs.dfs_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ins_def dioph_memb_def split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> int_encode <span class="improper">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioph_ineq_dfs_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="free">l</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs_def gen_dfs_simps dioph_ineq_dfs.empt dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_ineq_dfs_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_ineq_dfs.ins_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dioph_ineq_dfs.empt_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs.empt dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs.succs_is_node dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ins_def dioph_empt_def int_encode_bound dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ineq_dfa_accepting<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">⟹</span>
  dfa_accepting <span class="main">(</span>ineq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>dfa_steps <span class="main">(</span>ineq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">bss</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dioph_ineq_dfs.succsr_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> l Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="skolem">m</span> <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs.dfs_eq_rtrancl dioph_ineq_dfs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_dioph_replicate_0 dfa_accepting_def ineq_dfa_def split_beta nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">bs</span> <span class="skolem">bss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dioph_ineq_dfs.succsr_is_node<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> l Cons
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="skolem">m</span> <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs.dfs_eq_rtrancl dioph_ineq_dfs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> m <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_lookup <span class="main">(</span>fst <span class="main">(</span>ineq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span>
    the <span class="main">(</span>fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map nat_of_bool <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ineq_dfa_def split_beta nth_append bdd_lookup_make_bdd is_alph_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="main">(</span>map nat_of_bool <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_succs_def succsr_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"map nat_of_bool <span class="skolem"><span class="skolem">bs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_of_bool_mk_nat_vecs is_alph_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> k Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_dioph_ineq_div_mod<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nats_of_boolss_div2 nats_of_boolss_mod2 is_alph_def dfa_trans_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ineq_dfa_accepts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bss<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dfa_accepts <span class="main">(</span>ineq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> <span class="main">(</span>eval_dioph <span class="free">ks</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span> <span class="main">≤</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accepts_def<span class="main">)</span>
    <span class="main">(</span><span class="operator">rule</span> ineq_dfa_accepting <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ks</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ bss<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> dioph_ineq_dfs_start<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ineq_wf_dfa<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>ineq_dfa <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ys</span><span class="main">∈</span>set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span><span class="main">.</span>
    the <span class="main">(</span>fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="bound">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="bound">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span>
      length <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> set <span class="main">(</span>mk_nat_vecs <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth dioph_ineq_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="skolem">x</span> <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_is_node_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs.dfs_eq_rtrancl dioph_ineq_dfs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>succsr <span class="main">(</span>dioph_ineq_succs <span class="free">n</span> <span class="free">ks</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> succsr_def dioph_ineq_succs_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ys</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ys<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> dioph_ineq_dfs.succs_is_node <span class="main">[</span><span class="operator">OF</span> k'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> ys
    <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_succs_def list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dioph_memb <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs.dfs_eq_rtrancl dioph_ineq_dfs_def ll<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span>
      int_encode <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_memb_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> x' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs_bij <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> k'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> eval_dioph <span class="free">ks</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span>
      length <span class="main">(</span>snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> int_encode <span class="free">l</span> <span class="main">=</span> Some <span class="main">0</span> <span class="main">∧</span> dioph_is_node <span class="free">ks</span> <span class="free">l</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs_start dioph_is_node_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>dioph_ineq_dfs <span class="free">n</span> <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dioph_ineq_dfs_bij<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ineq_dfa_def split_beta wf_dfa_def dfa_is_node_def list_all_iff
      bddh_make_bdd bdd_all_make_bdd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Presburger Arithmetic›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pf <span class="main">=</span>
    Eq <span class="quoted"><span class="quoted">"int list"</span></span> <span class="quoted">int</span>
  <span class="main">|</span> Le <span class="quoted"><span class="quoted">"int list"</span></span> <span class="quoted">int</span>
  <span class="main">|</span> And <span class="quoted">pf</span> <span class="quoted">pf</span>
  <span class="main">|</span> Or <span class="quoted">pf</span> <span class="quoted">pf</span>
  <span class="main">|</span> Imp <span class="quoted">pf</span> <span class="quoted">pf</span>
  <span class="main">|</span> Forall <span class="quoted">pf</span>
  <span class="main">|</span> Exist <span class="quoted">pf</span>
  <span class="main">|</span> Neg <span class="quoted">pf</span>

<span class="keyword1"><span class="command">type_synonym</span></span> passign <span class="main">=</span> <span class="quoted"><span class="quoted">"nat list"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">eval_pf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pf <span class="main">⇒</span> passign <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>Le <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>eval_dioph <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∨</span> <span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟶</span> <span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>Exist <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_pf</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">eval_pf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">dfa_of_pf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> pf <span class="main">⇒</span> dfa"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> eq_dfa <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> Le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Le <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> ineq_dfa <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> And<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> and_dfa <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> or_dfa <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> imp_dfa <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Exist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Exist <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> rquot <span class="main">(</span>det_nfa <span class="main">(</span>quantify_nfa <span class="main">0</span> <span class="main">(</span>nfa_of_dfa <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> Forall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Neg <span class="main">(</span>Exist <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> Neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> negate_dfa <span class="main">(</span><span class="free">dfa_of_pf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary measure function for termination proof›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">count_forall</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pf <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>Le <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>Exist <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_forall</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_forall</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">dfa_of_pf</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">pf</span><span class="main">)</span><span class="main">.</span> count_forall <span class="bound">pf</span><span class="main">,</span> <span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">pf</span><span class="main">)</span><span class="main">.</span> size <span class="bound">pf</span><span class="main">]</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> dfa_of_pf_induct <span class="main">=</span>
  dfa_of_pf.induct <span class="main">[</span><span class="operator">case_names</span> Eq Le And Or Imp Exist Forall Neg<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> dfa_of_pf_well_formed<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>dfa_of_pf <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfa_of_pf_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Le <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ineq_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> or_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Imp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imp_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negate_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exist <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_well_formed_aut det_wf_nfa quantify_nfa_well_formed_aut dfa2wf_nfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfa_of_pf_correctness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">⟹</span>
     dfa_accepts <span class="main">(</span>dfa_of_pf <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> eval_pf <span class="free">p</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfa_of_pf_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_dfa_accepts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Le <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ineq_dfa_accepts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> or_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Imp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imp_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_accepts_negate <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exist <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">bs</span><span class="main">.</span> eval_pf <span class="skolem">p</span> <span class="main">(</span>nat_of_bools <span class="bound">bs</span> <span class="main">#</span> nats_of_boolss <span class="skolem">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="skolem">bss</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> eval_pf <span class="skolem">p</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> nats_of_boolss <span class="skolem">n</span> <span class="skolem">bss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="main">(</span>bools_of_nat <span class="main">(</span>length <span class="skolem">bss</span><span class="main">)</span> <span class="improper">x</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">bss</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"bools_of_nat <span class="main">(</span>length <span class="skolem">bss</span><span class="main">)</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bools_of_nat_inverse bools_of_nat_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> Exist <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
    rquot_accepts det_wf_nfa quantify_nfa_well_formed_aut dfa2wf_nfa
    det_nfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> zeros_is_alpha nfa_accepts_quantify_nfa <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span>
    nfa_of_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span> insertll_len2 nats_of_boolss_insertll
    zeros_len nats_of_boolss_append nats_of_boolss_zeros zip_replicate_mapr
    nats_of_boolss_length o_def insertl_0_eq
    dfa_of_pf_well_formed <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> rev_conj_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The same with minimization after quantification.›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">dfa_of_pf'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> pf <span class="main">⇒</span> dfa"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> eq_dfa <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Le <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> ineq_dfa <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> and_dfa <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> or_dfa <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> imp_dfa <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Exist <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> min_dfa <span class="main">(</span>rquot <span class="main">(</span>det_nfa <span class="main">(</span>quantify_nfa <span class="main">0</span> <span class="main">(</span>nfa_of_dfa <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Neg <span class="main">(</span>Exist <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> negate_dfa <span class="main">(</span><span class="free">dfa_of_pf'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">dfa_of_pf'</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">pf</span><span class="main">)</span><span class="main">.</span> count_forall <span class="bound">pf</span><span class="main">,</span> <span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">pf</span><span class="main">)</span><span class="main">.</span> size <span class="bound">pf</span><span class="main">]</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> dfa_of_pf'_induct <span class="main">=</span>
  dfa_of_pf'.induct <span class="main">[</span><span class="operator">case_names</span> Eq Le And Or Imp Exist Forall Neg<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> dfa_of_pf'_well_formed<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_dfa <span class="main">(</span>dfa_of_pf' <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfa_of_pf'_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Le <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ineq_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> or_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Imp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imp_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negate_wf_dfa<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exist <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_well_formed_aut det_wf_nfa quantify_nfa_well_formed_aut dfa2wf_nfa min_dfa_wf<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfa_of_pf'_correctness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_alph <span class="free">n</span><span class="main">)</span> <span class="free">bss</span> <span class="main">⟹</span>
     dfa_accepts <span class="main">(</span>dfa_of_pf' <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="free">bss</span> <span class="main">=</span> eval_pf <span class="free">p</span> <span class="main">(</span>nats_of_boolss <span class="free">n</span> <span class="free">bss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dfa_of_pf'_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_dfa_accepts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Le <span class="skolem">n</span> <span class="skolem">ks</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ineq_dfa_accepts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf'_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> or_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf'_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Imp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imp_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf'_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_accepts_negate <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dfa_of_pf'_well_formed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exist <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">bs</span><span class="main">.</span> eval_pf <span class="skolem">p</span> <span class="main">(</span>nat_of_bools <span class="bound">bs</span> <span class="main">#</span> nats_of_boolss <span class="skolem">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">bs</span> <span class="main">=</span> length <span class="skolem">bss</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> eval_pf <span class="skolem">p</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> nats_of_boolss <span class="skolem">n</span> <span class="skolem">bss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="main">(</span>bools_of_nat <span class="main">(</span>length <span class="skolem">bss</span><span class="main">)</span> <span class="improper">x</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">bss</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"bools_of_nat <span class="main">(</span>length <span class="skolem">bss</span><span class="main">)</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bools_of_nat_inverse bools_of_nat_length<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> Exist <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
    rquot_accepts det_wf_nfa quantify_nfa_well_formed_aut dfa2wf_nfa
    det_nfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> zeros_is_alpha nfa_accepts_quantify_nfa <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span>
    nfa_of_dfa_accepts <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span> insertll_len2 nats_of_boolss_insertll
    zeros_len nats_of_boolss_append nats_of_boolss_zeros zip_replicate_mapr
    nats_of_boolss_length o_def insertl_0_eq
    dfa_of_pf'_well_formed min_dfa_accept <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> min_dfa_wf rquot_well_formed_aut
    <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> rev_conj_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Exec">
<div class="head">
<h1>Theory Exec</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Presburger-Automata/Exec.thy
    Author:     Stefan Berghofer, TU Muenchen, 2008-2009
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Exec
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Presburger_Automata.html">Presburger_Automata</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> gen_dfs_simps <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(⟶)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">(∨)</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xa</span><span class="main">.</span> int <span class="bound">xa</span> <span class="main">-</span> int <span class="bound">x</span> <span class="main">=</span> <span class="numeral">5</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span> <span class="bound">xb</span><span class="main">.</span> <span class="main">¬</span> <span class="numeral">6</span> <span class="main">≤</span> int <span class="bound">xb</span> <span class="main">⟶</span> int <span class="bound">xb</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">*</span> int <span class="bound">xa</span> <span class="main">-</span> int <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> int <span class="bound">xa</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="main">=</span> eval_pf <span class="main">(</span>Forall <span class="main">(</span>Exist <span class="main">(</span>Or <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="numeral">5</span><span class="main">)</span>
    <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">6</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> eval_pf <span class="var">?P</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dfa_accepts <span class="main">(</span>dfa_of_pf <span class="main">0</span> <span class="var">?P</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_of_pf_correctness <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dfa_of_pf.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xb</span><span class="main">.</span> <span class="main">¬</span> <span class="numeral">2</span> <span class="main">≤</span> int <span class="bound">xb</span> <span class="main">⟶</span> int <span class="bound">xb</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> int <span class="bound">xa</span> <span class="main">-</span> int <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">xb</span> <span class="bound">xc</span><span class="main">.</span> <span class="main">¬</span> <span class="numeral">2</span> <span class="main">≤</span> int <span class="bound">xc</span> <span class="main">⟶</span> int <span class="bound">xc</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> int <span class="bound">xb</span> <span class="main">-</span> int <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xa</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> int <span class="bound">xa</span> <span class="main">=</span> int <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">xb</span> <span class="main">=</span> <span class="bound">xa</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="main">=</span> eval_pf <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Exist <span class="main">(</span>Eq <span class="main">[</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> eval_pf <span class="var">?P</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dfa_accepts <span class="main">(</span>dfa_of_pf <span class="main">0</span> <span class="var">?P</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfa_of_pf_correctness <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dfa_of_pf.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_dfa</span> <span class="main">=</span> dfa_of_pf <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">stamp</span> <span class="main">=</span> Forall <span class="main">(</span>Imp <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">8</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Exist <span class="main">(</span>Exist <span class="main">(</span>Eq <span class="main">[</span><span class="numeral">5</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">stamp_false</span> <span class="main">=</span> Forall <span class="main">(</span>Imp <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">7</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Exist <span class="main">(</span>Exist <span class="main">(</span>Eq <span class="main">[</span><span class="numeral">5</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example</span> <span class="main">=</span> Forall <span class="main">(</span>Exist <span class="main">(</span>Or <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="numeral">5</span><span class="main">)</span>
  <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">6</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example2</span> <span class="main">=</span> Forall <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Exist <span class="main">(</span>Eq <span class="main">[</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">example2_false</span> <span class="main">=</span> Forall <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Forall <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Neg <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Imp <span class="main">(</span>Eq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Imp <span class="main">(</span>Exist <span class="main">(</span>Eq <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">harrison1</span> <span class="main">=</span> Exist <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Exist <span class="main">(</span>Exist
  <span class="main">(</span>And <span class="main">(</span>Le <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>And <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">[</span><span class="numeral">8</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">harrison2</span> <span class="main">=</span> Exist <span class="main">(</span>Forall <span class="main">(</span>Imp <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Exist <span class="main">(</span>Exist
  <span class="main">(</span>And <span class="main">(</span>Le <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>And <span class="main">(</span>Le <span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Eq <span class="main">[</span><span class="numeral">8</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"mk_dfa stamp"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"min_dfa <span class="main">(</span>mk_dfa stamp<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"mk_dfa stamp_false"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"mk_dfa example"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"mk_dfa example2"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"mk_dfa example2_false"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"mk_dfa harrison1"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"mk_dfa harrison2"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>