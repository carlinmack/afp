<div id="Legendre_Symbol">
<div class="head">
<h1>Theory Legendre_Symbol</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Legendre_Symbol.thy
  Authors:  Daniel Stüwe

  Some more facts about the Legendre symbol that are missing from HOL-Number_Theory
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional Facts about the Legendre Symbol›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Legendre_Symbol
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> basic_cong<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">-</span><span class="main">1</span> <span class="main">≠</span>  <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="main">0</span> <span class="main">≠</span>  <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="main">1</span> <span class="main">≠</span>  <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">-</span><span class="main">1</span> <span class="main">≠</span>  <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff zdvd_not_zless<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_mod_2_eq_0_eq_1 power_one zero_power<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_in_cong_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span>Legendre <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> Legendre <span class="free">a</span> <span class="free">m</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Legendre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_p_eq_2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Legendre <span class="free">a</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Legendre_def QuadRes_def cong_iff_dvd_diff<span class="main">)</span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_p_eq_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Legendre <span class="free">a</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Legendre_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_criterion_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Legendre <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> euler_criterion assms prime_int_nat_transfer
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_nat_eq nat_numeral prime_gt_0_int zless_nat_conj<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> QuadRes_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"QuadRes <span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> QuadRes <span class="free">p</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> QuadRes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Legendre <span class="free">a</span> <span class="main">(</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="main">=</span> Legendre <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Legendre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Legendre <span class="free">a</span> <span class="free">p</span> <span class="main">*</span> Legendre <span class="free">b</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms order_le_less prime_ge_2_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Legendre_p_eq_2 mod_mult_eq mod_self mult_cancel_right2
                mult_eq_0_iff not_mod_2_eq_1_eq_0 one_mod_two_eq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Legendre <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> euler_criterion_int assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> Legendre <span class="free">a</span> <span class="free">p</span> <span class="main">*</span> Legendre <span class="free">b</span> <span class="free">p</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_sym<span class="main">[</span><span class="operator">OF</span> euler_criterion_int<span class="main">]</span> assms 2 cong_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Legendre_in_cong_eq<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Legendre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> QuadRes_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">⟹</span> QuadRes <span class="free">p</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> QuadRes <span class="free">p</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mod_cancel QuadRes_def cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">⟹</span> Legendre <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Legendre <span class="free">a</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mod_cancel Legendre_def cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> two_cong_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cong_altdef_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> dvd_refl prime_nat_iff two_is_prime_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> two_cong_0_iff_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cong_iff_dvd_diff
  <span class="keyword1"><span class="command">using</span></span> two_is_prime_nat prime_nat_iff int_dvd_int_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> two_cong_0_iff_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">[</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_numeral pos_int_cases semiring_char_0_class.of_nat_eq_1_iff two_cong_0_iff_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> QuadRes_2_2 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"QuadRes <span class="numeral">2</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> QuadRes_def
  <span class="keyword1"><span class="command">unfolding</span></span> cong_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_mod_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Suc <span class="free">a</span> <span class="main">=</span> Suc <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Suc_eq_plus1_left cong_add_lcancel_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> div_cancel_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_plus_div_distrib_dvd_right dvd_div_mult dvd_trans dvd_triv_left<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> div_cancel_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">⟹</span> Suc <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> div_cancel_aux<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_aux_eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span> <span class="main">⟹</span> <span class="main">[</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>

  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> odd_pos<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oddE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="skolem">m</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> m' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span>  power2_sum power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">b</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_altdef_nat div_cancel_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH cong_add_rcancel_nat <span class="keyword1"><span class="command">unfolding</span></span> * m <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span> 
     
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_2_pow<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span><span class="main">^</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="free">a</span> <span class="main">=</span> even <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_dvd_iff that<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_Int<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> card <span class="free">A</span> <span class="main">-</span> card <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Diff_Int Diff_subset card_Diff_subset finite_Diff that<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofs are inspired by \cite{Quadratic_Reciprocity}.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> supplement2_Legendre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="numeral">2</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> GAUSS <span class="quoted"><span class="quoted">"nat <span class="free">p</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> GAUSS_def prime_int_nat_transfer
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_cong_0_iff_int<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card E <span class="main">=</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">`</span>
          <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> card <span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> E_def C_def B_def A_def image_image <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">(*)</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">…</span> <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..}</span><span class="main">)</span> <span class="main">=</span>
               nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span><span class="main">(*)</span> <span class="numeral">2</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Int<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_image inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="main">(*)</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..}</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="main">0</span> <span class="main">&lt;..</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bij_betw_same_card<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(*)</span></span></span> <span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> bij_betw_imageI inj_onI<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> assms prime_odd_int<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nat <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> nat <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">=</span>  nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_diff_distrib nat_div_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card E <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="numeral">2</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gauss_lemma assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nat <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> nat <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_div_distrib nat_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_aux_eq_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nat <span class="free">p</span>"</span></span><span class="main">]</span> odd_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> supplement1_Legendre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span> Legendre <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> euler_criterion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> Legendre_in_cong_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_one_power_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> QuadRes_1_right <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"QuadRes <span class="free">p</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> QuadRes_def cong_def power_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_1_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> Legendre <span class="main">1</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Legendre_def cong_iff_dvd_diff not_prime_unit<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_eq_0_not_coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>coprime <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cong_iff_dvd_diff prime_int_iff 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_coprime_cong_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="main">¬</span>coprime <span class="free">a</span> <span class="free">p</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cong_iff_dvd_diff
  <span class="keyword1"><span class="command">using</span></span> prime_imp_coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_cong_eq_0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span>coprime <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword1"><span class="command">using</span></span> not_coprime_cong_eq_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> cong_eq_0_not_coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_eq_0_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> Legendre <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">¬</span>coprime <span class="free">a</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Legendre_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_cong_eq_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_prod_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> Legendre <span class="main">(</span>prod_mset <span class="free">M</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">q</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> Legendre <span class="bound">q</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_0_eq_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Legendre <span class="main">0</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Legendre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_values<span class="main">:</span> <span class="quoted"><span class="quoted">"Legendre <span class="free">p</span> <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Legendre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Algebraic_Auxiliaries">
<div class="head">
<h1>Theory Algebraic_Auxiliaries</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Algebraic_Auxiliaries.thy
  Authors:  Daniel Stüwe

  Miscellaneous facts about algebra and number theory
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Material›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Algebraic_Auxiliaries
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="quoted">"<a href="../../HOL/HOL-Algebra/Algebra.html">HOL-Algebra.Algebra</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Squarefree.html">HOL-Computational_Algebra.Squarefree</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
          
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Divisibility.prime

<span class="keyword1"><span class="command">lemma</span></span> sum_of_bool_eq_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> of_bool <span class="main">(</span><span class="free">P</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">S</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> of_bool <span class="main">(</span><span class="free">P</span> <span class="bound">a</span><span class="main">)</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mod_natE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">n</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="bound">l</span> <span class="main">+</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mod_mult_div_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> r_coset_is_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">#&gt;</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊗</span> <span class="free">a</span><span class="main">)</span> <span class="main">`</span> <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_coset_def image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> FactGroup_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subgroup <span class="free">H</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="free">G</span> <span class="main">=</span> order <span class="main">(</span><span class="free">G</span> <span class="keyword1">Mod</span> <span class="free">H</span><span class="main">)</span> <span class="main">*</span> card <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> lagrange assms <span class="keyword1"><span class="command">unfolding</span></span> FactGroup_def order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> FactGroup_order_div<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subgroup <span class="free">H</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="free">G</span> <span class="keyword1">Mod</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> order <span class="free">G</span> <span class="keyword1">div</span> card <span class="free">H</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms FactGroup_order subgroupE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹subgroup <span class="free">H</span> <span class="free">G</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> group_hom_imp_group_hom_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group_hom <span class="free">G</span> <span class="free">G</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"group_hom <span class="free">G</span> <span class="main">(</span><span class="free">G</span><span class="main">⦇</span>carrier <span class="main">:=</span> <span class="free">h</span>  <span class="main">`</span> carrier <span class="free">G</span><span class="main">⦈</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> group_hom.axioms<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> group_hom.img_is_subgroup<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> group.subgroup_imp_group
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> group_hom.intro <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> group_hom_axioms_def hom_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> homomorphism_thm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group_hom <span class="free">G</span> <span class="free">G</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="keyword1">Mod</span> kernel <span class="free">G</span> <span class="main">(</span><span class="free">G</span><span class="main">⦇</span>carrier <span class="main">:=</span> <span class="free">h</span> <span class="main">`</span> carrier <span class="free">G</span><span class="main">⦈</span><span class="main">)</span> <span class="free">h</span> <span class="main">≅</span> <span class="free">G</span> <span class="main">⦇</span>carrier <span class="main">:=</span> <span class="free">h</span> <span class="main">`</span> carrier <span class="free">G</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> group_hom.FactGroup_iso group_hom_imp_group_hom_image assms<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_iso_imp_same_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≅</span> <span class="free">G</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="free">H</span> <span class="main">=</span> order <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="main">(</span>carrier <span class="free">H</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_iso_def iso_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> order_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> homomorphism_thm_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"group_hom <span class="free">G</span> <span class="free">G</span> <span class="free">h</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="free">G</span><span class="main">⦇</span>carrier <span class="main">:=</span> <span class="free">h</span> <span class="main">`</span> carrier <span class="free">G</span><span class="main">⦈</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="main">(</span><span class="free">G</span><span class="main">⦇</span>carrier <span class="main">:=</span> <span class="free">h</span> <span class="main">`</span> carrier <span class="free">G</span><span class="main">⦈</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> order <span class="free">G</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="free">G</span><span class="main">⦇</span>carrier <span class="main">:=</span> <span class="free">h</span> <span class="main">`</span> carrier <span class="free">G</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> order <span class="main">(</span><span class="free">G</span> <span class="keyword1">Mod</span> <span class="main">(</span>kernel <span class="free">G</span> <span class="main">(</span><span class="free">G</span><span class="main">⦇</span>carrier <span class="main">:=</span> <span class="free">h</span> <span class="main">`</span> carrier <span class="free">G</span><span class="main">⦈</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_iso_imp_same_card<span class="main">[</span><span class="operator">OF</span> homomorphism_thm<span class="main">]</span> <span class="quoted"><span class="quoted">‹group_hom <span class="free">G</span> <span class="free">G</span> <span class="free">h</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"group <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹group_hom <span class="free">G</span> <span class="free">G</span> <span class="free">h</span>›</span></span> group_hom.axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹group_hom <span class="free">G</span> <span class="free">G</span> <span class="free">h</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> group_hom_imp_group_hom_image<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹group_hom <span class="free">G</span> <span class="free">G</span> <span class="free">h</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> FactGroup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> group.lagrange group_hom.subgroup_kernel order_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group_hom<span class="main">)</span> kernel_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"kernel <span class="free">G</span> <span class="free">H</span> <span class="free">h</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subgroup_kernel G.subgroupE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> proper_subgroup_imp_bound_on_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊂</span> carrier <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"subgroup <span class="free">H</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">H</span> <span class="main">≤</span> order <span class="free">G</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1">rcosets</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RCOSETS_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> subgroup.subgroup_in_rcosets<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹subgroup <span class="free">H</span> <span class="free">G</span>›</span></span> is_group<span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">∈</span> <span class="keyword1">rcosets</span> <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rcosets_part_G<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹subgroup <span class="free">H</span> <span class="free">G</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">H</span> <span class="main">⊂</span> carrier <span class="free">G</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_le_iff inf.absorb_iff2 inf.idem inf.strict_order_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="main">(</span><span class="keyword1">rcosets</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">H</span> <span class="main">∈</span> <span class="keyword1">rcosets</span> <span class="free">H</span>›</span></span> card_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="keyword1">rcosets</span> <span class="free">H</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">H</span><span class="main">,</span> <span class="skolem">J</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_le_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">rcosets</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">H</span>"</span></span><span class="main">]</span>  
    <span class="keyword1"><span class="command">unfolding</span></span> lagrange<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹subgroup <span class="free">H</span> <span class="free">G</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_exp_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">d</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">d</span> <span class="main">^</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">d</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">c</span> <span class="main">=</span> <span class="free">d</span> <span class="main">^</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cong_pow cong_sym cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_exp_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">^</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">^</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_mult_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_add_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_add_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">b</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">y</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cong_def
  <span class="keyword1"><span class="command">using</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_mult_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">*</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">*</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">y</span> <span class="main">*</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">b</span> <span class="main">*</span> <span class="free">y</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">y</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cong_def
  <span class="keyword1"><span class="command">using</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">(</span>4<span class="main">,</span> 5<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_diff_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">-</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">-</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">x</span> <span class="main">-</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">y</span> <span class="main">-</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">b</span> <span class="main">-</span> <span class="free">y</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">-</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">y</span> <span class="main">-</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>unique_euclidean_semiring<span class="main">,</span> euclidean_ring_cancel<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cong_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_diff_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_imp_eq_mod_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> eq_imp_eq_mod_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_pow_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">a</span> <span class="main">=</span> <span class="free">x</span><span class="main">^</span><span class="free">b</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> gre1I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> gre1I_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> totient_less_not_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> totient_imp_prime totient_less assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred le_less_trans less_SucE zero_le_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> power2_diff_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square mult_2_right<span class="main">)</span>
     <span class="main">(</span><span class="operator">meson</span> Nat.diff_diff_right le_add2 le_trans mult_le_mono order_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_inequality<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1_left Suc_leI mult_le_mono1 semiring_normalization_rules<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_one_cong_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms cong_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1"><span class="command">lemma</span></span> cong_square_alt_int<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">*</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>normalization_semidom<span class="main">,</span> linordered_idom<span class="main">,</span> unique_euclidean_ring<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dvd_add_triv_right_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff square_diff_one_factored <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prime_dvd_multD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_square_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">*</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">∨</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">using</span></span> cong_square_alt_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"int <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"int <span class="free">a</span>"</span></span><span class="main">]</span> prime_nat_int_transfer<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> cong_int_iff <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> square_minus_one_cong_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_mult<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> power2_diff_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">0</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">*</span> <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> square_inequality<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span> le_add_diff_inverse2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> square_inequality<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_diff_le add_Suc cong_iff_lin_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_to_1'_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> odd_prime_gt_2_int<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword1"><span class="command">using</span></span> prime_ge_2_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹odd <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> odd_prime_gt_2_nat<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">using</span></span> prime_ge_2_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹odd <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_one_imp_gt_one_power_if_coprime<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> coprime <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gre1I<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> coprime_absorb_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> residue_one_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cong_to_1_nat <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coprimeI_power_mod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">r</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">r</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">r</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_1_right <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">^</span> <span class="free">r</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_commute<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* MOVE - EXTRA *)</span>
<span class="keyword1"><span class="command">lemma</span></span> prime_dvd_choose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> fact <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_dvd_fact_iff<span class="main">)</span>   
  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> fact <span class="free">k</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prime_dvd_mult_iff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> prime_dvd_fact_iff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> binomial_fact_lemma<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">p</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms prime_dvd_multD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_eq_0_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">[</span><span class="free">f</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cong_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> power_mult_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms cong_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">n</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">^</span><span class="free">n</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> power_mult_distrib
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> odd_pow_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">m</span> <span class="main">⟹</span> <span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> even_pow_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="free">m</span> <span class="main">⟹</span> <span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> cong_mult<span class="main">[</span><span class="operator">OF</span> cong_refl IH<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> cong_mult<span class="main">[</span><span class="operator">OF</span> cong_refl IH<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> square_minus_one_cong_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cong_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_mult_uneq'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>unique_euclidean_ring<span class="main">,</span> ring_gcd<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">d</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span> <span class="main">≠</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">d</span> <span class="main">=</span> <span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">b</span> <span class="main">*</span> <span class="free">d</span> <span class="main">≠</span> <span class="free">c</span> <span class="main">*</span> <span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cong_mult_rcancel<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> cong_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">*</span><span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">*</span><span class="free">e</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">*</span><span class="free">d</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> cong_scalar_left cong_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> p_coprime_right_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> coprime <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">p</span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> coprime_absorb_left coprime_commute not_prime_unit prime_imp_coprime_nat<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> squarefree_mult_imp_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_gcd<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> coprimeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">dvd</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">*</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvdE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="main">(</span><span class="skolem">l</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a'</span> <span class="main">*</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square mult_ac<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> squarefreeD<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_divisor_exists_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">k</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prime_int_iff dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> nk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword1"><span class="command">from</span></span> nk assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zero_less_mult_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> nk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> nk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> nk <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_divisor_exists_strong_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">k</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> prime <span class="bound">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_def<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms prime_prime_factor <span class="keyword2"><span class="keyword">and</span></span> prime_gt_1_nat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="free">m</span>›</span></span> dvd_imp_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">m</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="free">m</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">k</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_lessI Nat.gr0I<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO Remove *)</span>
<span class="keyword1"><span class="command">lemma</span></span> prime_factorization_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="free">P</span> <span class="main">⟹</span> prime <span class="bound">p</span>"</span></span> <span class="quoted"><span class="quoted">"prod_mset <span class="free">P</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_factorization <span class="free">n</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_factorization_prod_mset_primes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factorization_prime_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime_elem <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_factorization <span class="free">p</span> <span class="main">=</span> <span class="main">{#</span>normalize <span class="free">p</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factorization <span class="free">p</span> <span class="main">=</span> prime_factorization <span class="main">(</span>normalize <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> normalize_idem prime_factorization_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{#</span>normalize <span class="free">p</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_factorization_prime<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_prime_factorization_eq_Suc_0_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_semiring_multiplicative"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>prime_factorization <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟷</span> prime_elem <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>prime_factorization <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> size <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_factorization <span class="free">n</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> size_mset_SucE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_elem <span class="main">(</span>normalize <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_prime_factors_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> prod_mset <span class="main">(</span>prime_factorization <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">…</span> <span class="main">=</span> normalize <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_mset_prime_factorization_weak<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prime_elem <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factorization_prime_elem<span class="main">)</span>
<span class="comment1">(* END TODO *)</span>

<span class="comment1">(* TODO Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> squarefree_prime_elem <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> algebraic_semidom"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime_elem <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"squarefree <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> squarefreeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_unit <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_unit <span class="main">(</span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_unit_power_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_elem <span class="main">(</span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_elem_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_elem_power_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_prime <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> squarefree <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_squarefree_primepow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primepow <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"squarefree <span class="free">n</span> <span class="main">⟷</span> prime <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_def squarefree_power_iff prime_power_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factorization_normalize <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime_factorization <span class="main">(</span>normalize <span class="free">n</span><span class="main">)</span> <span class="main">=</span> prime_factorization <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_factorization_cong<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> one_prime_factor_iff_primepow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_semiring_multiplicative"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟷</span> primepow <span class="main">(</span>normalize <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primepow <span class="main">(</span>normalize <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> pk<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="main">(</span>normalize <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pk<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_factors_power prime_factorization_prime<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">n</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> normalize <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_prime_factors<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">n</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> card_1_singletonE<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> multiplicity <span class="skolem">p</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_multiplicity<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primepow <span class="main">(</span>normalize <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> primepow_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_imp_prod_prime_factors_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_semiring_multiplicative"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">(</span>prime_factors <span class="free">x</span><span class="main">)</span> <span class="main">=</span> normalize <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">x</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> normalize <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_prime_factors<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">x</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">x</span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> squarefree_factorial_semiring'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* END TODO *)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Jacobi_Symbol">
<div class="head">
<h1>Theory Jacobi_Symbol</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Jacobi_Symbol.thy
  Authors:  Daniel Stüwe, Manuel Eberl

  The Jacobi symbol, a generalisation of the Legendre symbol.
  This is used in the Solovay--Strassen test.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Jacobi Symbol›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Jacobi_Symbol
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Legendre_Symbol.html">Legendre_Symbol</a>
  <a href="Algebraic_Auxiliaries.html">Algebraic_Auxiliaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Jacobi symbol is a generalisation of the Legendre symbol to non-primes \cite{Legendre_Symbol, Jacobi_Symbol}.
  It is defined as
  \[\left(\frac{a}{n}\right) =
      \left(\frac{a}{p_1}\right)^{k_1} \ldots \left(\frac{a}{p_l}\right)^{k_l}\]
  where $(\frac{a}{p})$ denotes the Legendre symbol, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> is an integer, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> is an odd natural
  number and $p_1^{k_1}\ldots p_l^{k_l}$ is its prime factorisation.

  There is, however, a fairly natural generalisation to all non-zero integers for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>.
  It is less clear what a good choice for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n = 0›</span></span></span></span> is; Mathematica and Maxima adopt
  the convention that $(\frac{\pm 1}{0}) = 1$ and $(\frac{a}{0}) = 0$ otherwise. However,
  we chose the slightly different convention $(\frac{a}{0}) = 0$ for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹all›</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> because then
  the Jacobi symbol is completely multiplicative in both arguments without any restrictions.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Jacobi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Jacobi</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span>
                  <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈#</span>prime_factorization <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> Legendre <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_0_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Jacobi_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_mult_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Jacobi <span class="free">a</span> <span class="free">n</span> <span class="main">*</span> Jacobi <span class="free">b</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> Legendre <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="bound">p</span>          <span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> prime_factorization <span class="free">n</span> <span class="main">#}</span> <span class="main">=</span>
           <span class="main">{#</span> Legendre <span class="free">a</span> <span class="bound">p</span> <span class="main">*</span> Legendre <span class="free">b</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> prime_factorization <span class="free">n</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Legendre_mult in_prime_factors_imp_prime image_mset_cong<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> Jacobi_def * prod_mset.distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_mult_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Jacobi <span class="free">a</span> <span class="free">n</span> <span class="main">*</span> Jacobi <span class="free">a</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Jacobi_def prime_factorization_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_p_Jacobi_eq_Legendre<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> Jacobi <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> Legendre <span class="free">a</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Jacobi_def prime_factorization_prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_mod <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Jacobi <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> Legendre <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> prime_factorization <span class="free">n</span> <span class="main">#}</span> <span class="main">=</span>
           <span class="main">{#</span> Legendre <span class="free">a</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> prime_factorization <span class="free">n</span> <span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_mset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> Legendre_mod<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dvd_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> in_prime_factors_imp_dvd<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Jacobi_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_mod_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> Jacobi <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> Jacobi <span class="free">b</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Jacobi_mod cong_def dvd_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_1_eq_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> Jacobi <span class="main">1</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Jacobi_def in_prime_factors_imp_prime <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> image_mset_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_eq_0_not_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="free">a</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">n</span> <span class="main">∧</span> prime <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_divisor_exists<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="free">a</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_int_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> p assms
    <span class="keyword1"><span class="command">unfolding</span></span> Jacobi_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff prime_factors_dvd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_p_eq_2'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> Jacobi <span class="free">a</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Jacobi_def prime_factorization_prime_power<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_prod_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> Jacobi <span class="main">(</span>prod_mset <span class="free">M</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">q</span><span class="main">∈#</span><span class="free">M</span><span class="main">.</span> Jacobi <span class="bound">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> non_trivial_coprime_neq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> coprime <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> odd_odd_even<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> even <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_nonprime_wlog <span class="main">[</span><span class="operator">case_names</span> primes nonprime sym<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">⟹</span> prime <span class="bound">q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>prime <span class="bound">p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">P</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">q</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"prime <span class="free">q</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Quadratic_Reciprocity_Jacobi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">p</span> <span class="free">q</span> <span class="main">*</span> Jacobi <span class="free">q</span> <span class="free">p</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"nat <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"nat <span class="free">q</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> 
         <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">a</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">b</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">split_format</span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="quasi_keyword"><span class="quasi_keyword">complete</span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prime_nonprime_wlog<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sym <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_ac coprime_commute mult_ac<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>primes <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>nat <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>nat <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_int_nat_transfer primes<span class="main">(</span>4<span class="main">)</span> non_trivial_coprime_neq prime_gt_1_int
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">with</span></span> Quadratic_Reciprocity_int <span class="keyword2"><span class="keyword">and</span></span> prime_p_Jacobi_eq_Legendre
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">q</span>›</span></span> primes<span class="main">(</span>5-<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nonprime <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>prime <span class="skolem">p</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> prime_divisor_exists_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">hence</span></span> odd_ab<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> odd_ab <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">b</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">p</span> <span class="skolem">q</span>›</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">*</span> Jacobi <span class="skolem">q</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
                        <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">b</span> <span class="skolem">q</span> <span class="main">*</span> Jacobi <span class="skolem">q</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * nonprime<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">*</span> Jacobi <span class="skolem">q</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span>Jacobi <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">*</span> Jacobi <span class="skolem">q</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Jacobi <span class="skolem">b</span> <span class="skolem">q</span> <span class="main">*</span> Jacobi <span class="skolem">q</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                     <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> odd_odd_even<span class="main">[</span><span class="operator">OF</span> odd_ab<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> * minus_one_power_iff <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> even_nat_iff pos_imp_zdiv_nonneg_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_values<span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">p</span> <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>Legendre <span class="free">p</span> <span class="skolem">x</span><span class="main">¦</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> prime_factorization <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that prod_mset_zero_iff Legendre_values<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Jacobi_def is_unit_prod_mset_iff set_image_mset
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>prod_mset <span class="main">(</span>image_mset <span class="main">(</span>Legendre <span class="free">p</span><span class="main">)</span> <span class="main">(</span>prime_factorization <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">p</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that False
    <span class="keyword1"><span class="command">unfolding</span></span> Jacobi_def is_unit_prod_mset_iff 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Jacobi_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Quadratic_Reciprocity_Jacobi'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="free">q</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> Jacobi <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">a</span><span class="main">*</span><span class="skolem">b</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">⟹</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> Quadratic_Reciprocity_Jacobi<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Jacobi <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Jacobi_values <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> aux<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∨</span> even <span class="main">(</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> minus_one_power_iff <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">q</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> even_nat_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="free">q</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_odd_square<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">8</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"odd <span class="skolem">x</span>"</span></span><span class="main">)</span> 
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> odd_odd_even'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">⟷</span> even <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> oddE evenE<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> odd_odd_even_nat'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">⟷</span> even <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> oddE evenE<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supplement2_Jacobi<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> Jacobi <span class="numeral">2</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="free">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prime_divisors_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>factor <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> prime_gt_1_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_odd_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> prime_gt_0_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> less_trans less_numeral_extra<span class="main">(</span>1<span class="main">)</span> zero_less_mult_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> base_case <span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="numeral">2</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> supplement2_Legendre <span class="keyword2"><span class="keyword">and</span></span> prime_p_Jacobi_eq_Legendre
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="numeral">2</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Jacobi <span class="numeral">2</span> <span class="skolem">p</span> <span class="main">*</span> Jacobi <span class="numeral">2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="numeral">2</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="skolem">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> factor.IH<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> base_case

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="skolem">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span>
             <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> minus_one_power_iff
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> odd_odd_even_nat'
      <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">linarith_split_limit</span> <span class="main"><span class="main">=</span></span> 0<span class="main">]</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_mult_distrib even_nat_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> mod_nat_wlog <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> modulo<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> mod_less_divisor 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> mod_int_wlog <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> modulo<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> pos_mod_conj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1"><span class="command">lemma</span></span> supplement2_Jacobi'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="numeral">2</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="numeral">7</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">8</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="numeral">7</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mod_nat_wlog<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>modulo <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_0_right even_even_mod_4_iff even_numeral mod_exhaust_less_4<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mod_natE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="numeral">7</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mod_natE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">*</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">*</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="numeral">7</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> nat_mod_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="numeral">8</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> even_nat_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> supplement2_Jacobi<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
              minus_one_power_iff *<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹odd <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> supplement1_Jacobi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"odd <span class="free">p</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span> Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prime_divisors_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>factor <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> prime_gt_1_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>nat <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> prime_int_nat_transfer
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Legendre <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_p_Jacobi_eq_Legendre<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span>nat <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> supplement1_Legendre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nat <span class="skolem">p</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_nat_eq nat_mono_iff nat_numeral_as_int prime_gt_0_int prime_int_nat_transfer<span class="main">)</span> 

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> base_case<span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> prime_gt_0_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> int_one_le_iff_zero_less not_less not_less_iff_gr_or_eq zero_less_mult_iff<span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_odd_int<span class="main">)</span> 

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">*</span> Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> base_case

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> False <span class="quoted"><span class="quoted">‹odd <span class="skolem">x</span>›</span></span> factor.IH 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">^</span> nat <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">*</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> minus_one_power_iff
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> even_nat_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> supplement1_Jacobi'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"odd <span class="free">n</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> Jacobi <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> even_nat_iff minus_one_power_iff supplement1_Jacobi<span class="main">)</span>
     <span class="operator">presburger</span><span class="main"><span class="keyword3">?</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_0_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_unit <span class="free">n</span> <span class="main">⟹</span> Jacobi <span class="main">0</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"prime_factorization <span class="free">n</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Jacobi_def prime_factorization_empty_iff image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_unit_Jacobi_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="free">x</span> <span class="main">⟹</span> Jacobi <span class="free">a</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Jacobi_def <span class="keyword1"><span class="command">using</span></span> prime_factorization_empty_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_unit_Jacobi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_unit_Jacobi_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_neg_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Jacobi <span class="free">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> * <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Jacobi_mult_right<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_neg_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="main">-</span><span class="free">a</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> Jacobi <span class="free">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> * <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> * Jacobi_mult_left supplement1_Jacobi'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">jacobi_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">jacobi_code</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span> 
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">jacobi_code</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> even <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="keyword1">if</span> even <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">jacobi_code</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">jacobi_code</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free">jacobi_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> even <span class="free"><span class="bound"><span class="entity">a</span></span></span>      <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">7</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">jacobi_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> coprime <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">jacobi_code</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>
   <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> nat<span class="main">(</span>abs<span class="main">(</span><span class="bound">a</span><span class="main">)</span> <span class="main">+</span> abs<span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> 
                   <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">a</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pos_mod_bound<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> jacobi_code.simps

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> jacobi_code <span class="free">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> jacobi_code.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 2<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 3<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 4<span class="main">:</span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 4 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main">)</span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> 5<span class="main">:</span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">n</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 4 5 1<span class="main">(</span>2<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> evenE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> jacobi_code.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_p_Jacobi_eq_Legendre<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> 6<span class="main">:</span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 4 5 6
                  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Jacobi_neg_left<span class="main">)</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> 7<span class="main">:</span> False
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> True
                  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_unit <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> Jacobi_0_eq_0<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> 2 3 4 5 7 True
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main">)</span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> 8<span class="main">:</span> False
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> True
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 4 5 6 7 8 1<span class="main">(</span>4<span class="main">)</span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main">)</span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> 9<span class="main">:</span> False
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="skolem">a</span>"</span></span><span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> True
                      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">…</span> <span class="skolem">n</span> <span class="main">=</span> Jacobi <span class="numeral">2</span> <span class="skolem">n</span> <span class="main">*</span> Jacobi <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> jacobi_code <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> 2 3 4 5 6 7 8 9 True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> 1<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
                      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="numeral">2</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">7</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> 2 3 5 supplement2_Jacobi'<span class="main">[</span><span class="operator">OF</span> 6<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> jacobi_code <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> jacobi_code <span class="skolem">a</span> <span class="skolem">n</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> 2 3 4 5 6 7 8 9 True
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> jacobi_code.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_False if_True HOL.simp_thms<span class="main">)</span>
                      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> 10<span class="main">:</span> False
                      <span class="keyword1"><span class="command">note</span></span> foo <span class="main">=</span> 1 2 3
                      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
                        <span class="keyword3"><span class="command">case</span></span> True
                        <span class="keyword1"><span class="command">note</span></span> this_case <span class="main">=</span> 2 3 4 5 6 7 8 9 10 True
                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 4 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
                        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 5 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
                        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"jacobi_code <span class="skolem">a</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>
                                                        <span class="main">*</span> jacobi_code <span class="skolem">n</span> <span class="skolem">a</span>"</span></span>
                          <span class="keyword1"><span class="command">using</span></span> this_case <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main">)</span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"jacobi_code <span class="skolem">n</span> <span class="skolem">a</span> <span class="main">=</span> Jacobi <span class="skolem">n</span> <span class="skolem">a</span>"</span></span>
                          <span class="keyword1"><span class="command">using</span></span> this_case <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> 1<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> Jacobi <span class="skolem">a</span> <span class="skolem">n</span>"</span></span>
                          <span class="keyword1"><span class="command">using</span></span> this_case <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">a</span>›</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Quadratic_Reciprocity_Jacobi' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute<span class="main">)</span>
                        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">case</span></span> False
                        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 7 8 9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span> 
                        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                          <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 5 6 7 8 9 10 False *
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Jacobi_eq_0_not_coprime<span class="main">)</span>
                      <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">subst</span> jacobi_code.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_eq_0_imp_not_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Jacobi <span class="free">n</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span>coprime <span class="free">n</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Jacobi_mod_cong coprime_iff_invertible_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> Jacobi_eq_0_iff_not_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">n</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">¬</span>coprime <span class="free">n</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> Jacobi_eq_0_imp_not_coprime 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Jacobi_eq_0_not_coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Residues_Nat">
<div class="head">
<h1>Theory Residues_Nat</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Residues_Nat.thy
  Authors:  Daniel Stüwe, Manuel Eberl

  The multiplicative group of the ring of residues modulo n.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Residue Rings of Natural Numbers›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Residues_Nat
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Algebraic_Auxiliaries.html">Algebraic_Auxiliaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>            

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The multiplicative group of residues modulo <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Residues_Mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>linordered_semidom<span class="main">,</span> euclidean_semiring<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span> monoid"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Residues_Mult</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
     <span class="main">⦇</span>carrier <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span> <span class="main">.</span> coprime <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">,</span> monoid.mult <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> one <span class="main">=</span> <span class="main">1</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> residues_mult_nat <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">G</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≡</span> Residues_Mult <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> carrier_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">G</span> <span class="main">=</span> totatives <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mult_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> one_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G_def Residues_Mult_def totatives_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> group <span class="quoted"><span class="free">G</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> groupI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> n_gt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute coprime_dvd_mult_left_iff
                                    coprime_absorb_left nat_dvd_not_less totatives_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_iff_invertible'_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> n_gt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_gcd_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">y</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">with</span></span> y n_gt_1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span>carrier <span class="free">G</span><span class="main">.</span> <span class="bound">y</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def cong_def mult_ac <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> n_gt_1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> totatives_less›</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> comm_group
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_pow_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">k</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_left_eq mod_mult_right_eq mult_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_pow_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">([^]</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> order_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">G</span> <span class="main">=</span> totient <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_def totient_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> order_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span> <span class="main">⟹</span> order <span class="free">G</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> totient_less_not_prime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> n_gt_1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ord_residue_mult_group<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"local.ord <span class="free">a</span> <span class="main">=</span> Pocklington.ord <span class="free">n</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> local.ord <span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pow_ord_eq_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Pocklington.ord <span class="free">n</span> <span class="free">a</span> <span class="keyword1">dvd</span> local.ord <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ord_divides<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"local.ord <span class="free">a</span> <span class="keyword1">dvd</span> Pocklington.ord <span class="free">n</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Pocklington.ord<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> n_gt_1 pow_eq_id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The ring of residues modulo <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Residues_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat ring"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Residues_nat</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">⦇</span>carrier <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">,</span> monoid.mult <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> one <span class="main">=</span> <span class="main">1</span><span class="main">,</span>
                     ring.zero <span class="main">=</span> <span class="main">0</span><span class="main">,</span> add <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> residues_nat <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> Residues_nat <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> carrier_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">R</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mult_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> add_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊕</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> one_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> zero_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">𝟬</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Residues_nat_def R_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(⊗</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> add_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(⊕</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> abelian_group <span class="quoted"><span class="free">R</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> abelian_groupI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> n_gt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> n_gt_1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span>›</span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> comm_monoid <span class="quoted"><span class="free">R</span></span>
  <span class="keyword1"><span class="command">using</span></span> n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> cring <span class="quoted"><span class="free">R</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Units_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Units <span class="free">R</span> <span class="main">=</span> totatives <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Units <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_imp_coprime cong_sym coprime_1_left coprime_mult_left_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def Units_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_iff_invertible'_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Units <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def mult_ac cong_def totatives_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> units<span class="main">:</span> residues_mult_nat <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"units_of <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"units_of <span class="free">R</span> <span class="main">≡</span> Residues_Mult <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> units_of_def Units_eq Residues_Mult_def totatives_def Suc_le_eq mult_eq'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> n_gt_1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> nat_pow_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">k</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> mult_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_pow_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">([^]</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The ring of residues modulo a prime›</span></span>

<span class="keyword1"><span class="command">locale</span></span> residues_nat_prime <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prime_p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> Residues_nat <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> residues_nat <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">R</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> prime_p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> carrier_eq' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"totatives <span class="free">p</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_prime<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> order_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="main">(</span>units_of <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> units.order_eq totient_prime<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> order_eq' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"totient <span class="free">p</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totient_prime<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> field <span class="quoted"><span class="free">R</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cring_fieldI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Units <span class="free">R</span> <span class="main">=</span> carrier <span class="free">R</span> <span class="main">-</span> <span class="main">{</span><span class="main">𝟬</span><span class="hidden">⇘</span><sub><span class="free">R</span></sub><span class="hidden">⇙</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Units_eq<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> prime_p <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> totatives_prime›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> residues_prime_cyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> n_gt_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_field_mult_group_has_gen <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> residues_prime_cyclic'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> units.ord <span class="bound">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> residues_prime_cyclic <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"units.ord <span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"units.ord <span class="skolem">x</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> units.ord_dvd_group_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> units.order_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">(* TODO FIXME: a bit ugly; could be simplified if we had a theory of finite cyclic rings *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> card <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>units.ord <span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> units.ord <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> units.ord <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> units.ord <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">(</span>units.ord <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> units.ord <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">⊗</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> <span class="skolem">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> units.ord <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> units.nat_pow_mult<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">(</span>units.ord <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> units.ord <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">(</span><span class="skolem">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> units.ord <span class="skolem">x</span><span class="main">)</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">div</span> units.ord <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> units.nat_pow_pow<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">[^]</span><span class="hidden">⇘</span><sub>units_of <span class="free">R</span></sub><span class="hidden">⇙</span> units.ord <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> units.pow_ord_eq_1<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="skolem">j</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> units.ord <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="skolem">j</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>units.ord <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> units.ord_ge_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">{..&lt;</span>units.ord <span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_image_le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> units.ord <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> units.ord <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>-1›</span></span></span></span> in residue rings›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_one_cong_solve_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Residues_Mult <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> residues_mult_nat <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">G</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main">:</span> G_def›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">n</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_diff_nat cong_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> square_minus_one_cong_one<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inv_unique'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> inv_unique'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> minus_one_in_totatives<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms<span class="main">(</span>1-3<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coprime_imp_mod_not_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms coprime_0_left_iff nat_dvd_not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_one_cong_solve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime coprime_imp_mod_not_zero <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">y</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime coprime_mod_left_iff <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> minus_one_cong_solve_weak<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> square_minus_one_cong_one'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> square_minus_one_cong_one<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="QuadRes">
<div class="head">
<h1>Theory QuadRes</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Miller_Rabin.thy
  Authors:  Daniel Stüwe

  Some facts about Quadratic Residues that are missing from the library
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional Material on Quadratic Residues›</span></span>
<span class="keyword1"><span class="command">theory</span></span> QuadRes
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Jacobi_Symbol.html">Jacobi_Symbol</a>
  <a href="Algebraic_Auxiliaries.html">Algebraic_Auxiliaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofs are inspired by \cite{Quadratic_Residues}.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_QuadRes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword3"><span class="command">assume</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> * <span class="main">:</span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword1"><span class="command">using</span></span> dvd_imp_le_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cong_def <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square square_diff_square_factored<span class="main">)</span> 
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_dvd_mult_iff<span class="main">)</span> 

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
           <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elem  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> * <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> QuadRes_set_prime<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> QuadRes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> cong_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mod<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> cong_def 
    <span class="keyword1"><span class="command">using</span></span> minus_mod_self1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_mod<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_0_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹odd <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_0_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that B
      <span class="keyword1"><span class="command">unfolding</span></span> cong_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that A
      <span class="keyword1"><span class="command">unfolding</span></span> cong_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> QuadRes_def cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> QuadRes_iff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>QuadRes <span class="free">p</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>QuadRes <span class="free">p</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> QuadRes_set_prime<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> card_QuadRes_set_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> QuadRes_set_prime<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">...</span> <span class="main">=</span> card <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inj_on_QuadRes<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">p</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> card_not_QuadRes_set_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="free">p</span> <span class="main">-</span> nat <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">p</span>›</span></span> prime_gt_0_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_add_distrib nat_mult_distrib<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">-</span> card <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_QuadRes_set_prime<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> card_atLeastZeroLessThan_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>    

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Diff_subset_Int<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_QuadRes_ex_if_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>QuadRes <span class="free">p</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> odd_prime_gt_2_int assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="main">¬</span>QuadRes <span class="free">p</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_not_QuadRes_set_prime<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_QuadRes_ex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟹</span> odd <span class="free">p</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>QuadRes <span class="free">p</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prime_divisors_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>factor <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> not_QuadRes_ex_if_prime QuadRes_def cong_iff_dvd_diff dvd_mult_left even_mult_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Euler_Witness">
<div class="head">
<h1>Theory Euler_Witness</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Euler_Witness.thy
  Author:   Daniel Stüwe

  Euler Witnesses as used in the Solovay--Strassen primality test
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Euler Witnesses›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Euler_Witness
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Jacobi_Symbol.html">Jacobi_Symbol</a>
  <a href="Residues_Nat.html">Residues_Nat</a>
  <a href="QuadRes.html">QuadRes</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Proofs are inspired by \cite{solovay_strassen_ori, SolovayStrassenTest, wiki:Solovay_Strassen_test, planetmath:SolovayStrassenTest}.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">euler_witness</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">[</span>Jacobi <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">euler_liar</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">¬</span> euler_witness <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> euler_witness_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"euler_witness <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> euler_witness <span class="free">a</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def cong_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mod<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_liar_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"euler_liar <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> euler_liar <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_liar_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> euler_liar <span class="free">b</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms cong_def euler_witness_mod<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_witnessI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">n</span> <span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span>Jacobi <span class="free">x</span> <span class="main">(</span>int <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span>
    <span class="main">⟹</span>  euler_witness <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def  <span class="keyword1"><span class="command">using</span></span> cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_witnessI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">≠</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"euler_liar <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">[</span>Jacobi <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"euler_liar <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">x</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Jacobi <span class="free">x</span> <span class="main">(</span>int <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> cong_dvd_modulus euler_witness_def int_dvd_int_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> main<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹euler_liar <span class="free"><span class="free">x</span></span> <span class="free"><span class="free">n</span></span>›</span></span></span><span class="main">]</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>  
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">a</span> <span class="main">≠</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cong_trans cong_sym
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> euler_witness_exists_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> euler_witness <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"squarefree <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_divisor_exists_strong_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>prime <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">p</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">k</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹squarefree <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> squarefree_mult_imp_coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>int <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>int <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>QuadRes <span class="skolem">p</span> <span class="skolem">b</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> not_QuadRes_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"int <span class="skolem">p</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> prime_gt_1_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> cong_def QuadRes_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_power2<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> binary_chinese_remainder_int<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹coprime <span class="main">(</span>int <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>int <span class="skolem">k</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="skolem">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> euler_witnessI2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span>"</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cong_def
        <span class="keyword1"><span class="command">using</span></span> cong_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">x</span> <span class="free">n</span> <span class="main">=</span> Jacobi <span class="skolem">x</span> <span class="skolem">p</span> <span class="main">*</span> Jacobi <span class="skolem">x</span> <span class="skolem">k</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> n 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> Jacobi_mod_cong<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">b</span> <span class="skolem">p</span> <span class="main">=</span> Legendre <span class="skolem">b</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_p_Jacobi_eq_Legendre<span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> Legendre_def 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> QuadRes <span class="skolem">p</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
     <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> Jacobi_mod_cong<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">k</span><span class="main">)</span>›</span></span><span class="main">]</span> 
  
     <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Jacobi <span class="skolem">x</span> <span class="main">(</span>int <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="skolem">k</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
        
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> not_coprime_cong_eq_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> prime_nat_int_transfer
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cong_sym cong_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="skolem">k</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coprime_iff_invertible_int coprime_mult_right_iff mult.right_neutral of_nat_mult<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹euler_witness <span class="skolem">x</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl2 odd_pos squarefree_factorial_semiring<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dvd_mult_imp_div <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_mult_div_cancel dvd_mult_right<span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dvd_trans even_power pos2<span class="main">)</span>
      
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_ge_2_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>  

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">^</span><span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> binomial a_def
      <span class="keyword1"><span class="command">using</span></span> atLeast0AtMost <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">*</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_distrib_left 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute power_minus_mult<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="keyword1">choose</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="keyword1">choose</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">^</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">choose</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> dvd_power_le<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">1</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">p</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvd_mult2 prime_dvd_choose<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dvdE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> odd_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>   sum.atLeast_Suc_atMost<span class="main">[</span><span class="operator">OF</span> Suc_leI<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI sum.atLeast_Suc_atMost<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">dvd</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> C m  <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> A B cong_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mod_Suc_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> Suc_eq_plus1_left<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI dvd_diffD1 dvd_mult_right not_prime_unit odd_pos power2_eq_square<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> div_mult2_eq n nonzero_mult_div_cancel_left <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cong_to_1_nat<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">n</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ord_works<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> a_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">n</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ord_divides<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">n</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span>›</span></span> n
      <span class="keyword1"><span class="command">unfolding</span></span> a_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coprime_add_one_right coprime_mult_left_iff dvd_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cong_altdef_nat<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">≠</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_mult_self_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> cong_sym cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> order_divides_expdiff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹coprime <span class="free">n</span> <span class="skolem">a</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹ord <span class="free">n</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_sym cong_trans
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span>int <span class="skolem">a</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cong_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_1 of_nat_eq_iff of_nat_mod of_nat_power<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">a</span> <span class="free">n</span> <span class="main">=</span> Jacobi <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> int <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_mult<span class="main">)</span>
      
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Jacobi <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">*</span> Jacobi <span class="skolem">a</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Jacobi_mult_right<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> Jacobi <span class="main">1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Jacobi_mod_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff a_def<span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="skolem">a</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Jacobi <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Jacobi_mod_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff a_def<span class="main">)</span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Jacobi_1_eq_1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvdE<span class="main">)</span>

    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span>int <span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="free">n</span> <span class="skolem">a</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"int <span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_sym coprime_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> euler_witness_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> euler_witness <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"euler_witness <span class="skolem">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> euler_witness_exists_weak assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> odd_pos<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pos_mod_sign<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>›</span></span>  coprime_0_left_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"int <span class="free">n</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pos_mod_bound<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> euler_witness_exists_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> euler_witness <span class="main">(</span>int <span class="bound">a</span><span class="main">)</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> euler_witness_exists<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> zero_less_imp_eq_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_liar_1_p<span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> euler_liar <span class="main">1</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_liar_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> euler_liar <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> euler_liar <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power_mult_distrib <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cong_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_liar_mult'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> euler_witness <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> euler_witness <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> euler_witness_def power_mult_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cong_mult_uneq'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> Jacobi_eq_0_iff_not_coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> Jacobi_values<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_imp_euler_liar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"euler_liar <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms prime_p_Jacobi_eq_Legendre <span class="keyword2"><span class="keyword">and</span></span> euler_criterion
  <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">locale</span></span> euler_witness_context <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> odd_p<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">G</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">=</span> Residues_Mult <span class="free">p</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> residues_mult_nat <span class="quoted"><span class="free">p</span></span> <span class="quoted">G</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">use</span> p_gt_1 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main">:</span> G_def›</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> coprime <span class="bound">x</span> <span class="free">p</span> <span class="main">∧</span> euler_liar <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">}</span>"</span></span>
         
<span class="keyword1"><span class="command">sublocale</span></span> H<span class="main">:</span> subgroup <span class="quoted">H</span> <span class="quoted">G</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"H <span class="main">⊆</span> carrier G"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def totatives_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subgroup H G"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> group.subgroupI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> is_group<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="main">1</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_gt_1
      <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="skolem">x</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="keyword1">inv</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">x</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> H›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">𝟭</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">using</span></span> subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> r_inv<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> y_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="skolem">x</span> <span class="main">*</span> int <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_1 of_nat_mod of_nat_mult<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">y</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> p_gt_1 <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_iff_invertible'_nat cong_def mult.commute<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier G"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> subset <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inv_closed<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_gt_1 totatives_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>    

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="main">1</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> euler_liar_1_p<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="main">(</span>int <span class="skolem">x</span> <span class="main">*</span> int <span class="skolem">y</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ** p_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> euler_liar_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"int <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> int <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span>"</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="skolem">y</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">x</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹euler_liar <span class="skolem">x</span> <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> euler_liar_mult'<span class="main">[</span><span class="operator">OF</span> p_gt_1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coprime_int_iff mult.commute<span class="main">)</span>
      
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> y_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def H_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gre1I_nat cong_mult
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute coprime_dvd_mult_left_iff
                     nat_dvd_not_less zmod_int power_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> H_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite H"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_witness_coset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="free">x</span> <span class="main">⟹</span> euler_witness <span class="free">y</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms euler_liar_mult'<span class="main">[</span><span class="operator">OF</span> p_gt_1<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> r_coset_is_image H_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute of_nat_mod<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_liar_coset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier G"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="free">x</span> <span class="main">⟹</span> euler_liar <span class="free">y</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_group H.rcos_const<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms totatives_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> p_gt_1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def totatives_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_cosets_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier G"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="free">x</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rcosetsI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def totatives_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> H_cosets_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="free">x</span><span class="main">)</span> <span class="main">∩</span> H <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> euler_witness_coset assms <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> H_rcosets_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier G"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>H<span class="main">,</span> H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_cosets_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> H.subgroup_in_rcosets<span class="main">[</span><span class="operator">OF</span> is_group<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> H_not_eq_coset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">x</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"H <span class="main">≠</span> H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H.one_closed H_def assms<span class="main">(</span>1<span class="main">)</span> euler_witness_coset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_cosets_H<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rcosets_part_G<span class="main">[</span><span class="operator">OF</span> H.is_subgroup<span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_UnionD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> card_cosets_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier G"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H_not_eq_coset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> card_mono<span class="main">[</span><span class="operator">OF</span> finite_cosets_H H_rcosets_aux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> card_euler_liars_cosets_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card H <span class="main">&lt;</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H"</span></span> <span class="quoted"><span class="quoted">" H <span class="main">⊆</span> carrier G"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_group H.subgroup_in_rcosets <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> carrier_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="skolem">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> odd_p assms euler_witness_exists_nat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> carrier G"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_cosets_limit <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite H"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> H.subset<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cosets_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rcosetsI<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> H.subset a <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H.subset rcosetsI <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> carrier G›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card H <span class="main">=</span> card <span class="main">(</span>H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_rcosets_equal H.subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H <span class="main">∪</span> H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">a</span> <span class="main">⊆</span> carrier G"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rcosets_part_G<span class="main">[</span><span class="operator">OF</span> H.is_subgroup<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> H.subgroup_in_rcosets<span class="main">[</span><span class="operator">OF</span> is_group<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> H›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card H <span class="main">+</span> card <span class="main">(</span>H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>carrier G<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite H›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>H <span class="main">#&gt;</span><span class="hidden">⇘</span><sub>G</sub><span class="hidden">⇙</span> <span class="skolem">a</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> H_cosets_aux<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹euler_witness <span class="skolem">a</span> <span class="free">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> H.subset finite_subset card_Un_disjoint
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card H <span class="main">≤</span> card <span class="main">(</span>carrier G<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pa</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">pa</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">pa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pa</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">pa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_divisor_exists_strong_nat<span class="main">[</span><span class="operator">OF</span> p_gt_1 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> prime <span class="free">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="skolem">pa</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier G <span class="main">⊂</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> prime <span class="free">p</span>›</span></span> pa<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier G<span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_atLeastLessThan finite_atLeastLessThan psubset_card_mono<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card H <span class="main">&lt;</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card H <span class="main">≤</span> card <span class="main">(</span>carrier G<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>carrier G<span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> odd_p less_mult_imp_div_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier G<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_imp_G_is_H<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"carrier G <span class="main">=</span> H"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">using</span></span> assms prime_imp_euler_liar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> totatives_less<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Carmichael_Numbers">
<div class="head">
<h1>Theory Carmichael_Numbers</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Carmichael_Numbers.thy
  Authors:  Daniel Stüwe

  Definition and basic properties of Carmichael numbers
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Carmichael Numbers›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Carmichael_Numbers
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Residues_Nat.html">Residues_Nat</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A Carmichael number is a composite number <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> that Fermat's test incorrectly labels
  as primes no matter which witness <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> is chosen (except in the case that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> shares a
  factor with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>). \cite{Carmichael_numbers, wiki:Carmichael_number}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Carmichael_number</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Carmichael_number</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¬</span>prime <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">a</span> <span class="main">^</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_0<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Carmichael_number <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_1<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Carmichael_number <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_number_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_Suc_0<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Carmichael_number <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_number_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_not_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span> <span class="main">⟹</span> <span class="main">¬</span>prime <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_number_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_gt_3<span class="main">:</span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_number_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> Carmichael_number_not_prime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The proofs are inspired by \cite{Carmichael_numbers, Carmichael_number_square_free}.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_imp_squarefree_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="free">r</span> <span class="main">*</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Carmichael_number <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> * <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Carmichael_number <span class="free">n</span>›</span></span> that
    <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gre1I_nat<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">r</span>›</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span><span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">r</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_one_right power_strict_increasing_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> less_le_trans n <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> binary_chinese_remainder_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">r</span>"</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> prime_imp_coprime_nat coprime_power_left_iff <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lucas_coprime_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> cong_imp_coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">r</span>"</span></span><span class="main">]</span> 
      <span class="keyword2"><span class="keyword">and</span></span> coprime_add_one_left cong_sym 
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="main">^</span> <span class="free">r</span> <span class="main">*</span> <span class="free">l</span>›</span></span> coprime_mult_right_iff coprime_power_right_iff power_one_right
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n cong_modulus_mult_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_scalar_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">r</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power_Suc2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">r</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">^</span><span class="main">(</span><span class="free">r</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_add power_Suc<span class="main">)</span>
   
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">r</span>›</span></span> A cong_modulus_mult_nat <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="free">r</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> cong_def power_mod<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">1</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> binomial<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">1</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">1</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> finite_atMost<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.subset_diff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">..</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_altdef_nat <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">^</span> <span class="free">r</span> <span class="main">=</span> <span class="free">p</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>›</span></span> n<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">1</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_eq_0_I<span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_0_iff le_imp_power_dvd<span class="main">)</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> cong_trans<span class="main">[</span><span class="operator">OF</span> cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span> 2<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> residue_one_dvd<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> One_nat_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def numeral_2_eq_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Carmichael_number_imp_squarefree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> squarefreeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Carmichael_number_gt_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_unit <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_divisor_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">^</span> multiplicity <span class="skolem">p</span> <span class="free">n</span> <span class="main">*</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiplicity_dvd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiplicity_decompose'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_dvd_1_iff_1 nat_mult_eq_cancel1 neq0_conv prime_prime_factor_sqrt zero_less_power<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> multiplicity <span class="skolem">p</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multiplicity_geI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
    
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_squarefree_aux<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Carmichael_number <span class="free">n</span>›</span></span> n<span class="main">]</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> Carmichael_not_primepow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>primepow <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_squarefree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> Carmichael_number_not_prime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms
        primepow_gt_0_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_squarefree_primepow<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_imp_squarefree_alt_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">*</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">¬</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_gt_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_squarefree assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prime_divisor_exists_strong_nat prime_gt_1_nat
    <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹squarefree <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> multiplicity_eq_zero_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> squarefree_factorial_semiring''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">n</span>›</span></span> multiplicity_decompose'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Carmichael_number_odd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> odd <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Carmichael_number_gt_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹even <span class="free">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="numeral">4</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> odd_pow_cong<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> cong_sym<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="numeral">4</span> <span class="main">≤</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≥</span> <span class="numeral">4</span>›</span></span> coprime_diff_one_left_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_imp_squarefree_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">*</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">¬</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="bound">l</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="bound">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_squarefree_alt_weak <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Carmichael_number_odd <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">l</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹Carmichael_number <span class="free">n</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_imp_dvd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Carmichael_number<span class="main">:</span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Carmichael_number <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_squarefree assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> not_prime_unit<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square squarefree_def <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">u</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> Residues_nat <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> residues_nat_prime <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">R</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> R_def<span class="main">)</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"units.ord <span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> residues_prime_cyclic' <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> totatives <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_prime <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">u</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_imp_coprime_nat<span class="main">)</span> 

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> binary_chinese_remainder_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> totatives <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cong_imp_coprime<span class="main">[</span><span class="operator">OF</span> cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_commute totatives_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="skolem">u</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> coprime_1_left <span class="keyword2"><span class="keyword">and</span></span> cong_imp_coprime<span class="main">[</span><span class="operator">OF</span> cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">u</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">u</span>›</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_pow<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_sym_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number <span class="quoted"><span class="quoted">‹coprime <span class="skolem">x</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">u</span>›</span></span> cong_modulus_mult_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">p</span> <span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ord_divides <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">p</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> totatives <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> units.ord_residue_mult_group<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma is also called Korselt's criterion.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Carmichael_numberI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          DIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">n</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> assms conjI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">∏</span><span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_factorization_nat <span class="keyword2"><span class="keyword">and</span></span> squarefree_factorial_semiring'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹squarefree <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> prime_factorization <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">∈#</span> prime_factorization <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">⟹</span> coprime <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> in_prime_factors_imp_prime primes_coprime
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> 
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈#</span> prime_factorization <span class="free">n</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">a</span> <span class="free">n</span>›</span></span> p coprime_common_divisor_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_prime_factors_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fermat_theorem<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ord <span class="skolem">p</span> <span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ord_divides<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> DIV<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ord_divides<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n coprime_cong_prod_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Carmichael_number_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span> <span class="main">⟷</span>
     <span class="free">n</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¬</span>prime <span class="free">n</span> <span class="main">∧</span> squarefree <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">n</span><span class="main">.</span> <span class="bound">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Carmichael_numberI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> Carmichael_number_imp_dvd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_number_not_prime Carmichael_number_imp_squarefree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Every Carmichael number has at least three distinct prime factors.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> Carmichael_number_card_prime_factors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_gt_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Carmichael_number_gt_3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factorization_empty_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_prime_factor_iff_primepow Carmichael_not_primepow<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">n</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Suc_eq numeral_2_eq_2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_prime_factors_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">∏</span><span class="main">(</span>prime_factors <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> squarefree_imp_prod_prime_factors_eq<span class="main">)</span>
                   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_number_imp_squarefree<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> pq <span class="keyword1"><span class="command">have</span></span> n_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms pq
    <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_wlog<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>le <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def le_mod_geq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_diff_nat cong_mult<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span>›</span></span> cong_sym_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mod_less<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_iff'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡</span> prime_factorization <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span> <span class="main">⟷</span>
           <span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> size <span class="free">P</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈#</span><span class="free">P</span><span class="main">.</span> count <span class="free">P</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def squarefree_factorial_semiring' count_prime_factorization<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The smallest Carmichael number is 561, and it was found and proven so by
  Carmichael in 1910~\cite{carmichael1910note}.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Carmichael_number_561<span class="main">:</span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="numeral">561</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="var">?n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime_factorization <span class="main">(</span><span class="numeral">561</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="numeral">3</span><span class="main">,</span> <span class="numeral">11</span><span class="main">,</span> <span class="numeral">17</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_factorization_eqI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Carmichael_number_iff'<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Fermat_Witness">
<div class="head">
<h1>Theory Fermat_Witness</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Fermat_Witness.thy
  Authors:  Daniel Stüwe

  Fermat witnesses as used in Fermat's test
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fermat Witnesses›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Fermat_Witness
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Euler_Witness.html">Euler_Witness</a> <a href="Carmichael_Numbers.html">Carmichael_Numbers</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divide_out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_semiring <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divide_out</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">^</span> multiplicity <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> multiplicity <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fst_divide_out <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>divide_out <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snd_divide_out <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>divide_out <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> multiplicity <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_out_def<span class="main">)</span>


<span class="keyword1"><span class="command">function</span></span> <span class="entity">divide_out_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_semiring <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divide_out_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> is_unit <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">divide_out_aux</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> multiplicity <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">acc</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> is_unit <span class="skolem">p</span> <span class="main">∨</span> <span class="main">¬</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">acc</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">acc</span><span class="main">)</span> <span class="main">∈</span> measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> multiplicity <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvdE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiplicity_times_same<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> divide_out_aux.simps

<span class="keyword1"><span class="command">lemma</span></span> divide_out_aux_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"divide_out_aux <span class="free">p</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">z</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="main">(</span>fst <span class="free">z</span><span class="main">)</span><span class="main">,</span> snd <span class="free">z</span> <span class="main">+</span> multiplicity <span class="free">p</span> <span class="main">(</span>fst <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> divide_out_aux.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">acc</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> is_unit <span class="skolem">p</span> <span class="main">∨</span> <span class="main">¬</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">^</span> multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">^</span> multiplicity <span class="skolem">p</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dvd_div_mult2_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvdE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiplicity_dvd multiplicity_times_same<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> divide_out_aux.simps<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> dvdE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiplicity_times_same multiplicity_unit_left
                                not_dvd_imp_multiplicity_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divide_out_aux.simps multiplicity_unit_left not_dvd_imp_multiplicity_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divide_out_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"divide_out <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> divide_out_aux <span class="free">p</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_out_aux_correct divide_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> multiplicity_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span>divide_out_aux <span class="free">p</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_out_aux_correct<span class="main">)</span>

<span class="comment1">(* TODO Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> multiplicity_times_same_power<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_unit <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"multiplicity <span class="free">p</span> <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> multiplicity <span class="free">p</span> <span class="free">x</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiplicity_times_same mult.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> divide_out_unique_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_unit <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> multiplicity <span class="free">p</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> multiplicity <span class="free">p</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms multiplicity_times_same_power not_dvd_imp_multiplicity_0<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fermat_liar</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fermat_witness</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">strong_fermat_liar</span> <span class="main">⟷</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> odd <span class="bound">m</span> <span class="main">⟶</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">⟶</span>
                 <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="bound">k</span><span class="main">}</span><span class="main">.</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">strong_fermat_witness</span> <span class="main">⟷</span> <span class="main">¬</span> strong_fermat_liar"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fermat_liar_witness_of_composition<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>fermat_liar <span class="main">=</span> fermat_witness"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>fermat_witness <span class="main">=</span> fermat_liar"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fermat_liar_def <span class="keyword2"><span class="keyword">and</span></span> fermat_witness_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strong_fermat_liar_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strong_fermat_liar <span class="main">⟷</span> 
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> divide_out <span class="numeral">2</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="bound">k</span><span class="main">}</span><span class="main">.</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> multiplicity <span class="numeral">2</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> multiplicity <span class="numeral">2</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> mk<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="skolem">m</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True multiplicity_decompose<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> multiplicity_dvd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def k_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="skolem">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True mk <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divide_out_def strong_fermat_liar_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def divide_out_def m_def k_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> divide_out_unique_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">2</span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_fermat_liar_def divide_out_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_fermat_liar_def divide_out_def<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> * <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strong_fermat_witness_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strong_fermat_witness <span class="main">=</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> odd <span class="bound">m</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="bound">m</span> <span class="main">∧</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="bound">m</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> 
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span><span class="main">}</span><span class="main">.</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strong_fermat_witness_def strong_fermat_liar_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> not_coprime_imp_witness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="free">a</span> <span class="free">n</span> <span class="main">⟹</span> fermat_witness"</span></span>
  <span class="keyword1"><span class="command">using</span></span> * lucas_coprime_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fermat_witness_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> liar_imp_coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"fermat_liar <span class="main">⟹</span> coprime <span class="free">a</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_coprime_imp_witness fermat_liar_witness_of_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fermat_witness_imp_strong_fermat_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"fermat_witness"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strong_fermat_witness"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹fermat_witness›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fermat_witness_def <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiplicity_decompose'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span> n ord_divides <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inc_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> base
        <span class="keyword1"><span class="command">have</span></span> * <span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> n semiring_normalization_rules<span class="main">(</span>27<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> nat"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_even_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> square_minus_one_cong_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> square_one_cong_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> * <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_even_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH2 <span class="keyword2"><span class="keyword">and</span></span> square_minus_one_cong_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH2 <span class="keyword2"><span class="keyword">and</span></span> square_one_cong_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> strong_fermat_witness_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> strong_fermat_liar_imp_fermat_liar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"strong_fermat_liar"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"fermat_liar"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fermat_witness_imp_strong_fermat_witness assms
    <span class="keyword2"><span class="keyword">and</span></span> fermat_liar_witness_of_composition strong_fermat_witness_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> euler_liar_is_fermat_liar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"euler_liar <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fermat_liar"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Jacobi <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹euler_liar <span class="free">a</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span>Jacobi <span class="free">a</span> <span class="free">n</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_pow<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Jacobi_values Jacobi_eq_0_iff_not_coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹coprime <span class="free">a</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_int_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_mult<span class="main">)</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> cong_sym fermat_liar_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> fermat_witness_is_euler_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"fermat_witness"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"euler_witness <span class="free">a</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms euler_liar_is_fermat_liar fermat_liar_witness_of_composition
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_is_fermat_liar<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> fermat_liar <span class="main">1</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fermat_liar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> one_is_strong_fermat_liar<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> strong_fermat_liar <span class="main">1</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strong_fermat_liar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_imp_fermat_liar<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">⟹</span> fermat_liar <span class="free">a</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fermat_liar_def
  <span class="keyword1"><span class="command">using</span></span> fermat_theorem <span class="keyword2"><span class="keyword">and</span></span> nat_dvd_not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Carmichael_numberD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Carmichael_number <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">.</span> fermat_witness <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">a</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span> <span class="main"><span class="main">:</span></span> gre1I_nat<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span>  <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fermat_witness <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fermat_witness_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> one_is_fermat_liar fermat_liar_witness_of_composition<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fermat_witness <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> prime_imp_strong_fermat_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strong_fermat_liar <span class="free">a</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fermat_theorem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">p</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gr0I<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span> <span class="main">0</span>"</span></span><span class="main">]</span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power2_eq_square power_even_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span> "</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_square_alt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> strong_fermat_liar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ignore_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">1</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">1</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="main">1</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">a</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">a</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_insert_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofs in the following section are inspired by \cite{Cornwell, MillerRabinTest, lecture_notes}.›</span></span>

<span class="keyword1"><span class="command">proposition</span></span> not_Carmichael_number_imp_card_fermat_witness_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Carmichael_number <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> fermat_witness <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Residues_Mult <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> residues_mult_nat <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">G</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main">:</span> G_def›</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ker</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ker</span> <span class="main">=</span> kernel <span class="skolem">G</span> <span class="main">(</span><span class="skolem">G</span><span class="main">⦇</span>carrier <span class="main">:=</span> <span class="skolem">h</span> <span class="main">`</span> carrier <span class="skolem">G</span><span class="main">⦈</span><span class="main">)</span> <span class="skolem">h</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">ker</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ker_def kernel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> <span class="skolem">ker</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ker_def kernel_def h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">ker</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_gt_0_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ker_def kernel_def h_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> totatives_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"totatives <span class="free">n</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> coprime <span class="bound">k</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> totatives_less<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ker_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ker</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ker_def fermat_liar_def carrier_eq kernel_def totatives_eq <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def cong_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> coprimeI_power_mod<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> h_is_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> hom <span class="skolem">G</span> <span class="skolem">G</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> hom_def <span class="keyword1"><span class="command">using</span></span> nat_pow_closed
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def power_mult_distrib <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> h<span class="main">:</span> group_hom <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="skolem">h</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"fermat_witness <span class="skolem">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms power_one not_Carmichael_numberD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fermat_witness_def cong_def h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="skolem">h</span> <span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">h</span> <span class="main">`</span> carrier <span class="skolem">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="skolem">h</span> <span class="main">`</span> carrier <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> <span class="skolem">h</span> <span class="main">`</span> carrier <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">h</span> <span class="main">`</span> carrier <span class="skolem">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> card <span class="skolem">ker</span> <span class="main">=</span> order <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> homomorphism_thm_order<span class="main">[</span><span class="operator">OF</span> h.group_hom_axioms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ker_def order_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">G</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> totient_less_not_prime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">ker</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> card <span class="skolem">ker</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">ker</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="skolem">ker</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Diff_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ker_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="skolem">ker</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> fermat_witness <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fermat_witness_def fermat_liar_def ker_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> fermat_witness <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">ker</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ker_altdef fermat_liar_def fermat_witness_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="skolem">ker</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Diff_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ker_altdef fermat_liar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">ker</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">ker</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">≤</span>
          card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> strong_fermat_liar_imp_fermat_liar<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> *
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">proposition</span></span> Carmichael_number_imp_lower_bound_on_strong_fermat_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Carmichael_number<span class="main">:</span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_witness <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Carmichael_number_gt_3<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_unit <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiplicity_decompose'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>is_unit <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_squarefree_alt<span class="main">[</span><span class="operator">OF</span> Carmichael_number<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">p</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_imp_coprime_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Carmichael_number_odd Carmichael_number <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

  <span class="keyword1"><span class="command">note</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> n <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> prime_ge_2_nat
               <span class="keyword2"><span class="keyword">and</span></span> dvd_triv_left le_neq_implies_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">k</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span>
                                                     <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> k <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number <span class="keyword1"><span class="command">unfolding</span></span> Carmichael_number_def n_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">m'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiplicity_decompose'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_dvd<span class="main">[</span><span class="operator">OF</span> Carmichael_number <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> n_less p_less
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">m'</span>›</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> coprime_dvd_mult_left_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="skolem">k'</span>"</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="skolem">k</span>"</span></span><span class="main">]</span> coprime_dvd_mult_right_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m'</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_coprime_right_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> p_less<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> fermat_theorem <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="skolem">m</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> p_less n_less
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dvd_trans ord_divides<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> j_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">j</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">using</span></span> that LeastI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">,</span> <span class="operator">OF</span> k'<span class="main">,</span> <span class="operator">folded</span> j_def<span class="main">]</span> cong_modulus_mult coprime_mult_right_iff 
    <span class="keyword1"><span class="command">unfolding</span></span> j_def n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> j_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_iff_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">c</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_mult <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power_add<span class="main">)</span>
    
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> j_prop<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">a</span> <span class="skolem">p</span>›</span></span><span class="main">]</span>
   
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> neq_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cong_less_modulus_unique_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k'</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> k'<span class="main"><span class="main">,</span></span> <span class="operator">folded</span> j_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gr0I<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="skolem">p</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coprime_diff_one_left_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>  prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">m</span>›</span></span> odd_pow_cong<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹odd <span class="skolem">m</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">folded</span> j_def<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> Residues_Mult <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> residues_mult_nat <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">G</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main">:</span> G_def›</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> H_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> carrier <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">interpret</span></span> H<span class="main">:</span> subgroup <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="skolem">G</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subgroupI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> H_subset <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="keyword1">inv</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> <span class="skolem">a</span>"</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier <span class="skolem">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H_subset <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> carrier_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">y</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> totatives_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H_subset r_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_pow<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> * <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span> <span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">note</span></span> *
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> minus_one_cong_solve<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span> * <span class="quoted"><span class="quoted">‹coprime <span class="skolem">a</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">y</span> <span class="free">n</span> ›</span></span>coprime_power_left_iff
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">H</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def totatives_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> totatives_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def x_def y_def cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_mult<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * square_minus_one_cong_one'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def x_def y_def power_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> binary_chinese_remainder_unique_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> prime_imp_coprime_nat
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">x</span> <span class="skolem">p</span>›</span></span> cong_imp_coprime<span class="main">[</span><span class="operator">OF</span> cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> coprime_mult_right_iff
      <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">l</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> coprime_1_left cong_imp_coprime<span class="main">[</span><span class="operator">OF</span> cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">l</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">a</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> carrier <span class="skolem">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gre1I_nat <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n totatives_def<span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> cong_trans cong_pow cong_sym
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_modulus_mult_nat n <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_pow<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">l</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">≠</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_Suc_eq mod_less mod_mult_self2_is_0 numeral_2_eq_2 odd_Suc_minus_one zero_neq_numeral<span class="main">)</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def n <span class="dynamic"><span class="dynamic">mod_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cong_modulus_mult_nat<span class="main">)</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> cong_modulus_mult_nat mult.commute n <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊂</span> carrier <span class="main">(</span><span class="skolem">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H_subset subgroup.mem_carrier <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> carrier <span class="main">(</span><span class="skolem">G</span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">H</span> <span class="main">≤</span> order <span class="skolem">G</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> proper_subgroup_imp_bound_on_card<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">⊂</span> carrier <span class="skolem">G</span>›</span></span> H.is_subgroup <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Carmichael_number_not_prime<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">G</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> totient_less_not_prime<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> prime <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">H</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="skolem">m</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_trans dvd_triv_right ord_divides<span class="main">)</span>
    
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"strong_fermat_liar <span class="skolem">a</span> <span class="free">n</span>"</span></span>
  
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> strong_fermat_liar_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">m</span>›</span></span> n_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">using</span></span> cong_modulus_mult_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> cong_altdef_nat<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_dvd_not_less<span class="main">)</span>

        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd_diffD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> Suc <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_sym <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_least<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">a</span> <span class="skolem">p</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> square_minus_one_cong_one<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square power_mult power_mult_distrib<span class="main">)</span>
  
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> power_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cong_pow_I <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_mult <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power_add<span class="main">)</span>
          
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span>
  
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> "</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> even_pow_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="skolem">i</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
  
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">H</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> strong_fermat_liar_imp_fermat_liar<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span><span class="main">]</span>  liar_imp_coprime
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> H_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> strong_fermat_liar_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">H</span></span><span class="main">]</span> le_less_trans<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹card <span class="skolem">H</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_witness <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> strong_fermat_witness_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_witness <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_Diff_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> strong_fermat_witness <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strong_fermat_liar_bounded ignore_one one_is_strong_fermat_liar <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> strong_fermat_witness_lower_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> strong_fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">&lt;</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Carmichael_number_imp_lower_bound_on_strong_fermat_witness<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
        not_Carmichael_number_imp_card_fermat_witness_bound<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Generalized_Primality_Test">
<div class="head">
<h1>Theory Generalized_Primality_Test</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Generalized_Primality_Test.thy
  Authors:  Daniel Stüwe, Manuel Eberl

  Generic probabilistic primality test
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Generic View on Probabilistic Prime Tests›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Generalized_Primality_Test
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span> 
  <a href="Algebraic_Auxiliaries.html">Algebraic_Auxiliaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primality_test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primality_test</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="numeral">3</span> <span class="main">∨</span> even <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> return_pmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">else</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">a</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">;</span>
        return_pmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">a</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="comment1">(* TODO Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> expectation_of_bool_is_pmf<span class="main">:</span> <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="free">M</span> of_bool <span class="main">=</span> pmf <span class="free">M</span> True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integral_measure_pmf_real<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span> UNIV_bool<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_bernoulli_pmfI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> True <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> bernoulli_pmf <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">bool</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pmf <span class="free">p</span> <span class="skolem">b</span> <span class="main">=</span> pmf <span class="main">(</span>bernoulli_pmf <span class="free">x</span><span class="main">)</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_False_conv_True<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We require a probabilistic primality test to never classify a prime as composite.
  It may, however, mistakenly classify composites as primes.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> prob_primality_test <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_works<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> prime <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">n</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FalseD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> false<span class="main">:</span> <span class="quoted"><span class="quoted">"False <span class="main">∈</span> set_pmf <span class="main">(</span>primality_test <span class="free">P</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> false <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span> <span class="main">|</span> 
      <span class="skolem">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">n</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primality_test_def not_less <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_neqE_nat<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> prime_ge_2_nat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> primes_dvd_imp_eq two_is_prime_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P_works <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> odd_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"primality_test <span class="free">P</span> <span class="free">n</span> <span class="main">=</span> return_pmf True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>primality_test <span class="free">P</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False <span class="main">∉</span> set_pmf <span class="main">(</span>primality_test <span class="free">P</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FalseD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>primality_test <span class="free">P</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_pmf_subset_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We call a primality test <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>-good for a fixed positive real number <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> if the probability
  that it mistakenly classifies a composite as a prime is less than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> good_prob_primality_test <span class="main">=</span> prob_primality_test <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> composite_witness_bound<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> odd <span class="free">n</span> <span class="main">⟹</span>
               real <span class="main">(</span>card <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">n</span> <span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> composite_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf.expectation <span class="main">(</span>primality_test <span class="free">P</span> <span class="free">n</span><span class="main">)</span> of_bool <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primality_test_def <span class="keyword1"><span class="command">using</span></span> assms composite_witness_bound q_pos
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_expectation_bind<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> sum_of_bool_eq_card <span class="dynamic"><span class="dynamic">field_simps</span></span>
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> composite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>primality_test <span class="free">P</span> <span class="free">n</span><span class="main">)</span> True <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> composite_aux<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expectation_of_bool_is_pmf<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Fermat_Test">
<div class="head">
<h1>Theory Fermat_Test</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Fermat_Test.thy
  Authors:  Daniel Stüwe, Manuel Eberl

  The probabilistic prime test known as Fermat's test
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fermat's Test›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Fermat_Test
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Fermat_Witness.html">Fermat_Witness</a>
  <a href="Generalized_Primality_Test.html">Generalized_Primality_Test</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fermat_test</span> <span class="main">=</span> primality_test <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> fermat_liar <span class="bound">a</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Fermat test is a good probabilistic primality test on non-Carmichael numbers.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> fermat_test_not_Carmichael_number <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_Carmichael_number<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Carmichael_number <span class="free">n</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">3</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> fermat_test<span class="main">:</span> good_prob_primality_test <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">n</span><span class="main">.</span> fermat_liar <span class="bound">n</span> <span class="bound">a</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"primality_test <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">n</span><span class="main">.</span> fermat_liar <span class="bound">n</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> fermat_test"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good_prob_primality_test <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">n</span><span class="main">.</span> fermat_liar <span class="bound">n</span> <span class="bound">a</span><span class="main">)</span> <span class="free">n</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_Carmichael_number not_Carmichael_number_imp_card_fermat_witness_bound<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
          prime_imp_fermat_liar<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fermat_test_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_coprime_imp_fermat_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="free">a</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fermat_witness <span class="free">a</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lucas_coprime_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fermat_witness_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> fermat_test_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fermat_test <span class="free">n</span> <span class="main">=</span> return_pmf True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fermat_test_not_Carmichael_number <span class="quoted"><span class="free">n</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Carmichael_number_not_prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fermat_test.prime<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fermat_test_composite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Carmichael_number <span class="free">n</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>fermat_test <span class="free">n</span><span class="main">)</span> True <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fermat_test_not_Carmichael_number <span class="quoted"><span class="free">n</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fermat_test.composite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For a Carmichael number $n$, Fermat's test as defined above mistakenly returns `True'
  with probability $(\varphi(n)-1) / (n - 2)$. This probability is close to 1 if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>
  has few and big prime factors; it is not quite as bad if it has many and/or small factors,
  but in that case, simple trial division can also detect compositeness.

  Moreover, Fermat's test only succeeds for a Carmichael number if it happens to guess a
  number that is not coprime to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>. In that case, the fact that we have found
  a number between 2 and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> that is not coprime to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> alone is 
  proof that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> is composite, and indeed we can even find a non-trivial factor
  by computing the GCD. This means that for Carmichael numbers, Fermat's test is essentially
  no better than the very crude method of attempting to guess numbers coprime to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>.

  This means that, in general, Fermat's test is not very helpful for Carmichael numbers.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> fermat_test_Carmichael_number<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Carmichael_number <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fermat_test <span class="free">n</span> <span class="main">=</span> bernoulli_pmf <span class="main">(</span>real <span class="main">(</span>totient <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_bernoulli_pmfI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Carmichael_number_odd Carmichael_number_gt_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fermat_test <span class="free">n</span> <span class="main">=</span> pmf_of_set <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> return_pmf <span class="main">(</span>fermat_liar <span class="bound">a</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fermat_test_def primality_test_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf_of_set <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> return_pmf <span class="main">(</span>coprime <span class="bound">a</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n assms lucas_coprime_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Carmichael_number_def fermat_liar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">…</span> True <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> indicat_real <span class="main">{</span>True<span class="main">}</span> <span class="main">(</span>coprime <span class="bound">a</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_bind_pmf_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> indicat_real <span class="main">{</span>True<span class="main">}</span> <span class="main">(</span>coprime <span class="bound">a</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">a</span></span> <span class="main">|</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">a</span> <span class="free">n</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> totatives <span class="free">n</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def order.strict_iff_order<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> totient <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Diff_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totient_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>fermat_test <span class="free">n</span><span class="main">)</span> True <span class="main">=</span> real <span class="main">(</span>totient <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Miller_Rabin_Test">
<div class="head">
<h1>Theory Miller_Rabin_Test</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Miller_Rabin.thy
  Authors:  Daniel Stüwe, Manuel Eberl

  The Miller--Rabin primality test.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Miller--Rabin Test›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Miller_Rabin_Test
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Fermat_Witness.html">Fermat_Witness</a>
  <a href="Generalized_Primality_Test.html">Generalized_Primality_Test</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">miller_rabin</span> <span class="main">=</span> primality_test <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The test is actually $\frac{1}{4}$ good, but we only show $\frac{1}{2}$, since the former
  is much more involved.
›</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> miller_rabin<span class="main">:</span> good_prob_primality_test <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"primality_test <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> miller_rabin"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good_prob_primality_test <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">a</span><span class="main">.</span> strong_fermat_liar <span class="bound">a</span> <span class="bound">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> strong_fermat_witness_lower_bound prime_imp_strong_fermat_witness <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> miller_rabin_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Solovay_Strassen_Test">
<div class="head">
<h1>Theory Solovay_Strassen_Test</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Solovay_Strassen.thy
  Authors:  Daniel Stüwe, Manuel Eberl

  The Solovay--Strassen primality test.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Solovay--Strassen Test›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Solovay_Strassen_Test
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Generalized_Primality_Test.html">Generalized_Primality_Test</a>
  <a href="Euler_Witness.html">Euler_Witness</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solovay_strassen_witness</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solovay_strassen_witness</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> Jacobi <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">x</span> <span class="main">=</span> int <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solovay_strassen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solovay_strassen</span> <span class="main">=</span> primality_test solovay_strassen_witness"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_imp_solovay_strassen_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"solovay_strassen_witness <span class="free">p</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Jacobi <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> Legendre <span class="free">a</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_p_Jacobi_eq_Legendre assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_imp_coprime<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> solovay_strassen_witness_def Let_def eq
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="free">p</span> <span class="free">a</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span>int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Legendre <span class="main">(</span>int <span class="free">a</span><span class="main">)</span> <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="main">=</span> int <span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> euler_criterion<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> card_solovay_strassen_liars_composite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> solovay_strassen_witness <span class="free">n</span> <span class="bound">a</span><span class="main">}</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> euler_witness_context <span class="quoted"><span class="free">n</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> euler_witness_context_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card H <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_euler_liars_cosets_limit<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"H <span class="main">=</span> insert <span class="main">1</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solovay_strassen_witness_def Let_def
                   euler_witness_def H_def Jacobi_eq_0_iff_not_coprime<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="var">?A</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card.insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> solovay_strassen<span class="main">:</span> good_prob_primality_test <span class="quoted">solovay_strassen_witness</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"primality_test solovay_strassen_witness <span class="main">=</span> solovay_strassen"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good_prob_primality_test solovay_strassen_witness <span class="free">n</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">∧</span> solovay_strassen_witness <span class="skolem">n</span> <span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_solovay_strassen_liars_composite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> prime_imp_solovay_strassen_witness <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solovay_strassen_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>