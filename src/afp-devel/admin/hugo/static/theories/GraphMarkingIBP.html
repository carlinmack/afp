<div id="Graph">
<div class="head">
<h1>Theory Graph</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Address Graph›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Graph
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory introduces the graph to be marked as a relation next on
nodes (addresses). We assume that we have a special node nil (the
null address). We have a node root from which we start marking the graph. 
We also assume that nil is not related by next to any node and any node is 
not related by next to nil.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> node <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nil</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">root</span>   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> graph <span class="main">=</span> node <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">next</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'node</span> <span class="main">×</span> <span class="tfree">'node</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_not_nil_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">!!</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="free">nil</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">next</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> next_not_nil_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">!!</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">nil</span><span class="main">)</span> <span class="main">∉</span> <span class="free">next</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
On lists of nodes we introduce two operations similar to
existing hd and tl for getting the head and the tail of
a list. The new function head applied to a nonempty list
returns the head of the list, and it reurns nil when
applied to the empty list. The function tail returns the
tail of the list when applied to a non-empty list, and
it returns the empty list otherwise.
›</span></span>
  <span class="keyword1"><span class="command">definition</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">head</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">nil</span> <span class="keyword1">else</span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
    
  <span class="keyword1"><span class="command">definition</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tail</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">nil</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_not_nil_left<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">nil</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_not_nil_right<span class="main">)</span>


  <span class="keyword1"><span class="command">theorem</span></span> head_not_nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>head <span class="free">S</span> <span class="main">≠</span> <span class="free">nil</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>head <span class="free">S</span> <span class="main">=</span> hd <span class="free">S</span> <span class="main">∧</span> tail <span class="free">S</span> <span class="main">=</span> tl <span class="free">S</span> <span class="main">∧</span> hd <span class="free">S</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> head_def tail_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">theorem</span></span> nonempty_head <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> head_def<span class="main">)</span>

  <span class="keyword1"><span class="command">theorem</span></span> nonempty_tail <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"tail <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tail_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
    <span class="quoted"><span class="quoted">"<span class="free">reach</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">nil</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> reach_nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">nil</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_induct<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>  reach_next<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> reach <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">∈</span> reach <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> 
    <span class="quoted"><span class="quoted">"<span class="free">path</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">mrk</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">mrk</span></span></span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">mrk</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SetMark">
<div class="head">
<h1>Theory SetMark</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Marking Using a Set›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SetMark
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Graph.html">Graph</a> <a href="../DataRefinementIBP/DataRefinement.html">DataRefinementIBP.DataRefinement</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
We construct in this theory a diagram which computes all reachable nodes
from a given root node in a graph. The graph is defined in the theory
Graph and is given by a relation $next$ on the nodes of the graph.

The diagram has only three ordered situation 
($\mathit{init} &gt; \mathit{loop} &gt; \mathit{final}$). The termination
variant is a pair of a situation and a natural number with the lexicographic
ordering. The idea of this ordering is that we can go from a bigger situation
to a smaller one, however if we stay in the same situation the second
component of the variant must decrease.

The idea of the algorithm is that it starts with a set $X$ containing the
root element and the root is marked. As long as $X$ is not empty, if $x\in X$ 
and $y$ is an unmarked sucessor of $x$ we add $y$ to $X$. If $x\in X$ has
no unmarked sucessors it is removed from $X$. 
The algorithm terminates when $X$ is empty.  
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> I <span class="main">=</span> init <span class="main">|</span> loop <span class="main">|</span> final

<span class="keyword1"><span class="command">declare</span></span> I.split <span class="main">[</span><span class="operator">split</span><span class="main">]</span>


<span class="keyword1"><span class="command">instantiation</span></span> I <span class="main">::</span> <span class="quoted">well_founded_transitive</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  less_I_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> init <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> loop <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> final<span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> loop <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> final<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  less_eq_I_def<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">::</span>I<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">::</span>I<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">I</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">then</span></span>  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_I_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">I</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_I_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">I</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">when</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> that<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> final"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> loop"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_I_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The set $\mathit{path}\ S \ \mathit{mrk}$ contains all reachable nodes from S along paths with
unmarked nodes.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trascl_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∨</span>  <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> 
    b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">R</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> 
    P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟶</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∨</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">O</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rtrancl_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Compl_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ya</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">ya</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> z <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">z</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rtrancl_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">za</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">ya</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">za</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> z <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">z</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rtrancl_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> add_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> path <span class="free">S</span> <span class="free">mrk</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> path <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">mrk</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">ya</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">-</span> <span class="free">mrk</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trascl_less<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">ya</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> <span class="free">mrk</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relcomp_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">ya</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> <span class="free">mrk</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> insert <span class="free">y</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> insert <span class="free">y</span> <span class="free">mrk</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relcomp_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">yaa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> <span class="free">mrk</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> insert <span class="free">y</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> insert <span class="free">y</span> <span class="free">mrk</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> add_set2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> path <span class="free">S</span> <span class="free">mrk</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> path <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> add_set<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> del_stack <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span>  <span class="free">mrk</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> path <span class="free">S</span> <span class="free">mrk</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> path <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">mrk</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">xa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="improper">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">mrk</span><span class="main">)</span> <span class="main">×</span> <span class="main">-</span> <span class="free">mrk</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rtranclD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tranclD<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> init_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> reach <span class="free">root</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">root</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> path <span class="main">{</span><span class="free">root</span><span class="main">}</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def path_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">≠</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">root</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">root</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">next</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trascl_less<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Compl_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">root</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">next</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rtranclD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">root</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> tranclD<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>  init_set2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> reach <span class="free">root</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> path <span class="main">{</span><span class="free">root</span><span class="main">}</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">root</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">≠</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> init_set<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q1_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">X'</span><span class="main">,</span> <span class="bound">mrk'</span><span class="main">.</span> <span class="main">(</span><span class="free">root</span><span class="main">::</span><span class="tfree">'node</span><span class="main">)</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">X'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q2_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">X'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
       <span class="main">(</span><span class="free">root</span><span class="main">::</span><span class="tfree">'node</span><span class="main">)</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">X'</span> <span class="main">=</span> <span class="main">{</span><span class="free">root</span><span class="main">::</span><span class="tfree">'node</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="main">{</span><span class="free">root</span><span class="main">::</span><span class="tfree">'node</span><span class="main">}</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q3_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">X'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
        <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">mrk</span> <span class="main">∧</span> <span class="bound">X'</span> <span class="main">=</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q4_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">X'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>  
        <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">X'</span> <span class="main">=</span> <span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">)</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q5_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">X'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="bound">mrk</span> <span class="main">=</span> <span class="bound">mrk'</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Loop</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span>
      finite <span class="main">(</span><span class="main">-</span><span class="bound">mrk</span><span class="main">)</span> <span class="main">∧</span> finite <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="bound">mrk</span> <span class="main">∧</span> 
      <span class="bound">mrk</span> <span class="main">⊆</span> reach <span class="free">root</span> <span class="main">∧</span> reach <span class="free">root</span> <span class="main">∩</span> <span class="main">-</span><span class="bound">mrk</span> <span class="main">⊆</span> path <span class="bound">X</span> <span class="bound">mrk</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trm</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">X</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span><span class="main">-</span><span class="bound">mrk</span><span class="main">)</span> <span class="main">+</span> card <span class="bound">X</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">term_eq</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">term_less</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> union_term_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">w</span> <span class="main">.</span> term_eq <span class="free">t</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> union_less_term_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">v</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">}</span><span class="main">.</span> term_eq <span class="free">t</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> term_less <span class="free">t</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_eq_def term_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">X</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> set<span class="main">)</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> set<span class="main">)</span><span class="main">)</span> <span class="main">.</span> finite <span class="main">(</span><span class="main">-</span><span class="bound">mrk</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">mrk</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Final</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">X</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> set<span class="main">)</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> set<span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="bound">mrk</span> <span class="main">=</span> reach <span class="free">root</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">SetMarkInv</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> Init <span class="main">|</span>
      I.loop  <span class="main">⇒</span> Loop <span class="main">|</span>
      I.final <span class="main">⇒</span> Final<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">SetMarkInvFinal</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.final  <span class="main">⇒</span> Final <span class="main">|</span>
      <span class="main"><span class="bound">_</span></span>  <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">SetMarkInvTerm</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> Init <span class="main">|</span>
      I.loop  <span class="main">⇒</span> Loop <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> trm <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span> <span class="main">|</span>
      I.final <span class="main">⇒</span> Final<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">SetMark</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>I.init<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> Q1_a <span class="main">⊓</span> Q2_a <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> Q3_a <span class="main">⊓</span> Q4_a <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.final<span class="main">)</span> <span class="main">⇒</span> Q5_a <span class="main">|</span>
       <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> top<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>  SetMark_dmono <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dmono SetMark"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dmono_def SetMark_def Q1_a_def Q2_a_def Q3_a_def Q4_a_def Q5_a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the transitions›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> init_loop_1_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> Init <span class="main">{|</span> Q1_a <span class="main">|}</span> Loop"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> hoare_demonic Init_def Q1_a_def Loop_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> init_loop_2_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> Init <span class="main">{|</span> Q2_a <span class="main">|}</span> Loop"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hoare_demonic Init_def Q2_a_def Loop_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> init_set2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> loop_loop_1_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="main">(</span>Loop <span class="main">∩</span>  <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> trm <span class="bound">s</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span><span class="main">)</span> <span class="main">{|</span> Q3_a <span class="main">|}</span> <span class="main">(</span>Loop <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> trm <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hoare_demonic Q3_a_def Loop_def trm_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Compl_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_set2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">-</span><span class="improper">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

 <span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> loop_loop_2_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="main">(</span>Loop <span class="main">∩</span>  <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> trm <span class="bound">s</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span><span class="main">)</span> <span class="main">{|</span> Q4_a <span class="main">|}</span> <span class="main">(</span>Loop <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> trm <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hoare_demonic Q4_a_def Loop_def trm_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"card <span class="improper">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

 <span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> loop_final_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> <span class="main">(</span>Loop <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> trm <span class="bound">s</span> <span class="main">=</span> <span class="free">w</span><span class="main">}</span><span class="main">)</span> <span class="main">{|</span> Q5_a <span class="main">|}</span> Final"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hoare_demonic Q5_a_def Loop_def Final_def subset_eq Int_def path_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> union_term_w<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">.</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">w</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> union_less_term_w<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">v</span><span class="main">∈</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span> <span class="main">.</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="free">A</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span>  <span class="main">(</span><span class="main">⋃</span> <span class="bound">w</span> <span class="main">.</span> <span class="free">A</span> <span class="bound">w</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> forall_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">≠</span> <span class="free">u</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span> <span class="free">A</span> <span class="main">.</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> forall_simp2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span>  <span class="main">=</span> <span class="free">t</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">b</span> <span class="main">≠</span> <span class="free">u</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram correctness›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The termination ordering for the $\mathit{SetMark}$ diagram is the lexicographic
ordering on pairs $(i,\, n)$ where $i\in I$ and $n\in \mathit{nat}$.
›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span>  DiagramTermination <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="bound">i</span> <span class="main">::</span> I<span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> SetMark_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊨</span> SetMarkInv <span class="main">{|</span>pt SetMark<span class="main">|}</span> SetMarkInvFinal"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> X <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"SetMarkInvTerm"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> hoare_diagram3<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dmono SetMark"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⊨</span> SetMarkInvTerm <span class="bound">u</span> <span class="bound">i</span><span class="main">{|</span> SetMark <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">|}</span>
    DiagramTermination.SUP_L_P <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> SetMarkInvTerm <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_L_P_def  less_pair_def less_I_def hoare_choice SetMark_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SetMarkInv <span class="main">≤</span> Sup <span class="main">(</span>range SetMarkInvTerm<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetMarkInv_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range SetMarkInvTerm<span class="main">)</span> <span class="main">⊓</span> <span class="main">-</span> grd <span class="main">(</span>step SetMark<span class="main">)</span> <span class="main">≤</span> SetMarkInvFinal"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def inf_fun_def SetMarkInvFinal_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"I.loop"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetMark_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q1_a_def Q2_a_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"I.loop"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"I.final"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetMark_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q3_a_def Q4_a_def Q5_a_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> SetMark_correct1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Hoare_dgr SetMarkInv SetMark <span class="main">(</span>SetMarkInv <span class="main">⊓</span> <span class="main">(</span><span class="main">-</span> grd <span class="main">(</span>step SetMark<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hoare_dgr_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted">SetMarkInvTerm</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"SetMarkInv <span class="main">=</span> <span class="main">⨆</span>range SetMarkInvTerm"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetMark_def SUP_L_P_def
       less_pair_def less_I_def hoare_choice<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> SetMarkInv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> stack_not_nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mrk</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> Loop <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">nil</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Loop_def reach_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="StackMark">
<div class="head">
<h1>Theory StackMark</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Marking Using a Stack›</span></span>

<span class="keyword1"><span class="command">theory</span></span> StackMark
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SetMark.html">SetMark</a> <a href="../DataRefinementIBP/DataRefinement.html">DataRefinementIBP.DataRefinement</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
In this theory we refine the set marking diagram to a diagram in which the
set is replaced by a list (stack). Iniatially the list contains the root element
and as long as the list is nonempty and the top of the list has an unmarked
successor $y$, then $y$ is added to the top of the list. If the top does not
have unmarked sucessors, it is removed from the list. The diagram terminates when
the list is empty.

The data refinement relation of the two diagrams is true if the list
has distinct elements and the elements of the list and the set are the same.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q1'_a</span> <span class="main">≡</span> <span class="main">[:</span><span class="main">λ</span> <span class="main">(</span><span class="bound">stk</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> list<span class="main">)</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> set<span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">stk'</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> list<span class="main">)</span><span class="main">,</span> <span class="bound">mrk'</span><span class="main">)</span> <span class="main">.</span> 
             <span class="free">root</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">stk'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">}</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q2'_a</span> <span class="main">≡</span> <span class="main">[:</span><span class="main">λ</span> <span class="main">(</span><span class="bound">stk</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> list<span class="main">)</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">::</span><span class="main">(</span><span class="tfree">'node</span> set<span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">stk'</span><span class="main">,</span> <span class="bound">mrk'</span><span class="main">)</span> <span class="main">.</span> 
         <span class="free">root</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">stk'</span> <span class="main">=</span> <span class="main">[</span><span class="free">root</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span><span class="main">}</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q3'_a</span> <span class="main">≡</span> <span class="main">[:</span><span class="main">λ</span> <span class="main">(</span><span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">stk'</span><span class="main">,</span> <span class="bound">mrk'</span><span class="main">)</span> <span class="main">.</span>  <span class="bound">stk</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="main">.</span> <span class="main">(</span>hd <span class="bound">stk</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span> <span class="main">∧</span> 
         <span class="bound">y</span> <span class="main">∉</span> <span class="bound">mrk</span> <span class="main">∧</span> <span class="bound">stk'</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">stk</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q4'_a</span> <span class="main">≡</span> <span class="main">[:</span><span class="main">λ</span> <span class="main">(</span><span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">stk'</span><span class="main">,</span> <span class="bound">mrk'</span><span class="main">)</span> <span class="main">.</span> <span class="bound">stk</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">.</span> <span class="main">(</span>hd <span class="bound">stk</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">next</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">stk'</span> <span class="main">=</span> tl <span class="bound">stk</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">}</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q5'_a</span> <span class="main">≡</span> <span class="main">[:</span><span class="main">λ</span> <span class="main">(</span><span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">stk'</span><span class="main">,</span> <span class="bound">mrk'</span><span class="main">)</span> <span class="main">.</span> <span class="bound">stk</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">}</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Init'</span> <span class="main">≡</span> UNIV"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Loop'</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span> distinct <span class="bound">stk</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Final'</span> <span class="main">≡</span> UNIV"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">StackMarkInv</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> Init' <span class="main">|</span>
      I.loop  <span class="main">⇒</span> Loop' <span class="main">|</span>
      I.final <span class="main">⇒</span> Final'<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data refinement relations›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R1_a</span> <span class="main">≡</span> <span class="main">{:</span> <span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">:}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R2_a</span> <span class="main">≡</span> <span class="main">{:</span> <span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> set <span class="bound">stk</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">∈</span> Loop' <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">:}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"R1_a <span class="main">∈</span> Apply.Disjunctive"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"R2_a <span class="main">∈</span> Apply.Disjunctive"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_a_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> R1_a <span class="main">|</span>
      I.loop  <span class="main">⇒</span> R2_a <span class="main">|</span>
      I.final <span class="main">⇒</span> R1_a<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Disjunctive_fun R_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Disjunctive_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">angelic_fun</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="main">.</span> <span class="main">{:</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span><span class="main">:}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">StackMark_a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>I.init<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> Q1'_a <span class="main">⊓</span> Q2'_a <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> Q3'_a <span class="main">⊓</span> Q4'_a <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.final<span class="main">)</span> <span class="main">⇒</span> Q5'_a <span class="main">|</span>
       <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">⊤</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data refinement of the transitions›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> init_nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Init<span class="main">.}</span> <span class="keyword1">o</span> Q1_a<span class="main">)</span> R1_a R2_a Q1'_a"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q1'_a_def Init_def 
     Loop'_def R1_a_def R2_a_def Q1_a_def angelic_def subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> init_root <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Init<span class="main">.}</span> <span class="keyword1">o</span> Q2_a<span class="main">)</span> R1_a R2_a Q2'_a"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q2'_a_def Init_def 
     Loop'_def R1_a_def R2_a_def Q2_a_def angelic_def subset_eq<span class="main">)</span>
   
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> step1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop<span class="main">.}</span> <span class="keyword1">o</span> Q3_a<span class="main">)</span> R2_a R2_a Q3'_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Loop_def 
    Loop'_def R2_a_def Q3_a_def Q3'_a_def angelic_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_in_set distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> step2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop<span class="main">.}</span> <span class="keyword1">o</span> Q4_a<span class="main">)</span> R2_a R2_a Q4'_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Loop_def 
    Loop'_def R2_a_def Q4_a_def Q4'_a_def angelic_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> final <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop<span class="main">.}</span> <span class="keyword1">o</span> Q5_a<span class="main">)</span>  R2_a R1_a Q5'_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Loop_def 
    Loop'_def R2_a_def R1_a_def Q5_a_def Q5'_a_def angelic_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp_eq_emptyset<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram data refinement›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> assert_comp_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{.</span><span class="free">p</span><span class="main">.}</span> <span class="keyword1">o</span> <span class="main">(</span><span class="free">S</span> <span class="main">⊓</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{.</span><span class="free">p</span><span class="main">.}</span> <span class="keyword1">o</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">{.</span><span class="free">p</span><span class="main">.}</span> <span class="keyword1">o</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff assert_def le_fun_def inf_fun_def inf_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="improper">x</span> <span class="main">⊓</span> <span class="free">T</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inf_le2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="improper">x</span> <span class="main">⊓</span> <span class="free">T</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inf_le2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="improper">x</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊓</span> <span class="free">T</span> <span class="improper">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inf_le2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="improper">x</span> <span class="main">⊓</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊓</span> <span class="free">T</span> <span class="improper">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inf_le2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⊓</span> <span class="free">T</span> <span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inf_le2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> StackMark_DataRefinement <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"DgrDataRefinement2 SetMarkInv SetMark R_a StackMark_a"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DgrDataRefinement2_def  StackMark_a_def SetMark_def demonic_sup_inf 
    SetMarkInv_def data_refinement_choice2 assert_comp_choice<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram correctness›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> StackMark_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Hoare_dgr <span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span> StackMark_a <span class="main">(</span><span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">-</span> grd <span class="main">(</span>step <span class="main">(</span>StackMark_a<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> D <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"SetMark"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Diagram_DataRefinement2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> SetMark_correct1<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LinkMark">
<div class="head">
<h1>Theory LinkMark</h1>
</div>
<pre class="source">
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generalization of Deutsch-Schorr-Waite Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LinkMark
<span class="keyword2"><span class="keyword">imports</span></span> <a href="StackMark.html">StackMark</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the third step the stack diagram is refined to a diagram where no extra 
memory is used. The relation $next$  is replaced by two new variables $link$ and $label$. 
The variable $\mathit{label}:\mathit{node}\to \mathit{index}$ associates a label to every node and the variable
$\mathit{link}: \mathit{index}\to \mathit{node}\to \mathit{node}$ is a collection of pointer functions indexed by the set  
$\mathit{index}$ of labels. For $x\in \mathit{node}$, $\mathit{link} \ i \ x$ is the successor node of $x$  along 
the function $\mathit{link} \ i$. In this context a node $x$ is reachable if there exists a path 
from the root to $x$  along the links $\mathit{link} \ i$  such that all nodes in this path are 
not $\mathit{nil}$ and they are labeled by a special label $\mathit{none}\in \mathit{index}$.

The stack variable $S$ is replaced by two new variables $p$ and $t$ ranging over nodes. Variable $p$ 
stores the head of $S$,  $t$ stores the head of the tail of $S$, and the rest of $S$ 
is stored by temporarily modifying the variables $\mathit{link}$ and $\mathit{label}$.

This algorithm is a generalization of the Deutsch-Schorr-Waite graph marking algorithm because
we have a collection of pointer functions instead of left and right only.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> pointer <span class="main">=</span> node <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">none</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">link0</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'node</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">label0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'index</span>"</span></span>
  <span class="comment1">(* next assume is used to bind the type variable 'node introduced in this locale to the 
    type variable 'node introduced in the locale node. *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nil</span><span class="main">::</span><span class="tfree">'node</span><span class="main">)</span> <span class="main">=</span> <span class="free">nil</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="main">=</span>  <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="main">.</span> <span class="free">link0</span> <span class="bound">i</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="free">label0</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">none</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> pointer <span class="main">⊆</span> link<span class="main">?</span><span class="main">:</span> graph <span class="quoted"><span class="quoted">"<span class="free">nil</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">root</span>"</span></span> <span class="quoted"><span class="quoted">"next"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> next_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The locale pointer fixes the initial values for the variables $ \mathit{link}$ and $ \mathit{label}$ and
it defines the relation next as the union of all $ \mathit{link} \ i$ functions, excluding
the mappings to $ \mathit{nil}$, the mappings from $ \mathit{nil}$ as well as the mappings from elements which
are not labeled by $ \mathit{none}$.
›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The next two recursive functions, $ \mathit{label}\_0$, $ \mathit{link}\_0$ are used to compute
the initial values of the variables $ \mathit{label}$ and $ \mathit{link}$ from their current
values.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> pointer
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">label_0</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'index</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'node</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'index</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
   <span class="quoted"><span class="quoted">"<span class="free">label_0</span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="main">[]</span>      <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="free">label_0</span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">label_0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lbl</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free">none</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> label_cong <span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">⟹</span> pointer.label_0 <span class="free">n</span> <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> pointer.label_0 <span class="free">n</span> <span class="free">g</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">link_0</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'node</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'index</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'node</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'node</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'node</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">link_0</span> <span class="free"><span class="bound"><span class="entity">lnk</span></span></span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span>       <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">lnk</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">link_0</span> <span class="free"><span class="bound"><span class="entity">lnk</span></span></span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>  <span class="main">=</span> <span class="free">link_0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lnk</span></span></span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">:=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">lnk</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The function $ \mathit{stack}$ defined bellow is the main data refinement relation connecting
the stack from the abstract algorithm to its concrete representation by temporarily
modifying the variable $ \mathit{link}$ and $ \mathit{label}$.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">stack</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'node</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'index</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'node</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'node</span> list<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free"><span class="bound"><span class="entity">lnk</span></span></span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span>       <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">nil</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stack</span> <span class="free"><span class="bound"><span class="entity">lnk</span></span></span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>  <span class="main">=</span> 
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">stack</span> <span class="free"><span class="bound"><span class="entity">lnk</span></span></span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lnk</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> label_out_range0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟹</span> label_0 <span class="free">lbl</span> <span class="free">S</span> <span class="free">x</span> <span class="main">=</span> <span class="free">lbl</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">label</span> <span class="main">.</span> <span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟶</span> label_0 <span class="bound">label</span> <span class="free">S</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">label</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mp<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> link_out_range0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟹</span> link_0 <span class="free">link</span> <span class="free">label</span> <span class="free">p</span> <span class="free">S</span> <span class="free">i</span> <span class="free">x</span> <span class="main">=</span> <span class="free">link</span> <span class="free">i</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">link</span> <span class="bound">p</span> <span class="main">.</span> <span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟶</span> link_0 <span class="bound">link</span> <span class="free">label</span> <span class="bound">p</span> <span class="free">S</span> <span class="free">i</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">link</span> <span class="free">i</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mp<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> link_out_range <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟹</span> link_0 <span class="free">link</span> <span class="main">(</span><span class="free">label</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="free">S</span> <span class="main">=</span> link_0 <span class="free">link</span> <span class="free">label</span> <span class="free">p</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">link</span> <span class="bound">p</span> <span class="main">.</span> <span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟶</span> link_0 <span class="bound">link</span> <span class="main">(</span><span class="free">label</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="free">S</span> <span class="main">=</span> link_0 <span class="bound">link</span> <span class="free">label</span> <span class="bound">p</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mp<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_stack <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stack <span class="free">link</span> <span class="free">label</span> <span class="free">nil</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stack_out_link_range <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟹</span> stack <span class="main">(</span><span class="free">link</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="main">(</span><span class="free">link</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">label</span> <span class="free">x</span> <span class="free">S</span> <span class="main">=</span> stack <span class="free">link</span> <span class="free">label</span> <span class="free">x</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">link</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">¬</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟶</span> stack <span class="main">(</span><span class="bound">link</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="main">(</span><span class="bound">link</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">label</span> <span class="bound">x</span> <span class="free">S</span> <span class="main">=</span> stack <span class="bound">link</span> <span class="free">label</span> <span class="bound">x</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mp<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stack_out_label_range <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟹</span> stack <span class="free">link</span> <span class="main">(</span><span class="free">label</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">S</span> <span class="main">=</span> stack <span class="free">link</span> <span class="free">label</span> <span class="free">x</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">link</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">¬</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">S</span> <span class="main">⟶</span> stack <span class="bound">link</span> <span class="main">(</span><span class="free">label</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="free">S</span> <span class="main">=</span> stack <span class="bound">link</span> <span class="free">label</span> <span class="bound">x</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mp<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free"><span class="bound"><span class="entity">mrk</span></span></span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mrk</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">lbl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">none</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_cong <span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mrk</span> <span class="main">=</span> <span class="free">mrk1</span> <span class="main">⟹</span> <span class="free">lbl</span> <span class="main">=</span> <span class="free">lbl1</span> <span class="main">⟹</span> <span class="free">ptr</span> <span class="main">=</span> <span class="free">ptr1</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x1</span> <span class="main">==&gt;</span> 
       pointer.g <span class="free">n</span> <span class="free">m</span> <span class="free">mrk</span> <span class="free">lbl</span> <span class="free">ptr</span> <span class="free">x</span> <span class="main">=</span> pointer.g <span class="free">n</span> <span class="free">m</span> <span class="free">mrk1</span> <span class="free">lbl1</span> <span class="free">ptr1</span> <span class="free">x1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q1''_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">lnk'</span><span class="main">,</span> <span class="bound">lbl'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>
      <span class="free">root</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">lnk'</span> <span class="main">=</span> <span class="bound">lnk</span> <span class="main">∧</span> <span class="bound">lbl'</span> <span class="main">=</span> <span class="bound">lbl</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q2''_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">lnk'</span><span class="main">,</span> <span class="bound">lbl'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>
      <span class="free">root</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">root</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">lnk'</span> <span class="main">=</span> <span class="bound">lnk</span> <span class="main">∧</span> <span class="bound">lbl'</span> <span class="main">=</span> <span class="bound">lbl</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q3''_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">lnk'</span><span class="main">,</span> <span class="bound">lbl'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>
         <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> 
         <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="main">.</span> g <span class="bound">mrk</span> <span class="bound">lbl</span> <span class="main">(</span><span class="bound">lnk</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> 
            <span class="bound">p'</span> <span class="main">=</span> <span class="bound">lnk</span> <span class="bound">i</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span>  <span class="bound">p</span> <span class="main">∧</span> <span class="bound">lnk'</span> <span class="main">=</span>  <span class="bound">lnk</span><span class="main">(</span><span class="bound">i</span> <span class="main">:=</span> <span class="main">(</span><span class="bound">lnk</span> <span class="bound">i</span><span class="main">)</span><span class="main">(</span><span class="bound">p</span> <span class="main">:=</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">lbl'</span> <span class="main">=</span> <span class="bound">lbl</span><span class="main">(</span><span class="bound">p</span> <span class="main">:=</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
            <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">lnk</span> <span class="bound">i</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q4''_a</span>  <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">lnk'</span><span class="main">,</span> <span class="bound">lbl'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>
          <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">.</span> <span class="main">¬</span> g <span class="bound">mrk</span> <span class="bound">lbl</span> <span class="main">(</span><span class="bound">lnk</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> 
          <span class="bound">p'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">lnk</span> <span class="main">(</span><span class="bound">lbl</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">lnk'</span> <span class="main">=</span> <span class="bound">lnk</span><span class="main">(</span><span class="bound">lbl</span> <span class="bound">t</span> <span class="main">:=</span> <span class="main">(</span><span class="bound">lnk</span> <span class="main">(</span><span class="bound">lbl</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="bound">t</span> <span class="main">:=</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">∧</span> <span class="bound">lbl'</span> <span class="main">=</span> <span class="bound">lbl</span><span class="main">(</span><span class="bound">t</span> <span class="main">:=</span> <span class="free">none</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q5''_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">lnk'</span><span class="main">,</span> <span class="bound">lbl'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>
           <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">.</span> <span class="main">¬</span> g <span class="bound">mrk</span> <span class="bound">lbl</span> <span class="main">(</span><span class="bound">lnk</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span>
           <span class="bound">p'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">lnk'</span> <span class="main">=</span>  <span class="bound">lnk</span> <span class="main">∧</span> <span class="bound">lbl'</span> <span class="main">=</span> <span class="bound">lbl</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q6''_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">lnk'</span><span class="main">,</span> <span class="bound">lbl'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span>  
         <span class="bound">p'</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">lnk'</span> <span class="main">=</span> <span class="bound">lnk</span> <span class="main">∧</span> <span class="bound">lbl'</span> <span class="main">=</span>  <span class="bound">lbl</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Init''</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span> <span class="bound">lnk</span> <span class="main">=</span> <span class="free">link0</span> <span class="main">∧</span> <span class="bound">lbl</span> <span class="main">=</span> <span class="free">label0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Loop''</span> <span class="main">≡</span> UNIV"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Final''</span> <span class="main">≡</span> Init''"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data refinement relations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">R1'_a</span> <span class="main">≡</span> <span class="main">{:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">∈</span> Init'' <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span><span class="main">:}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>  
  <span class="quoted"><span class="quoted">"<span class="free">R2'_a</span> <span class="main">≡</span> <span class="main">{:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">stk</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>  
       <span class="bound">p</span> <span class="main">=</span> head <span class="bound">stk</span> <span class="main">∧</span>  
       <span class="bound">t</span> <span class="main">=</span> head <span class="main">(</span>tail <span class="bound">stk</span><span class="main">)</span> <span class="main">∧</span>  
       stack <span class="bound">lnk</span> <span class="bound">lbl</span> <span class="bound">t</span> <span class="main">(</span>tail <span class="bound">stk</span><span class="main">)</span> <span class="main">∧</span> 
       <span class="free">link0</span> <span class="main">=</span> link_0 <span class="bound">lnk</span> <span class="bound">lbl</span> <span class="bound">p</span> <span class="main">(</span>tail <span class="bound">stk</span><span class="main">)</span> <span class="main">∧</span> 
       <span class="free">label0</span> <span class="main">=</span> label_0 <span class="bound">lbl</span> <span class="main">(</span>tail <span class="bound">stk</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">¬</span> <span class="free">nil</span> <span class="main">∈</span> set <span class="bound">stk</span> <span class="main">∧</span> 
       <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">:}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"R1'_a <span class="main">∈</span> Apply.Disjunctive"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1'_a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"R2'_a <span class="main">∈</span> Apply.Disjunctive"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2'_a_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R'_a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> R1'_a <span class="main">|</span>
      I.loop  <span class="main">⇒</span> R2'_a <span class="main">|</span>
      I.final <span class="main">⇒</span> R1'_a<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Disjunctive_fun R'_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Disjunctive_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Diagram›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LinkMark</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>I.init<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> Q1''_a <span class="main">⊓</span>  Q2''_a <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> Q3''_a <span class="main">⊓</span> <span class="main">(</span>Q4''_a <span class="main">⊓</span> Q5''_a<span class="main">)</span> <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.final<span class="main">)</span> <span class="main">⇒</span> Q6''_a <span class="main">|</span>
       <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">⊤</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">LinkMarkInv</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> Init'' <span class="main">|</span>
      I.loop  <span class="main">⇒</span> Loop'' <span class="main">|</span>
      I.final <span class="main">⇒</span> Final''<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data refinement of the transitions›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> init1_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Init'<span class="main">.}</span> <span class="keyword1">o</span> Q1'_a<span class="main">)</span> R1'_a R2'_a Q1''_a"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q1''_a_def Init'_def Init''_def 
       Loop''_def R1'_a_def R2'_a_def Q1'_a_def tail_def head_def angelic_def subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> init2_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Init'<span class="main">.}</span> <span class="keyword1">o</span> Q2'_a<span class="main">)</span> R1'_a R2'_a Q2''_a"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q2''_a_def Init'_def Init''_def 
       Loop''_def R1'_a_def R2'_a_def Q2'_a_def tail_def head_def angelic_def subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> step1_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop'<span class="main">.}</span> <span class="keyword1">o</span> Q3'_a<span class="main">)</span> R2'_a R2'_a Q3''_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q3''_a_def Init'_def Init''_def 
       Loop'_def R1'_a_def Q3'_a_def tail_def head_def angelic_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> next_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2'_a_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2'_a_def angelic_def hoare_demonic simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">aa</span> <span class="improper">i</span> <span class="main">(</span>hd <span class="improper">a</span><span class="main">)</span> <span class="main">#</span> <span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def  neq_Nil_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def  neq_Nil_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def  neq_Nil_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> neqif <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> step2_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop'<span class="main">.}</span> <span class="keyword1">o</span> Q4'_a<span class="main">)</span> R2'_a R2'_a Q4''_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q4''_a_def Init'_def Init''_def 
       Loop'_def Q4'_a_def tail_def head_def angelic_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> next_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2'_a_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2'_a_def angelic_def hoare_demonic simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> g_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> head_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ysa</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ab</span> <span class="improper">ya</span> <span class="main">=</span> <span class="improper">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> setsimp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> step3_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop'<span class="main">.}</span> <span class="keyword1">o</span> Q4'_a<span class="main">)</span> R2'_a R2'_a Q5''_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q5''_a_def Init'_def Init''_def 
       Loop'_def Q4'_a_def angelic_def subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> R2'_a_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> next_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def subset_eq 
           simp_eq_emptyset g_def head_def tail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> final_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop'<span class="main">.}</span> <span class="keyword1">o</span> Q5'_a<span class="main">)</span> R2'_a R1'_a Q6''_a"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic Q6''_a_def Init'_def Init''_def 
       Loop'_def R2'_a_def R1'_a_def Q5'_a_def angelic_def subset_eq neq_Nil_conv tail_def head_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp_eq_emptyset<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram data refinement›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apply_fun_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">..</span> <span class="free">P</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Disjunctive_fun <span class="main">(</span><span class="free">r</span><span class="main">::</span><span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span><span class="main">)</span> 
        <span class="main">⟹</span> mono_fun <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Disjunctive_fun_def mono_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> LinkMark_DataRefinement_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"DgrDataRefinement2 <span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span> StackMark_a R'_a LinkMark"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"StackMarkInv"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> DgrDataRefinement_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def SetMarkInv_def angelic_def 
               R1_a_def R2_a_def Init'_def Final'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DgrDataRefinement2_def dgr_demonic_def LinkMark_def 
    StackMark_a_def demonic_sup_inf data_refinement_choice2 assert_comp_choice<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> data_refinement_choice2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> data_refinement_choice1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q1'_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q1'_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q2'_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q2'_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q3'_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q3'_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q4'_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q4'_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q5'_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q5'_a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dmono StackMark_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dmono_def StackMark_a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram correctness›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> LinkMark_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Hoare_dgr <span class="main">(</span>R'_a <span class="main">..</span> <span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span><span class="main">)</span> LinkMark <span class="main">(</span><span class="main">(</span>R'_a <span class="main">..</span> <span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span><span class="main">)</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">-</span> grd <span class="main">(</span>step LinkMark<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> D <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"StackMark_a"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Diagram_DataRefinement2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> StackMark_correct<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DSWMark">
<div class="head">
<h1>Theory DSWMark</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deutsch-Schorr-Waite Marking Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DSWMark
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LinkMark.html">LinkMark</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Finally, we construct the Deutsch-Schorr-Waite marking algorithm by assuming that there 
are only two pointers ($\mathit{left}$, $\mathit{right}$) from every node. There is also a new variable,
$\mathit{atom}: \mathit{node} \to  \mathit{bool}$ which associates to every node a Boolean value.
The data invariant of this refinement step requires that $\mathit{index}$ has exactly two distinct 
elements $none$  and $\mathit{some}$, $\mathit{left} = \mathit{link}\ \mathit{none}$, 
$\mathit{right}=\mathit{link}\  \mathit{some}$, and $\mathit{atom}\ x$ is true 
if and only if $\mathit{label}\ x = \mathit{some}$.

We use a new locale which fixes the initial values of the variables $\mathit{left}$, $\mathit{right}$, and
$\mathit{atom}$ in $\mathit{left0}$, $\mathit{right0}$, and $\mathit{atom0}$ respectively.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> Index <span class="main">=</span> none <span class="main">|</span> some

<span class="keyword1"><span class="command">locale</span></span> classical <span class="main">=</span> node <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">left0</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'node</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">right0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'node</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">atom0</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nil</span><span class="main">::</span><span class="tfree">'node</span><span class="main">)</span> <span class="main">=</span> <span class="free">nil</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">definition</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">link0</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>none<span class="main">::</span>Index<span class="main">)</span> <span class="keyword1">then</span> <span class="free">left0</span> <span class="keyword1">else</span> <span class="free">right0</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">definition</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">label0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">atom0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>some<span class="main">::</span>Index<span class="main">)</span> <span class="keyword1">else</span> none<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> classical <span class="main">⊆</span> dsw<span class="main">?</span><span class="main">:</span> pointer <span class="quoted"><span class="quoted">"<span class="free">nil</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">root</span>"</span></span> <span class="quoted"><span class="quoted">"none<span class="main">::</span>Index"</span></span> <span class="quoted"><span class="quoted">"link0"</span></span> <span class="quoted"><span class="quoted">"label0"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> classical
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>label0 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> <span class="free">atom</span> <span class="bound">x</span> <span class="keyword1">then</span> some <span class="keyword1">else</span> none<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">atom0</span> <span class="main">=</span> <span class="free">atom</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff label0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gg</span> <span class="free"><span class="bound"><span class="entity">mrk</span></span></span> <span class="free"><span class="bound"><span class="entity">atom</span></span></span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ptr</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mrk</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">atom</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ1_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
         <span class="free">root</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span>  <span class="bound">p'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∧</span> <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span> 
         <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span> <span class="main">:]</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ2_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
         <span class="free">root</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span>  <span class="bound">p'</span> <span class="main">=</span> <span class="free">root</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="free">root</span><span class="main">}</span> 
         <span class="main">∧</span> <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span> <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ3_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
      <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">left</span> <span class="bound">p</span> <span class="main">∧</span>
      <span class="bound">p'</span> <span class="main">=</span> <span class="bound">left</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">left</span> <span class="bound">p</span><span class="main">}</span> <span class="main">∧</span> 
      <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span><span class="main">(</span><span class="bound">p</span> <span class="main">:=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ4_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
      <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">right</span> <span class="bound">p</span> <span class="main">∧</span>
      <span class="bound">p'</span> <span class="main">=</span> <span class="bound">right</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">right</span> <span class="bound">p</span><span class="main">}</span> <span class="main">∧</span> 
      <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span> <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span><span class="main">(</span><span class="bound">p</span> <span class="main">:=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span><span class="main">(</span><span class="bound">p</span> <span class="main">:=</span> True<span class="main">)</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ5_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
      <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="comment1">― ‹not needed in the proof›</span>
      <span class="main">¬</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">left</span> <span class="bound">p</span> <span class="main">∧</span> <span class="main">¬</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">right</span> <span class="bound">p</span> <span class="main">∧</span>
      <span class="bound">t</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">atom</span> <span class="bound">t</span> <span class="main">∧</span>
      <span class="bound">p'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">left</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∧</span> 
      <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span><span class="main">(</span><span class="bound">t</span> <span class="main">:=</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span> <span class="main">:]</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ6_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
      <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="comment1">― ‹not needed in the proof›</span>
      <span class="main">¬</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">left</span> <span class="bound">p</span> <span class="main">∧</span> <span class="main">¬</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">right</span> <span class="bound">p</span> <span class="main">∧</span>
      <span class="bound">t</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">atom</span> <span class="bound">t</span> <span class="main">∧</span>
      <span class="bound">p'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">right</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∧</span> 
      <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span> <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span><span class="main">(</span><span class="bound">t</span> <span class="main">:=</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span><span class="main">(</span><span class="bound">t</span> <span class="main">:=</span> False<span class="main">)</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ7_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
      <span class="bound">p</span> <span class="main">≠</span> <span class="free">nil</span> <span class="main">∧</span>
      <span class="main">¬</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">left</span> <span class="bound">p</span> <span class="main">∧</span> <span class="main">¬</span> gg <span class="bound">mrk</span> <span class="bound">atom</span> <span class="bound">right</span> <span class="bound">p</span> <span class="main">∧</span>
      <span class="bound">t</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span>
      <span class="bound">p'</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∧</span> 
      <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span> <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span> <span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">QQ8_a</span> <span class="main">≡</span> <span class="main">[:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">left'</span><span class="main">,</span> <span class="bound">right'</span><span class="main">,</span> <span class="bound">atom'</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span> 
     <span class="bound">p</span> <span class="main">=</span> <span class="free">nil</span> <span class="main">∧</span> <span class="bound">p'</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">∧</span> <span class="bound">left'</span> <span class="main">=</span> <span class="bound">left</span> <span class="main">∧</span> <span class="bound">right'</span> <span class="main">=</span> <span class="bound">right</span> <span class="main">∧</span> <span class="bound">atom'</span> <span class="main">=</span> <span class="bound">atom</span><span class="main">:]</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Data refinement relation›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RR_a</span> <span class="main">≡</span> <span class="main">{:</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span> <span class="main">↝</span> <span class="bound">p'</span><span class="main">,</span> <span class="bound">t'</span><span class="main">,</span> <span class="bound">lnk</span><span class="main">,</span> <span class="bound">lbl</span><span class="main">,</span> <span class="bound">mrk'</span> <span class="main">.</span>
          <span class="bound">lnk</span> none <span class="main">=</span> <span class="bound">left</span> <span class="main">∧</span> <span class="bound">lnk</span> some <span class="main">=</span> <span class="bound">right</span> <span class="main">∧</span>
          <span class="bound">lbl</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> <span class="bound">atom</span> <span class="bound">x</span> <span class="keyword1">then</span> some <span class="keyword1">else</span> none<span class="main">)</span> <span class="main">∧</span>
          <span class="bound">p'</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">mrk'</span> <span class="main">=</span> <span class="bound">mrk</span> <span class="main">:}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R''_a</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> RR_a"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ClassicMark</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>I.init<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> QQ1_a <span class="main">⊓</span> QQ2_a <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.loop<span class="main">)</span>  <span class="main">⇒</span> <span class="main">(</span>QQ3_a <span class="main">⊓</span> QQ4_a<span class="main">)</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">(</span>QQ5_a <span class="main">⊓</span> QQ6_a<span class="main">)</span> <span class="main">⊓</span> QQ7_a<span class="main">)</span> <span class="main">|</span>
      <span class="main">(</span>I.loop<span class="main">,</span> I.final<span class="main">)</span> <span class="main">⇒</span> QQ8_a <span class="main">|</span>
       <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">⊤</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data refinement of the transitions›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> init1_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Init''<span class="main">.}</span> <span class="keyword1">o</span> Q1''_a<span class="main">)</span> RR_a RR_a QQ1_a"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def QQ1_a_def Q1''_a_def RR_a_def
       Init''_def subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> init2_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Init''<span class="main">.}</span> <span class="keyword1">o</span> Q2''_a<span class="main">)</span> RR_a RR_a QQ2_a"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def QQ2_a_def Q2''_a_def RR_a_def
       Init''_def subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> index_simp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> none <span class="main">=</span> <span class="free">v</span> none <span class="main">∧</span> <span class="free">u</span> some <span class="main">=</span> <span class="free">v</span> some<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> step1_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop''<span class="main">.}</span> <span class="keyword1">o</span> Q3''_a<span class="main">)</span> RR_a RR_a QQ3_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def QQ3_a_def  Q3''_a_def RR_a_def
       Loop''_def subset_eq g_def gg_def simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> some <span class="keyword1">then</span> <span class="improper">ab</span> some <span class="keyword1">else</span> <span class="main">(</span><span class="improper">ab</span> none<span class="main">)</span><span class="main">(</span><span class="improper">a</span> <span class="main">:=</span> <span class="improper">aa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"none"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_simp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> step2_a<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop''<span class="main">.}</span> <span class="keyword1">o</span> Q3''_a<span class="main">)</span> RR_a RR_a QQ4_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def QQ4_a_def Q3''_a_def RR_a_def
       Loop''_def subset_eq g_def gg_def simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> none <span class="keyword1">then</span> <span class="improper">ab</span> none <span class="keyword1">else</span> <span class="main">(</span><span class="improper">ab</span> some<span class="main">)</span><span class="main">(</span><span class="improper">a</span> <span class="main">:=</span> <span class="improper">aa</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"some"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_simp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> step3_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop''<span class="main">.}</span> <span class="keyword1">o</span> Q4''_a<span class="main">)</span> RR_a RR_a QQ5_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def QQ5_a_def Q4''_a_def RR_a_def
       Loop''_def subset_eq g_def gg_def simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> if_set_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> step4_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop''<span class="main">.}</span> <span class="keyword1">o</span>  Q4''_a<span class="main">)</span> RR_a RR_a QQ6_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def RR_a_def QQ6_a_def Q4''_a_def
       Loop''_def subset_eq simp_eq_emptyset g_def gg_def if_set_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> step5_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop''<span class="main">.}</span> <span class="keyword1">o</span> Q5''_a<span class="main">)</span> RR_a RR_a QQ7_a"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def Q5''_a_def QQ7_a_def 
       Loop''_def subset_eq RR_a_def simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def gg_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> final_step_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"DataRefinement <span class="main">(</span><span class="main">{.</span>Loop''<span class="main">.}</span> <span class="keyword1">o</span> Q6''_a<span class="main">)</span> RR_a RR_a QQ8_a"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_refinement_hoare hoare_demonic angelic_def Q6''_a_def QQ8_a_def 
       Loop''_def subset_eq RR_a_def simp_eq_emptyset<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram data refinement›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono RR_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RR_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RR_a <span class="main">∈</span> Apply.Disjunctive"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RR_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Disjunctive_fun R''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Disjunctive_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono_fun R''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q1''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q1''_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q2''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q2''_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q3''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q3''_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q4''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q4''_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q5''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q5''_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono Q6''_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q6''_a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dmono LinkMark"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dmono_def LinkMark_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> ClassicMark_DataRefinement_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"DgrDataRefinement2 <span class="main">(</span>R'_a <span class="main">..</span> <span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span><span class="main">)</span> LinkMark R''_a ClassicMark"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"LinkMarkInv"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> DgrDataRefinement_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def SetMarkInv_def 
    angelic_def R1'_a_def R2'_a_def Init''_def Loop''_def Final''_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DgrDataRefinement2_def dgr_demonic_def ClassicMark_def LinkMark_def 
    demonic_sup_inf data_refinement_choice2 assert_comp_choice<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> data_refinement_choice2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> data_refinement_choice1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> data_refinement_choice2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> data_refinement_choice1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Diagram corectness›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ClassicMark_correct_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Hoare_dgr  <span class="main">(</span>R''_a <span class="main">..</span> <span class="main">(</span>R'_a <span class="main">..</span> <span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span><span class="main">)</span><span class="main">)</span>  ClassicMark 
         <span class="main">(</span><span class="main">(</span>R''_a <span class="main">..</span> <span class="main">(</span>R'_a <span class="main">..</span><span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">-</span> grd <span class="main">(</span>step ClassicMark<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> D <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"LinkMark"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> Diagram_DataRefinement2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LinkMark_correct<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We have proved the correctness of the final algorithm, but the pre and the post conditions
involve the angelic choice operator and they depend on all data refinement steps we 
have used to prove the final diagram. We simplify these conditions and we show that
we obtained indead the corectness of the marking algorithm. 

The predicate $\mathit{ClassicInit}$ which is true for the $\mathit{init}$ situation states that initially 
the variables $\mathit{left}$, $\mathit{right}$, and $\mathit{atom}$ are equal to their initial values and also 
that no node is marked.

The predicate $\mathit{ClassicFinal}$ which is true for the $final$ situation states that at the end
the values of the variables $\mathit{left}$, $\mathit{right}$, and $\mathit{atom}$ are again equal to their initial values
and the variable $mrk$ records all reachable nodes. The reachable nodes are defined using our initial 
$\mathit{next}$ relation, however if we unfold all locale interpretations and definitions we see easeily
that a node $x$ is reachable if there is a path from $root$ to $x$ along $\mathit{left}$ and $\mathit{right}$ functions,
and all nodes in this path have the atom bit false.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ClassicInit</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span>
      <span class="bound">atom</span> <span class="main">=</span> <span class="free">atom0</span> <span class="main">∧</span> <span class="bound">left</span> <span class="main">=</span> <span class="free">left0</span> <span class="main">∧</span> <span class="bound">right</span> <span class="main">=</span> <span class="free">right0</span> <span class="main">∧</span> 
      finite <span class="main">(</span><span class="main">-</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">mrk</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ClassicFinal</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">left</span><span class="main">,</span> <span class="bound">right</span><span class="main">,</span> <span class="bound">atom</span><span class="main">,</span> <span class="bound">mrk</span><span class="main">)</span> <span class="main">.</span> 
       <span class="bound">atom</span> <span class="main">=</span> <span class="free">atom0</span> <span class="main">∧</span> <span class="bound">left</span> <span class="main">=</span> <span class="free">left0</span> <span class="main">∧</span> <span class="bound">right</span> <span class="main">=</span> <span class="free">right0</span> <span class="main">∧</span> 
       <span class="bound">mrk</span> <span class="main">=</span> reach <span class="free">root</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ClassicInit <span class="main">⊆</span> <span class="main">(</span>RR_a <span class="main">(</span>R1'_a <span class="main">(</span>R1_a <span class="main">(</span>SetMarkInv init<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetMarkInv_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ClassicInit_def angelic_def RR_a_def R1'_a_def R1_a_def Init_def Init''_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> simp_eq_emptyset<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> link0_def label0_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> label0_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>RR_a <span class="main">(</span>R1'_a <span class="main">(</span>R1_a <span class="main">(</span>SetMarkInv final<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ClassicFinal"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetMarkInv_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ClassicFinal_def angelic_def RR_a_def R1'_a_def R1_a_def 
    Final_def Final''_def Init''_def label0_def link0_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simp_eq_emptyset inf_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> link0_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The indexed predicate $\mathit{ClassicPre}$ is the precondition of the diagram, and since we are only interested
in starting the marking diagram in the $init$ situation we set 
$\mathit{ClassicPre} \ loop = \mathit{ClassicPre} \ \mathit{final} = \emptyset$. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ClassicPre</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> ClassicInit <span class="main">|</span>
      I.loop  <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span>
      I.final <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
We are interested on the other hand that the marking diagram terminates only in the $\mathit{final}$ situation. In order to
achieve this we define the postcondition of the diagram as the indexed predicate $\mathit{ClassicPost}$ which is empty
on every situation except $final$. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ClassicPost</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
      I.init  <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span>
      I.loop  <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span>
      I.final <span class="main">⇒</span> ClassicFinal<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_or<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> grd <span class="main">(</span>step  ClassicMark<span class="main">)</span><span class="main">)</span> init <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> grd_def step_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted">loop</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ClassicMark_def QQ1_a_def QQ2_a_def demonic_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"grd <span class="main">⊤</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> grd_def top_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> grd <span class="main">(</span>step  ClassicMark<span class="main">)</span><span class="main">)</span> loop <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"final"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"loop"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ClassicMark_def QQ1_a_def QQ2_a_def QQ3_a_def QQ4_a_def QQ5_a_def QQ6_a_def QQ7_a_def QQ8_a_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">a</span> <span class="main">≠</span> <span class="free">nil</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The final theorem states the correctness of the marking diagram with respect to the precondition
$\mathit{ClassicPre}$ and the postcondition $\mathit{ClassicPost}$, that is, if the diagram starts in the initial 
situation, then it will terminate in the final situation, and it will mark all reachable nodes.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ1_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ1_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ2_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ2_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ3_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ3_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ4_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ4_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ5_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ5_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ6_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ6_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ7_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ7_a_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono QQ8_a"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QQ8_a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dmono ClassicMark"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dmono_def ClassicMark_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊨</span> ClassicPre <span class="main">{|</span> pt ClassicMark <span class="main">|}</span> ClassicPost"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>R''_a <span class="main">..</span> <span class="main">(</span>R'_a <span class="main">..</span> <span class="main">(</span>R_a <span class="main">..</span>SetMarkInv<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> hoare_pre<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Q <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>R''_a <span class="main">..</span> <span class="main">(</span>R'_a <span class="main">..</span> <span class="main">(</span>R_a <span class="main">..</span> SetMarkInv<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">-</span> grd <span class="main">(</span>step <span class="main">(</span><span class="main">(</span>ClassicMark<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> hoare_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hoare_dgr_correctness<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_fun_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> uminus_apply<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"RR_a <span class="main">(</span>R1'_a <span class="main">(</span>R1_a <span class="main">(</span>SetMarkInv final<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>