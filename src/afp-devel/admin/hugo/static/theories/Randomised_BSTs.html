<div id="Randomised_BSTs">
<div class="head">
<h1>Theory Randomised_BSTs</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:      Randomised_BSTs.thy
  Author:    Manuel Eberl (TU München)

  A formalisation of the randomised binary search trees described by Martínez &amp; Roura.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Randomised Binary Search Trees›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Randomised_BSTs
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Random_BSTs/Random_BSTs.html">Random_BSTs.Random_BSTs</a>"</span> <span class="quoted">"<a href="../Monad_Normalisation/Monad_Normalisation.html">Monad_Normalisation.Monad_Normalisation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary facts›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  First of all, we need some fairly simple auxiliary lemmas.
›</span></span>

<span class="keyword1" id="Randomised_BSTs-return_pmf_if"><span class="command">lemma</span></span> return_pmf_if<span class="main">:</span> <span class="quoted"><span class="quoted">"return_pmf <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> return_pmf <span class="free">a</span> <span class="keyword1">else</span> return_pmf <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pmf_as_function <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Randomised_BSTs-True_in_set_bernoulli_pmf_iff"><span class="command">lemma</span></span> True_in_set_bernoulli_pmf_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"True <span class="main">∈</span> set_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Randomised_BSTs-False_in_set_bernoulli_pmf_iff"><span class="command">lemma</span></span> False_in_set_bernoulli_pmf_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"False <span class="main">∈</span> set_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Randomised_BSTs-in_set_pmf_of_setD"><span class="command">lemma</span></span> in_set_pmf_of_setD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> set_pmf_of_set<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Randomised_BSTs-random_bst_reduce"><span class="command">lemma</span></span> random_bst_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
     random_bst <span class="free">A</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="free">A</span><span class="main">;</span> <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_bst.simps<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Randomised_BSTs-pmf_bind_bernoulli"><span class="command">lemma</span></span> pmf_bind_bernoulli<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>bernoulli_pmf <span class="free">x</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">f</span> True<span class="main">)</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">f</span> False<span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_bind<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-vimage_bool_pair"><span class="command">lemma</span></span> vimage_bool_pair<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> bool"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Randomised_BSTs-Leaf_in_set_random_bst_iff"><span class="command">lemma</span></span> Leaf_in_set_random_bst_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Leaf <span class="main">∈</span> set_pmf <span class="main">(</span>random_bst <span class="free">A</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">¬</span>finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_bst.simps<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Randomised_BSTs-bst_insert"><span class="command">lemma</span></span> bst_insert <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> bst <span class="main">(</span>Tree_Set.insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_iff_sorted_wrt_less inorder_insert sorted_ins_list<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-bst_bst_of_list"><span class="command">lemma</span></span> bst_bst_of_list <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="main">(</span>bst_of_list <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="main">(</span>fold Tree_Set.insert <span class="free">xs</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons bst_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_of_list_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Randomised_BSTs-bst_random_bst"><span class="command">lemma</span></span> bst_random_bst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set_pmf <span class="main">(</span>random_bst <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"random_bst <span class="free">A</span> <span class="main">=</span> map_pmf bst_of_list <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> random_bst_altdef<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">…</span> <span class="main">=</span> bst_of_list <span class="main">`</span> permutations_of_set <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"random_bst <span class="free">A</span> <span class="main">=</span> return_pmf <span class="main">⟨⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_bst.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Randomised_BSTs-set_random_bst"><span class="command">lemma</span></span> set_random_bst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set_pmf <span class="main">(</span>random_bst <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set_tree <span class="free">t</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"random_bst <span class="free">A</span> <span class="main">=</span> map_pmf bst_of_list <span class="main">(</span>pmf_of_set <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> random_bst_altdef<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">…</span> <span class="main">=</span> bst_of_list <span class="main">`</span> permutations_of_set <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutations_of_setD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Randomised_BSTs-isin_bst"><span class="command">lemma</span></span> isin_bst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"isin <span class="free">t</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set_tree <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> isin_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bst_iff_sorted_wrt_less<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-isin_random_bst"><span class="command">lemma</span></span> isin_random_bst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set_pmf <span class="main">(</span>random_bst <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"isin <span class="free">t</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bst_random_bst<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isin_bst set_random_bst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Randomised_BSTs-card_3way_split"><span class="command">lemma</span></span> card_3way_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder set<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_insert_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following theorem allows splitting a uniformly random choice from a union of two disjoint
  sets to first tossing a coin to decide on one of the constituent sets and then chooing an 
  element from it uniformly at random.
›</span></span>
<span class="keyword1" id="Randomised_BSTs-pmf_of_set_union_split"><span class="command">lemma</span></span> pmf_of_set_union_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> card <span class="free">A</span> <span class="main">/</span> <span class="main">(</span>card <span class="free">A</span> <span class="main">+</span> card <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> pmf_of_set <span class="free">A</span> <span class="keyword1">else</span> pmf_of_set <span class="free">B</span><span class="main">}</span> <span class="main">=</span> pmf_of_set <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pmf_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">x</span> <span class="main">=</span> pmf <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> pmf <span class="main">(</span>pmf_of_set <span class="free">B</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pmf_bind <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_bernoulli_pmf<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
                <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> pmf <span class="main">(</span>pmf_of_set <span class="free">B</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">B</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> pmf <span class="main">(</span>pmf_of_set <span class="free">B</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">/</span> real <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_gt_0_iff<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> pmf <span class="main">(</span>pmf_of_set <span class="free">B</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>card <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>›</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>›</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_of_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Un_disjoint assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">x</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Randomised_BSTs-pmf_of_set_split_inter_diff"><span class="command">lemma</span></span> pmf_of_set_split_inter_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">/</span> card <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="free">p</span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> pmf_of_set <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
             pmf_of_set <span class="free">B</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> card_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">B</span> <span class="main">=</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> card_Un_disjoint<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> pmf_of_set <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_set_union_split<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Similarly to the above rule, we can split up a uniformly random choice from the disjoint
  union of three sets. This could be done with two coin flips, but it is more convenient to
  choose a natural number uniformly at random instead and then do a case distinction on it.
›</span></span>
<span class="keyword1" id="Randomised_BSTs-pmf_of_set_3way_split"><span class="command">lemma</span></span> pmf_of_set_3way_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> pmf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">∩</span> <span class="free">A2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">∩</span> <span class="free">A3</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">∩</span> <span class="free">A3</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">∪</span> <span class="free">A2</span> <span class="main">∪</span> <span class="free">A3</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="free">A</span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A1</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A2</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span>
           <span class="keyword1">do</span> <span class="main">{</span><span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span><span class="main">;</span>
               <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> card <span class="free">A1</span> <span class="keyword1">then</span> pmf_of_set <span class="free">A1</span> <span class="main">⤜</span> <span class="free">f</span>
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> card <span class="free">A1</span> <span class="main">+</span> card <span class="free">A2</span> <span class="keyword1">then</span> pmf_of_set <span class="free">A2</span> <span class="main">⤜</span> <span class="free">g</span>
               <span class="keyword1">else</span> pmf_of_set <span class="free">A3</span> <span class="main">⤜</span> <span class="free">h</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> card <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> card <span class="free">A2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> card <span class="free">A3</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A1</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A2</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> card_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A1</span> <span class="main">∪</span> <span class="free">A2</span> <span class="main">∪</span> <span class="free">A3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> card_A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> card <span class="free">A1</span> <span class="main">+</span> card <span class="free">A2</span> <span class="main">+</span> card <span class="free">A3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> A_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> card_A_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="skolem">m</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m</span><span class="main">..&lt;</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def n_def card_A_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="keyword1">then</span> pmf_of_set <span class="free">A1</span> <span class="main">⤜</span> <span class="free">f</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">then</span>
                  pmf_of_set <span class="free">A2</span> <span class="main">⤜</span> <span class="free">g</span> <span class="keyword1">else</span> pmf_of_set <span class="free">A3</span> <span class="main">⤜</span> <span class="free">h</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> card_times_pmf_of_set_bind<span class="main">:</span>
      <span class="quoted"><span class="quoted">"card <span class="skolem">X</span> <span class="main">*</span> pmf <span class="main">(</span>pmf_of_set <span class="skolem">X</span> <span class="main">⤜</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> pmf <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> pmf"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_bind_pmf_of_set<span class="main">)</span>  

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?rhs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>card <span class="free">A</span><span class="main">.</span> pmf <span class="main">(</span><span class="var">?M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> card <span class="free">A</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">/</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms card_pos <span class="keyword1"><span class="command">unfolding</span></span> m_def n_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_bind_pmf_of_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span>real <span class="skolem">m</span> <span class="main">*</span> pmf <span class="main">(</span>pmf_of_set <span class="free">A1</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">+</span>
                   real <span class="skolem">n</span> <span class="main">*</span> pmf <span class="main">(</span>pmf_of_set <span class="free">A2</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">+</span>
                   real <span class="skolem">l</span> <span class="main">*</span> pmf <span class="main">(</span>pmf_of_set <span class="free">A3</span> <span class="main">⤜</span> <span class="free">h</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> card_A_eq'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_A_eq m_def n_def l_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A1</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A2</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A3</span><span class="main">.</span> pmf <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> m_def n_def l_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> card_times_pmf_of_set_bind<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">A1</span> <span class="main">∪</span> <span class="free">A2</span> <span class="main">∪</span> <span class="free">A3</span><span class="main">.</span>
                       pmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A1</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A2</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="main">(</span><span class="operator">intro</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(+)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> card <span class="free">A</span> <span class="main">=</span> pmf <span class="var">?lhs</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_bind_pmf_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">x</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> m_def n_def l_def card_A_eq <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partitioning a BST›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The split operation takes a search parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and partitions a BST into two BSTs
  containing all the values that are smaller than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and those that are greater than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>,
  respectively. Note that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> need not be an element of the tree.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_bst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">×</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_bst</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟨⟩</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_bst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
        <span class="keyword1">case</span> <span class="free">split_bst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">t1</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
        <span class="keyword1">case</span> <span class="free">split_bst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">t2</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_bst'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool <span class="main">×</span> <span class="tfree">'a</span> tree <span class="main">×</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_bst'</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟨⟩</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="main">⟨⟩</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_bst'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
        <span class="keyword1">case</span> <span class="free">split_bst'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">t1</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
        <span class="keyword1">case</span> <span class="free">split_bst'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">t1</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">t2</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span>True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Randomised_BSTs-split_bst'_altdef"><span class="command">lemma</span></span> split_bst'_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"split_bst' <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>isin <span class="free">t</span> <span class="free">x</span><span class="main">,</span> split_bst <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_bst.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-fst_split_bst'"><span class="command">lemma</span></span> fst_split_bst' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>split_bst' <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> isin <span class="free">t</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> snd_split_bst' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>split_bst' <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> split_bst <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_bst'_altdef<span class="main">)</span>


<span class="keyword1" id="Randomised_BSTs-size_fst_split_bst"><span class="command">lemma</span></span> size_fst_split_bst <span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-size_snd_split_bst"><span class="command">lemma</span></span> size_snd_split_bst <span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> size_split_bst <span class="main">=</span> size_fst_split_bst size_snd_split_bst

<span class="keyword1" id="Randomised_BSTs-set_split_bst1"><span class="command">lemma</span></span> set_split_bst1<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> set_tree <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> set_tree <span class="free">t</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-set_split_bst2"><span class="command">lemma</span></span> set_split_bst2<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> set_tree <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> set_tree <span class="free">t</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-bst_split_bst1"><span class="command">lemma</span></span> bst_split_bst1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> bst <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold set_split_bst1<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-bst_split_bst2"><span class="command">lemma</span></span> bst_split_bst2 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> bst <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold set_split_bst2<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Splitting a random BST produces two random BSTs:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> split_random_bst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span>split_bst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="free">A</span><span class="main">)</span> <span class="main">=</span>
             pair_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> random_bst.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A<span class="hidden">⇩</span><sub>1</sub>_def A<span class="hidden">⇩</span><sub>2</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A<span class="hidden">⇩</span><sub>1</sub>_def A<span class="hidden">⇩</span><sub>2</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">include</span></span> monad_normalisation

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_return_pmf1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span>split_bst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span>
            <span class="keyword1">do</span> <span class="main">{</span><span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="keyword1">then</span>
                  <span class="keyword1">do</span> <span class="main">{</span>
                    <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                    <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">←</span> map_pmf <span class="main">(</span>split_bst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                    return_pmf <span class="main">(</span><span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">t1</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span>
                  <span class="main">}</span>
                <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span> <span class="keyword1">then</span>
                  <span class="keyword1">do</span> <span class="main">{</span>
                    <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">←</span> map_pmf <span class="main">(</span>split_bst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                    <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                    return_pmf <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">}</span>
                <span class="keyword1">else</span>
                  <span class="keyword1">do</span> <span class="main">{</span>
                    <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                    <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                    return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
                  <span class="main">}</span>
               <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_bst.simps<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_pmf bind_map_pmf return_pmf_if case_prod_unfold <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>
                                                 <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">t1</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span>
                          <span class="main">}</span>
                        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>
                                                 <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                            <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">}</span>
                         <span class="keyword1">else</span> 
                           <span class="keyword1">do</span> <span class="main">{</span>
                             <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                             <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                             return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
                           <span class="main">}</span>
                       <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">thm</span></span> <span class="quoted">"1.IH"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong if_cong refl <span class="quoted">"1.IH"</span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">t1</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span>
                          <span class="main">}</span>
                        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">}</span>
                         <span class="keyword1">else</span> 
                           <span class="keyword1">do</span> <span class="main">{</span>
                             <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                             <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                             return_pmf <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
                           <span class="main">}</span>
                       <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">t1</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span>
                          <span class="main">}</span>
                        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                            <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">}</span>
                         <span class="keyword1">else</span>
                           pair_pmf <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                       <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A<span class="hidden">⇩</span><sub>1</sub>_def A<span class="hidden">⇩</span><sub>2</sub>_def pair_pmf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>card <span class="skolem">A</span><span class="main">}</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> card <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                            <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">t1</span><span class="main">⟩</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span>
                          <span class="main">}</span>
                        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> card <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> card <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">then</span>
                          <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span>
                            <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                            <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">t2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">}</span>
                         <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                           <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
                           pair_pmf <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                         <span class="main">}</span>
                       <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_set_3way_split<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A<span class="hidden">⇩</span><sub>1</sub>_def A<span class="hidden">⇩</span><sub>2</sub>_def not_less_iff_gr_or_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">i</span> <span class="main">←</span> pmf_of_set <span class="main">{..&lt;</span>card <span class="skolem">A</span><span class="main">}</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> card <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
                          pair_pmf <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                        <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> card <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> card <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">then</span>
                          pair_pmf <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                         <span class="keyword1">else</span> 
                          pair_pmf <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                       <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def random_bst_reduce<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def random_bst_reduce<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pair_pmf <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="hidden">⇩</span><sub>1</sub>_def A<span class="hidden">⇩</span><sub>2</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Joining›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The ``join'' operation computes the union of two BSTs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> where all the values in
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> are stricly smaller than those in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_join</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> <span class="main">⟨⟩</span> <span class="keyword1">then</span> return_pmf <span class="free"><span class="bound"><span class="entity">t2</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">⟨⟩</span> <span class="keyword1">then</span> return_pmf <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">/</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_join</span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_join</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Randomised_BSTs-mrbst_join_Leaf_left"><span class="command">lemma</span></span> mrbst_join_Leaf_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_join <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_join_Leaf_right"><span class="command">lemma</span></span> mrbst_join_Leaf_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_join <span class="free">t</span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_join_reduce"><span class="command">lemma</span></span> mrbst_join_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≠</span> <span class="main">⟨⟩</span> <span class="main">⟹</span> <span class="free">t2</span> <span class="main">≠</span> <span class="main">⟨⟩</span> <span class="main">⟹</span> mrbst_join <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span>
     <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span>size <span class="free">t1</span> <span class="main">/</span> <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">r</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="free">t1</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mrbst_join.simps<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> mrbst_join.simps

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_join <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_tree <span class="free">t1</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set_tree <span class="free">t2</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_join<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_join<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span> <span class="main">∧</span> set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">t'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">⟨⟩</span> <span class="main">∨</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">⟨⟩</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span>Node <span class="bound">l</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">r</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
             <span class="skolem">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="skolem">t1</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mrbst_join_reduce<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span>Node <span class="bound">l</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">r</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_join <span class="skolem">r</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">r'</span> <span class="main">∧</span> set_tree <span class="skolem">r'</span> <span class="main">=</span> set_tree <span class="skolem">r</span> <span class="main">∪</span> set_tree <span class="skolem">t2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="skolem">t1</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">l'</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_join <span class="skolem">t1</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">l'</span> <span class="main">∧</span> set_tree <span class="skolem">l'</span> <span class="main">=</span> set_tree <span class="skolem">t1</span> <span class="main">∪</span> set_tree <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> less.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Joining two random BSTs that satisfy the necessary preconditions again yields a random BST.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> mrbst_join_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="free">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="free">B</span><span class="main">;</span> mrbst_join <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>psubset <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> card <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> card <span class="skolem">B</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">include</span></span> monad_normalisation
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False psubset.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> p_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> that
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def m_def n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> p_lt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def m_def n_def<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span> mrbst_join <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span>
            <span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span>size <span class="bound">t1</span> <span class="main">/</span> <span class="main">(</span>size <span class="bound">t1</span> <span class="main">+</span> size <span class="bound">t2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span>
                  <span class="keyword1">case</span> <span class="bound">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">r</span> <span class="bound">t2</span><span class="main">)</span>
                <span class="keyword1">else</span>
                  <span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">t1</span> <span class="bound">l</span><span class="main">)</span>
               <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> mrbst_join_reduce<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span>
                            <span class="keyword1">case</span> <span class="bound">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">r</span> <span class="bound">t2</span><span class="main">)</span>
                          <span class="keyword1">else</span>
                            <span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">t1</span> <span class="bound">l</span><span class="main">)</span>
                         <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">bernoulli_pmf</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def m_def n_def size_random_bst<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          <span class="keyword1">case</span> <span class="bound">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">r</span> <span class="bound">t2</span><span class="main">)</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          <span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">t1</span> <span class="bound">l</span><span class="main">)</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                  <span class="keyword1">case</span> <span class="bound">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">r</span> <span class="bound">t2</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
              <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                <span class="bound">r</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span> mrbst_join <span class="bound">r</span> <span class="bound">t2</span><span class="main">}</span><span class="main">;</span>
                return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
              <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_bst_reduce<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_pmf_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB psubset.prems 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl psubset arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB psubset.prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">b</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_lt1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                  <span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_join <span class="bound">t1</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
              <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                <span class="bound">l</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span> <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span> mrbst_join <span class="bound">t1</span> <span class="bound">l</span><span class="main">}</span><span class="main">;</span>
                <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
              <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_bst_reduce<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_pmf_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB psubset.prems 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl psubset arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB psubset.prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="bound">x</span> <span class="main">←</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> pmf_of_set <span class="skolem">A</span> <span class="keyword1">else</span> pmf_of_set <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                        return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">x</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> pmf_of_set <span class="skolem">A</span> <span class="keyword1">else</span> pmf_of_set <span class="skolem">B</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                        return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> pmf_of_set <span class="skolem">A</span> <span class="keyword1">else</span> pmf_of_set <span class="skolem">B</span><span class="main">}</span> <span class="main">=</span>
                   pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB psubset.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_set_union_split<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def m_def n_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
                   <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                   <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                   <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                   return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                 <span class="main">}</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> random_bst_reduce <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pushdown›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The ``push down'' operation ``forgets'' information about the root of a tree in the following
  sense: It takes a non-empty tree whose root is some known fixed value and whose children are
  random BSTs and shuffles the root in such a way that the resulting tree is a random BST.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_push_down</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_push_down</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">k</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="main">0</span><span class="main">..</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span>
         <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span>
           <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">lr</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_push_down</span> <span class="bound">lr</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span>
         <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
           <span class="main">⟨</span><span class="bound">rl</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_push_down</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">rl</span><span class="main">)</span>
       <span class="keyword1">else</span>
         return_pmf <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span>
     <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> mrbst_push_down.simps

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_push_down <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set_tree <span class="free">t1</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set_tree <span class="free">t2</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_push_down<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_push_down<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span> <span class="main">∧</span> set_tree <span class="free">t'</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">t'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≠</span> <span class="main">⟨⟩</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">t1</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span>
                            map_pmf <span class="main">(</span>Node <span class="bound">l</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>mrbst_push_down <span class="bound">r</span> <span class="free">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
          <span class="skolem">t2</span> <span class="main">≠</span> <span class="main">⟨⟩</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">t2</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="main">⇒</span>
                            map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_push_down <span class="skolem">t1</span> <span class="free">x</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
          <span class="skolem">t'</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">t1</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mrbst_push_down.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_push_down <span class="skolem">r</span> <span class="free">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">r'</span> <span class="main">∧</span> set_tree <span class="skolem">r'</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="skolem">r</span> <span class="main">∪</span> set_tree <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">l'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_push_down <span class="skolem">t1</span> <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">l'</span> <span class="main">∧</span> set_tree <span class="skolem">l'</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="skolem">t1</span> <span class="main">∪</span> set_tree <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> less.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> less.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> mrbst_push_down_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">l</span> <span class="main">←</span> random_bst <span class="free">A</span><span class="main">;</span> <span class="bound">r</span> <span class="main">←</span> random_bst <span class="free">B</span><span class="main">;</span> mrbst_push_down <span class="bound">l</span> <span class="free">x</span> <span class="bound">r</span><span class="main">}</span> <span class="main">=</span>
             random_bst <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>psubset <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> card <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> card <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> A_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> B_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>

    <span class="keyword1"><span class="command">include</span></span> monad_normalisation
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span> <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span> mrbst_push_down <span class="bound">l</span> <span class="free">x</span> <span class="bound">r</span><span class="main">}</span> <span class="main">=</span>
          <span class="keyword1">do</span> <span class="main">{</span><span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
              <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
              <span class="bound">k</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span><span class="main">;</span>
              <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="keyword1">then</span>
                <span class="keyword1">case</span> <span class="bound">l</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">lr</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_push_down <span class="bound">lr</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">then</span>
                <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">rl</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_push_down <span class="bound">l</span> <span class="free">x</span> <span class="bound">rl</span><span class="main">)</span>
              <span class="keyword1">else</span>
                return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
             <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> psubset.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mrbst_push_down.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bind_pmf_cong refl<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_random_bst m_def n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          <span class="keyword1">case</span> <span class="bound">l</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">lr</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_push_down <span class="bound">lr</span> <span class="free">x</span> <span class="bound">r</span><span class="main">)</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> <span class="main">⟨</span><span class="bound">rl</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span> <span class="main">⇒</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>mrbst_push_down <span class="bound">l</span> <span class="free">x</span> <span class="bound">rl</span><span class="main">)</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                       <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">ll</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r'</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">lr</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                                    <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                                    mrbst_push_down <span class="bound">lr</span> <span class="free">x</span> <span class="bound">r</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l'</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                                    <span class="bound">rl</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                                    mrbst_push_down <span class="bound">l</span> <span class="free">x</span> <span class="bound">rl</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">rr</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                       <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_bst_reduce map_pmf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_bst_reduce map_pmf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">ll</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r'</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l'</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">rr</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                       <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> psubset.prems A_ne B_ne
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong psubset<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_pmf <span class="main">(</span>pmf_of_set <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">B</span> <span class="main">⊂</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> psubset.prems A_ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_pmf_of_setD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_pmf <span class="main">(</span>pmf_of_set <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">}</span> <span class="main">⊂</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> psubset.prems B_ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_pmf_of_setD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">ll</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r'</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l'</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">rr</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                       <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> psubset.prems A_ne B_ne
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong if_cong refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
          <span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> psubset.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">k</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">ll</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r'</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">ll</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l'</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">rr</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">rr</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                       <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?X</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span><span class="main">+</span><span class="skolem">n</span><span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_of_set_singleton <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span>card <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubset.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                           <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                           <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                           return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_def n_def <span class="keyword1"><span class="command">using</span></span> psubset.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pmf_of_set_3way_split <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> psubset.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_pmf_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> psubset.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_bst_reduce<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Randomised_BSTs-mrbst_push_down_correct'"><span class="command">lemma</span></span> mrbst_push_down_correct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder set<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span> <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">;</span> mrbst_push_down <span class="bound">l</span> <span class="free">x</span> <span class="bound">r</span><span class="main">}</span> <span class="main">=</span>
             random_bst <span class="free">A</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mrbst_push_down_correct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Intersection and Difference›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithms for intersection and difference of two trees are almost identical; the only
  difference is that the ``if'' statement at the end of the recursive case is flipped. We
  therefore introduce a generic intersection/difference operation first and prove its correctness
  to avoid duplication.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_inter_diff</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_inter_diff</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟨⟩</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf <span class="main">⟨⟩</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrbst_inter_diff</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">case</span> split_bst' <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sep</span><span class="main">,</span> <span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">l</span> <span class="main">←</span> <span class="free">mrbst_inter_diff</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="bound">l2</span><span class="main">;</span>
          <span class="bound">r</span> <span class="main">←</span> <span class="free">mrbst_inter_diff</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="bound">r2</span><span class="main">;</span>
          <span class="keyword1">if</span> <span class="bound">sep</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
        <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Randomised_BSTs-mrbst_inter_diff_reduce"><span class="command">lemma</span></span> mrbst_inter_diff_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_inter_diff <span class="free">b</span> <span class="main">⟨</span><span class="free">l1</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">r1</span><span class="main">⟩</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">t2</span><span class="main">.</span> <span class="keyword1">case</span> split_bst' <span class="free">x</span> <span class="bound">t2</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sep</span><span class="main">,</span> <span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">l</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="free">l1</span> <span class="bound">l2</span><span class="main">;</span>
           <span class="bound">r</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="free">r1</span> <span class="bound">r2</span><span class="main">;</span>
           <span class="keyword1">if</span> <span class="bound">sep</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
         <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_inter_diff_Leaf_left"><span class="command">lemma</span></span> mrbst_inter_diff_Leaf_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_inter_diff <span class="free">b</span> <span class="main">⟨⟩</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf <span class="main">⟨⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_inter_diff_Leaf_right"><span class="command">lemma</span></span> mrbst_inter_diff_Leaf_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_inter_diff <span class="free">b</span> <span class="main">(</span><span class="free">t1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder tree<span class="main">)</span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">⟨⟩</span> <span class="keyword1">else</span> <span class="free">t1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_return_pmf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">bool</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">setop</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">(∩)</span> <span class="keyword1">else</span> <span class="main">(-)</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_inter_diff <span class="free">b</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_inter_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_inter_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> <span class="free">setop</span> <span class="main">(</span>set_tree <span class="free">t1</span><span class="main">)</span> <span class="main">(</span>set_tree <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">write</span></span> <span class="free">setop</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋄</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span> <span class="main">∧</span> set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main"><span class="free">⋄</span></span> set_tree <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l1</span> <span class="skolem">x</span> <span class="skolem">r1</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> bst <span class="main">=</span> <span class="quoted"><span class="quoted">‹bst <span class="main">⟨</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t2</span>›</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> fst <span class="main">(</span>split_bst <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> snd <span class="main">(</span>split_bst <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_inter_diff <span class="free">b</span> <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_inter_diff <span class="free">b</span> <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">t2</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span><span class="main">}</span> <span class="keyword1">else</span> set_pmf <span class="main">(</span>mrbst_join <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold l2_def r2_def isin_bst <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> lr <span class="keyword1"><span class="command">have</span></span> lr'<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="skolem">l</span> <span class="main">∧</span> set_tree <span class="skolem">l</span> <span class="main">=</span> set_tree <span class="skolem">l1</span> <span class="main"><span class="free">⋄</span></span> set_tree <span class="skolem">l2</span>"</span></span>
                      <span class="quoted"><span class="quoted">"bst <span class="skolem">r</span> <span class="main">∧</span> set_tree <span class="skolem">r</span> <span class="main">=</span> set_tree <span class="skolem">r1</span> <span class="main"><span class="free">⋄</span></span> set_tree <span class="skolem">r2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Node.IH<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l2_def r2_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">t'</span> <span class="main">=</span> set_tree <span class="skolem">l</span> <span class="main">∪</span> set_tree <span class="skolem">r</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">t2</span> <span class="main">⟷</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">t2</span> <span class="main">⟷</span> <span class="free">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_tree <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
        <span class="keyword1"><span class="command">using</span></span> that lr' bst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> set_t'<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">t'</span> <span class="main">=</span> set_tree <span class="skolem">l</span> <span class="main">∪</span> set_tree <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t' set_mrbst_join<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> False lr' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> t' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_tree <span class="main">⟨</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">⟩</span> <span class="main"><span class="free">⋄</span></span> set_tree <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lr' bst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def l2_def r2_def set_split_bst1 set_split_bst2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">t'</span> <span class="main">=</span> set_tree <span class="main">⟨</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">⟩</span> <span class="main"><span class="free">⋄</span></span> set_tree <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> lr' t' bst <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bst_mrbst_join<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main"><span class="free">⋄</span></span> set_tree <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> mrbst_inter_diff_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">bool</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">setop</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">(∩)</span> <span class="keyword1">else</span> <span class="main">(-)</span> <span class="main">::</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="free">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="free">B</span><span class="main">;</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span>
             random_bst <span class="main">(</span><span class="free">setop</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>psubset <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">write</span></span> <span class="free">setop</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋄</span>"</span> 80<span class="main">)</span>
  <span class="keyword1"><span class="command">include</span></span> monad_normalisation
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R1</span></span> <span class="skolem"><span class="skolem">R2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> card_A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">=</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> card_Un_disjoint<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf_of_set <span class="skolem">A</span> <span class="main">=</span>
                <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span>card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">/</span> card <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                    <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">B</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> psubset.prems False <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> A_eq card_A_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> pmf_of_set_union_split <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_gt_0_iff<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> not_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span>
          <span class="keyword1">do</span> <span class="main">{</span>
            <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
            <span class="bound">l1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
            <span class="bound">r1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
            <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">=</span> split_bst <span class="bound">x</span> <span class="bound">t2</span><span class="main">;</span>
            <span class="bound">l</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
            <span class="bound">r</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
            <span class="keyword1">if</span> isin <span class="bound">t2</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
          <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_bst_reduce<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mrbst_inter_diff_reduce map_pmf_def split_bst'_altdef<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="bound">l1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="bound">r1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span>
                      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">=</span> split_bst <span class="bound">x</span> <span class="bound">t2</span><span class="main">;</span>
                      <span class="bound">l</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                      <span class="bound">r</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def case_prod_unfold <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isin_random_bst<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="bound">l1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="bound">r1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">←</span> map_pmf <span class="main">(</span>split_bst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                      <span class="bound">l</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                      <span class="bound">r</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def map_pmf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="bound">l1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="bound">r1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                      <span class="bound">l</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                      <span class="bound">r</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl split_random_bst <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="bound">l1</span> <span class="main">←</span> <span class="skolem">R1</span> <span class="bound">x</span><span class="main">;</span>
                      <span class="bound">r1</span> <span class="main">←</span> <span class="skolem">R2</span> <span class="bound">x</span><span class="main">;</span>
                      <span class="bound">l2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="bound">r2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                      <span class="bound">l</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                      <span class="bound">r</span> <span class="main">←</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pair_pmf_def bind_assoc_pmf R1_R2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="bound">l</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">l1</span> <span class="main">←</span> <span class="skolem">R1</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">l2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">}</span><span class="main">;</span>
                      <span class="bound">r</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">r1</span> <span class="main">←</span> <span class="skolem">R2</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">r2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span> mrbst_inter_diff <span class="free">b</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">}</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bind_assoc_pmf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                      <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R1_R2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl psubset.IH<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        mrbst_join <span class="bound">l</span> <span class="bound">r</span>
                      <span class="main">}</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                        random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main"><span class="free">⋄</span></span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
                      <span class="main">}</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl mrbst_join_correct if_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                        random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">)</span>
                      <span class="main">}</span>
                    <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> pmf_of_set <span class="skolem">A</span> <span class="main">⤜</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order setop_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span>card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">/</span> card <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                      <span class="bound">x</span> <span class="main">←</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">b'</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                        random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">)</span>
                      <span class="main">}</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bind_assoc_pmf eq <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">A</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> not_subset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_pmf_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> card_gt_0_iff
               <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_pmf_of_setD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span>card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">/</span> card <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">b'</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                        return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                        random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">)</span>
                      <span class="main">}</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                      <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span>card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">/</span> card <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                      <span class="keyword1">if</span> <span class="bound">b'</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                        random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">)</span>
                      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                        random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">)</span>
                      <span class="main">}</span>
                    <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> not_subset <span class="quoted"><span class="quoted">‹card <span class="skolem">A</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong random_bst_reduce <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> setop_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main"><span class="free">⋄</span></span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now derive the intersection and difference from the generic operation:
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_inter</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_inter</span> <span class="main">⟨⟩</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf <span class="main">⟨⟩</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrbst_inter</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">case</span> split_bst' <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sep</span><span class="main">,</span> <span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">l</span> <span class="main">←</span> <span class="free">mrbst_inter</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="bound">l2</span><span class="main">;</span>
          <span class="bound">r</span> <span class="main">←</span> <span class="free">mrbst_inter</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="bound">r2</span><span class="main">;</span>
          <span class="keyword1">if</span> <span class="bound">sep</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
        <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Randomised_BSTs-mrbst_inter_Leaf_left"><span class="command">lemma</span></span> mrbst_inter_Leaf_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_inter <span class="main">⟨⟩</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf <span class="main">⟨⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_inter_Leaf_right"><span class="command">lemma</span></span> mrbst_inter_Leaf_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_inter <span class="main">(</span><span class="free">t1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder tree<span class="main">)</span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="main">⟨⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_return_pmf<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_inter_reduce"><span class="command">lemma</span></span> mrbst_inter_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_inter <span class="main">⟨</span><span class="free">l1</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">r1</span><span class="main">⟩</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">t2</span><span class="main">.</span> <span class="keyword1">case</span> split_bst' <span class="free">x</span> <span class="bound">t2</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sep</span><span class="main">,</span> <span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">l</span> <span class="main">←</span> mrbst_inter <span class="free">l1</span> <span class="bound">l2</span><span class="main">;</span>
           <span class="bound">r</span> <span class="main">←</span> mrbst_inter <span class="free">r1</span> <span class="bound">r2</span><span class="main">;</span>
           <span class="keyword1">if</span> <span class="bound">sep</span> <span class="keyword1">then</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span> <span class="keyword1">else</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span>
         <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_inter_altdef"><span class="command">lemma</span></span> mrbst_inter_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_inter <span class="main">=</span> mrbst_inter_diff True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mrbst_inter <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">=</span> mrbst_inter_diff True <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder tree"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_inter <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∩</span> set_tree <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bst_mrbst_inter_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted">True</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span><span class="main">]</span> set_mrbst_inter_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted">True</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mrbst_inter_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> mrbst_inter_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="free">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="free">B</span><span class="main">;</span> mrbst_inter <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mrbst_inter_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mrbst_inter_diff_correct<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_diff</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_diff</span> <span class="main">⟨⟩</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> return_pmf <span class="main">⟨⟩</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrbst_diff</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">case</span> split_bst' <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sep</span><span class="main">,</span> <span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">l</span> <span class="main">←</span> <span class="free">mrbst_diff</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="bound">l2</span><span class="main">;</span>
          <span class="bound">r</span> <span class="main">←</span> <span class="free">mrbst_diff</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="bound">r2</span><span class="main">;</span>
          <span class="keyword1">if</span> <span class="bound">sep</span> <span class="keyword1">then</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span> <span class="keyword1">else</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
        <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Randomised_BSTs-mrbst_diff_Leaf_left"><span class="command">lemma</span></span> mrbst_diff_Leaf_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_diff <span class="main">⟨⟩</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_pmf <span class="main">⟨⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_diff_Leaf_right"><span class="command">lemma</span></span> mrbst_diff_Leaf_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_diff <span class="main">(</span><span class="free">t1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder tree<span class="main">)</span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_return_pmf<span class="main">)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_diff_reduce"><span class="command">lemma</span></span> mrbst_diff_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mrbst_diff <span class="main">⟨</span><span class="free">l1</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">r1</span><span class="main">⟩</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">t2</span><span class="main">.</span> <span class="keyword1">case</span> split_bst' <span class="free">x</span> <span class="bound">t2</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">sep</span><span class="main">,</span> <span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">do</span> <span class="main">{</span>
           <span class="bound">l</span> <span class="main">←</span> mrbst_diff <span class="free">l1</span> <span class="bound">l2</span><span class="main">;</span>
           <span class="bound">r</span> <span class="main">←</span> mrbst_diff <span class="free">r1</span> <span class="bound">r2</span><span class="main">;</span>
           <span class="keyword1">if</span> <span class="bound">sep</span> <span class="keyword1">then</span> mrbst_join <span class="bound">l</span> <span class="bound">r</span> <span class="keyword1">else</span> return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
         <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Randomised_BSTs-If_not"><span class="command">lemma</span></span> If_not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span><span class="free">b</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">y</span> <span class="keyword1">else</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_diff_altdef"><span class="command">lemma</span></span> mrbst_diff_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_diff <span class="main">=</span> mrbst_inter_diff False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mrbst_diff <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="main">=</span> mrbst_inter_diff False <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> If_not<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder tree"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_diff <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">-</span> set_tree <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bst_mrbst_inter_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted">False</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span><span class="main">]</span> set_mrbst_inter_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted">False</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mrbst_diff_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> mrbst_diff_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="free">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="free">B</span><span class="main">;</span> mrbst_diff <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mrbst_diff_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mrbst_inter_diff_correct<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Union›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The algorithm for the union of two trees is by far the most complicated one. It involves a 
›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span>
    case_prod_unfold <span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span>
    if_splits <span class="main">[</span><span class="operator">split</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_union</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_union</span> <span class="main">⟨⟩</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> return_pmf <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrbst_union</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="free"><span class="bound"><span class="entity">t1</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrbst_union</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">⟩</span> <span class="main">=</span>
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> size <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">⟩</span><span class="main">;</span> <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> size <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">⟩</span><span class="main">;</span>
       <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span><span class="bound">m</span> <span class="main">/</span> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l2'</span><span class="main">,</span> <span class="bound">r2'</span><span class="main">)</span> <span class="main">=</span> split_bst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">⟩</span><span class="main">;</span>
         <span class="bound">l</span> <span class="main">←</span> <span class="free">mrbst_union</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="bound">l2'</span><span class="main">;</span>
         <span class="bound">r</span> <span class="main">←</span> <span class="free">mrbst_union</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="bound">r2'</span><span class="main">;</span>
         return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
       <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="keyword1">let</span> <span class="main">(</span><span class="bound">sep</span><span class="main">,</span> <span class="bound">l1'</span><span class="main">,</span> <span class="bound">r1'</span><span class="main">)</span> <span class="main">=</span> split_bst' <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">⟩</span><span class="main">;</span>
         <span class="bound">l</span> <span class="main">←</span> <span class="free">mrbst_union</span> <span class="bound">l1'</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">;</span>
         <span class="bound">r</span> <span class="main">←</span> <span class="free">mrbst_union</span> <span class="bound">r1'</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">;</span>
         <span class="keyword1">if</span> <span class="bound">sep</span> <span class="keyword1">then</span>
           mrbst_push_down <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="bound">r</span>
         <span class="keyword1">else</span>
           return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
       <span class="main">}</span>
     <span class="main">}</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_union_Leaf_left"><span class="command">lemma</span></span> mrbst_union_Leaf_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_union <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Randomised_BSTs-mrbst_union_Leaf_right"><span class="command">lemma</span></span> mrbst_union_Leaf_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_union <span class="free">t1</span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">bool</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_union <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_union<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_union<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span> <span class="main">∧</span> set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">t'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">⟨⟩</span> <span class="main">∨</span> <span class="skolem">t2</span> <span class="main">=</span> <span class="main">⟨⟩</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l2</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> less.prems <span class="keyword1"><span class="command">consider</span></span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_union <span class="skolem">l1</span> <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_union <span class="skolem">r1</span> <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
      <span class="main">|</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_union <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="skolem">y</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_union <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="skolem">y</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">if</span> isin <span class="main">⟨</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">⟩</span> <span class="skolem">y</span> <span class="keyword1">then</span> set_pmf <span class="main">(</span>mrbst_push_down <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold t1 t2 Let_def
                 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> split_bst.simps split_bst'.simps isin.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="skolem">l</span> <span class="main">∧</span> set_tree <span class="skolem">l</span> <span class="main">=</span> set_tree <span class="skolem">l1</span> <span class="main">∪</span> set_tree <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="quoted"><span class="quoted">"bst <span class="skolem">r</span> <span class="main">∧</span> set_tree <span class="skolem">r</span> <span class="main">=</span> set_tree <span class="skolem">r1</span> <span class="main">∪</span> set_tree <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> less.prems size_split_bst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t2</span></span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t1 set_split_bst1 set_split_bst2<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="skolem">l</span> <span class="main">∧</span> set_tree <span class="skolem">l</span> <span class="main">=</span> set_tree <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="skolem">y</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set_tree <span class="skolem">l2</span>"</span></span>
                  <span class="quoted"><span class="quoted">"bst <span class="skolem">r</span> <span class="main">∧</span> set_tree <span class="skolem">r</span> <span class="main">=</span> set_tree <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="skolem">y</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set_tree <span class="skolem">r2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> less.prems size_split_bst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t1</span></span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isin <span class="main">⟨</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">⟩</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 less.prems lr
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> isin.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t2 set_split_bst1 set_split_bst2<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> bst'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>set_tree <span class="skolem">l</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>set_tree <span class="skolem">r</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lr less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_split_bst1 set_split_bst2 t2<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> True <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_push_down <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> isin.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bst_mrbst_push_down<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> lr bst' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">t'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="skolem">l</span> <span class="main">∪</span> set_tree <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_mrbst_push_down<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> lr bst' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less.prems lr
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> isin.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t2 set_split_bst1 set_split_bst2<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> less.prems <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> mrbst_union_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="free">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="free">B</span><span class="main">;</span> mrbst_union <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span>
             random_bst <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>psubset <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">including</span></span> monad_normalisation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> psubset.hyps <span class="keyword1"><span class="command">have</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> card <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> card <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">/</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> AB <span class="keyword1"><span class="command">have</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def q_def m_def n_def l_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def m_def n_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> add_nonneg_eq_0_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">unfolding</span></span> n_def l_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_Diff_subset<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> AB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l_def n_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mn <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def q_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> r_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">include</span></span> monad_normalisation
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">RA1</span></span> <span class="skolem"><span class="skolem">RA2</span></span> <span class="skolem"><span class="skolem">RB1</span></span> <span class="skolem"><span class="skolem">RB2</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RA1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RA2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RB1</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RB2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">t1</span> <span class="main">←</span> random_bst <span class="skolem">A</span><span class="main">;</span> <span class="bound">t2</span> <span class="main">←</span> random_bst <span class="skolem">B</span><span class="main">;</span> mrbst_union <span class="bound">t1</span> <span class="bound">t2</span><span class="main">}</span> <span class="main">=</span>
              <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                <span class="bound">l1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                <span class="bound">r1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                <span class="bound">l2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                <span class="bound">r2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> size <span class="main">⟨</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r1</span><span class="main">⟩</span><span class="main">;</span>
                <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> size <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">;</span>
                <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span><span class="bound">m</span> <span class="main">/</span> <span class="main">(</span><span class="bound">m</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                  <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="bound">l1</span> <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="bound">x</span> <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                  <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="bound">r1</span> <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="bound">x</span> <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                  return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                  <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="bound">y</span> <span class="main">⟨</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r1</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="bound">l2</span><span class="main">;</span>
                  <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="bound">y</span> <span class="main">⟨</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r1</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">;</span>
                  <span class="keyword1">if</span> isin <span class="main">⟨</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r1</span><span class="main">⟩</span> <span class="bound">y</span> <span class="keyword1">then</span>
                    mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                  <span class="keyword1">else</span>
                    return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                <span class="main">}</span>
              <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AB
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_bst_reduce split_bst'_altdef Let_def case_prod_unfold <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                        <span class="bound">l1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">r1</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                        <span class="bound">l2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">r2</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="bound">l1</span> <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="bound">x</span> <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="bound">r1</span> <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="bound">x</span> <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="main">(</span>fst <span class="main">(</span>split_bst <span class="bound">y</span> <span class="main">⟨</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r1</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="bound">l2</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="main">(</span>snd <span class="main">(</span>split_bst <span class="bound">y</span> <span class="main">⟨</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r1</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span>
                            mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                          <span class="keyword1">else</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Let_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l1</span> <span class="skolem">x</span> <span class="skolem">r1</span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">∈</span> set_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∈</span> set_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_pmf <span class="main">(</span>pmf_of_set <span class="skolem">A</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"isin <span class="main">⟨</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">⟩</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> isin_bst<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bst_random_bst set_random_bst<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> AB<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_random_bst m_def n_def p_def isin_random_bst <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_3way_split<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">←</span> map_pmf <span class="main">(</span>split_bst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">←</span> map_pmf <span class="main">(</span>split_bst <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span>
                            mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                          <span class="keyword1">else</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AB
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_bst_reduce map_pmf_def case_prod_unfold pair_pmf_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span><span class="skolem">RA1</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">RA2</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span><span class="skolem">RB1</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">RB2</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span><span class="skolem">RA1</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">RA2</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span>
                          <span class="main">(</span><span class="bound">l2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span><span class="skolem">RB1</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">RB2</span> <span class="bound">y</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> mrbst_union <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> mrbst_union <span class="bound">r1</span> <span class="bound">r2</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span>
                            mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                          <span class="keyword1">else</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold RA1_def RA2_def RB1_def RB2_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong split_random_bst AB<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">l1</span> <span class="main">←</span> <span class="skolem">RA1</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">l2</span> <span class="main">←</span> <span class="skolem">RB1</span> <span class="bound">x</span><span class="main">;</span> mrbst_union <span class="bound">l1</span> <span class="bound">l2</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">r1</span> <span class="main">←</span> <span class="skolem">RA2</span> <span class="bound">x</span><span class="main">;</span> <span class="bound">r2</span> <span class="main">←</span> <span class="skolem">RB2</span> <span class="bound">x</span><span class="main">;</span> mrbst_union <span class="bound">r1</span> <span class="bound">r2</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">l1</span> <span class="main">←</span> <span class="skolem">RA1</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">l2</span> <span class="main">←</span> <span class="skolem">RB1</span> <span class="bound">y</span><span class="main">;</span> mrbst_union <span class="bound">l1</span> <span class="bound">l2</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">r1</span> <span class="main">←</span> <span class="skolem">RA2</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">r2</span> <span class="main">←</span> <span class="skolem">RB2</span> <span class="bound">y</span><span class="main">;</span> mrbst_union <span class="bound">r1</span> <span class="bound">r2</span><span class="main">}</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span>
                            mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                          <span class="keyword1">else</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_pmf_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span>
                            mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                          <span class="keyword1">else</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> RA1_def RA2_def RB1_def RB2_def <span class="keyword1"><span class="command">using</span></span> AB
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong if_cong refl psubset<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span>
                            mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                          <span class="keyword1">else</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong if_cong refl arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">random_bst</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">q</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                            random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>
                          <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                            <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                          <span class="main">}</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> q_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q_def l_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> q_lt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> that AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q_def l_def n_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"pmf_of_set <span class="skolem">B</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">q</span><span class="main">;</span>
                                     <span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_of_set_split_inter_diff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q_def l_def n_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span><span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="skolem">B</span><span class="main">;</span>
                  <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                  <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                  <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="keyword1">then</span>
                    mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                  <span class="keyword1">else</span>
                    return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                 <span class="main">}</span> <span class="main">=</span>
              <span class="keyword1">do</span> <span class="main">{</span>
                <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">q</span><span class="main">;</span>
                <span class="bound">y</span> <span class="main">←</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                <span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span>
                  mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span>
                <span class="keyword1">else</span>
                  return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
              <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq bind_assoc_pmf <span class="keyword1"><span class="command">using</span></span> AB q_pos q_lt1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong refl if_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">q</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                            <span class="keyword1">do</span> <span class="main">{</span><span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                                <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                                mrbst_push_down <span class="bound">l</span> <span class="bound">y</span> <span class="bound">r</span><span class="main">}</span>
                          <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                            <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                          <span class="main">}</span>
                        <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">q</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span><span class="main">;</span>
                            random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>
                          <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                            <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                            <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                            return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                          <span class="main">}</span>
                        <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> AB q_pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong if_cong refl mrbst_push_down_correct'<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">p</span><span class="main">;</span>
                        <span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">q</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="skolem">A</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                            random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">y</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span> <span class="main">←</span> pair_pmf <span class="main">(</span>bernoulli_pmf <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bernoulli_pmf <span class="skolem">q</span><span class="main">)</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">∨</span> <span class="main">¬</span><span class="bound">b'</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> pmf_of_set <span class="skolem">A</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                            random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pair_pmf_def bind_assoc_pmf
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span> <span class="main">←</span> map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">∨</span> <span class="main">¬</span><span class="bound">b'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
                                    <span class="main">(</span>pair_pmf <span class="main">(</span>bernoulli_pmf <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bernoulli_pmf <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> pmf_of_set <span class="skolem">A</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                            random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> bind_pmf <span class="main">_</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_pmf case_prod_unfold <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_pmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">∨</span> <span class="main">¬</span><span class="bound">b'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>pair_pmf <span class="main">(</span>bernoulli_pmf <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>bernoulli_pmf <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="keyword1">do</span> <span class="main">{</span>
                   <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span><span class="main">)</span><span class="main">;</span>
                   <span class="bound">b'</span> <span class="main">←</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> bernoulli_pmf <span class="skolem">r</span> <span class="keyword1">else</span> return_pmf False<span class="main">)</span><span class="main">;</span>
                   return_pmf <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span>
                 <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_eqI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bb'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> bool"</span></span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bb'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bb'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pmf <span class="var">?lhs</span> <span class="skolem">bb'</span> <span class="main">=</span> pmf <span class="var">?rhs</span> <span class="skolem">bb'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> pq r_aux <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main">)</span>
             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_map pmf_bind_bernoulli measure_measure_pmf_finite 
                         vimage_bool_pair pmf_pair r_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⤜</span> <span class="var">?f</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                              <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span><span class="main">)</span><span class="main">;</span>
                              <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                                <span class="bound">x</span> <span class="main">←</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b'</span> <span class="main">←</span> bernoulli_pmf <span class="skolem">r</span><span class="main">;</span>
                                         <span class="keyword1">if</span> <span class="bound">b'</span> <span class="keyword1">then</span> pmf_of_set <span class="skolem">A</span> <span class="keyword1">else</span> pmf_of_set <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">}</span><span class="main">;</span>
                                <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                                <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                                return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                              <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                                random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>
                              <span class="main">}</span>
                            <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
                        <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span><span class="main">)</span><span class="main">;</span>
                        <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                          <span class="bound">x</span> <span class="main">←</span> pmf_of_set <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                          <span class="bound">l</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          <span class="bound">r</span> <span class="main">←</span> random_bst <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&gt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">;</span>
                          return_pmf <span class="main">⟨</span><span class="bound">l</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">⟩</span>
                        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                          random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>
                        <span class="main">}</span>
                      <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> AB pq <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> mn
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_pmf_cong if_cong refl pmf_of_set_union_split<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> n_def <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> r_def p_def q_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">…</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_bst_reduce <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion and Deletion›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The insertion and deletion operations are simple special cases of the union
  and difference operations where one of the trees is a singleton tree.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_insert</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrbst_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span> <span class="main">=</span>
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">b</span> <span class="main">←</span> bernoulli_pmf <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
       <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> split_bst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span><span class="main">;</span>
         return_pmf <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span>
       <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
       <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
         map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
       <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
         mrbst_push_down <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="main">}</span>
     <span class="main">}</span>"</span></span>

<span class="keyword1" id="Randomised_BSTs-mrbst_insert_altdef"><span class="command">lemma</span></span> mrbst_insert_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_insert <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> mrbst_union <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mrbst_insert.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def map_pmf_def bind_return_pmf case_prod_unfold <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder tree"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set_tree <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bst_mrbst_union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> set_mrbst_union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mrbst_insert_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> mrbst_insert_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"random_bst <span class="free">A</span> <span class="main">⤜</span> mrbst_insert <span class="free">x</span> <span class="main">=</span> random_bst <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mrbst_union_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mrbst_insert_altdef<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> bind_return_pmf<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mrbst_delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ord <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree pmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrbst_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨⟩</span> <span class="main">=</span> return_pmf <span class="main">⟨⟩</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrbst_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
       map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">l'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
       map_pmf <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span><span class="free">mrbst_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> 
       mrbst_join <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Randomised_BSTs-mrbst_delete_altdef"><span class="command">lemma</span></span> mrbst_delete_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"mrbst_delete <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> mrbst_diff <span class="free">t</span> <span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_return_pmf map_pmf_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder tree"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set_pmf <span class="main">(</span>mrbst_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   bst_mrbst_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   set_mrbst_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t'</span> <span class="main">=</span> set_tree <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bst_mrbst_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span>"</span></span><span class="main">]</span> set_mrbst_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨⟩</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="main">⟨⟩</span><span class="main">⟩</span>"</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mrbst_delete_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> mrbst_delete_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">t</span> <span class="main">←</span> random_bst <span class="free">A</span><span class="main">;</span> mrbst_delete <span class="free">x</span> <span class="bound">t</span><span class="main">}</span> <span class="main">=</span> random_bst <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mrbst_diff_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mrbst_delete_altdef bind_return_pmf<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>