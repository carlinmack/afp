<div id="Factorials">
<div class="head">
<h1>Theory Factorials</h1>
</div>
<pre class="source">
<span class="comment1">(* Authors: Amine Chaieb &amp; Florian Haftmann, TU Muenchen with contributions by Lukas Bulwahn *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Falling factorials›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Factorials
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Stirling.html">HOL-Library.Stirling</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pochhammer_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="comment1">― ‹TODO move›</span>
  <span class="quoted"><span class="quoted">"pochhammer <span class="main">0</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_prod<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ffact</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>comm_semiring_1_cancel <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ffact</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> pochhammer <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff ffact_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_def pochhammer_prod prod.atLeast0_lessThan_Suc <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="comment1">(* TODO: what's the right class here? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ffact_Suc_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span><span class="main">)</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_semiring_1_cancel<span class="main">,</span> ab_group_add<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ffact_def pochhammer_rec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_add_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_nat_triv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_Suc_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_def pochhammer_prod <span class="dynamic"><span class="dynamic">algebra_simps</span></span> prod.atLeast0_lessThan_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_nat_triv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_Suc_rev_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_def pochhammer_rec Suc_diff_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_nat_triv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fact_div_fact_ffact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fact <span class="free">n</span> <span class="keyword1">div</span> fact <span class="free">m</span> <span class="main">=</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fact <span class="free">n</span> <span class="main">=</span> ffact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">n</span> <span class="main">*</span> fact <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_def pochhammer_product pochhammer_fact<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fact <span class="free">m</span> <span class="keyword1">dvd</span> <span class="main">(</span>fact <span class="free">n</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fact_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fact_div_fact_ffact_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fact <span class="free">n</span> <span class="keyword1">div</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_div_fact_ffact<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_fact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="main">(</span>of_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>of_nat <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ffact_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_add_diff_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> of_nat <span class="free">n</span><span class="main">)</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">a</span> <span class="main">+</span> of_nat <span class="free">n</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_ffact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">a</span> <span class="main">=</span> ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">+</span> of_nat <span class="free">n</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">+</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ffact <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> of_nat <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ffact <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> of_nat <span class="free">n</span> <span class="main">*</span> <span class="main">(</span>ffact <span class="free">n</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ffact_Suc_rev <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ffact_add_diff_assoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: what's the right class here? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> prod_ffact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ord<span class="main">,</span> ring_1<span class="main">,</span> comm_monoid_mult<span class="main">,</span> comm_semiring_1_cancel<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> of_nat <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_diff_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> of_nat <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> of_nat <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.reindex_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ffact_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pochhammer_prod_rev<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_ffact_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_diff_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod.reindex_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ffact_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pochhammer_prod_rev<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_nat_triv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: what's the right class here? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> prod_rev_ffact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ord<span class="main">,</span> ring_1<span class="main">,</span> comm_monoid_mult<span class="main">,</span> comm_semiring_1_cancel<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> of_nat <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> of_nat <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> of_nat <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> of_nat <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> of_nat <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.reindex_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ffact_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pochhammer_prod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_rev_ffact_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.reindex_cong<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> ffact_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pochhammer_prod of_nat_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_rev_ffact_nat'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">{</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">m</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">{</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">..</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.reindex_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prod_rev_ffact_nat<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_eq_fact_mult_binomial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> fact <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> fact <span class="free">n</span> <span class="keyword1">div</span> fact <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fact_div_fact_ffact_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fact <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_fact_lemma<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this ffact_nat_triv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_ffact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>ffact <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="main">(</span>of_nat <span class="free">m</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_Suc_nat ffact_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ffact_Suc_nat ffact_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_int_ffact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>ffact <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> ffact <span class="free">n</span> <span class="main">(</span>of_int <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">(</span>ffact <span class="skolem">n</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ffact <span class="skolem">n</span> <span class="main">(</span>of_int <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_Suc_nat ffact_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> pochhammer <span class="free">x</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> pochhammer <span class="main">(</span><span class="main">-</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ffact_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pochhammer <span class="main">(</span><span class="main">-</span> <span class="free">x</span> <span class="main">-</span> of_nat <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_add_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> pochhammer <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pochhammer_minus'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> pochhammer <span class="free">x</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conversion of natural potences into falling factorials and back›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> monomial_ffact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="bound">k</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span> mult_ffact<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span> Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="bound">k</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="bound">k</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">..</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="bound">k</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">..</span> Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> image_Suc_atLeastAtMost sum.shift_bounds_cl_Suc_ivl<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">..</span> Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_mult <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="bound">k</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="bound">k</span> <span class="main">*</span> Stirling <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> image_Suc_atLeastAtMost sum.shift_bounds_cl_Suc_ivl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> of_nat <span class="main">(</span>Stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> ffact <span class="bound">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffact_monomial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffact <span class="free">n</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> of_nat <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffact_Suc_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="main">(</span>stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> diff_conv_add_uminus distrib_right<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">+</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> stirling <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_le<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> stirling <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.shift_bounds_cl_Suc_ivl<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> stirling <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> stirling <span class="skolem">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> stirling.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum.shift_bounds_cl_Suc_ivl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="main">(</span>stirling <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Discrete_Summation">
<div class="head">
<h1>Theory Discrete_Summation</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Florian Haftmann, TU Muenchen *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Some basic facts about discrete summation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Discrete_Summation
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_sum_orient<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_sum_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">j</span> <span class="free">k</span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span>
    sum <span class="free">f</span> <span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.union_inter <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ivl_disj_un<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The shift operator›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>ring_1 <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>ab_group_add<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>of_int <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>of_int <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Δ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">l</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> Δ <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_same_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Δ <span class="free">f</span> <span class="main">=</span> Δ <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> plus <span class="bound">l</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> of_int <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> of_int"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> Δ <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> Δ <span class="free">g</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_incr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?F</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?G</span> <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?F</span> <span class="bound">k</span> <span class="main">-</span> <span class="var">?G</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?F</span> <span class="main">(</span><span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?G</span> <span class="main">(</span><span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
    <span class="var">?F</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?G</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?F</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?G</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?F</span> <span class="bound">k</span> <span class="main">-</span> <span class="var">?G</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">k</span> <span class="main">-</span> <span class="var">?G</span> <span class="bound">k</span> <span class="main">=</span> <span class="var">?F</span> <span class="main">0</span> <span class="main">-</span> <span class="var">?G</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">k</span> <span class="main">-</span> <span class="var">?G</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?F</span> <span class="main">0</span> <span class="main">-</span> <span class="var">?G</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> int_induct<span class="main">)</span>
        <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_incr k_decr <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_int_add of_int_diff of_int_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>plus <span class="main">(</span><span class="var">?G</span> <span class="main">0</span> <span class="main">-</span> <span class="var">?F</span> <span class="main">0</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?F</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="var">?G</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plus <span class="main">(</span><span class="var">?G</span> <span class="main">0</span> <span class="main">-</span> <span class="var">?F</span> <span class="main">0</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?F</span> <span class="main">=</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plus <span class="main">(</span><span class="var">?G</span> <span class="main">0</span> <span class="main">-</span> <span class="var">?F</span> <span class="main">0</span><span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> of_int <span class="main">=</span> <span class="free">g</span> <span class="main">∘</span> of_int"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Δ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">k</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Δ <span class="free">f</span> <span class="free">k</span> <span class="main">+</span> Δ <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_factor<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Δ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The formal sum operator›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>ring_1 <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>ab_group_add<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> sum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> of_int<span class="main">)</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">-</span> sum <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> of_int<span class="main">)</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_same <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="free">f</span> <span class="free">j</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_positive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">⟹</span> Σ <span class="free">f</span> <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> sum <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> of_int<span class="main">)</span> <span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_negative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">l</span> <span class="main">⟹</span> Σ <span class="free">f</span> <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> <span class="main">-</span> Σ <span class="free">f</span> <span class="free">l</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_comp_of_int<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> of_int<span class="main">)</span> <span class="main">=</span> Σ <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> of_int <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">k</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> Σ <span class="free">f</span> <span class="free">j</span> <span class="free">l</span> <span class="main">+</span> Σ <span class="free">g</span> <span class="free">j</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def sum.distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_factor<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>ring<span class="main">)</span> <span class="main">*</span> Σ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def sum_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_concat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="free">f</span> <span class="free">j</span> <span class="free">k</span> <span class="main">+</span> Σ <span class="free">f</span> <span class="free">k</span> <span class="free">l</span> <span class="main">=</span> Σ <span class="free">f</span> <span class="free">j</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> add_sum_int<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_sum_orient <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="main">]</span></span>
      add_sum_orient <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main">]</span></span>
      add_sum_orient <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="main">]</span></span> add_sum_int<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_incr_upper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="free">f</span> <span class="free">j</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Σ <span class="free">f</span> <span class="free">j</span> <span class="free">l</span> <span class="main">+</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Σ <span class="free">f</span> <span class="free">l</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Σ <span class="free">f</span> <span class="free">j</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Σ <span class="free">f</span> <span class="free">j</span> <span class="free">l</span> <span class="main">+</span> Σ <span class="free">f</span> <span class="free">l</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_concat<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fundamental lemmas: The relation between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Δ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Σ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_Σ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Δ <span class="main">(</span>Σ <span class="free">f</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Δ <span class="main">(</span>Σ <span class="free">f</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_def Σ_incr_upper<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_Δ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="main">(</span>Δ <span class="free">f</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">l</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Δ_Σ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Δ <span class="main">(</span>Σ <span class="main">(</span>Δ <span class="free">f</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> Δ <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"plus <span class="skolem">k</span> <span class="main">∘</span> Σ <span class="main">(</span>Δ <span class="free">f</span><span class="main">)</span> <span class="free">j</span> <span class="main">∘</span> of_int <span class="main">=</span> <span class="free">f</span> <span class="main">∘</span> of_int"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Δ_same_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_int <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> Σ <span class="main">(</span>Δ <span class="free">f</span><span class="main">)</span> <span class="free">j</span> <span class="bound">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Summation_Conversion">
<div class="head">
<h1>Theory Summation_Conversion</h1>
</div>
<pre class="source">
<span class="comment1">(* Author: Florian Haftmann, TU Muenchen *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A barebone conversion for discrete summation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Summation_Conversion
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Factorials.html">Factorials</a> <a href="Discrete_Summation.html">Discrete_Summation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extensible theorem collection for solving summation problems›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> summation <span class="quoted">"rules for solving summation problems"</span>

<span class="keyword1"><span class="command">declare</span></span>
  Σ_const <span class="main">[</span><span class="operator">summation</span><span class="main">]</span> Σ_add <span class="main">[</span><span class="operator">summation</span><span class="main">]</span>
  Σ_factor <span class="main">[</span><span class="operator">summation</span><span class="main">]</span> monomial_ffact <span class="main">[</span><span class="operator">summation</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> intervall_simps <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">::</span>nat <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="main">0</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">::</span>nat <span class="main">=</span> <span class="main">0</span><span class="main">..</span>Suc <span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">::</span>nat <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_ffact<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Δ <span class="main">(</span>ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="main">(</span>of_int <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_def ffact_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Δ <span class="main">(</span>ffact <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span>
    ffact <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>of_int <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ffact <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_int <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ffact <span class="skolem">m</span> <span class="main">(</span>of_int <span class="free">k</span><span class="main">)</span>
    <span class="main">-</span> <span class="main">(</span>ffact <span class="skolem">m</span> <span class="main">(</span>of_int <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_int <span class="free">k</span> <span class="main">-</span> of_nat <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ffact_Suc_rev <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int <span class="free">k</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> ffact_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>of_int <span class="free">k</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> of_int <span class="free">k</span> <span class="main">+</span> of_nat <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> ffact <span class="skolem">m</span> <span class="main">(</span>of_int <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> ffact <span class="skolem">m</span> <span class="main">(</span>of_int <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> ffact <span class="main">(</span>Suc <span class="skolem">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> Suc <span class="skolem">n</span>›</span></span> diff_Suc_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_ffact_divide <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Σ <span class="main">(</span>ffact <span class="free">n</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span> <span class="main">=</span>
    <span class="main">(</span>ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">l</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>idom_divide<span class="main">,</span> semiring_char_0<span class="main">}</span><span class="main">)</span> <span class="main">-</span> ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> Σ <span class="main">(</span>ffact <span class="free">n</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span><span class="main">)</span> <span class="keyword1">div</span> of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Σ <span class="main">(</span>ffact <span class="free">n</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_nat_neq_0 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">l</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">-</span> ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>of_int <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
    Σ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> Δ <span class="main">(</span>ffact <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_Δ<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Σ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> ffact <span class="free">n</span> <span class="main">(</span>of_int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Δ_ffact<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">*</span> Σ <span class="main">(</span>ffact <span class="free">n</span> <span class="main">∘</span> of_int<span class="main">)</span> <span class="free">j</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_factor comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Σ_comp_of_int * of_nat_eq_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Various other rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_int_coeff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int <span class="free">l</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">)</span> <span class="main">*</span> numeral <span class="free">k</span> <span class="main">=</span> of_int <span class="main">(</span><span class="free">l</span> <span class="main">*</span> numeral <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> nat_simps <span class="main">=</span>
  add_0_left add_0_right add_Suc add_Suc_right
  mult_Suc mult_Suc_right mult_zero_left mult_zero_right
  One_nat_def of_nat_simps

<span class="keyword1"><span class="command">lemmas</span></span> of_int_pull_out <span class="main">=</span>
  of_int_add <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> of_int_diff <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> of_int_mult <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  of_int_coeff

<span class="keyword1"><span class="command">lemma</span></span> of_nat_coeff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>of_nat <span class="free">n</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>comm_semiring_1<span class="main">)</span> <span class="main">*</span> numeral <span class="free">m</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="free">n</span> <span class="main">*</span> numeral <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> of_nat_pull_out <span class="main">=</span>
  of_nat_add <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> of_nat_mult <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> of_nat_coeff

<span class="keyword1"><span class="command">lemmas</span></span> nat_pull_in <span class="main">=</span>
  nat_int_add

<span class="keyword1"><span class="command">lemmas</span></span> of_int_pull_in <span class="main">=</span>
  of_int_pull_out <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> add_divide_distrib diff_divide_distrib of_int_power
  of_int_numeral of_int_neg_numeral times_divide_eq_left <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_nat</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> int <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Σ_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Σ<span class="hidden">⇩</span><sub>ℕ</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Σ<span class="hidden">⇩</span><sub>ℕ</sub></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nat <span class="main">(</span>Σ <span class="main">(</span>lift_nat <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pos_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pos_id</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Σ_pos_id <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> Σ <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>pos_id <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="free">l</span> <span class="main">=</span> Σ <span class="free">f</span> <span class="free">k</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Σ_def pos_id_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> numeral <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>int<span class="main">)</span> <span class="main">≤</span> int <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_nat <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> int <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_nat_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_nat <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> pos_id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_nat_def fun_eq_iff pos_id_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_nat <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> lift_nat <span class="free">f</span> <span class="bound">k</span> <span class="main">+</span> lift_nat <span class="free">g</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_nat_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_nat <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">m</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> int <span class="free">m</span> <span class="main">*</span> lift_nat <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_nat_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_nat <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> lift_nat <span class="free">f</span> <span class="bound">k</span> <span class="main">*</span> int <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_nat_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">summation</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift_nat <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> lift_nat <span class="free">f</span> <span class="bound">k</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift_nat_def fun_eq_iff<span class="main">)</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Generic conversion›</span></span>  

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SUMMATION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Summation</span> <span class="main">:</span> <span class="entity">SUMMATION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">simps2</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> Stirling.simps ffact_0 ffact_Suc nat_simps<span class="antiquote">}</span></span></span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">simpset3</span> <span class="main">=</span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  |&gt; fold <span class="entity">Simplifier.add_simp</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="antiquote">}</span></span></span>
  |&gt; Simplifier.simpset_of<span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">simps4</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> of_int_pull_out of_nat_pull_out nat_pull_in<span class="antiquote">}</span></span></span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">simps6</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> of_int_pull_in<span class="antiquote">}</span></span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt1</span> <span class="main">=</span>
      <span class="entity">ctxt</span>
      |&gt; put_simpset <span class="entity">HOL_basic_ss</span>
      |&gt; fold <span class="entity">Simplifier.add_simp</span> <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> summation<span class="antiquote">}</span></span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt2</span> <span class="main">=</span>
      <span class="entity">ctxt</span>
      |&gt; put_simpset <span class="entity">HOL_basic_ss</span>
      |&gt; fold <span class="entity">Simplifier.add_simp</span> <span class="entity">simps2</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt3</span> <span class="main">=</span>
      <span class="entity">ctxt</span>
      |&gt; put_simpset <span class="entity">simpset3</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt4</span> <span class="main">=</span>
      <span class="entity">ctxt</span>
      |&gt; put_simpset <span class="entity">HOL_basic_ss</span>
      |&gt; fold <span class="entity">Simplifier.add_simp</span> <span class="entity">simps4</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">semiring_conv_base</span> <span class="main">=</span> <span class="entity">Semiring_Normalizer.semiring_normalize_conv</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">semiring_conv</span> <span class="main">=</span> Conv.arg_conv <span class="main">(</span>Conv.arg1_conv <span class="main">(</span>Conv.arg_conv <span class="entity">semiring_conv_base</span><span class="main">)</span><span class="main">)</span>
      else_conv Conv.arg1_conv <span class="main">(</span>Conv.arg_conv <span class="entity">semiring_conv_base</span><span class="main">)</span>
      else_conv <span class="entity">semiring_conv_base</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt6</span> <span class="main">=</span>
      <span class="entity">ctxt</span>
      |&gt; put_simpset <span class="entity">HOL_basic_ss</span>
      |&gt; fold <span class="entity">Simplifier.add_simp</span> <span class="entity">simps6</span>
  <span class="keyword2"><span class="keyword">in</span></span>
     <span class="entity">Simplifier.rewrite</span> <span class="entity">ctxt1</span>
     then_conv <span class="entity">Simplifier.rewrite</span> <span class="entity">ctxt2</span>
     then_conv <span class="entity">Simplifier.rewrite</span> <span class="entity">ctxt3</span>
     then_conv <span class="entity">Simplifier.rewrite</span> <span class="entity">ctxt4</span>
     then_conv <span class="entity">semiring_conv</span>
     then_conv <span class="entity">Simplifier.rewrite</span> <span class="entity">ctxt6</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> nat_simps of_int_pull_out of_int_pull_in

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source">
<span class="comment1">(* Author: Florian Haftmann, TU Muenchen *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simple examples›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Summation_Conversion.html">Summation_Conversion</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="entity">Summation.conv</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"Σ <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">::</span>rat<span class="main">.</span> <span class="bound">q</span> <span class="main">^</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span> <span class="free">j</span>"</span><span class="antiquote">}</span></span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="entity">Summation.conv</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"Σ <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span> <span class="free">j</span>"</span><span class="antiquote">}</span></span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="entity">Summation.conv</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"Σ <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">::</span>int<span class="main">.</span> <span class="bound">k</span> <span class="main">^</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span> <span class="free">j</span>"</span><span class="antiquote">}</span></span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="entity">Summation.conv</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"<span class="keyword1">Σ<span class="hidden">⇩</span><sub>ℕ</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">n</span> <span class="main">^</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">0</span> <span class="free">m</span>"</span><span class="antiquote">}</span></span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>